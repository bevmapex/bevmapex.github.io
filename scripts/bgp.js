function bevgeoplot(h,S){function z(){Yi=document.getElementById(h).offsetWidth,Ki=document.getElementById(h).offsetHeight}function F(jn){var Ln=jn.add(bf,'blank').name('').__li;Ln.setAttribute('class','cr function mydum')}function D(){}function V(){rn.get('tap').set({threshold:1,posThreshold:1,time:1,interval:2}),rn.get('press').set({threshold:50,time:3}),rn.get('pan').set({threshold:sensivity,time:4,direction:Hammer.DIRECTION_ALL}),rn.get('pinch').set({enable:!0})}function Q(jn,Ln){var Pn=null==Ln?Jl:Ln;if(null==jn)return console.log('Null object!'),null;for(var En,Tn=0;Tn<Pn.children.length;Tn++)if(Pn.children[Tn].uuid==jn){En=Pn.children[Tn];break}return En}function M(){line3dtemp.children.length=0,line3dgroup.children.length=0,fallar.children.length=0,fi.visible=!1,Wl=yp=zp=-1e3,un=-1e3,renderblock=1;for(var jn=0;jn<oman.ao.length;jn++)oman.removefromscene(oman.get(jn));Xl=[],oman=new C,ga(),allp=new Ge,allq=new We,Qa(),allq.update(),renderblock=0,ae()}function C(){this.ao=Xl,this.history=[],this.sid=wl,this.so=null,this.sp=null,this.selidx=null,this.changelist={},this.updchangelist=function(jn){this.changelist[jn]=wl},this.select=function(jn,Ln){this.so=null,this.sp=null,this.selidx=null;var Pn=be(jn,Ln);if(Pn[3]>Math.sqrt(Pi*Pi+Li*Li)/7)return console.log('Nothing selected'),[null,null];var En=Pn[0];return this.selidx=En,this.so=this.get(En),this.so||console.log('No object selected'),this.sp=allp.par[Ae(En)],this.sp||console.log('No property selected'),bi.visible=!!this.so,[this.so,this.sp]},this.get=function(jn){var Ln=this.ao[jn];return null==Ln?(console.log('No object ',jn),null):Ln},this.add=function(jn){this.ao.push(jn)},this.undo=function(){var jn=this.history.pop();return jn?void('add'==jn[0]&&(this.removefromscene(jn[1]),this.history.pop()),'remove'==jn[0]&&(this.plot(jn[1]),this.history.pop()),'removeSequence'==jn[0]&&(this.plot(jn[1]),this.history.pop(),'removeSequence'==this.history[this.history.length-1][0]&&this.undo()),'movefrom'==jn[0]&&this.move(jn[1],jn[2],jn[3]),Qa(),ae()):void console.log('No history elements')},this.move=function(jn,Ln,Pn){if(null==jn)return void console.log('Trying to move null object');var En=Q(jn.id,'B'==jn.type?ki:null);if(En){var Tn=Ln-jn.xs,On=Pn-jn.ys;En.position.x+=Tn,En.position.y+=On,params.movestart||this.history.push(['movefrom',jn,jn.xs,jn.ys]),jn.xs=Ln,jn.ys=Pn,bi.visible=!0,bi.position.set(Ln,Pn,10),this.updchangelist(jn.sid)}},this.erasefromhistory=function(jn){for(var Ln=0;Ln<this.history.length;Ln)this.history[Ln][1].sameas(jn)?this.history.splice(Ln,1):Ln++},this.removefromscene=function(jn,Ln){if(1==jn.skip)return!1;if('L'==jn.type)return jn.skip=1,Ln?this.history.push(['removeSequence',jn]):this.history.push(['remove',jn]),renderblock||this.updchangelist(jn.sid),!0;var Pn=Q(jn.id,'B'==jn.type?ki:null);return null==Pn?(console.log('No such object on scene',jn),!1):('B'==jn.type?ki.remove(Pn):Jl.remove(Pn),this.history.push(['remove',jn]),ae(),jn.skip=1,renderblock||this.updchangelist(jn.sid),!0)},this.isdublicate=function(jn){for(var Pn,Ln=0;Ln<this.ao.length;Ln++)Pn=this.get(Ln),Pn.sameas(jn)&&(this.removefromscene(Pn),this.erasefromhistory(jn))},this.plot=function(jn){if('L'==jn.type)return jn.skip=0,void this.history.push(['add',jn]);var Ln;'W'==jn.type&&(Ln=H(jn.xs,jn.ys,jn.zs,jn.size)),'F'==jn.type&&(Ln=ee(jn.xs,jn.ys,jn.zs,jn.angle,jn.fall,jn.size),''!=jn.color&&Gt(jn.color)),'T'==jn.type&&(Ln=X(jn.text,jn.xs,jn.ys,jn.zs,1- -jn.fall)),'B'==jn.type&&(Ln=O(jn.xs,jn.ys,jn.zs,jn.xe,jn.ye,jn.ze),ri=[Ln,jn],ki.add(Ln));Ln&&(Ln.name=Xl.length,jn.id=Ln.uuid,jn.skip=0,this.history.push(['add',jn]),'B'!=jn.type&&Jl.add(Ln),ae())}}function R(jn){!0==controls.enableRotate||((!params.move||'Line'==params.linetype)&&(dn=jn.center.x-es,lasty=jn.center.y-$i),jl.x=2*((jn.center.x-es)/Yi)-1,jl.y=2*-((jn.center.y-$i)/Ki)+1,Ql?J():L())}function J(){fcp=1,Al.setFromCamera(jl,camera);var jn=Al.intersectObjects(meshes.children);if(0<jn.length){var Ln=new ja;Ln.sid=wl;var Pn=mr(Wl),En=mr(yp),Tn=mr(zp),On=mr(Ul),In=mr(yp2d),Bn=mr(jn[0].point.x),Gn=mr(jn[0].point.y),Nn=mr(jn[0].point.z),_n=mr(2*(jn[0].uv.x-0.5)*Li),Wn=mr(2*(jn[0].uv.y-0.5)*Pi);if(-1e3<Wl){var Un=params.lineStyle==qa.lineStylear[0]?0:params.lineStyle==qa.lineStylear[1]?1:params.lineStyle==qa.lineStylear[2]?2:3,Hn=Un+params.color,Xn=_(Pn,En,Tn,Bn,Gn,Nn,Math.round(40*params.size),params.color);if(2==jn.length){var Yn=mr(2*(jn[1].uv.x-0.5)*Li),Kn=mr(2*(jn[1].uv.y-0.5)*Pi),Zn={xs:Yn,ys:Kn,v:new THREE.Vector3(jn[1].point.x,jn[1].point.y,jn[1].point.z)};linez.push(Zn)}var Zn={xs:On,ys:In,v:new THREE.Vector3(Pn,En,Tn)};linez.push(Zn),line3dtemp.add(Xn)}Wl=Bn,yp=Gn,zp=Nn,Ul=_n,yp2d=Wn,zp2d=Nn}ae()}function A(jn){return params.linemagnet?0.3>Math.abs(jn-Li)?Li:0.3>Math.abs(jn+Li)?-Li:jn:jn}function L(){fcp=1,Al.setFromCamera(jl,camera);var jn=Al.intersectObjects(Hl);if(0<jn.length){var Ln=new ja;Ln.sid=wl;var Pn=mr(Wl),En=mr(yp),Tn=mr(zp),On=mr(jn[0].point.x),In=mr(jn[0].point.y),Bn=mr(jn[0].point.z);if(!Ql&&!params.move&&On<-Li&&'Select'==params.linetype)return Le(In),Pe(),void ae();if('Line'==params.linetype&&On>=-Li){if(Pn=A(Pn),On=A(On),-1e3<Wl){fi.visible=!0,fi.position.set(On,In,10);var Gn=params.lineStyle==qa.lineStylear[0]?0:params.lineStyle==qa.lineStylear[1]?1:params.lineStyle==qa.lineStylear[2]?2:3,Nn=Gn+params.color,_n=_(Pn,En,Tn,On,In,Bn+params.layer+1,Math.round(30*params.size),params.color);_n.name=Xl.length,Ln.addline(Pn,En,Tn,On,In,Bn+params.layer+1,Math.round(30*params.size),Nn),oman.plot(Ln),oman.add(Ln),xi.add(_n),un=On,endy=In}else cn=On,firsty=In,firstz=Bn;fi.visible=!0,fi.position.set(On,In,10),Wl=On,yp=In,zp=Bn+params.layer+1}if('Bolt'==params.linetype&&On>=-Li)if(!El)Ln.addbolt(On,In,Bn+7,On,In,Bn+7,params.bolttype),oman.plot(Ln),oman.add(Ln);else{G(On,In,Bn+7);var Wn=oman.get(Xl.length-1);Wn.xe=$l.vertices[1].x,Wn.ye=$l.vertices[1].y,Wn.ze=$l.vertices[1].z}if('Fall'==params.linetype&&On>=-Li&&(Tl?0!=params.fall&&_a(On,In,Bn+7):(Ln.addfall(On,In,Bn+7,params.angle,params.fall,Sl<kl),oman.plot(Ln),oman.add(Ln))),'Water'==params.linetype&&On>=-Li&&(Ln.addwater(On,In,Bn+7,Math.round(10*params.wsize)/10),oman.plot(Ln),oman.add(Ln)),'Text'==params.linetype&&On>=-Li&&''!=params.text&&(Ln.addtext(params.text,On,In,Bn+params.layer+1),oman.plot(Ln),oman.add(Ln)),'Select'==params.linetype&&On>=-Li)if(!params.move){oman.select(On,In);var Un=be(On,In);if(Un[3]>Math.sqrt(Pi*Pi+Li*Li)/7)return;bi.visible=!0,bi.position.set(Un[1],Un[2],10),Ji=Un[0],Je(Ji)}else if(oman.so){var Hn=On-0.1*Li/camera.zoom,Xn=In+0.1*Pi/camera.zoom;oman.move(oman.get(Ji),Hn,Xn)}}else'Select'==params.linetype?params.move&&de():(Na(),bi.visible=!1);ae()}function P(){if(-1e3<un){var jn=new ja;jn.sid=wl;var Ln=params.lineStyle==qa.lineStylear[0]?0:params.lineStyle==qa.lineStylear[1]?1:params.lineStyle==qa.lineStylear[2]?2:3;if(0<Ln)return void(un=endy=cn=firsty=firstz=-1e3);var Pn=Ln+params.color;jn.addline(un,endy,firstz+params.layer+1,cn,firsty,firstz+params.layer+1,Math.round(30*params.size),Pn),oman.plot(jn),oman.add(jn),un=endy=cn=firsty=firstz=-1e3,Qa(),ae()}}function E(jn,Ln,Pn){Jl.remove(zi);var En=6,Tn=0.1*Oi;zi=new THREE.Object3D;var On=-Pi,In=Pi,Bn=_(1.13*Li,On,0,1.13*Li,In,0,10,$a);zi.add(Bn);var Gn={val:15},Nn=X(jn,1.13*Li+0.11*Li,On+Tn,0,0,$a);zi.add(Nn);var _n=_(1.13*Li,On,0,1.067*Li,On,0,En,$a);zi.add(_n);var Wn=_(1.13*-Li,On,10,1.067*-Li,On,10,En,$a);zi.add(Wn);var Un=X(Ln,1.13*Li+0.11*Li,In-Tn,0,0,$a);zi.add(Un);var Hn=_(1.13*Li,In,0,1.067*Li,In,0,En,$a),Xn=_(1.13*-Li,In,10,1.067*-Li,In,10,En,$a);zi.add(Hn),zi.add(Xn);for(var Yn=1;Yn<pmult*(Ln-jn)/5;++Yn){var Kn=-Pi+5*(pmult*Yn*(In-On))/(Ln-jn),Zn=_(1.13*Li,Kn,0,1.067*Li,Kn,0,En,$a),$n=_(1.13*-Li,Kn,10,1.067*-Li,Kn,10,En,$a),eo=5*pmult*Yn+parseInt(jn),to=X(eo,1.13*Li+0.11*Li,Kn,0,0,$a);zi.add(Zn),zi.add(to),zi.add($n)}var ao=normPel(jn,Ln);if(100<ao[1]-ao[0])for(var Yn=ao[0]-1;Yn<=ao[1];Yn++)if(0==Yn%100){fcp=1;var lo=X(Yn,4*Li,La(Yn),Gn,0,$a);zi.add(lo),fcp=0}if(null!=Pn){zi.position.set(0,Pn,0)}Jl.add(zi)}function O(jn,Ln,Pn,En,Tn,On){var In=new THREE.Object3D,Bn=0.07,Gn=_(jn+Bn,Ln+Bn,Pn,jn-Bn,Ln-Bn,Pn-0.01,2,'#000000'),Nn=_(jn-Bn,Ln+Bn,Pn,jn+Bn,Ln-Bn,Pn-0.01,2,'#000000'),_n=Wa(jn,Ln,Pn,2*(Bn/Math.sqrt(2)),2,'#000000');return di=B(jn,Ln,Pn,En,Tn,On,1,'#000000'),In.add(Gn),In.add(Nn),In.add(_n),In.add(di),In}function I(){return 1/2e3}function B(jn,Ln,Pn,En,Tn,On,In,Bn){$l=new THREE.Geometry,ei=new THREE.Vector3(jn,Ln,Pn),$l.vertices.push(ei),$l.vertices.push(new THREE.Vector3(En,Tn,On));return N([jn,Ln,Pn,En,Tn,On],10,Bn)}function G(jn,Ln,Pn){var En=(ei.x-jn)*(ei.x-jn)+(ei.y-Ln)*(ei.y-Ln),Tn=2*(Fl/ji),On=params.boltlen*Math.sin(Math.PI/24);if(En=Math.sqrt(En)/Tn,En<On)ri[0].remove(di),di=B(ei.x,ei.y,ei.z,jn,Ln,Pn,1,'#000000'),ri[0].add(di),ri[1].xe=jn,ri[1].ye=Ln,ri[1].ze=Pn;else{var Bn,Gn;Bn=ei.x+(jn-ei.x)/En*On,Gn=ei.y+(Ln-ei.y)/En*On,ri[0].remove(di),di=B(ei.x,ei.y,ei.z,Bn,Gn,Pn,1,'#000000'),ri[0].add(di),ri[1].xe=Bn,ri[1].ye=Gn,ri[1].ze=Pn}console.log(ri[1])}function N(jn,Ln,Pn,En){if(0!=jn.length){var Tn=new THREE.LineGeometry;Tn.setPositions(jn);var On=Pn+'',In=0;if(7<On.length&&(In=On[0],On=On.slice(1,8)),0<In){var Bn=W(jn,Ln,Pn,En);return Bn}var Gn=Math.abs(Ln),Nn=Ql?5:3,_n=new THREE.LineMaterial({color:new THREE.Color(On),linewidth:Gn/3,dashed:!1}),Wn=renderer.getSize();_n.resolution.set(Wn.width,Wn.height);var Bn=new THREE.Line2(Tn,_n);return null==En&&Si.add(Bn),Bn}}function _(jn,Ln,Pn,En,Tn,On,In,Bn){var Gn=new Float32Array(6);Gn[0]=jn,Gn[1]=Ln,Gn[2]=Pn,Gn[3]=En,Gn[4]=Tn,Gn[5]=On;var Nn=N(Gn,In,Bn,1);return Nn}function W(jn,Ln,Pn,En){if(0!=jn.length){var Tn=jn.length,On=Pn+'',In=0;7<On.length&&(In=On[0],On=On.slice(1,8));for(var Bn=0,Gn=3;Gn<Tn;Gn+=3)Bn+=Math.sqrt((jn[Gn]-jn[Gn-3])*(jn[Gn]-jn[Gn-3])+(jn[Gn+1]-jn[Gn-2])*(jn[Gn+1]-jn[Gn-2]));var Nn=new Float32Array(Tn);iOS&&(Nn=new Float32Array(2*Tn-3));for(var Gn=0;Gn<jn.length;Gn++)Nn[Gn]=jn[Gn];if(iOS)for(var Wn,Gn=0;Gn<Tn-3;Gn+=3)Wn=2*Tn-3-Gn-3,Nn[Wn]=jn[Gn],Nn[Wn+1]=jn[Gn+1],Nn[Wn+2]=jn[Gn+2];var Un=new THREE.Color(On),Hn=Math.abs(Ln)*I(),Xn=new MeshLineMaterial({color:Un,lineWidth:Hn*lsc,useMap:!1,transparent:!!(0>Ln),opacity:0>Ln?0.6:1,resolution:Zi});if(1==In)var Xn=new MeshLineMaterial({color:Un,lineWidth:Hn*lsc,useMap:!1,useAlphaMap:1,transparent:!0,alphaMap:Ts,resolution:Zi});if(2==In){var Yn=Math.round(1.5*Bn);Yn=1>Yn?1:Yn;var Xn=new MeshLineMaterial({color:Un,lineWidth:Hn*lsc,useMap:!1,useAlphaMap:1,repeat:new THREE.Vector2(Yn,1),transparent:!0,alphaMap:Os,resolution:Zi})}if(3==In){var Yn=Math.round(Bn);Un=new THREE.Color('#aaaaaa'),Yn=1>Yn?1:Yn;var Xn=new MeshLineMaterial({color:Un,lineWidth:1.5*(Hn*lsc),useMap:!0,map:Is,useAlphaMap:1,repeat:new THREE.Vector2(Yn,1),transparent:!0,alphaMap:Is,resolution:Zi})}var Kn=new MeshLine;Kn.setGeometry(Nn);var Zn=new THREE.Mesh(Kn.geometry,Xn);return null==En&&Si.add(Zn),Zn}}function U(jn,Ln){var Pn=new THREE.Sprite;return Pn.position.set(jn,Ln,2),Pn.scale.set(0.4,0.4,0.4),Pn}function H(jn,Ln,Pn,En){var Tn=new THREE.Sprite(mn);return Tn.position.set(jn,Ln,Pn),Tn.scale.x=Tn.scale.y=En*Oi,Tn}function X(jn,Ln,Pn,En,Tn,On){var In=10,Bn=new THREE.Object3D,Gn=Ua(jn,On,En);if(Gn.position.set(Ln+0.1,Pn-0.05,In/5),Bn.add(Gn),Tn){Gn.position.set(Ln+0.35,Pn-0.2,In/5);var Nn=0.07,_n=_(-Nn,-Nn,10,Nn,Nn,10,In/5,'#000000'),Wn=_(Nn,-Nn,10,-Nn,Nn,10,In/5,'#000000');_n.position.set(Ln,Pn,0),Wn.position.set(Ln,Pn,0);var Un=U(Ln+0.35,Pn+0.12);Un.visible=!1,Bn.add(_n),Bn.add(Wn),Bn.add(Un),2==Tn&&(Un.material=kn,Un.visible=!0,console.log('photo added')),3==Tn&&(Un.material=Sn,Un.visible=!0,console.log('labtest added'))}return Bn}function Y(jn){var Ln=new FileReader;Ln.onloadend=function(Pn){var En=Sl;Re()&&(En=Math.round(Pa(Xl[Ji].ys)));var Tn=new Date,On='';On='pic_'+En+'_'+Tn.getMinutes()+'m'+Tn.getSeconds()+'s',zn(Pn.target.result,On+'.jpg'),Z(Ji,On,1),Js.updateDisplay()},Ln.readAsDataURL(jn.files[0])}function Z(jn,Ln,Pn){var En=Xl[jn];if('T'!=Re(jn))return void console.log('not T');var Tn=Jl.getObjectByName(jn),On=Tn.children[0];On.redrawInterval=1,Tn.children[0].material.map.text=''+Ln,En.text=Ln,oman.updchangelist(En.sid),null!=Pn&&(1==Pn&&(En.fall=1,Tn.children[3].material=kn),2==Pn&&(En.fall=2,Tn.children[3].material=Sn),Tn.children[3].visible=1),ae(),setTimeout(function(){On.redrawInterval=1e8,ae()},1)}function $(jn,Ln,Pn){var En=Xl[jn];if('F'!=Re(jn))return void console.log('not F');var Tn=En.size&&Sl<kl?Pn:360-Pn,On=Jl.getObjectByName(jn),In=On.children[1].children[0];In.redrawInterval=1,0!=Ln&&90!=Ln&&(On.children[1].children[0].material.map.text=''+Ln),On.children[0].material.rotation=Math.round(1e3*(-Math.PI/180*Tn))/1e3,0==Ln&&(On.children[0].material.map=bn,On.children[1].children[0].material.map.text='',On.children[0].material.rotation=0),90==Ln&&(On.children[0].material.map=fn,On.children[1].children[0].material.map.text=''),0!=Ln&&90!=Ln&&(On.children[0].material.map=yn),En.fall=parseInt(Ln),En.angle=parseInt(Pn),oman.updchangelist(En.sid),ae(),setTimeout(function(){In.redrawInterval=1e8,ae()},50)}function ee(jn,Ln,Pn,En,Tn,On){var In=On==Sl<kl?En:360-En,Bn='',Gn=new THREE.Object3D;if(0!=Tn&&90!=Tn){ti=new THREE.SpriteMaterial({map:yn,color:16777215,rotation:-Math.PI/180*In});var Nn=new THREE.Sprite(ti);Bn=Tn+''}if(0==Tn)var _n=new THREE.SpriteMaterial({map:bn,color:16777215}),Nn=new THREE.Sprite(_n);if(90==Tn){ti=new THREE.SpriteMaterial({map:fn,color:16777215,rotation:-Math.PI/180*In});var Nn=new THREE.Sprite(ti)}Nn.position.set(jn,Ln,Pn),Nn.scale.x=Nn.scale.y=0.4*Oi;var Wn=X(Bn,jn+0.25*Ti,Ln-0.12*Oi,Pn,0);return Gn.add(Nn),Gn.add(Wn),Gn}function ae(jn,Ln){if(!renderblock){if(mt.start('render'),null==jn&&controls.update(),Ql?renderer.render(gi,camera):null==Ln?renderer.render(Jl,camera):renderer.render(Ln,camera),null==jn&&(1==rendebug&&console.log('r'),2==rendebug)){var Pn=ae.caller;console.log(Pn)}mt.end('render')}}function le(jn,Ln){var Pn=Ia();if(!Pn)return void console.log('Nothing to save');var En=JSON.stringify(Pn),Tn=getpelrange(En,picparams.ps,picparams.pe);params.textsave=En,Js.updateDisplay();var On=new Date,In='',Bn=getauthorandsid(Pn);In='pel'+Tn[0]+'_'+Tn[1]+'\''+params.tunnel+'\''+Bn.author+shortsid(Bn.sid)+'.txt';var Gn={name:In,size:En.length,content:En},Nn=elemfromfile(Gn),_n=function(Xn){dbputreg(Xn,function(){null==Ln&&(newdb.ldb(),allq.update())})};console.log('Attempt to add new file to db',Nn);var Wn=newdb.comparef(Nn);if(Wn){console.log('File already exists in db',Wn);var Un=Nn.savedata,Hn=Wn.savedata;comparesave(Un,Hn)?console.log('Files are same, not saving'):(console.log('Adding because files are different'),_n(Nn))}else console.log('Adding new file to db',Nn),_n(Nn);ie(jn)}function ie(){var Ln=Ia(1);if(!Ln)return void console.log('Nothing to save');var Pn=JSON.stringify(Ln),En=getpelrange(Pn,picparams.ps,picparams.pe);params.textsave=Pn,Js.updateDisplay();var Tn=new Date,On='',In=getauthorandsid(Ln);On='pel'+En[0]+'_'+En[1]+'\''+params.tunnel+'\''+In.author+shortsid(In.sid)+'.txt';({name:On,size:Pn.length,content:Pn})}function oe(jn,Ln){params.withbg||(vi.visible=!1),tt();var Pn=new THREE.Scene;Pn.add(Ri),ae(null,Pn),console.log('start save as image'),re(function(En){Jl.add(Ri),ae(),re(jn,En),vi.visible=!0,ut(),Qa(),ae(),null!=Ln&&(params.what2plot='Geo+Q+Pel')},1)}function re(jn,Ln){var Pn,Tn=window.devicePixelRatio;try{Pn=renderer.domElement.toDataURL('image/png');var In=new Image,Bn='For 3d'==params.what2plot?1:0,Gn='Only texture'==params.what2plot?1:0;In.onload=function(){var _n=document.createElement('canvas');_n.width=Gn?2*Cl:Ml,_n.height=Gn?2*Cl:Cl,_n.width*=Tn,_n.height*=Tn,_n.visible=0;var Wn=_n.getContext('2d');Wn.drawImage(In,0,0);var Un=Wn.getImageData(0,0,_n.width,_n.height),Hn=Un.data,Xn=Hn.length,Yn=[];if(null!=Ln&&!Array.isArray(Ln))for(var Kn=0;Kn<Xn;Kn+=4)if(208==Hn[Kn]&&208==Hn[Kn+1]&&208==Hn[Kn+2]);else Yn.push(Kn);if(null!=Ln&&!Array.isArray(Ln))return void jn(Yn);if(!params.withbg){for(var Kn=0;Kn<Xn;Kn+=4)208==Hn[Kn]&&208==Hn[Kn+1]&&208==Hn[Kn+2]&&(Hn[Kn+3]=0);if(Array.isArray(Ln))for(var Kn=0;Kn<Ln.length;Kn++)Hn[Ln[Kn]+3]=100}console.log('done pic'),Un.data=Hn,Wn.putImageData(Un,0,0);var Zn=document.createElement('canvas');Zn.visible=0;var $n=Wn.getImageData(Cl,0,Cl+Ml,Cl);Zn.width=Cl,Zn.height=Ml;var eo=Zn.getContext('2d');if(eo.putImageData($n,0,0),Pn=Gn?Zn.toDataURL():_n.toDataURL(),yl=Pn,console.log('tmp pic saved'),void 0!==jn)return rl=Pn,void jn();if(!Bn){var to=new Date,ao='';ao=ao+'geo'+to.getHours()+'h'+to.getMinutes()+'m'+to.getSeconds()+'s.png',zn(Pn,ao)}},In.src=Pn}catch(_n){return void console.log(_n)}}function de(){if(!Pl){var jn=Re();jn&&('L'==jn?myask(container,'Remove line?',function(){ue(),un=-1e3,Qa(),ae()}):(ue(),Qa(),ae()))}}function ue(){if(oman.so){allp.remove(oman.sp);var jn=[];if(jn=he(oman.selidx),'Group'==Hi.value&&1<jn.length)for(var Ln=0;Ln<jn.length;Ln++)oman.removefromscene(oman.get(jn[Ln]),1);else oman.removefromscene(oman.so);bi.visible=!1,oman.so=null,oman.selidx=null}}function he(jn){for(var Ln=[jn],Pn=jn-1;0<=Pn&&1!=Xl[Pn].skip&&Xl[Pn].xe==Xl[Pn+1].xs&&Xl[Pn].ye==Xl[Pn+1].ys;Pn--)Ln.push(Pn);for(var Pn=jn+1;Pn<Xl.length&&1!=Xl[Pn].skip&&Xl[Pn-1].xe==Xl[Pn].xs&&Xl[Pn-1].ye==Xl[Pn].ys;Pn++)Ln.push(Pn);return Ln.sort((En,Tn)=>En-Tn),Ln}function ge(jn){var Ln=[];if(-1==jn[0])return Ln;for(var En,Pn=0;Pn<jn.length;Pn++)En=jn[Pn],0==Pn&&(Ln.push(Xl[En].xs),Ln.push(Xl[En].ys)),Ln.push(Xl[En].xe),Ln.push(Xl[En].ye);return Ln}function me(){oman.undo(),Qa(),Xi.setAttribute('class','geobutton1'),setTimeout(function(){Xi.setAttribute('class','geobutton')},200)}function fe(){this.tunnel='',this.zeropel=0,this.pelperunit=1,this.pelstart=0,this.pelend=20,this.qval={},this.pval={},this.pw=Li,this.author='V',this.sid=wl,this.lastchange=0,this.objdata=[]}function be(jn,Ln){for(var Pn=Xl.length,En=1e3,Tn=-1,On=-20,In=-20,Bn=1,Gn=0;Gn<Pn;Gn++)if(!Xl[Gn].skip){Bn=1;var Nn=Xl[Gn].xs,_n=Xl[Gn].ys,Wn=(jn-Nn)*(jn-Nn)+(Ln-_n)*(Ln-_n);if('L'==Xl[Gn].type){var Un=we(Xl[Gn],jn,Ln);Wn=Un[0],Nn=Un[2],_n=Un[3],(0>Un[1]||1<Un[1])&&(Bn=0)}En>=Wn&&Bn&&(En=Wn,Tn=Gn,On=Nn,In=_n)}return[Tn,On,In,Math.sqrt(En)]}function we(jn,Ln,Pn){var En=jn.xs,Tn=jn.xe,On=jn.ys,In=jn.ye,Bn=Math.sqrt((Tn-En)*(Tn-En)+(In-On)*(In-On)),_n=[0,1,2,3,4],Un=((Tn-En)*(Ln-En)+(In-On)*(Pn-On))/Bn/Bn,Hn=En+Un*Bn*((Tn-En)/Bn),Xn=On+Un*Bn*((In-On)/Bn),Yn=Math.sqrt((Ln-En)*(Ln-En)+(Pn-On)*(Pn-On)),Kn=Math.sqrt((Ln-Tn)*(Ln-Tn)+(Pn-In)*(Pn-In)),Zn=Math.sqrt((Ln-Hn)*(Ln-Hn)+(Pn-Xn)*(Pn-Xn));return _n[0]=Math.sqrt((Ln-Hn)*(Ln-Hn)+(Pn-Xn)*(Pn-Xn)),Se(Un)||(_n[0]=Math.min(Yn,Kn)),_n[1]=Un,_n[2]=Hn,_n[3]=Xn,_n[4]=0,0>=(Tn-En)*(Pn-On)-(In-On)*(Ln-En)&&(_n[4]=1),_n}function Se(jn){return 0<=jn&&1>=jn}function ke(){localStorage.setItem('lastauthor',params.author)}function qe(jn){return': -1??'==jn?'':jn}function De(jn,Ln,Pn){Ln.value=jn+qe(': '+Pn),'-1??'!=Pn&&Ln.setAttribute('class','inguib aguibut')}function Ve(){De('RQD',Cs.rqd,Ns.RQD+Ns.RQDc),De('Jn',Cs.Jn,Ns.Jn+Ns.Jnc),De('Jr',Cs.Jr,Ns.Jr+Ns.Jrc),De('Ja',Cs.Ja,Ns.Ja+Ns.Jac),De('Jw',Cs.Jw,Ns.Jw+Ns.Jwc),De('SRF',Cs.SRF,Ns.SRF+Ns.SRFc),Ns.getQ(),'????'==Ns.Q+Ns.class?Cs.Q.name('Q = ?'):Cs.Q.name('Q = '+Ns.Q+Ns.class),Js.updateDisplay()}function Qe(jn,Ln){var Pn=jn.add(bf,'blank').name(Ln).__li;return Pn.setAttribute('class','cr function myguibut'),null==Ln&&Pn.removeChild(Pn.children[0]),Pn}function Me(jn){jn.style.height='5px',jn.style.height=jn.scrollHeight-5+'px'}function Ce(jn){for(var Ln=0;Ln<fs.length;Ln++)if(jn==fs[Ln])return bs[Ln]}function Re(jn){var Ln=0,Pn=Ji;null!=jn&&(Pn=jn);Jl.getObjectByName(Pn);return null==Xl[Pn]?Ln:1==Xl[Pn].skip?Ln:Xl[Pn].type}function Je(jn){var Ln=Ae(jn);if(-3==Ln)return void console.log('Nothing selected');var Pn=Re(jn);chosenp=Ln,-2==chosenp?(_s=new Be,_s.type=Pn,_s.coords=Bl,_s.isarea=Ne(Bl)):_s.restore(allp.par[chosenp]),Da('Select',Pn),Js.updateDisplay()}function Ae(jn){var Ln=Re(jn);if(!Ln)return console.log('Nothing selected'),-3;if('L'==Ln){var Pn=he(jn);Bl=ge(Pn),0==Bl.length&&console.log('No lines selected')}else Bl=[Xl[jn].xs,Xl[jn].ys];return allp.get(Bl)}function je(jn){for(var Ln=normPel(Sl,kl),Pn=Ln[0];Pn<Ln[1];Pn+=5)if(jn>=Pn&&jn<Pn+5){var En=allq.get(Pn),Tn=allq.get(Pn+5);if(-2==En&&-2==Tn)return console.log('No Q near'),[Pn,Pn+5];var On=Pn,In=-2==Tn?En:Tn;On=-2==Tn?Math.max(allq.qar[En].ps,allq.qar[En].pe):Math.min(allq.qar[Tn].ps,allq.qar[Tn].pe);var Bn=-2==Tn?5:-5;return[On,On+Bn]}return console.log('No q found'),[jn,jn+5*Ln[2]]}function Le(jn){var Ln=Pa(jn);if(Ws=allq.get(Ln),-2==Ws){Ns=new Ue,Ns.getQ();var Pn=je(Ln);Ns.ps=Pn[0],Ns.pe=Pn[1],Ns.comment=''}else Ns.restore(allq.qar[Ws]);ae(),Yl==qa.qval?(Js.removeFolder(qa.qval),za()):Da(qa.qval),Fs.close(),Js.removeFolder(qa.main),Js.removeFolder(qa.setproperties),Vs.open(),bi.visible=!0,bi.position.set(1.2*-Li,0.35*La(Ns.pe)+0.65*La(Ns.ps),10),Ve(),Js.updateDisplay()}function Pe(){setTimeout(function(){Js.open()},200)}function Ee(){Js.close()}function Te(){-1<Ws?(Ns.lastchange=wl,allq.qar[Ws].restore(Ns)):(allq.add(Ns),Ws=allq.qar.length-1),oman.updchangelist(Ns.sid),allq.update(),Xt(null,1)}function Oe(){allq.remove(Ws),allq.update(),ae(),Ns=new Ue,Ve()}function Ie(){if(0==Bl.length)return void console.log('No lines selected');if(-1<chosenp){if('undefined'==typeof allp.par[chosenp])return void console.log('No lines selected');allp.par[chosenp].restore(_s),allp.par[chosenp].author=params.author,allp.par[chosenp].lastchange=wl,'L'==allp.par[chosenp].type&&(allp.par[chosenp].color=St(Ce(_s.bergart)))}else _s.author=params.author,'L'==_s.type&&(_s.color=St(Ce(_s.bergart))),_s.sid=wl,allp.add(_s),chosenp=allp.amtok()-1;oman.sp=allp.par[chosenp],allq.update(),ae()}function Be(){this.author=params.author,this.sid=wl,this.lastchange=wl,this.type='',this.bergart='none',this.ispartofQ=0,this.id='',this.coords=[],this.color=0,this.comment='',this.width=0,this.dsc='Not given',this.wdrip=0,this.wleak=0,this.isarea=!1,this.restore=function(jn){var Ln=JSON.parse(JSON.stringify(jn));this.sid=Ln.sid,this.lastchange=null==Ln.lastchange?this.sid:Ln.lastchange,this.type=Ln.type,this.id=Ln.id,this.coords=Ln.coords,this.bergart=Ln.bergart,this.width=Ln.width,this.comment=Ln.comment,this.ispartofQ=Ln.ispartofQ,null!=Ln.author&&(this.author=Ln.author),this.isarea=Ln.isarea,this.color=Ln.color,null!=Ln.dsc&&(this.dsc=Ln.dsc,this.wdrip=Ln.wdrip,this.wleak=Ln.wleak)},this.sameas=function(jn){if(0==jn.length)return!1;for(var Ln=0;Ln<Math.min(jn.length,this.coords.length)&&!(6<Ln);Ln++){if(20<Ln)return console.log('Same',this.coords),!0;if(10<jn.length){var Pn=Aa(jn[Ln],this.coords[Ln]);if(!Pn)return!0}if(!Ja(jn[Ln],this.coords[Ln]))return!1}return!0},this.showprops=function(){var jn;return jn='W'==this.type?this.coords+' wdrip='+this.wdrip+' wleak='+this.wleak:this.bergart+' '+this.coords,jn}}function Ge(){this.par=[],this.getareas=function(){var jn=[];for(var Ln in this.par){var Pn=this.par[Ln];Pn.isarea&&!Pn.ispartofQ&&jn.push(Pn)}return jn},this.amtok=function(){for(var jn=0,Ln=0;Ln<this.par.length;Ln++)this.par[Ln].ispartofQ||jn++;return jn},this.add=function(jn,Ln){var Pn=new Be;Pn.restore(jn),this.par.push(Pn),null==Ln&&this.update()},this.remove=function(jn,Ln){if('object'==typeof jn)for(var Pn in console.log('Trying to remove',jn),this.par){var En=this.par[Pn];if(En==jn){this.par.splice(Pn,1);break}}else-1<jn&&this.par.splice(jn,1);null==Ln&&this.update()},this.cleanFromQ=function(){for(var jn=0;jn<this.par.length;jn++)1==this.par[jn].ispartofQ&&(this.remove(jn,1),jn--)},this.y2pelcoords=function(){for(var jn=0;jn<this.par.length;jn++)for(var Ln=0;Ln<this.par[jn].coords.length;Ln+=2)this.par[jn].coords[Ln+1]=Pa(this.par[jn].coords[Ln+1])},this.cleanFromPel=function(){for(var jn=0;jn<this.par.length;jn++)Ya(this.par[jn].coords[1])||(console.log('Skipping property',this.par[jn]),this.remove(jn),jn--)},this.get=function(jn){for(var Ln=0;Ln<this.par.length;Ln++)if(this.par[Ln].sameas(jn))return Ln;return-2},this.restore=function(jn,Ln,Pn){var En=!1;null!=Pn&&(En=Pn);for(var On,Tn=0;Tn<jn.par.length;Tn++)(On=this.ismemberalready(jn.par[Tn]),null==jn.par[Tn].sid&&(jn.par[Tn].sid=Jn),null==jn.par[Tn].author&&(jn.par[Tn].author=An),!(1==En&&jn.par[Tn].sid<wl))&&(1<En&&jn.par[Tn].sid!=En||(-1<On?this.par[On].restore(jn.par[Tn]):this.add(jn.par[Tn],Ln)));null==Ln&&(console.log('Update inside restore'),this.update())},this.ismemberalready=function(jn){for(var Ln=0;Ln<this.par.length;Ln++)if(this.par[Ln].sameas(jn.coords))return Ln;return-1},this.update=function(){mt.start('updatePinside');var jn=renderblock;if(renderblock=1,ga(),params.showbergart)for(var Ln=0;Ln<this.par.length;Ln++)if(('L'==this.par[Ln].type||this.par[Ln].ispartofQ)&&(this.par[Ln].isarea&&Ye(this.par[Ln].coords,Ce(this.par[Ln].bergart),this.par[Ln].ispartofQ),''!=this.par[Ln].comment)){var En,Tn,Pn=this.par[Ln].coords.length;En=this.par[Ln].coords[Pn-2],Tn=this.par[Ln].coords[Pn-1];var On=X('comment!',En,Tn,5,1);Ri.add(On)}renderblock=jn,mt.end('updatePinside')}}function Ne(jn){var Ln=jn.length;return Ln%2?(console.log('Odd amount of coordinates?'),console.log(jn),!1):!(8>Ln)&&jn[0]==jn[Ln-2]&&jn[1]==jn[Ln-1]}function _e(jn){var Ln=Sl<kl,Pn=allq.get(jn);return-1<Pn&&(Ln=allq.qar[Pn].ps>allq.qar[Pn].pe?0:Ln),Sl<tunborder&&(Ln=13730<jn&&13915>jn||14350<jn&&14980>jn?0:1),17057<jn&&17068>jn&&(Ln=1),Ln}function We(){this.qar=[],this.add=function(jn){var Ln=new Ue;Ln.restore(jn),this.qar.push(Ln)},this.get=function(jn){for(var Tn,Ln=1e3,Pn=-2,En=0;En<this.qar.length;En++)Tn=Ln,(this.qar[En].pe>jn&&this.qar[En].ps<jn||this.qar[En].ps>jn&&this.qar[En].pe<jn)&&(Ln=Math.min(Ln,Math.abs(jn-this.qar[En].ps),Math.abs(jn-this.qar[En].pe),Math.abs(jn-(this.qar[En].pe+this.qar[En].ps)/2)),Tn!=Ln&&(Pn=En));return Pn},this.remove=function(jn){-1<jn&&(console.log('Removed Q'),oman.updchangelist(this.qar[jn].sid),this.qar.splice(jn,1))},this.removeP=function(jn){var Ln=this.get(jn);-1<Ln?this.qar.splice(Ln,1):console.log('No such Q with pel'+jn)},this.getoverlaps=function(){for(var jn=[],Ln=0;Ln<this.qar.length;Ln++){for(var Pn=0,En=this.qar[Ln],Tn=Math.min(En.ps,En.pe),On=Math.max(En.ps,En.pe),In=Ln+1;In<this.qar.length;In++){var Bn=this.qar[In],Gn=Math.min(Bn.ps,Bn.pe),Nn=Math.max(Bn.ps,Bn.pe);if(Gn<=On&&Gn>=Tn){if(Gn==On)continue;var _n=[Gn,Math.min(Nn,On)];jn.push(_n),En.Q==Bn.Q&&En.comment==Bn.comment&&(En.sid>Bn.sid?(console.log('Removing overlap',Bn),this.remove(In),In--):Pn=1);continue}if(Nn<=On&&Nn>=Tn){if(Nn==Tn)continue;var _n=[Math.max(Gn,Tn),Nn];jn.push(_n),En.Q==Bn.Q&&En.comment==Bn.comment&&(En.sid>Bn.sid?(console.log('Removing overlap',Bn),this.remove(In),In--):Pn=1)}}Pn&&(console.log('Removing i',En),this.remove(Ln),Ln--)}return 2<jn.length&&console.log('Overlaps',jn),jn},this.update=function(){mt.start('updateQ'),mt.start('Get Q overlaps'),this.getoverlaps(),mt.end('Get Q overlaps'),ha(),mt.start('Clean Q'),allp.cleanFromQ(),mt.end('Clean Q');for(var jn=0;jn<this.qar.length;jn++)if(ua(this.qar[jn].ps,this.qar[jn].pe,this.qar[jn].getQ(),this.qar[jn].class,this.qar[jn].comment),'none'!=this.qar[jn].bergart){var Ln=new Ge,Pn=new Be;Pn.ispartofQ=1;var En=La(this.qar[jn].ps),Tn=La(this.qar[jn].pe);Pn.coords=[-Li,En,-Li,Tn,Li,Tn,Li,En],Pn.bergart=this.qar[jn].bergart,Pn.isarea=!0,Ln.add(Pn,1),allp.restore(Ln,1)}mt.start('updatePFinal'),allp.update(),mt.end('updatePFinal'),mt.end('updateQ')},this.clear=function(){ha(),this.qar=[]},this.restore=function(jn,Ln,Pn){var En=!1;null!=Pn&&(En=Pn);for(var Tn=0;Tn<jn.qar.length;Tn++)if((null==jn.qar[Tn].sid&&(jn.qar[Tn].sid=Jn),null==jn.qar[Tn].author&&(jn.qar[Tn].author=An),!(1==En&&jn.qar[Tn].sid<wl))&&!(1<En&&jn.qar[Tn].sid!=En)){if(params.onlycurpel&&(!Ya(jn.qar[Tn].ps)||!Ya(jn.qar[Tn].pe))){console.log('Q not in limits'+jn.qar[Tn].ps+' '+jn.qar[Tn].pe);continue}var On=this.isequal(jn.qar[Tn]);-1<On?this.qar[On].restore(jn.qar[Tn]):this.add(jn.qar[Tn])}null==Ln&&this.update()},this.isequal=function(jn){for(var Ln=0;Ln<this.qar.length;Ln++)if(this.qar[Ln].ps==jn.ps&&this.qar[Ln].pe==jn.pe)return Ln;return-1}}function Ue(){this.author=params.author,this.sid=wl,this.lastchange=wl,this.ps=Sl,this.pe=kl,this.RQDc='??',this.Jrc='??',this.Jwc='??',this.Jnc='??',this.Jac='??',this.SRFc='??',this.Jnmult=1,this.RQD=-1,this.Jr=-1,this.Jw=-1,this.Jn=-1,this.Ja=-1,this.SRF=-1,this.Q='??',this.class='??',this.comment='',this.bergart='none',this.getQ=function(){return 0>this.RQD||0>this.Jr||0>this.Jr||0>this.Jn||0>this.Ja||0>this.SRF?this.Q:(this.Q=Math.round(1e3*(Math.max(this.RQD,10)*this.Jr*this.Jw/(this.Jn*this.Ja*this.SRF)))/1e3,0.01<this.Q&&(this.Q=Math.round(100*this.Q)/100),1<this.Q&&(this.Q=Math.round(10*this.Q)/10),this.class='G',0.01<this.Q&&(this.class='F'),0.1<this.Q&&(this.class='E'),1<this.Q&&(this.class='D'),4<this.Q&&(this.class='C'),10<this.Q&&(this.class='A/B'),this.Q)},this.restore=function(jn){this.ps=jn.ps,this.pe=jn.pe,this.comment=jn.comment,this.bergart=jn.bergart,this.RQDc=jn.RQDc,this.Jrc=jn.Jrc,this.Jwc=jn.Jwc,this.Jnc=jn.Jnc,this.Jac=jn.Jac,this.SRFc=jn.SRFc,this.Jnmultc=1,this.RQD=jn.RQD,this.Jr=jn.Jr,this.Jw=jn.Jw,this.Jn=jn.Jn,this.Ja=jn.Ja,this.SRF=jn.SRF,null!=jn.author&&(this.author=jn.author),null!=jn.sid&&(this.sid=jn.sid),this.lastchange=null==jn.lastchange?this.sid:jn.lastchange,this.getQ()}}function Ye(jn,Ln,Pn){for(var On,En=[],Tn=0;Tn<jn.length;Tn+=2)On=new THREE.Vector3(jn[Tn],jn[Tn+1],1-0.02*Pn),En.push(On);var Bn,Gn,Nn=new THREE.Geometry,_n=new THREE.MeshBasicMaterial({color:Ln,transparent:!0,opacity:0.7});_n.side=THREE.DoubleSide,Nn.vertices=En,Bn=THREE.ShapeUtils.triangulateShape(En,[]);for(var Tn=0;Tn<Bn.length;Tn++)Nn.faces.push(new THREE.Face3(Bn[Tn][0],Bn[Tn][1],Bn[Tn][2]));Gn=new THREE.Mesh(Nn,_n),Ri.add(Gn),ae()}function Ke(jn){for(var Ln=jn.elements,Pn=0;Pn<Ln.length;Pn++)Ln[Pn]=mr(Ln[Pn]);return Ln}function $e(jn,Ln){var Pn={x:(jn/Li+1)/2,y:(Ln/Pi+1)/2};return Pn}function et(jn,Ln){var Pn=Ln.x-jn[0].x,En=Ln.y-jn[0].y,Tn=0<(jn[1].x-jn[0].x)*En-(jn[1].y-jn[0].y)*Pn;return 0<(jn[2].x-jn[0].x)*En-(jn[2].y-jn[0].y)*Pn!=Tn&&0<(jn[2].x-jn[1].x)*(Ln.y-jn[1].y)-(jn[2].y-jn[1].y)*(Ln.x-jn[1].x)==Tn}function tt(){controls.reset(),controls.target.set(0,0,0),camera.position.set(0,0,ss),cameraFix.position.set(0,0,ss),Na(),lt(),Qa()}function lt(){var jn=window.devicePixelRatio;Ml=ul,Cl=hl,camera.left=-Li,camera.right=Li,camera.top=Pi+Ei,camera.bottom=-Pi+Ei,cameraFix.left=-Li,cameraFix.right=Li,cameraFix.top=Pi+Ei,cameraFix.bottom=-Pi+Ei,'Geo+Q+Pel'==params.what2plot&&(camera.left=-Li-1.2,camera.right=Li+1.2,Ml*=1.3,lsc=0.5),Ml/=jn,Cl/=jn;'For 3d'!=params.what2plot&&4096<Cl&&(Ml=4096*Ml/Cl,Cl=4096);var Pn=Ml,En=Cl;'For 3d'==params.what2plot,renderer.setSize(Pn,En),Zi=new THREE.Vector2(Pn,En),'For 3d'==params.what2plot&&(lsc=Math.min(0.5,5e3/En));var Tn=android||iOS?4:1;buftext=new THREE.WebGLRenderTarget(4096/Tn,16384/Tn,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat}),camera.updateProjectionMatrix(),cameraFix.updateProjectionMatrix()}function it(){Ql||(sensivity=1,V(),params.what2plot='For 3d',vt(Sl,kl,1),tt(),Va(),Ql=!0,renderer.render(Jl,cameraFix,buftext),ut(),Mt(),camera.position.set(0,0,1e3),params.what2plot='Geo+Q+Pel',controls.enableRotate=!0,ae(),check3dbox.style.display='',check3dbox.checked=!0,fgui.close(),Da('3d'))}function rt(){if(Ql){for(sensivity=5,V();0<gi.children.length;)gi.remove(gi.children[0]);buftext.dispose(),Jl=yi,params.resetcam(),controls.enableRotate=!1,Ql=!1,camera.position.set(0,0,ss),lsc=1,ut(),Qa(),Va(),vt(Sl,kl),setTimeout(function(){ae()},50),Hi.value='Select',Da('Line'),check3dbox.style.display='none',fgui.close(),Js.close()}}function dt(){kl+=5*pmult,Sl-=5*pmult,zl=Math.abs(parseInt(Sl)-parseInt(kl)),hl=Fl*zl,Cl=hl,Pi=hl/ji,E(Sl,kl,Ei),vt(Sl,kl),ua(Sl,kl,-1),pt(gl,La(kl-2.5*pmult)),pt(gl,La(Sl+2.5*pmult)),ae()}function pt(jn,Ln){var Pn=new THREE.MeshBasicMaterial({color:16777215}),En=new THREE.PlaneGeometry(5*(2*(Fl/ji)),2*Li,1,1),Tn=new THREE.Mesh(En,Pn);Tn.position.set(0,Ln,0),Tn.rotateZ(Math.PI/2),Hl.push(Tn),vi.add(Tn)}function ut(){z(),Zi=new THREE.Vector2(Yi,Ki),as=Yi/Ki,camera.left=-ls*as/2,camera.right=ls*as/2,camera.top=is/2,camera.bottom=-is/2,camera.updateProjectionMatrix(),renderer.setSize(Yi,Ki),ae()}function gt(){if(Rs)return!1;for(var jn=0,Ln=0;Ln<Xl.length;Ln++)1!=Xl[0].skip&&(jn=1);if(allq.qar.length&&(jn=1),!jn)return!1;var Pn=new Date().getTime(),En=Ia(1),Tn=JSON.stringify(En);localStorage.setItem(Kl.s,Tn);var On=new Date().getTime()-Pn;return console.log('dT = '+On),!0}function yt(){if(localStorage.getItem(Kl.l)){var jn=localStorage.getItem(Kl.l),Ln=JSON.parse(jn);console.log('Sid set to',Ln.sid),Ra(Ln),allq.update(),Qa(),ae(),params.restses=0,Da('Line')}}function vt(jn,Ln,Pn){if(Jl.remove(Fi),!!params.rutenett){Fi=new THREE.Object3D;var En=normPel(jn,Ln),Tn=En[0],On=En[1],In=-4;null!=Pn&&(In=-0.5);for(var Un,Wn=Tn;Wn<=On;Wn++){Un=[],Un.push(-Li,La(Wn),1,1.13*Li,La(Wn),1);var Hn=N(Un,In,'0#000000');Fi.add(Hn)}Jl.add(Fi)}}function xt(){if(params.vederlag){var jn=tungeom[params.tunnel].Width,Ln=[];for(var Pn in jn){var En=jn[Pn][1],Tn=jn[Pn][3],On=jn[Pn][5],In=On-En;Ln.push([jn[Pn][0],2*((jn[Pn][2]-En)/In)-1,2*((jn[Pn][3]-En)/In)-1,2*((jn[Pn][4]-En)/In)-1])}for(var Hn,Xn,Yn,Kn,In,Bn=normPel(Sl,kl),Gn=Bn[0],Nn=Bn[1],_n=[],Wn=[],Un=[],Zn=1,Pn=Gn;Pn<Nn;Pn++){if(In=Math.max(Pn,Ln[0][0]),In=Pn,Hn=wt(In,Ln),Yn=La(In),Xn=wt(In+pmult,Ln),Kn=La(In+1),!Hn||!Xn){console.log('No vederlag data for pel=',Pn),Zn=0;break}_n.push(Hn[0]),_n.push(Yn),_n.push(1),Wn.push(Hn[1]),Wn.push(Yn),Wn.push(1),Un.push(Hn[2]),Un.push(Yn),Un.push(1)}Zn&&(_n.push(Xn[0]),_n.push(Kn),_n.push(1),Wn.push(Xn[1]),Wn.push(Kn),Wn.push(1),Un.push(Xn[2]),Un.push(Kn),Un.push(1)),N(_n,-4,'0#000000'),N(Wn,-4,'0#000000'),N(Un,-4,'0#000000')}}function wt(jn,Ln){for(var Pn=Ln.length,En=xct=xrt=0,Tn=0,On=0,In=0;In<Pn-1;In++)if(jn>=Ln[In][0]&&jn<Ln[In+1][0]||jn<=Ln[In][0]&&jn>Ln[In+1][0]){var Bn=Ln[In+1][0]-Ln[In][0];0==Bn?Tn=[Ln[In][1]*Li,Ln[In][2]*Li,Ln[In][3]*Li]:(On=(jn-Ln[In][0])/(Ln[In+1][0]-Ln[In][0]),En=Ln[In][1]+On*(Ln[In+1][1]-Ln[In][1]),xct=Ln[In][2]+On*(Ln[In+1][2]-Ln[In][2]),xrt=Ln[In][3]+On*(Ln[In+1][3]-Ln[In][3]),Tn=[En*Li,xct*Li,xrt*Li])}return Tn?Tn:jn<Ln[0][0]?[Ln[0][1]*Li,Ln[0][2]*Li,Ln[0][3]*Li]:[Ln[Pn-1][1]*Li,Ln[Pn-1][2]*Li,Ln[Pn-1][3]*Li]}function St(jn,Ln){var Pn=jn;return 7==Pn.length?(Pn=null==Ln?'0x'+Pn[5]+Pn[6]+Pn[3]+Pn[4]+Pn[1]+Pn[2]:'0x'+Pn[1]+Pn[2]+Pn[3]+Pn[4]+Pn[5]+Pn[6],parseInt(Pn)):0}function kt(){Ql?(Ni.style.display='none',_i.style.display='none',Wi.style.display='none',Hi.style.display='none',Xi.style.display='none'):(Ni.style.display='',_i.style.display='',Wi.style.display='',Hi.style.display='',Xi.style.display='')}function zt(){Ni.setAttribute('class','geobutton'),_i.setAttribute('class','geobutton'),Wi.setAttribute('class','geobutton'),Ui.setAttribute('class','geobutton'),Hi.setAttribute('class','geobutton')}function Dt(jn){var Ln=[],Pn=jn.length;for(var En in Ln.push(Lt(jn[0][0]+1,jn)),jn)jn[En][0]>jn[0][0]+1&&jn[En][0]<jn[Pn-1][0]-1&&Ln.push(Lt(jn[En][0],jn));return Ln.push(Lt(jn[Pn-1][0]-1,jn)),Ln}function Vt(jn){var Ln=tungeom[jn].TunProfile,Pn=parse3dmod(Ln),En=Dt(Pn),Tn=Rt(Pn);for(var On in En)Tn.add(Qt(En[On]));var In=(Pn[0][0]+Pn[Pn.length-1][0])/2,Bn=-La(In);return[Pn,Tn]}function Qt(jn){var Ln=[];for(var Pn in jn.v)Ln.push(jn.v[Pn].x),Ln.push(jn.v[Pn].y),Ln.push(jn.v[Pn].z);var En=new THREE.Object3D,Tn=N(Ln,10,'0#000000');return En.add(Tn),En}function Mt(){p2y=La;var jn=Vn,Ln=jn[0];lingeom=new THREE.Object3D,lingeom.add(Vn[1]),lingeom.add(Mn);var Pn=(Ln[0][0]+Ln[Ln.length-1][0])/2,En=La(Pn),Tn=getglobc((Sl+kl)/2);lingeom.position.set(-Tn.x,-Tn.y,-Tn.z);var On=jt(Ln),In=On[0];for(var Bn in partlingeom=On[1],pmat=new THREE.MeshBasicMaterial({map:buftext.texture,transparent:!0,opacity:0.5,depthTest:!0}),pmat.side=THREE.DoubleSide,my3dgroup=new THREE.Object3D,meshes=new THREE.Object3D,In){var Gn=new THREE.Mesh(In[Bn][2],pmat);Gn.castShadow=!1,Gn.receiveShadow=!1,meshes.add(Gn)}meshes.position.set(-Tn.x,-Tn.y,-Tn.z),my3dgroup.add(meshes),gi=new THREE.Scene,yi=Jl;var Tn=getglobc((Sl+kl)/2),Nn=new THREE.Object3D;''!=strin&&Nn.add(Vi),Nn.position.set(-Tn.x,-Tn.y,-Tn.z),my3dgroup.add(Nn),In[0][2].computeBoundingSphere();var _n=In[0][2].boundingSphere.center,Wn=new THREE.Quaternion;Wn.setFromUnitVectors(new THREE.Vector3(0,0,1),new THREE.Vector3(0,1,0)),my3dgroup.applyQuaternion(Wn);for(var Un,Hn,Xn=0;Xn<oman.ao.length;Xn++)if('B'==oman.ao[Xn].type){var Yn=$e(oman.get(Xn).xs,oman.get(Xn).ys),Kn=Pa(oman.get(Xn).ys),Zn=new THREE.Vector2(Yn.x,Yn.y);for(var $n in In)if(numintersect(In[$n][0],In[$n][1],Kn,Kn)){Un=qn(meshes.children[$n],Zn);break}var eo=$e(oman.get(Xn).xe,oman.get(Xn).ye),Kn=Pa(oman.get(Xn).ye),Zn=new THREE.Vector2(eo.x,eo.y);for(var $n in In)if(numintersect(In[$n][0],In[$n][1],Kn,Kn)){Hn=qn(meshes.children[$n],Zn);break}var to=Hn[0],ao=Hn[1],lo=Un[0],no=Un[1],oo=-10,po=Fn(new THREE.Vector3(lo.x,lo.y,lo.z),new THREE.Vector3(to.x+1*(no.x*oo),to.y+1*(no.y*oo),to.z+1*(no.z*oo)));Nn.add(po)}my3dgroup.add(lingeom),my3dgroup.add(partlingeom),gi.add(my3dgroup),gi.add(fallar),gi.add(line3dgroup),gi.add(line3dtemp),controls.enableRotate=!0,ae()}function Rt(jn){for(var Ln=jn[0][1].length,Pn=new THREE.Object3D,En=[],Tn=jn[0][1],On=[],In=jn[0][0]+1;In<jn[jn.length-1][0]-1;In+=2)On.push(Lt(In,jn));for(var Bn in Tn){for(var Gn in En=[],On){var Nn=On[Gn],_n=Nn.v[Bn];En.push(_n.x,_n.y,_n.z)}var Bn=N(En,5,'0#000000');Pn.add(Bn)}return Pn}function At(jn,Ln){var Pn=[];if(jn<Ln[0][0])return Qi=[jn,Ln[0][1]],Qi;if(jn>Ln[Ln.length-1][0])return Qi=[jn,Ln[Ln.length-1][1]],Qi;for(var En=1;En<Ln.length;En++)if(jn>=Ln[En-1][0]&&jn<=Ln[En][0]){var Tn=Ln[En-1][0],On=Ln[En][0],In=(jn-Tn)/(On-Tn);for(var Bn in Ln[En][1]){var Gn=Ln[En][1][Bn],Nn=Ln[En-1][1][Bn];Pn.push(new THREE.Vector2(Gn.x*In+Nn.x*(1-In),Gn.y*In+Nn.y*(1-In)))}break}return Pn.length||console.log('Error! Vout not defined in getcurveatpel'),[jn,Pn]}function jt(jn){for(var Nn,Ln=Sl,Pn=kl,En=At(Ln,jn),Tn=At(Pn,jn),On=-1,In=[[0,En]],Bn=[],Gn=0;Gn<jn.length;Gn++)if((Nn=jn[Gn][0],Math.round(On)!=Math.round(Nn))&&(On=Nn,Nn=Math.round(Nn),Ka(Nn,Ln,Pn))){var _n=(Nn-Ln)/(Pn-Ln);Bn.push([_n,jn[Gn]])}if(0<pmult)for(var Wn=0;Wn<Bn.length;Wn++)In.push(Bn[Wn]);else for(var Wn=Bn.length-1;-1<Wn;Wn--)In.push(Bn[Wn]);In.push([1,Tn]);for(var Un=new THREE.Object3D,Hn=[],Xn=[],Wn=0;Wn<In.length-1;Wn++)for(var Yn=In[Wn][1][0],Kn=In[Wn+1][1][0],Zn=0,Gn=Yn;0>(Gn-Kn)*pmult;Gn+=5*pmult){Zn++;var _n=(Gn-Ln)/(Pn-Ln);if(Xn.push([_n,At(Gn,jn)]),500<Zn)return}Xn.push(In[In.length-1]);for(var Wn=1;Wn<Xn.length;Wn++){var $n=Lt(Xn[Wn][1][0],jn),eo=Lt(Xn[Wn-1][1][0],jn);Hn.push([Xn[Wn-1][1][0],Xn[Wn][1][0],Pt(eo,$n,Xn[Wn-1][0],Xn[Wn][0])])}return[Hn,Un]}function Lt(jn,Ln){var Pn=At(jn,Ln),En=getglobc(jn),Tn=getglobc(jn,1)[1]/180*Math.PI,On=getglobc(jn+0.01),In=new THREE.Quaternion;null==On?(On=getglobc(jn).sub(getglobc(jn-0.01)).normalize(),On=On.normalize(),On.z=0,In.setFromUnitVectors(new THREE.Vector3(1,0,0),On)):(On=getglobc(jn+0.01).sub(En),On=On.normalize(),On.z=0,In.setFromUnitVectors(new THREE.Vector3(1,0,0),On)),0.1<Math.abs(In.y)&&(console.log(jn,En,On),console.log(jn,In));var Bn={pel:jn,v:[]};for(var Gn in Pn[1]){var Nn=Pn[1][Gn],_n=Math.sin(Tn),Wn=Math.cos(Tn),Un=new THREE.Vector3(0,Nn.x,Nn.y);Un.applyAxisAngle(new THREE.Vector3(1,0,0),Tn),Un.applyQuaternion(In),Un.add(En),Bn.v.push(Un)}return Bn}function Pt(jn,Ln,Pn,En){var Tn=new THREE.Geometry,On=0,In=jn.v.length;Tn.faceVertexUvs[0]=[];for(var Bn=0;Bn<In-1;++Bn){var Gn=jn.v[Bn],Nn=jn.v[Bn+1],_n=Ln.v[Bn],Wn=Ln.v[Bn+1],Un=Bn/(In-1),Hn=(Bn+1)/(In-1),Xn=null==Pn?0:Pn,Yn=null==En?1:En;Tn.vertices.push(new THREE.Vector3(Gn.x,Gn.y,Gn.z)),Tn.vertices.push(new THREE.Vector3(Nn.x,Nn.y,Nn.z)),Tn.vertices.push(new THREE.Vector3(_n.x,_n.y,_n.z)),Tn.vertices.push(new THREE.Vector3(Wn.x,Wn.y,Wn.z)),Tn.faces.push(new THREE.Face3(On+2,On+1,On)),Tn.faces.push(new THREE.Face3(On+1,On+2,On+3)),Tn.faceVertexUvs[0].push([new THREE.Vector2(Un,Yn),new THREE.Vector2(Hn,Xn),new THREE.Vector2(Un,Xn)]),Tn.faceVertexUvs[0].push([new THREE.Vector2(Hn,Xn),new THREE.Vector2(Un,Yn),new THREE.Vector2(Hn,Yn)]),On+=4}return Tn.uvsNeedUpdate=!0,Tn.computeFaceNormals(),Tn}function Et(){Mn=new THREE.Object3D;var jn=tun2='';if('34100'==params.tunnel&&(tun2='34100',jn='34000'),'34000'==params.tunnel&&(tun2='34000',jn='34100'),jn){globavg=tungeom[jn].Geo3d.globavg,globtc=tungeom[jn].Geo3d.globtc,Mn=Vt(jn)[1];var Ln=tv().copy(tungeom[jn].Geo3d.globavg).sub(tungeom[tun2].Geo3d.globavg);Ln.y=-Ln.y,Mn.position.set(Ln.x,Ln.y,Ln.z)}globavg=tungeom[params.tunnel].Geo3d.globavg,globtc=tungeom[params.tunnel].Geo3d.globtc,globtc[0].pel-=0.1,('Kjorholt'==params.tunnel||'Tunnel1'==params.tunnel)&&(globtc[0].pel=13650),globtc[globtc.length-1].pel+=0.1,Vn=Vt(params.tunnel),''!=strin&&(!android&&(strin=strin2),Vi=makecloud(strin))}function Tt(){var jn=linez.length;if(!(2>jn)){for(var Pn,Ln=1;Ln<jn;Ln++)Pn=new ja,Pn.addline(linez[Ln-1].xs,linez[Ln-1].ys,1,linez[Ln].xs,linez[Ln].ys,1,Math.round(30*params.size),'#000000'),oman.add(Pn);var En=linez[0].v,Tn=linez[Math.floor(jn/2)].v,On=linez[jn-1].v,In=Ot();return In}}function Ot(){for(var jn=linez.length,Ln=Math.floor(jn/3),Pn=Math.floor(2*jn/3),En=tv(),Tn=tv(),On=tv(),In=0;In<Ln;In++)En.add(linez[In].v);En.multiplyScalar(1/Ln);for(var In=Ln;In<Pn;In++)Tn.add(linez[In].v);Tn.multiplyScalar(1/(Pn-Ln));for(var In=Pn;In<jn;In++)On.add(linez[In].v);return On.multiplyScalar(1/(jn-Pn)),[En,Tn,On]}function Gt(jn){var Ln=new THREE.Plane().setFromCoplanarPoints(jn[0],jn[1],jn[2]),Pn=new THREE.Vector3((jn[0].x+jn[1].x+jn[2].x)/3,(jn[0].y+jn[1].y+jn[2].y)/3,(jn[0].z+jn[1].z+jn[2].z)/3),En=new THREE.BoxGeometry(150,150,0.5),Tn=new THREE.MeshBasicMaterial({color:17408,transparent:!0,opacity:0.1}),On=new THREE.Mesh(En,Tn),In=new THREE.Quaternion;In.setFromUnitVectors(new THREE.Vector3(0,0,1),Ln.normal),On.applyQuaternion(In),On.position.set(Pn.x,Pn.y,Pn.z),On.scale.set(fscale.val,fscale.val,1),fallar.add(On)}function Nt(jn){var Ln=new THREE.Plane().setFromCoplanarPoints(jn[0],jn[1],jn[2]),Pn=new THREE.Vector3((jn[0].x+jn[1].x+jn[2].x)/3,(jn[0].y+jn[1].y+jn[2].y)/3,(jn[0].z+jn[1].z+jn[2].z)/3),En=Ln.normal;0>En.y&&En.negate();var Tn=180*new THREE.Vector3(0,1,0).angleTo(En)/Math.PI,On=Pa(linez[0].ys),In=getglobc(On+1).sub(getglobc(On));In=In.normalize();var Bn=getglobc((Sl+kl)/2),Gn=new THREE.Quaternion;Gn.setFromUnitVectors(new THREE.Vector3(0,0,1),new THREE.Vector3(0,1,0)),In.applyQuaternion(Gn);var Nn=new THREE.Quaternion;Nn.setFromUnitVectors(new THREE.Vector3(0,1,0).applyQuaternion(Gn),new THREE.Vector3(1,0,0).applyQuaternion(Gn));var _n=tv().copy(In).applyQuaternion(Nn),Wn=new THREE.Plane().setFromCoplanarPoints(Pn,tv().copy(Pn).add(_n),tv().copy(Pn).add(In)),Un=tv().copy(En).projectOnPlane(Wn.normal),Hn=Un.angleTo(In)<Math.PI/2?1:0,Xn=180*Un.angleTo(_n)/Math.PI;return Xn=Hn?360-Xn:Xn,console.log('Strike:',Xn),console.log('Dip/Fall',Tn),[Math.floor(Xn),Math.round(Tn)]}function Ut(){if(linez.length){var jn=new ConvexHullGrahamScan;for(var Ln in linez)jn.addPoint(linez[Ln].xs,linez[Ln].ys);var Pn=jn.getHull(),En=[];for(var Tn in linez)for(var Ln in Pn){var On=linez[Tn];Pn[Ln].x==On.xs&&Pn[Ln].y==On.ys&&En.push(On)}linez=En,linez.sort(function(_n,Wn){return Wn.xs-_n.xs});var In=y=0;for(var Tn in linez)In+=linez[Tn].xs,y+=linez[Tn].ys;In/=linez.length,y/=linez.length;var Bn=Tt(),Gn=Nt(Bn),Nn=new ja;Nn.addfall(In,y,8,Gn[0],Gn[1],1),Nn.color=Bn,oman.plot(Nn),oman.add(Nn),Ht(linez),Qa(),ae(),linez=[],controls.enableRotate=!0,check3dbox.checked=!0,Js.updateDisplay()}}function Ht(jn){var Ln=[];for(var Pn in jn)Ln.push(jn[Pn].v.x,jn[Pn].v.y,jn[Pn].v.z);if(Ln.length){var En=N(Ln,Math.round(40*params.size),'#000000',1);line3dgroup.add(En)}}function Xt(jn,Ln){var Pn=new Date().getTime(),En=5e3;if(null!=Ln&&(En=Ln),Pn-pi>En){for(var Tn in Rl){var On=Rl[Tn];On.redrawInterval=1}for(var Tn in ae(jn),Rl){var On=Rl[Tn];On.redrawInterval=1e5}pi=Pn}else ae(jn)}function ea(){params.withbg?ia(gl):ia(''),us.material=ms,ae()}function ia(jn){if(''==jn)ms=new THREE.MeshBasicMaterial({color:16777215});else{var Ln=new THREE.TextureLoader;Ln.crossOrigin='anonymous';var Pn=Ln.load(jn,function(){ae()});Pn.magFilter=THREE.NearestFilter,Pn.minFilter=THREE.LinearMipMapLinearFilter,Pn.anisotropy=2,Sl>kl&&(Pn.flipY=!1),ms=new THREE.MeshBasicMaterial({map:Pn})}}function oa(jn,Ln){wl=getsessionid(),M(),kl=parseInt(Ln),Sl=parseInt(jn),pmult=Sl<kl?1:-1,Dl=(Sl+kl)/2,zl=Math.abs(parseInt(Sl)-parseInt(kl)),Fl=50,11>zl&&(Fl=100),6>zl&&(Fl=200),hl=Fl*zl,Cl=hl,Pi=hl/ji,E(Sl,kl,Ei),vt(Sl,kl),ca(gl,0),ua(Sl,kl,-1),params.resetcam(),ae(),picparams.ps=Sl,picparams.pe=kl,saveifokdist(picparams.ps,picparams.pe),fgui.updateDisplay()}function ra(jn,Ln,Pn){var En=params.tunnel;null!=Pn&&(En=Pn);var Tn=jn>Ln,On=Math.min(jn,Ln),In=Math.max(jn,Ln),Bn=1*Math.floor(On/1),Gn=1*Math.floor((In-0.01)/1+1),Nn=gettunlim(En);('Kjorholt'==params.tunnel||'Tunnel1'==params.tunnel)&&(Nn.pmin=13650),'34100'==params.tunnel&&(Nn.pmin=0);var _n=checklims(Bn,Gn,Nn);Bn=_n[0],Gn=_n[1],picdb.sortbypelasc();var Wn=getpicsinrange(En,Bn,Gn);gl='';var Un=Wn.length;for(var Hn in Un&&(Bn=parseFloat(picdb.files[Wn[0]].ps),Gn=parseFloat(picdb.files[Wn[Un-1]].pe)),Tn?oa(Gn,Bn):oa(Bn,Gn),Wn)pa(picdb.files[Wn[Hn]],Tn);rt(),fgui.close(),Js.close()}function pa(jn,Ln){var Pn=Sl>kl;null!=Ln&&(Pn=Ln);var En=new THREE.TextureLoader;En.crossOrigin='anonymous';var Tn=En.load(jn.pic,function(){ae()});Tn.magFilter=THREE.NearestFilter,Tn.minFilter=THREE.LinearMipMapLinearFilter,Tn.anisotropy=2,Pn&&(Tn.flipY=!1);var On=new THREE.MeshBasicMaterial({map:Tn}),In=Math.abs(La(Math.max(jn.ps,jn.pe))-La(Math.min(jn.ps,jn.pe))),Bn=La((jn.ps- -jn.pe)/2),Gn=new THREE.PlaneGeometry(In,2*Li,1,1);us=new THREE.Mesh(Gn,On),us.position.set(0,Bn,0.01);var Nn=Pn?Math.PI:0;us.rotateZ(Math.PI/2+Nn),Hl.push(us),vi.add(us)}function ca(jn,Ln){Jl.remove(vi),vi=new THREE.Object3D,Hl.length=0,ia(jn);var Pn=new THREE.PlaneGeometry(2*Pi,2*Li,1,1);us=new THREE.Mesh(Pn,ms),us.position.set(0,Ln/Fl,0);var En=Sl>kl?Math.PI:0;us.rotateZ(Math.PI/2+En),Hl.push(us),vi.add(us),Jl.add(vi)}function ua(jn,Ln,Pn,En,Tn){var On,In=!1;-1==Pn?(In=!0,On=11184810):(On=16711680,1<Pn&&(On=16769024),4<Pn&&(On=16746240),10<Pn&&(On=2258722));var Bn=In?1:0.8,Gn=new THREE.MeshBasicMaterial({color:On,transparent:!0,opacity:Bn}),Nn=La((jn+Ln)/2),_n=Math.abs(La(Ln)-La(jn)),Wn=Li/3,Un=-Li-Wn+Li/10,Hn=new THREE.PlaneGeometry(Wn,_n,1,1),Xn=new THREE.Mesh(Hn,Gn);if(Xn.position.set(Un,Nn,In?0:1),In){var Yn=Ci.children[0];null!=Yn&&Ci.remove(Yn),Ci.add(Xn),Hl.push(Xn)}else{Mi.add(Xn);var Kn=X('Q='+Pn+' '+En,Un,Nn,10,0);if(Mi.add(Kn),null!=Tn&&''!=Tn){for(var Zn='',$n=0;$n<Math.min(4,Tn.length);$n++)Zn+=Tn[$n];Zn+='..!';var eo=X(Zn,Un-0.35*Ti,Nn+0.38*_n,10,1);Mi.add(eo)}}}function ha(){for(;Mi.children.length;){var jn=Mi.children[0];'undefined'!=typeof jn.material&&jn.material.dispose(),'undefined'!=typeof jn.geometry&&jn.geometry.dispose(),Mi.remove(jn)}}function ga(){for(;Ri.children.length;){var jn=Ri.children[0];'undefined'!=typeof jn.material&&jn.material.dispose(),'undefined'!=typeof jn.geometry&&jn.geometry.dispose(),Ri.remove(jn)}}function ya(){for(;Si.children.length;){var jn=Si.children[0];'undefined'!=typeof jn.material&&jn.material.dispose(),'undefined'!=typeof jn.geometry&&jn.geometry.dispose(),Si.remove(jn)}for(;Di.children.length;){var jn=Di.children[0];'undefined'!=typeof jn.material&&jn.material.dispose(),'undefined'!=typeof jn.geometry&&jn.geometry.dispose(),Di.remove(jn)}for(;xi.children.length;){var jn=xi.children[0];'undefined'!=typeof jn.material&&jn.material.dispose(),'undefined'!=typeof jn.geometry&&jn.geometry.dispose(),xi.remove(jn)}}function ba(jn,Ln){var Pn=document.createElement('input',Ln);Pn.setAttribute('class','inguib'),Pn.setAttribute('type','button'),Pn.setAttribute('value',jn),Pn.setAttribute('id','mgb'+jn);var En=new Hammer(Pn);return Pn.onfocus=function(){Pn.blur()},En.on('press',function(){mycswitch(Pn,'ibpressed',500),null!=Ln&&setTimeout(function(){Ln()},150)}),En.get('press').set({threshold:100,time:3}),Pn}function xa(){var jn=new FormData;jn.append('data',params.author);try{var Ln=window.XMLHttpRequest?new XMLHttpRequest:new activeXObject('Microsoft.XMLHTTP');Ln.onreadystatechange=function(){if(4===Ln.readyState){var Pn=JSON.parse(Ln.response);filetable(container,Pn,function(En){var Tn=pelfromfname(En),On=Tn[0],In=Tn[1];saveifokdist(On,In),wa(En)})}},Ln.open('post',baseaddr+'getflist.php',!0),Ln.send(jn)}catch(Pn){console.log(Pn)}}function wa(jn){var Ln=new FormData;Ln.append('fname',jn);try{var Pn=window.XMLHttpRequest?new XMLHttpRequest:new activeXObject('Microsoft.XMLHTTP');Pn.onreadystatechange=function(){if(4===Pn.readyState){if(params.overridepel){var En=pelfromfname(jn),Tn=getpelrange(Pn.response,En[0],En[1]);Cn=[],gl='',oa(Tn[0],Tn[1])}Ra(Pn.response),allq.update(),Qa(),ae()}},Pn.open('post',baseaddr+'gettxt.php',!0),Pn.send(Ln)}catch(En){console.log(En)}}function Sa(jn){var Ln=basekjor;'Kjorholt'==jn&&(Ln=basekjor),'Bamle'==jn&&(Ln=basebamble);var Pn=jn+picparams.ps+'_'+picparams.pe+'.xml',En=Ln+Ta(jn)+endfile,Tn=vkbeautify.xml(En);download(Tn,Pn)}function ka(jn,Ln){var Pn=Js.add(bf,'blank').name('Geology:');Pn.onChange(function(){Js.close()}),Pn.__li.setAttribute('class','cr function first');var En=parseFloat(Js.domElement.style.width)-1;Pn.__li.style.width=En+'px';var Tn=Qe(Js),On=ba('ShowDB',function(){As.showdb()});On.setAttribute('class','inguib but2gui'),Tn.appendChild(On),On=ba('Save',function(){params.save()}),On.setAttribute('class','inguib but2gui'),Tn.appendChild(On),Fs=Js.addFolder('Save/Open file'),Fs.add(params,'loadprev').name(qa.restoresession),Fs.add(params,'savealpha').name(qa.savepicture),Fs.add(params,'author').name(qa.author).onChange(function(){ke()}).domElement.children[0].setAttribute('maxlength','20'),Fs.add(params,'openfile').name(qa.openfilegeology);var In=Fs.addFolder('Expert');if(In.add(params,'ex').name('Expert user').onChange(function(){Js.close(),Da(Yl)}),In.add(params,'clear').name(qa.clearall),In.add(params,'overridepel').name('Override pel'),In.add(params,'withbg').name(qa.showmwd).onChange(function(){ea()}),In.add(params,'showbergart').name(qa.showrocktype).onChange(function(){allp.update(),ae()}),In.add(params,'forcesync').name('ForcedSync'),null!=jn&&(jn==qa.qval&&za(),'Select'==jn)){Ms=Js.addFolder(qa.setproperties);var Bn=sid2txtdate(_s.sid)+' '+_s.author;if(Ms.add(bf,'blank').name(Bn),Ms.add(_s,'author').name(qa.author),'T'!=Ln){q22=Ms.add(_s,'comment').name('');var Gn=q22.domElement.children[0];Gn.setAttribute('class','myta'),q22.domElement.setAttribute('class','c bigtadiv'),Gn.placeholder='Comment...',Gn.onkeyup=function(){Me(this)},Gn.onchange=function(){Ie()},q22.__li.setAttribute('class','cr string bigta')}if('T'==Ln&&(Ms.add(Xl[Ji],'text').name(qa.text).onChange(function(){Z(Ji,Xl[Ji].text)}),Ms.add(params,'openfoto').name(qa.takephoto),Ms.add(params,'makelab').name(qa.labtest)),null==Ln||'L'==Ln){Ms.add(_s,'bergart',fs).name(qa.rocktype).listen().onChange(function(){params.parcolor=Ce(_s.bergart),Js.updateDisplay()});var Tn=Ms.addColor(params,'parcolor').name(qa.color).listen().onChange(function(){params.parcolor=Ce(_s.bergart),Js.updateDisplay()}),Nn=Tn.domElement.children[0];Nn.style.width='70%'}return'W'==Ln&&(Ms.add(_s,'dsc',qa.dsc).name(qa.description),Ms.add(_s,'wdrip').name(qa.dripmin),Ms.add(_s,'wleak').name(qa.litmin)),'F'==Ln&&(Ms.add(Xl[Ji],'angle',0,360).step(1).name(qa.angle).onChange(function(){$(Ji,Xl[Ji].fall,Xl[Ji].angle)}),Ms.add(Xl[Ji],'fall',0,90).step(1).name(qa.fall).onChange(function(){$(Ji,Xl[Ji].fall,Xl[Ji].angle)})),Ms.add(bf,'blank').name(''),void Ms.add(params,'applyP').name(qa.ap)}Qs=Js.addFolder(qa.main),Qs.add(bf,'blank').name(''),params.ex&&(F(Qs),F(Qs),Qs.add(params,'resetcam').name(qa.resetcamera),F(Qs))}function za(){Vs=Js.addFolder(qa.qval);var jn=sid2txtdate(Ns.lastchange)+' by \''+Ns.author+'\'';Vs.add(bf,'blank').name('Updated '+jn);var Ln=Vs.add(Ns,'ps').name('Pel start').domElement.children[0];Ln.type='tel',Ln.setAttribute('maxlength','5'),Ln=Vs.add(Ns,'pe').name('Pel end').domElement.children[0],Ln.type='tel',Ln.setAttribute('maxlength','5'),q22=Vs.add(Ns,'comment').name('');var Pn=q22.domElement.children[0];Pn.setAttribute('class','myta'),q22.domElement.setAttribute('class','c bigtadiv'),Pn.placeholder='Comment...',Pn.onkeyup=function(){Me(this)},20<Ns.comment.length&&Me(Pn),Pn.onchange=function(){Te()},q22.__li.setAttribute('class','cr string bigta');var Ln=Qe(Vs);Cs.rqd=ba('RQD',function(){params.editRQD()}),Ln.appendChild(Cs.rqd),Cs.Jr=ba('Jr',function(){params.editJr()}),Ln.appendChild(Cs.Jr),Cs.Jw=ba('Jw',function(){params.editJw()}),Ln.appendChild(Cs.Jw),Cs.Jn=ba('Jn',function(){params.editJn()}),Ln.appendChild(Cs.Jn),Cs.Ja=ba('Ja',function(){params.editJa()}),Ln.appendChild(Cs.Ja),Cs.SRF=ba('SRF',function(){params.editSRF()}),Ln.appendChild(Cs.SRF);var En=Vs.add(bf,'blank').name('');En.__li.setAttribute('class','cr function qtext'),Cs.Q=En,Vs.add(Ns,'bergart',fs).name(qa.rocktype);var Ln=Qe(Vs),Tn=ba(qa.apply,function(){Te()});Tn.setAttribute('class','inguib but2gui'),Ln.appendChild(Tn);var Tn=ba(qa.removeq,function(){params.removeq()});Tn.setAttribute('class','inguib but2gui'),Ln.appendChild(Tn)}function Fa(){Js=new dat.GUI({autoPlace:!1,width:Math.min(400,Yi/2-4)}),container.appendChild(Js.domElement),Js.domElement.id='guipos'}function Da(jn,Ln){Yl=jn;var Pn=jn;Ql?(Pn='3d',globgeo='Settings'):globgeo='Geology',kt(),null==Pn&&(Bl=[],chosenp=-2);var En=Js.closed;if(container.removeChild(Js.domElement),Js.destroy(),Fa(),'3d'==Pn){var Tn=Js.add(bf,'blank').name('Settings:');Tn.onChange(function(){Js.close()}),Tn.__li.setAttribute('class','cr function first');var On=parseFloat(Js.domElement.style.width)-1;return Tn.__li.style.width=On+'px',Js.add(lingeom,'visible').name('Tunnel frame').onChange(function(){ae()}),Rn&&(pointval.valmin=23,params.opacity=0.3,pointCloud.geometry.drawRange.start=pointval.ar[pointval.valmin-1],pointCloud.geometry.drawRange.count=pointval.ar[pointval.valmax-1]-pointCloud.geometry.drawRange.start,meshes.children[0].material.opacity=params.opacity,pMaterial.size=10,ae(),Rn=0),''!=strin&&(Js.add(pointval,'valmin',1,pointval.ar.length).name('Min').step(1).onChange(function(){pointCloud.geometry.drawRange.start=pointval.ar[pointval.valmin-1],pointCloud.geometry.drawRange.count=pointval.ar[pointval.valmax-1]-pointCloud.geometry.drawRange.start,ae()}),Js.add(pointval,'valmax',1,pointval.ar.length).name('Max').step(1).onChange(function(){pointCloud.geometry.drawRange.count=pointval.ar[pointval.valmax-1]-pointCloud.geometry.drawRange.start,ae()}),Js.add(pMaterial,'size',5,35).name('Point size').step(1).onChange(function(){ae()}),Js.add(params,'opacity',0,1).name('Tunnel opacity').step(0.1).onChange(function(){meshes.children[0].material.opacity=params.opacity,ae()})),Js.add(fscale,'val',0,1).name('Plane size').step(0.02).onChange(function(){for(var Bn in fallar.children)fallar.children[Bn].scale.set(fscale.val,fscale.val,1);ae()}),void Js.updateDisplay()}if(ka(Pn,Ln),null==Ln&&Na(),zt(),'Line'==Pn&&(Ni.setAttribute('class','geobuttonf'),params.linetype='Line',Qs.add(params,'bolt').name(qa.bolt),Qs.add(params,'lineStyle',qa.lineStylear).name(qa.ls),Qs.add(params,'linemagnet').name('Magnet'),params.ex&&Qs.add(params,'size',0.1,1).name('Size').step(0.1),Qs.add(bf,'blank').name('')),'Water'==Pn&&(_i.setAttribute('class','geobuttonf'),params.linetype='Water',Qs.add(params,'wsize',0.1,1).step(0.1).name('Size'),Qs.add(bf,'blank').name('')),'Text'==Pn){Wi.setAttribute('class','geobuttonf'),params.linetype='Text',q22=Qs.add(params,'text').name(qa.ttp),Qs.add(bf,'blank').name('');var In=q22.domElement.children[0];In.setAttribute('class','myta'),In.placeholder='Text...',En=!1}'Fall'==Pn&&(Ui.setAttribute('class','geobuttonf'),params.linetype='Fall',q22=Qs.add(params,'angle',0,360).step(1).name(qa.angle),Qs.add(params,'fall',0,90).step(1).name(qa.fall),Qs.add(bf,'blank').name(''),En=!1),'Bolt'==Pn&&(params.linetype='Bolt',Qs.add(params,'boltlen',1,10).step(0.5).name(qa.len),Qs.add(params,'bolttype',qa.boltlist).name(qa.material),Qs.add(bf,'blank').name('')),'Select'==Pn||'Q - value'==Pn?(Hi.setAttribute('class','geobuttonf'),params.linetype='Select'):Qs.open(),Js.updateDisplay(),En?Ee():Pe()}function Va(){for(var jn in ki.children.length=0,oman.ao){var Ln=oman.ao[jn];Ln.toskip||'B'!=Ln.type||oman.plot(Ln)}}function Qa(){ya(),xt();for(var jn=[],Ln=0;Ln<Xl.length;Ln++)0==Xl[Ln].skip&&jn.push(Xl[Ln]);for(var Tn,On,Pn=yprev=cprev=sprev=-1e3,En=[],Ln=0;Ln<jn.length;Ln++)if('L'==jn[Ln].type)if(Pn==jn[Ln].xs&&yprev==jn[Ln].ys&&cprev==jn[Ln].color&&sprev==jn[Ln].size){var In=[jn[Ln].xe,jn[Ln].ye,jn[Ln].zs];Pn=jn[Ln].xe,yprev=jn[Ln].ye,En.push(In[0]),En.push(In[1]),En.push(In[2])}else N(En,On,Tn),Pn=jn[Ln].xe,yprev=jn[Ln].ye,cprev=jn[Ln].color,sprev=jn[Ln].size,En=[jn[Ln].xs,jn[Ln].ys,jn[Ln].zs,Pn,yprev,jn[Ln].zs],Tn=jn[Ln].color,On=jn[Ln].size;N(En,On,Tn)}function Ma(){this.oldzero=1,this.oldppu=1,this.oldpw=1,this.getnewy=function(jn){var Pn=La(jn);return Pn=mr(Pn),Pn},this.getnewx=function(jn){var Ln=jn/this.oldpw*Li;return Ln=mr(Ln),Ln}}function Ca(jn,Ln){for(var Pn in Ln)for(var En=Ln[Pn],Tn=0;Tn<En.length;Tn++)if(En[Tn]==jn)return''+Pn;return null}function Ra(jn){mt.start('Get json');var Ln='object'==typeof jn?JSON.parse(JSON.stringify(jn)):JSON.parse(jn);var Pn=Ln.objdata;mt.end('Get json');var En=new Ma,Tn=Ln.authors,On=Ln.sids,In=Ln.chlist;if(null==In||isEmpty(In))for(var Bn in On)oman.changelist[Bn]=Bn;else for(var Bn in On)oman.changelist[Bn]=In[Bn];En.oldzero=Ln.zeropel,An=Ln.author,En.oldppu=Ln.pelperunit,En.oldpw=Ln.pw,Jn=Ln.sid,allq.restore(Ln.qval,1);for(var Gn=Ln.pval,Nn=0;Nn<Gn.par.length;Nn++)for(var Bn=0;Bn<Gn.par[Nn].coords.length;Bn+=2)Gn.par[Nn].coords[Bn]=En.getnewx(Gn.par[Nn].coords[Bn]),Gn.par[Nn].coords[Bn+1]=En.getnewy(Gn.par[Nn].coords[Bn+1],1);allp.restore(Gn,1);for(var Xn,_n=Pn.length,Wn=6,Un='#000000',Hn=qy=qz=tmpy=tmpx=-1e3,Bn=0;Bn<_n;Bn++){if(Xn=new ja,null==On)Xn.sid=Jn;else{var Yn=Ca(Bn,On);Xn.sid=null==Yn?Jn:Yn}if(null==Tn)Xn.author=An;else{var Yn=Ca(Bn,Tn);Xn.author=null==Yn?An:Yn}var Kn=Pn[Bn];if(2==Kn.length){tmpx=En.getnewx(Kn[0]/qprec),tmpy=En.getnewy(Kn[1]/qprec),Xn.addline(Hn,qy,qz,tmpx,tmpy,qz,Wn,Un),Hn=En.getnewx(Kn[0]/qprec),qy=En.getnewy(Kn[1]/qprec),oman.isdublicate(Xn),oman.plot(Xn),oman.add(Xn);continue}if(0==Kn[0]){Wn=15,Un='#000000',6<Kn.length&&('number'==typeof Kn[6]&&(Wn=Kn[6]),'string'==typeof Kn[6]&&(Un=Kn[6])),8==Kn.length&&(Un=Kn[7]),Hn=En.getnewx(Kn[4]/qprec),qy=En.getnewy(Kn[5]/qprec),qz=Kn[3],tmpx=En.getnewx(Kn[1]/qprec),tmpy=En.getnewy(Kn[2]/qprec),Xn.addline(tmpx,tmpy,qz,Hn,qy,qz,Wn,Un),oman.isdublicate(Xn),oman.plot(Xn),oman.add(Xn);continue}if(1==Kn[0]){Wn=0.5,3<Wn.length&&(Wn=Kn[3]),tmpx=En.getnewx(Kn[1]/qprec),tmpy=En.getnewy(Kn[2]/qprec),Xn.addwater(tmpx,tmpy,10,Wn),oman.isdublicate(Xn),oman.plot(Xn),oman.add(Xn);continue}if(2==Kn[0]){tmpx=En.getnewx(Kn[1]/qprec),tmpy=En.getnewy(Kn[2]/qprec);var Zn=Kn[4];'_pho_'==Zn.slice(0,5)&&(Xn.fall=1,Zn=Zn.slice(5),console.log(Zn)),'_lab_'==Zn.slice(0,5)&&(Xn.fall=2,Zn=Zn.slice(5)),Xn.addtext(Zn,tmpx,tmpy,Kn[3],1),oman.isdublicate(Xn),oman.plot(Xn),oman.add(Xn);continue}if(3==Kn[0]&&(tmpx=En.getnewx(Kn[1]/qprec),tmpy=En.getnewy(Kn[2]/qprec),Xn.addfall(tmpx,tmpy,10,Kn[3],Kn[4],Kn[5]),null!=Kn[6]&&(Xn.color=[tv(Kn[6][0].x,Kn[6][0].y,Kn[6][0].z),tv(Kn[6][1].x,Kn[6][1].y,Kn[6][1].z),tv(Kn[6][2].x,Kn[6][2].y,Kn[6][2].z)]),oman.isdublicate(Xn),oman.plot(Xn),oman.add(Xn)),4==Kn[0]){Xn.addbolt(En.getnewx(Kn[1]/qprec),En.getnewy(Kn[2]/qprec),Kn[3],En.getnewx(Kn[4]/qprec),En.getnewy(Kn[5]/qprec),Kn[6],Kn[7]),oman.isdublicate(Xn),oman.plot(Xn),oman.add(Xn);continue}}}function Ja(jn,Ln,Pn){var En=0.02/Math.abs(Sl-kl);null!=Pn&&(En=Pn);var Tn=Math.abs(parseFloat(jn)-parseFloat(Ln));return!!(Tn<En)}function Aa(jn,Ln){var En=Math.abs(parseFloat(jn)-parseFloat(Ln));return En}function ja(){this.type='',this.sid=wl,this.author=params.author,this.id=0,this.skip=0,this.text='',this.xs=0,this.ys=0,this.zs=0,this.xe=0,this.ye=1,this.ze=1,this.size=3,this.color='',this.fall=0,this.angle=0,this.lastmx=-1e3,this.lastmy=-1e3,this.sameas=function(jn){return this.type==jn.type&&Ja(this.xs,jn.xs)&&Ja(this.ys,jn.ys)},this.addline=function(jn,Ln,Pn,En,Tn,On,In,Bn){this.type='L',this.size=In,this.color=Bn,this.xs=jn,this.ys=Ln,this.zs=Pn,this.xe=En,this.ye=Tn,this.ze=On},this.addbolt=function(jn,Ln,Pn,En,Tn,On,In){this.type='B',this.text=In,this.xs=jn,this.ys=Ln,this.zs=Pn,this.xe=En,this.ye=Tn,this.ze=On},this.addwater=function(jn,Ln,Pn,En,Tn,On,In,Bn){this.type='W',this.size=En,this.xs=jn,this.ys=Ln,this.zs=Pn,null!==Tn&&(this.text=Tn),null!==On&&(this.xe=On),null!==In&&(this.fall=In),null!==Bn&&(this.angle=Bn)},this.addfall=function(jn,Ln,Pn,En,Tn,On){this.type='F',this.xs=jn,this.ys=Ln,this.zs=Pn,this.angle=En,this.fall=Tn,this.size=null==On?_e(Pa(Ln)):On},this.addtext=function(jn,Ln,Pn,En){this.type='T',this.text=jn,this.xs=Ln,this.ys=Pn,this.zs=En}}function La(jn){var Ln=parseFloat(2*(pmult*(jn-parseFloat(Dl))*Fl/ji));return Ln}function Pa(jn){var Ln=parseFloat(pmult*jn/(2*(Fl/ji))+Dl);return Ln}function Ea(){var jn=new Date,Ln=parseInt(jn.getMonth()+1),Pn={date:jn.getFullYear()+'-'+az(Ln)+'-'+az(jn.getDate()),author:params.author};return Pn}function Ta(jn){for(var Ln=[],Pn=[],En={pmult:pmult,pelperunit:1/(2*(Fl/ji)),zeropel:Dl,pw:Li,author:params.author,tunnel:jn},Tn=new myxml(En),On={type:'w',da:Ea(),coords:[0,1],comment:'',dsc:0,drip:'',leak:''},In={type:'t',da:Ea(),coords:[0,1],comment:'',fall:0},Bn={type:'f',da:Ea(),coords:[0,1],comment:'',angle:0,fall:0},Gn={type:'l',da:Ea(),coords:[0,1],ltype:0,comment:'',bergart:'none',color:'',width:0},Nn={type:'q',da:Ea(),coords:[0,1],QVal:[],bergart:'none',color:0,comment:''},_n=0;_n<allq.qar.length;_n++){var Wn=allq.qar[_n],Un=Nn;Un.da.author=Wn.author,Un.da.date=sid2date(Wn.lastchange),Un.coords=[Wn.ps,Wn.pe],Un.QVal=[Wn.RQD,Wn.Jn,Wn.Jr,Wn.Ja,Wn.Jw,Wn.SRF,Wn.Q],Un.bergart=Wn.bergart,Un.comment=Wn.comment,Un.color=St(Ce(Wn.bergart)),Tn.parseos(Un)}for(var _n=0;_n<Xl.length;_n++)if(!Xl[_n].skip&&!isinarray(Pn,_n)){var Hn=Ae(_n);if(!isinarray(Ln,Hn)){var Kn,Xn=Re(_n),Yn=-2<Hn?1:0;Yn&&(Ln.push(Hn),Kn=allp.par[Hn]);var $n,Zn=Xl[_n];if('L'==Xn)if($n=Gn,$n.da.author=Zn.author,$n.da.date=sid2date(Zn.sid),$n.ltype=Zn.color[0],Yn)Kn.isarea&&($n.ltype=5),$n.coords=Kn.coords,$n.comment=Kn.comment,$n.bergart=Kn.bergart,$n.color=Kn.color,$n.width=Kn.width;else{for(var eo=he(_n),to=0;to<eo.length;to++)Pn.push(eo[to]);$n.coords=ge(eo)}'W'==Xn&&($n=On,$n.da.author=Zn.author,$n.da.date=sid2date(Zn.sid),$n.coords=[Zn.xs,Zn.ys],Yn&&(Kn.comment&&($n.comment=Kn.comment),Kn.dsc&&($n.dsc=Kn.dsc),Kn.wdrip&&($n.drip=Kn.wdrip),Kn.wleak&&($n.leak=Kn.wleak))),'T'==Xn&&($n=In,$n.da.author=Zn.author,$n.da.date=sid2date(Zn.sid),$n.coords=[Zn.xs,Zn.ys],$n.comment=Zn.text,$n.fall=Zn.fall),'B'==Xn&&($n=In,$n.da.author=Zn.author,$n.da.date=sid2date(Zn.sid),$n.coords=[Zn.xs,Zn.ys],$n.comment='B'),'F'==Xn&&($n=Bn,$n.da.author=Zn.author,$n.da.date=sid2date(Zn.sid),$n.coords=[Zn.xs,Zn.ys],$n.angle=Zn.size?Zn.angle:360-Zn.angle,$n.fall=Zn.fall),Tn.parseos($n)}}return Tn.showstrout()}function Oa(jn,Ln){for(var Pn=[],En=[],Tn=JSON.parse(JSON.stringify(jn)),On=0;On<Tn.length;On++)if(!isinarray(En,On)){var In=params.onlynew&&!Ln?Tn[On].sid==wl:1;1<params.onlynew&&(In=Tn[On].sid==params.onlynew?1:0);var Bn=1;if(params.onlycurpel&&!Ln&&!Ya(Pa(Tn[On].ys))){var Gn=he(On);add2array(En,Gn),Bn=0}!Tn[On].skip&&In&&Bn&&Pn.push(Tn[On])}return Pn}function Ia(jn){var Ln=0;null!=jn&&(Ln=jn);var Pn=Oa(Xl,Ln),En=new fe;En.lastchange=oman.changelist[params.onlynew],null==En.lastchange&&(En.lastchange=wl),En.zeropel=Dl,En.pelperunit=Fl*pmult,En.pw=Li,En.pelstart=Sl,En.pelend=kl,En.author=params.author,En.authors={},En.sid=wl,En.sids={},En.tunnel=params.tunnel;var Tn=new We;Ln?Tn.restore(allq,1):Tn.restore(allq,1,params.onlynew),En.qval=Tn;var On=new Ge;On.restore(allp,1,params.onlynew&&!Ln),Ln?On.restore(allp,1):On.restore(allp,1,params.onlynew),On.cleanFromQ(),On.y2pelcoords(),params.onlycurpel&&On.cleanFromPel(),En.pval=On;for(var In=yprev=cprev=sprev=-1e3,Bn=0;Bn<Pn.length;Bn++)Pn[Bn].ys=Pa(Pn[Bn].ys),Pn[Bn].ye=Pa(Pn[Bn].ye);for(var Gn,Bn=0;Bn<Pn.length;Bn++){Gn=Pn[Bn].author,null==En.authors[Gn]?En.authors[Gn]=[Bn]:En.authors[Gn].push(Bn);var Nn=Pn[Bn].sid;if(null==En.sids[Nn]?En.sids[Nn]=[Bn]:En.sids[Nn].push(Bn),'L'==Pn[Bn].type){if(In==Math.round(Pn[Bn].xs*qprec)&&yprev==Math.round(Pn[Bn].ys*qprec)&&cprev==Pn[Bn].color&&sprev==Pn[Bn].size){var _n=[Math.round(Pn[Bn].xe*qprec),Math.round(Pn[Bn].ye*qprec)];In=Math.round(Pn[Bn].xe*qprec),yprev=Math.round(Pn[Bn].ye*qprec)}else{In=Math.round(Pn[Bn].xe*qprec),yprev=Math.round(Pn[Bn].ye*qprec),cprev=Pn[Bn].color,sprev=Pn[Bn].size;var _n=[0,Math.round(Pn[Bn].xs*qprec),Math.round(Pn[Bn].ys*qprec),Pn[Bn].zs,In,yprev];6!=Pn[Bn].size&&_n.push(Pn[Bn].size),'#000000'!=Pn[Bn].color&&_n.push(Pn[Bn].color)}En.objdata.push(_n)}if('W'==Pn[Bn].type){In=-1e3;var _n=[1,Pn[Bn].xs*qprec,Pn[Bn].ys*qprec];0.5!=Pn[Bn].size&&_n.push(Pn[Bn].size),En.objdata.push(_n)}if('T'==Pn[Bn].type){In=-1e3;var Wn=Pn[Bn].text;1==Pn[Bn].fall&&(Wn='_pho_'+Wn),2==Pn[Bn].fall&&(Wn='_lab_'+Wn);var _n=[2,Pn[Bn].xs*qprec,Pn[Bn].ys*qprec,Pn[Bn].zs,Wn];En.objdata.push(_n)}if('F'==Pn[Bn].type){if(In=-1e3,''!=Pn[Bn].color)var _n=[3,Pn[Bn].xs*qprec,Pn[Bn].ys*qprec,Pn[Bn].angle,Pn[Bn].fall,Pn[Bn].size,Pn[Bn].color];else var _n=[3,Pn[Bn].xs*qprec,Pn[Bn].ys*qprec,Pn[Bn].angle,Pn[Bn].fall,Pn[Bn].size];En.objdata.push(_n)}if('B'==Pn[Bn].type){In=-1e3;var _n=[4,Pn[Bn].xs*qprec,Pn[Bn].ys*qprec,Pn[Bn].zs,Pn[Bn].xe*qprec,Pn[Bn].ye*qprec,Pn[Bn].ze,Pn[Bn].text];En.objdata.push(_n)}}var Un=Object.keys(En.authors).length;if(1==Un){var Hn=Ca(0,En.authors);null!=Hn&&(En.author=Ca(0,En.authors)),null==En.authors}var Xn=Object.keys(En.sids).length;if(1==Xn){var Hn=Ca(0,En.sids);null!=Hn&&(En.sid=Ca(0,En.sids)),null==En.sids}for(var Yn in En.chlist={},En.sids){var Gn=oman.changelist[Yn];console.log('Element of changelist',Yn,Gn),null!=Gn&&(En.chlist[Yn]=Gn)}return console.log('Saved change list',En.chlist),0==En.qval.qar.length&&console.log('No Q to save'),0==En.pval.par.length&&console.log('No Props to save'),0==En.objdata.length&&console.log('No registrations to save'),0==En.objdata.length&&0==En.pval.par.length&&0==En.qval.qar.length&&(En=0),En}function Ba(jn,Ln){if(Rs=1,renderblock=1,Ln>=jn.files.length)return Ii.value=null,allq.update(),Qa(),renderblock=0,ae(),void(Rs=0);var Pn=new FileReader;Pn.onload=function(En){return 1==jn.files.length&&params.overridepel?(console.log('open one blank file'),openblankimage(En.target.result),Rs=0,void(renderblock=0)):void(Ra(En.target.result),console.log('Done reading ',Ln),Ba(Ii,Ln+1))},Pn.readAsText(jn.files[Ln])}function Na(){fi.visible=!1,Wl=yp=zp=-1e3,Ji=-1,bi.visible=!1}function _a(jn,Ln){var En=180*(Math.atan2(jn-Xl[Xl.length-1].xs,Ln-Xl[Xl.length-1].ys)/Math.PI);En=Math.round(En),0>En&&(En=360+En),ti.rotation=Math.round(1e3*(-Math.PI/180*En))/1e3,params.angle=En,Xl[Xl.length-1].angle=En,Js.updateDisplay(),oman.updchangelist(Xl[Xl.length-1].sid)}function Wa(jn,Ln,Pn,En,Tn,On){var In=new THREE.CircleGeometry(En,32,Math.PI/4,2.12*Math.PI),Bn=new THREE.Line(In,new THREE.LineBasicMaterial({color:On,linewidth:Tn}));return Bn.position.set(jn,Ln,Pn),Bn}function Ua(jn,Ln,Pn){var Tn=0;null!=Ln&&(Tn=St(Ln,1));var On='object'==typeof Pn?Pn.val:1,In=new THREE.TextSprite({textSize:0.25*Oi*On,redrawInterval:1e7,texture:{text:jn+'',fontFamily:'Arial, Helvetica, sans-serif, Bold',fontWeight:'bold',autoRedraw:!1},material:{color:Tn,fog:!1}});return 15!=On&&Rl.push(In),In.position.set(0,0,1),fcp&&(setTimeout(function(){ae()},100),fcp=0),In}function Xa(){Te(),Ve(),Pe()}function Ya(jn){var Ln=picparams.ps,Pn=picparams.pe;if(0<pmult){if(jn>=Ln&&jn<=Pn)return!0;}else if(jn>=Pn&&jn<=Ln)return!0;return!1}function Ka(jn,Ln,Pn){var En=Ln,Tn=Pn;if(Pn>Ln){if(jn>=En&&jn<=Tn)return!0;}else if(jn>=Tn&&jn<=En)return!0;return!1}(function(){try{var jn=new FormData,Ln=window.XMLHttpRequest?new XMLHttpRequest:new activeXObject('Microsoft.XMLHTTP');Ln.open('get',baseaddr+'getip.php',!0),Ln.send('')}catch(Pn){console.log(Pn)}})();var $a=window.getComputedStyle(document.body,null).getPropertyValue('--myyellow'),el=window.getComputedStyle(document.body,null).getPropertyValue('--myblack'),il=window.getComputedStyle(document.body,null).getPropertyValue('--mybackground'),sl,rl;this.getrs=function(){return sl},this.callresultstring=function(jn){le(jn)},this.getrp=function(){return rl},this.callresultpic=function(jn){oe(jn)},this.loadlines=function(jn){Ra(jn),allq.update(),Qa(),ae()},this.setauthor=function(jn){params.author=jn,Js.updateDisplay()},this.showvederlag=function(){console.log('vederlag to be done')},this.makenovaxml=function(jn,Ln){console.log('novaxmlto to be done'),Ln},this.getnxml=function(){return'to be xml text'},this.show3d=function(){it()},this.show2d=function(){rt()};var ul=S.picsizex,hl=S.picsizey,gl=S.picadress;gl='';var yl=gl,fl=S.tung,vl=S.ling,wl=getsessionid();newdb=new mydb,newdb.ldb(),picdb=new mypicdb,6>picdb.files.length&&(picdb.files=picfiles,picdb.sdb()),tungeom.Tunnel1=tungeom1.Tunnel1;var Sl=S.pelstart,kl=S.pelend,zl=Math.abs(parseInt(Sl)-parseInt(kl)),Fl=50;11>zl&&(Fl=100),6>zl&&(Fl=200),hl=Fl*zl;var Dl=S.zeropel,Vl=S.picpack,Ql=!1,Ml=ul,Cl=hl,Rl=[];container=condiv();var Jl,Al=new THREE.Raycaster,jl=new THREE.Vector2,Pl=0,El=0,Tl=0,Bl=[],Wl=yp=zp=-1e3,Ul=yp2d=zp2d=-1e3,Hl=[],Xl=[],Yl='Line';oman=new C;var Kl=function(){return{s:'bevgsave1',l:'bevgsave1'}}(),Zl=new function(){this.idx=[],this.type=[],this.remprev=[],this.xl=[],this.yl=[],this.add=function(jn,Ln,Pn){this.idx.push(jn),this.type.push(Ln),this.remprev.push(Pn),this.xl.push(0),this.yl.push(0)},this.addMove=function(jn,Ln,Pn,En,Tn){this.idx.push(jn),this.type.push(Ln),this.remprev.push(Pn),this.xl.push(En),this.yl.push(Tn)},this.removelast=function(){this.type.splice(this.type.length-1,1),this.idx.splice(this.idx.length-1,1),this.remprev.splice(this.remprev.length-1,1),this.xl.splice(this.xl.length-1,1),this.yl.splice(this.xl.length-1,1)}},$l,ei,ti,ri,di,pi=0,ci=lastmovey=-1e3,ui=0;Detector.canvas||alert('Browser does not support canvas 3d'),Jl=new THREE.Scene;var gi=new THREE.Scene,mi=new THREE.Scene,yi=Jl,fi=new THREE.Object3D,bi=new THREE.Object3D,vi=new THREE.Object3D,xi=new THREE.Object3D,Si=new THREE.Object3D,ki=new THREE.Object3D,zi=new THREE.Object3D,Fi=new THREE.Object3D,Di=new THREE.Object3D,Vi=new THREE.Object3D,Qi;fallar=new THREE.Object3D,line3dgroup=new THREE.Object3D,line3dtemp=new THREE.Object3D,Jl.add(zi),Jl.add(Fi),Jl.add(Di);var Mi=new THREE.Object3D,Ci=new THREE.Object3D,Ri=new THREE.Object3D,Ji=-1;fi.visible=!1,bi.visible=!1,pmult=Sl<kl?1:-1;var ji=200,Li=ul/200,Pi=hl/ji,Ei=0,Ti=1,Oi=1,Ii=document.createElement('input');document.body.appendChild(Ii),Ii.type='file',Ii.accept='.txt',Ii.multiple=!0,Ii.style.display='none',Ii.onchange=function(){if(console.log('Start file read'),null==this.files[0])return void console.log('No files chosen');var jn=this.files[0].name,Ln=pelfromfname(jn);params.overridepel&&saveifokdist(Ln[0],Ln[1]),('t'==jn[jn.length-1]||'T'==jn[jn.length-1])&&Ba(this,0)};var Bi=document.createElement('input');document.body.appendChild(Bi),Bi.type='file',Bi.style.display='none',Bi.onchange=function(){if(null==this.files[0])return void console.log('No photo chosen');var jn=this.files[0].name;('g'==jn[jn.length-1]||'G'==jn[jn.length-1])&&Y(this)};var Gi=new Image,Ni=document.getElementById('linbtn'),_i=document.getElementById('watbtn'),Wi=document.getElementById('txtbtn'),Ui=document.getElementById('falbtn'),Hi=document.getElementById('selbtn'),Xi=document.getElementById('undbtn');renderer=new THREE.WebGLRenderer({antialias:!1,alpha:!0,premultipliedAlpha:!0}),renderer.setPixelRatio(window.devicePixelRatio),renderer.setClearColor(St(il,1));var Yi,Ki;z();var Zi=new THREE.Vector2(Yi,Ki);renderer.setSize(Yi,Ki),document.getElementById(h).appendChild(renderer.domElement);var $i=document.getElementById(h).offsetTop,es=document.getElementById(h).offsetLeft,as=Yi/Ki,ls=2.5*Pi*Math.sqrt(2.28/(Pi/Li)),is=ls;Jl.add(vi),Jl.add(Mi),Jl.add(Ri),Jl.add(Ci),Jl.add(Si),Jl.add(ki),Jl.add(xi),camera=new THREE.OrthographicCamera(-ls*as/2,ls*as/2,is/2,-is/2,-5e3,5e3),controls=new THREE.OrbitControls(camera,renderer.domElement),controls.enableDamping=!1,controls.dampingFactor=0.3,controls.enableRotate=!1,controls.rotateSpeed=0.45,controls.zoomSpeed=1,android||iOS||(controls.zoomSpeed=3);var ss=1;controls.target.set(0,0,0),camera.position.set(0,0,ss);camera.zoom;controls.addEventListener('change',function(){Xt(1)}),controls.addEventListener('end',function(){Xt(1)}),cameraFix=new THREE.OrthographicCamera(-ls*as/2,ls*as/2,is/2,-is/2,-5e3,5e3);var us,ms;ca(gl,0),function(){var jn=0.07*Oi,Ln=0.14*Oi,Pn=_(-jn,-jn,10,jn,jn,10,8*Oi,'#000000'),En=_(jn,-jn,10,-jn,jn,10,8*Oi,'#000000');fi.add(Pn,En),Jl.add(fi);var Tn=_(-Ln,-Ln,10,Ln,-Ln,10,5*Oi,'#000000'),On=_(Ln,-Ln,10,Ln,Ln,10,5*Oi,'#0000ff'),In=_(Ln,Ln,10,-Ln,Ln,10,5*Oi,'#ff0000'),Bn=_(-Ln,Ln,10,-Ln,-Ln,10,5*Oi,'#00ff00');bi.add(Tn,On,In,Bn),Jl.add(bi)}();var fs=['none','Hornfels','Svartskifer','Sill','Spr\xF8ytebetong','Special','Weakness','Basalt','Calcite','Granite','Pyrite'],bs=['#ffffff','#D0D470','#817A85','#EDA155','#877D7B','#ED4AE8','#771111','#000000','#aaffaa','#aa7777','#ff2222'],Fs,Vs,Qs,Ms,Cs={rqd:'',Jn:'',Jr:'',Ja:'',Jw:'',SRF:'',Q:''},Rs=0;(android||iOS)&&setInterval(function(){gt()},3e4),params={ex:!1,restses:1,loadprev:function(){myask(container,qa.unsaved,function(){M(),yt()})},savexml:function(){Sa(params.tunnel)},forcesync:!1,enrot:!1,linetype:'Line',linemagnet:!0,lineStyle:qa.lineStylear[0],tunnel:picparams.ps>tunborder?'Bamble':'Kjorholt',vederlag:!1,text:'',author:'V',onlynew:!1,onlycurpel:!1,rutenett:!1,size:0.5,wsize:0.5,opacity:0.5,angle:0,fall:45,layer:0,move:!1,movestart:!1,color:'#000000',parcolor:'#000000',savealpha:function(){tt(),Xt(null,1),ae();var jn=renderer.domElement.toDataURL(),Ln=new Date,Pn='';Pn=Pn+'geo'+Ln.getHours()+'h'+Ln.getMinutes()+'m'+Ln.getSeconds()+'s.png',zn(jn,Pn),ut(),lsc=1,Qa()},what2plot:'Geo+Q+Pel',withbg:!0,showbergart:!0,tstval:45,bolt:function(){Hi.value='Select',Da('Bolt')},boltlen:5,bolttype:'Steel',wtxt:'',dsc:'Not given',wleak:0,wdrip:0,save:function(){var jn='Save all registrations as \n'+params.tunnel+' tunnel?';myask(container,jn,function(){params.onlynew=!1,disassemble(),Js.updateDisplay()})},textsave:'',clear:function(){myask(container,qa.unsaved,function(){M()})},load:function(){Ra(params.textsave),ae()},go3d:it,go2d:rt,getflist:function(){xa()},add5m:function(){fgui.close(),Js.close(),dt()},resetcam:function(){Js.updateDisplay(),controls.reset(),controls.target.set(0,0,0),camera.position.set(0,0,ss),Na(),ae()},openfile:function(){params.overridepel?myask(container,qa.unsaved,function(){Ii.click()}):Ii.click()},overridepel:!0,openfoto:function(){Bi.click()},makelab:function(){Z(Ji,qa.labtest,2),Js.updateDisplay()},dummy:function(){},apply:function(){Te()},applyP:function(){Ie()},qedit:function(){},editRQD:function(){rqdmenu(Ns,container,Xa)},editJn:function(){jnmenu(Ns,container,Xa)},editJr:function(){jrmenu(Ns,container,Xa)},editJa:function(){jamenu(Ns,container,Xa)},editJw:function(){jwmenu(Ns,container,Xa)},editSRF:function(){srfmenu(Ns,container,Xa)},removeq:function(){myask(container,qa.removeqmes,function(){Oe()})}},params.author=function(){return localStorage.getItem('lastauthor')?localStorage.getItem('lastauthor'):'none'}(),params.tunnel=gettunnel()?gettunnel():tunlist[0];var Js=new dat.GUI({autoPlace:!1});Js.domElement.id='guipos',Js.close(),container.appendChild(Js.domElement),Da('Line'),lasst=params.tunnel,myaddfunc.flip=function(){renderblock=1;var jn=gt();M();var Ln=picparams.ps;picparams.ps=picparams.pe,picparams.pe=Ln,fgui.updateDisplay(),saveifokdist(picparams.ps,picparams.pe),''==gl?ra(picparams.ps,picparams.pe):oa(picparams.ps,picparams.pe),jn&&yt(),renderblock=0,ae(),Da('Line'),Hi.value='Select',fgui.close(),Js.close()},myaddfunc.openblank=function(){console.log('Oblank'),fgui.close(),myask(container,qa.unsaved,function(){getbypl(picparams.ps,picparams.pe)})};var As={showdb:function(){var jn=function(){for(var Pn=0,En=0;En<newdb.files.length;En++)newdb.files[En].ischosen&&!newdb.files[En].toskip&&Pn++;if(Pn){if(params.overridepel){var Tn=getchosenpels(newdb),On=Tn[0],In=Tn[1];picparams.ps=On,picparams.pe=In,fgui.updateDisplay(),saveifokdist(picparams.ps,picparams.pe),ra(picparams.ps,picparams.pe)}var Bn=0;renderblock=1;for(var Gn,En=0;En<newdb.files.length;En++)Gn=newdb.files[En],Gn.ischosen&&!newdb.files[En].toskip&&(Bn++,Ra(Gn.savedata));Qa(),allq.update(),renderblock=0,ae(),newdb.uncheckall(),Da('Line')}};dbtable(container,function(){params.ex?myask3(container,qa.openneworex,qa.opennew,function(){params.overridepel=!0,jn(),Js.updateDisplay()},qa.opentoexisting,function(){params.overridepel=!1,jn()}):(jn(),Js.updateDisplay())})},showpicdb:function(){dbpictable(container,js)},newblank:function(){oa(picparams.ps,picparams.pe)}};picparams.openf=function(){myask(container,qa.unsaved,function(){picdb.makefromfiles(function(){for(var jn in picdb.sortbytime(),picdb.files)if(!picdb.files[jn].toskip){picdb.files[jn].ischosen=1;break}js(1)})})};var js=function(jn){var Ln=getchosenpels(picdb);if(null!=Ln){var Pn=Ln[0],En=Ln[1],Tn=Ln[2];picparams.ps=Pn,picparams.pe=En,fgui.updateDisplay(),saveifokdist(picparams.ps,picparams.pe),console.log('Chosen are',picparams.ps,picparams.pe),jn?getbypl(picparams.ps,picparams.pe):ra(picparams.ps,picparams.pe,Tn),Et(),picdb.uncheckall()}},Ls=Qe(fgui),Ps=ba('Start!',function(){myaddfunc.openblank()});Ps.setAttribute('class','inguib but1gui aguibut'),Ls.appendChild(Ps);var Ls=Qe(fgui),Ps=ba('Flip pic',function(){myaddfunc.flip()});Ps.setAttribute('class','inguib but2gui'),Ls.appendChild(Ps),Ps=ba('Add 5m',function(){params.add5m()}),Ps.setAttribute('class','inguib but2gui'),Ls.appendChild(Ps);var Ls=Qe(fgui),Ps=ba('MWDdb',function(){As.showpicdb()});Ps.setAttribute('class','inguib but2gui aguibut'),Ls.appendChild(Ps),Ps=ba('Open geom',function(){picparams.openf()}),Ps.setAttribute('class','inguib but2gui aguibut'),Ls.appendChild(Ps);var Ls=Qe(fgui),Ps=ba('Go 2d',function(){params.go2d()});Ps.setAttribute('class','inguib but2gui'),Ls.appendChild(Ps),Ps=ba('Go 3d',function(){params.go3d()}),Ps.setAttribute('class','inguib but2gui'),Ls.appendChild(Ps),fgui.add(params,'tunnel',tunlist).name('Tunnel:').onChange(function(){savetunnel(params.tunnel),Et()}),fgui.add(params,'vederlag').name(qa.showved).onChange(function(){Qa(),ae()}),fgui.add(params,'rutenett').name(qa.rutenett).onChange(function(){vt(Sl,kl),ae()}),E(Sl,kl),vt(Sl,kl);var Es=new THREE.TextureLoader;Es.crossOrigin='anonymous';var Ts=Es.load(spcline),Os=Es.load(spcline1,function(){Os.wrapS=Os.wrapT=THREE.RepeatWrapping,Os.offset.set(0,0),Os.repeat.set(1,1)}),Is=Es.load(spcline2,function(){Is.wrapS=Is.wrapT=THREE.RepeatWrapping,Is.offset.set(0,0),Is.repeat.set(1,1)}),Gs=new ja,Ns=new Ue,_s=new Be;Ns.getQ(),allq=new We,allp=new Ge;var Ws=chosenp=-2;ua(Sl,kl,-1);var Us=0,Hs=new Hammer(Ni);Ni.onclick=function(){if(Us)return void(Us=0);var Ln=0,Pn=Js.closed;'Line'==params.linetype&&(Ln=1),Da('Line'),D(this),Ln&&P(),Pn&&Js.close(),Js.removeFolder(qa.qval),Js.removeFolder(qa.setproperties),Hi.value='Select'},(iOS||android)&&Hs.on('press',function(){Ni.click(),Us=1,setTimeout(function(){Us=0},250)}),Hs.get('press').set({threshold:100,time:3});var Xs=new Hammer(_i);_i.onclick=function(){return Us?void(Us=0):void(Da('Water'),Hi.value='Select',D(this))},(iOS||android)&&Xs.on('press',function(){_i.click(),Us=1,setTimeout(function(){Us=0},250)}),Xs.get('press').set({threshold:100,time:3});var Ys=new Hammer(Wi);Wi.onclick=function(){Da('Text'),Hi.value='Select',D(this)},(iOS||android)&&Ys.on('press',function(){Wi.click(),Us=1,setTimeout(function(){Us=0},250)}),Ys.get('press').set({threshold:100,time:3});var Ks=new Hammer(Ui);Ui.onclick=function(){return Ql?void Ut():void(Da('Fall'),Hi.value='Select',D(this))},(iOS||android)&&Ks.on('press',function(){Ui.click(),Us=1,setTimeout(function(){Us=0},250)}),Ks.get('press').set({threshold:100,time:3});var Zs=new Hammer(Xi);Xi.onclick=function(){android&&me(),Hi.value='Select',zt()},Zs.on('press',function(){android||(me(),Hi.value='Select',Us=1,setTimeout(function(){Us=0},250))}),Zs.get('press').set({threshold:100,time:3});var $s=0,en=new Hammer(Hi);android&&(Hi.onclick=function(){$s||tn(1)}),en.on('press',function(){tn(0),$s=1,setTimeout(function(){$s=0},250)}),en.get('press').set({threshold:100,time:3});var tn=function(){return'Select'==Hi.value?(Hi.value='Group',void Da('Select')):'One'==Hi.value?void(Hi.value='Group'):'Group'==Hi.value?void(Hi.value='One'):void 0};Ee();Jl.children.length;document.addEventListener('keydown',function(jn){switch(jn.keyCode){case 65:break;case 66:break;case 67:break;case 68:}},!1),window.addEventListener('resize',ut,!1),window.addEventListener('orientationchange',ut,!1);var nn=null,rn=new Hammer(renderer.domElement),dn=lasty=-1e3,cn=firsty=firstz=-1e3,un=endy=-1e3;rn.on('press',function(jn){ui=new Date().getTime(),R(jn),Qa()}),rn.on('pan',function(jn){if('Line'==params.linetype){var Ln=(dn-jn.center.x+es)*(dn-jn.center.x+es)+(lasty-jn.center.y+$i)*(lasty-jn.center.y+$i);Ln>sensivity*sensivity&&R(jn)}if('Select'==params.linetype){if(Pl)return;var Ln=(dn-jn.center.x+es)*(dn-jn.center.x+es)+(lasty-jn.center.y+$i)*(lasty-jn.center.y+$i),Pn=jn.velocityX*jn.velocityX+jn.velocityY*jn.velocityY;20<Pn&&(de(),Pl=1),params.move&&5>Pn&&(1e4<Ln||params.movestart)&&(R(jn),params.movestart=!0)}'Bolt'==params.linetype&&R(jn),'Fall'==params.linetype&&R(jn)}),rn.on('panstart',function(){El=1,Tl=1,Pl=0,params.move=!0,params.movestart=!1,!Ql||controls.enableRotate}),rn.on('panend',function(){'Line'==params.linetype&&(Na(),ui=new Date().getTime()),params.move=!1,Qa(),ae(),Pl=0,El=0,Tl=0,Ql}),rn.on('pinchstart',function(){clearTimeout(nn),nn=null,Na()}),V();ae();var Es=new THREE.TextureLoader;Es.crossOrigin='anonymous';var gn=Es.load(Vl.imdrop),mn=new THREE.SpriteMaterial({map:gn,color:16777215}),yn=Es.load(Vl.fallMap),fn=Es.load(Vl.fallMapA180),bn=Es.load(Vl.fallMapF0),xn=Es.load(imflask),wn=Es.load(imphoto),Sn=new THREE.SpriteMaterial({map:xn}),kn=new THREE.SpriteMaterial({map:wn}),zn=function(jn,Ln){var Pn=document.createElement('a');'string'==typeof Pn.download?(document.body.appendChild(Pn),Pn.download=Ln,Pn.href=jn,Pn.click(),document.body.removeChild(Pn)):location.replace(uri)};var Fn=function(jn,Ln){var Pn=new THREE.Vector3().subVectors(Ln,jn),En=new THREE.Matrix4;En.lookAt(jn,Ln,new THREE.Object3D().up);var Tn=new THREE.Matrix4;Tn.set(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),En.multiply(Tn);var On=new THREE.CylinderGeometry(0.1,0.1,Pn.multiplyScalar(0.3).length(),48,1),In=new THREE.Mesh(On,new THREE.MeshBasicMaterial({color:0}));In.applyMatrix(En);var Bn=new THREE.Vector3().addVectors(jn,Pn.multiplyScalar(0.5));return In.position.set(Bn.x,Bn.y,Bn.z),In},qn=function(jn,Ln){var Pn,En,Tn,On,In,Bn,Gn,Nn,_n,Wn,Un,Hn,Xn,Yn;for(Xn=[],Gn=jn.geometry.faceVertexUvs[0],Nn=jn.geometry.faces,_n=jn.geometry.vertices,Wn=new THREE.Matrix4,Un=new THREE.Matrix4,Yn=new THREE.Matrix4,gi.updateMatrixWorld(!0),On=0;On<Gn.length;On++)if(In=Gn[On],Bn=Nn[On],et(In,Ln)){Pn=_n[Bn.a].clone().applyMatrix4(jn.matrixWorld),En=_n[Bn.b].clone().applyMatrix4(jn.matrixWorld),Tn=_n[Bn.c].clone().applyMatrix4(jn.matrixWorld),Wn.set(Pn.x,Pn.y,Pn.z,0,En.x,En.y,En.z,0,Tn.x,Tn.y,Tn.z,0,0,0,0,1),Un.set(In[0].x,In[0].y,0,1,In[1].x,In[1].y,0,1,In[2].x,In[2].y,0,1,0,0,1,0),Un.getInverse(Un),Wn.multiplyMatrices(Un,Wn),Wn.elements=Ke(Wn),Wn.transpose(),Hn=new THREE.Vector3(Ln.x,Ln.y,1);var Kn=Hn.applyMatrix4(Wn);Xn.push(Kn),Xn.push(Bn.normal)}return Xn};check3dbox.onchange=function(){controls.enableRotate=check3dbox.checked,Js.updateDisplay()},syncfun=function(Ln,Pn){var En=function(){putdbf(Ln),wl=getsessionid()},Tn=function(){mt.end('Merging'),newdb.syncall(),En()},On=function(Bn){mt.start('Merging'),syncbtn.textContent='Merge start',newdb.wipeold(function(){newdb.mergewithstring(Bn,Tn)})};getver(function(Bn){var Gn=Bn[0];console.log('localver=',newdb.getsid(),'onlinever',Gn);var Nn=!0;for(var _n in newdb.files)Nn=Nn&&newdb.files[_n].issynced;syncbtn.textContent='Got versions',newdb.getsid()!=Gn||!Nn||params.forcesync?(syncbtn.textContent=newdb.getsid()+' '+Gn,getdbf(On)):(console.log('Version is up to date'),syncbtn.textContent='Version is up to date',null!=Pn&&Pn())})};getbypl=function(Ln,Pn){var En=normPel(Ln,Pn),Tn=En[0],On=En[1],In=Tn,Bn=On,Gn=newdb.sorted;newdb.sortbypelasc();var Nn=[],_n=JSON.parse(JSON.stringify(newdb.files));for(var Wn in _n){var Un=_n[Wn];if(!Un.toskip){var Hn=normPel(Un.ps,Un.pe);numintersect(Tn,On,Hn[0],Hn[1])&&(In=Math.min(In,Tn,On,Hn[0],Hn[1]),Bn=Math.max(Bn,Tn,On,Hn[0],Hn[1]),Nn.push(Un.savedata))}}for(var Wn in newdb.sortbytime(),ra(In,Bn),renderblock=1,Nn)Ra(Nn[Wn]);Qa(),allq.update(),renderblock=0,ae()};var Vn,Mn;Et();var Cn=[],Rn=1,Jn,An;cutpels=function(){params.onlycurpel=!0;var jn=Ia();M(),Ra(jn),Qa(),allq.update(),ae(),params.onlycurpel=!1},disassemble=function(){var jn=Ia();console.log('Sids are',jn.sids);var Ln=[];for(var Pn in jn.sids)Ln.push(Pn);for(var En in Ln)params.onlynew=parseInt(Ln[En]),En==Ln.length-1?le(1):le(1,1);params.onlynew=0,ie()},dat.GUI.prototype.removeFolder=function(jn){var Ln=this.__folders[jn];Ln&&(Ln.close(),this.__ul.removeChild(Ln.domElement.parentNode),delete this.__folders[jn],this.onResize())},S.callback(),picdb.ldb(function(){ra(picparams.ps,picparams.pe,params.tunnel)})}