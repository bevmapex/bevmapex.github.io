function bevgeoplot(h,S){function z(){Ni=document.getElementById(h).offsetWidth,_i=document.getElementById(h).offsetHeight}function F(Qn){var Vn=Qn.add(bf,'blank').name('').__li;Vn.setAttribute('class','cr function mydum')}function D(){}function Q(){Zs.get('tap').set({threshold:1,posThreshold:1,time:1,interval:2}),Zs.get('press').set({threshold:50,time:3}),Zs.get('pan').set({threshold:sensivity,time:4,direction:Hammer.DIRECTION_ALL}),Zs.get('pinch').set({enable:!0})}function V(Qn,Vn){var Cn=null==Vn?Vl:Vn;if(null==Qn)return console.log('Null object!'),null;for(var Mn,Rn=0;Rn<Cn.children.length;Rn++)if(Cn.children[Rn].uuid==Qn){Mn=Cn.children[Rn];break}return Mn}function C(){line3dtemp.children.length=0,line3dgroup.children.length=0,fallar.children.length=0,hi.visible=!1,Bl=yp=zp=-1e3,tn=-1e3,renderblock=1;for(var Qn=0;Qn<oman.ao.length;Qn++)oman.removefromscene(oman.get(Qn));_l=[],oman=new M,ha(),allp=new Be,allq=new _e,ka(),allq.update(),renderblock=0,ee()}function M(){this.ao=_l,this.history=[],this.sid=hl,this.so=null,this.sp=null,this.selidx=null,this.changelist={},this.updchangelist=function(Qn){this.changelist[Qn]=hl},this.select=function(Qn,Vn){this.so=null,this.sp=null,this.selidx=null;var Cn=fe(Qn,Vn);if(Cn[3]>Math.sqrt(Mi*Mi+Ci*Ci)/7)return console.log('Nothing selected'),[null,null];var Mn=Cn[0];return this.selidx=Mn,this.so=this.get(Mn),this.so||console.log('No object selected'),this.sp=allp.par[Je(Mn)],this.sp||console.log('No property selected'),gi.visible=!!this.so,[this.so,this.sp]},this.get=function(Qn){var Vn=this.ao[Qn];return null==Vn?(console.log('No object ',Qn),null):Vn},this.add=function(Qn){this.ao.push(Qn)},this.undo=function(){var Qn=this.history.pop();return Qn?void('add'==Qn[0]&&(this.removefromscene(Qn[1]),this.history.pop()),'remove'==Qn[0]&&(this.plot(Qn[1]),this.history.pop()),'removeSequence'==Qn[0]&&(this.plot(Qn[1]),this.history.pop(),'removeSequence'==this.history[this.history.length-1][0]&&this.undo()),'movefrom'==Qn[0]&&this.move(Qn[1],Qn[2],Qn[3]),ka(),ee()):void console.log('No history elements')},this.move=function(Qn,Vn,Cn){if(null==Qn)return void console.log('Trying to move null object');var Mn=V(Qn.id,'B'==Qn.type?bi:null);if(Mn){var Rn=Vn-Qn.xs,Jn=Cn-Qn.ys;Mn.position.x+=Rn,Mn.position.y+=Jn,params.movestart||this.history.push(['movefrom',Qn,Qn.xs,Qn.ys]),Qn.xs=Vn,Qn.ys=Cn,gi.visible=!0,gi.position.set(Vn,Cn,10),this.updchangelist(Qn.sid)}},this.erasefromhistory=function(Qn){for(var Vn=0;Vn<this.history.length;Vn)this.history[Vn][1].sameas(Qn)?this.history.splice(Vn,1):Vn++},this.removefromscene=function(Qn,Vn){if(1==Qn.skip)return!1;if('L'==Qn.type)return Qn.skip=1,Vn?this.history.push(['removeSequence',Qn]):this.history.push(['remove',Qn]),renderblock||this.updchangelist(Qn.sid),!0;var Cn=V(Qn.id,'B'==Qn.type?bi:null);return null==Cn?(console.log('No such object on scene',Qn),!1):('B'==Qn.type?bi.remove(Cn):Vl.remove(Cn),this.history.push(['remove',Qn]),ee(),Qn.skip=1,renderblock||this.updchangelist(Qn.sid),!0)},this.isdublicate=function(Qn){for(var Cn,Vn=0;Vn<this.ao.length;Vn++)Cn=this.get(Vn),Cn.sameas(Qn)&&(this.removefromscene(Cn),this.erasefromhistory(Qn))},this.plot=function(Qn){if('L'==Qn.type)return Qn.skip=0,void this.history.push(['add',Qn]);var Vn;'W'==Qn.type&&(Vn=U(Qn.xs,Qn.ys,Qn.zs,Qn.size)),'F'==Qn.type&&(Vn=$(Qn.xs,Qn.ys,Qn.zs,Qn.angle,Qn.fall,Qn.size),''!=Qn.color&&Bt(Qn.color)),'T'==Qn.type&&(Vn=H(Qn.text,Qn.xs,Qn.ys,Qn.zs,1- -Qn.fall)),'B'==Qn.type&&(Vn=O(Qn.xs,Qn.ys,Qn.zs,Qn.xe,Qn.ye,Qn.ze),li=[Vn,Qn],bi.add(Vn));Vn&&(Vn.name=_l.length,Qn.id=Vn.uuid,Qn.skip=0,this.history.push(['add',Qn]),'B'!=Qn.type&&Vl.add(Vn),ee())}}function R(Qn){!0==controls.enableRotate||((!params.move||'Line'==params.linetype)&&($s=Qn.center.x-Hi,lasty=Qn.center.y-Ui),Ml.x=2*((Qn.center.x-Hi)/Ni)-1,Ml.y=2*-((Qn.center.y-Ui)/_i)+1,kl?J():A())}function J(){fcp=1,Cl.setFromCamera(Ml,camera);var Qn=Cl.intersectObjects(meshes.children);if(0<Qn.length){var Vn=new Ca;Vn.sid=hl;var Cn=mr(Bl),Mn=mr(yp),Rn=mr(zp),Jn=mr(Gl),An=mr(yp2d),jn=mr(Qn[0].point.x),Ln=mr(Qn[0].point.y),Pn=mr(Qn[0].point.z),En=mr(2*(Qn[0].uv.x-0.5)*Ci),On=mr(2*(Qn[0].uv.y-0.5)*Mi);if(-1e3<Bl){var In=params.lineStyle==qa.lineStylear[0]?0:params.lineStyle==qa.lineStylear[1]?1:params.lineStyle==qa.lineStylear[2]?2:3,Tn=In+params.color,Bn=N(Cn,Mn,Rn,jn,Ln,Pn,Math.round(40*params.size),params.color);if(2==Qn.length){var Gn=mr(2*(Qn[1].uv.x-0.5)*Ci),Nn=mr(2*(Qn[1].uv.y-0.5)*Mi),_n={xs:Gn,ys:Nn,v:new THREE.Vector3(Qn[1].point.x,Qn[1].point.y,Qn[1].point.z)};linez.push(_n)}var _n={xs:Jn,ys:An,v:new THREE.Vector3(Cn,Mn,Rn)};linez.push(_n),line3dtemp.add(Bn)}Bl=jn,yp=Ln,zp=Pn,Gl=En,yp2d=On,zp2d=Pn}ee()}function A(){fcp=1,Cl.setFromCamera(Ml,camera);var Qn=Cl.intersectObjects(Nl);if(0<Qn.length){var Vn=new Ca;Vn.sid=hl;var Cn=mr(Bl),Mn=mr(yp),Rn=mr(zp),Jn=mr(Qn[0].point.x),An=mr(Qn[0].point.y),jn=mr(Qn[0].point.z);if(!kl&&Jn<-Ci)return je(An),params.linetype='Select',Le(),void ee();if('Line'==params.linetype){if(-1e3<Bl){hi.visible=!0,hi.position.set(Jn,An,10);var Ln=params.lineStyle==qa.lineStylear[0]?0:params.lineStyle==qa.lineStylear[1]?1:params.lineStyle==qa.lineStylear[2]?2:3,Pn=Ln+params.color,En=N(Cn,Mn,Rn,Jn,An,jn+params.layer+1,Math.round(30*params.size),params.color);En.name=_l.length,Vn.addline(Cn,Mn,Rn,Jn,An,jn+params.layer+1,Math.round(30*params.size),Pn),oman.plot(Vn),oman.add(Vn),yi.add(En),tn=Jn,endy=An}else en=Jn,firsty=An,firstz=jn;hi.visible=!0,hi.position.set(Jn,An,10),Bl=Jn,yp=An,zp=jn+params.layer+1}if('Bolt'==params.linetype)if(!Al)Vn.addbolt(Jn,An,jn+7,Jn,An,jn+7,params.bolttype),oman.plot(Vn),oman.add(Vn);else{B(Jn,An,jn+7);var On=oman.get(_l.length-1);On.xe=Yl.vertices[1].x,On.ye=Yl.vertices[1].y,On.ze=Yl.vertices[1].z}if('Fall'==params.linetype&&(jl?0!=params.fall&&Ia(Jn,An,jn+7):(Vn.addfall(Jn,An,jn+7,params.angle,params.fall,gl<yl),oman.plot(Vn),oman.add(Vn))),'Water'==params.linetype&&(Vn.addwater(Jn,An,jn+7,Math.round(10*params.wsize)/10),oman.plot(Vn),oman.add(Vn)),'Text'==params.linetype&&''!=params.text&&(Vn.addtext(params.text,Jn,An,jn+params.layer+1),oman.plot(Vn),oman.add(Vn)),'Select'==params.linetype)if(!params.move){oman.select(Jn,An);var In=fe(Jn,An);if(In[3]>Math.sqrt(Mi*Mi+Ci*Ci)/7)return;gi.visible=!0,gi.position.set(In[1],In[2],10),Di=In[0],Re(Di)}else if(oman.so){var Tn=Jn-0.1*Ci/camera.zoom,Bn=An+0.1*Mi/camera.zoom;oman.move(oman.get(Di),Tn,Bn)}}else'Select'==params.linetype?params.move&&re():(Oa(),gi.visible=!1);ee()}function L(){if(-1e3<tn){var Qn=new Ca;Qn.sid=hl;var Vn=params.lineStyle==qa.lineStylear[0]?0:params.lineStyle==qa.lineStylear[1]?1:params.lineStyle==qa.lineStylear[2]?2:3;if(0<Vn)return void(tn=endy=en=firsty=firstz=-1e3);var Cn=Vn+params.color;Qn.addline(tn,endy,firstz+params.layer+1,en,firsty,firstz+params.layer+1,Math.round(30*params.size),Cn),oman.plot(Qn),oman.add(Qn),tn=endy=en=firsty=firstz=-1e3,ka(),ee()}}function P(Qn,Vn,Cn){Vl.remove(vi);var Mn=6,Rn=0.1*Ai;vi=new THREE.Object3D;var Jn=-Mi,An=Mi,jn=N(1.13*Ci,Jn,0,1.13*Ci,An,0,10,Ha);vi.add(jn);var Ln={val:15},Pn=H(Qn,1.13*Ci+0.11*Ci,Jn+Rn,0,0,Ha);vi.add(Pn);var En=N(1.13*Ci,Jn,0,1.067*Ci,Jn,0,Mn,Ha);vi.add(En);var On=N(1.13*-Ci,Jn,10,1.067*-Ci,Jn,10,Mn,Ha);vi.add(On);var In=H(Vn,1.13*Ci+0.11*Ci,An-Rn,0,0,Ha);vi.add(In);var Tn=N(1.13*Ci,An,0,1.067*Ci,An,0,Mn,Ha),Bn=N(1.13*-Ci,An,10,1.067*-Ci,An,10,Mn,Ha);vi.add(Tn),vi.add(Bn);for(var Gn=1;Gn<pmult*(Vn-Qn)/5;++Gn){var Nn=-Mi+5*(pmult*Gn*(An-Jn))/(Vn-Qn),_n=N(1.13*Ci,Nn,0,1.067*Ci,Nn,0,Mn,Ha),Wn=N(1.13*-Ci,Nn,10,1.067*-Ci,Nn,10,Mn,Ha),Un=5*pmult*Gn+parseInt(Qn),Hn=H(Un,1.13*Ci+0.11*Ci,Nn,0,0,Ha);vi.add(_n),vi.add(Hn),vi.add(Wn)}var Yn=normPel(Qn,Vn);if(100<Yn[1]-Yn[0])for(var Gn=Yn[0]-1;Gn<=Yn[1];Gn++)if(0==Gn%100){fcp=1;var Kn=H(Gn,4*Ci,Ma(Gn),Ln,0,Ha);vi.add(Kn),fcp=0}if(null!=Cn){vi.position.set(0,Cn,0)}Vl.add(vi)}function O(Qn,Vn,Cn,Mn,Rn,Jn){var An=new THREE.Object3D,jn=0.07,Ln=N(Qn+jn,Vn+jn,Cn,Qn-jn,Vn-jn,Cn-0.01,2,'#000000'),Pn=N(Qn-jn,Vn+jn,Cn,Qn+jn,Vn-jn,Cn-0.01,2,'#000000'),En=Ta(Qn,Vn,Cn,2*(jn/Math.sqrt(2)),2,'#000000');return ii=T(Qn,Vn,Cn,Mn,Rn,Jn,1,'#000000'),An.add(Ln),An.add(Pn),An.add(En),An.add(ii),An}function I(){return 1/2e3}function T(Qn,Vn,Cn,Mn,Rn,Jn,An,jn){Yl=new THREE.Geometry,Kl=new THREE.Vector3(Qn,Vn,Cn),Yl.vertices.push(Kl),Yl.vertices.push(new THREE.Vector3(Mn,Rn,Jn));return G([Qn,Vn,Cn,Mn,Rn,Jn],10,jn)}function B(Qn,Vn,Cn){var Mn=(Kl.x-Qn)*(Kl.x-Qn)+(Kl.y-Vn)*(Kl.y-Vn),Rn=2*(vl/Vi),Jn=params.boltlen*Math.sin(Math.PI/24);if(Mn=Math.sqrt(Mn)/Rn,Mn<Jn)li[0].remove(ii),ii=T(Kl.x,Kl.y,Kl.z,Qn,Vn,Cn,1,'#000000'),li[0].add(ii),li[1].xe=Qn,li[1].ye=Vn,li[1].ze=Cn;else{var jn,Ln;jn=Kl.x+(Qn-Kl.x)/Mn*Jn,Ln=Kl.y+(Vn-Kl.y)/Mn*Jn,li[0].remove(ii),ii=T(Kl.x,Kl.y,Kl.z,jn,Ln,Cn,1,'#000000'),li[0].add(ii),li[1].xe=jn,li[1].ye=Ln,li[1].ze=Cn}console.log(li[1])}function G(Qn,Vn,Cn,Mn){if(0!=Qn.length){var Rn=new THREE.LineGeometry;Rn.setPositions(Qn);var Jn=Cn+'',An=0;if(7<Jn.length&&(An=Jn[0],Jn=Jn.slice(1,8)),0<An){var jn=_(Qn,Vn,Cn,Mn);return jn}var Ln=Math.abs(Vn),Pn=kl?5:3,En=new THREE.LineMaterial({color:new THREE.Color(Jn),linewidth:Ln/3,dashed:!1}),On=renderer.getSize();En.resolution.set(On.width,On.height);var jn=new THREE.Line2(Rn,En);return null==Mn&&fi.add(jn),jn}}function N(Qn,Vn,Cn,Mn,Rn,Jn,An,jn){var Ln=new Float32Array(6);Ln[0]=Qn,Ln[1]=Vn,Ln[2]=Cn,Ln[3]=Mn,Ln[4]=Rn,Ln[5]=Jn;var Pn=G(Ln,An,jn,1);return Pn}function _(Qn,Vn,Cn,Mn){if(0!=Qn.length){var Rn=Qn.length,Jn=Cn+'',An=0;7<Jn.length&&(An=Jn[0],Jn=Jn.slice(1,8));for(var jn=0,Ln=3;Ln<Rn;Ln+=3)jn+=Math.sqrt((Qn[Ln]-Qn[Ln-3])*(Qn[Ln]-Qn[Ln-3])+(Qn[Ln+1]-Qn[Ln-2])*(Qn[Ln+1]-Qn[Ln-2]));var Pn=new Float32Array(Rn);iOS&&(Pn=new Float32Array(2*Rn-3));for(var Ln=0;Ln<Qn.length;Ln++)Pn[Ln]=Qn[Ln];if(iOS)for(var On,Ln=0;Ln<Rn-3;Ln+=3)On=2*Rn-3-Ln-3,Pn[On]=Qn[Ln],Pn[On+1]=Qn[Ln+1],Pn[On+2]=Qn[Ln+2];var In=new THREE.Color(Jn),Tn=Math.abs(Vn)*I(),Bn=new MeshLineMaterial({color:In,lineWidth:Tn*lsc,useMap:!1,transparent:!!(0>Vn),opacity:0>Vn?0.6:1,resolution:Wi});if(1==An)var Bn=new MeshLineMaterial({color:In,lineWidth:Tn*lsc,useMap:!1,useAlphaMap:1,transparent:!0,alphaMap:Js,resolution:Wi});if(2==An){var Gn=Math.round(1.5*jn);Gn=1>Gn?1:Gn;var Bn=new MeshLineMaterial({color:In,lineWidth:Tn*lsc,useMap:!1,useAlphaMap:1,repeat:new THREE.Vector2(Gn,1),transparent:!0,alphaMap:As,resolution:Wi})}if(3==An){var Gn=Math.round(jn);In=new THREE.Color('#aaaaaa'),Gn=1>Gn?1:Gn;var Bn=new MeshLineMaterial({color:In,lineWidth:1.5*(Tn*lsc),useMap:!0,map:js,useAlphaMap:1,repeat:new THREE.Vector2(Gn,1),transparent:!0,alphaMap:js,resolution:Wi})}var Nn=new MeshLine;Nn.setGeometry(Pn);var _n=new THREE.Mesh(Nn.geometry,Bn);return null==Mn&&fi.add(_n),_n}}function W(Qn,Vn){var Cn=new THREE.Sprite;return Cn.position.set(Qn,Vn,2),Cn.scale.set(0.4,0.4,0.4),Cn}function U(Qn,Vn,Cn,Mn){var Rn=new THREE.Sprite(rn);return Rn.position.set(Qn,Vn,Cn),Rn.scale.x=Rn.scale.y=Mn*Ai,Rn}function H(Qn,Vn,Cn,Mn,Rn,Jn){var An=10,jn=new THREE.Object3D,Ln=Ba(Qn,Jn,Mn);if(Ln.position.set(Vn+0.1,Cn-0.05,An/5),jn.add(Ln),Rn){Ln.position.set(Vn+0.35,Cn-0.2,An/5);var Pn=0.07,En=N(-Pn,-Pn,10,Pn,Pn,10,An/5,'#000000'),On=N(Pn,-Pn,10,-Pn,Pn,10,An/5,'#000000');En.position.set(Vn,Cn,0),On.position.set(Vn,Cn,0);var In=W(Vn+0.35,Cn+0.12);In.visible=!1,jn.add(En),jn.add(On),jn.add(In),2==Rn&&(In.material=mn,In.visible=!0,console.log('photo added')),3==Rn&&(In.material=gn,In.visible=!0,console.log('labtest added'))}return jn}function Y(Qn){var Vn=new FileReader;Vn.onloadend=function(Cn){var Mn=gl;Me()&&(Mn=Math.round(Ra(_l[Di].ys)));var Rn=new Date,Jn='';Jn='pic_'+Mn+'_'+Rn.getMinutes()+'m'+Rn.getSeconds()+'s',yn(Cn.target.result,Jn+'.jpg'),X(Di,Jn,1),Ds.updateDisplay()},Vn.readAsDataURL(Qn.files[0])}function X(Qn,Vn,Cn){var Mn=_l[Qn];if('T'!=Me(Qn))return void console.log('not T');var Rn=Vl.getObjectByName(Qn),Jn=Rn.children[0];Jn.redrawInterval=1,Rn.children[0].material.map.text=''+Vn,Mn.text=Vn,oman.updchangelist(Mn.sid),null!=Cn&&(1==Cn&&(Mn.fall=1,Rn.children[3].material=mn),2==Cn&&(Mn.fall=2,Rn.children[3].material=gn),Rn.children[3].visible=1),ee(),setTimeout(function(){Jn.redrawInterval=1e8,ee()},1)}function Z(Qn,Vn,Cn){var Mn=_l[Qn];if('F'!=Me(Qn))return void console.log('not F');var Rn=Mn.size&&gl<yl?Cn:360-Cn,Jn=Vl.getObjectByName(Qn),An=Jn.children[1].children[0];An.redrawInterval=1,0!=Vn&&90!=Vn&&(Jn.children[1].children[0].material.map.text=''+Vn),Jn.children[0].material.rotation=Math.round(1e3*(-Math.PI/180*Rn))/1e3,0==Vn&&(Jn.children[0].material.map=cn,Jn.children[1].children[0].material.map.text='',Jn.children[0].material.rotation=0),90==Vn&&(Jn.children[0].material.map=pn,Jn.children[1].children[0].material.map.text=''),0!=Vn&&90!=Vn&&(Jn.children[0].material.map=dn),Mn.fall=parseInt(Vn),Mn.angle=parseInt(Cn),oman.updchangelist(Mn.sid),ee(),setTimeout(function(){An.redrawInterval=1e8,ee()},50)}function $(Qn,Vn,Cn,Mn,Rn,Jn){var An=Jn==gl<yl?Mn:360-Mn,jn='',Ln=new THREE.Object3D;if(0!=Rn&&90!=Rn){Xl=new THREE.SpriteMaterial({map:dn,color:16777215,rotation:-Math.PI/180*An});var Pn=new THREE.Sprite(Xl);jn=Rn+''}if(0==Rn)var En=new THREE.SpriteMaterial({map:cn,color:16777215}),Pn=new THREE.Sprite(En);if(90==Rn){Xl=new THREE.SpriteMaterial({map:pn,color:16777215,rotation:-Math.PI/180*An});var Pn=new THREE.Sprite(Xl)}Pn.position.set(Qn,Vn,Cn),Pn.scale.x=Pn.scale.y=0.4*Ai;var On=H(jn,Qn+0.25*Ji,Vn-0.12*Ai,Cn,0);return Ln.add(Pn),Ln.add(On),Ln}function ee(Qn,Vn){if(!renderblock){if(mt.start('render'),null==Qn&&controls.update(),kl?renderer.render(pi,camera):null==Vn?renderer.render(Vl,camera):renderer.render(Vn,camera),null==Qn&&(1==rendebug&&console.log('r'),2==rendebug)){var Cn=ee.caller;console.log(Cn)}mt.end('render')}}function ae(Qn,Vn){var Cn=La();if(!Cn)return void console.log('Nothing to save');var Mn=JSON.stringify(Cn),Rn=getpelrange(Mn,picparams.ps,picparams.pe);params.textsave=Mn,Ds.updateDisplay();var Jn=new Date,An='',jn=getauthorandsid(Cn);An='pel'+Rn[0]+'_'+Rn[1]+'\''+params.tunnel+'\''+jn.author+shortsid(jn.sid)+'.txt';var Ln={name:An,size:Mn.length,content:Mn},Pn=elemfromfile(Ln),En=function(Bn){dbputreg(Bn,function(){null==Vn&&(newdb.ldb(),allq.update())})};console.log('Attempt to add new file to db',Pn);var On=newdb.comparef(Pn);if(On){console.log('File already exists in db',On);var In=Pn.savedata,Tn=On.savedata;comparesave(In,Tn)?console.log('Files are same, not saving'):(console.log('Adding because files are different'),En(Pn))}else console.log('Adding new file to db',Pn),En(Pn);le(Qn)}function le(Qn){var Vn=La(1);if(!Vn)return void console.log('Nothing to save');var Cn=JSON.stringify(Vn),Mn=getpelrange(Cn,picparams.ps,picparams.pe);params.textsave=Cn,Ds.updateDisplay();var Rn=new Date,Jn='',An=getauthorandsid(Vn);Jn='pel'+Mn[0]+'_'+Mn[1]+'\''+params.tunnel+'\''+An.author+shortsid(An.sid)+'.txt';({name:Jn,size:Cn.length,content:Cn});null==Qn&&download(Cn,Jn)}function se(Qn,Vn){params.withbg||(mi.visible=!1),et();var Cn=new THREE.Scene;Cn.add(Fi),ee(null,Cn),console.log('start save as image'),oe(function(Mn){Vl.add(Fi),ee(),oe(Qn,Mn),mi.visible=!0,pt(),ka(),ee(),null!=Vn&&(params.what2plot='Geo+Q+Pel')},1)}function oe(Qn,Vn){var Cn,Rn=window.devicePixelRatio;try{Cn=renderer.domElement.toDataURL('image/png');var An=new Image,jn='For 3d'==params.what2plot?1:0,Ln='Only texture'==params.what2plot?1:0;An.onload=function(){var En=document.createElement('canvas');En.width=Ln?2*Fl:zl,En.height=Ln?2*Fl:Fl,En.width*=Rn,En.height*=Rn,En.visible=0;var On=En.getContext('2d');On.drawImage(An,0,0);var In=On.getImageData(0,0,En.width,En.height),Tn=In.data,Bn=Tn.length,Gn=[];if(null!=Vn&&!Array.isArray(Vn))for(var Nn=0;Nn<Bn;Nn+=4)if(208==Tn[Nn]&&208==Tn[Nn+1]&&208==Tn[Nn+2]);else Gn.push(Nn);if(null!=Vn&&!Array.isArray(Vn))return void Qn(Gn);if(!params.withbg){for(var Nn=0;Nn<Bn;Nn+=4)208==Tn[Nn]&&208==Tn[Nn+1]&&208==Tn[Nn+2]&&(Tn[Nn+3]=0);if(Array.isArray(Vn))for(var Nn=0;Nn<Vn.length;Nn++)Tn[Vn[Nn]+3]=100}console.log('done pic'),In.data=Tn,On.putImageData(In,0,0);var _n=document.createElement('canvas');_n.visible=0;var Wn=On.getImageData(Fl,0,Fl+zl,Fl);_n.width=Fl,_n.height=zl;var Un=_n.getContext('2d');if(Un.putImageData(Wn,0,0),Cn=Ln?_n.toDataURL():En.toDataURL(),rl=Cn,console.log('tmp pic saved'),void 0!==Qn)return Za=Cn,void Qn();if(!jn){var Hn=new Date,Yn='';Yn=Yn+'geo'+Hn.getHours()+'h'+Hn.getMinutes()+'m'+Hn.getSeconds()+'s.png',yn(Cn,Yn)}},An.src=Cn}catch(En){return void console.log(En)}}function re(){if(!Jl){var Qn=Me();Qn&&('L'==Qn?myask(container,'Remove line?',function(){de(),tn=-1e3,ka(),ee()}):(de(),ka(),ee()))}}function de(){if(oman.so){allp.remove(oman.sp);var Qn=[];if(Qn=ue(oman.selidx),'Group'==Bi.value&&1<Qn.length)for(var Vn=0;Vn<Qn.length;Vn++)oman.removefromscene(oman.get(Qn[Vn]),1);else oman.removefromscene(oman.so);gi.visible=!1,oman.so=null,oman.selidx=null}}function ue(Qn){for(var Vn=[Qn],Cn=Qn-1;0<=Cn&&1!=_l[Cn].skip&&_l[Cn].xe==_l[Cn+1].xs&&_l[Cn].ye==_l[Cn+1].ys;Cn--)Vn.push(Cn);for(var Cn=Qn+1;Cn<_l.length&&1!=_l[Cn].skip&&_l[Cn-1].xe==_l[Cn].xs&&_l[Cn-1].ye==_l[Cn].ys;Cn++)Vn.push(Cn);return Vn.sort((Mn,Rn)=>Mn-Rn),Vn}function he(Qn){var Vn=[];if(-1==Qn[0])return Vn;for(var Mn,Cn=0;Cn<Qn.length;Cn++)Mn=Qn[Cn],0==Cn&&(Vn.push(_l[Mn].xs),Vn.push(_l[Mn].ys)),Vn.push(_l[Mn].xe),Vn.push(_l[Mn].ye);return Vn}function ge(){oman.undo(),ka(),Gi.setAttribute('class','geobutton1'),setTimeout(function(){Gi.setAttribute('class','geobutton')},200)}function me(){this.tunnel='',this.zeropel=0,this.pelperunit=1,this.pelstart=0,this.pelend=20,this.qval={},this.pval={},this.pw=Ci,this.author='V',this.sid=hl,this.lastchange=0,this.objdata=[]}function fe(Qn,Vn){for(var Cn=_l.length,Mn=1e3,Rn=-1,Jn=-20,An=-20,jn=1,Ln=0;Ln<Cn;Ln++)if(!_l[Ln].skip){jn=1;var Pn=_l[Ln].xs,En=_l[Ln].ys,On=(Qn-Pn)*(Qn-Pn)+(Vn-En)*(Vn-En);if('L'==_l[Ln].type){var In=be(_l[Ln],Qn,Vn);On=In[0],Pn=In[2],En=In[3],(0>In[1]||1<In[1])&&(jn=0)}Mn>=On&&jn&&(Mn=On,Rn=Ln,Jn=Pn,An=En)}return[Rn,Jn,An,Math.sqrt(Mn)]}function be(Qn,Vn,Cn){var Mn=Qn.xs,Rn=Qn.xe,Jn=Qn.ys,An=Qn.ye,jn=Math.sqrt((Rn-Mn)*(Rn-Mn)+(An-Jn)*(An-Jn)),En=[0,1,2,3,4],In=((Rn-Mn)*(Vn-Mn)+(An-Jn)*(Cn-Jn))/jn/jn,Tn=Mn+In*jn*((Rn-Mn)/jn),Bn=Jn+In*jn*((An-Jn)/jn),Gn=Math.sqrt((Vn-Mn)*(Vn-Mn)+(Cn-Jn)*(Cn-Jn)),Nn=Math.sqrt((Vn-Rn)*(Vn-Rn)+(Cn-An)*(Cn-An)),_n=Math.sqrt((Vn-Tn)*(Vn-Tn)+(Cn-Bn)*(Cn-Bn));return En[0]=Math.sqrt((Vn-Tn)*(Vn-Tn)+(Cn-Bn)*(Cn-Bn)),we(In)||(En[0]=Math.min(Gn,Nn)),En[1]=In,En[2]=Tn,En[3]=Bn,En[4]=0,0>=(Rn-Mn)*(Cn-Jn)-(An-Jn)*(Vn-Mn)&&(En[4]=1),En}function we(Qn){return 0<=Qn&&1>=Qn}function Se(){localStorage.setItem('lastauthor',params.author)}function Fe(Qn){return': -1??'==Qn?'':Qn}function qe(Qn,Vn,Cn){Vn.value=Qn+Fe(': '+Cn),'-1??'!=Cn&&Vn.setAttribute('class','inguib aguibut')}function De(){qe('RQD',ks.rqd,Es.RQD+Es.RQDc),qe('Jn',ks.Jn,Es.Jn+Es.Jnc),qe('Jr',ks.Jr,Es.Jr+Es.Jrc),qe('Ja',ks.Ja,Es.Ja+Es.Jac),qe('Jw',ks.Jw,Es.Jw+Es.Jwc),qe('SRF',ks.SRF,Es.SRF+Es.SRFc),Es.getQ(),'????'==Es.Q+Es.class?ks.Q.name('Q = ?'):ks.Q.name('Q = '+Es.Q+Es.class),Ds.updateDisplay()}function Qe(Qn,Vn){var Cn=Qn.add(bf,'blank').name(Vn).__li;return Cn.setAttribute('class','cr function myguibut'),null==Vn&&Cn.removeChild(Cn.children[0]),Cn}function Ve(Qn){Qn.style.height='5px',Qn.style.height=Qn.scrollHeight-5+'px'}function Ce(Qn){for(var Vn=0;Vn<is.length;Vn++)if(Qn==is[Vn])return ss[Vn]}function Me(Qn){var Vn=0,Cn=Di;null!=Qn&&(Cn=Qn);Vl.getObjectByName(Cn);return null==_l[Cn]?Vn:1==_l[Cn].skip?Vn:_l[Cn].type}function Re(Qn){var Vn=Je(Qn);if(-3==Vn)return void console.log('Nothing selected');var Cn=Me(Qn);chosenp=Vn,-2==chosenp?(Os=new Te,Os.type=Cn,Os.coords=El,Os.isarea=Ge(El)):Os.restore(allp.par[chosenp]),wa('Select',Cn),Ds.updateDisplay()}function Je(Qn){var Vn=Me(Qn);if(!Vn)return console.log('Nothing selected'),-3;if('L'==Vn){var Cn=ue(Qn);El=he(Cn),0==El.length&&console.log('No lines selected')}else El=[_l[Qn].xs,_l[Qn].ys];return allp.get(El)}function Ae(Qn){for(var Vn=normPel(gl,yl),Cn=Vn[0];Cn<Vn[1];Cn+=5)if(Qn>=Cn&&Qn<Cn+5){var Mn=allq.get(Cn),Rn=allq.get(Cn+5);if(-2==Mn&&-2==Rn)return console.log('No Q near'),[Cn,Cn+5];var Jn=Cn,An=-2==Rn?Mn:Rn;Jn=-2==Rn?Math.max(allq.qar[Mn].ps,allq.qar[Mn].pe):Math.min(allq.qar[Rn].ps,allq.qar[Rn].pe);var jn=-2==Rn?5:-5;return[Jn,Jn+jn]}return console.log('No q found'),[Qn,Qn+5*Vn[2]]}function je(Qn){var Vn=Ra(Qn);if(Is=allq.get(Vn),-2==Is){Es=new We,Es.getQ();var Cn=Ae(Vn);Es.ps=Cn[0],Es.pe=Cn[1],Es.comment=''}else Es.restore(allq.qar[Is]);ee(),Wl==qa.qval?(Ds.removeFolder(qa.qval),va()):wa(qa.qval),ms.close(),Ds.removeFolder(qa.main),Ds.removeFolder(qa.setproperties),bs.open(),gi.visible=!0,gi.position.set(1.2*-Ci,0.35*Ma(Es.pe)+0.65*Ma(Es.ps),10),De(),Ds.updateDisplay()}function Le(){setTimeout(function(){Ds.open()},200)}function Pe(){Ds.close()}function Ee(){-1<Is?(Es.lastchange=hl,allq.qar[Is].restore(Es)):(allq.add(Es),Is=allq.qar.length-1),oman.updchangelist(Es.sid),allq.update(),Ht(null,1)}function Oe(){allq.remove(Is),allq.update(),ee(),Es=new We,De()}function Ie(){if(0==El.length)return void console.log('No lines selected');if(-1<chosenp){if('undefined'==typeof allp.par[chosenp])return void console.log('No lines selected');allp.par[chosenp].restore(Os),allp.par[chosenp].author=params.author,allp.par[chosenp].lastchange=hl,'L'==allp.par[chosenp].type&&(allp.par[chosenp].color=wt(Ce(Os.bergart)))}else Os.author=params.author,'L'==Os.type&&(Os.color=wt(Ce(Os.bergart))),Os.sid=hl,allp.add(Os),chosenp=allp.amtok()-1;oman.sp=allp.par[chosenp],allq.update(),ee()}function Te(){this.author=params.author,this.sid=hl,this.lastchange=hl,this.type='',this.bergart='none',this.ispartofQ=0,this.id='',this.coords=[],this.color=0,this.comment='',this.width=0,this.dsc='Not given',this.wdrip=0,this.wleak=0,this.isarea=!1,this.restore=function(Qn){var Vn=JSON.parse(JSON.stringify(Qn));this.sid=Vn.sid,this.lastchange=null==Vn.lastchange?this.sid:Vn.lastchange,this.type=Vn.type,this.id=Vn.id,this.coords=Vn.coords,this.bergart=Vn.bergart,this.width=Vn.width,this.comment=Vn.comment,this.ispartofQ=Vn.ispartofQ,null!=Vn.author&&(this.author=Vn.author),this.isarea=Vn.isarea,this.color=Vn.color,null!=Vn.dsc&&(this.dsc=Vn.dsc,this.wdrip=Vn.wdrip,this.wleak=Vn.wleak)},this.sameas=function(Qn){if(0==Qn.length)return!1;for(var Vn=0;Vn<Math.min(Qn.length,this.coords.length)&&!(6<Vn);Vn++){if(20<Vn)return console.log('Same',this.coords),!0;if(10<Qn.length){var Cn=Va(Qn[Vn],this.coords[Vn]);if(!Cn)return!0}if(!Qa(Qn[Vn],this.coords[Vn]))return!1}return!0},this.showprops=function(){var Qn;return Qn='W'==this.type?this.coords+' wdrip='+this.wdrip+' wleak='+this.wleak:this.bergart+' '+this.coords,Qn}}function Be(){this.par=[],this.getareas=function(){var Qn=[];for(var Vn in this.par){var Cn=this.par[Vn];Cn.isarea&&!Cn.ispartofQ&&Qn.push(Cn)}return Qn},this.amtok=function(){for(var Qn=0,Vn=0;Vn<this.par.length;Vn++)this.par[Vn].ispartofQ||Qn++;return Qn},this.add=function(Qn,Vn){var Cn=new Te;Cn.restore(Qn),this.par.push(Cn),null==Vn&&this.update()},this.remove=function(Qn,Vn){if('object'==typeof Qn)for(var Cn in console.log('Trying to remove',Qn),this.par){var Mn=this.par[Cn];if(Mn==Qn){this.par.splice(Cn,1);break}}else-1<Qn&&this.par.splice(Qn,1);null==Vn&&this.update()},this.cleanFromQ=function(){for(var Qn=0;Qn<this.par.length;Qn++)1==this.par[Qn].ispartofQ&&(this.remove(Qn,1),Qn--)},this.y2pelcoords=function(){for(var Qn=0;Qn<this.par.length;Qn++)for(var Vn=0;Vn<this.par[Qn].coords.length;Vn+=2)this.par[Qn].coords[Vn+1]=Ra(this.par[Qn].coords[Vn+1])},this.cleanFromPel=function(){for(var Qn=0;Qn<this.par.length;Qn++)_a(this.par[Qn].coords[1])||(console.log('Skipping property',this.par[Qn]),this.remove(Qn),Qn--)},this.get=function(Qn){for(var Vn=0;Vn<this.par.length;Vn++)if(this.par[Vn].sameas(Qn))return Vn;return-2},this.restore=function(Qn,Vn,Cn){var Mn=!1;null!=Cn&&(Mn=Cn);for(var Jn,Rn=0;Rn<Qn.par.length;Rn++)(Jn=this.ismemberalready(Qn.par[Rn]),null==Qn.par[Rn].sid&&(Qn.par[Rn].sid=qn),null==Qn.par[Rn].author&&(Qn.par[Rn].author=Dn),!(1==Mn&&Qn.par[Rn].sid<hl))&&(1<Mn&&Qn.par[Rn].sid!=Mn||(-1<Jn?this.par[Jn].restore(Qn.par[Rn]):this.add(Qn.par[Rn],Vn)));null==Vn&&(console.log('Update inside restore'),this.update())},this.ismemberalready=function(Qn){for(var Vn=0;Vn<this.par.length;Vn++)if(this.par[Vn].sameas(Qn.coords))return Vn;return-1},this.update=function(){mt.start('updatePinside');var Qn=renderblock;if(renderblock=1,ha(),params.showbergart)for(var Vn=0;Vn<this.par.length;Vn++)if(('L'==this.par[Vn].type||this.par[Vn].ispartofQ)&&(this.par[Vn].isarea&&Ye(this.par[Vn].coords,Ce(this.par[Vn].bergart),this.par[Vn].ispartofQ),''!=this.par[Vn].comment)){var Mn,Rn,Cn=this.par[Vn].coords.length;Mn=this.par[Vn].coords[Cn-2],Rn=this.par[Vn].coords[Cn-1];var Jn=H('comment!',Mn,Rn,5,1);Fi.add(Jn)}renderblock=Qn,mt.end('updatePinside')}}function Ge(Qn){var Vn=Qn.length;return Vn%2?(console.log('Odd amount of coordinates?'),console.log(Qn),!1):!(8>Vn)&&Qn[0]==Qn[Vn-2]&&Qn[1]==Qn[Vn-1]}function Ne(Qn){var Vn=gl<yl,Cn=allq.get(Qn);return-1<Cn&&(Vn=allq.qar[Cn].ps>allq.qar[Cn].pe?0:Vn),gl<tunborder&&(Vn=13730<Qn&&13915>Qn||14350<Qn&&14980>Qn?0:1),17057<Qn&&17068>Qn&&(Vn=1),Vn}function _e(){this.qar=[],this.add=function(Qn){var Vn=new We;Vn.restore(Qn),this.qar.push(Vn)},this.get=function(Qn){for(var Rn,Vn=1e3,Cn=-2,Mn=0;Mn<this.qar.length;Mn++)Rn=Vn,(this.qar[Mn].pe>Qn&&this.qar[Mn].ps<Qn||this.qar[Mn].ps>Qn&&this.qar[Mn].pe<Qn)&&(Vn=Math.min(Vn,Math.abs(Qn-this.qar[Mn].ps),Math.abs(Qn-this.qar[Mn].pe),Math.abs(Qn-(this.qar[Mn].pe+this.qar[Mn].ps)/2)),Rn!=Vn&&(Cn=Mn));return Cn},this.remove=function(Qn){-1<Qn&&(console.log('Removed Q'),oman.updchangelist(this.qar[Qn].sid),this.qar.splice(Qn,1))},this.removeP=function(Qn){var Vn=this.get(Qn);-1<Vn?this.qar.splice(Vn,1):console.log('No such Q with pel'+Qn)},this.getoverlaps=function(){for(var Qn=[],Vn=0;Vn<this.qar.length;Vn++){for(var Cn=0,Mn=this.qar[Vn],Rn=Math.min(Mn.ps,Mn.pe),Jn=Math.max(Mn.ps,Mn.pe),An=Vn+1;An<this.qar.length;An++){var jn=this.qar[An],Ln=Math.min(jn.ps,jn.pe),Pn=Math.max(jn.ps,jn.pe);if(Ln<=Jn&&Ln>=Rn){if(Ln==Jn)continue;var En=[Ln,Math.min(Pn,Jn)];Qn.push(En),Mn.Q==jn.Q&&Mn.comment==jn.comment&&(Mn.sid>jn.sid?(console.log('Removing overlap',jn),this.remove(An),An--):Cn=1);continue}if(Pn<=Jn&&Pn>=Rn){if(Pn==Rn)continue;var En=[Math.max(Ln,Rn),Pn];Qn.push(En),Mn.Q==jn.Q&&Mn.comment==jn.comment&&(Mn.sid>jn.sid?(console.log('Removing overlap',jn),this.remove(An),An--):Cn=1)}}Cn&&(console.log('Removing i',Mn),this.remove(Vn),Vn--)}return 2<Qn.length&&console.log('Overlaps',Qn),Qn},this.update=function(){mt.start('updateQ'),mt.start('Get Q overlaps'),this.getoverlaps(),mt.end('Get Q overlaps'),ua(),mt.start('Clean Q'),allp.cleanFromQ(),mt.end('Clean Q');for(var Qn=0;Qn<this.qar.length;Qn++)if(ca(this.qar[Qn].ps,this.qar[Qn].pe,this.qar[Qn].getQ(),this.qar[Qn].class,this.qar[Qn].comment),'none'!=this.qar[Qn].bergart){var Vn=new Be,Cn=new Te;Cn.ispartofQ=1;var Mn=Ma(this.qar[Qn].ps),Rn=Ma(this.qar[Qn].pe);Cn.coords=[-Ci,Mn,-Ci,Rn,Ci,Rn,Ci,Mn],Cn.bergart=this.qar[Qn].bergart,Cn.isarea=!0,Vn.add(Cn,1),allp.restore(Vn,1)}mt.start('updatePFinal'),allp.update(),mt.end('updatePFinal'),mt.end('updateQ')},this.clear=function(){ua(),this.qar=[]},this.restore=function(Qn,Vn,Cn){var Mn=!1;null!=Cn&&(Mn=Cn);for(var Rn=0;Rn<Qn.qar.length;Rn++)if((null==Qn.qar[Rn].sid&&(Qn.qar[Rn].sid=qn),null==Qn.qar[Rn].author&&(Qn.qar[Rn].author=Dn),!(1==Mn&&Qn.qar[Rn].sid<hl))&&!(1<Mn&&Qn.qar[Rn].sid!=Mn)){if(params.onlycurpel&&(!_a(Qn.qar[Rn].ps)||!_a(Qn.qar[Rn].pe))){console.log('Q not in limits'+Qn.qar[Rn].ps+' '+Qn.qar[Rn].pe);continue}var Jn=this.isequal(Qn.qar[Rn]);-1<Jn?this.qar[Jn].restore(Qn.qar[Rn]):this.add(Qn.qar[Rn])}null==Vn&&this.update()},this.isequal=function(Qn){for(var Vn=0;Vn<this.qar.length;Vn++)if(this.qar[Vn].ps==Qn.ps&&this.qar[Vn].pe==Qn.pe)return Vn;return-1}}function We(){this.author=params.author,this.sid=hl,this.lastchange=hl,this.ps=gl,this.pe=yl,this.RQDc='??',this.Jrc='??',this.Jwc='??',this.Jnc='??',this.Jac='??',this.SRFc='??',this.Jnmult=1,this.RQD=-1,this.Jr=-1,this.Jw=-1,this.Jn=-1,this.Ja=-1,this.SRF=-1,this.Q='??',this.class='??',this.comment='',this.bergart='none',this.getQ=function(){return 0>this.RQD||0>this.Jr||0>this.Jr||0>this.Jn||0>this.Ja||0>this.SRF?this.Q:(this.Q=Math.round(1e3*(Math.max(this.RQD,10)*this.Jr*this.Jw/(this.Jn*this.Ja*this.SRF)))/1e3,0.01<this.Q&&(this.Q=Math.round(100*this.Q)/100),1<this.Q&&(this.Q=Math.round(10*this.Q)/10),this.class='G',0.01<this.Q&&(this.class='F'),0.1<this.Q&&(this.class='E'),1<this.Q&&(this.class='D'),4<this.Q&&(this.class='C'),10<this.Q&&(this.class='A/B'),this.Q)},this.restore=function(Qn){this.ps=Qn.ps,this.pe=Qn.pe,this.comment=Qn.comment,this.bergart=Qn.bergart,this.RQDc=Qn.RQDc,this.Jrc=Qn.Jrc,this.Jwc=Qn.Jwc,this.Jnc=Qn.Jnc,this.Jac=Qn.Jac,this.SRFc=Qn.SRFc,this.Jnmultc=1,this.RQD=Qn.RQD,this.Jr=Qn.Jr,this.Jw=Qn.Jw,this.Jn=Qn.Jn,this.Ja=Qn.Ja,this.SRF=Qn.SRF,null!=Qn.author&&(this.author=Qn.author),null!=Qn.sid&&(this.sid=Qn.sid),this.lastchange=null==Qn.lastchange?this.sid:Qn.lastchange,this.getQ()}}function Ye(Qn,Vn,Cn){for(var Jn,Mn=[],Rn=0;Rn<Qn.length;Rn+=2)Jn=new THREE.Vector3(Qn[Rn],Qn[Rn+1],1-0.02*Cn),Mn.push(Jn);var jn,Ln,Pn=new THREE.Geometry,En=new THREE.MeshBasicMaterial({color:Vn,transparent:!0,opacity:0.7});En.side=THREE.DoubleSide,Pn.vertices=Mn,jn=THREE.ShapeUtils.triangulateShape(Mn,[]);for(var Rn=0;Rn<jn.length;Rn++)Pn.faces.push(new THREE.Face3(jn[Rn][0],jn[Rn][1],jn[Rn][2]));Ln=new THREE.Mesh(Pn,En),Fi.add(Ln),ee()}function Ke(Qn){for(var Vn=Qn.elements,Cn=0;Cn<Vn.length;Cn++)Vn[Cn]=mr(Vn[Cn]);return Vn}function Ze(Qn,Vn){var Cn={x:(Qn/Ci+1)/2,y:(Vn/Mi+1)/2};return Cn}function $e(Qn,Vn){var Cn=Vn.x-Qn[0].x,Mn=Vn.y-Qn[0].y,Rn=0<(Qn[1].x-Qn[0].x)*Mn-(Qn[1].y-Qn[0].y)*Cn;return 0<(Qn[2].x-Qn[0].x)*Mn-(Qn[2].y-Qn[0].y)*Cn!=Rn&&0<(Qn[2].x-Qn[1].x)*(Vn.y-Qn[1].y)-(Qn[2].y-Qn[1].y)*(Vn.x-Qn[1].x)==Rn}function et(){controls.reset(),controls.target.set(0,0,0),camera.position.set(0,0,Zi),cameraFix.position.set(0,0,Zi),Oa(),at(),ka()}function at(){var Qn=window.devicePixelRatio;zl=el,Fl=il,camera.left=-Ci,camera.right=Ci,camera.top=Mi+Ri,camera.bottom=-Mi+Ri,cameraFix.left=-Ci,cameraFix.right=Ci,cameraFix.top=Mi+Ri,cameraFix.bottom=-Mi+Ri,'Geo+Q+Pel'==params.what2plot&&(camera.left=-Ci-1.2,camera.right=Ci+1.2,zl*=1.3,lsc=0.5),zl/=Qn,Fl/=Qn;'For 3d'!=params.what2plot&&4096<Fl&&(zl=4096*zl/Fl,Fl=4096);var Cn=zl,Mn=Fl;'For 3d'==params.what2plot,renderer.setSize(Cn,Mn),Wi=new THREE.Vector2(Cn,Mn),'For 3d'==params.what2plot&&(lsc=Math.min(0.5,5e3/Mn));var Rn=android||iOS?4:1;buftext=new THREE.WebGLRenderTarget(4096/Rn,16384/Rn,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat}),camera.updateProjectionMatrix(),cameraFix.updateProjectionMatrix()}function lt(){kl||(sensivity=1,Q(),params.what2plot='For 3d',bt(gl,yl,1),et(),Sa(),kl=!0,renderer.render(Vl,cameraFix,buftext),pt(),Vt(),camera.position.set(0,0,1e3),params.what2plot='Geo+Q+Pel',controls.enableRotate=!0,ee(),check3dbox.style.display='',check3dbox.checked=!0,fgui.close(),wa('3d'))}function it(){if(kl){for(sensivity=5,Q();0<pi.children.length;)pi.remove(pi.children[0]);buftext.dispose(),Vl=ui,params.resetcam(),controls.enableRotate=!1,kl=!1,camera.position.set(0,0,Zi),lsc=1,pt(),ka(),Sa(),bt(gl,yl),setTimeout(function(){ee()},50),Bi.value='Select',wa('Line'),check3dbox.style.display='none',fgui.close(),Ds.close()}}function rt(){yl+=5*pmult,gl-=5*pmult,fl=Math.abs(parseInt(gl)-parseInt(yl)),il=vl*fl,Fl=il,Mi=il/Vi,P(gl,yl,Ri),bt(gl,yl),ca(gl,yl,-1),dt(sl,Ma(yl-2.5*pmult)),dt(sl,Ma(gl+2.5*pmult)),ee()}function dt(Qn,Vn){var Cn=new THREE.MeshBasicMaterial({color:16777215}),Mn=new THREE.PlaneGeometry(5*(2*(vl/Vi)),2*Ci,1,1),Rn=new THREE.Mesh(Mn,Cn);Rn.position.set(0,Vn,0),Rn.rotateZ(Math.PI/2),Nl.push(Rn),mi.add(Rn)}function pt(){z(),Wi=new THREE.Vector2(Ni,_i),Yi=Ni/_i,camera.left=-Ki*Yi/2,camera.right=Ki*Yi/2,camera.top=Xi/2,camera.bottom=-Xi/2,camera.updateProjectionMatrix(),renderer.setSize(Ni,_i),ee()}function ht(){if(Fs)return!1;for(var Qn=0,Vn=0;Vn<_l.length;Vn++)1!=_l[0].skip&&(Qn=1);if(allq.qar.length&&(Qn=1),!Qn)return!1;var Cn=new Date().getTime(),Mn=La(1),Rn=JSON.stringify(Mn);localStorage.setItem(Ul.s,Rn);var Jn=new Date().getTime()-Cn;return console.log('dT = '+Jn),!0}function gt(){if(localStorage.getItem(Ul.l)){var Qn=localStorage.getItem(Ul.l),Vn=JSON.parse(Qn);console.log('Sid set to',Vn.sid),Da(Vn),allq.update(),ka(),ee(),params.restses=0,wa('Line')}}function bt(Qn,Vn,Cn){if(Vl.remove(xi),!!params.rutenett){xi=new THREE.Object3D;var Mn=normPel(Qn,Vn),Rn=Mn[0],Jn=Mn[1],An=-4;null!=Cn&&(An=-0.5);for(var In,On=Rn;On<=Jn;On++){In=[],In.push(-Ci,Ma(On),1,1.13*Ci,Ma(On),1);var Tn=G(In,An,'0#000000');xi.add(Tn)}Vl.add(xi)}}function vt(){if(params.vederlag){var Qn=tungeom[params.tunnel].Width,Vn=[];for(var Cn in Qn){var Mn=Qn[Cn][1],Rn=Qn[Cn][3],Jn=Qn[Cn][5],An=Jn-Mn;Vn.push([Qn[Cn][0],2*((Qn[Cn][2]-Mn)/An)-1,2*((Qn[Cn][3]-Mn)/An)-1,2*((Qn[Cn][4]-Mn)/An)-1])}for(var Tn,Bn,Gn,Nn,An,jn=normPel(gl,yl),Ln=jn[0],Pn=jn[1],En=[],On=[],In=[],_n=1,Cn=Ln;Cn<Pn;Cn++){if(An=Math.max(Cn,Vn[0][0]),An=Cn,Tn=xt(An,Vn),Gn=Ma(An),Bn=xt(An+pmult,Vn),Nn=Ma(An+1),!Tn||!Bn){console.log('No vederlag data for pel=',Cn),_n=0;break}En.push(Tn[0]),En.push(Gn),En.push(1),On.push(Tn[1]),On.push(Gn),On.push(1),In.push(Tn[2]),In.push(Gn),In.push(1)}_n&&(En.push(Bn[0]),En.push(Nn),En.push(1),On.push(Bn[1]),On.push(Nn),On.push(1),In.push(Bn[2]),In.push(Nn),In.push(1)),G(En,-4,'0#000000'),G(On,-4,'0#000000'),G(In,-4,'0#000000')}}function xt(Qn,Vn){for(var Cn=Vn.length,Mn=xct=xrt=0,Rn=0,Jn=0,An=0;An<Cn-1;An++)if(Qn>=Vn[An][0]&&Qn<Vn[An+1][0]||Qn<=Vn[An][0]&&Qn>Vn[An+1][0]){var jn=Vn[An+1][0]-Vn[An][0];0==jn?Rn=[Vn[An][1]*Ci,Vn[An][2]*Ci,Vn[An][3]*Ci]:(Jn=(Qn-Vn[An][0])/(Vn[An+1][0]-Vn[An][0]),Mn=Vn[An][1]+Jn*(Vn[An+1][1]-Vn[An][1]),xct=Vn[An][2]+Jn*(Vn[An+1][2]-Vn[An][2]),xrt=Vn[An][3]+Jn*(Vn[An+1][3]-Vn[An][3]),Rn=[Mn*Ci,xct*Ci,xrt*Ci])}return Rn?Rn:Qn<Vn[0][0]?[Vn[0][1]*Ci,Vn[0][2]*Ci,Vn[0][3]*Ci]:[Vn[Cn-1][1]*Ci,Vn[Cn-1][2]*Ci,Vn[Cn-1][3]*Ci]}function wt(Qn,Vn){var Cn=Qn;return 7==Cn.length?(Cn=null==Vn?'0x'+Cn[5]+Cn[6]+Cn[3]+Cn[4]+Cn[1]+Cn[2]:'0x'+Cn[1]+Cn[2]+Cn[3]+Cn[4]+Cn[5]+Cn[6],parseInt(Cn)):0}function St(){kl?(Ei.style.display='none',Oi.style.display='none',Ii.style.display='none',Bi.style.display='none',Gi.style.display='none'):(Ei.style.display='',Oi.style.display='',Ii.style.display='',Bi.style.display='',Gi.style.display='')}function kt(){Ei.setAttribute('class','geobutton'),Oi.setAttribute('class','geobutton'),Ii.setAttribute('class','geobutton'),Ti.setAttribute('class','geobutton'),Bi.setAttribute('class','geobutton')}function Ft(Qn){var Vn=[],Cn=Qn.length;for(var Mn in Vn.push(jt(Qn[0][0]+1,Qn)),Qn)Qn[Mn][0]>Qn[0][0]+1&&Qn[Mn][0]<Qn[Cn-1][0]-1&&Vn.push(jt(Qn[Mn][0],Qn));return Vn.push(jt(Qn[Cn-1][0]-1,Qn)),Vn}function Dt(Qn){var Vn=tungeom[Qn].TunProfile,Cn=parse3dmod(Vn),Mn=Ft(Cn),Rn=Mt(Cn);for(var Jn in Mn)Rn.add(Qt(Mn[Jn]));var An=(Cn[0][0]+Cn[Cn.length-1][0])/2,jn=-Ma(An);return[Cn,Rn]}function Qt(Qn){var Vn=[];for(var Cn in Qn.v)Vn.push(Qn.v[Cn].x),Vn.push(Qn.v[Cn].y),Vn.push(Qn.v[Cn].z);var Mn=new THREE.Object3D,Rn=G(Vn,10,'0#000000');return Mn.add(Rn),Mn}function Vt(){p2y=Ma;var Qn=wn,Vn=Qn[0];lingeom=new THREE.Object3D,lingeom.add(wn[1]),lingeom.add(kn);var Cn=(Vn[0][0]+Vn[Vn.length-1][0])/2,Mn=Ma(Cn),Rn=getglobc((gl+yl)/2);lingeom.position.set(-Rn.x,-Rn.y,-Rn.z);var Jn=At(Vn),An=Jn[0];for(var jn in partlingeom=Jn[1],pmat=new THREE.MeshBasicMaterial({map:buftext.texture,transparent:!0,opacity:0.5,depthTest:!1}),pmat.side=THREE.DoubleSide,my3dgroup=new THREE.Object3D,meshes=new THREE.Object3D,An){var Ln=new THREE.Mesh(An[jn][2],pmat);Ln.castShadow=!1,Ln.receiveShadow=!1,meshes.add(Ln)}meshes.position.set(-Rn.x,-Rn.y,-Rn.z),my3dgroup.add(meshes),pi=new THREE.Scene,ui=Vl;var Rn=getglobc((gl+yl)/2),Pn=new THREE.Object3D;''!=strin&&Pn.add(Dl),Pn.position.set(-Rn.x,-Rn.y,-Rn.z),my3dgroup.add(Pn),An[0][2].computeBoundingSphere();var En=An[0][2].boundingSphere.center,On=new THREE.Quaternion;On.setFromUnitVectors(new THREE.Vector3(0,0,1),new THREE.Vector3(0,1,0)),my3dgroup.applyQuaternion(On);for(var In,Tn,Bn=0;Bn<oman.ao.length;Bn++)if('B'==oman.ao[Bn].type){var Gn=Ze(oman.get(Bn).xs,oman.get(Bn).ys),Nn=Ra(oman.get(Bn).ys),_n=new THREE.Vector2(Gn.x,Gn.y);for(var Wn in An)if(numintersect(An[Wn][0],An[Wn][1],Nn,Nn)){In=bn(meshes.children[Wn],_n);break}var Un=Ze(oman.get(Bn).xe,oman.get(Bn).ye),Nn=Ra(oman.get(Bn).ye),_n=new THREE.Vector2(Un.x,Un.y);for(var Wn in An)if(numintersect(An[Wn][0],An[Wn][1],Nn,Nn)){Tn=bn(meshes.children[Wn],_n);break}var Hn=Tn[0],Yn=Tn[1],Kn=In[0],Xn=In[1],Zn=10,$n=fn(new THREE.Vector3(Kn.x,Kn.y,Kn.z),new THREE.Vector3(Hn.x+1*(Xn.x*Zn),Hn.y+1*(Xn.y*Zn),Hn.z+1*(Xn.z*Zn)));Pn.add($n)}my3dgroup.add(lingeom),my3dgroup.add(partlingeom),pi.add(my3dgroup),pi.add(fallar),pi.add(line3dgroup),pi.add(line3dtemp),controls.enableRotate=!0,ee()}function Mt(Qn){for(var Vn=Qn[0][1].length,Cn=new THREE.Object3D,Mn=[],Rn=Qn[0][1],Jn=[],An=Qn[0][0]+1;An<Qn[Qn.length-1][0]-1;An+=2)Jn.push(jt(An,Qn));for(var jn in Rn){for(var Ln in Mn=[],Jn){var Pn=Jn[Ln],En=Pn.v[jn];Mn.push(En.x,En.y,En.z)}var jn=G(Mn,5,'0#000000');Cn.add(jn)}return Cn}function Jt(Qn,Vn){var Cn=[];if(Qn<Vn[0][0])return Dl=[Qn,Vn[0][1]],console.log('Not inside pel limits'),console.log(Qn,Vn[0][0]),Dl;if(Qn>Vn[Vn.length-1][0])return Dl=[Qn,Vn[Vn.length-1][1]],console.log('Not inside pel limits'),console.log(Qn,Vn[Vn.length-1][0]),Dl;for(var Mn=1;Mn<Vn.length;Mn++)if(Qn>=Vn[Mn-1][0]&&Qn<=Vn[Mn][0]){var Rn=Vn[Mn-1][0],Jn=Vn[Mn][0],An=(Qn-Rn)/(Jn-Rn);for(var jn in Vn[Mn][1]){var Ln=Vn[Mn][1][jn],Pn=Vn[Mn-1][1][jn];Cn.push(new THREE.Vector2(Ln.x*An+Pn.x*(1-An),Ln.y*An+Pn.y*(1-An)))}break}return Cn.length||console.log('Error! Vout not defined in getcurveatpel'),[Qn,Cn]}function At(Qn){for(var Pn,Vn=gl,Cn=yl,Mn=Jt(Vn,Qn),Rn=Jt(Cn,Qn),Jn=-1,An=[[0,Mn]],jn=[],Ln=0;Ln<Qn.length;Ln++)if((Pn=Qn[Ln][0],Math.round(Jn)!=Math.round(Pn))&&(Jn=Pn,Pn=Math.round(Pn),Wa(Pn,Vn,Cn))){var En=(Pn-Vn)/(Cn-Vn);jn.push([En,Qn[Ln]])}if(0<pmult)for(var On=0;On<jn.length;On++)An.push(jn[On]);else for(var On=jn.length-1;-1<On;On--)An.push(jn[On]);An.push([1,Rn]);for(var In=new THREE.Object3D,Tn=[],Bn=[],On=0;On<An.length-1;On++)for(var Gn=An[On][1][0],Nn=An[On+1][1][0],_n=0,Ln=Gn;0>(Ln-Nn)*pmult;Ln+=5*pmult){_n++;var En=(Ln-Vn)/(Cn-Vn);if(Bn.push([En,Jt(Ln,Qn)]),500<_n)return}Bn.push(An[An.length-1]);for(var On=1;On<Bn.length;On++){var Wn=jt(Bn[On][1][0],Qn),Un=jt(Bn[On-1][1][0],Qn);Tn.push([Bn[On-1][1][0],Bn[On][1][0],Lt(Un,Wn,Bn[On-1][0],Bn[On][0])])}return[Tn,In]}function jt(Qn,Vn){var Cn=Jt(Qn,Vn),Mn=getglobc(Qn),Rn=getglobc(Qn,1)[1]/180*Math.PI,Jn=getglobc(Qn+0.01),An=new THREE.Quaternion;null==Jn?(Jn=getglobc(Qn).sub(getglobc(Qn-0.01)).normalize(),Jn=Jn.normalize(),Jn.z=0,An.setFromUnitVectors(new THREE.Vector3(1,0,0),Jn)):(Jn=getglobc(Qn+0.01).sub(Mn),Jn=Jn.normalize(),Jn.z=0,An.setFromUnitVectors(new THREE.Vector3(1,0,0),Jn)),0.1<Math.abs(An.y)&&(console.log(Qn,Mn,Jn),console.log(Qn,An));var jn={pel:Qn,v:[]};for(var Ln in Cn[1]){var Pn=Cn[1][Ln],En=Math.sin(Rn),On=Math.cos(Rn),In=new THREE.Vector3(0,Pn.x,Pn.y);In.applyAxisAngle(new THREE.Vector3(1,0,0),Rn),In.applyQuaternion(An),In.add(Mn),jn.v.push(In)}return jn}function Lt(Qn,Vn,Cn,Mn){var Rn=new THREE.Geometry,Jn=0,An=Qn.v.length;Rn.faceVertexUvs[0]=[];for(var jn=0;jn<An-1;++jn){var Ln=Qn.v[jn],Pn=Qn.v[jn+1],En=Vn.v[jn],On=Vn.v[jn+1],In=(An-(jn+1))/(An-1),Tn=(An-(jn+2))/(An-1),Bn=null==Cn?0:Cn,Gn=null==Mn?1:Mn;Rn.vertices.push(new THREE.Vector3(Ln.x,Ln.y,Ln.z)),Rn.vertices.push(new THREE.Vector3(Pn.x,Pn.y,Pn.z)),Rn.vertices.push(new THREE.Vector3(En.x,En.y,En.z)),Rn.vertices.push(new THREE.Vector3(On.x,On.y,On.z)),Rn.faces.push(new THREE.Face3(Jn+2,Jn+1,Jn)),Rn.faces.push(new THREE.Face3(Jn+1,Jn+2,Jn+3)),Rn.faceVertexUvs[0].push([new THREE.Vector2(In,Gn),new THREE.Vector2(Tn,Bn),new THREE.Vector2(In,Bn)]),Rn.faceVertexUvs[0].push([new THREE.Vector2(Tn,Bn),new THREE.Vector2(In,Gn),new THREE.Vector2(Tn,Gn)]),Jn+=4}return Rn.uvsNeedUpdate=!0,Rn.computeFaceNormals(),Rn}function Pt(){kn=new THREE.Object3D;var Qn=tun2='';if('34100'==params.tunnel&&(tun2='34100',Qn='34000'),'34000'==params.tunnel&&(tun2='34000',Qn='34100'),Qn){globavg=tungeom[Qn].Geo3d.globavg,globtc=tungeom[Qn].Geo3d.globtc,kn=Dt(Qn)[1];var Vn=tv().copy(tungeom[Qn].Geo3d.globavg).sub(tungeom[tun2].Geo3d.globavg);kn.position.set(Vn.x,Vn.y,Vn.z)}globavg=tungeom[params.tunnel].Geo3d.globavg,globtc=tungeom[params.tunnel].Geo3d.globtc,globtc[0].pel-=0.1,('Kjorholt'==params.tunnel||'Tunnel1'==params.tunnel)&&(globtc[0].pel=13650),globtc[globtc.length-1].pel+=0.1,wn=Dt(params.tunnel),''!=strin&&(Dl=makecloud(strin))}function Et(){var Qn=linez.length;if(!(2>Qn)){for(var Cn,Vn=1;Vn<Qn;Vn++)Cn=new Ca,Cn.addline(linez[Vn-1].xs,linez[Vn-1].ys,1,linez[Vn].xs,linez[Vn].ys,1,Math.round(30*params.size),'#000000'),oman.add(Cn);var Mn=linez[0].v,Rn=linez[Math.floor(Qn/2)].v,Jn=linez[Qn-1].v,An=Ot();return console.log(An),console.log('Prev'),console.log([Mn,Rn,Jn]),An}}function Ot(){for(var Qn=linez.length,Vn=Math.floor(Qn/3),Cn=Math.floor(2*Qn/3),Mn=tv(),Rn=tv(),Jn=tv(),An=0;An<Vn;An++)Mn.add(linez[An].v);Mn.multiplyScalar(1/Vn);for(var An=Vn;An<Cn;An++)Rn.add(linez[An].v);Rn.multiplyScalar(1/(Cn-Vn));for(var An=Cn;An<Qn;An++)Jn.add(linez[An].v);return Jn.multiplyScalar(1/(Qn-Cn)),[Mn,Rn,Jn]}function Bt(Qn){var Vn=new THREE.Plane().setFromCoplanarPoints(Qn[0],Qn[1],Qn[2]),Cn=new THREE.Vector3((Qn[0].x+Qn[1].x+Qn[2].x)/3,(Qn[0].y+Qn[1].y+Qn[2].y)/3,(Qn[0].z+Qn[1].z+Qn[2].z)/3),Mn=new THREE.BoxGeometry(150,150,0.5),Rn=new THREE.MeshBasicMaterial({color:17408,transparent:!0,opacity:0.1}),Jn=new THREE.Mesh(Mn,Rn),An=new THREE.Quaternion;An.setFromUnitVectors(new THREE.Vector3(0,0,1),Vn.normal),Jn.applyQuaternion(An),Jn.position.set(Cn.x,Cn.y,Cn.z),Jn.scale.set(fscale.val,fscale.val,1),fallar.add(Jn)}function Gt(Qn){var Vn=new THREE.Plane().setFromCoplanarPoints(Qn[0],Qn[1],Qn[2]),Cn=new THREE.Vector3((Qn[0].x+Qn[1].x+Qn[2].x)/3,(Qn[0].y+Qn[1].y+Qn[2].y)/3,(Qn[0].z+Qn[1].z+Qn[2].z)/3),Mn=Vn.normal;0>Mn.y&&Mn.negate();var Rn=180*new THREE.Vector3(0,1,0).angleTo(Mn)/Math.PI,Jn=Ra(linez[0].ys),An=getglobc(Jn+1).sub(getglobc(Jn));An=An.normalize();var jn=getglobc((gl+yl)/2),Ln=new THREE.Quaternion;Ln.setFromUnitVectors(new THREE.Vector3(0,0,1),new THREE.Vector3(0,1,0)),An.applyQuaternion(Ln);var Pn=new THREE.Quaternion;Pn.setFromUnitVectors(new THREE.Vector3(0,1,0).applyQuaternion(Ln),new THREE.Vector3(1,0,0).applyQuaternion(Ln));var En=tv().copy(An).applyQuaternion(Pn),On=new THREE.Plane().setFromCoplanarPoints(Cn,tv().copy(Cn).add(En),tv().copy(Cn).add(An)),In=tv().copy(Mn).projectOnPlane(On.normal),Tn=In.angleTo(An)<Math.PI/2?1:0,Bn=180*In.angleTo(En)/Math.PI;return Bn=Tn?360-Bn:Bn,console.log('Strike:',Bn),console.log('Dip/Fall',Rn),[Math.floor(Bn),Math.round(Rn)]}function Wt(){if(linez.length){var Qn=new ConvexHullGrahamScan;for(var Vn in linez)Qn.addPoint(linez[Vn].xs,linez[Vn].ys);var Cn=Qn.getHull(),Mn=[];for(var Rn in linez)for(var Vn in Cn){var Jn=linez[Rn];Cn[Vn].x==Jn.xs&&Cn[Vn].y==Jn.ys&&Mn.push(Jn)}linez=Mn,linez.sort(function(En,On){return On.xs-En.xs});var An=y=0;for(var Rn in linez)An+=linez[Rn].xs,y+=linez[Rn].ys;An/=linez.length,y/=linez.length;var jn=Et(),Ln=Gt(jn),Pn=new Ca;Pn.addfall(An,y,8,Ln[0],Ln[1],1),Pn.color=jn,oman.plot(Pn),oman.add(Pn),Ut(linez),ka(),ee(),linez=[],controls.enableRotate=!0,check3dbox.checked=!0,Ds.updateDisplay()}}function Ut(Qn){var Vn=[];for(var Cn in Qn)Vn.push(Qn[Cn].v.x,Qn[Cn].v.y,Qn[Cn].v.z);if(Vn.length){var Mn=G(Vn,Math.round(40*params.size),'#000000',1);line3dgroup.add(Mn)}}function Ht(Qn,Vn){var Cn=new Date().getTime(),Mn=5e3;if(null!=Vn&&(Mn=Vn),Cn-si>Mn){for(var Rn in Ql){var Jn=Ql[Rn];Jn.redrawInterval=1}for(var Rn in ee(Qn),Ql){var Jn=Ql[Rn];Jn.redrawInterval=1e5}si=Cn}else ee(Qn)}function $t(){params.withbg?ea(sl):ea(''),as.material=ls,ee()}function ea(Qn){if(''==Qn)ls=new THREE.MeshBasicMaterial({color:16777215});else{var Vn=new THREE.TextureLoader;Vn.crossOrigin='anonymous';var Cn=Vn.load(Qn,function(){ee()});Cn.magFilter=THREE.NearestFilter,Cn.minFilter=THREE.LinearMipMapLinearFilter,Cn.anisotropy=2,gl>yl&&(Cn.flipY=!1),ls=new THREE.MeshBasicMaterial({map:Cn})}}function ia(Qn,Vn){hl=getsessionid(),C(),yl=parseInt(Vn),gl=parseInt(Qn),pmult=gl<yl?1:-1,wl=(gl+yl)/2,fl=Math.abs(parseInt(gl)-parseInt(yl)),vl=50,11>fl&&(vl=100),6>fl&&(vl=200),il=vl*fl,Fl=il,Mi=il/Vi,P(gl,yl,Ri),bt(gl,yl),pa(sl,0),ca(gl,yl,-1),params.resetcam(),ee(),picparams.ps=gl,picparams.pe=yl,saveifokdist(picparams.ps,picparams.pe),fgui.updateDisplay()}function oa(Qn,Vn,Cn){console.log('in pelfrom pic',picparams.ps,picparams.pe);var Mn=params.tunnel;null!=Cn&&(Mn=Cn);var Rn=Qn>Vn,Jn=Math.min(Qn,Vn),An=Math.max(Qn,Vn),jn=25*Math.floor(Jn/25);if(0>jn||0>Ln)return void console.log('Trying to get negative pels',jn,Ln);var Ln=25*Math.floor((An-0.01)/25+1),Pn=gettunlim(Mn);('Kjorholt'==params.tunnel||'Tunnel1'==params.tunnel)&&(Pn.pmin=13650);var En=checklims(jn,Ln,Pn);jn=En[0],Ln=En[1];for(var On=jn;On<Ln;On+=25){var In=Math.round(Math.min(parseInt(On+25),Ln)),Tn=Mn+On+'_'+In;dbgetpic(Tn,function(Bn){-1!=Bn&&ra(Bn,Rn)})}sl='',Rn?ia(Ln,jn):ia(jn,Ln),it(),fgui.close(),Ds.close()}function ra(Qn,Vn){var Cn=gl>yl;null!=Vn&&(Cn=Vn);var Mn=new THREE.TextureLoader;Mn.crossOrigin='anonymous',null!=Qn.tunmodel&&(deftm=Qn.tunmodel);var Rn=Mn.load(Qn.pic,function(){ee()});Rn.magFilter=THREE.NearestFilter,Rn.minFilter=THREE.LinearMipMapLinearFilter,Rn.anisotropy=2,Cn&&(Rn.flipY=!1);var Jn=new THREE.MeshBasicMaterial({map:Rn}),An=Math.abs(Ma(Math.max(Qn.ps,Qn.pe))-Ma(Math.min(Qn.ps,Qn.pe))),jn=Ma((Qn.ps- -Qn.pe)/2),Ln=new THREE.PlaneGeometry(An,2*Ci,1,1);as=new THREE.Mesh(Ln,Jn),as.position.set(0,jn,0.01);var Pn=Cn?Math.PI:0;as.rotateZ(Math.PI/2+Pn),Nl.push(as),mi.add(as)}function pa(Qn,Vn){Vl.remove(mi),mi=new THREE.Object3D,Nl.length=0,ea(Qn);var Cn=new THREE.PlaneGeometry(2*Mi,2*Ci,1,1);as=new THREE.Mesh(Cn,ls),as.position.set(0,Vn/vl,0);var Mn=gl>yl?Math.PI:0;as.rotateZ(Math.PI/2+Mn),Nl.push(as),mi.add(as),Vl.add(mi)}function ca(Qn,Vn,Cn,Mn,Rn){var Jn,An=!1;-1==Cn?(An=!0,Jn=11184810):(Jn=16711680,1<Cn&&(Jn=16769024),4<Cn&&(Jn=16746240),10<Cn&&(Jn=2258722));var jn=An?1:0.8,Ln=new THREE.MeshBasicMaterial({color:Jn,transparent:!0,opacity:jn}),Pn=Ma((Qn+Vn)/2),En=Math.abs(Ma(Vn)-Ma(Qn)),On=Ci/3,In=-Ci-On+Ci/10,Tn=new THREE.PlaneGeometry(On,En,1,1),Bn=new THREE.Mesh(Tn,Ln);if(Bn.position.set(In,Pn,An?0:1),An){var Gn=zi.children[0];null!=Gn&&zi.remove(Gn),zi.add(Bn),Nl.push(Bn)}else{ki.add(Bn);var Nn=H('Q='+Cn+' '+Mn,In,Pn,10,0);if(ki.add(Nn),null!=Rn&&''!=Rn){for(var _n='',Wn=0;Wn<Math.min(4,Rn.length);Wn++)_n+=Rn[Wn];_n+='..!';var Un=H(_n,In-0.35*Ji,Pn+0.38*En,10,1);ki.add(Un)}}}function ua(){for(;ki.children.length;){var Qn=ki.children[0];'undefined'!=typeof Qn.material&&Qn.material.dispose(),'undefined'!=typeof Qn.geometry&&Qn.geometry.dispose(),ki.remove(Qn)}}function ha(){for(;Fi.children.length;){var Qn=Fi.children[0];'undefined'!=typeof Qn.material&&Qn.material.dispose(),'undefined'!=typeof Qn.geometry&&Qn.geometry.dispose(),Fi.remove(Qn)}}function ga(){for(;fi.children.length;){var Qn=fi.children[0];'undefined'!=typeof Qn.material&&Qn.material.dispose(),'undefined'!=typeof Qn.geometry&&Qn.geometry.dispose(),fi.remove(Qn)}for(;Si.children.length;){var Qn=Si.children[0];'undefined'!=typeof Qn.material&&Qn.material.dispose(),'undefined'!=typeof Qn.geometry&&Qn.geometry.dispose(),Si.remove(Qn)}for(;yi.children.length;){var Qn=yi.children[0];'undefined'!=typeof Qn.material&&Qn.material.dispose(),'undefined'!=typeof Qn.geometry&&Qn.geometry.dispose(),yi.remove(Qn)}}function fa(Qn,Vn){var Cn=document.createElement('input',Vn);Cn.setAttribute('class','inguib'),Cn.setAttribute('type','button'),Cn.setAttribute('value',Qn),Cn.setAttribute('id','mgb'+Qn);var Mn=new Hammer(Cn);return Cn.onfocus=function(){Cn.blur()},Mn.on('press',function(){mycswitch(Cn,'ibpressed',500),null!=Vn&&setTimeout(function(){Vn()},150)}),Mn.get('press').set({threshold:100,time:3}),Cn}function ba(Qn,Vn){var Cn=Ds.add(bf,'blank').name('Geology:');Cn.onChange(function(){Ds.close()}),Cn.__li.setAttribute('class','cr function first');var Mn=parseFloat(Ds.domElement.style.width)-1;Cn.__li.style.width=Mn+'px';var Rn=Qe(Ds),Jn=fa('ShowDB',function(){Qs.showdb()});Jn.setAttribute('class','inguib but2gui'),Rn.appendChild(Jn),Jn=fa('Save',function(){params.save()}),Jn.setAttribute('class','inguib but2gui'),Rn.appendChild(Jn),ms=Ds.addFolder('Save/Open file'),ms.add(params,'loadprev').name(qa.restoresession),ms.add(params,'savealpha').name(qa.savepicture),ms.add(params,'author').name(qa.author).onChange(function(){Se()}).domElement.children[0].setAttribute('maxlength','20'),ms.add(params,'save').name(qa.savegeology),ms.add(params,'openfile').name(qa.openfilegeology);var An=ms.addFolder('Expert');if(An.add(params,'ex').name('Expert user').onChange(function(){Ds.close(),wa(Wl)}),An.add(params,'overridepel').name('Override pel'),An.add(params,'withbg').name(qa.showmwd).onChange(function(){$t()}),An.add(params,'showbergart').name(qa.showrocktype).onChange(function(){allp.update(),ee()}),An.add(params,'forcesync').name('ForcedSync'),null!=Qn&&(Qn==qa.qval&&va(),'Select'==Qn)){Ss=Ds.addFolder(qa.setproperties);var jn=sid2txtdate(Os.sid)+' '+Os.author;if(Ss.add(bf,'blank').name(jn),Ss.add(Os,'author').name(qa.author),'T'!=Vn){q22=Ss.add(Os,'comment').name('');var Ln=q22.domElement.children[0];Ln.setAttribute('class','myta'),q22.domElement.setAttribute('class','c bigtadiv'),Ln.placeholder='Comment...',Ln.onkeyup=function(){Ve(this)},Ln.onchange=function(){Ie()},q22.__li.setAttribute('class','cr string bigta')}if('T'==Vn&&(Ss.add(_l[Di],'text').name(qa.text).onChange(function(){X(Di,_l[Di].text)}),Ss.add(params,'openfoto').name(qa.takephoto),Ss.add(params,'makelab').name(qa.labtest)),null==Vn||'L'==Vn){Ss.add(Os,'bergart',is).name(qa.rocktype).listen().onChange(function(){params.parcolor=Ce(Os.bergart),Ds.updateDisplay()});var Rn=Ss.addColor(params,'parcolor').name(qa.color).listen().onChange(function(){params.parcolor=Ce(Os.bergart),Ds.updateDisplay()});console.log(Rn.__li),console.log(Rn.domElement);var Pn=Rn.domElement.children[0];Pn.style.width='70%'}return'W'==Vn&&(Ss.add(Os,'dsc',qa.dsc).name(qa.description),Ss.add(Os,'wdrip').name(qa.dripmin),Ss.add(Os,'wleak').name(qa.litmin)),'F'==Vn&&(Ss.add(_l[Di],'angle',0,360).step(1).name(qa.angle).onChange(function(){Z(Di,_l[Di].fall,_l[Di].angle)}),Ss.add(_l[Di],'fall',0,90).step(1).name(qa.fall).onChange(function(){Z(Di,_l[Di].fall,_l[Di].angle)})),Ss.add(bf,'blank').name(''),void Ss.add(params,'applyP').name(qa.ap)}ws=Ds.addFolder(qa.main),ws.add(bf,'blank').name(''),params.ex&&(ws.add(params,'bolt').name(qa.bolt),F(ws),ws.add(params,'clear').name(qa.clearall),F(ws),ws.add(params,'resetcam').name(qa.resetcamera),F(ws))}function va(){bs=Ds.addFolder(qa.qval);var Qn=sid2txtdate(Es.lastchange)+' by \''+Es.author+'\'';bs.add(bf,'blank').name('Updated '+Qn);var Vn=bs.add(Es,'ps').name('Pel start').domElement.children[0];Vn.type='tel',Vn.setAttribute('maxlength','5'),Vn=bs.add(Es,'pe').name('Pel end').domElement.children[0],Vn.type='tel',Vn.setAttribute('maxlength','5'),q22=bs.add(Es,'comment').name('');var Cn=q22.domElement.children[0];Cn.setAttribute('class','myta'),q22.domElement.setAttribute('class','c bigtadiv'),Cn.placeholder='Comment...',Cn.onkeyup=function(){Ve(this)},20<Es.comment.length&&Ve(Cn),Cn.onchange=function(){Ee()},q22.__li.setAttribute('class','cr string bigta');var Vn=Qe(bs);ks.rqd=fa('RQD',function(){params.editRQD()}),Vn.appendChild(ks.rqd),ks.Jr=fa('Jr',function(){params.editJr()}),Vn.appendChild(ks.Jr),ks.Jw=fa('Jw',function(){params.editJw()}),Vn.appendChild(ks.Jw),ks.Jn=fa('Jn',function(){params.editJn()}),Vn.appendChild(ks.Jn),ks.Ja=fa('Ja',function(){params.editJa()}),Vn.appendChild(ks.Ja),ks.SRF=fa('SRF',function(){params.editSRF()}),Vn.appendChild(ks.SRF);var Mn=bs.add(bf,'blank').name('');Mn.__li.setAttribute('class','cr function qtext'),ks.Q=Mn,bs.add(Es,'bergart',is).name(qa.rocktype);var Vn=Qe(bs),Rn=fa(qa.apply,function(){Ee()});Rn.setAttribute('class','inguib but2gui'),Vn.appendChild(Rn);var Rn=fa(qa.removeq,function(){params.removeq()});Rn.setAttribute('class','inguib but2gui'),Vn.appendChild(Rn)}function xa(){Ds=new dat.GUI({autoPlace:!1,width:Math.min(400,Ni/2-4)}),container.appendChild(Ds.domElement),Ds.domElement.id='guipos'}function wa(Qn,Vn){Wl=Qn;var Cn=Qn;kl?(Cn='3d',globgeo='Settings'):globgeo='Geology',St(),null==Cn&&(El=[],chosenp=-2);var Mn=Ds.closed;if(container.removeChild(Ds.domElement),Ds.destroy(),xa(),'3d'==Cn){var Rn=Ds.add(bf,'blank').name('Settings:');Rn.onChange(function(){Ds.close()}),Rn.__li.setAttribute('class','cr function first');var Jn=parseFloat(Ds.domElement.style.width)-1;return Rn.__li.style.width=Jn+'px',Ds.add(lingeom,'visible').name('Tunnel frame').onChange(function(){ee()}),Fn&&(pointval.valmin=23,params.opacity=0.3,pointCloud.geometry.drawRange.start=pointval.ar[pointval.valmin-1],pointCloud.geometry.drawRange.count=pointval.ar[pointval.valmax-1]-pointCloud.geometry.drawRange.start,meshes.children[0].material.opacity=params.opacity,pMaterial.size=10,ee(),Fn=0),''!=strin&&(Ds.add(pointval,'valmin',1,pointval.ar.length).name('Min').step(1).onChange(function(){pointCloud.geometry.drawRange.start=pointval.ar[pointval.valmin-1],pointCloud.geometry.drawRange.count=pointval.ar[pointval.valmax-1]-pointCloud.geometry.drawRange.start,ee()}),Ds.add(pointval,'valmax',1,pointval.ar.length).name('Max').step(1).onChange(function(){pointCloud.geometry.drawRange.count=pointval.ar[pointval.valmax-1]-pointCloud.geometry.drawRange.start,ee()}),Ds.add(pMaterial,'size',5,35).name('Point size').step(1).onChange(function(){ee()}),Ds.add(params,'opacity',0,1).name('Tunnel opacity').step(0.1).onChange(function(){meshes.children[0].material.opacity=params.opacity,ee()})),Ds.add(fscale,'val',0,1).name('Plane size').step(0.02).onChange(function(){for(var jn in fallar.children)fallar.children[jn].scale.set(fscale.val,fscale.val,1);ee()}),void Ds.updateDisplay()}if(ba(Cn,Vn),null==Vn&&Oa(),kt(),'Q - value'==Cn&&(Ds.updateDisplay(),params.linetype='Q - value',Bi.value='Select'),'Line'==Cn&&(Ei.setAttribute('class','geobuttonf'),params.linetype='Line',q22=ws.add(params,'lineStyle',qa.lineStylear).name(qa.ls),params.ex&&ws.add(params,'size',0.1,1).name('Size').step(0.1),ws.add(bf,'blank').name('')),'Water'==Cn&&(Oi.setAttribute('class','geobuttonf'),params.linetype='Water',ws.add(params,'wsize',0.1,1).step(0.1).name('Size'),ws.add(bf,'blank').name('')),'Text'==Cn){Ii.setAttribute('class','geobuttonf'),params.linetype='Text',q22=ws.add(params,'text').name(qa.ttp),ws.add(bf,'blank').name('');var An=q22.domElement.children[0];An.setAttribute('class','myta'),An.placeholder='Some text...'}'Fall'==Cn&&(Ti.setAttribute('class','geobuttonf'),params.linetype='Fall',q22=ws.add(params,'angle',0,360).step(1).name(qa.angle),ws.add(params,'fall',0,90).step(1).name(qa.fall),ws.add(bf,'blank').name('')),'Bolt'==Cn&&(params.linetype='Bolt',ws.add(params,'boltlen',1,10).step(0.5).name(qa.len),ws.add(params,'bolttype',qa.boltlist).name(qa.material),ws.add(bf,'blank').name('')),'Select'==Cn?(Bi.setAttribute('class','geobuttonf'),params.linetype='Select'):ws.open(),Ds.updateDisplay(),Mn?Pe():Le()}function Sa(){for(var Qn in bi.children.length=0,oman.ao){var Vn=oman.ao[Qn];Vn.toskip||'B'!=Vn.type||oman.plot(Vn)}}function ka(){ga(),vt();for(var Qn=[],Vn=0;Vn<_l.length;Vn++)0==_l[Vn].skip&&Qn.push(_l[Vn]);for(var Rn,Jn,Cn=yprev=cprev=sprev=-1e3,Mn=[],Vn=0;Vn<Qn.length;Vn++)if('L'==Qn[Vn].type)if(Cn==Qn[Vn].xs&&yprev==Qn[Vn].ys&&cprev==Qn[Vn].color&&sprev==Qn[Vn].size){var An=[Qn[Vn].xe,Qn[Vn].ye,Qn[Vn].zs];Cn=Qn[Vn].xe,yprev=Qn[Vn].ye,Mn.push(An[0]),Mn.push(An[1]),Mn.push(An[2])}else G(Mn,Jn,Rn),Cn=Qn[Vn].xe,yprev=Qn[Vn].ye,cprev=Qn[Vn].color,sprev=Qn[Vn].size,Mn=[Qn[Vn].xs,Qn[Vn].ys,Qn[Vn].zs,Cn,yprev,Qn[Vn].zs],Rn=Qn[Vn].color,Jn=Qn[Vn].size;G(Mn,Jn,Rn)}function za(){this.oldzero=1,this.oldppu=1,this.oldpw=1,this.getnewy=function(Qn){var Cn=Ma(Qn);return Cn=mr(Cn),Cn},this.getnewx=function(Qn){var Vn=Qn/this.oldpw*Ci;return Vn=mr(Vn),Vn}}function Fa(Qn,Vn){for(var Cn in Vn)for(var Mn=Vn[Cn],Rn=0;Rn<Mn.length;Rn++)if(Mn[Rn]==Qn)return''+Cn;return null}function Da(Qn){mt.start('Get json');var Vn='object'==typeof Qn?JSON.parse(JSON.stringify(Qn)):JSON.parse(Qn);var Cn=Vn.objdata;mt.end('Get json');var Mn=new za,Rn=Vn.authors,Jn=Vn.sids,An=Vn.chlist;if(null==An||isEmpty(An))for(var jn in Jn)oman.changelist[jn]=jn;else for(var jn in Jn)oman.changelist[jn]=An[jn];Mn.oldzero=Vn.zeropel,Dn=Vn.author,Mn.oldppu=Vn.pelperunit,Mn.oldpw=Vn.pw,qn=Vn.sid,allq.restore(Vn.qval,1);for(var Ln=Vn.pval,Pn=0;Pn<Ln.par.length;Pn++)for(var jn=0;jn<Ln.par[Pn].coords.length;jn+=2)Ln.par[Pn].coords[jn]=Mn.getnewx(Ln.par[Pn].coords[jn]),Ln.par[Pn].coords[jn+1]=Mn.getnewy(Ln.par[Pn].coords[jn+1],1);allp.restore(Ln,1);for(var Bn,En=Cn.length,On=6,In='#000000',Tn=qy=qz=tmpy=tmpx=-1e3,jn=0;jn<En;jn++){if(Bn=new Ca,null==Jn)Bn.sid=qn;else{var Gn=Fa(jn,Jn);Bn.sid=null==Gn?qn:Gn}if(null==Rn)Bn.author=Dn;else{var Gn=Fa(jn,Rn);Bn.author=null==Gn?Dn:Gn}var Nn=Cn[jn];if(2==Nn.length){tmpx=Mn.getnewx(Nn[0]/qprec),tmpy=Mn.getnewy(Nn[1]/qprec),Bn.addline(Tn,qy,qz,tmpx,tmpy,qz,On,In),Tn=Mn.getnewx(Nn[0]/qprec),qy=Mn.getnewy(Nn[1]/qprec),oman.isdublicate(Bn),oman.plot(Bn),oman.add(Bn);continue}if(0==Nn[0]){On=15,In='#000000',6<Nn.length&&('number'==typeof Nn[6]&&(On=Nn[6]),'string'==typeof Nn[6]&&(In=Nn[6])),8==Nn.length&&(In=Nn[7]),Tn=Mn.getnewx(Nn[4]/qprec),qy=Mn.getnewy(Nn[5]/qprec),qz=Nn[3],tmpx=Mn.getnewx(Nn[1]/qprec),tmpy=Mn.getnewy(Nn[2]/qprec),Bn.addline(tmpx,tmpy,qz,Tn,qy,qz,On,In),oman.isdublicate(Bn),oman.plot(Bn),oman.add(Bn);continue}if(1==Nn[0]){On=0.5,3<On.length&&(On=Nn[3]),tmpx=Mn.getnewx(Nn[1]/qprec),tmpy=Mn.getnewy(Nn[2]/qprec),Bn.addwater(tmpx,tmpy,10,On),oman.isdublicate(Bn),oman.plot(Bn),oman.add(Bn);continue}if(2==Nn[0]){tmpx=Mn.getnewx(Nn[1]/qprec),tmpy=Mn.getnewy(Nn[2]/qprec);var _n=Nn[4];'_pho_'==_n.slice(0,5)&&(Bn.fall=1,_n=_n.slice(5),console.log(_n)),'_lab_'==_n.slice(0,5)&&(Bn.fall=2,_n=_n.slice(5)),Bn.addtext(_n,tmpx,tmpy,Nn[3],1),oman.isdublicate(Bn),oman.plot(Bn),oman.add(Bn);continue}if(3==Nn[0]&&(tmpx=Mn.getnewx(Nn[1]/qprec),tmpy=Mn.getnewy(Nn[2]/qprec),Bn.addfall(tmpx,tmpy,10,Nn[3],Nn[4],Nn[5]),null!=Nn[6]&&(Bn.color=[tv(Nn[6][0].x,Nn[6][0].y,Nn[6][0].z),tv(Nn[6][1].x,Nn[6][1].y,Nn[6][1].z),tv(Nn[6][2].x,Nn[6][2].y,Nn[6][2].z)]),oman.isdublicate(Bn),oman.plot(Bn),oman.add(Bn)),4==Nn[0]){Bn.addbolt(Mn.getnewx(Nn[1]/qprec),Mn.getnewy(Nn[2]/qprec),Nn[3],Mn.getnewx(Nn[4]/qprec),Mn.getnewy(Nn[5]/qprec),Nn[6],Nn[7]),oman.isdublicate(Bn),oman.plot(Bn),oman.add(Bn);continue}}}function Qa(Qn,Vn,Cn){var Mn=0.02/Math.abs(gl-yl);null!=Cn&&(Mn=Cn);var Rn=Math.abs(parseFloat(Qn)-parseFloat(Vn));return!!(Rn<Mn)}function Va(Qn,Vn){var Mn=Math.abs(parseFloat(Qn)-parseFloat(Vn));return Mn}function Ca(){this.type='',this.sid=hl,this.author=params.author,this.id=0,this.skip=0,this.text='',this.xs=0,this.ys=0,this.zs=0,this.xe=0,this.ye=1,this.ze=1,this.size=3,this.color='',this.fall=0,this.angle=0,this.lastmx=-1e3,this.lastmy=-1e3,this.sameas=function(Qn){return this.type==Qn.type&&Qa(this.xs,Qn.xs)&&Qa(this.ys,Qn.ys)},this.addline=function(Qn,Vn,Cn,Mn,Rn,Jn,An,jn){this.type='L',this.size=An,this.color=jn,this.xs=Qn,this.ys=Vn,this.zs=Cn,this.xe=Mn,this.ye=Rn,this.ze=Jn},this.addbolt=function(Qn,Vn,Cn,Mn,Rn,Jn,An){this.type='B',this.text=An,this.xs=Qn,this.ys=Vn,this.zs=Cn,this.xe=Mn,this.ye=Rn,this.ze=Jn},this.addwater=function(Qn,Vn,Cn,Mn,Rn,Jn,An,jn){this.type='W',this.size=Mn,this.xs=Qn,this.ys=Vn,this.zs=Cn,null!==Rn&&(this.text=Rn),null!==Jn&&(this.xe=Jn),null!==An&&(this.fall=An),null!==jn&&(this.angle=jn)},this.addfall=function(Qn,Vn,Cn,Mn,Rn,Jn){this.type='F',this.xs=Qn,this.ys=Vn,this.zs=Cn,this.angle=Mn,this.fall=Rn,this.size=null==Jn?Ne(Ra(Vn)):Jn},this.addtext=function(Qn,Vn,Cn,Mn){this.type='T',this.text=Qn,this.xs=Vn,this.ys=Cn,this.zs=Mn}}function Ma(Qn){var Vn=parseFloat(2*(pmult*(Qn-parseFloat(wl))*vl/Vi));return Vn}function Ra(Qn){var Vn=parseFloat(pmult*Qn/(2*(vl/Vi))+wl);return Vn}function ja(Qn,Vn){for(var Cn=[],Mn=[],Rn=JSON.parse(JSON.stringify(Qn)),Jn=0;Jn<Rn.length;Jn++)if(!isinarray(Mn,Jn)){var An=params.onlynew&&!Vn?Rn[Jn].sid==hl:1;1<params.onlynew&&(An=Rn[Jn].sid==params.onlynew?1:0);var jn=1;if(params.onlycurpel&&!Vn&&!_a(Ra(Rn[Jn].ys))){var Ln=ue(Jn);add2array(Mn,Ln),jn=0}!Rn[Jn].skip&&An&&jn&&Cn.push(Rn[Jn])}return Cn}function La(Qn){var Vn=0;null!=Qn&&(Vn=Qn);var Cn=ja(_l,Vn),Mn=new me;Mn.lastchange=oman.changelist[params.onlynew],null==Mn.lastchange&&(Mn.lastchange=hl),Mn.zeropel=wl,Mn.pelperunit=vl*pmult,Mn.pw=Ci,Mn.pelstart=gl,Mn.pelend=yl,Mn.author=params.author,Mn.authors={},Mn.sid=hl,Mn.sids={},Mn.tunnel=params.tunnel;var Rn=new _e;Vn?Rn.restore(allq,1):Rn.restore(allq,1,params.onlynew),Mn.qval=Rn;var Jn=new Be;Jn.restore(allp,1,params.onlynew&&!Vn),Vn?Jn.restore(allp,1):Jn.restore(allp,1,params.onlynew),Jn.cleanFromQ(),Jn.y2pelcoords(),params.onlycurpel&&Jn.cleanFromPel(),Mn.pval=Jn;for(var An=yprev=cprev=sprev=-1e3,jn=0;jn<Cn.length;jn++)Cn[jn].ys=Ra(Cn[jn].ys),Cn[jn].ye=Ra(Cn[jn].ye);for(var Ln,jn=0;jn<Cn.length;jn++){Ln=Cn[jn].author,null==Mn.authors[Ln]?Mn.authors[Ln]=[jn]:Mn.authors[Ln].push(jn);var Pn=Cn[jn].sid;if(null==Mn.sids[Pn]?Mn.sids[Pn]=[jn]:Mn.sids[Pn].push(jn),'L'==Cn[jn].type){if(An==Math.round(Cn[jn].xs*qprec)&&yprev==Math.round(Cn[jn].ys*qprec)&&cprev==Cn[jn].color&&sprev==Cn[jn].size){var En=[Math.round(Cn[jn].xe*qprec),Math.round(Cn[jn].ye*qprec)];An=Math.round(Cn[jn].xe*qprec),yprev=Math.round(Cn[jn].ye*qprec)}else{An=Math.round(Cn[jn].xe*qprec),yprev=Math.round(Cn[jn].ye*qprec),cprev=Cn[jn].color,sprev=Cn[jn].size;var En=[0,Math.round(Cn[jn].xs*qprec),Math.round(Cn[jn].ys*qprec),Cn[jn].zs,An,yprev];6!=Cn[jn].size&&En.push(Cn[jn].size),'#000000'!=Cn[jn].color&&En.push(Cn[jn].color)}Mn.objdata.push(En)}if('W'==Cn[jn].type){An=-1e3;var En=[1,Cn[jn].xs*qprec,Cn[jn].ys*qprec];0.5!=Cn[jn].size&&En.push(Cn[jn].size),Mn.objdata.push(En)}if('T'==Cn[jn].type){An=-1e3;var On=Cn[jn].text;1==Cn[jn].fall&&(On='_pho_'+On),2==Cn[jn].fall&&(On='_lab_'+On);var En=[2,Cn[jn].xs*qprec,Cn[jn].ys*qprec,Cn[jn].zs,On];Mn.objdata.push(En)}if('F'==Cn[jn].type){if(An=-1e3,''!=Cn[jn].color)var En=[3,Cn[jn].xs*qprec,Cn[jn].ys*qprec,Cn[jn].angle,Cn[jn].fall,Cn[jn].size,Cn[jn].color];else var En=[3,Cn[jn].xs*qprec,Cn[jn].ys*qprec,Cn[jn].angle,Cn[jn].fall,Cn[jn].size];Mn.objdata.push(En)}if('B'==Cn[jn].type){An=-1e3;var En=[4,Cn[jn].xs*qprec,Cn[jn].ys*qprec,Cn[jn].zs,Cn[jn].xe*qprec,Cn[jn].ye*qprec,Cn[jn].ze,Cn[jn].text];Mn.objdata.push(En)}}var In=Object.keys(Mn.authors).length;if(1==In){var Tn=Fa(0,Mn.authors);null!=Tn&&(Mn.author=Fa(0,Mn.authors)),null==Mn.authors}var Bn=Object.keys(Mn.sids).length;if(1==Bn){var Tn=Fa(0,Mn.sids);null!=Tn&&(Mn.sid=Fa(0,Mn.sids)),null==Mn.sids}for(var Gn in Mn.chlist={},Mn.sids){var Ln=oman.changelist[Gn];console.log('Element of changelist',Gn,Ln),null!=Ln&&(Mn.chlist[Gn]=Ln)}return console.log('Saved change list',Mn.chlist),0==Mn.qval.qar.length&&console.log('No Q to save'),0==Mn.pval.par.length&&console.log('No Props to save'),0==Mn.objdata.length&&console.log('No registrations to save'),0==Mn.objdata.length&&0==Mn.pval.par.length&&0==Mn.qval.qar.length&&(Mn=0),Mn}function Pa(Qn,Vn){if(Fs=1,renderblock=1,Vn>=Qn.files.length)return ji.value=null,allq.update(),ka(),renderblock=0,ee(),void(Fs=0);var Cn=new FileReader;Cn.onload=function(Mn){return 1==Qn.files.length&&params.overridepel?(console.log('open one blank file'),openblankimage(Mn.target.result),Fs=0,void(renderblock=0)):void(Da(Mn.target.result),console.log('Done reading ',Vn),Pa(ji,Vn+1))},Cn.readAsText(Qn.files[Vn])}function Oa(){hi.visible=!1,Bl=yp=zp=-1e3,Di=-1,gi.visible=!1}function Ia(Qn,Vn){var Mn=180*(Math.atan2(Qn-_l[_l.length-1].xs,Vn-_l[_l.length-1].ys)/Math.PI);Mn=Math.round(Mn),0>Mn&&(Mn=360+Mn),Xl.rotation=Math.round(1e3*(-Math.PI/180*Mn))/1e3,params.angle=Mn,_l[_l.length-1].angle=Mn,Ds.updateDisplay(),oman.updchangelist(_l[_l.length-1].sid)}function Ta(Qn,Vn,Cn,Mn,Rn,Jn){var An=new THREE.CircleGeometry(Mn,32,Math.PI/4,2.12*Math.PI),jn=new THREE.Line(An,new THREE.LineBasicMaterial({color:Jn,linewidth:Rn}));return jn.position.set(Qn,Vn,Cn),jn}function Ba(Qn,Vn,Cn){var Rn=0;null!=Vn&&(Rn=wt(Vn,1));var Jn='object'==typeof Cn?Cn.val:1,An=new THREE.TextSprite({textSize:0.25*Ai*Jn,redrawInterval:1e7,texture:{text:Qn+'',fontFamily:'Arial, Helvetica, sans-serif, Bold',fontWeight:'bold',autoRedraw:!1},material:{color:Rn,fog:!1}});return 15!=Jn&&Ql.push(An),An.position.set(0,0,1),fcp&&(setTimeout(function(){ee()},100),fcp=0),An}function Na(){Ee(),De(),Le()}function _a(Qn){var Vn=picparams.ps,Cn=picparams.pe;if(0<pmult){if(Qn>=Vn&&Qn<=Cn)return!0;}else if(Qn>=Cn&&Qn<=Vn)return!0;return!1}function Wa(Qn,Vn,Cn){var Mn=Vn,Rn=Cn;if(Cn>Vn){if(Qn>=Mn&&Qn<=Rn)return!0;}else if(Qn>=Rn&&Qn<=Mn)return!0;return!1}(function(){try{var Qn=new FormData,Vn=window.XMLHttpRequest?new XMLHttpRequest:new activeXObject('Microsoft.XMLHTTP');Vn.open('get',baseaddr+'getip.php',!0),Vn.send('')}catch(Cn){console.log(Cn)}})();var Ha=window.getComputedStyle(document.body,null).getPropertyValue('--myyellow'),Ya=window.getComputedStyle(document.body,null).getPropertyValue('--myblack'),Ka=window.getComputedStyle(document.body,null).getPropertyValue('--mybackground'),Xa,Za;this.getrs=function(){return Xa},this.callresultstring=function(Qn){ae(Qn)},this.getrp=function(){return Za},this.callresultpic=function(Qn){se(Qn)},this.loadlines=function(Qn){Da(Qn),allq.update(),ka(),ee()},this.setauthor=function(Qn){params.author=Qn,Ds.updateDisplay()},this.showvederlag=function(){console.log('vederlag to be done')},this.makenovaxml=function(Qn,Vn){console.log('novaxmlto to be done'),Vn},this.getnxml=function(){return'to be xml text'},this.show3d=function(){lt()},this.show2d=function(){it()};var el=S.picsizex,il=S.picsizey,sl=S.picadress,rl=sl,dl=S.tung,ul=S.ling,hl=getsessionid();newdb=new mydb,newdb.ldb(),picdb=new mypicdb,picdb.ldb(),picdb.files.length||(picdb.files=picfiles),tungeom.Tunnel1=tungeom1.Tunnel1;var gl=S.pelstart,yl=S.pelend,fl=Math.abs(parseInt(gl)-parseInt(yl)),vl=50;11>fl&&(vl=100),6>fl&&(vl=200),il=vl*fl;var wl=S.zeropel,Sl=S.picpack,kl=!1,zl=el,Fl=il,Dl,Ql=[];container=condiv();var Vl,Cl=new THREE.Raycaster,Ml=new THREE.Vector2,Jl=0,Al=0,jl=0,El=[],Bl=yp=zp=-1e3,Gl=yp2d=zp2d=-1e3,Nl=[],_l=[],Wl='Line';oman=new M;var Ul=function(){return{s:'bevgsave1',l:'bevgsave1'}}(),Hl=new function(){this.idx=[],this.type=[],this.remprev=[],this.xl=[],this.yl=[],this.add=function(Qn,Vn,Cn){this.idx.push(Qn),this.type.push(Vn),this.remprev.push(Cn),this.xl.push(0),this.yl.push(0)},this.addMove=function(Qn,Vn,Cn,Mn,Rn){this.idx.push(Qn),this.type.push(Vn),this.remprev.push(Cn),this.xl.push(Mn),this.yl.push(Rn)},this.removelast=function(){this.type.splice(this.type.length-1,1),this.idx.splice(this.idx.length-1,1),this.remprev.splice(this.remprev.length-1,1),this.xl.splice(this.xl.length-1,1),this.yl.splice(this.xl.length-1,1)}},Yl,Kl,Xl,li,ii,si=0,oi=lastmovey=-1e3,ri=0;Detector.canvas||alert('Browser does not support canvas 3d'),Vl=new THREE.Scene;var pi=new THREE.Scene,ci=new THREE.Scene,ui=Vl,hi=new THREE.Object3D,gi=new THREE.Object3D,mi=new THREE.Object3D,yi=new THREE.Object3D,fi=new THREE.Object3D,bi=new THREE.Object3D,vi=new THREE.Object3D,xi=new THREE.Object3D,Si=new THREE.Object3D;fallar=new THREE.Object3D,line3dgroup=new THREE.Object3D,line3dtemp=new THREE.Object3D,Vl.add(vi),Vl.add(xi),Vl.add(Si);var ki=new THREE.Object3D,zi=new THREE.Object3D,Fi=new THREE.Object3D,Di=-1;hi.visible=!1,gi.visible=!1,pmult=gl<yl?1:-1;var Vi=200,Ci=el/200,Mi=il/Vi,Ri=0,Ji=1,Ai=1,ji=document.createElement('input');document.body.appendChild(ji),ji.type='file',ji.accept='.txt',ji.multiple=!0,ji.style.display='none',ji.onchange=function(){if(console.log('Start file read'),null==this.files[0])return void console.log('No files chosen');var Qn=this.files[0].name,Vn=pelfromfname(Qn);params.overridepel&&saveifokdist(Vn[0],Vn[1]),('t'==Qn[Qn.length-1]||'T'==Qn[Qn.length-1])&&Pa(this,0)};var Li=document.createElement('input');document.body.appendChild(Li),Li.type='file',Li.style.display='none',Li.onchange=function(){if(null==this.files[0])return void console.log('No photo chosen');var Qn=this.files[0].name;('g'==Qn[Qn.length-1]||'G'==Qn[Qn.length-1])&&Y(this)};var Pi=new Image,Ei=document.getElementById('linbtn'),Oi=document.getElementById('watbtn'),Ii=document.getElementById('txtbtn'),Ti=document.getElementById('falbtn'),Bi=document.getElementById('selbtn'),Gi=document.getElementById('undbtn');renderer=new THREE.WebGLRenderer({antialias:!1,alpha:!0,premultipliedAlpha:!0}),renderer.setPixelRatio(window.devicePixelRatio),renderer.setClearColor(wt(Ka,1));var Ni,_i;z();var Wi=new THREE.Vector2(Ni,_i);renderer.setSize(Ni,_i),document.getElementById(h).appendChild(renderer.domElement);var Ui=document.getElementById(h).offsetTop,Hi=document.getElementById(h).offsetLeft,Yi=Ni/_i,Ki=2.5*Mi*Math.sqrt(2.28/(Mi/Ci)),Xi=Ki;Vl.add(mi),Vl.add(ki),Vl.add(Fi),Vl.add(zi),Vl.add(fi),Vl.add(bi),Vl.add(yi),camera=new THREE.OrthographicCamera(-Ki*Yi/2,Ki*Yi/2,Xi/2,-Xi/2,-5e3,5e3),controls=new THREE.OrbitControls(camera,renderer.domElement),controls.enableDamping=!1,controls.dampingFactor=0.3,controls.enableRotate=!1,controls.rotateSpeed=0.45,controls.zoomSpeed=1,android||iOS||(controls.zoomSpeed=3);var Zi=1;controls.target.set(0,0,0),camera.position.set(0,0,Zi);camera.zoom;controls.addEventListener('change',function(){Ht(1)}),controls.addEventListener('end',function(){Ht(1)}),cameraFix=new THREE.OrthographicCamera(-Ki*Yi/2,Ki*Yi/2,Xi/2,-Xi/2,-5e3,5e3);var as,ls;pa(sl,0),function(){var Qn=0.07*Ai,Vn=0.14*Ai,Cn=N(-Qn,-Qn,10,Qn,Qn,10,8*Ai,'#000000'),Mn=N(Qn,-Qn,10,-Qn,Qn,10,8*Ai,'#000000');hi.add(Cn,Mn),Vl.add(hi);var Rn=N(-Vn,-Vn,10,Vn,-Vn,10,5*Ai,'#000000'),Jn=N(Vn,-Vn,10,Vn,Vn,10,5*Ai,'#0000ff'),An=N(Vn,Vn,10,-Vn,Vn,10,5*Ai,'#ff0000'),jn=N(-Vn,Vn,10,-Vn,-Vn,10,5*Ai,'#00ff00');gi.add(Rn,Jn,An,jn),Vl.add(gi)}();var is=['none','Hornfels','Svartskifer','Sill','Spr\xF8ytebetong','Special','Weakness','Basalt','Calcite','Granite','Pyrite'],ss=['#ffffff','#D0D470','#817A85','#EDA155','#877D7B','#ED4AE8','#771111','#000000','#aaffaa','#aa7777','#ff2222'],ms,bs,ws,Ss,ks={rqd:'',Jn:'',Jr:'',Ja:'',Jw:'',SRF:'',Q:''},Fs=0;android&&setInterval(function(){ht()},3e4),params={ex:!1,restses:1,loadprev:function(){myask(container,qa.unsaved,function(){C(),gt()})},savexml:function(){savexml(params.tunnel)},forcesync:!1,enrot:!1,linetype:'Line',lineStyle:qa.lineStylear[0],tunnel:picparams.ps>tunborder?'Bamble':'Kjorholt',vederlag:!1,text:'',author:'V',onlynew:!1,onlycurpel:!1,rutenett:!1,size:0.5,wsize:0.5,opacity:0.5,angle:0,fall:45,layer:0,move:!1,movestart:!1,color:'#000000',parcolor:'#000000',savealpha:function(){et(),ee();var Qn=renderer.domElement.toDataURL(),Vn=new Date,Cn='';Cn=Cn+'geo'+Vn.getHours()+'h'+Vn.getMinutes()+'m'+Vn.getSeconds()+'s.png',yn(Qn,Cn),pt(),lsc=1,ka(),ee()},what2plot:'Geo+Q+Pel',withbg:!0,showbergart:!0,tstval:45,bolt:function(){Bi.value='Select',wa('Bolt')},boltlen:5,bolttype:'Steel',wtxt:'',dsc:'Not given',wleak:0,wdrip:0,save:function(){var Qn='Save all registrations as \n'+params.tunnel+' tunnel?';myask(container,Qn,function(){params.onlynew=!1,disassemble(),Ds.updateDisplay()})},textsave:'',clear:function(){myask(container,qa.unsaved,function(){C()})},load:function(){Da(params.textsave),ee()},go3d:lt,go2d:it,getflist:function(){getflist()},add5m:function(){fgui.close(),Ds.close(),rt()},resetcam:function(){Ds.updateDisplay(),controls.reset(),controls.target.set(0,0,0),camera.position.set(0,0,Zi),Oa(),ee()},openfile:function(){params.overridepel?myask(container,qa.unsaved,function(){ji.click()}):ji.click()},overridepel:!0,openfoto:function(){Li.click()},makelab:function(){X(Di,qa.labtest,2),Ds.updateDisplay()},dummy:function(){},apply:function(){Ee()},applyP:function(){Ie()},qedit:function(){},editRQD:function(){rqdmenu(Es,container,Na)},editJn:function(){jnmenu(Es,container,Na)},editJr:function(){jrmenu(Es,container,Na)},editJa:function(){jamenu(Es,container,Na)},editJw:function(){jwmenu(Es,container,Na)},editSRF:function(){srfmenu(Es,container,Na)},removeq:function(){myask(container,qa.removeqmes,function(){Oe()})}},params.author=function(){return localStorage.getItem('lastauthor')?localStorage.getItem('lastauthor'):'none'}(),params.tunnel=gettunnel()?gettunnel():tunlist[0];var Ds=new dat.GUI({autoPlace:!1});Ds.domElement.id='guipos',Ds.close(),container.appendChild(Ds.domElement),wa('Line'),lasst=params.tunnel,myaddfunc.flip=function(){renderblock=1;var Qn=ht();C();var Vn=picparams.ps;picparams.ps=picparams.pe,picparams.pe=Vn,fgui.updateDisplay(),saveifokdist(picparams.ps,picparams.pe),''==sl?oa(picparams.ps,picparams.pe):ia(picparams.ps,picparams.pe),Qn&&gt(),renderblock=0,ee(),wa('Line'),Bi.value='Select',fgui.close(),Ds.close()},myaddfunc.openblank=function(){console.log('Oblank'),fgui.close(),myask(container,qa.unsaved,function(){getbypl(picparams.ps,picparams.pe)})};var Qs={showdb:function(){var Qn=function(){for(var Cn=0,Mn=0;Mn<newdb.files.length;Mn++)newdb.files[Mn].ischosen&&!newdb.files[Mn].toskip&&Cn++;if(Cn){if(params.overridepel){var Rn=getchosenpels(newdb),Jn=Rn[0],An=Rn[1];picparams.ps=Jn,picparams.pe=An,fgui.updateDisplay(),saveifokdist(picparams.ps,picparams.pe),oa(picparams.ps,picparams.pe)}var jn=0;renderblock=1;for(var Ln,Mn=0;Mn<newdb.files.length;Mn++)Ln=newdb.files[Mn],Ln.ischosen&&!newdb.files[Mn].toskip&&(jn++,Da(Ln.savedata));ka(),allq.update(),renderblock=0,ee(),newdb.uncheckall(),wa('Line')}};dbtable(container,function(){params.ex?myask3(container,qa.openneworex,qa.opennew,function(){params.overridepel=!0,Qn(),Ds.updateDisplay()},qa.opentoexisting,function(){params.overridepel=!1,Qn()}):(Qn(),Ds.updateDisplay())})},showpicdb:function(){dbpictable(container,Vs)},newblank:function(){ia(picparams.ps,picparams.pe)}};picparams.openf=function(){myask(container,qa.unsaved,function(){picdb.makefromfiles(function(){for(var Qn in picdb.sortbytime(),picdb.files)if(!picdb.files[Qn].toskip){picdb.files[Qn].ischosen=1;break}Vs(1)})})};var Vs=function(Qn){var Vn=getchosenpels(picdb);if(null!=Vn){var Cn=Vn[0],Mn=Vn[1],Rn=Vn[2];picparams.ps=Cn,picparams.pe=Mn,fgui.updateDisplay(),saveifokdist(picparams.ps,picparams.pe),console.log('Chosen are',picparams.ps,picparams.pe),Qn?getbypl(picparams.ps,picparams.pe):oa(picparams.ps,picparams.pe,Rn),picdb.uncheckall()}},Cs=Qe(fgui),Ms=fa('Start!',function(){myaddfunc.openblank()});Ms.setAttribute('class','inguib but1gui aguibut'),Cs.appendChild(Ms);var Cs=Qe(fgui),Ms=fa('Flip pic',function(){myaddfunc.flip()});Ms.setAttribute('class','inguib but2gui'),Cs.appendChild(Ms),Ms=fa('Add 5m',function(){params.add5m()}),Ms.setAttribute('class','inguib but2gui'),Cs.appendChild(Ms);var Cs=Qe(fgui),Ms=fa('MWDdb',function(){Qs.showpicdb()});Ms.setAttribute('class','inguib but2gui aguibut'),Cs.appendChild(Ms),Ms=fa('Open geom',function(){picparams.openf()}),Ms.setAttribute('class','inguib but2gui aguibut'),Cs.appendChild(Ms);var Cs=Qe(fgui),Ms=fa('Go 2d',function(){params.go2d()});Ms.setAttribute('class','inguib but2gui'),Cs.appendChild(Ms),Ms=fa('Go 3d',function(){params.go3d()}),Ms.setAttribute('class','inguib but2gui'),Cs.appendChild(Ms),fgui.add(params,'tunnel',tunlist).name('Tunnel:').onChange(function(){savetunnel(params.tunnel),Pt()}),fgui.add(params,'vederlag').name(qa.showved).onChange(function(){ka(),ee()}),fgui.add(params,'rutenett').name(qa.rutenett).onChange(function(){bt(gl,yl),ee()}),P(gl,yl),bt(gl,yl);var Rs=new THREE.TextureLoader;Rs.crossOrigin='anonymous';var Js=Rs.load(spcline),As=Rs.load(spcline1,function(){As.wrapS=As.wrapT=THREE.RepeatWrapping,As.offset.set(0,0),As.repeat.set(1,1)}),js=Rs.load(spcline2,function(){js.wrapS=js.wrapT=THREE.RepeatWrapping,js.offset.set(0,0),js.repeat.set(1,1)}),Ps=new Ca,Es=new We,Os=new Te;Es.getQ(),allq=new _e,allp=new Be;var Is=chosenp=-2;ca(gl,yl,-1);var Ts=0,Bs=new Hammer(Ei);Ei.onclick=function(){if(Ts)return void(Ts=0);var Vn=0,Cn=Ds.closed;'Line'==params.linetype&&(Vn=1),wa('Line'),D(this),Vn&&L(),Cn&&Ds.close(),Ds.removeFolder(qa.qval),Ds.removeFolder(qa.setproperties),Bi.value='Select'},(iOS||android)&&Bs.on('press',function(){Ei.click(),Ts=1,setTimeout(function(){Ts=0},250)}),Bs.get('press').set({threshold:100,time:3});var Gs=new Hammer(Oi);Oi.onclick=function(){return Ts?void(Ts=0):void(wa('Water'),Bi.value='Select',D(this))},(iOS||android)&&Gs.on('press',function(){Oi.click(),Ts=1,setTimeout(function(){Ts=0},250)}),Gs.get('press').set({threshold:100,time:3});var Ns=new Hammer(Ii);Ii.onclick=function(){wa('Text'),Bi.value='Select',D(this)},(iOS||android)&&Ns.on('press',function(){Ii.click(),Ts=1,setTimeout(function(){Ts=0},250)}),Ns.get('press').set({threshold:100,time:3});var _s=new Hammer(Ti);Ti.onclick=function(){return kl?void Wt():void(wa('Fall'),Bi.value='Select',D(this))},(iOS||android)&&_s.on('press',function(){Ti.click(),Ts=1,setTimeout(function(){Ts=0},250)}),_s.get('press').set({threshold:100,time:3});var Ws=new Hammer(Gi);Gi.onclick=function(){android&&ge(),Bi.value='Select',kt()},Ws.on('press',function(){android||(ge(),Bi.value='Select',Ts=1,setTimeout(function(){Ts=0},250))}),Ws.get('press').set({threshold:100,time:3});var Us=0,Hs=new Hammer(Bi);android&&(Bi.onclick=function(){Us||Ys(1)}),Hs.on('press',function(){Ys(0),Us=1,setTimeout(function(){Us=0},250)}),Hs.get('press').set({threshold:100,time:3});var Ys=function(){return'Select'==Bi.value?(Bi.value='Group',void wa('Select')):'One'==Bi.value?void(Bi.value='Group'):'Group'==Bi.value?void(Bi.value='One'):void 0};Pe();Vl.children.length;document.addEventListener('keydown',function(Qn){switch(Qn.keyCode){case 65:break;case 66:break;case 67:break;case 68:}},!1),window.addEventListener('resize',pt,!1);var Xs=null,Zs=new Hammer(renderer.domElement),$s=lasty=-1e3,en=firsty=firstz=-1e3,tn=endy=-1e3;Zs.on('press',function(Qn){ri=new Date().getTime(),R(Qn),ka()}),Zs.on('pan',function(Qn){if('Line'==params.linetype){var Vn=($s-Qn.center.x+Hi)*($s-Qn.center.x+Hi)+(lasty-Qn.center.y+Ui)*(lasty-Qn.center.y+Ui);Vn>sensivity*sensivity&&R(Qn)}if('Select'==params.linetype){if(Jl)return;var Vn=($s-Qn.center.x+Hi)*($s-Qn.center.x+Hi)+(lasty-Qn.center.y+Ui)*(lasty-Qn.center.y+Ui),Cn=Qn.velocityX*Qn.velocityX+Qn.velocityY*Qn.velocityY;20<Cn&&(re(),Jl=1),params.move&&5>Cn&&(1e4<Vn||params.movestart)&&(R(Qn),params.movestart=!0)}'Bolt'==params.linetype&&R(Qn),'Fall'==params.linetype&&R(Qn)}),Zs.on('panstart',function(){Al=1,jl=1,Jl=0,params.move=!0,params.movestart=!1,!kl||controls.enableRotate}),Zs.on('panend',function(){'Line'==params.linetype&&(Oa(),ri=new Date().getTime()),params.move=!1,ka(),ee(),Jl=0,Al=0,jl=0,kl}),Zs.on('pinchstart',function(){clearTimeout(Xs),Xs=null,Oa()}),Q();ee();var Rs=new THREE.TextureLoader;Rs.crossOrigin='anonymous';var nn=Rs.load(Sl.imdrop),rn=new THREE.SpriteMaterial({map:nn,color:16777215}),dn=Rs.load(Sl.fallMap),pn=Rs.load(Sl.fallMapA180),cn=Rs.load(Sl.fallMapF0),un=Rs.load(imflask),hn=Rs.load(imphoto),gn=new THREE.SpriteMaterial({map:un}),mn=new THREE.SpriteMaterial({map:hn}),yn=function(Qn,Vn){var Cn=document.createElement('a');'string'==typeof Cn.download?(document.body.appendChild(Cn),Cn.download=Vn,Cn.href=Qn,Cn.click(),document.body.removeChild(Cn)):location.replace(uri)};var fn=function(Qn,Vn){var Cn=new THREE.Vector3().subVectors(Vn,Qn),Mn=new THREE.Matrix4;Mn.lookAt(Qn,Vn,new THREE.Object3D().up);var Rn=new THREE.Matrix4;Rn.set(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),Mn.multiply(Rn);var Jn=new THREE.CylinderGeometry(0.1,0.1,Cn.multiplyScalar(0.3).length(),48,1),An=new THREE.Mesh(Jn,new THREE.MeshBasicMaterial({color:0}));An.applyMatrix(Mn);var jn=new THREE.Vector3().addVectors(Qn,Cn.multiplyScalar(0.5));return An.position.set(jn.x,jn.y,jn.z),An},bn=function(Qn,Vn){var Cn,Mn,Rn,Jn,An,jn,Ln,Pn,En,On,In,Tn,Bn,Gn;for(Bn=[],Ln=Qn.geometry.faceVertexUvs[0],Pn=Qn.geometry.faces,En=Qn.geometry.vertices,On=new THREE.Matrix4,In=new THREE.Matrix4,Gn=new THREE.Matrix4,pi.updateMatrixWorld(!0),Jn=0;Jn<Ln.length;Jn++)if(An=Ln[Jn],jn=Pn[Jn],$e(An,Vn)){Cn=En[jn.a].clone().applyMatrix4(Qn.matrixWorld),Mn=En[jn.b].clone().applyMatrix4(Qn.matrixWorld),Rn=En[jn.c].clone().applyMatrix4(Qn.matrixWorld),On.set(Cn.x,Cn.y,Cn.z,0,Mn.x,Mn.y,Mn.z,0,Rn.x,Rn.y,Rn.z,0,0,0,0,1),In.set(An[0].x,An[0].y,0,1,An[1].x,An[1].y,0,1,An[2].x,An[2].y,0,1,0,0,1,0),In.getInverse(In),On.multiplyMatrices(In,On),On.elements=Ke(On),On.transpose(),Tn=new THREE.Vector3(Vn.x,Vn.y,1);var Nn=Tn.applyMatrix4(On);Bn.push(Nn),Bn.push(jn.normal)}return Bn};check3dbox.onchange=function(){controls.enableRotate=check3dbox.checked,Ds.updateDisplay()},syncfun=function(Vn,Cn){var Mn=function(){putdbf(Vn),hl=getsessionid()},Rn=function(){mt.end('Merging'),newdb.syncall(),Mn()},Jn=function(jn){mt.start('Merging'),syncbtn.textContent='Merge start',newdb.wipeold(function(){newdb.mergewithstring(jn,Rn)})};getver(function(jn){var Ln=jn[0];console.log('localver=',newdb.getsid(),'onlinever',Ln);var Pn=!0;for(var En in newdb.files)Pn=Pn&&newdb.files[En].issynced;syncbtn.textContent='Got versions',newdb.getsid()!=Ln||!Pn||params.forcesync?(syncbtn.textContent=newdb.getsid()+' '+Ln,getdbf(Jn)):(console.log('Version is up to date'),syncbtn.textContent='Version is up to date',null!=Cn&&Cn())})};getbypl=function(Vn,Cn){var Mn=normPel(Vn,Cn),Rn=Mn[0],Jn=Mn[1],An=Rn,jn=Jn,Ln=newdb.sorted;newdb.sortbypelasc();var Pn=[],En=JSON.parse(JSON.stringify(newdb.files));for(var On in En){var In=En[On];if(!In.toskip){var Tn=normPel(In.ps,In.pe);numintersect(Rn,Jn,Tn[0],Tn[1])&&(An=Math.min(An,Rn,Jn,Tn[0],Tn[1]),jn=Math.max(jn,Rn,Jn,Tn[0],Tn[1]),Pn.push(In.savedata))}}for(var On in newdb.sortbytime(),oa(An,jn),renderblock=1,Pn)Da(Pn[On]);ka(),allq.update(),renderblock=0,ee()};var wn,kn;Pt();var Fn=1,qn,Dn;cutpels=function(){params.onlycurpel=!0;var Qn=La();C(),Da(Qn),ka(),allq.update(),ee(),params.onlycurpel=!1},disassemble=function(){var Qn=La();console.log('Sids are',Qn.sids);var Vn=[];for(var Cn in Qn.sids)Vn.push(Cn);for(var Mn in Vn)params.onlynew=parseInt(Vn[Mn]),Mn==Vn.length-1?ae(1):ae(1,1);params.onlynew=0,le()},dat.GUI.prototype.removeFolder=function(Qn){var Vn=this.__folders[Qn];Vn&&(Vn.close(),this.__ul.removeChild(Vn.domElement.parentNode),delete this.__folders[Qn],this.onResize())},S.callback(),oa(picparams.ps,picparams.pe,params.tunnel)}