function bevgeoplot(h,S){function z(){ii=document.getElementById(h).offsetWidth,oi=document.getElementById(h).offsetHeight}function F(An){var Ln=An.add(bf,'blank').name('').__li;Ln.setAttribute('class','cr function mydum')}function D(){}function V(){rn.get('tap').set({threshold:1,posThreshold:1,time:1,interval:2}),rn.get('press').set({threshold:50,time:3}),rn.get('pan').set({threshold:sensivity,time:4,direction:Hammer.DIRECTION_ALL}),rn.get('pinch').set({enable:!0})}function Q(An,Ln){var Pn=null==Ln?Jl:Ln;if(null==An)return console.log('Null object!'),null;for(var En,Tn=0;Tn<Pn.children.length;Tn++)if(Pn.children[Tn].uuid==An){En=Pn.children[Tn];break}return En}function M(){line3dtemp.children.length=0,line3dgroup.children.length=0,fallar.children.length=0,Ds.visible=!1,Wl=yp=zp=-1e3,un=-1e3,renderblock=1;for(var An=0;An<oman.ao.length;An++)oman.removefromscene(oman.get(An));Xl=[],oman=new C,ga(),allp=new Ge,allq=new We,Qa(),allq.update(),renderblock=0,ae()}function C(){this.ao=Xl,this.history=[],this.sid=wl,this.so=null,this.sp=null,this.selidx=null,this.changelist={},this.updchangelist=function(An){this.changelist[An]=wl},this.select=function(An,Ln){this.so=null,this.sp=null,this.selidx=null;var Pn=be(An,Ln);if(Pn[3]>Math.sqrt(_s*_s+Ns*Ns)/7)return console.log('Nothing selected'),[null,null];var En=Pn[0];return this.selidx=En,this.so=this.get(En),this.so||console.log('No object selected'),this.sp=allp.par[je(En)],this.sp||console.log('No property selected'),Vs.visible=!!this.so,[this.so,this.sp]},this.get=function(An){var Ln=this.ao[An];return null==Ln?(console.log('No object ',An),null):Ln},this.add=function(An){this.ao.push(An)},this.undo=function(){var An=this.history.pop();return An?void('add'==An[0]&&(this.removefromscene(An[1]),this.history.pop()),'remove'==An[0]&&(this.plot(An[1]),this.history.pop()),'removeSequence'==An[0]&&(this.plot(An[1]),this.history.pop(),'removeSequence'==this.history[this.history.length-1][0]&&this.undo()),'movefrom'==An[0]&&this.move(An[1],An[2],An[3]),Qa(),ae()):void console.log('No history elements')},this.move=function(An,Ln,Pn){if(null==An)return void console.log('Trying to move null object');var En=Q(An.id,'B'==An.type?Rs:null);if(En){var Tn=Ln-An.xs,On=Pn-An.ys;En.position.x+=Tn,En.position.y+=On,params.movestart||this.history.push(['movefrom',An,An.xs,An.ys]),An.xs=Ln,An.ys=Pn,Vs.visible=!0,Vs.position.set(Ln,Pn,10),this.updchangelist(An.sid)}},this.erasefromhistory=function(An){for(var Ln=0;Ln<this.history.length;Ln)this.history[Ln][1].sameas(An)?this.history.splice(Ln,1):Ln++},this.removefromscene=function(An,Ln){if(1==An.skip)return!1;if('L'==An.type)return An.skip=1,Ln?this.history.push(['removeSequence',An]):this.history.push(['remove',An]),renderblock||this.updchangelist(An.sid),!0;var Pn=Q(An.id,'B'==An.type?Rs:null);return null==Pn?(console.log('No such object on scene',An),!1):('B'==An.type?Rs.remove(Pn):Jl.remove(Pn),this.history.push(['remove',An]),ae(),An.skip=1,renderblock||this.updchangelist(An.sid),!0)},this.isdublicate=function(An){for(var Pn,Ln=0;Ln<this.ao.length;Ln++)Pn=this.get(Ln),Pn.sameas(An)&&(this.removefromscene(Pn),this.erasefromhistory(An))},this.plot=function(An){if('L'==An.type)return An.skip=0,void this.history.push(['add',An]);var Ln;'W'==An.type&&(Ln=H(An.xs,An.ys,An.zs,An.size)),'F'==An.type&&(Ln=ee(An.xs,An.ys,An.zs,An.angle,An.fall,An.size),''!=An.color&&Gt(An.color)),'T'==An.type&&(Ln=X(An.text,An.xs,An.ys,An.zs,1- -An.fall)),'B'==An.type&&(Ln=O(An.xs,An.ys,An.zs,An.xe,An.ye,An.ze),ds=[Ln,An],Rs.add(Ln));Ln&&(Ln.name=Xl.length,An.id=Ln.uuid,An.skip=0,this.history.push(['add',An]),'B'!=An.type&&Jl.add(Ln),ae())}}function R(An){!0==controls.enableRotate||((!params.move||'Line'==params.linetype)&&(dn=An.center.x-pi,lasty=An.center.y-di),Al.x=2*((An.center.x-pi)/ii)-1,Al.y=2*-((An.center.y-di)/oi)+1,Ql?J():L())}function J(){fcp=1,jl.setFromCamera(Al,camera);var An=jl.intersectObjects(meshes.children);if(0<An.length){var Ln=new Aa;Ln.sid=wl;var Pn=mr(Wl),En=mr(yp),Tn=mr(zp),On=mr(Ul),In=mr(yp2d),Bn=mr(An[0].point.x),Gn=mr(An[0].point.y),Nn=mr(An[0].point.z),_n=mr(2*(An[0].uv.x-0.5)*Ns),Wn=mr(2*(An[0].uv.y-0.5)*_s);if(-1e3<Wl){var Un=params.lineStyle==qa.lineStylear[0]?0:params.lineStyle==qa.lineStylear[1]?1:params.lineStyle==qa.lineStylear[2]?2:3,Hn=Un+params.color,Xn=_(Pn,En,Tn,Bn,Gn,Nn,Math.round(40*params.size),params.color);if(2==An.length){var Yn=mr(2*(An[1].uv.x-0.5)*Ns),Kn=mr(2*(An[1].uv.y-0.5)*_s),Zn={xs:Yn,ys:Kn,v:new THREE.Vector3(An[1].point.x,An[1].point.y,An[1].point.z)};linez.push(Zn)}var Zn={xs:On,ys:In,v:new THREE.Vector3(Pn,En,Tn)};linez.push(Zn),line3dtemp.add(Xn)}Wl=Bn,yp=Gn,zp=Nn,Ul=_n,yp2d=Wn,zp2d=Nn}ae()}function A(An){return params.linemagnet?0.3>Math.abs(An-Ns)?Ns:0.3>Math.abs(An+Ns)?-Ns:An:An}function L(){fcp=1,jl.setFromCamera(Al,camera);var An=jl.intersectObjects(Hl);if(0<An.length){var Ln=new Aa;Ln.sid=wl;var Pn=mr(Wl),En=mr(yp),Tn=mr(zp),On=mr(An[0].point.x),In=mr(An[0].point.y),Bn=mr(An[0].point.z);if(!Ql&&!params.move&&On<-Ns&&'Select'==params.linetype)return Le(In),Pe(),void ae();if('Line'==params.linetype&&On>=-Ns){if(Pn=A(Pn),On=A(On),-1e3<Wl){Ds.visible=!0,Ds.position.set(On,In,10);var Gn=params.lineStyle==qa.lineStylear[0]?0:params.lineStyle==qa.lineStylear[1]?1:params.lineStyle==qa.lineStylear[2]?2:3,Nn=Gn+params.color,_n=_(Pn,En,Tn,On,In,Bn+params.layer+1,Math.round(30*params.size),params.color);_n.name=Xl.length,Ln.addline(Pn,En,Tn,On,In,Bn+params.layer+1,Math.round(30*params.size),Nn),oman.plot(Ln),oman.add(Ln),Ms.add(_n),un=On,endy=In}else cn=On,firsty=In,firstz=Bn;Ds.visible=!0,Ds.position.set(On,In,10),Wl=On,yp=In,zp=Bn+params.layer+1}if('Bolt'==params.linetype&&On>=-Ns)if(!El)Ln.addbolt(On,In,Bn+7,On,In,Bn+7,params.bolttype),oman.plot(Ln),oman.add(Ln);else{G(On,In,Bn+7);var Wn=oman.get(Xl.length-1);Wn.xe=$l.vertices[1].x,Wn.ye=$l.vertices[1].y,Wn.ze=$l.vertices[1].z}if('Fall'==params.linetype&&On>=-Ns&&(Tl?0!=params.fall&&_a(On,In,Bn+7):(Ln.addfall(On,In,Bn+7,params.angle,params.fall,kl<Sl),oman.plot(Ln),oman.add(Ln))),'Water'==params.linetype&&On>=-Ns&&(Ln.addwater(On,In,Bn+7,Math.round(10*params.wsize)/10),oman.plot(Ln),oman.add(Ln)),'Text'==params.linetype&&On>=-Ns&&''!=params.text&&(Ln.addtext(params.text,On,In,Bn+params.layer+1),oman.plot(Ln),oman.add(Ln)),'Select'==params.linetype&&On>=-Ns)if(!params.move){oman.select(On,In);var Un=be(On,In);if(Un[3]>Math.sqrt(_s*_s+Ns*Ns)/7)return;Vs.visible=!0,Vs.position.set(Un[1],Un[2],10),Is=Un[0],Je(Is)}else if(oman.so){var Hn=On-0.1*Ns/camera.zoom,Xn=In+0.1*_s/camera.zoom;oman.move(oman.get(Is),Hn,Xn)}}else'Select'==params.linetype?params.move&&de():(Na(),Vs.visible=!1);ae()}function P(){if(-1e3<un){var An=new Aa;An.sid=wl;var Ln=params.lineStyle==qa.lineStylear[0]?0:params.lineStyle==qa.lineStylear[1]?1:params.lineStyle==qa.lineStylear[2]?2:3;if(0<Ln)return void(un=endy=cn=firsty=firstz=-1e3);var Pn=Ln+params.color;An.addline(un,endy,firstz+params.layer+1,cn,firsty,firstz+params.layer+1,Math.round(30*params.size),Pn),oman.plot(An),oman.add(An),un=endy=cn=firsty=firstz=-1e3,Qa(),ae()}}function E(An,Ln,Pn){Jl.remove(Js);var En=6,Tn=0.1*Hs;Js=new THREE.Object3D;var On=-_s,In=_s,Bn=_(1.13*Ns,On,0,1.13*Ns,In,0,10,$a);Js.add(Bn);var Gn={val:15},Nn=X(An,1.13*Ns+0.11*Ns,On+Tn,0,0,$a);Js.add(Nn);var _n=_(1.13*Ns,On,0,1.067*Ns,On,0,En,$a);Js.add(_n);var Wn=_(1.13*-Ns,On,10,1.067*-Ns,On,10,En,$a);Js.add(Wn);var Un=X(Ln,1.13*Ns+0.11*Ns,In-Tn,0,0,$a);Js.add(Un);var Hn=_(1.13*Ns,In,0,1.067*Ns,In,0,En,$a),Xn=_(1.13*-Ns,In,10,1.067*-Ns,In,10,En,$a);Js.add(Hn),Js.add(Xn);for(var Yn=1;Yn<pmult*(Ln-An)/5;++Yn){var Kn=-_s+5*(pmult*Yn*(In-On))/(Ln-An),Zn=_(1.13*Ns,Kn,0,1.067*Ns,Kn,0,En,$a),$n=_(1.13*-Ns,Kn,10,1.067*-Ns,Kn,10,En,$a),eo=5*pmult*Yn+parseInt(An),to=X(eo,1.13*Ns+0.11*Ns,Kn,0,0,$a);Js.add(Zn),Js.add(to),Js.add($n)}var ao=normPel(An,Ln);if(100<ao[1]-ao[0])for(var Yn=ao[0]-1;Yn<=ao[1];Yn++)if(0==Yn%100){fcp=1;var lo=X(Yn,4*Ns,La(Yn),Gn,0,$a);Js.add(lo),fcp=0}if(null!=Pn){Js.position.set(0,Pn,0)}Jl.add(Js)}function O(An,Ln,Pn,En,Tn,On){var In=new THREE.Object3D,Bn=0.07,Gn=_(An+Bn,Ln+Bn,Pn,An-Bn,Ln-Bn,Pn-0.01,2,'#000000'),Nn=_(An-Bn,Ln+Bn,Pn,An+Bn,Ln-Bn,Pn-0.01,2,'#000000'),_n=Wa(An,Ln,Pn,2*(Bn/Math.sqrt(2)),2,'#000000');return us=B(An,Ln,Pn,En,Tn,On,1,'#000000'),In.add(Gn),In.add(Nn),In.add(_n),In.add(us),In}function I(){return 1/2e3}function B(An,Ln,Pn,En,Tn,On,In,Bn){$l=new THREE.Geometry,es=new THREE.Vector3(An,Ln,Pn),$l.vertices.push(es),$l.vertices.push(new THREE.Vector3(En,Tn,On));return N([An,Ln,Pn,En,Tn,On],10,Bn)}function G(An,Ln,Pn){var En=(es.x-An)*(es.x-An)+(es.y-Ln)*(es.y-Ln),Tn=2*(Fl/Gs),On=params.boltlen*Math.sin(Math.PI/24);if(En=Math.sqrt(En)/Tn,En<On)ds[0].remove(us),us=B(es.x,es.y,es.z,An,Ln,Pn,1,'#000000'),ds[0].add(us),ds[1].xe=An,ds[1].ye=Ln,ds[1].ze=Pn;else{var Bn,Gn;Bn=es.x+(An-es.x)/En*On,Gn=es.y+(Ln-es.y)/En*On,ds[0].remove(us),us=B(es.x,es.y,es.z,Bn,Gn,Pn,1,'#000000'),ds[0].add(us),ds[1].xe=Bn,ds[1].ye=Gn,ds[1].ze=Pn}console.log(ds[1])}function N(An,Ln,Pn,En){if(0!=An.length){var Tn=new THREE.LineGeometry;Tn.setPositions(An);var On=Pn+'',In=0;if(7<On.length&&(In=On[0],On=On.slice(1,8)),0<In){var Bn=W(An,Ln,Pn,En);return Bn}var Gn=Math.abs(Ln),Nn=Ql?5:3,_n=new THREE.LineMaterial({color:new THREE.Color(On),linewidth:Gn/3,dashed:!1}),Wn=renderer.getSize();_n.resolution.set(Wn.width,Wn.height);var Bn=new THREE.Line2(Tn,_n);return null==En&&Cs.add(Bn),Bn}}function _(An,Ln,Pn,En,Tn,On,In,Bn){var Gn=new Float32Array(6);Gn[0]=An,Gn[1]=Ln,Gn[2]=Pn,Gn[3]=En,Gn[4]=Tn,Gn[5]=On;var Nn=N(Gn,In,Bn,1);return Nn}function W(An,Ln,Pn,En){if(0!=An.length){var Tn=An.length,On=Pn+'',In=0;7<On.length&&(In=On[0],On=On.slice(1,8));for(var Bn=0,Gn=3;Gn<Tn;Gn+=3)Bn+=Math.sqrt((An[Gn]-An[Gn-3])*(An[Gn]-An[Gn-3])+(An[Gn+1]-An[Gn-2])*(An[Gn+1]-An[Gn-2]));var Nn=new Float32Array(Tn);iOS&&(Nn=new Float32Array(2*Tn-3));for(var Gn=0;Gn<An.length;Gn++)Nn[Gn]=An[Gn];if(iOS)for(var Wn,Gn=0;Gn<Tn-3;Gn+=3)Wn=2*Tn-3-Gn-3,Nn[Wn]=An[Gn],Nn[Wn+1]=An[Gn+1],Nn[Wn+2]=An[Gn+2];var Un=new THREE.Color(On),Hn=Math.abs(Ln)*I(),Xn=new MeshLineMaterial({color:Un,lineWidth:Hn*lsc,useMap:!1,transparent:!!(0>Ln),opacity:0>Ln?0.6:1,resolution:ri});if(1==In)var Xn=new MeshLineMaterial({color:Un,lineWidth:Hn*lsc,useMap:!1,useAlphaMap:1,transparent:!0,alphaMap:Ti,resolution:ri});if(2==In){var Yn=Math.round(1.5*Bn);Yn=1>Yn?1:Yn;var Xn=new MeshLineMaterial({color:Un,lineWidth:Hn*lsc,useMap:!1,useAlphaMap:1,repeat:new THREE.Vector2(Yn,1),transparent:!0,alphaMap:Oi,resolution:ri})}if(3==In){var Yn=Math.round(Bn);Un=new THREE.Color('#aaaaaa'),Yn=1>Yn?1:Yn;var Xn=new MeshLineMaterial({color:Un,lineWidth:1.5*(Hn*lsc),useMap:!0,map:Ii,useAlphaMap:1,repeat:new THREE.Vector2(Yn,1),transparent:!0,alphaMap:Ii,resolution:ri})}var Kn=new MeshLine;Kn.setGeometry(Nn);var Zn=new THREE.Mesh(Kn.geometry,Xn);return null==En&&Cs.add(Zn),Zn}}function U(An,Ln){var Pn=new THREE.Sprite;return Pn.position.set(An,Ln,2),Pn.scale.set(0.4,0.4,0.4),Pn}function H(An,Ln,Pn,En){var Tn=new THREE.Sprite(mn);return Tn.position.set(An,Ln,Pn),Tn.scale.x=Tn.scale.y=En*Hs,Tn}function X(An,Ln,Pn,En,Tn,On){var In=10,Bn=new THREE.Object3D,Gn=Ua(An,On,En);if(Gn.position.set(Ln+0.1,Pn-0.05,In/5),Bn.add(Gn),Tn){Gn.position.set(Ln+0.35,Pn-0.2,In/5);var Nn=0.07,_n=_(-Nn,-Nn,10,Nn,Nn,10,In/5,'#000000'),Wn=_(Nn,-Nn,10,-Nn,Nn,10,In/5,'#000000');_n.position.set(Ln,Pn,0),Wn.position.set(Ln,Pn,0);var Un=U(Ln+0.35,Pn+0.12);Un.visible=!1,Bn.add(_n),Bn.add(Wn),Bn.add(Un),2==Tn&&(Un.material=Sn,Un.visible=!0,console.log('photo added')),3==Tn&&(Un.material=kn,Un.visible=!0,console.log('labtest added'))}return Bn}function Y(An){var Ln=new FileReader;Ln.onloadend=function(Pn){var En=kl;Re()&&(En=Math.round(Pa(Xl[Is].ys)));var Tn=new Date,On='';On='pic_'+En+'_'+Tn.getMinutes()+'m'+Tn.getSeconds()+'s',zn(Pn.target.result,On+'.jpg'),Z(Is,On,1),Ji.updateDisplay()},Ln.readAsDataURL(An.files[0])}function Z(An,Ln,Pn){var En=Xl[An];if('T'!=Re(An))return void console.log('not T');var Tn=Jl.getObjectByName(An),On=Tn.children[0];On.redrawInterval=1,Tn.children[0].material.map.text=''+Ln,En.text=Ln,oman.updchangelist(En.sid),null!=Pn&&(1==Pn&&(En.fall=1,Tn.children[3].material=Sn),2==Pn&&(En.fall=2,Tn.children[3].material=kn),Tn.children[3].visible=1),ae(),setTimeout(function(){On.redrawInterval=1e8,ae()},1)}function $(An,Ln,Pn){var En=Xl[An];if('F'!=Re(An))return void console.log('not F');var Tn=En.size&&kl<Sl?Pn:360-Pn,On=Jl.getObjectByName(An),In=On.children[1].children[0];In.redrawInterval=1,0!=Ln&&90!=Ln&&(On.children[1].children[0].material.map.text=''+Ln),On.children[0].material.rotation=Math.round(1e3*(-Math.PI/180*Tn))/1e3,0==Ln&&(On.children[0].material.map=bn,On.children[1].children[0].material.map.text='',On.children[0].material.rotation=0),90==Ln&&(On.children[0].material.map=fn,On.children[1].children[0].material.map.text=''),0!=Ln&&90!=Ln&&(On.children[0].material.map=yn),En.fall=parseInt(Ln),En.angle=parseInt(Pn),oman.updchangelist(En.sid),ae(),setTimeout(function(){In.redrawInterval=1e8,ae()},50)}function ee(An,Ln,Pn,En,Tn,On){var In=On==kl<Sl?En:360-En,Bn='',Gn=new THREE.Object3D;if(0!=Tn&&90!=Tn){as=new THREE.SpriteMaterial({map:yn,color:16777215,rotation:-Math.PI/180*In});var Nn=new THREE.Sprite(as);Bn=Tn+''}if(0==Tn)var _n=new THREE.SpriteMaterial({map:bn,color:16777215}),Nn=new THREE.Sprite(_n);if(90==Tn){as=new THREE.SpriteMaterial({map:fn,color:16777215,rotation:-Math.PI/180*In});var Nn=new THREE.Sprite(as)}Nn.position.set(An,Ln,Pn),Nn.scale.x=Nn.scale.y=0.4*Hs;var Wn=X(Bn,An+0.25*Us,Ln-0.12*Hs,Pn,0);return Gn.add(Nn),Gn.add(Wn),Gn}function ae(An,Ln){if(!renderblock){if(mt.start('render'),null==An&&controls.update(),Ql?renderer.render(ks,camera):null==Ln?renderer.render(Jl,camera):renderer.render(Ln,camera),null==An&&(1==rendebug&&console.log('r'),2==rendebug)){var Pn=ae.caller;console.log(Pn)}mt.end('render')}}function le(An,Ln){var Pn=Ia();if(!Pn)return void console.log('Nothing to save');var En=JSON.stringify(Pn),Tn=getpelrange(En,picparams.ps,picparams.pe);params.textsave=En,Ji.updateDisplay();var On=new Date,In='',Bn=getauthorandsid(Pn);In='pel'+Tn[0]+'_'+Tn[1]+'\''+params.tunnel+'\''+Bn.author+shortsid(Bn.sid)+'.txt';var Gn={name:In,size:En.length,content:En},Nn=elemfromfile(Gn),_n=function(Xn){dbputreg(Xn,function(){null==Ln&&(newdb.ldb(),allq.update())})};console.log('Attempt to add new file to db',Nn);var Wn=newdb.comparef(Nn);if(Wn){console.log('File already exists in db',Wn);var Un=Nn.savedata,Hn=Wn.savedata;comparesave(Un,Hn)?console.log('Files are same, not saving'):(console.log('Adding because files are different'),_n(Nn))}else console.log('Adding new file to db',Nn),_n(Nn);se(An)}function se(){var Ln=Ia(1);if(!Ln)return void console.log('Nothing to save');var Pn=JSON.stringify(Ln),En=getpelrange(Pn,picparams.ps,picparams.pe);params.textsave=Pn,Ji.updateDisplay();var Tn=new Date,On='',In=getauthorandsid(Ln);On='pel'+En[0]+'_'+En[1]+'\''+params.tunnel+'\''+In.author+shortsid(In.sid)+'.txt';({name:On,size:Pn.length,content:Pn})}function oe(An,Ln){params.withbg||(Qs.visible=!1),tt();var Pn=new THREE.Scene;Pn.add(Os),ae(null,Pn),console.log('start save as image'),re(function(En){Jl.add(Os),ae(),re(An,En),Qs.visible=!0,ut(),Qa(),ae(),null!=Ln&&(params.what2plot='Geo+Q+Pel')},1)}function re(An,Ln){var Pn,Tn=window.devicePixelRatio;try{Pn=renderer.domElement.toDataURL('image/png');var In=new Image,Bn='For 3d'==params.what2plot?1:0,Gn='Only texture'==params.what2plot?1:0;In.onload=function(){var _n=document.createElement('canvas');_n.width=Gn?2*Cl:Ml,_n.height=Gn?2*Cl:Cl,_n.width*=Tn,_n.height*=Tn,_n.visible=0;var Wn=_n.getContext('2d');Wn.drawImage(In,0,0);var Un=Wn.getImageData(0,0,_n.width,_n.height),Hn=Un.data,Xn=Hn.length,Yn=[];if(null!=Ln&&!Array.isArray(Ln))for(var Kn=0;Kn<Xn;Kn+=4)if(208==Hn[Kn]&&208==Hn[Kn+1]&&208==Hn[Kn+2]);else Yn.push(Kn);if(null!=Ln&&!Array.isArray(Ln))return void An(Yn);if(!params.withbg){for(var Kn=0;Kn<Xn;Kn+=4)208==Hn[Kn]&&208==Hn[Kn+1]&&208==Hn[Kn+2]&&(Hn[Kn+3]=0);if(Array.isArray(Ln))for(var Kn=0;Kn<Ln.length;Kn++)Hn[Ln[Kn]+3]=100}console.log('done pic'),Un.data=Hn,Wn.putImageData(Un,0,0);var Zn=document.createElement('canvas');Zn.visible=0;var $n=Wn.getImageData(Cl,0,Cl+Ml,Cl);Zn.width=Cl,Zn.height=Ml;var eo=Zn.getContext('2d');if(eo.putImageData($n,0,0),Pn=Gn?Zn.toDataURL():_n.toDataURL(),yl=Pn,console.log('tmp pic saved'),void 0!==An)return rl=Pn,void An();if(!Bn){var to=new Date,ao='';ao=ao+'geo'+to.getHours()+'h'+to.getMinutes()+'m'+to.getSeconds()+'s.png',zn(Pn,ao)}},In.src=Pn}catch(_n){return void console.log(_n)}}function de(){if(!Pl){var An=Re();An&&('L'==An?myask(container,'Remove line?',function(){ue(),un=-1e3,Qa(),ae()}):(ue(),Qa(),ae()))}}function ue(){if(oman.so){allp.remove(oman.sp);var An=[];if(An=he(oman.selidx),'Group'==li.value&&1<An.length)for(var Ln=0;Ln<An.length;Ln++)oman.removefromscene(oman.get(An[Ln]),1);else oman.removefromscene(oman.so);Vs.visible=!1,oman.so=null,oman.selidx=null}}function he(An){for(var Ln=[An],Pn=An-1;0<=Pn&&1!=Xl[Pn].skip&&Xl[Pn].xe==Xl[Pn+1].xs&&Xl[Pn].ye==Xl[Pn+1].ys;Pn--)Ln.push(Pn);for(var Pn=An+1;Pn<Xl.length&&1!=Xl[Pn].skip&&Xl[Pn-1].xe==Xl[Pn].xs&&Xl[Pn-1].ye==Xl[Pn].ys;Pn++)Ln.push(Pn);return Ln.sort((En,Tn)=>En-Tn),Ln}function ge(An){var Ln=[];if(-1==An[0])return Ln;for(var En,Pn=0;Pn<An.length;Pn++)En=An[Pn],0==Pn&&(Ln.push(Xl[En].xs),Ln.push(Xl[En].ys)),Ln.push(Xl[En].xe),Ln.push(Xl[En].ye);return Ln}function me(){oman.undo(),Qa(),si.setAttribute('class','geobutton1'),setTimeout(function(){si.setAttribute('class','geobutton')},200)}function fe(){this.tunnel='',this.zeropel=0,this.pelperunit=1,this.pelstart=0,this.pelend=20,this.qval={},this.pval={},this.pw=Ns,this.author='V',this.sid=wl,this.lastchange=0,this.objdata=[]}function be(An,Ln){for(var Pn=Xl.length,En=1e3,Tn=-1,On=-20,In=-20,Bn=1,Gn=0;Gn<Pn;Gn++)if(!Xl[Gn].skip){Bn=1;var Nn=Xl[Gn].xs,_n=Xl[Gn].ys,Wn=(An-Nn)*(An-Nn)+(Ln-_n)*(Ln-_n);if('L'==Xl[Gn].type){var Un=we(Xl[Gn],An,Ln);Wn=Un[0],Nn=Un[2],_n=Un[3],(0>Un[1]||1<Un[1])&&(Bn=0)}En>=Wn&&Bn&&(En=Wn,Tn=Gn,On=Nn,In=_n)}return[Tn,On,In,Math.sqrt(En)]}function we(An,Ln,Pn){var En=An.xs,Tn=An.xe,On=An.ys,In=An.ye,Bn=Math.sqrt((Tn-En)*(Tn-En)+(In-On)*(In-On)),_n=[0,1,2,3,4],Un=((Tn-En)*(Ln-En)+(In-On)*(Pn-On))/Bn/Bn,Hn=En+Un*Bn*((Tn-En)/Bn),Xn=On+Un*Bn*((In-On)/Bn),Yn=Math.sqrt((Ln-En)*(Ln-En)+(Pn-On)*(Pn-On)),Kn=Math.sqrt((Ln-Tn)*(Ln-Tn)+(Pn-In)*(Pn-In)),Zn=Math.sqrt((Ln-Hn)*(Ln-Hn)+(Pn-Xn)*(Pn-Xn));return _n[0]=Math.sqrt((Ln-Hn)*(Ln-Hn)+(Pn-Xn)*(Pn-Xn)),ke(Un)||(_n[0]=Math.min(Yn,Kn)),_n[1]=Un,_n[2]=Hn,_n[3]=Xn,_n[4]=0,0>=(Tn-En)*(Pn-On)-(In-On)*(Ln-En)&&(_n[4]=1),_n}function ke(An){return 0<=An&&1>=An}function Se(){localStorage.setItem('lastauthor',params.author)}function qe(An){return': -1??'==An?'':An}function De(An,Ln,Pn){Ln.value=An+qe(': '+Pn),'-1??'!=Pn&&Ln.setAttribute('class','inguib aguibut')}function Ve(){De('RQD',Ci.rqd,Ni.RQD+Ni.RQDc),De('Jn',Ci.Jn,Ni.Jn+Ni.Jnc),De('Jr',Ci.Jr,Ni.Jr+Ni.Jrc),De('Ja',Ci.Ja,Ni.Ja+Ni.Jac),De('Jw',Ci.Jw,Ni.Jw+Ni.Jwc),De('SRF',Ci.SRF,Ni.SRF+Ni.SRFc),Ni.getQ(),'????'==Ni.Q+Ni.class?Ci.Q.name('Q = ?'):Ci.Q.name('Q = '+Ni.Q+Ni.class),Ji.updateDisplay()}function Qe(An,Ln){var Pn=An.add(bf,'blank').name(Ln).__li;return Pn.setAttribute('class','cr function myguibut'),null==Ln&&Pn.removeChild(Pn.children[0]),Pn}function Me(An){An.style.height='5px',An.style.height=An.scrollHeight-5+'px'}function Ce(An){for(var Ln=0;Ln<vi.length;Ln++)if(An==vi[Ln])return xi[Ln]}function Re(An){var Ln=0,Pn=Is;null!=An&&(Pn=An);Jl.getObjectByName(Pn);return null==Xl[Pn]?Ln:1==Xl[Pn].skip?Ln:Xl[Pn].type}function Je(An){var Ln=je(An);if(-3==Ln)return void console.log('Nothing selected');var Pn=Re(An);chosenp=Ln,-2==chosenp?(_i=new Be,_i.type=Pn,_i.coords=Bl,_i.isarea=Ne(Bl)):_i.restore(allp.par[chosenp]),Da('Select',Pn),Ji.updateDisplay()}function je(An){var Ln=Re(An);if(!Ln)return console.log('Nothing selected'),-3;if('L'==Ln){var Pn=he(An);Bl=ge(Pn),0==Bl.length&&console.log('No lines selected')}else Bl=[Xl[An].xs,Xl[An].ys];return allp.get(Bl)}function Ae(An){for(var Ln=normPel(kl,Sl),Pn=Ln[0];Pn<Ln[1];Pn+=5)if(An>=Pn&&An<Pn+5){var En=allq.get(Pn),Tn=allq.get(Pn+5);if(-2==En&&-2==Tn)return console.log('No Q near'),[Pn,Pn+5];var On=Pn,In=-2==Tn?En:Tn;On=-2==Tn?Math.max(allq.qar[En].ps,allq.qar[En].pe):Math.min(allq.qar[Tn].ps,allq.qar[Tn].pe);var Bn=-2==Tn?5:-5;return[On,On+Bn]}return console.log('No q found'),[An,An+5*Ln[2]]}function Le(An){var Ln=Pa(An);if(Wi=allq.get(Ln),-2==Wi){Ni=new Ue,Ni.getQ();var Pn=Ae(Ln);Ni.ps=Pn[0],Ni.pe=Pn[1],Ni.comment=''}else Ni.restore(allq.qar[Wi]);ae(),Yl==qa.qval?(Ji.removeFolder(qa.qval),za()):Da(qa.qval),Fi.close(),Ji.removeFolder(qa.main),Ji.removeFolder(qa.setproperties),Vi.open(),Vs.visible=!0,Vs.position.set(1.2*-Ns,0.35*La(Ni.pe)+0.65*La(Ni.ps),10),Ve(),Ji.updateDisplay()}function Pe(){setTimeout(function(){Ji.open()},200)}function Ee(){Ji.close()}function Te(){-1<Wi?(Ni.lastchange=wl,allq.qar[Wi].restore(Ni)):(allq.add(Ni),Wi=allq.qar.length-1),oman.updchangelist(Ni.sid),allq.update(),Xt(null,1)}function Oe(){allq.remove(Wi),allq.update(),ae(),Ni=new Ue,Ve()}function Ie(){if(0==Bl.length)return void console.log('No lines selected');if(-1<chosenp){if('undefined'==typeof allp.par[chosenp])return void console.log('No lines selected');allp.par[chosenp].restore(_i),allp.par[chosenp].author=params.author,allp.par[chosenp].lastchange=wl,'L'==allp.par[chosenp].type&&(allp.par[chosenp].color=kt(Ce(_i.bergart)))}else _i.author=params.author,'L'==_i.type&&(_i.color=kt(Ce(_i.bergart))),_i.sid=wl,allp.add(_i),chosenp=allp.amtok()-1;oman.sp=allp.par[chosenp],allq.update(),ae()}function Be(){this.author=params.author,this.sid=wl,this.lastchange=wl,this.type='',this.bergart='none',this.ispartofQ=0,this.id='',this.coords=[],this.color=0,this.comment='',this.width=0,this.dsc='Not given',this.wdrip=0,this.wleak=0,this.isarea=!1,this.restore=function(An){var Ln=JSON.parse(JSON.stringify(An));this.sid=Ln.sid,this.lastchange=null==Ln.lastchange?this.sid:Ln.lastchange,this.type=Ln.type,this.id=Ln.id,this.coords=Ln.coords,this.bergart=Ln.bergart,this.width=Ln.width,this.comment=Ln.comment,this.ispartofQ=Ln.ispartofQ,null!=Ln.author&&(this.author=Ln.author),this.isarea=Ln.isarea,this.color=Ln.color,null!=Ln.dsc&&(this.dsc=Ln.dsc,this.wdrip=Ln.wdrip,this.wleak=Ln.wleak)},this.sameas=function(An){if(0==An.length)return!1;for(var Ln=0;Ln<Math.min(An.length,this.coords.length)&&!(6<Ln);Ln++){if(20<Ln)return console.log('Same',this.coords),!0;if(10<An.length){var Pn=ja(An[Ln],this.coords[Ln]);if(!Pn)return!0}if(!Ja(An[Ln],this.coords[Ln]))return!1}return!0},this.showprops=function(){var An;return An='W'==this.type?this.coords+' wdrip='+this.wdrip+' wleak='+this.wleak:this.bergart+' '+this.coords,An}}function Ge(){this.par=[],this.getareas=function(){var An=[];for(var Ln in this.par){var Pn=this.par[Ln];Pn.isarea&&!Pn.ispartofQ&&An.push(Pn)}return An},this.amtok=function(){for(var An=0,Ln=0;Ln<this.par.length;Ln++)this.par[Ln].ispartofQ||An++;return An},this.add=function(An,Ln){var Pn=new Be;Pn.restore(An),this.par.push(Pn),null==Ln&&this.update()},this.remove=function(An,Ln){if('object'==typeof An)for(var Pn in console.log('Trying to remove',An),this.par){var En=this.par[Pn];if(En==An){this.par.splice(Pn,1);break}}else-1<An&&this.par.splice(An,1);null==Ln&&this.update()},this.cleanFromQ=function(){for(var An=0;An<this.par.length;An++)1==this.par[An].ispartofQ&&(this.remove(An,1),An--)},this.y2pelcoords=function(){for(var An=0;An<this.par.length;An++)for(var Ln=0;Ln<this.par[An].coords.length;Ln+=2)this.par[An].coords[Ln+1]=Pa(this.par[An].coords[Ln+1])},this.cleanFromPel=function(){for(var An=0;An<this.par.length;An++)Ya(this.par[An].coords[1])||(console.log('Skipping property',this.par[An]),this.remove(An),An--)},this.get=function(An){for(var Ln=0;Ln<this.par.length;Ln++)if(this.par[Ln].sameas(An))return Ln;return-2},this.restore=function(An,Ln,Pn){var En=!1;null!=Pn&&(En=Pn);for(var On,Tn=0;Tn<An.par.length;Tn++)(On=this.ismemberalready(An.par[Tn]),null==An.par[Tn].sid&&(An.par[Tn].sid=Jn),null==An.par[Tn].author&&(An.par[Tn].author=jn),!(1==En&&An.par[Tn].sid<wl))&&(1<En&&An.par[Tn].sid!=En||(-1<On?this.par[On].restore(An.par[Tn]):this.add(An.par[Tn],Ln)));null==Ln&&(console.log('Update inside restore'),this.update())},this.ismemberalready=function(An){for(var Ln=0;Ln<this.par.length;Ln++)if(this.par[Ln].sameas(An.coords))return Ln;return-1},this.update=function(){mt.start('updatePinside');var An=renderblock;if(renderblock=1,ga(),params.showbergart)for(var Ln=0;Ln<this.par.length;Ln++)if(('L'==this.par[Ln].type||this.par[Ln].ispartofQ)&&(this.par[Ln].isarea&&Ye(this.par[Ln].coords,Ce(this.par[Ln].bergart),this.par[Ln].ispartofQ),''!=this.par[Ln].comment)){var En,Tn,Pn=this.par[Ln].coords.length;En=this.par[Ln].coords[Pn-2],Tn=this.par[Ln].coords[Pn-1];var On=X('comment!',En,Tn,5,1);Os.add(On)}renderblock=An,mt.end('updatePinside')}}function Ne(An){var Ln=An.length;return Ln%2?(console.log('Odd amount of coordinates?'),console.log(An),!1):!(8>Ln)&&An[0]==An[Ln-2]&&An[1]==An[Ln-1]}function _e(An){var Ln=kl<Sl,Pn=allq.get(An);return-1<Pn&&(Ln=allq.qar[Pn].ps>allq.qar[Pn].pe?0:Ln),kl<tunborder&&(Ln=13730<An&&13915>An||14350<An&&14980>An?0:1),17057<An&&17068>An&&(Ln=1),Ln}function We(){this.qar=[],this.add=function(An){var Ln=new Ue;Ln.restore(An),this.qar.push(Ln)},this.get=function(An){for(var Tn,Ln=1e3,Pn=-2,En=0;En<this.qar.length;En++)Tn=Ln,(this.qar[En].pe>An&&this.qar[En].ps<An||this.qar[En].ps>An&&this.qar[En].pe<An)&&(Ln=Math.min(Ln,Math.abs(An-this.qar[En].ps),Math.abs(An-this.qar[En].pe),Math.abs(An-(this.qar[En].pe+this.qar[En].ps)/2)),Tn!=Ln&&(Pn=En));return Pn},this.remove=function(An){-1<An&&(console.log('Removed Q'),oman.updchangelist(this.qar[An].sid),this.qar.splice(An,1))},this.removeP=function(An){var Ln=this.get(An);-1<Ln?this.qar.splice(Ln,1):console.log('No such Q with pel'+An)},this.getoverlaps=function(){for(var An=[],Ln=0;Ln<this.qar.length;Ln++){for(var Pn=0,En=this.qar[Ln],Tn=Math.min(En.ps,En.pe),On=Math.max(En.ps,En.pe),In=Ln+1;In<this.qar.length;In++){var Bn=this.qar[In],Gn=Math.min(Bn.ps,Bn.pe),Nn=Math.max(Bn.ps,Bn.pe);if(Gn<=On&&Gn>=Tn){if(Gn==On)continue;var _n=[Gn,Math.min(Nn,On)];An.push(_n),En.Q==Bn.Q&&En.comment==Bn.comment&&(En.sid>Bn.sid?(console.log('Removing overlap',Bn),this.remove(In),In--):Pn=1);continue}if(Nn<=On&&Nn>=Tn){if(Nn==Tn)continue;var _n=[Math.max(Gn,Tn),Nn];An.push(_n),En.Q==Bn.Q&&En.comment==Bn.comment&&(En.sid>Bn.sid?(console.log('Removing overlap',Bn),this.remove(In),In--):Pn=1)}}Pn&&(console.log('Removing i',En),this.remove(Ln),Ln--)}return 2<An.length&&console.log('Overlaps',An),An},this.update=function(){mt.start('updateQ'),mt.start('Get Q overlaps'),this.getoverlaps(),mt.end('Get Q overlaps'),ha(),mt.start('Clean Q'),allp.cleanFromQ(),mt.end('Clean Q');for(var An=0;An<this.qar.length;An++)if(ua(this.qar[An].ps,this.qar[An].pe,this.qar[An].getQ(),this.qar[An].class,this.qar[An].comment),'none'!=this.qar[An].bergart){var Ln=new Ge,Pn=new Be;Pn.ispartofQ=1;var En=La(this.qar[An].ps),Tn=La(this.qar[An].pe);Pn.coords=[-Ns,En,-Ns,Tn,Ns,Tn,Ns,En],Pn.bergart=this.qar[An].bergart,Pn.isarea=!0,Ln.add(Pn,1),allp.restore(Ln,1)}mt.start('updatePFinal'),allp.update(),mt.end('updatePFinal'),mt.end('updateQ')},this.clear=function(){ha(),this.qar=[]},this.restore=function(An,Ln,Pn){var En=!1;null!=Pn&&(En=Pn);for(var Tn=0;Tn<An.qar.length;Tn++)if((null==An.qar[Tn].sid&&(An.qar[Tn].sid=Jn),null==An.qar[Tn].author&&(An.qar[Tn].author=jn),!(1==En&&An.qar[Tn].sid<wl))&&!(1<En&&An.qar[Tn].sid!=En)){if(params.onlycurpel&&(!Ya(An.qar[Tn].ps)||!Ya(An.qar[Tn].pe))){console.log('Q not in limits'+An.qar[Tn].ps+' '+An.qar[Tn].pe);continue}var On=this.isequal(An.qar[Tn]);-1<On?this.qar[On].restore(An.qar[Tn]):this.add(An.qar[Tn])}null==Ln&&this.update()},this.isequal=function(An){for(var Ln=0;Ln<this.qar.length;Ln++)if(this.qar[Ln].ps==An.ps&&this.qar[Ln].pe==An.pe)return Ln;return-1}}function Ue(){this.author=params.author,this.sid=wl,this.lastchange=wl,this.ps=kl,this.pe=Sl,this.RQDc='??',this.Jrc='??',this.Jwc='??',this.Jnc='??',this.Jac='??',this.SRFc='??',this.Jnmult=1,this.RQD=-1,this.Jr=-1,this.Jw=-1,this.Jn=-1,this.Ja=-1,this.SRF=-1,this.Q='??',this.class='??',this.comment='',this.bergart='none',this.getQ=function(){return 0>this.RQD||0>this.Jr||0>this.Jr||0>this.Jn||0>this.Ja||0>this.SRF?this.Q:(this.Q=Math.round(1e3*(Math.max(this.RQD,10)*this.Jr*this.Jw/(this.Jn*this.Ja*this.SRF)))/1e3,0.01<this.Q&&(this.Q=Math.round(100*this.Q)/100),1<this.Q&&(this.Q=Math.round(10*this.Q)/10),this.class='G',0.01<this.Q&&(this.class='F'),0.1<this.Q&&(this.class='E'),1<this.Q&&(this.class='D'),4<this.Q&&(this.class='C'),10<this.Q&&(this.class='A/B'),this.Q)},this.restore=function(An){this.ps=An.ps,this.pe=An.pe,this.comment=An.comment,this.bergart=An.bergart,this.RQDc=An.RQDc,this.Jrc=An.Jrc,this.Jwc=An.Jwc,this.Jnc=An.Jnc,this.Jac=An.Jac,this.SRFc=An.SRFc,this.Jnmultc=1,this.RQD=An.RQD,this.Jr=An.Jr,this.Jw=An.Jw,this.Jn=An.Jn,this.Ja=An.Ja,this.SRF=An.SRF,null!=An.author&&(this.author=An.author),null!=An.sid&&(this.sid=An.sid),this.lastchange=null==An.lastchange?this.sid:An.lastchange,this.getQ()}}function Ye(An,Ln,Pn){for(var On,En=[],Tn=0;Tn<An.length;Tn+=2)On=new THREE.Vector3(An[Tn],An[Tn+1],1-0.02*Pn),En.push(On);var Bn,Gn,Nn=new THREE.Geometry,_n=new THREE.MeshBasicMaterial({color:Ln,transparent:!0,opacity:0.7});_n.side=THREE.DoubleSide,Nn.vertices=En,Bn=THREE.ShapeUtils.triangulateShape(En,[]);for(var Tn=0;Tn<Bn.length;Tn++)Nn.faces.push(new THREE.Face3(Bn[Tn][0],Bn[Tn][1],Bn[Tn][2]));Gn=new THREE.Mesh(Nn,_n),Os.add(Gn),ae()}function Ke(An){for(var Ln=An.elements,Pn=0;Pn<Ln.length;Pn++)Ln[Pn]=mr(Ln[Pn]);return Ln}function $e(An,Ln){var Pn={x:(An/Ns+1)/2,y:(Ln/_s+1)/2};return Pn}function et(An,Ln){var Pn=Ln.x-An[0].x,En=Ln.y-An[0].y,Tn=0<(An[1].x-An[0].x)*En-(An[1].y-An[0].y)*Pn;return 0<(An[2].x-An[0].x)*En-(An[2].y-An[0].y)*Pn!=Tn&&0<(An[2].x-An[1].x)*(Ln.y-An[1].y)-(An[2].y-An[1].y)*(Ln.x-An[1].x)==Tn}function tt(){controls.reset(),controls.target.set(0,0,0),camera.position.set(0,0,gi),cameraFix.position.set(0,0,gi),Na(),lt(),Qa()}function lt(){var An=window.devicePixelRatio;Ml=ul,Cl=hl,camera.left=-Ns,camera.right=Ns,camera.top=_s+Ws,camera.bottom=-_s+Ws,cameraFix.left=-Ns,cameraFix.right=Ns,cameraFix.top=_s+Ws,cameraFix.bottom=-_s+Ws,'Geo+Q+Pel'==params.what2plot&&(camera.left=-Ns-1.2,camera.right=Ns+1.2,Ml*=1.3,lsc=0.5),Ml/=An,Cl/=An;'For 3d'!=params.what2plot&&4096<Cl&&(Ml=4096*Ml/Cl,Cl=4096);var Pn=Ml,En=Cl;'For 3d'==params.what2plot,renderer.setSize(Pn,En),ri=new THREE.Vector2(Pn,En),'For 3d'==params.what2plot&&(lsc=Math.min(0.5,5e3/En));var Tn=android||iOS?4:1;buftext=new THREE.WebGLRenderTarget(4096/Tn,16384/Tn,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat}),camera.updateProjectionMatrix(),cameraFix.updateProjectionMatrix()}function it(){Ql||(sensivity=1,V(),params.what2plot='For 3d',vt(kl,Sl,1),tt(),Va(),Ql=!0,renderer.render(Jl,cameraFix,buftext),ut(),Mt(),camera.position.set(0,0,1e3),params.what2plot='Geo+Q+Pel',controls.enableRotate=!0,ae(),check3dbox.style.display='',check3dbox.checked=!0,fgui.close(),Da('3d'))}function rt(){if(Ql){for(sensivity=5,V();0<ks.children.length;)ks.remove(ks.children[0]);buftext.dispose(),Jl=Fs,params.resetcam(),controls.enableRotate=!1,Ql=!1,camera.position.set(0,0,gi),lsc=1,ut(),Qa(),Va(),vt(kl,Sl),setTimeout(function(){ae()},50),li.value='Select',Da('Line'),check3dbox.style.display='none',fgui.close(),Ji.close()}}function dt(){Sl+=5*pmult,kl-=5*pmult,zl=Math.abs(parseInt(kl)-parseInt(Sl)),hl=Fl*zl,Cl=hl,_s=hl/Gs,E(kl,Sl,Ws),vt(kl,Sl),ua(kl,Sl,-1),pt(gl,La(Sl-2.5*pmult)),pt(gl,La(kl+2.5*pmult)),ae()}function pt(An,Ln){var Pn=new THREE.MeshBasicMaterial({color:16777215}),En=new THREE.PlaneGeometry(5*(2*(Fl/Gs)),2*Ns,1,1),Tn=new THREE.Mesh(En,Pn);Tn.position.set(0,Ln,0),Tn.rotateZ(Math.PI/2),Hl.push(Tn),Qs.add(Tn)}function ut(){z(),ri=new THREE.Vector2(ii,oi),ci=ii/oi,camera.left=-ui*ci/2,camera.right=ui*ci/2,camera.top=hi/2,camera.bottom=-hi/2,camera.updateProjectionMatrix(),renderer.setSize(ii,oi),ae()}function gt(){if(Ri)return!1;for(var An=0,Ln=0;Ln<Xl.length;Ln++)1!=Xl[0].skip&&(An=1);if(allq.qar.length&&(An=1),!An)return!1;var Pn=new Date().getTime(),En=Ia(1),Tn=JSON.stringify(En);localStorage.setItem(Kl.s,Tn);var On=new Date().getTime()-Pn;return console.log('dT = '+On),!0}function yt(){if(localStorage.getItem(Kl.l)){var An=localStorage.getItem(Kl.l),Ln=JSON.parse(An);console.log('Sid set to',Ln.sid),Ra(Ln),allq.update(),Qa(),ae(),params.restses=0,Da('Line')}}function vt(An,Ln,Pn){if(Jl.remove(js),!!params.rutenett){js=new THREE.Object3D;var En=normPel(An,Ln),Tn=En[0],On=En[1],In=-4;null!=Pn&&(In=-0.5);for(var Un,Wn=Tn;Wn<=On;Wn++){Un=[],Un.push(-Ns,La(Wn),1,1.13*Ns,La(Wn),1);var Hn=N(Un,In,'0#000000');js.add(Hn)}Jl.add(js)}}function xt(){if(params.vederlag){var An=tungeom[params.tunnel].Width,Ln=[];for(var Pn in An){var En=An[Pn][1],Tn=An[Pn][3],On=An[Pn][5],In=On-En;Ln.push([An[Pn][0],2*((An[Pn][2]-En)/In)-1,2*((An[Pn][3]-En)/In)-1,2*((An[Pn][4]-En)/In)-1])}for(var Hn,Xn,Yn,Kn,In,Bn=normPel(kl,Sl),Gn=Bn[0],Nn=Bn[1],_n=[],Wn=[],Un=[],Zn=1,Pn=Gn;Pn<Nn;Pn++){if(In=Math.max(Pn,Ln[0][0]),In=Pn,Hn=wt(In,Ln),Yn=La(In),Xn=wt(In+pmult,Ln),Kn=La(In+1),!Hn||!Xn){console.log('No vederlag data for pel=',Pn),Zn=0;break}_n.push(Hn[0]),_n.push(Yn),_n.push(1),Wn.push(Hn[1]),Wn.push(Yn),Wn.push(1),Un.push(Hn[2]),Un.push(Yn),Un.push(1)}Zn&&(_n.push(Xn[0]),_n.push(Kn),_n.push(1),Wn.push(Xn[1]),Wn.push(Kn),Wn.push(1),Un.push(Xn[2]),Un.push(Kn),Un.push(1)),N(_n,-4,'0#000000'),N(Wn,-4,'0#000000'),N(Un,-4,'0#000000')}}function wt(An,Ln){for(var Pn=Ln.length,En=xct=xrt=0,Tn=0,On=0,In=0;In<Pn-1;In++)if(An>=Ln[In][0]&&An<Ln[In+1][0]||An<=Ln[In][0]&&An>Ln[In+1][0]){var Bn=Ln[In+1][0]-Ln[In][0];0==Bn?Tn=[Ln[In][1]*Ns,Ln[In][2]*Ns,Ln[In][3]*Ns]:(On=(An-Ln[In][0])/(Ln[In+1][0]-Ln[In][0]),En=Ln[In][1]+On*(Ln[In+1][1]-Ln[In][1]),xct=Ln[In][2]+On*(Ln[In+1][2]-Ln[In][2]),xrt=Ln[In][3]+On*(Ln[In+1][3]-Ln[In][3]),Tn=[En*Ns,xct*Ns,xrt*Ns])}return Tn?Tn:An<Ln[0][0]?[Ln[0][1]*Ns,Ln[0][2]*Ns,Ln[0][3]*Ns]:[Ln[Pn-1][1]*Ns,Ln[Pn-1][2]*Ns,Ln[Pn-1][3]*Ns]}function kt(An,Ln){var Pn=An;return 7==Pn.length?(Pn=null==Ln?'0x'+Pn[5]+Pn[6]+Pn[3]+Pn[4]+Pn[1]+Pn[2]:'0x'+Pn[1]+Pn[2]+Pn[3]+Pn[4]+Pn[5]+Pn[6],parseInt(Pn)):0}function St(){Ql?(Zs.style.display='none',$s.style.display='none',ei.style.display='none',li.style.display='none',si.style.display='none'):(Zs.style.display='',$s.style.display='',ei.style.display='',li.style.display='',si.style.display='')}function zt(){Zs.setAttribute('class','geobutton'),$s.setAttribute('class','geobutton'),ei.setAttribute('class','geobutton'),ti.setAttribute('class','geobutton'),li.setAttribute('class','geobutton')}function Dt(An){var Ln=[],Pn=An.length;for(var En in Ln.push(Lt(An[0][0]+1,An)),An)An[En][0]>An[0][0]+1&&An[En][0]<An[Pn-1][0]-1&&Ln.push(Lt(An[En][0],An));return Ln.push(Lt(An[Pn-1][0]-1,An)),Ln}function Vt(An){var Ln=tungeom[An].TunProfile,Pn=parse3dmod(Ln),En=Dt(Pn),Tn=Rt(Pn);for(var On in En)Tn.add(Qt(En[On]));var In=(Pn[0][0]+Pn[Pn.length-1][0])/2,Bn=-La(In);return[Pn,Tn]}function Qt(An){var Ln=[];for(var Pn in An.v)Ln.push(An.v[Pn].x),Ln.push(An.v[Pn].y),Ln.push(An.v[Pn].z);var En=new THREE.Object3D,Tn=N(Ln,10,'0#000000');return En.add(Tn),En}function Mt(){p2y=La;var An=Vn,Ln=An[0];lingeom=new THREE.Object3D,lingeom.add(Vn[1]),lingeom.add(Mn);var Pn=(Ln[0][0]+Ln[Ln.length-1][0])/2,En=La(Pn),Tn=getglobc((kl+Sl)/2);lingeom.position.set(-Tn.x,-Tn.y,-Tn.z);var On=At(Ln),In=On[0];for(var Bn in partlingeom=On[1],pmat=new THREE.MeshBasicMaterial({map:buftext.texture,transparent:!0,opacity:0.5,depthTest:!0}),pmat.side=THREE.DoubleSide,my3dgroup=new THREE.Object3D,meshes=new THREE.Object3D,In){var Gn=new THREE.Mesh(In[Bn][2],pmat);Gn.castShadow=!1,Gn.receiveShadow=!1,meshes.add(Gn)}if(meshes.position.set(-Tn.x,-Tn.y,-Tn.z),my3dgroup.add(meshes),ks=new THREE.Scene,Fs=Jl,params.showholes){var Nn=new THREE.Object3D;Nn.add(Ls),Nn.position.set(-Tn.x,-Tn.y,-Tn.z),my3dgroup.add(Nn)}In[0][2].computeBoundingSphere();var _n=In[0][2].boundingSphere.center,Wn=new THREE.Quaternion;Wn.setFromUnitVectors(new THREE.Vector3(0,0,1),new THREE.Vector3(0,1,0)),my3dgroup.applyQuaternion(Wn);for(var Un,Hn,Xn=0;Xn<oman.ao.length;Xn++)if('B'==oman.ao[Xn].type){var Yn=$e(oman.get(Xn).xs,oman.get(Xn).ys),Kn=Pa(oman.get(Xn).ys),Zn=new THREE.Vector2(Yn.x,Yn.y);for(var $n in In)if(numintersect(In[$n][0],In[$n][1],Kn,Kn)){Un=qn(meshes.children[$n],Zn);break}var eo=$e(oman.get(Xn).xe,oman.get(Xn).ye),Kn=Pa(oman.get(Xn).ye),Zn=new THREE.Vector2(eo.x,eo.y);for(var $n in In)if(numintersect(In[$n][0],In[$n][1],Kn,Kn)){Hn=qn(meshes.children[$n],Zn);break}var to=Hn[0],ao=Hn[1],lo=Un[0],no=Un[1],oo=-10,po=Fn(new THREE.Vector3(lo.x,lo.y,lo.z),new THREE.Vector3(to.x+1*(no.x*oo),to.y+1*(no.y*oo),to.z+1*(no.z*oo)));Nn.add(po)}my3dgroup.add(lingeom),my3dgroup.add(partlingeom),ks.add(my3dgroup),ks.add(fallar),ks.add(line3dgroup),ks.add(line3dtemp),controls.enableRotate=!0,ae()}function Rt(An){for(var Ln=An[0][1].length,Pn=new THREE.Object3D,En=[],Tn=An[0][1],On=[],In=An[0][0]+1;In<An[An.length-1][0]-1;In+=2)On.push(Lt(In,An));for(var Bn in Tn){for(var Gn in En=[],On){var Nn=On[Gn],_n=Nn.v[Bn];En.push(_n.x,_n.y,_n.z)}var Bn=N(En,5,'0#000000');Pn.add(Bn)}return Pn}function jt(An,Ln){var Pn=[];if(An<Ln[0][0])return Ps=[An,Ln[0][1]],Ps;if(An>Ln[Ln.length-1][0])return Ps=[An,Ln[Ln.length-1][1]],Ps;for(var En=1;En<Ln.length;En++)if(An>=Ln[En-1][0]&&An<=Ln[En][0]){var Tn=Ln[En-1][0],On=Ln[En][0],In=(An-Tn)/(On-Tn);for(var Bn in Ln[En][1]){var Gn=Ln[En][1][Bn],Nn=Ln[En-1][1][Bn];Pn.push(new THREE.Vector2(Gn.x*In+Nn.x*(1-In),Gn.y*In+Nn.y*(1-In)))}break}return Pn.length||console.log('Error! Vout not defined in getcurveatpel'),[An,Pn]}function At(An){for(var Nn,Ln=kl,Pn=Sl,En=jt(Ln,An),Tn=jt(Pn,An),On=-1,In=[[0,En]],Bn=[],Gn=0;Gn<An.length;Gn++)if((Nn=An[Gn][0],Math.round(On)!=Math.round(Nn))&&(On=Nn,Nn=Math.round(Nn),Ka(Nn,Ln,Pn))){var _n=(Nn-Ln)/(Pn-Ln);Bn.push([_n,An[Gn]])}if(0<pmult)for(var Wn=0;Wn<Bn.length;Wn++)In.push(Bn[Wn]);else for(var Wn=Bn.length-1;-1<Wn;Wn--)In.push(Bn[Wn]);In.push([1,Tn]);for(var Un=new THREE.Object3D,Hn=[],Xn=[],Wn=0;Wn<In.length-1;Wn++)for(var Yn=In[Wn][1][0],Kn=In[Wn+1][1][0],Zn=0,Gn=Yn;0>(Gn-Kn)*pmult;Gn+=5*pmult){Zn++;var _n=(Gn-Ln)/(Pn-Ln);if(Xn.push([_n,jt(Gn,An)]),500<Zn)return}Xn.push(In[In.length-1]);for(var Wn=1;Wn<Xn.length;Wn++){var $n=Lt(Xn[Wn][1][0],An),eo=Lt(Xn[Wn-1][1][0],An);Hn.push([Xn[Wn-1][1][0],Xn[Wn][1][0],Pt(eo,$n,Xn[Wn-1][0],Xn[Wn][0])])}return[Hn,Un]}function Lt(An,Ln){var Pn=jt(An,Ln),En=getglobc(An),Tn=getglobc(An,1)[1]/180*Math.PI,On=getglobc(An+0.01),In=new THREE.Quaternion;null==On?(On=getglobc(An).sub(getglobc(An-0.01)).normalize(),On=On.normalize(),On.z=0,In.setFromUnitVectors(new THREE.Vector3(1,0,0),On)):(On=getglobc(An+0.01).sub(En),On=On.normalize(),On.z=0,In.setFromUnitVectors(new THREE.Vector3(1,0,0),On)),0.1<Math.abs(In.y)&&(console.log(An,En,On),console.log(An,In));var Bn={pel:An,v:[]};for(var Gn in Pn[1]){var Nn=Pn[1][Gn],_n=Math.sin(Tn),Wn=Math.cos(Tn),Un=new THREE.Vector3(0,Nn.x,Nn.y);Un.applyAxisAngle(new THREE.Vector3(1,0,0),Tn),Un.applyQuaternion(In),Un.add(En),Bn.v.push(Un)}return Bn}function Pt(An,Ln,Pn,En){var Tn=new THREE.Geometry,On=0,In=An.v.length;Tn.faceVertexUvs[0]=[];for(var Bn=0;Bn<In-1;++Bn){var Gn=An.v[Bn],Nn=An.v[Bn+1],_n=Ln.v[Bn],Wn=Ln.v[Bn+1],Un=Bn/(In-1),Hn=(Bn+1)/(In-1),Xn=null==Pn?0:Pn,Yn=null==En?1:En;Tn.vertices.push(new THREE.Vector3(Gn.x,Gn.y,Gn.z)),Tn.vertices.push(new THREE.Vector3(Nn.x,Nn.y,Nn.z)),Tn.vertices.push(new THREE.Vector3(_n.x,_n.y,_n.z)),Tn.vertices.push(new THREE.Vector3(Wn.x,Wn.y,Wn.z)),Tn.faces.push(new THREE.Face3(On+2,On+1,On)),Tn.faces.push(new THREE.Face3(On+1,On+2,On+3)),Tn.faceVertexUvs[0].push([new THREE.Vector2(Un,Yn),new THREE.Vector2(Hn,Xn),new THREE.Vector2(Un,Xn)]),Tn.faceVertexUvs[0].push([new THREE.Vector2(Hn,Xn),new THREE.Vector2(Un,Yn),new THREE.Vector2(Hn,Yn)]),On+=4}return Tn.uvsNeedUpdate=!0,Tn.computeFaceNormals(),Tn}function Et(){Mn=new THREE.Object3D;var An=tun2='';if('34100'==params.tunnel&&(tun2='34100',An='34000'),'34000'==params.tunnel&&(tun2='34000',An='34100'),An){globavg=tungeom[An].Geo3d.globavg,globtc=tungeom[An].Geo3d.globtc,Mn=Vt(An)[1];var Ln=tv().copy(tungeom[An].Geo3d.globavg).sub(tungeom[tun2].Geo3d.globavg);Ln.y=-Ln.y,Mn.position.set(Ln.x,Ln.y,Ln.z)}globavg=tungeom[params.tunnel].Geo3d.globavg,globtc=tungeom[params.tunnel].Geo3d.globtc,globtc[0].pel-=0.1,('Kjorholt'==params.tunnel||'Tunnel1'==params.tunnel)&&(globtc[0].pel=13650),globtc[globtc.length-1].pel+=0.1,Vn=Vt(params.tunnel)}function Tt(){var An=linez.length;if(!(2>An)){for(var Pn,Ln=1;Ln<An;Ln++)Pn=new Aa,Pn.addline(linez[Ln-1].xs,linez[Ln-1].ys,1,linez[Ln].xs,linez[Ln].ys,1,Math.round(30*params.size),'#000000'),oman.add(Pn);var En=linez[0].v,Tn=linez[Math.floor(An/2)].v,On=linez[An-1].v,In=Ot();return In}}function Ot(){for(var An=linez.length,Ln=Math.floor(An/3),Pn=Math.floor(2*An/3),En=tv(),Tn=tv(),On=tv(),In=0;In<Ln;In++)En.add(linez[In].v);En.multiplyScalar(1/Ln);for(var In=Ln;In<Pn;In++)Tn.add(linez[In].v);Tn.multiplyScalar(1/(Pn-Ln));for(var In=Pn;In<An;In++)On.add(linez[In].v);return On.multiplyScalar(1/(An-Pn)),[En,Tn,On]}function Gt(An){var Ln=new THREE.Plane().setFromCoplanarPoints(An[0],An[1],An[2]),Pn=new THREE.Vector3((An[0].x+An[1].x+An[2].x)/3,(An[0].y+An[1].y+An[2].y)/3,(An[0].z+An[1].z+An[2].z)/3),En=new THREE.BoxGeometry(150,150,0.5),Tn=new THREE.MeshBasicMaterial({color:17408,transparent:!0,opacity:0.1}),On=new THREE.Mesh(En,Tn),In=new THREE.Quaternion;In.setFromUnitVectors(new THREE.Vector3(0,0,1),Ln.normal),On.applyQuaternion(In),On.position.set(Pn.x,Pn.y,Pn.z),On.scale.set(fscale.val,fscale.val,1),fallar.add(On)}function Nt(An){var Ln=new THREE.Plane().setFromCoplanarPoints(An[0],An[1],An[2]),Pn=new THREE.Vector3((An[0].x+An[1].x+An[2].x)/3,(An[0].y+An[1].y+An[2].y)/3,(An[0].z+An[1].z+An[2].z)/3),En=Ln.normal;0>En.y&&En.negate();var Tn=180*new THREE.Vector3(0,1,0).angleTo(En)/Math.PI,On=Pa(linez[0].ys),In=getglobc(On+1).sub(getglobc(On));In=In.normalize();var Bn=getglobc((kl+Sl)/2),Gn=new THREE.Quaternion;Gn.setFromUnitVectors(new THREE.Vector3(0,0,1),new THREE.Vector3(0,1,0)),In.applyQuaternion(Gn);var Nn=new THREE.Quaternion;Nn.setFromUnitVectors(new THREE.Vector3(0,1,0).applyQuaternion(Gn),new THREE.Vector3(1,0,0).applyQuaternion(Gn));var _n=tv().copy(In).applyQuaternion(Nn),Wn=new THREE.Plane().setFromCoplanarPoints(Pn,tv().copy(Pn).add(_n),tv().copy(Pn).add(In)),Un=tv().copy(En).projectOnPlane(Wn.normal),Hn=Un.angleTo(In)<Math.PI/2?1:0,Xn=180*Un.angleTo(_n)/Math.PI;return Xn=Hn?360-Xn:Xn,console.log('Strike:',Xn),console.log('Dip/Fall',Tn),[Math.floor(Xn),Math.round(Tn)]}function Ut(){if(linez.length){var An=new ConvexHullGrahamScan;for(var Ln in linez)An.addPoint(linez[Ln].xs,linez[Ln].ys);var Pn=An.getHull(),En=[];for(var Tn in linez)for(var Ln in Pn){var On=linez[Tn];Pn[Ln].x==On.xs&&Pn[Ln].y==On.ys&&En.push(On)}linez=En,linez.sort(function(_n,Wn){return Wn.xs-_n.xs});var In=y=0;for(var Tn in linez)In+=linez[Tn].xs,y+=linez[Tn].ys;In/=linez.length,y/=linez.length;var Bn=Tt(),Gn=Nt(Bn),Nn=new Aa;Nn.addfall(In,y,8,Gn[0],Gn[1],1),Nn.color=Bn,oman.plot(Nn),oman.add(Nn),Ht(linez),Qa(),ae(),linez=[],controls.enableRotate=!0,check3dbox.checked=!0,Ji.updateDisplay()}}function Ht(An){var Ln=[];for(var Pn in An)Ln.push(An[Pn].v.x,An[Pn].v.y,An[Pn].v.z);if(Ln.length){var En=N(Ln,Math.round(40*params.size),'#000000',1);line3dgroup.add(En)}}function Xt(An,Ln){var Pn=new Date().getTime(),En=5e3;if(null!=Ln&&(En=Ln),Pn-ms>En){for(var Tn in Rl){var On=Rl[Tn];On.redrawInterval=1}for(var Tn in ae(An),Rl){var On=Rl[Tn];On.redrawInterval=1e5}ms=Pn}else ae(An)}function ea(){params.withbg?ia(gl):ia(''),fi.material=bi,ae()}function ia(An){if(''==An)bi=new THREE.MeshBasicMaterial({color:16777215});else{var Ln=new THREE.TextureLoader;Ln.crossOrigin='anonymous';var Pn=Ln.load(An,function(){ae()});Pn.magFilter=THREE.NearestFilter,Pn.minFilter=THREE.LinearMipMapLinearFilter,Pn.anisotropy=2,kl>Sl&&(Pn.flipY=!1),bi=new THREE.MeshBasicMaterial({map:Pn})}}function oa(An,Ln){wl=getsessionid(),M(),Sl=parseInt(Ln),kl=parseInt(An),pmult=kl<Sl?1:-1,Dl=(kl+Sl)/2,zl=Math.abs(parseInt(kl)-parseInt(Sl)),Fl=50,11>zl&&(Fl=100),6>zl&&(Fl=200),hl=Fl*zl,Cl=hl,_s=hl/Gs,E(kl,Sl,Ws),vt(kl,Sl),ca(gl,0),ua(kl,Sl,-1),params.resetcam(),ae(),picparams.ps=kl,picparams.pe=Sl,saveifokdist(picparams.ps,picparams.pe),fgui.updateDisplay()}function ra(An,Ln,Pn){var En=params.tunnel;null!=Pn&&(En=Pn);var Tn=An>Ln,On=Math.min(An,Ln),In=Math.max(An,Ln),Bn=1*Math.floor(On/1),Gn=1*Math.floor((In-0.01)/1+1),Nn=gettunlim(En);('Kjorholt'==params.tunnel||'Tunnel1'==params.tunnel)&&(Nn.pmin=13650),'34100'==params.tunnel&&(Nn.pmin=0);var _n=checklims(Bn,Gn,Nn);Bn=_n[0],Gn=_n[1],picdb.sortbypelasc();var Wn=getpicsinrange(En,Bn,Gn);gl='';var Un=Wn.length;for(var Hn in Un&&(Bn=parseFloat(picdb.files[Wn[0]].ps),Gn=parseFloat(picdb.files[Wn[Un-1]].pe)),Tn?oa(Gn,Bn):oa(Bn,Gn),Wn)pa(picdb.files[Wn[Hn]],Tn);rt(),fgui.close(),Ji.close()}function pa(An,Ln){var Pn=kl>Sl;null!=Ln&&(Pn=Ln);var En=new THREE.TextureLoader;En.crossOrigin='anonymous';var Tn=En.load(An.pic,function(){ae()});Tn.magFilter=THREE.NearestFilter,Tn.minFilter=THREE.LinearMipMapLinearFilter,Tn.anisotropy=2,Pn&&(Tn.flipY=!1);var On=new THREE.MeshBasicMaterial({map:Tn}),In=Math.abs(La(Math.max(An.ps,An.pe))-La(Math.min(An.ps,An.pe))),Bn=La((An.ps- -An.pe)/2),Gn=new THREE.PlaneGeometry(In,2*Ns,1,1);fi=new THREE.Mesh(Gn,On),fi.position.set(0,Bn,0.01);var Nn=Pn?Math.PI:0;fi.rotateZ(Math.PI/2+Nn),Hl.push(fi),Qs.add(fi)}function ca(An,Ln){Jl.remove(Qs),Qs=new THREE.Object3D,Hl.length=0,ia(An);var Pn=new THREE.PlaneGeometry(2*_s,2*Ns,1,1);fi=new THREE.Mesh(Pn,bi),fi.position.set(0,Ln/Fl,0);var En=kl>Sl?Math.PI:0;fi.rotateZ(Math.PI/2+En),Hl.push(fi),Qs.add(fi),Jl.add(Qs)}function ua(An,Ln,Pn,En,Tn){var On,In=!1;-1==Pn?(In=!0,On=11184810):(On=16711680,1<Pn&&(On=16769024),4<Pn&&(On=16746240),10<Pn&&(On=2258722));var Bn=In?1:0.8,Gn=new THREE.MeshBasicMaterial({color:On,transparent:!0,opacity:Bn}),Nn=La((An+Ln)/2),_n=Math.abs(La(Ln)-La(An)),Wn=Ns/3,Un=-Ns-Wn+Ns/10,Hn=new THREE.PlaneGeometry(Wn,_n,1,1),Xn=new THREE.Mesh(Hn,Gn);if(Xn.position.set(Un,Nn,In?0:1),In){var Yn=Ts.children[0];null!=Yn&&Ts.remove(Yn),Ts.add(Xn),Hl.push(Xn)}else{Es.add(Xn);var Kn=X('Q='+Pn+' '+En,Un,Nn,10,0);if(Es.add(Kn),null!=Tn&&''!=Tn){for(var Zn='',$n=0;$n<Math.min(4,Tn.length);$n++)Zn+=Tn[$n];Zn+='..!';var eo=X(Zn,Un-0.35*Us,Nn+0.38*_n,10,1);Es.add(eo)}}}function ha(){for(;Es.children.length;){var An=Es.children[0];'undefined'!=typeof An.material&&An.material.dispose(),'undefined'!=typeof An.geometry&&An.geometry.dispose(),Es.remove(An)}}function ga(){for(;Os.children.length;){var An=Os.children[0];'undefined'!=typeof An.material&&An.material.dispose(),'undefined'!=typeof An.geometry&&An.geometry.dispose(),Os.remove(An)}}function ya(){for(;Cs.children.length;){var An=Cs.children[0];'undefined'!=typeof An.material&&An.material.dispose(),'undefined'!=typeof An.geometry&&An.geometry.dispose(),Cs.remove(An)}for(;As.children.length;){var An=As.children[0];'undefined'!=typeof An.material&&An.material.dispose(),'undefined'!=typeof An.geometry&&An.geometry.dispose(),As.remove(An)}for(;Ms.children.length;){var An=Ms.children[0];'undefined'!=typeof An.material&&An.material.dispose(),'undefined'!=typeof An.geometry&&An.geometry.dispose(),Ms.remove(An)}}function ba(An,Ln){var Pn=document.createElement('input',Ln);Pn.setAttribute('class','inguib'),Pn.setAttribute('type','button'),Pn.setAttribute('value',An),Pn.setAttribute('id','mgb'+An);var En=new Hammer(Pn);return Pn.onfocus=function(){Pn.blur()},En.on('press',function(){mycswitch(Pn,'ibpressed',500),null!=Ln&&setTimeout(function(){Ln()},150)}),En.get('press').set({threshold:100,time:3}),Pn}function xa(){var An=new FormData;An.append('data',params.author);try{var Ln=window.XMLHttpRequest?new XMLHttpRequest:new activeXObject('Microsoft.XMLHTTP');Ln.onreadystatechange=function(){if(4===Ln.readyState){var Pn=JSON.parse(Ln.response);filetable(container,Pn,function(En){var Tn=pelfromfname(En),On=Tn[0],In=Tn[1];saveifokdist(On,In),wa(En)})}},Ln.open('post',baseaddr+'getflist.php',!0),Ln.send(An)}catch(Pn){console.log(Pn)}}function wa(An){var Ln=new FormData;Ln.append('fname',An);try{var Pn=window.XMLHttpRequest?new XMLHttpRequest:new activeXObject('Microsoft.XMLHTTP');Pn.onreadystatechange=function(){if(4===Pn.readyState){if(params.overridepel){var En=pelfromfname(An),Tn=getpelrange(Pn.response,En[0],En[1]);Cn=[],gl='',oa(Tn[0],Tn[1])}Ra(Pn.response),allq.update(),Qa(),ae()}},Pn.open('post',baseaddr+'gettxt.php',!0),Pn.send(Ln)}catch(En){console.log(En)}}function ka(An){var Ln=basekjor;'Kjorholt'==An&&(Ln=basekjor),'Bamle'==An&&(Ln=basebamble);var Pn=An+picparams.ps+'_'+picparams.pe+'.xml',En=Ln+Ta(An)+endfile,Tn=vkbeautify.xml(En);download(Tn,Pn)}function Sa(An,Ln){var Pn=Ji.add(bf,'blank').name('Geology:');Pn.onChange(function(){Ji.close()}),Pn.__li.setAttribute('class','cr function first');var En=parseFloat(Ji.domElement.style.width)-1;Pn.__li.style.width=En+'px';var Tn=Qe(Ji),On=ba('ShowDB',function(){ji.showdb()});On.setAttribute('class','inguib but2gui'),Tn.appendChild(On),On=ba('Save',function(){params.save()}),On.setAttribute('class','inguib but2gui'),Tn.appendChild(On),Fi=Ji.addFolder('Save/Open file'),Fi.add(params,'loadprev').name(qa.restoresession),Fi.add(params,'savealpha').name(qa.savepicture),Fi.add(params,'author').name(qa.author).onChange(function(){Se()}).domElement.children[0].setAttribute('maxlength','20'),Fi.add(params,'openfile').name(qa.openfilegeology);var In=Fi.addFolder('Expert');if(In.add(params,'ex').name('Expert user').onChange(function(){Ji.close(),Da(Yl)}),In.add(params,'clear').name(qa.clearall),In.add(params,'overridepel').name('Override pel'),In.add(params,'withbg').name(qa.showmwd).onChange(function(){ea()}),In.add(params,'showbergart').name(qa.showrocktype).onChange(function(){allp.update(),ae()}),In.add(params,'forcesync').name('ForcedSync'),null!=An&&(An==qa.qval&&za(),'Select'==An)){Mi=Ji.addFolder(qa.setproperties);var Bn=sid2txtdate(_i.sid)+' '+_i.author;if(Mi.add(bf,'blank').name(Bn),Mi.add(_i,'author').name(qa.author),'T'!=Ln){q22=Mi.add(_i,'comment').name('');var Gn=q22.domElement.children[0];Gn.setAttribute('class','myta'),q22.domElement.setAttribute('class','c bigtadiv'),Gn.placeholder='Comment...',Gn.onkeyup=function(){Me(this)},Gn.onchange=function(){Ie()},q22.__li.setAttribute('class','cr string bigta')}if('T'==Ln&&(Mi.add(Xl[Is],'text').name(qa.text).onChange(function(){Z(Is,Xl[Is].text)}),Mi.add(params,'openfoto').name(qa.takephoto),Mi.add(params,'makelab').name(qa.labtest)),null==Ln||'L'==Ln){Mi.add(_i,'bergart',vi).name(qa.rocktype).listen().onChange(function(){params.parcolor=Ce(_i.bergart),Ji.updateDisplay()});var Tn=Mi.addColor(params,'parcolor').name(qa.color).listen().onChange(function(){params.parcolor=Ce(_i.bergart),Ji.updateDisplay()}),Nn=Tn.domElement.children[0];Nn.style.width='70%'}return'W'==Ln&&(Mi.add(_i,'dsc',qa.dsc).name(qa.description),Mi.add(_i,'wdrip').name(qa.dripmin),Mi.add(_i,'wleak').name(qa.litmin)),'F'==Ln&&(Mi.add(Xl[Is],'angle',0,360).step(1).name(qa.angle).onChange(function(){$(Is,Xl[Is].fall,Xl[Is].angle)}),Mi.add(Xl[Is],'fall',0,90).step(1).name(qa.fall).onChange(function(){$(Is,Xl[Is].fall,Xl[Is].angle)})),Mi.add(bf,'blank').name(''),void Mi.add(params,'applyP').name(qa.ap)}Qi=Ji.addFolder(qa.main),Qi.add(bf,'blank').name(''),params.ex&&(F(Qi),F(Qi),Qi.add(params,'resetcam').name(qa.resetcamera),F(Qi))}function za(){Vi=Ji.addFolder(qa.qval);var An=sid2txtdate(Ni.lastchange)+' by \''+Ni.author+'\'';Vi.add(bf,'blank').name('Updated '+An);var Ln=Vi.add(Ni,'ps').name('Pel start').domElement.children[0];Ln.type='tel',Ln.setAttribute('maxlength','5'),Ln=Vi.add(Ni,'pe').name('Pel end').domElement.children[0],Ln.type='tel',Ln.setAttribute('maxlength','5'),q22=Vi.add(Ni,'comment').name('');var Pn=q22.domElement.children[0];Pn.setAttribute('class','myta'),q22.domElement.setAttribute('class','c bigtadiv'),Pn.placeholder='Comment...',Pn.onkeyup=function(){Me(this)},20<Ni.comment.length&&Me(Pn),Pn.onchange=function(){Te()},q22.__li.setAttribute('class','cr string bigta');var Ln=Qe(Vi);Ci.rqd=ba('RQD',function(){params.editRQD()}),Ln.appendChild(Ci.rqd),Ci.Jr=ba('Jr',function(){params.editJr()}),Ln.appendChild(Ci.Jr),Ci.Jw=ba('Jw',function(){params.editJw()}),Ln.appendChild(Ci.Jw),Ci.Jn=ba('Jn',function(){params.editJn()}),Ln.appendChild(Ci.Jn),Ci.Ja=ba('Ja',function(){params.editJa()}),Ln.appendChild(Ci.Ja),Ci.SRF=ba('SRF',function(){params.editSRF()}),Ln.appendChild(Ci.SRF);var En=Vi.add(bf,'blank').name('');En.__li.setAttribute('class','cr function qtext'),Ci.Q=En,Vi.add(Ni,'bergart',vi).name(qa.rocktype);var Ln=Qe(Vi),Tn=ba(qa.apply,function(){Te()});Tn.setAttribute('class','inguib but2gui'),Ln.appendChild(Tn);var Tn=ba(qa.removeq,function(){params.removeq()});Tn.setAttribute('class','inguib but2gui'),Ln.appendChild(Tn)}function Fa(){Ji=new dat.GUI({autoPlace:!1,width:Math.min(400,ii/2-4)}),container.appendChild(Ji.domElement),Ji.domElement.id='guipos'}function Da(An,Ln){Yl=An;var Pn=An;Ql?(Pn='3d',globgeo='Settings'):globgeo='Geology',St(),null==Pn&&(Bl=[],chosenp=-2);var En=Ji.closed;if(container.removeChild(Ji.domElement),Ji.destroy(),Fa(),'3d'==Pn){var Tn=Ji.add(bf,'blank').name('Settings:');Tn.onChange(function(){Ji.close()}),Tn.__li.setAttribute('class','cr function first');var On=parseFloat(Ji.domElement.style.width)-1;return Tn.__li.style.width=On+'px',Ji.add(lingeom,'visible').name('Tunnel frame').onChange(function(){ae()}),Rn&&(params.showholes&&(pointval.valmin=23,pMaterial.size=10,pointCloud.geometry.drawRange.start=pointval.ar[pointval.valmin-1],pointCloud.geometry.drawRange.count=pointval.ar[pointval.valmax-1]-pointCloud.geometry.drawRange.start),params.opacity=0.3,meshes.children[0].material.opacity=params.opacity,ae(),Rn=0),params.showholes&&(Ji.add(pointval,'valmin',1,pointval.ar.length).name('Min').step(1).onChange(function(){pointCloud.geometry.drawRange.start=pointval.ar[pointval.valmin-1],pointCloud.geometry.drawRange.count=pointval.ar[pointval.valmax-1]-pointCloud.geometry.drawRange.start,ae()}),Ji.add(pointval,'valmax',1,pointval.ar.length).name('Max').step(1).onChange(function(){pointCloud.geometry.drawRange.count=pointval.ar[pointval.valmax-1]-pointCloud.geometry.drawRange.start,ae()}),Ji.add(pMaterial,'size',5,35).name('Point size').step(1).onChange(function(){ae()})),Ji.add(params,'opacity',0,1).name('Tunnel opacity').step(0.1).onChange(function(){meshes.children[0].material.opacity=params.opacity,ae()}),Ji.add(fscale,'val',0,1).name('Plane size').step(0.02).onChange(function(){for(var Bn in fallar.children)fallar.children[Bn].scale.set(fscale.val,fscale.val,1);ae()}),params.showholes||Ji.add(params,'showholeask').name('Show holes'),void Ji.updateDisplay()}if(Sa(Pn,Ln),null==Ln&&Na(),zt(),'Line'==Pn&&(Zs.setAttribute('class','geobuttonf'),params.linetype='Line',Qi.add(params,'bolt').name(qa.bolt),Qi.add(params,'lineStyle',qa.lineStylear).name(qa.ls),Qi.add(params,'linemagnet').name('Magnet'),params.ex&&Qi.add(params,'size',0.1,1).name('Size').step(0.1),Qi.add(bf,'blank').name('')),'Water'==Pn&&($s.setAttribute('class','geobuttonf'),params.linetype='Water',Qi.add(params,'wsize',0.1,1).step(0.1).name('Size'),Qi.add(bf,'blank').name('')),'Text'==Pn){ei.setAttribute('class','geobuttonf'),params.linetype='Text',q22=Qi.add(params,'text').name(qa.ttp),Qi.add(bf,'blank').name('');var In=q22.domElement.children[0];In.setAttribute('class','myta'),In.placeholder='Text...',En=!1}'Fall'==Pn&&(ti.setAttribute('class','geobuttonf'),params.linetype='Fall',q22=Qi.add(params,'angle',0,360).step(1).name(qa.angle),Qi.add(params,'fall',0,90).step(1).name(qa.fall),Qi.add(bf,'blank').name(''),En=!1),'Bolt'==Pn&&(params.linetype='Bolt',Qi.add(params,'boltlen',1,10).step(0.5).name(qa.len),Qi.add(params,'bolttype',qa.boltlist).name(qa.material),Qi.add(bf,'blank').name('')),'Select'==Pn||'Q - value'==Pn?(li.setAttribute('class','geobuttonf'),params.linetype='Select'):Qi.open(),Ji.updateDisplay(),En?Ee():Pe()}function Va(){for(var An in Rs.children.length=0,oman.ao){var Ln=oman.ao[An];Ln.toskip||'B'!=Ln.type||oman.plot(Ln)}}function Qa(){ya(),xt();for(var An=[],Ln=0;Ln<Xl.length;Ln++)0==Xl[Ln].skip&&An.push(Xl[Ln]);for(var Tn,On,Pn=yprev=cprev=sprev=-1e3,En=[],Ln=0;Ln<An.length;Ln++)if('L'==An[Ln].type)if(Pn==An[Ln].xs&&yprev==An[Ln].ys&&cprev==An[Ln].color&&sprev==An[Ln].size){var In=[An[Ln].xe,An[Ln].ye,An[Ln].zs];Pn=An[Ln].xe,yprev=An[Ln].ye,En.push(In[0]),En.push(In[1]),En.push(In[2])}else N(En,On,Tn),Pn=An[Ln].xe,yprev=An[Ln].ye,cprev=An[Ln].color,sprev=An[Ln].size,En=[An[Ln].xs,An[Ln].ys,An[Ln].zs,Pn,yprev,An[Ln].zs],Tn=An[Ln].color,On=An[Ln].size;N(En,On,Tn)}function Ma(){this.oldzero=1,this.oldppu=1,this.oldpw=1,this.getnewy=function(An){var Pn=La(An);return Pn=mr(Pn),Pn},this.getnewx=function(An){var Ln=An/this.oldpw*Ns;return Ln=mr(Ln),Ln}}function Ca(An,Ln){for(var Pn in Ln)for(var En=Ln[Pn],Tn=0;Tn<En.length;Tn++)if(En[Tn]==An)return''+Pn;return null}function Ra(An){mt.start('Get json');var Ln='object'==typeof An?JSON.parse(JSON.stringify(An)):JSON.parse(An);var Pn=Ln.objdata;mt.end('Get json');var En=new Ma,Tn=Ln.authors,On=Ln.sids,In=Ln.chlist;if(null==In||isEmpty(In))for(var Bn in On)oman.changelist[Bn]=Bn;else for(var Bn in On)oman.changelist[Bn]=In[Bn];En.oldzero=Ln.zeropel,jn=Ln.author,En.oldppu=Ln.pelperunit,En.oldpw=Ln.pw,Jn=Ln.sid,allq.restore(Ln.qval,1);for(var Gn=Ln.pval,Nn=0;Nn<Gn.par.length;Nn++)for(var Bn=0;Bn<Gn.par[Nn].coords.length;Bn+=2)Gn.par[Nn].coords[Bn]=En.getnewx(Gn.par[Nn].coords[Bn]),Gn.par[Nn].coords[Bn+1]=En.getnewy(Gn.par[Nn].coords[Bn+1],1);allp.restore(Gn,1);for(var Xn,_n=Pn.length,Wn=6,Un='#000000',Hn=qy=qz=tmpy=tmpx=-1e3,Bn=0;Bn<_n;Bn++){if(Xn=new Aa,null==On)Xn.sid=Jn;else{var Yn=Ca(Bn,On);Xn.sid=null==Yn?Jn:Yn}if(null==Tn)Xn.author=jn;else{var Yn=Ca(Bn,Tn);Xn.author=null==Yn?jn:Yn}var Kn=Pn[Bn];if(2==Kn.length){tmpx=En.getnewx(Kn[0]/qprec),tmpy=En.getnewy(Kn[1]/qprec),Xn.addline(Hn,qy,qz,tmpx,tmpy,qz,Wn,Un),Hn=En.getnewx(Kn[0]/qprec),qy=En.getnewy(Kn[1]/qprec),oman.isdublicate(Xn),oman.plot(Xn),oman.add(Xn);continue}if(0==Kn[0]){Wn=15,Un='#000000',6<Kn.length&&('number'==typeof Kn[6]&&(Wn=Kn[6]),'string'==typeof Kn[6]&&(Un=Kn[6])),8==Kn.length&&(Un=Kn[7]),Hn=En.getnewx(Kn[4]/qprec),qy=En.getnewy(Kn[5]/qprec),qz=Kn[3],tmpx=En.getnewx(Kn[1]/qprec),tmpy=En.getnewy(Kn[2]/qprec),Xn.addline(tmpx,tmpy,qz,Hn,qy,qz,Wn,Un),oman.isdublicate(Xn),oman.plot(Xn),oman.add(Xn);continue}if(1==Kn[0]){Wn=0.5,3<Wn.length&&(Wn=Kn[3]),tmpx=En.getnewx(Kn[1]/qprec),tmpy=En.getnewy(Kn[2]/qprec),Xn.addwater(tmpx,tmpy,10,Wn),oman.isdublicate(Xn),oman.plot(Xn),oman.add(Xn);continue}if(2==Kn[0]){tmpx=En.getnewx(Kn[1]/qprec),tmpy=En.getnewy(Kn[2]/qprec);var Zn=Kn[4];'_pho_'==Zn.slice(0,5)&&(Xn.fall=1,Zn=Zn.slice(5),console.log(Zn)),'_lab_'==Zn.slice(0,5)&&(Xn.fall=2,Zn=Zn.slice(5)),Xn.addtext(Zn,tmpx,tmpy,Kn[3],1),oman.isdublicate(Xn),oman.plot(Xn),oman.add(Xn);continue}if(3==Kn[0]&&(tmpx=En.getnewx(Kn[1]/qprec),tmpy=En.getnewy(Kn[2]/qprec),Xn.addfall(tmpx,tmpy,10,Kn[3],Kn[4],Kn[5]),null!=Kn[6]&&(Xn.color=[tv(Kn[6][0].x,Kn[6][0].y,Kn[6][0].z),tv(Kn[6][1].x,Kn[6][1].y,Kn[6][1].z),tv(Kn[6][2].x,Kn[6][2].y,Kn[6][2].z)]),oman.isdublicate(Xn),oman.plot(Xn),oman.add(Xn)),4==Kn[0]){Xn.addbolt(En.getnewx(Kn[1]/qprec),En.getnewy(Kn[2]/qprec),Kn[3],En.getnewx(Kn[4]/qprec),En.getnewy(Kn[5]/qprec),Kn[6],Kn[7]),oman.isdublicate(Xn),oman.plot(Xn),oman.add(Xn);continue}}}function Ja(An,Ln,Pn){var En=0.02/Math.abs(kl-Sl);null!=Pn&&(En=Pn);var Tn=Math.abs(parseFloat(An)-parseFloat(Ln));return!!(Tn<En)}function ja(An,Ln){var En=Math.abs(parseFloat(An)-parseFloat(Ln));return En}function Aa(){this.type='',this.sid=wl,this.author=params.author,this.id=0,this.skip=0,this.text='',this.xs=0,this.ys=0,this.zs=0,this.xe=0,this.ye=1,this.ze=1,this.size=3,this.color='',this.fall=0,this.angle=0,this.lastmx=-1e3,this.lastmy=-1e3,this.sameas=function(An){return this.type==An.type&&Ja(this.xs,An.xs)&&Ja(this.ys,An.ys)},this.addline=function(An,Ln,Pn,En,Tn,On,In,Bn){this.type='L',this.size=In,this.color=Bn,this.xs=An,this.ys=Ln,this.zs=Pn,this.xe=En,this.ye=Tn,this.ze=On},this.addbolt=function(An,Ln,Pn,En,Tn,On,In){this.type='B',this.text=In,this.xs=An,this.ys=Ln,this.zs=Pn,this.xe=En,this.ye=Tn,this.ze=On},this.addwater=function(An,Ln,Pn,En,Tn,On,In,Bn){this.type='W',this.size=En,this.xs=An,this.ys=Ln,this.zs=Pn,null!==Tn&&(this.text=Tn),null!==On&&(this.xe=On),null!==In&&(this.fall=In),null!==Bn&&(this.angle=Bn)},this.addfall=function(An,Ln,Pn,En,Tn,On){this.type='F',this.xs=An,this.ys=Ln,this.zs=Pn,this.angle=En,this.fall=Tn,this.size=null==On?_e(Pa(Ln)):On},this.addtext=function(An,Ln,Pn,En){this.type='T',this.text=An,this.xs=Ln,this.ys=Pn,this.zs=En}}function La(An){var Ln=parseFloat(2*(pmult*(An-parseFloat(Dl))*Fl/Gs));return Ln}function Pa(An){var Ln=parseFloat(pmult*An/(2*(Fl/Gs))+Dl);return Ln}function Ea(){var An=new Date,Ln=parseInt(An.getMonth()+1),Pn={date:An.getFullYear()+'-'+az(Ln)+'-'+az(An.getDate()),author:params.author};return Pn}function Ta(An){for(var Ln=[],Pn=[],En={pmult:pmult,pelperunit:1/(2*(Fl/Gs)),zeropel:Dl,pw:Ns,author:params.author,tunnel:An},Tn=new myxml(En),On={type:'w',da:Ea(),coords:[0,1],comment:'',dsc:0,drip:'',leak:''},In={type:'t',da:Ea(),coords:[0,1],comment:'',fall:0},Bn={type:'f',da:Ea(),coords:[0,1],comment:'',angle:0,fall:0},Gn={type:'l',da:Ea(),coords:[0,1],ltype:0,comment:'',bergart:'none',color:'',width:0},Nn={type:'q',da:Ea(),coords:[0,1],QVal:[],bergart:'none',color:0,comment:''},_n=0;_n<allq.qar.length;_n++){var Wn=allq.qar[_n],Un=Nn;Un.da.author=Wn.author,Un.da.date=sid2date(Wn.lastchange),Un.coords=[Wn.ps,Wn.pe],Un.QVal=[Wn.RQD,Wn.Jn,Wn.Jr,Wn.Ja,Wn.Jw,Wn.SRF,Wn.Q],Un.bergart=Wn.bergart,Un.comment=Wn.comment,Un.color=kt(Ce(Wn.bergart)),Tn.parseos(Un)}for(var _n=0;_n<Xl.length;_n++)if(!Xl[_n].skip&&!isinarray(Pn,_n)){var Hn=je(_n);if(!isinarray(Ln,Hn)){var Kn,Xn=Re(_n),Yn=-2<Hn?1:0;Yn&&(Ln.push(Hn),Kn=allp.par[Hn]);var $n,Zn=Xl[_n];if('L'==Xn)if($n=Gn,$n.da.author=Zn.author,$n.da.date=sid2date(Zn.sid),$n.ltype=Zn.color[0],Yn)Kn.isarea&&($n.ltype=5),$n.coords=Kn.coords,$n.comment=Kn.comment,$n.bergart=Kn.bergart,$n.color=Kn.color,$n.width=Kn.width;else{for(var eo=he(_n),to=0;to<eo.length;to++)Pn.push(eo[to]);$n.coords=ge(eo)}'W'==Xn&&($n=On,$n.da.author=Zn.author,$n.da.date=sid2date(Zn.sid),$n.coords=[Zn.xs,Zn.ys],Yn&&(Kn.comment&&($n.comment=Kn.comment),Kn.dsc&&($n.dsc=Kn.dsc),Kn.wdrip&&($n.drip=Kn.wdrip),Kn.wleak&&($n.leak=Kn.wleak))),'T'==Xn&&($n=In,$n.da.author=Zn.author,$n.da.date=sid2date(Zn.sid),$n.coords=[Zn.xs,Zn.ys],$n.comment=Zn.text,$n.fall=Zn.fall),'B'==Xn&&($n=In,$n.da.author=Zn.author,$n.da.date=sid2date(Zn.sid),$n.coords=[Zn.xs,Zn.ys],$n.comment='B'),'F'==Xn&&($n=Bn,$n.da.author=Zn.author,$n.da.date=sid2date(Zn.sid),$n.coords=[Zn.xs,Zn.ys],$n.angle=Zn.size?Zn.angle:360-Zn.angle,$n.fall=Zn.fall),Tn.parseos($n)}}return Tn.showstrout()}function Oa(An,Ln){for(var Pn=[],En=[],Tn=JSON.parse(JSON.stringify(An)),On=0;On<Tn.length;On++)if(!isinarray(En,On)){var In=params.onlynew&&!Ln?Tn[On].sid==wl:1;1<params.onlynew&&(In=Tn[On].sid==params.onlynew?1:0);var Bn=1;if(params.onlycurpel&&!Ln&&!Ya(Pa(Tn[On].ys))){var Gn=he(On);add2array(En,Gn),Bn=0}!Tn[On].skip&&In&&Bn&&Pn.push(Tn[On])}return Pn}function Ia(An){var Ln=0;null!=An&&(Ln=An);var Pn=Oa(Xl,Ln),En=new fe;En.lastchange=oman.changelist[params.onlynew],null==En.lastchange&&(En.lastchange=wl),En.zeropel=Dl,En.pelperunit=Fl*pmult,En.pw=Ns,En.pelstart=kl,En.pelend=Sl,En.author=params.author,En.authors={},En.sid=wl,En.sids={},En.tunnel=params.tunnel;var Tn=new We;Ln?Tn.restore(allq,1):Tn.restore(allq,1,params.onlynew),En.qval=Tn;var On=new Ge;On.restore(allp,1,params.onlynew&&!Ln),Ln?On.restore(allp,1):On.restore(allp,1,params.onlynew),On.cleanFromQ(),On.y2pelcoords(),params.onlycurpel&&On.cleanFromPel(),En.pval=On;for(var In=yprev=cprev=sprev=-1e3,Bn=0;Bn<Pn.length;Bn++)Pn[Bn].ys=Pa(Pn[Bn].ys),Pn[Bn].ye=Pa(Pn[Bn].ye);for(var Gn,Bn=0;Bn<Pn.length;Bn++){Gn=Pn[Bn].author,null==En.authors[Gn]?En.authors[Gn]=[Bn]:En.authors[Gn].push(Bn);var Nn=Pn[Bn].sid;if(null==En.sids[Nn]?En.sids[Nn]=[Bn]:En.sids[Nn].push(Bn),'L'==Pn[Bn].type){if(In==Math.round(Pn[Bn].xs*qprec)&&yprev==Math.round(Pn[Bn].ys*qprec)&&cprev==Pn[Bn].color&&sprev==Pn[Bn].size){var _n=[Math.round(Pn[Bn].xe*qprec),Math.round(Pn[Bn].ye*qprec)];In=Math.round(Pn[Bn].xe*qprec),yprev=Math.round(Pn[Bn].ye*qprec)}else{In=Math.round(Pn[Bn].xe*qprec),yprev=Math.round(Pn[Bn].ye*qprec),cprev=Pn[Bn].color,sprev=Pn[Bn].size;var _n=[0,Math.round(Pn[Bn].xs*qprec),Math.round(Pn[Bn].ys*qprec),Pn[Bn].zs,In,yprev];6!=Pn[Bn].size&&_n.push(Pn[Bn].size),'#000000'!=Pn[Bn].color&&_n.push(Pn[Bn].color)}En.objdata.push(_n)}if('W'==Pn[Bn].type){In=-1e3;var _n=[1,Pn[Bn].xs*qprec,Pn[Bn].ys*qprec];0.5!=Pn[Bn].size&&_n.push(Pn[Bn].size),En.objdata.push(_n)}if('T'==Pn[Bn].type){In=-1e3;var Wn=Pn[Bn].text;1==Pn[Bn].fall&&(Wn='_pho_'+Wn),2==Pn[Bn].fall&&(Wn='_lab_'+Wn);var _n=[2,Pn[Bn].xs*qprec,Pn[Bn].ys*qprec,Pn[Bn].zs,Wn];En.objdata.push(_n)}if('F'==Pn[Bn].type){if(In=-1e3,''!=Pn[Bn].color)var _n=[3,Pn[Bn].xs*qprec,Pn[Bn].ys*qprec,Pn[Bn].angle,Pn[Bn].fall,Pn[Bn].size,Pn[Bn].color];else var _n=[3,Pn[Bn].xs*qprec,Pn[Bn].ys*qprec,Pn[Bn].angle,Pn[Bn].fall,Pn[Bn].size];En.objdata.push(_n)}if('B'==Pn[Bn].type){In=-1e3;var _n=[4,Pn[Bn].xs*qprec,Pn[Bn].ys*qprec,Pn[Bn].zs,Pn[Bn].xe*qprec,Pn[Bn].ye*qprec,Pn[Bn].ze,Pn[Bn].text];En.objdata.push(_n)}}var Un=Object.keys(En.authors).length;if(1==Un){var Hn=Ca(0,En.authors);null!=Hn&&(En.author=Ca(0,En.authors)),null==En.authors}var Xn=Object.keys(En.sids).length;if(1==Xn){var Hn=Ca(0,En.sids);null!=Hn&&(En.sid=Ca(0,En.sids)),null==En.sids}for(var Yn in En.chlist={},En.sids){var Gn=oman.changelist[Yn];console.log('Element of changelist',Yn,Gn),null!=Gn&&(En.chlist[Yn]=Gn)}return console.log('Saved change list',En.chlist),0==En.qval.qar.length&&console.log('No Q to save'),0==En.pval.par.length&&console.log('No Props to save'),0==En.objdata.length&&console.log('No registrations to save'),0==En.objdata.length&&0==En.pval.par.length&&0==En.qval.qar.length&&(En=0),En}function Ba(An,Ln){if(Ri=1,renderblock=1,Ln>=An.files.length)return Xs.value=null,allq.update(),Qa(),renderblock=0,ae(),void(Ri=0);var Pn=new FileReader;Pn.onload=function(En){return 1==An.files.length&&params.overridepel?(console.log('open one blank file'),openblankimage(En.target.result),Ri=0,void(renderblock=0)):void(Ra(En.target.result),console.log('Done reading ',Ln),Ba(Xs,Ln+1))},Pn.readAsText(An.files[Ln])}function Na(){Ds.visible=!1,Wl=yp=zp=-1e3,Is=-1,Vs.visible=!1}function _a(An,Ln){var En=180*(Math.atan2(An-Xl[Xl.length-1].xs,Ln-Xl[Xl.length-1].ys)/Math.PI);En=Math.round(En),0>En&&(En=360+En),as.rotation=Math.round(1e3*(-Math.PI/180*En))/1e3,params.angle=En,Xl[Xl.length-1].angle=En,Ji.updateDisplay(),oman.updchangelist(Xl[Xl.length-1].sid)}function Wa(An,Ln,Pn,En,Tn,On){var In=new THREE.CircleGeometry(En,32,Math.PI/4,2.12*Math.PI),Bn=new THREE.Line(In,new THREE.LineBasicMaterial({color:On,linewidth:Tn}));return Bn.position.set(An,Ln,Pn),Bn}function Ua(An,Ln,Pn){var Tn=0;null!=Ln&&(Tn=kt(Ln,1));var On='object'==typeof Pn?Pn.val:1,In=new THREE.TextSprite({textSize:0.25*Hs*On,redrawInterval:1e7,texture:{text:An+'',fontFamily:'Arial, Helvetica, sans-serif, Bold',fontWeight:'bold',autoRedraw:!1},material:{color:Tn,fog:!1}});return 15!=On&&Rl.push(In),In.position.set(0,0,1),fcp&&(setTimeout(function(){ae()},100),fcp=0),In}function Xa(){Te(),Ve(),Pe()}function Ya(An){var Ln=picparams.ps,Pn=picparams.pe;if(0<pmult){if(An>=Ln&&An<=Pn)return!0;}else if(An>=Pn&&An<=Ln)return!0;return!1}function Ka(An,Ln,Pn){var En=Ln,Tn=Pn;if(Pn>Ln){if(An>=En&&An<=Tn)return!0;}else if(An>=Tn&&An<=En)return!0;return!1}(function(){try{var An=new FormData,Ln=window.XMLHttpRequest?new XMLHttpRequest:new activeXObject('Microsoft.XMLHTTP');Ln.open('get',baseaddr+'getip.php',!0),Ln.send('')}catch(Pn){console.log(Pn)}})();var $a=window.getComputedStyle(document.body,null).getPropertyValue('--myyellow'),el=window.getComputedStyle(document.body,null).getPropertyValue('--myblack'),sl=window.getComputedStyle(document.body,null).getPropertyValue('--mybackground'),il,rl;this.getrs=function(){return il},this.callresultstring=function(An){le(An)},this.getrp=function(){return rl},this.callresultpic=function(An){oe(An)},this.loadlines=function(An){Ra(An),allq.update(),Qa(),ae()},this.setauthor=function(An){params.author=An,Ji.updateDisplay()},this.showvederlag=function(){console.log('vederlag to be done')},this.makenovaxml=function(An,Ln){console.log('novaxmlto to be done'),Ln},this.getnxml=function(){return'to be xml text'},this.show3d=function(){it()},this.show2d=function(){rt()};var ul=S.picsizex,hl=S.picsizey,gl=S.picadress;gl='';var yl=gl,fl=S.tung,vl=S.ling,wl=getsessionid();newdb=new mydb,newdb.ldb(),picdb=new mypicdb,6>picdb.files.length&&(picdb.files=picfiles,picdb.sdb()),tungeom.Tunnel1=tungeom1.Tunnel1;var kl=S.pelstart,Sl=S.pelend,zl=Math.abs(parseInt(kl)-parseInt(Sl)),Fl=50;11>zl&&(Fl=100),6>zl&&(Fl=200),hl=Fl*zl;var Dl=S.zeropel,Vl=S.picpack,Ql=!1,Ml=ul,Cl=hl,Rl=[];container=condiv();var Jl,jl=new THREE.Raycaster,Al=new THREE.Vector2,Pl=0,El=0,Tl=0,Bl=[],Wl=yp=zp=-1e3,Ul=yp2d=zp2d=-1e3,Hl=[],Xl=[],Yl='Line';oman=new C;var Kl=function(){return{s:'bevgsave1',l:'bevgsave1'}}(),Zl=new function(){this.idx=[],this.type=[],this.remprev=[],this.xl=[],this.yl=[],this.add=function(An,Ln,Pn){this.idx.push(An),this.type.push(Ln),this.remprev.push(Pn),this.xl.push(0),this.yl.push(0)},this.addMove=function(An,Ln,Pn,En,Tn){this.idx.push(An),this.type.push(Ln),this.remprev.push(Pn),this.xl.push(En),this.yl.push(Tn)},this.removelast=function(){this.type.splice(this.type.length-1,1),this.idx.splice(this.idx.length-1,1),this.remprev.splice(this.remprev.length-1,1),this.xl.splice(this.xl.length-1,1),this.yl.splice(this.xl.length-1,1)}},$l,es,as,ds,us,ms=0,fs=lastmovey=-1e3,bs=0;Detector.canvas||alert('Browser does not support canvas 3d'),Jl=new THREE.Scene;var ks=new THREE.Scene,Ss=new THREE.Scene,Fs=Jl,Ds=new THREE.Object3D,Vs=new THREE.Object3D,Qs=new THREE.Object3D,Ms=new THREE.Object3D,Cs=new THREE.Object3D,Rs=new THREE.Object3D,Js=new THREE.Object3D,js=new THREE.Object3D,As=new THREE.Object3D,Ls=new THREE.Object3D,Ps;fallar=new THREE.Object3D,line3dgroup=new THREE.Object3D,line3dtemp=new THREE.Object3D,Jl.add(Js),Jl.add(js),Jl.add(As);var Es=new THREE.Object3D,Ts=new THREE.Object3D,Os=new THREE.Object3D,Is=-1;Ds.visible=!1,Vs.visible=!1,pmult=kl<Sl?1:-1;var Gs=200,Ns=ul/200,_s=hl/Gs,Ws=0,Us=1,Hs=1,Xs=document.createElement('input');document.body.appendChild(Xs),Xs.type='file',Xs.accept='.txt',Xs.multiple=!0,Xs.style.display='none',Xs.onchange=function(){if(console.log('Start file read'),null==this.files[0])return void console.log('No files chosen');var An=this.files[0].name,Ln=pelfromfname(An);params.overridepel&&saveifokdist(Ln[0],Ln[1]),('t'==An[An.length-1]||'T'==An[An.length-1])&&Ba(this,0)};var Ys=document.createElement('input');document.body.appendChild(Ys),Ys.type='file',Ys.style.display='none',Ys.onchange=function(){if(null==this.files[0])return void console.log('No photo chosen');var An=this.files[0].name;('g'==An[An.length-1]||'G'==An[An.length-1])&&Y(this)};var Ks=new Image,Zs=document.getElementById('linbtn'),$s=document.getElementById('watbtn'),ei=document.getElementById('txtbtn'),ti=document.getElementById('falbtn'),li=document.getElementById('selbtn'),si=document.getElementById('undbtn');renderer=new THREE.WebGLRenderer({antialias:!1,alpha:!0,premultipliedAlpha:!0}),renderer.setPixelRatio(window.devicePixelRatio),renderer.setClearColor(kt(sl,1));var ii,oi;z();var ri=new THREE.Vector2(ii,oi);renderer.setSize(ii,oi),document.getElementById(h).appendChild(renderer.domElement);var di=document.getElementById(h).offsetTop,pi=document.getElementById(h).offsetLeft,ci=ii/oi,ui=2.5*_s*Math.sqrt(2.28/(_s/Ns)),hi=ui;Jl.add(Qs),Jl.add(Es),Jl.add(Os),Jl.add(Ts),Jl.add(Cs),Jl.add(Rs),Jl.add(Ms),camera=new THREE.OrthographicCamera(-ui*ci/2,ui*ci/2,hi/2,-hi/2,-5e3,5e3),controls=new THREE.OrbitControls(camera,renderer.domElement),controls.enableDamping=!1,controls.dampingFactor=0.3,controls.enableRotate=!1,controls.rotateSpeed=0.45,controls.zoomSpeed=1,android||iOS||(controls.zoomSpeed=3);var gi=1;controls.target.set(0,0,0),camera.position.set(0,0,gi);camera.zoom;controls.addEventListener('change',function(){Xt(1)}),controls.addEventListener('end',function(){Xt(1)}),cameraFix=new THREE.OrthographicCamera(-ui*ci/2,ui*ci/2,hi/2,-hi/2,-5e3,5e3);var fi,bi;ca(gl,0),function(){var An=0.07*Hs,Ln=0.14*Hs,Pn=_(-An,-An,10,An,An,10,8*Hs,'#000000'),En=_(An,-An,10,-An,An,10,8*Hs,'#000000');Ds.add(Pn,En),Jl.add(Ds);var Tn=_(-Ln,-Ln,10,Ln,-Ln,10,5*Hs,'#000000'),On=_(Ln,-Ln,10,Ln,Ln,10,5*Hs,'#0000ff'),In=_(Ln,Ln,10,-Ln,Ln,10,5*Hs,'#ff0000'),Bn=_(-Ln,Ln,10,-Ln,-Ln,10,5*Hs,'#00ff00');Vs.add(Tn,On,In,Bn),Jl.add(Vs)}();var vi=['none','Hornfels','Svartskifer','Sill','Spr\xF8ytebetong','Special','Weakness','Basalt','Calcite','Granite','Pyrite'],xi=['#ffffff','#D0D470','#817A85','#EDA155','#877D7B','#ED4AE8','#771111','#000000','#aaffaa','#aa7777','#ff2222'],Fi,Vi,Qi,Mi,Ci={rqd:'',Jn:'',Jr:'',Ja:'',Jw:'',SRF:'',Q:''},Ri=0;(android||iOS)&&setInterval(function(){gt()},3e4),params={ex:!1,restses:1,loadprev:function(){myask(container,qa.unsaved,function(){M(),yt()})},savexml:function(){ka(params.tunnel)},forcesync:!1,enrot:!1,linetype:'Line',linemagnet:!0,lineStyle:qa.lineStylear[0],tunnel:picparams.ps>tunborder?'Bamble':'Kjorholt',vederlag:!1,text:'',author:'V',onlynew:!1,onlycurpel:!1,rutenett:!1,size:0.5,wsize:0.5,opacity:0.5,angle:0,fall:45,layer:0,showholes:!1,showholeask:function(){myask(container,'This will take up to 10 seconds calculations.',function(){params.showholefunc()})},showholefunc:function(){params.showholes=!0,''!=strin&&(!android&&(strin=strin2),Ls=makecloud(strin));var An=getglobc((kl+Sl)/2),Ln=new THREE.Object3D;Ln.add(Ls),Ln.position.set(-An.x,-An.y,-An.z),my3dgroup.add(Ln),ae(),Da('3d')},move:!1,movestart:!1,color:'#000000',parcolor:'#000000',savealpha:function(){tt(),Xt(null,1),ae();var An=renderer.domElement.toDataURL(),Ln=new Date,Pn='';Pn=Pn+'geo'+Ln.getHours()+'h'+Ln.getMinutes()+'m'+Ln.getSeconds()+'s.png',zn(An,Pn),ut(),lsc=1,Qa()},what2plot:'Geo+Q+Pel',withbg:!0,showbergart:!0,tstval:45,bolt:function(){li.value='Select',Da('Bolt')},boltlen:5,bolttype:'Steel',wtxt:'',dsc:'Not given',wleak:0,wdrip:0,save:function(){var An='Save all registrations as \n'+params.tunnel+' tunnel?';myask(container,An,function(){params.onlynew=!1,disassemble(),Ji.updateDisplay()})},textsave:'',clear:function(){myask(container,qa.unsaved,function(){M()})},load:function(){Ra(params.textsave),ae()},go3d:it,go2d:rt,getflist:function(){xa()},add5m:function(){fgui.close(),Ji.close(),dt()},resetcam:function(){Ji.updateDisplay(),controls.reset(),controls.target.set(0,0,0),camera.position.set(0,0,gi),Na(),ae()},openfile:function(){params.overridepel?myask(container,qa.unsaved,function(){Xs.click()}):Xs.click()},overridepel:!0,openfoto:function(){Ys.click()},makelab:function(){Z(Is,qa.labtest,2),Ji.updateDisplay()},dummy:function(){},apply:function(){Te()},applyP:function(){Ie()},qedit:function(){},editRQD:function(){rqdmenu(Ni,container,Xa)},editJn:function(){jnmenu(Ni,container,Xa)},editJr:function(){jrmenu(Ni,container,Xa)},editJa:function(){jamenu(Ni,container,Xa)},editJw:function(){jwmenu(Ni,container,Xa)},editSRF:function(){srfmenu(Ni,container,Xa)},removeq:function(){myask(container,qa.removeqmes,function(){Oe()})}},params.author=function(){return localStorage.getItem('lastauthor')?localStorage.getItem('lastauthor'):'none'}(),params.tunnel=gettunnel()?gettunnel():tunlist[0];var Ji=new dat.GUI({autoPlace:!1});Ji.domElement.id='guipos',Ji.close(),container.appendChild(Ji.domElement),Da('Line'),lasst=params.tunnel,myaddfunc.flip=function(){renderblock=1;var An=gt();M();var Ln=picparams.ps;picparams.ps=picparams.pe,picparams.pe=Ln,fgui.updateDisplay(),saveifokdist(picparams.ps,picparams.pe),''==gl?ra(picparams.ps,picparams.pe):oa(picparams.ps,picparams.pe),An&&yt(),renderblock=0,ae(),Da('Line'),li.value='Select',fgui.close(),Ji.close()},myaddfunc.openblank=function(){console.log('Oblank'),fgui.close(),myask(container,qa.unsaved,function(){getbypl(picparams.ps,picparams.pe)})};var ji={showdb:function(){var An=function(){for(var Pn=0,En=0;En<newdb.files.length;En++)newdb.files[En].ischosen&&!newdb.files[En].toskip&&Pn++;if(Pn){if(params.overridepel){var Tn=getchosenpels(newdb),On=Tn[0],In=Tn[1];picparams.ps=On,picparams.pe=In,fgui.updateDisplay(),saveifokdist(picparams.ps,picparams.pe),ra(picparams.ps,picparams.pe)}var Bn=0;renderblock=1;for(var Gn,En=0;En<newdb.files.length;En++)Gn=newdb.files[En],Gn.ischosen&&!newdb.files[En].toskip&&(Bn++,Ra(Gn.savedata));Qa(),allq.update(),renderblock=0,ae(),newdb.uncheckall(),Da('Line')}};dbtable(container,function(){params.ex?myask3(container,qa.openneworex,qa.opennew,function(){params.overridepel=!0,An(),Ji.updateDisplay()},qa.opentoexisting,function(){params.overridepel=!1,An()}):(An(),Ji.updateDisplay())})},showpicdb:function(){dbpictable(container,Ai)},newblank:function(){oa(picparams.ps,picparams.pe)}};picparams.openf=function(){myask(container,qa.unsaved,function(){picdb.makefromfiles(function(){for(var An in picdb.sortbytime(),picdb.files)if(!picdb.files[An].toskip){picdb.files[An].ischosen=1;break}Ai(1)})})};var Ai=function(An){var Ln=getchosenpels(picdb);if(null!=Ln){var Pn=Ln[0],En=Ln[1],Tn=Ln[2];picparams.ps=Pn,picparams.pe=En,fgui.updateDisplay(),saveifokdist(picparams.ps,picparams.pe),console.log('Chosen are',picparams.ps,picparams.pe),An?getbypl(picparams.ps,picparams.pe):ra(picparams.ps,picparams.pe,Tn),Et(),picdb.uncheckall()}},Li=Qe(fgui),Pi=ba('Start!',function(){myaddfunc.openblank()});Pi.setAttribute('class','inguib but1gui aguibut'),Li.appendChild(Pi);var Li=Qe(fgui),Pi=ba('Flip pic',function(){myaddfunc.flip()});Pi.setAttribute('class','inguib but2gui'),Li.appendChild(Pi),Pi=ba('Add 5m',function(){params.add5m()}),Pi.setAttribute('class','inguib but2gui'),Li.appendChild(Pi);var Li=Qe(fgui),Pi=ba('MWDdb',function(){ji.showpicdb()});Pi.setAttribute('class','inguib but2gui aguibut'),Li.appendChild(Pi),Pi=ba('Open geom',function(){picparams.openf()}),Pi.setAttribute('class','inguib but2gui aguibut'),Li.appendChild(Pi);var Li=Qe(fgui),Pi=ba('Go 2d',function(){params.go2d()});Pi.setAttribute('class','inguib but2gui'),Li.appendChild(Pi),Pi=ba('Go 3d',function(){params.go3d()}),Pi.setAttribute('class','inguib but2gui'),Li.appendChild(Pi),fgui.add(params,'tunnel',tunlist).name('Tunnel:').onChange(function(){savetunnel(params.tunnel),Et()}),fgui.add(params,'vederlag').name(qa.showved).onChange(function(){Qa(),ae()}),fgui.add(params,'rutenett').name(qa.rutenett).onChange(function(){vt(kl,Sl),ae()}),E(kl,Sl),vt(kl,Sl);var Ei=new THREE.TextureLoader;Ei.crossOrigin='anonymous';var Ti=Ei.load(spcline),Oi=Ei.load(spcline1,function(){Oi.wrapS=Oi.wrapT=THREE.RepeatWrapping,Oi.offset.set(0,0),Oi.repeat.set(1,1)}),Ii=Ei.load(spcline2,function(){Ii.wrapS=Ii.wrapT=THREE.RepeatWrapping,Ii.offset.set(0,0),Ii.repeat.set(1,1)}),Gi=new Aa,Ni=new Ue,_i=new Be;Ni.getQ(),allq=new We,allp=new Ge;var Wi=chosenp=-2;ua(kl,Sl,-1);var Ui=0,Hi=new Hammer(Zs);Zs.onclick=function(){if(Ui)return void(Ui=0);var Ln=0,Pn=Ji.closed;'Line'==params.linetype&&(Ln=1),Da('Line'),D(this),Ln&&P(),Pn&&Ji.close(),Ji.removeFolder(qa.qval),Ji.removeFolder(qa.setproperties),li.value='Select'},(iOS||android)&&Hi.on('press',function(){Zs.click(),Ui=1,setTimeout(function(){Ui=0},250)}),Hi.get('press').set({threshold:100,time:3});var Xi=new Hammer($s);$s.onclick=function(){return Ui?void(Ui=0):void(Da('Water'),li.value='Select',D(this))},(iOS||android)&&Xi.on('press',function(){$s.click(),Ui=1,setTimeout(function(){Ui=0},250)}),Xi.get('press').set({threshold:100,time:3});var Yi=new Hammer(ei);ei.onclick=function(){Da('Text'),li.value='Select',D(this)},(iOS||android)&&Yi.on('press',function(){ei.click(),Ui=1,setTimeout(function(){Ui=0},250)}),Yi.get('press').set({threshold:100,time:3});var Ki=new Hammer(ti);ti.onclick=function(){return Ql?void Ut():void(Da('Fall'),li.value='Select',D(this))},(iOS||android)&&Ki.on('press',function(){ti.click(),Ui=1,setTimeout(function(){Ui=0},250)}),Ki.get('press').set({threshold:100,time:3});var Zi=new Hammer(si);si.onclick=function(){android&&me(),li.value='Select',zt()},Zi.on('press',function(){android||(me(),li.value='Select',Ui=1,setTimeout(function(){Ui=0},250))}),Zi.get('press').set({threshold:100,time:3});var $i=0,en=new Hammer(li);android&&(li.onclick=function(){$i||tn(1)}),en.on('press',function(){tn(0),$i=1,setTimeout(function(){$i=0},250)}),en.get('press').set({threshold:100,time:3});var tn=function(){return'Select'==li.value?(li.value='Group',void Da('Select')):'One'==li.value?void(li.value='Group'):'Group'==li.value?void(li.value='One'):void 0};Ee();Jl.children.length;document.addEventListener('keydown',function(An){switch(An.keyCode){case 65:params.showholefunc();break;case 66:break;case 67:break;case 68:}},!1),window.addEventListener('resize',ut,!1),window.addEventListener('orientationchange',ut,!1);var nn=null,rn=new Hammer(renderer.domElement),dn=lasty=-1e3,cn=firsty=firstz=-1e3,un=endy=-1e3;rn.on('press',function(An){bs=new Date().getTime(),R(An),Qa()}),rn.on('pan',function(An){if('Line'==params.linetype){var Ln=(dn-An.center.x+pi)*(dn-An.center.x+pi)+(lasty-An.center.y+di)*(lasty-An.center.y+di);Ln>sensivity*sensivity&&R(An)}if('Select'==params.linetype){if(Pl)return;var Ln=(dn-An.center.x+pi)*(dn-An.center.x+pi)+(lasty-An.center.y+di)*(lasty-An.center.y+di),Pn=An.velocityX*An.velocityX+An.velocityY*An.velocityY;20<Pn&&(de(),Pl=1),params.move&&5>Pn&&(1e4<Ln||params.movestart)&&(R(An),params.movestart=!0)}'Bolt'==params.linetype&&R(An),'Fall'==params.linetype&&R(An)}),rn.on('panstart',function(){El=1,Tl=1,Pl=0,params.move=!0,params.movestart=!1,!Ql||controls.enableRotate}),rn.on('panend',function(){'Line'==params.linetype&&(Na(),bs=new Date().getTime()),params.move=!1,Qa(),ae(),Pl=0,El=0,Tl=0,Ql}),rn.on('pinchstart',function(){clearTimeout(nn),nn=null,Na()}),V();ae();var Ei=new THREE.TextureLoader;Ei.crossOrigin='anonymous';var gn=Ei.load(Vl.imdrop),mn=new THREE.SpriteMaterial({map:gn,color:16777215}),yn=Ei.load(Vl.fallMap),fn=Ei.load(Vl.fallMapA180),bn=Ei.load(Vl.fallMapF0),xn=Ei.load(imflask),wn=Ei.load(imphoto),kn=new THREE.SpriteMaterial({map:xn}),Sn=new THREE.SpriteMaterial({map:wn}),zn=function(An,Ln){var Pn=document.createElement('a');'string'==typeof Pn.download?(document.body.appendChild(Pn),Pn.download=Ln,Pn.href=An,Pn.click(),document.body.removeChild(Pn)):location.replace(uri)};var Fn=function(An,Ln){var Pn=new THREE.Vector3().subVectors(Ln,An),En=new THREE.Matrix4;En.lookAt(An,Ln,new THREE.Object3D().up);var Tn=new THREE.Matrix4;Tn.set(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),En.multiply(Tn);var On=new THREE.CylinderGeometry(0.1,0.1,Pn.multiplyScalar(0.3).length(),48,1),In=new THREE.Mesh(On,new THREE.MeshBasicMaterial({color:0}));In.applyMatrix(En);var Bn=new THREE.Vector3().addVectors(An,Pn.multiplyScalar(0.5));return In.position.set(Bn.x,Bn.y,Bn.z),In},qn=function(An,Ln){var Pn,En,Tn,On,In,Bn,Gn,Nn,_n,Wn,Un,Hn,Xn,Yn;for(Xn=[],Gn=An.geometry.faceVertexUvs[0],Nn=An.geometry.faces,_n=An.geometry.vertices,Wn=new THREE.Matrix4,Un=new THREE.Matrix4,Yn=new THREE.Matrix4,ks.updateMatrixWorld(!0),On=0;On<Gn.length;On++)if(In=Gn[On],Bn=Nn[On],et(In,Ln)){Pn=_n[Bn.a].clone().applyMatrix4(An.matrixWorld),En=_n[Bn.b].clone().applyMatrix4(An.matrixWorld),Tn=_n[Bn.c].clone().applyMatrix4(An.matrixWorld),Wn.set(Pn.x,Pn.y,Pn.z,0,En.x,En.y,En.z,0,Tn.x,Tn.y,Tn.z,0,0,0,0,1),Un.set(In[0].x,In[0].y,0,1,In[1].x,In[1].y,0,1,In[2].x,In[2].y,0,1,0,0,1,0),Un.getInverse(Un),Wn.multiplyMatrices(Un,Wn),Wn.elements=Ke(Wn),Wn.transpose(),Hn=new THREE.Vector3(Ln.x,Ln.y,1);var Kn=Hn.applyMatrix4(Wn);Xn.push(Kn),Xn.push(Bn.normal)}return Xn};check3dbox.onchange=function(){controls.enableRotate=check3dbox.checked,Ji.updateDisplay()},syncfun=function(Ln,Pn){var En=function(){putdbf(Ln),wl=getsessionid()},Tn=function(){mt.end('Merging'),newdb.syncall(),En()},On=function(Bn){mt.start('Merging'),syncbtn.textContent='Merge start',newdb.wipeold(function(){newdb.mergewithstring(Bn,Tn)})};getver(function(Bn){var Gn=Bn[0];console.log('localver=',newdb.getsid(),'onlinever',Gn);var Nn=!0;for(var _n in newdb.files)Nn=Nn&&newdb.files[_n].issynced;syncbtn.textContent='Got versions',newdb.getsid()!=Gn||!Nn||params.forcesync?(syncbtn.textContent=newdb.getsid()+' '+Gn,getdbf(On)):(console.log('Version is up to date'),syncbtn.textContent='Version is up to date',null!=Pn&&Pn())})};getbypl=function(Ln,Pn){var En=normPel(Ln,Pn),Tn=En[0],On=En[1],In=Tn,Bn=On,Gn=newdb.sorted;newdb.sortbypelasc();var Nn=[],_n=JSON.parse(JSON.stringify(newdb.files));for(var Wn in _n){var Un=_n[Wn];if(!Un.toskip){var Hn=normPel(Un.ps,Un.pe);numintersect(Tn,On,Hn[0],Hn[1])&&(In=Math.min(In,Tn,On,Hn[0],Hn[1]),Bn=Math.max(Bn,Tn,On,Hn[0],Hn[1]),Nn.push(Un.savedata))}}for(var Wn in newdb.sortbytime(),ra(In,Bn),renderblock=1,Nn)Ra(Nn[Wn]);Qa(),allq.update(),renderblock=0,ae()};var Vn,Mn;Et();var Cn=[],Rn=1,Jn,jn;cutpels=function(){params.onlycurpel=!0;var An=Ia();M(),Ra(An),Qa(),allq.update(),ae(),params.onlycurpel=!1},disassemble=function(){var An=Ia();console.log('Sids are',An.sids);var Ln=[];for(var Pn in An.sids)Ln.push(Pn);for(var En in Ln)params.onlynew=parseInt(Ln[En]),En==Ln.length-1?le(1):le(1,1);params.onlynew=0,se()},dat.GUI.prototype.removeFolder=function(An){var Ln=this.__folders[An];Ln&&(Ln.close(),this.__ul.removeChild(Ln.domElement.parentNode),delete this.__folders[An],this.onResize())},S.callback(),picdb.ldb(function(){ra(picparams.ps,picparams.pe,params.tunnel)})}