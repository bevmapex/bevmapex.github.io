function bevgeoplot(h,S){function z(){ii=document.getElementById(h).offsetWidth,oi=document.getElementById(h).offsetHeight}function F(jn){var Ln=jn.add(bf,'blank').name('').__li;Ln.setAttribute('class','cr function mydum')}function D(){}function V(){rn.get('tap').set({threshold:1,posThreshold:1,time:1,interval:2}),rn.get('press').set({threshold:50,time:3}),rn.get('pan').set({threshold:sensivity,time:4,direction:Hammer.DIRECTION_ALL}),rn.get('pinch').set({enable:!0})}function Q(jn,Ln){var Pn=null==Ln?Jl:Ln;if(null==jn)return console.log('Null object!'),null;for(var En,Tn=0;Tn<Pn.children.length;Tn++)if(Pn.children[Tn].uuid==jn){En=Pn.children[Tn];break}return En}function M(){line3dtemp.children.length=0,line3dgroup.children.length=0,fallar.children.length=0,Ds.visible=!1,Wl=yp=zp=-1e3,un=-1e3,renderblock=1;for(var jn=0;jn<oman.ao.length;jn++)oman.removefromscene(oman.get(jn));Xl=[],oman=new C,ga(),allp=new Ge,allq=new We,Qa(),allq.update(),renderblock=0,ae()}function C(){this.ao=Xl,this.history=[],this.sid=wl,this.so=null,this.sp=null,this.selidx=null,this.changelist={},this.updchangelist=function(jn){this.changelist[jn]=wl},this.select=function(jn,Ln){this.so=null,this.sp=null,this.selidx=null;var Pn=be(jn,Ln);if(Pn[3]>Math.sqrt(_s*_s+Ns*Ns)/7)return console.log('Nothing selected'),[null,null];var En=Pn[0];return this.selidx=En,this.so=this.get(En),this.so||console.log('No object selected'),this.sp=allp.par[Ae(En)],this.sp||console.log('No property selected'),Vs.visible=!!this.so,[this.so,this.sp]},this.get=function(jn){var Ln=this.ao[jn];return null==Ln?(console.log('No object ',jn),null):Ln},this.add=function(jn){this.ao.push(jn)},this.undo=function(){var jn=this.history.pop();return jn?void('add'==jn[0]&&(this.removefromscene(jn[1]),this.history.pop()),'remove'==jn[0]&&(this.plot(jn[1]),this.history.pop()),'removeSequence'==jn[0]&&(this.plot(jn[1]),this.history.pop(),'removeSequence'==this.history[this.history.length-1][0]&&this.undo()),'movefrom'==jn[0]&&this.move(jn[1],jn[2],jn[3]),Qa(),ae()):void console.log('No history elements')},this.move=function(jn,Ln,Pn){if(null==jn)return void console.log('Trying to move null object');var En=Q(jn.id,'B'==jn.type?Rs:null);if(En){var Tn=Ln-jn.xs,On=Pn-jn.ys;En.position.x+=Tn,En.position.y+=On,params.movestart||this.history.push(['movefrom',jn,jn.xs,jn.ys]),jn.xs=Ln,jn.ys=Pn,Vs.visible=!0,Vs.position.set(Ln,Pn,10),this.updchangelist(jn.sid)}},this.erasefromhistory=function(jn){for(var Ln=0;Ln<this.history.length;Ln)this.history[Ln][1].sameas(jn)?this.history.splice(Ln,1):Ln++},this.removefromscene=function(jn,Ln){if(1==jn.skip)return!1;if('L'==jn.type)return jn.skip=1,Ln?this.history.push(['removeSequence',jn]):this.history.push(['remove',jn]),renderblock||this.updchangelist(jn.sid),!0;var Pn=Q(jn.id,'B'==jn.type?Rs:null);return null==Pn?(console.log('No such object on scene',jn),!1):('B'==jn.type?Rs.remove(Pn):Jl.remove(Pn),this.history.push(['remove',jn]),ae(),jn.skip=1,renderblock||this.updchangelist(jn.sid),!0)},this.isdublicate=function(jn){for(var Pn,Ln=0;Ln<this.ao.length;Ln++)Pn=this.get(Ln),Pn.sameas(jn)&&(this.removefromscene(Pn),this.erasefromhistory(jn))},this.plot=function(jn){if('L'==jn.type)return jn.skip=0,void this.history.push(['add',jn]);var Ln;'W'==jn.type&&(Ln=H(jn.xs,jn.ys,jn.zs,jn.size)),'F'==jn.type&&(Ln=ee(jn.xs,jn.ys,jn.zs,jn.angle,jn.fall,jn.size),''!=jn.color&&Gt(jn.color)),'T'==jn.type&&(Ln=X(jn.text,jn.xs,jn.ys,jn.zs,1- -jn.fall)),'B'==jn.type&&(Ln=O(jn.xs,jn.ys,jn.zs,jn.xe,jn.ye,jn.ze),ds=[Ln,jn],Rs.add(Ln));Ln&&(Ln.name=Xl.length,jn.id=Ln.uuid,jn.skip=0,this.history.push(['add',jn]),'B'!=jn.type&&Jl.add(Ln),ae())}}function R(jn){!0==controls.enableRotate||((!params.move||'Line'==params.linetype)&&(dn=jn.center.x-pi,lasty=jn.center.y-di),jl.x=2*((jn.center.x-pi)/ii)-1,jl.y=2*-((jn.center.y-di)/oi)+1,Ql?J():L())}function J(){fcp=1,Al.setFromCamera(jl,camera);var jn=Al.intersectObjects(meshes.children);if(0<jn.length){var Ln=new ja;Ln.sid=wl;var Pn=mr(Wl),En=mr(yp),Tn=mr(zp),On=mr(Ul),Bn=mr(yp2d),In=mr(jn[0].point.x),Gn=mr(jn[0].point.y),Nn=mr(jn[0].point.z),_n=mr(2*(jn[0].uv.x-0.5)*Ns),Wn=mr(2*(jn[0].uv.y-0.5)*_s);if(-1e3<Wl){var Un=params.lineStyle==qa.lineStylear[0]?0:params.lineStyle==qa.lineStylear[1]?1:params.lineStyle==qa.lineStylear[2]?2:3,Hn=Un+params.color,Xn=_(Pn,En,Tn,In,Gn,Nn,Math.round(40*params.size),params.color);if(2==jn.length){var Yn=mr(2*(jn[1].uv.x-0.5)*Ns),Kn=mr(2*(jn[1].uv.y-0.5)*_s),Zn={xs:Yn,ys:Kn,v:new THREE.Vector3(jn[1].point.x,jn[1].point.y,jn[1].point.z)};linez.push(Zn)}var Zn={xs:On,ys:Bn,v:new THREE.Vector3(Pn,En,Tn)};linez.push(Zn),line3dtemp.add(Xn)}Wl=In,yp=Gn,zp=Nn,Ul=_n,yp2d=Wn,zp2d=Nn}ae()}function A(jn){return params.linemagnet?0.3>Math.abs(jn-Ns)?Ns:0.3>Math.abs(jn+Ns)?-Ns:jn:jn}function L(){fcp=1,Al.setFromCamera(jl,camera);var jn=Al.intersectObjects(Hl);if(0<jn.length){var Ln=new ja;Ln.sid=wl;var Pn=mr(Wl),En=mr(yp),Tn=mr(zp),On=mr(jn[0].point.x),Bn=mr(jn[0].point.y),In=mr(jn[0].point.z);if(Pn=A(Pn),On=A(On),!Ql&&!params.move&&On<-Ns&&'Select'==params.linetype)return Le(Bn),Pe(),void ae();if('Line'==params.linetype&&On>=-Ns){if(-1e3<Wl){Ds.visible=!0,Ds.position.set(On,Bn,10);var Gn=params.lineStyle==qa.lineStylear[0]?0:params.lineStyle==qa.lineStylear[1]?1:params.lineStyle==qa.lineStylear[2]?2:3,Nn=Gn+params.color,_n=_(Pn,En,Tn,On,Bn,In+params.layer+1,Math.round(30*params.size),params.color);_n.name=Xl.length,Ln.addline(Pn,En,Tn,On,Bn,In+params.layer+1,Math.round(30*params.size),Nn),oman.plot(Ln),oman.add(Ln),Ms.add(_n),un=On,endy=Bn}else cn=On,firsty=Bn,firstz=In;Ds.visible=!0,Ds.position.set(On,Bn,10),Wl=On,yp=Bn,zp=In+params.layer+1}if('Bolt'==params.linetype)if(!El)Ln.addbolt(On,Bn,In+7,On,Bn,In+7,params.bolttype),oman.plot(Ln),oman.add(Ln);else{G(On,Bn,In+7);var Wn=oman.get(Xl.length-1);Wn.xe=$l.vertices[1].x,Wn.ye=$l.vertices[1].y,Wn.ze=$l.vertices[1].z}if('Fall'==params.linetype&&(Tl?0!=params.fall&&_a(On,Bn,In+7):(Ln.addfall(On,Bn,In+7,params.angle,params.fall,Sl<kl),oman.plot(Ln),oman.add(Ln))),'Water'==params.linetype&&(Ln.addwater(On,Bn,In+7,Math.round(10*params.wsize)/10),oman.plot(Ln),oman.add(Ln)),'Text'==params.linetype&&''!=params.text&&(Ln.addtext(params.text,On,Bn,In+params.layer+1),oman.plot(Ln),oman.add(Ln)),'Select'==params.linetype)if(!params.move){oman.select(On,Bn);var Un=be(On,Bn);if(Un[3]>Math.sqrt(_s*_s+Ns*Ns)/7)return;Vs.visible=!0,Vs.position.set(Un[1],Un[2],10),Bs=Un[0],Je(Bs)}else if(oman.so){var Hn=On-0.1*Ns/camera.zoom,Xn=Bn+0.1*_s/camera.zoom;oman.move(oman.get(Bs),Hn,Xn)}}else'Select'==params.linetype?params.move&&de():(Na(),Vs.visible=!1);ae()}function P(){if(-1e3<un){var jn=new ja;jn.sid=wl;var Ln=params.lineStyle==qa.lineStylear[0]?0:params.lineStyle==qa.lineStylear[1]?1:params.lineStyle==qa.lineStylear[2]?2:3;if(0<Ln)return void(un=endy=cn=firsty=firstz=-1e3);var Pn=Ln+params.color;jn.addline(un,endy,firstz+params.layer+1,cn,firsty,firstz+params.layer+1,Math.round(30*params.size),Pn),oman.plot(jn),oman.add(jn),un=endy=cn=firsty=firstz=-1e3,Qa(),ae()}}function E(jn,Ln,Pn){Jl.remove(Js);var En=6,Tn=0.1*Hs;Js=new THREE.Object3D;var On=-_s,Bn=_s,In=_(1.13*Ns,On,0,1.13*Ns,Bn,0,10,$a);Js.add(In);var Gn={val:15},Nn=X(jn,1.13*Ns+0.11*Ns,On+Tn,0,0,$a);Js.add(Nn);var _n=_(1.13*Ns,On,0,1.067*Ns,On,0,En,$a);Js.add(_n);var Wn=_(1.13*-Ns,On,10,1.067*-Ns,On,10,En,$a);Js.add(Wn);var Un=X(Ln,1.13*Ns+0.11*Ns,Bn-Tn,0,0,$a);Js.add(Un);var Hn=_(1.13*Ns,Bn,0,1.067*Ns,Bn,0,En,$a),Xn=_(1.13*-Ns,Bn,10,1.067*-Ns,Bn,10,En,$a);Js.add(Hn),Js.add(Xn);for(var Yn=1;Yn<pmult*(Ln-jn)/5;++Yn){var Kn=-_s+5*(pmult*Yn*(Bn-On))/(Ln-jn),Zn=_(1.13*Ns,Kn,0,1.067*Ns,Kn,0,En,$a),$n=_(1.13*-Ns,Kn,10,1.067*-Ns,Kn,10,En,$a),eo=5*pmult*Yn+parseInt(jn),to=X(eo,1.13*Ns+0.11*Ns,Kn,0,0,$a);Js.add(Zn),Js.add(to),Js.add($n)}var ao=normPel(jn,Ln);if(100<ao[1]-ao[0])for(var Yn=ao[0]-1;Yn<=ao[1];Yn++)if(0==Yn%100){fcp=1;var lo=X(Yn,4*Ns,La(Yn),Gn,0,$a);Js.add(lo),fcp=0}if(null!=Pn){Js.position.set(0,Pn,0)}Jl.add(Js)}function O(jn,Ln,Pn,En,Tn,On){var Bn=new THREE.Object3D,In=0.07,Gn=_(jn+In,Ln+In,Pn,jn-In,Ln-In,Pn-0.01,2,'#000000'),Nn=_(jn-In,Ln+In,Pn,jn+In,Ln-In,Pn-0.01,2,'#000000'),_n=Wa(jn,Ln,Pn,2*(In/Math.sqrt(2)),2,'#000000');return us=I(jn,Ln,Pn,En,Tn,On,1,'#000000'),Bn.add(Gn),Bn.add(Nn),Bn.add(_n),Bn.add(us),Bn}function B(){return 1/2e3}function I(jn,Ln,Pn,En,Tn,On,Bn,In){$l=new THREE.Geometry,es=new THREE.Vector3(jn,Ln,Pn),$l.vertices.push(es),$l.vertices.push(new THREE.Vector3(En,Tn,On));return N([jn,Ln,Pn,En,Tn,On],10,In)}function G(jn,Ln,Pn){var En=(es.x-jn)*(es.x-jn)+(es.y-Ln)*(es.y-Ln),Tn=2*(Fl/Gs),On=params.boltlen*Math.sin(Math.PI/24);if(En=Math.sqrt(En)/Tn,En<On)ds[0].remove(us),us=I(es.x,es.y,es.z,jn,Ln,Pn,1,'#000000'),ds[0].add(us),ds[1].xe=jn,ds[1].ye=Ln,ds[1].ze=Pn;else{var In,Gn;In=es.x+(jn-es.x)/En*On,Gn=es.y+(Ln-es.y)/En*On,ds[0].remove(us),us=I(es.x,es.y,es.z,In,Gn,Pn,1,'#000000'),ds[0].add(us),ds[1].xe=In,ds[1].ye=Gn,ds[1].ze=Pn}console.log(ds[1])}function N(jn,Ln,Pn,En){if(0!=jn.length){var Tn=new THREE.LineGeometry;Tn.setPositions(jn);var On=Pn+'',Bn=0;if(7<On.length&&(Bn=On[0],On=On.slice(1,8)),0<Bn){var In=W(jn,Ln,Pn,En);return In}var Gn=Math.abs(Ln),Nn=Ql?5:3,_n=new THREE.LineMaterial({color:new THREE.Color(On),linewidth:Gn/3,dashed:!1}),Wn=renderer.getSize();_n.resolution.set(Wn.width,Wn.height);var In=new THREE.Line2(Tn,_n);return null==En&&Cs.add(In),In}}function _(jn,Ln,Pn,En,Tn,On,Bn,In){var Gn=new Float32Array(6);Gn[0]=jn,Gn[1]=Ln,Gn[2]=Pn,Gn[3]=En,Gn[4]=Tn,Gn[5]=On;var Nn=N(Gn,Bn,In,1);return Nn}function W(jn,Ln,Pn,En){if(0!=jn.length){var Tn=jn.length,On=Pn+'',Bn=0;7<On.length&&(Bn=On[0],On=On.slice(1,8));for(var In=0,Gn=3;Gn<Tn;Gn+=3)In+=Math.sqrt((jn[Gn]-jn[Gn-3])*(jn[Gn]-jn[Gn-3])+(jn[Gn+1]-jn[Gn-2])*(jn[Gn+1]-jn[Gn-2]));var Nn=new Float32Array(Tn);iOS&&(Nn=new Float32Array(2*Tn-3));for(var Gn=0;Gn<jn.length;Gn++)Nn[Gn]=jn[Gn];if(iOS)for(var Wn,Gn=0;Gn<Tn-3;Gn+=3)Wn=2*Tn-3-Gn-3,Nn[Wn]=jn[Gn],Nn[Wn+1]=jn[Gn+1],Nn[Wn+2]=jn[Gn+2];var Un=new THREE.Color(On),Hn=Math.abs(Ln)*B(),Xn=new MeshLineMaterial({color:Un,lineWidth:Hn*lsc,useMap:!1,transparent:!!(0>Ln),opacity:0>Ln?0.6:1,resolution:ri});if(1==Bn)var Xn=new MeshLineMaterial({color:Un,lineWidth:Hn*lsc,useMap:!1,useAlphaMap:1,transparent:!0,alphaMap:Ti,resolution:ri});if(2==Bn){var Yn=Math.round(1.5*In);Yn=1>Yn?1:Yn;var Xn=new MeshLineMaterial({color:Un,lineWidth:Hn*lsc,useMap:!1,useAlphaMap:1,repeat:new THREE.Vector2(Yn,1),transparent:!0,alphaMap:Oi,resolution:ri})}if(3==Bn){var Yn=Math.round(In);Un=new THREE.Color('#aaaaaa'),Yn=1>Yn?1:Yn;var Xn=new MeshLineMaterial({color:Un,lineWidth:1.5*(Hn*lsc),useMap:!0,map:Bi,useAlphaMap:1,repeat:new THREE.Vector2(Yn,1),transparent:!0,alphaMap:Bi,resolution:ri})}var Kn=new MeshLine;Kn.setGeometry(Nn);var Zn=new THREE.Mesh(Kn.geometry,Xn);return null==En&&Cs.add(Zn),Zn}}function U(jn,Ln){var Pn=new THREE.Sprite;return Pn.position.set(jn,Ln,2),Pn.scale.set(0.4,0.4,0.4),Pn}function H(jn,Ln,Pn,En){var Tn=new THREE.Sprite(mn);return Tn.position.set(jn,Ln,Pn),Tn.scale.x=Tn.scale.y=En*Hs,Tn}function X(jn,Ln,Pn,En,Tn,On){var Bn=10,In=new THREE.Object3D,Gn=Ua(jn,On,En);if(Gn.position.set(Ln+0.1,Pn-0.05,Bn/5),In.add(Gn),Tn){Gn.position.set(Ln+0.35,Pn-0.2,Bn/5);var Nn=0.07,_n=_(-Nn,-Nn,10,Nn,Nn,10,Bn/5,'#000000'),Wn=_(Nn,-Nn,10,-Nn,Nn,10,Bn/5,'#000000');_n.position.set(Ln,Pn,0),Wn.position.set(Ln,Pn,0);var Un=U(Ln+0.35,Pn+0.12);Un.visible=!1,In.add(_n),In.add(Wn),In.add(Un),2==Tn&&(Un.material=kn,Un.visible=!0,console.log('photo added')),3==Tn&&(Un.material=Sn,Un.visible=!0,console.log('labtest added'))}return In}function Y(jn){var Ln=new FileReader;Ln.onloadend=function(Pn){var En=Sl;Re()&&(En=Math.round(Pa(Xl[Bs].ys)));var Tn=new Date,On='';On='pic_'+En+'_'+Tn.getMinutes()+'m'+Tn.getSeconds()+'s',zn(Pn.target.result,On+'.jpg'),Z(Bs,On,1),Ji.updateDisplay()},Ln.readAsDataURL(jn.files[0])}function Z(jn,Ln,Pn){var En=Xl[jn];if('T'!=Re(jn))return void console.log('not T');var Tn=Jl.getObjectByName(jn),On=Tn.children[0];On.redrawInterval=1,Tn.children[0].material.map.text=''+Ln,En.text=Ln,oman.updchangelist(En.sid),null!=Pn&&(1==Pn&&(En.fall=1,Tn.children[3].material=kn),2==Pn&&(En.fall=2,Tn.children[3].material=Sn),Tn.children[3].visible=1),ae(),setTimeout(function(){On.redrawInterval=1e8,ae()},1)}function $(jn,Ln,Pn){var En=Xl[jn];if('F'!=Re(jn))return void console.log('not F');var Tn=En.size&&Sl<kl?Pn:360-Pn,On=Jl.getObjectByName(jn),Bn=On.children[1].children[0];Bn.redrawInterval=1,0!=Ln&&90!=Ln&&(On.children[1].children[0].material.map.text=''+Ln),On.children[0].material.rotation=Math.round(1e3*(-Math.PI/180*Tn))/1e3,0==Ln&&(On.children[0].material.map=bn,On.children[1].children[0].material.map.text='',On.children[0].material.rotation=0),90==Ln&&(On.children[0].material.map=fn,On.children[1].children[0].material.map.text=''),0!=Ln&&90!=Ln&&(On.children[0].material.map=yn),En.fall=parseInt(Ln),En.angle=parseInt(Pn),oman.updchangelist(En.sid),ae(),setTimeout(function(){Bn.redrawInterval=1e8,ae()},50)}function ee(jn,Ln,Pn,En,Tn,On){var Bn=On==Sl<kl?En:360-En,In='',Gn=new THREE.Object3D;if(0!=Tn&&90!=Tn){as=new THREE.SpriteMaterial({map:yn,color:16777215,rotation:-Math.PI/180*Bn});var Nn=new THREE.Sprite(as);In=Tn+''}if(0==Tn)var _n=new THREE.SpriteMaterial({map:bn,color:16777215}),Nn=new THREE.Sprite(_n);if(90==Tn){as=new THREE.SpriteMaterial({map:fn,color:16777215,rotation:-Math.PI/180*Bn});var Nn=new THREE.Sprite(as)}Nn.position.set(jn,Ln,Pn),Nn.scale.x=Nn.scale.y=0.4*Hs;var Wn=X(In,jn+0.25*Us,Ln-0.12*Hs,Pn,0);return Gn.add(Nn),Gn.add(Wn),Gn}function ae(jn,Ln){if(!renderblock){if(mt.start('render'),null==jn&&controls.update(),Ql?renderer.render(Ss,camera):null==Ln?renderer.render(Jl,camera):renderer.render(Ln,camera),null==jn&&(1==rendebug&&console.log('r'),2==rendebug)){var Pn=ae.caller;console.log(Pn)}mt.end('render')}}function le(jn,Ln){var Pn=Ba();if(!Pn)return void console.log('Nothing to save');var En=JSON.stringify(Pn),Tn=getpelrange(En,picparams.ps,picparams.pe);params.textsave=En,Ji.updateDisplay();var On=new Date,Bn='',In=getauthorandsid(Pn);Bn='pel'+Tn[0]+'_'+Tn[1]+'\''+params.tunnel+'\''+In.author+shortsid(In.sid)+'.txt';var Gn={name:Bn,size:En.length,content:En},Nn=elemfromfile(Gn),_n=function(Xn){dbputreg(Xn,function(){null==Ln&&(newdb.ldb(),allq.update())})};console.log('Attempt to add new file to db',Nn);var Wn=newdb.comparef(Nn);if(Wn){console.log('File already exists in db',Wn);var Un=Nn.savedata,Hn=Wn.savedata;comparesave(Un,Hn)?console.log('Files are same, not saving'):(console.log('Adding because files are different'),_n(Nn))}else console.log('Adding new file to db',Nn),_n(Nn);se(jn)}function se(){var Ln=Ba(1);if(!Ln)return void console.log('Nothing to save');var Pn=JSON.stringify(Ln),En=getpelrange(Pn,picparams.ps,picparams.pe);params.textsave=Pn,Ji.updateDisplay();var Tn=new Date,On='',Bn=getauthorandsid(Ln);On='pel'+En[0]+'_'+En[1]+'\''+params.tunnel+'\''+Bn.author+shortsid(Bn.sid)+'.txt';({name:On,size:Pn.length,content:Pn})}function oe(jn,Ln){params.withbg||(Qs.visible=!1),tt();var Pn=new THREE.Scene;Pn.add(Os),ae(null,Pn),console.log('start save as image'),re(function(En){Jl.add(Os),ae(),re(jn,En),Qs.visible=!0,ut(),Qa(),ae(),null!=Ln&&(params.what2plot='Geo+Q+Pel')},1)}function re(jn,Ln){var Pn,Tn=window.devicePixelRatio;try{Pn=renderer.domElement.toDataURL('image/png');var Bn=new Image,In='For 3d'==params.what2plot?1:0,Gn='Only texture'==params.what2plot?1:0;Bn.onload=function(){var _n=document.createElement('canvas');_n.width=Gn?2*Cl:Ml,_n.height=Gn?2*Cl:Cl,_n.width*=Tn,_n.height*=Tn,_n.visible=0;var Wn=_n.getContext('2d');Wn.drawImage(Bn,0,0);var Un=Wn.getImageData(0,0,_n.width,_n.height),Hn=Un.data,Xn=Hn.length,Yn=[];if(null!=Ln&&!Array.isArray(Ln))for(var Kn=0;Kn<Xn;Kn+=4)if(208==Hn[Kn]&&208==Hn[Kn+1]&&208==Hn[Kn+2]);else Yn.push(Kn);if(null!=Ln&&!Array.isArray(Ln))return void jn(Yn);if(!params.withbg){for(var Kn=0;Kn<Xn;Kn+=4)208==Hn[Kn]&&208==Hn[Kn+1]&&208==Hn[Kn+2]&&(Hn[Kn+3]=0);if(Array.isArray(Ln))for(var Kn=0;Kn<Ln.length;Kn++)Hn[Ln[Kn]+3]=100}console.log('done pic'),Un.data=Hn,Wn.putImageData(Un,0,0);var Zn=document.createElement('canvas');Zn.visible=0;var $n=Wn.getImageData(Cl,0,Cl+Ml,Cl);Zn.width=Cl,Zn.height=Ml;var eo=Zn.getContext('2d');if(eo.putImageData($n,0,0),Pn=Gn?Zn.toDataURL():_n.toDataURL(),yl=Pn,console.log('tmp pic saved'),void 0!==jn)return rl=Pn,void jn();if(!In){var to=new Date,ao='';ao=ao+'geo'+to.getHours()+'h'+to.getMinutes()+'m'+to.getSeconds()+'s.png',zn(Pn,ao)}},Bn.src=Pn}catch(_n){return void console.log(_n)}}function de(){if(!Pl){var jn=Re();jn&&('L'==jn?myask(container,'Remove line?',function(){ue(),un=-1e3,Qa(),ae()}):(ue(),Qa(),ae()))}}function ue(){if(oman.so){allp.remove(oman.sp);var jn=[];if(jn=he(oman.selidx),'Group'==li.value&&1<jn.length)for(var Ln=0;Ln<jn.length;Ln++)oman.removefromscene(oman.get(jn[Ln]),1);else oman.removefromscene(oman.so);Vs.visible=!1,oman.so=null,oman.selidx=null}}function he(jn){for(var Ln=[jn],Pn=jn-1;0<=Pn&&1!=Xl[Pn].skip&&Xl[Pn].xe==Xl[Pn+1].xs&&Xl[Pn].ye==Xl[Pn+1].ys;Pn--)Ln.push(Pn);for(var Pn=jn+1;Pn<Xl.length&&1!=Xl[Pn].skip&&Xl[Pn-1].xe==Xl[Pn].xs&&Xl[Pn-1].ye==Xl[Pn].ys;Pn++)Ln.push(Pn);return Ln.sort((En,Tn)=>En-Tn),Ln}function ge(jn){var Ln=[];if(-1==jn[0])return Ln;for(var En,Pn=0;Pn<jn.length;Pn++)En=jn[Pn],0==Pn&&(Ln.push(Xl[En].xs),Ln.push(Xl[En].ys)),Ln.push(Xl[En].xe),Ln.push(Xl[En].ye);return Ln}function me(){oman.undo(),Qa(),si.setAttribute('class','geobutton1'),setTimeout(function(){si.setAttribute('class','geobutton')},200)}function fe(){this.tunnel='',this.zeropel=0,this.pelperunit=1,this.pelstart=0,this.pelend=20,this.qval={},this.pval={},this.pw=Ns,this.author='V',this.sid=wl,this.lastchange=0,this.objdata=[]}function be(jn,Ln){for(var Pn=Xl.length,En=1e3,Tn=-1,On=-20,Bn=-20,In=1,Gn=0;Gn<Pn;Gn++)if(!Xl[Gn].skip){In=1;var Nn=Xl[Gn].xs,_n=Xl[Gn].ys,Wn=(jn-Nn)*(jn-Nn)+(Ln-_n)*(Ln-_n);if('L'==Xl[Gn].type){var Un=we(Xl[Gn],jn,Ln);Wn=Un[0],Nn=Un[2],_n=Un[3],(0>Un[1]||1<Un[1])&&(In=0)}En>=Wn&&In&&(En=Wn,Tn=Gn,On=Nn,Bn=_n)}return[Tn,On,Bn,Math.sqrt(En)]}function we(jn,Ln,Pn){var En=jn.xs,Tn=jn.xe,On=jn.ys,Bn=jn.ye,In=Math.sqrt((Tn-En)*(Tn-En)+(Bn-On)*(Bn-On)),_n=[0,1,2,3,4],Un=((Tn-En)*(Ln-En)+(Bn-On)*(Pn-On))/In/In,Hn=En+Un*In*((Tn-En)/In),Xn=On+Un*In*((Bn-On)/In),Yn=Math.sqrt((Ln-En)*(Ln-En)+(Pn-On)*(Pn-On)),Kn=Math.sqrt((Ln-Tn)*(Ln-Tn)+(Pn-Bn)*(Pn-Bn)),Zn=Math.sqrt((Ln-Hn)*(Ln-Hn)+(Pn-Xn)*(Pn-Xn));return _n[0]=Math.sqrt((Ln-Hn)*(Ln-Hn)+(Pn-Xn)*(Pn-Xn)),Se(Un)||(_n[0]=Math.min(Yn,Kn)),_n[1]=Un,_n[2]=Hn,_n[3]=Xn,_n[4]=0,0>=(Tn-En)*(Pn-On)-(Bn-On)*(Ln-En)&&(_n[4]=1),_n}function Se(jn){return 0<=jn&&1>=jn}function ke(){localStorage.setItem('lastauthor',params.author)}function qe(jn){return': -1??'==jn?'':jn}function De(jn,Ln,Pn){Ln.value=jn+qe(': '+Pn),'-1??'!=Pn&&Ln.setAttribute('class','inguib aguibut')}function Ve(){De('RQD',Ci.rqd,Ni.RQD+Ni.RQDc),De('Jn',Ci.Jn,Ni.Jn+Ni.Jnc),De('Jr',Ci.Jr,Ni.Jr+Ni.Jrc),De('Ja',Ci.Ja,Ni.Ja+Ni.Jac),De('Jw',Ci.Jw,Ni.Jw+Ni.Jwc),De('SRF',Ci.SRF,Ni.SRF+Ni.SRFc),Ni.getQ(),'????'==Ni.Q+Ni.class?Ci.Q.name('Q = ?'):Ci.Q.name('Q = '+Ni.Q+Ni.class),Ji.updateDisplay()}function Qe(jn,Ln){var Pn=jn.add(bf,'blank').name(Ln).__li;return Pn.setAttribute('class','cr function myguibut'),null==Ln&&Pn.removeChild(Pn.children[0]),Pn}function Me(jn){jn.style.height='5px',jn.style.height=jn.scrollHeight-5+'px'}function Ce(jn){for(var Ln=0;Ln<vi.length;Ln++)if(jn==vi[Ln])return xi[Ln]}function Re(jn){var Ln=0,Pn=Bs;null!=jn&&(Pn=jn);Jl.getObjectByName(Pn);return null==Xl[Pn]?Ln:1==Xl[Pn].skip?Ln:Xl[Pn].type}function Je(jn){var Ln=Ae(jn);if(-3==Ln)return void console.log('Nothing selected');var Pn=Re(jn);chosenp=Ln,-2==chosenp?(_i=new Ie,_i.type=Pn,_i.coords=Il,_i.isarea=Ne(Il)):_i.restore(allp.par[chosenp]),Da('Select',Pn),Ji.updateDisplay()}function Ae(jn){var Ln=Re(jn);if(!Ln)return console.log('Nothing selected'),-3;if('L'==Ln){var Pn=he(jn);Il=ge(Pn),0==Il.length&&console.log('No lines selected')}else Il=[Xl[jn].xs,Xl[jn].ys];return allp.get(Il)}function je(jn){for(var Ln=normPel(Sl,kl),Pn=Ln[0];Pn<Ln[1];Pn+=5)if(jn>=Pn&&jn<Pn+5){var En=allq.get(Pn),Tn=allq.get(Pn+5);if(-2==En&&-2==Tn)return console.log('No Q near'),[Pn,Pn+5];var On=Pn,Bn=-2==Tn?En:Tn;On=-2==Tn?Math.max(allq.qar[En].ps,allq.qar[En].pe):Math.min(allq.qar[Tn].ps,allq.qar[Tn].pe);var In=-2==Tn?5:-5;return[On,On+In]}return console.log('No q found'),[jn,jn+5*Ln[2]]}function Le(jn){var Ln=Pa(jn);if(Wi=allq.get(Ln),-2==Wi){Ni=new Ue,Ni.getQ();var Pn=je(Ln);Ni.ps=Pn[0],Ni.pe=Pn[1],Ni.comment=''}else Ni.restore(allq.qar[Wi]);ae(),Yl==qa.qval?(Ji.removeFolder(qa.qval),za()):Da(qa.qval),Fi.close(),Ji.removeFolder(qa.main),Ji.removeFolder(qa.setproperties),Vi.open(),Vs.visible=!0,Vs.position.set(1.2*-Ns,0.35*La(Ni.pe)+0.65*La(Ni.ps),10),Ve(),Ji.updateDisplay()}function Pe(){setTimeout(function(){Ji.open()},200)}function Ee(){Ji.close()}function Te(){-1<Wi?(Ni.lastchange=wl,allq.qar[Wi].restore(Ni)):(allq.add(Ni),Wi=allq.qar.length-1),oman.updchangelist(Ni.sid),allq.update(),Xt(null,1)}function Oe(){allq.remove(Wi),allq.update(),ae(),Ni=new Ue,Ve()}function Be(){if(0==Il.length)return void console.log('No lines selected');if(-1<chosenp){if('undefined'==typeof allp.par[chosenp])return void console.log('No lines selected');allp.par[chosenp].restore(_i),allp.par[chosenp].author=params.author,allp.par[chosenp].lastchange=wl,'L'==allp.par[chosenp].type&&(allp.par[chosenp].color=St(Ce(_i.bergart)))}else _i.author=params.author,'L'==_i.type&&(_i.color=St(Ce(_i.bergart))),_i.sid=wl,allp.add(_i),chosenp=allp.amtok()-1;oman.sp=allp.par[chosenp],allq.update(),ae()}function Ie(){this.author=params.author,this.sid=wl,this.lastchange=wl,this.type='',this.bergart='none',this.ispartofQ=0,this.id='',this.coords=[],this.color=0,this.comment='',this.width=0,this.dsc='Not given',this.wdrip=0,this.wleak=0,this.isarea=!1,this.restore=function(jn){var Ln=JSON.parse(JSON.stringify(jn));this.sid=Ln.sid,this.lastchange=null==Ln.lastchange?this.sid:Ln.lastchange,this.type=Ln.type,this.id=Ln.id,this.coords=Ln.coords,this.bergart=Ln.bergart,this.width=Ln.width,this.comment=Ln.comment,this.ispartofQ=Ln.ispartofQ,null!=Ln.author&&(this.author=Ln.author),this.isarea=Ln.isarea,this.color=Ln.color,null!=Ln.dsc&&(this.dsc=Ln.dsc,this.wdrip=Ln.wdrip,this.wleak=Ln.wleak)},this.sameas=function(jn){if(0==jn.length)return!1;for(var Ln=0;Ln<Math.min(jn.length,this.coords.length)&&!(6<Ln);Ln++){if(20<Ln)return console.log('Same',this.coords),!0;if(10<jn.length){var Pn=Aa(jn[Ln],this.coords[Ln]);if(!Pn)return!0}if(!Ja(jn[Ln],this.coords[Ln]))return!1}return!0},this.showprops=function(){var jn;return jn='W'==this.type?this.coords+' wdrip='+this.wdrip+' wleak='+this.wleak:this.bergart+' '+this.coords,jn}}function Ge(){this.par=[],this.getareas=function(){var jn=[];for(var Ln in this.par){var Pn=this.par[Ln];Pn.isarea&&!Pn.ispartofQ&&jn.push(Pn)}return jn},this.amtok=function(){for(var jn=0,Ln=0;Ln<this.par.length;Ln++)this.par[Ln].ispartofQ||jn++;return jn},this.add=function(jn,Ln){var Pn=new Ie;Pn.restore(jn),this.par.push(Pn),null==Ln&&this.update()},this.remove=function(jn,Ln){if('object'==typeof jn)for(var Pn in console.log('Trying to remove',jn),this.par){var En=this.par[Pn];if(En==jn){this.par.splice(Pn,1);break}}else-1<jn&&this.par.splice(jn,1);null==Ln&&this.update()},this.cleanFromQ=function(){for(var jn=0;jn<this.par.length;jn++)1==this.par[jn].ispartofQ&&(this.remove(jn,1),jn--)},this.y2pelcoords=function(){for(var jn=0;jn<this.par.length;jn++)for(var Ln=0;Ln<this.par[jn].coords.length;Ln+=2)this.par[jn].coords[Ln+1]=Pa(this.par[jn].coords[Ln+1])},this.cleanFromPel=function(){for(var jn=0;jn<this.par.length;jn++)Ya(this.par[jn].coords[1])||(console.log('Skipping property',this.par[jn]),this.remove(jn),jn--)},this.get=function(jn){for(var Ln=0;Ln<this.par.length;Ln++)if(this.par[Ln].sameas(jn))return Ln;return-2},this.restore=function(jn,Ln,Pn){var En=!1;null!=Pn&&(En=Pn);for(var On,Tn=0;Tn<jn.par.length;Tn++)(On=this.ismemberalready(jn.par[Tn]),null==jn.par[Tn].sid&&(jn.par[Tn].sid=Jn),null==jn.par[Tn].author&&(jn.par[Tn].author=An),!(1==En&&jn.par[Tn].sid<wl))&&(1<En&&jn.par[Tn].sid!=En||(-1<On?this.par[On].restore(jn.par[Tn]):this.add(jn.par[Tn],Ln)));null==Ln&&(console.log('Update inside restore'),this.update())},this.ismemberalready=function(jn){for(var Ln=0;Ln<this.par.length;Ln++)if(this.par[Ln].sameas(jn.coords))return Ln;return-1},this.update=function(){mt.start('updatePinside');var jn=renderblock;if(renderblock=1,ga(),params.showbergart)for(var Ln=0;Ln<this.par.length;Ln++)if(('L'==this.par[Ln].type||this.par[Ln].ispartofQ)&&(this.par[Ln].isarea&&Ye(this.par[Ln].coords,Ce(this.par[Ln].bergart),this.par[Ln].ispartofQ),''!=this.par[Ln].comment)){var En,Tn,Pn=this.par[Ln].coords.length;En=this.par[Ln].coords[Pn-2],Tn=this.par[Ln].coords[Pn-1];var On=X('comment!',En,Tn,5,1);Os.add(On)}renderblock=jn,mt.end('updatePinside')}}function Ne(jn){var Ln=jn.length;return Ln%2?(console.log('Odd amount of coordinates?'),console.log(jn),!1):!(8>Ln)&&jn[0]==jn[Ln-2]&&jn[1]==jn[Ln-1]}function _e(jn){var Ln=Sl<kl,Pn=allq.get(jn);return-1<Pn&&(Ln=allq.qar[Pn].ps>allq.qar[Pn].pe?0:Ln),Sl<tunborder&&(Ln=13730<jn&&13915>jn||14350<jn&&14980>jn?0:1),17057<jn&&17068>jn&&(Ln=1),Ln}function We(){this.qar=[],this.add=function(jn){var Ln=new Ue;Ln.restore(jn),this.qar.push(Ln)},this.get=function(jn){for(var Tn,Ln=1e3,Pn=-2,En=0;En<this.qar.length;En++)Tn=Ln,(this.qar[En].pe>jn&&this.qar[En].ps<jn||this.qar[En].ps>jn&&this.qar[En].pe<jn)&&(Ln=Math.min(Ln,Math.abs(jn-this.qar[En].ps),Math.abs(jn-this.qar[En].pe),Math.abs(jn-(this.qar[En].pe+this.qar[En].ps)/2)),Tn!=Ln&&(Pn=En));return Pn},this.remove=function(jn){-1<jn&&(console.log('Removed Q'),oman.updchangelist(this.qar[jn].sid),this.qar.splice(jn,1))},this.removeP=function(jn){var Ln=this.get(jn);-1<Ln?this.qar.splice(Ln,1):console.log('No such Q with pel'+jn)},this.getoverlaps=function(){for(var jn=[],Ln=0;Ln<this.qar.length;Ln++){for(var Pn=0,En=this.qar[Ln],Tn=Math.min(En.ps,En.pe),On=Math.max(En.ps,En.pe),Bn=Ln+1;Bn<this.qar.length;Bn++){var In=this.qar[Bn],Gn=Math.min(In.ps,In.pe),Nn=Math.max(In.ps,In.pe);if(Gn<=On&&Gn>=Tn){if(Gn==On)continue;var _n=[Gn,Math.min(Nn,On)];jn.push(_n),En.Q==In.Q&&En.comment==In.comment&&(En.sid>In.sid?(console.log('Removing overlap',In),this.remove(Bn),Bn--):Pn=1);continue}if(Nn<=On&&Nn>=Tn){if(Nn==Tn)continue;var _n=[Math.max(Gn,Tn),Nn];jn.push(_n),En.Q==In.Q&&En.comment==In.comment&&(En.sid>In.sid?(console.log('Removing overlap',In),this.remove(Bn),Bn--):Pn=1)}}Pn&&(console.log('Removing i',En),this.remove(Ln),Ln--)}return 2<jn.length&&console.log('Overlaps',jn),jn},this.update=function(){mt.start('updateQ'),mt.start('Get Q overlaps'),this.getoverlaps(),mt.end('Get Q overlaps'),ha(),mt.start('Clean Q'),allp.cleanFromQ(),mt.end('Clean Q');for(var jn=0;jn<this.qar.length;jn++)if(ua(this.qar[jn].ps,this.qar[jn].pe,this.qar[jn].getQ(),this.qar[jn].class,this.qar[jn].comment),'none'!=this.qar[jn].bergart){var Ln=new Ge,Pn=new Ie;Pn.ispartofQ=1;var En=La(this.qar[jn].ps),Tn=La(this.qar[jn].pe);Pn.coords=[-Ns,En,-Ns,Tn,Ns,Tn,Ns,En],Pn.bergart=this.qar[jn].bergart,Pn.isarea=!0,Ln.add(Pn,1),allp.restore(Ln,1)}mt.start('updatePFinal'),allp.update(),mt.end('updatePFinal'),mt.end('updateQ')},this.clear=function(){ha(),this.qar=[]},this.restore=function(jn,Ln,Pn){var En=!1;null!=Pn&&(En=Pn);for(var Tn=0;Tn<jn.qar.length;Tn++)if((null==jn.qar[Tn].sid&&(jn.qar[Tn].sid=Jn),null==jn.qar[Tn].author&&(jn.qar[Tn].author=An),!(1==En&&jn.qar[Tn].sid<wl))&&!(1<En&&jn.qar[Tn].sid!=En)){if(params.onlycurpel&&(!Ya(jn.qar[Tn].ps)||!Ya(jn.qar[Tn].pe))){console.log('Q not in limits'+jn.qar[Tn].ps+' '+jn.qar[Tn].pe);continue}var On=this.isequal(jn.qar[Tn]);-1<On?this.qar[On].restore(jn.qar[Tn]):this.add(jn.qar[Tn])}null==Ln&&this.update()},this.isequal=function(jn){for(var Ln=0;Ln<this.qar.length;Ln++)if(this.qar[Ln].ps==jn.ps&&this.qar[Ln].pe==jn.pe)return Ln;return-1}}function Ue(){this.author=params.author,this.sid=wl,this.lastchange=wl,this.ps=Sl,this.pe=kl,this.RQDc='??',this.Jrc='??',this.Jwc='??',this.Jnc='??',this.Jac='??',this.SRFc='??',this.Jnmult=1,this.RQD=-1,this.Jr=-1,this.Jw=-1,this.Jn=-1,this.Ja=-1,this.SRF=-1,this.Q='??',this.class='??',this.comment='',this.bergart='none',this.getQ=function(){return 0>this.RQD||0>this.Jr||0>this.Jr||0>this.Jn||0>this.Ja||0>this.SRF?this.Q:(this.Q=Math.round(1e3*(Math.max(this.RQD,10)*this.Jr*this.Jw/(this.Jn*this.Ja*this.SRF)))/1e3,0.01<this.Q&&(this.Q=Math.round(100*this.Q)/100),1<this.Q&&(this.Q=Math.round(10*this.Q)/10),this.class='G',0.01<this.Q&&(this.class='F'),0.1<this.Q&&(this.class='E'),1<this.Q&&(this.class='D'),4<this.Q&&(this.class='C'),10<this.Q&&(this.class='A/B'),this.Q)},this.restore=function(jn){this.ps=jn.ps,this.pe=jn.pe,this.comment=jn.comment,this.bergart=jn.bergart,this.RQDc=jn.RQDc,this.Jrc=jn.Jrc,this.Jwc=jn.Jwc,this.Jnc=jn.Jnc,this.Jac=jn.Jac,this.SRFc=jn.SRFc,this.Jnmultc=1,this.RQD=jn.RQD,this.Jr=jn.Jr,this.Jw=jn.Jw,this.Jn=jn.Jn,this.Ja=jn.Ja,this.SRF=jn.SRF,null!=jn.author&&(this.author=jn.author),null!=jn.sid&&(this.sid=jn.sid),this.lastchange=null==jn.lastchange?this.sid:jn.lastchange,this.getQ()}}function Ye(jn,Ln,Pn){for(var On,En=[],Tn=0;Tn<jn.length;Tn+=2)On=new THREE.Vector3(jn[Tn],jn[Tn+1],1-0.02*Pn),En.push(On);var In,Gn,Nn=new THREE.Geometry,_n=new THREE.MeshBasicMaterial({color:Ln,transparent:!0,opacity:0.7});_n.side=THREE.DoubleSide,Nn.vertices=En,In=THREE.ShapeUtils.triangulateShape(En,[]);for(var Tn=0;Tn<In.length;Tn++)Nn.faces.push(new THREE.Face3(In[Tn][0],In[Tn][1],In[Tn][2]));Gn=new THREE.Mesh(Nn,_n),Os.add(Gn),ae()}function Ke(jn){for(var Ln=jn.elements,Pn=0;Pn<Ln.length;Pn++)Ln[Pn]=mr(Ln[Pn]);return Ln}function $e(jn,Ln){var Pn={x:(jn/Ns+1)/2,y:(Ln/_s+1)/2};return Pn}function et(jn,Ln){var Pn=Ln.x-jn[0].x,En=Ln.y-jn[0].y,Tn=0<(jn[1].x-jn[0].x)*En-(jn[1].y-jn[0].y)*Pn;return 0<(jn[2].x-jn[0].x)*En-(jn[2].y-jn[0].y)*Pn!=Tn&&0<(jn[2].x-jn[1].x)*(Ln.y-jn[1].y)-(jn[2].y-jn[1].y)*(Ln.x-jn[1].x)==Tn}function tt(){controls.reset(),controls.target.set(0,0,0),camera.position.set(0,0,gi),cameraFix.position.set(0,0,gi),Na(),lt(),Qa()}function lt(){var jn=window.devicePixelRatio;Ml=ul,Cl=hl,camera.left=-Ns,camera.right=Ns,camera.top=_s+Ws,camera.bottom=-_s+Ws,cameraFix.left=-Ns,cameraFix.right=Ns,cameraFix.top=_s+Ws,cameraFix.bottom=-_s+Ws,'Geo+Q+Pel'==params.what2plot&&(camera.left=-Ns-1.2,camera.right=Ns+1.2,Ml*=1.3,lsc=0.5),Ml/=jn,Cl/=jn;'For 3d'!=params.what2plot&&4096<Cl&&(Ml=4096*Ml/Cl,Cl=4096);var Pn=Ml,En=Cl;'For 3d'==params.what2plot,renderer.setSize(Pn,En),ri=new THREE.Vector2(Pn,En),'For 3d'==params.what2plot&&(lsc=Math.min(0.5,5e3/En));var Tn=android||iOS?4:1;buftext=new THREE.WebGLRenderTarget(4096/Tn,16384/Tn,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat}),camera.updateProjectionMatrix(),cameraFix.updateProjectionMatrix()}function it(){Ql||(sensivity=1,V(),params.what2plot='For 3d',vt(Sl,kl,1),tt(),Va(),Ql=!0,renderer.render(Jl,cameraFix,buftext),ut(),Mt(),camera.position.set(0,0,1e3),params.what2plot='Geo+Q+Pel',controls.enableRotate=!0,ae(),check3dbox.style.display='',check3dbox.checked=!0,fgui.close(),Da('3d'))}function rt(){if(Ql){for(sensivity=5,V();0<Ss.children.length;)Ss.remove(Ss.children[0]);buftext.dispose(),Jl=Fs,params.resetcam(),controls.enableRotate=!1,Ql=!1,camera.position.set(0,0,gi),lsc=1,ut(),Qa(),Va(),vt(Sl,kl),setTimeout(function(){ae()},50),li.value='Select',Da('Line'),check3dbox.style.display='none',fgui.close(),Ji.close()}}function dt(){kl+=5*pmult,Sl-=5*pmult,zl=Math.abs(parseInt(Sl)-parseInt(kl)),hl=Fl*zl,Cl=hl,_s=hl/Gs,E(Sl,kl,Ws),vt(Sl,kl),ua(Sl,kl,-1),pt(gl,La(kl-2.5*pmult)),pt(gl,La(Sl+2.5*pmult)),ae()}function pt(jn,Ln){var Pn=new THREE.MeshBasicMaterial({color:16777215}),En=new THREE.PlaneGeometry(5*(2*(Fl/Gs)),2*Ns,1,1),Tn=new THREE.Mesh(En,Pn);Tn.position.set(0,Ln,0),Tn.rotateZ(Math.PI/2),Hl.push(Tn),Qs.add(Tn)}function ut(){z(),ri=new THREE.Vector2(ii,oi),ci=ii/oi,camera.left=-ui*ci/2,camera.right=ui*ci/2,camera.top=hi/2,camera.bottom=-hi/2,camera.updateProjectionMatrix(),renderer.setSize(ii,oi),ae()}function gt(){if(Ri)return!1;for(var jn=0,Ln=0;Ln<Xl.length;Ln++)1!=Xl[0].skip&&(jn=1);if(allq.qar.length&&(jn=1),!jn)return!1;var Pn=new Date().getTime(),En=Ba(1),Tn=JSON.stringify(En);localStorage.setItem(Kl.s,Tn);var On=new Date().getTime()-Pn;return console.log('dT = '+On),!0}function yt(){if(localStorage.getItem(Kl.l)){var jn=localStorage.getItem(Kl.l),Ln=JSON.parse(jn);console.log('Sid set to',Ln.sid),Ra(Ln),allq.update(),Qa(),ae(),params.restses=0,Da('Line')}}function vt(jn,Ln,Pn){if(Jl.remove(As),!!params.rutenett){As=new THREE.Object3D;var En=normPel(jn,Ln),Tn=En[0],On=En[1],Bn=-4;null!=Pn&&(Bn=-0.5);for(var Un,Wn=Tn;Wn<=On;Wn++){Un=[],Un.push(-Ns,La(Wn),1,1.13*Ns,La(Wn),1);var Hn=N(Un,Bn,'0#000000');As.add(Hn)}Jl.add(As)}}function xt(){if(params.vederlag){var jn=tungeom[params.tunnel].Width,Ln=[];for(var Pn in jn){var En=jn[Pn][1],Tn=jn[Pn][3],On=jn[Pn][5],Bn=On-En;Ln.push([jn[Pn][0],2*((jn[Pn][2]-En)/Bn)-1,2*((jn[Pn][3]-En)/Bn)-1,2*((jn[Pn][4]-En)/Bn)-1])}for(var Hn,Xn,Yn,Kn,Bn,In=normPel(Sl,kl),Gn=In[0],Nn=In[1],_n=[],Wn=[],Un=[],Zn=1,Pn=Gn;Pn<Nn;Pn++){if(Bn=Math.max(Pn,Ln[0][0]),Bn=Pn,Hn=wt(Bn,Ln),Yn=La(Bn),Xn=wt(Bn+pmult,Ln),Kn=La(Bn+1),!Hn||!Xn){console.log('No vederlag data for pel=',Pn),Zn=0;break}_n.push(Hn[0]),_n.push(Yn),_n.push(1),Wn.push(Hn[1]),Wn.push(Yn),Wn.push(1),Un.push(Hn[2]),Un.push(Yn),Un.push(1)}Zn&&(_n.push(Xn[0]),_n.push(Kn),_n.push(1),Wn.push(Xn[1]),Wn.push(Kn),Wn.push(1),Un.push(Xn[2]),Un.push(Kn),Un.push(1)),N(_n,-4,'0#000000'),N(Wn,-4,'0#000000'),N(Un,-4,'0#000000')}}function wt(jn,Ln){for(var Pn=Ln.length,En=xct=xrt=0,Tn=0,On=0,Bn=0;Bn<Pn-1;Bn++)if(jn>=Ln[Bn][0]&&jn<Ln[Bn+1][0]||jn<=Ln[Bn][0]&&jn>Ln[Bn+1][0]){var In=Ln[Bn+1][0]-Ln[Bn][0];0==In?Tn=[Ln[Bn][1]*Ns,Ln[Bn][2]*Ns,Ln[Bn][3]*Ns]:(On=(jn-Ln[Bn][0])/(Ln[Bn+1][0]-Ln[Bn][0]),En=Ln[Bn][1]+On*(Ln[Bn+1][1]-Ln[Bn][1]),xct=Ln[Bn][2]+On*(Ln[Bn+1][2]-Ln[Bn][2]),xrt=Ln[Bn][3]+On*(Ln[Bn+1][3]-Ln[Bn][3]),Tn=[En*Ns,xct*Ns,xrt*Ns])}return Tn?Tn:jn<Ln[0][0]?[Ln[0][1]*Ns,Ln[0][2]*Ns,Ln[0][3]*Ns]:[Ln[Pn-1][1]*Ns,Ln[Pn-1][2]*Ns,Ln[Pn-1][3]*Ns]}function St(jn,Ln){var Pn=jn;return 7==Pn.length?(Pn=null==Ln?'0x'+Pn[5]+Pn[6]+Pn[3]+Pn[4]+Pn[1]+Pn[2]:'0x'+Pn[1]+Pn[2]+Pn[3]+Pn[4]+Pn[5]+Pn[6],parseInt(Pn)):0}function kt(){Ql?(Zs.style.display='none',$s.style.display='none',ei.style.display='none',li.style.display='none',si.style.display='none'):(Zs.style.display='',$s.style.display='',ei.style.display='',li.style.display='',si.style.display='')}function zt(){Zs.setAttribute('class','geobutton'),$s.setAttribute('class','geobutton'),ei.setAttribute('class','geobutton'),ti.setAttribute('class','geobutton'),li.setAttribute('class','geobutton')}function Dt(jn){var Ln=[],Pn=jn.length;for(var En in Ln.push(Lt(jn[0][0]+1,jn)),jn)jn[En][0]>jn[0][0]+1&&jn[En][0]<jn[Pn-1][0]-1&&Ln.push(Lt(jn[En][0],jn));return Ln.push(Lt(jn[Pn-1][0]-1,jn)),Ln}function Vt(jn){var Ln=tungeom[jn].TunProfile,Pn=parse3dmod(Ln),En=Dt(Pn),Tn=Rt(Pn);for(var On in En)Tn.add(Qt(En[On]));var Bn=(Pn[0][0]+Pn[Pn.length-1][0])/2,In=-La(Bn);return[Pn,Tn]}function Qt(jn){var Ln=[];for(var Pn in jn.v)Ln.push(jn.v[Pn].x),Ln.push(jn.v[Pn].y),Ln.push(jn.v[Pn].z);var En=new THREE.Object3D,Tn=N(Ln,10,'0#000000');return En.add(Tn),En}function Mt(){p2y=La;var jn=Vn,Ln=jn[0];lingeom=new THREE.Object3D,lingeom.add(Vn[1]),lingeom.add(Mn);var Pn=(Ln[0][0]+Ln[Ln.length-1][0])/2,En=La(Pn),Tn=getglobc((Sl+kl)/2);lingeom.position.set(-Tn.x,-Tn.y,-Tn.z);var On=jt(Ln),Bn=On[0];for(var In in partlingeom=On[1],pmat=new THREE.MeshBasicMaterial({map:buftext.texture,transparent:!0,opacity:0.5,depthTest:!0}),pmat.side=THREE.DoubleSide,my3dgroup=new THREE.Object3D,meshes=new THREE.Object3D,Bn){var Gn=new THREE.Mesh(Bn[In][2],pmat);Gn.castShadow=!1,Gn.receiveShadow=!1,meshes.add(Gn)}meshes.position.set(-Tn.x,-Tn.y,-Tn.z),my3dgroup.add(meshes),Ss=new THREE.Scene,Fs=Jl;var Tn=getglobc((Sl+kl)/2);console.log('Bound sphere');var Nn=new THREE.Object3D;''!=strin&&Nn.add(Ls),Nn.position.set(-Tn.x,-Tn.y,-Tn.z),my3dgroup.add(Nn),Bn[0][2].computeBoundingSphere();var _n=Bn[0][2].boundingSphere.center,Wn=new THREE.Quaternion;Wn.setFromUnitVectors(new THREE.Vector3(0,0,1),new THREE.Vector3(0,1,0)),my3dgroup.applyQuaternion(Wn);for(var Un,Hn,Xn=0;Xn<oman.ao.length;Xn++)if('B'==oman.ao[Xn].type){var Yn=$e(oman.get(Xn).xs,oman.get(Xn).ys),Kn=Pa(oman.get(Xn).ys),Zn=new THREE.Vector2(Yn.x,Yn.y);for(var $n in Bn)if(numintersect(Bn[$n][0],Bn[$n][1],Kn,Kn)){Un=qn(meshes.children[$n],Zn);break}var eo=$e(oman.get(Xn).xe,oman.get(Xn).ye),Kn=Pa(oman.get(Xn).ye),Zn=new THREE.Vector2(eo.x,eo.y);for(var $n in Bn)if(numintersect(Bn[$n][0],Bn[$n][1],Kn,Kn)){Hn=qn(meshes.children[$n],Zn);break}var to=Hn[0],ao=Hn[1],lo=Un[0],no=Un[1],oo=10,po=Fn(new THREE.Vector3(lo.x,lo.y,lo.z),new THREE.Vector3(to.x+1*(no.x*oo),to.y+1*(no.y*oo),to.z+1*(no.z*oo)));Nn.add(po)}my3dgroup.add(lingeom),my3dgroup.add(partlingeom),Ss.add(my3dgroup),Ss.add(fallar),Ss.add(line3dgroup),Ss.add(line3dtemp),controls.enableRotate=!0,ae()}function Rt(jn){for(var Ln=jn[0][1].length,Pn=new THREE.Object3D,En=[],Tn=jn[0][1],On=[],Bn=jn[0][0]+1;Bn<jn[jn.length-1][0]-1;Bn+=2)On.push(Lt(Bn,jn));for(var In in Tn){for(var Gn in En=[],On){var Nn=On[Gn],_n=Nn.v[In];En.push(_n.x,_n.y,_n.z)}var In=N(En,5,'0#000000');Pn.add(In)}return Pn}function At(jn,Ln){var Pn=[];if(jn<Ln[0][0])return Ps=[jn,Ln[0][1]],Ps;if(jn>Ln[Ln.length-1][0])return Ps=[jn,Ln[Ln.length-1][1]],Ps;for(var En=1;En<Ln.length;En++)if(jn>=Ln[En-1][0]&&jn<=Ln[En][0]){var Tn=Ln[En-1][0],On=Ln[En][0],Bn=(jn-Tn)/(On-Tn);for(var In in Ln[En][1]){var Gn=Ln[En][1][In],Nn=Ln[En-1][1][In];Pn.push(new THREE.Vector2(Gn.x*Bn+Nn.x*(1-Bn),Gn.y*Bn+Nn.y*(1-Bn)))}break}return Pn.length||console.log('Error! Vout not defined in getcurveatpel'),[jn,Pn]}function jt(jn){for(var Nn,Ln=Sl,Pn=kl,En=At(Ln,jn),Tn=At(Pn,jn),On=-1,Bn=[[0,En]],In=[],Gn=0;Gn<jn.length;Gn++)if((Nn=jn[Gn][0],Math.round(On)!=Math.round(Nn))&&(On=Nn,Nn=Math.round(Nn),Ka(Nn,Ln,Pn))){var _n=(Nn-Ln)/(Pn-Ln);In.push([_n,jn[Gn]])}if(0<pmult)for(var Wn=0;Wn<In.length;Wn++)Bn.push(In[Wn]);else for(var Wn=In.length-1;-1<Wn;Wn--)Bn.push(In[Wn]);Bn.push([1,Tn]);for(var Un=new THREE.Object3D,Hn=[],Xn=[],Wn=0;Wn<Bn.length-1;Wn++)for(var Yn=Bn[Wn][1][0],Kn=Bn[Wn+1][1][0],Zn=0,Gn=Yn;0>(Gn-Kn)*pmult;Gn+=5*pmult){Zn++;var _n=(Gn-Ln)/(Pn-Ln);if(Xn.push([_n,At(Gn,jn)]),500<Zn)return}Xn.push(Bn[Bn.length-1]);for(var Wn=1;Wn<Xn.length;Wn++){var $n=Lt(Xn[Wn][1][0],jn),eo=Lt(Xn[Wn-1][1][0],jn);Hn.push([Xn[Wn-1][1][0],Xn[Wn][1][0],Pt(eo,$n,Xn[Wn-1][0],Xn[Wn][0])])}return[Hn,Un]}function Lt(jn,Ln){var Pn=At(jn,Ln),En=getglobc(jn),Tn=getglobc(jn,1)[1]/180*Math.PI,On=getglobc(jn+0.01),Bn=new THREE.Quaternion;null==On?(On=getglobc(jn).sub(getglobc(jn-0.01)).normalize(),On=On.normalize(),On.z=0,Bn.setFromUnitVectors(new THREE.Vector3(1,0,0),On)):(On=getglobc(jn+0.01).sub(En),On=On.normalize(),On.z=0,Bn.setFromUnitVectors(new THREE.Vector3(1,0,0),On)),0.1<Math.abs(Bn.y)&&(console.log(jn,En,On),console.log(jn,Bn));var In={pel:jn,v:[]};for(var Gn in Pn[1]){var Nn=Pn[1][Gn],_n=Math.sin(Tn),Wn=Math.cos(Tn),Un=new THREE.Vector3(0,Nn.x,Nn.y);Un.applyAxisAngle(new THREE.Vector3(1,0,0),Tn),Un.applyQuaternion(Bn),Un.add(En),In.v.push(Un)}return In}function Pt(jn,Ln,Pn,En){var Tn=new THREE.Geometry,On=0,Bn=jn.v.length;Tn.faceVertexUvs[0]=[];for(var In=0;In<Bn-1;++In){var Gn=jn.v[In],Nn=jn.v[In+1],_n=Ln.v[In],Wn=Ln.v[In+1],Un=In/(Bn-1),Hn=(In+1)/(Bn-1),Xn=null==Pn?0:Pn,Yn=null==En?1:En;Tn.vertices.push(new THREE.Vector3(Gn.x,Gn.y,Gn.z)),Tn.vertices.push(new THREE.Vector3(Nn.x,Nn.y,Nn.z)),Tn.vertices.push(new THREE.Vector3(_n.x,_n.y,_n.z)),Tn.vertices.push(new THREE.Vector3(Wn.x,Wn.y,Wn.z)),Tn.faces.push(new THREE.Face3(On+2,On+1,On)),Tn.faces.push(new THREE.Face3(On+1,On+2,On+3)),Tn.faceVertexUvs[0].push([new THREE.Vector2(Un,Yn),new THREE.Vector2(Hn,Xn),new THREE.Vector2(Un,Xn)]),Tn.faceVertexUvs[0].push([new THREE.Vector2(Hn,Xn),new THREE.Vector2(Un,Yn),new THREE.Vector2(Hn,Yn)]),On+=4}return Tn.uvsNeedUpdate=!0,Tn.computeFaceNormals(),Tn}function Et(){Mn=new THREE.Object3D;var jn=tun2='';if('34100'==params.tunnel&&(tun2='34100',jn='34000'),'34000'==params.tunnel&&(tun2='34000',jn='34100'),jn){globavg=tungeom[jn].Geo3d.globavg,globtc=tungeom[jn].Geo3d.globtc,Mn=Vt(jn)[1];var Ln=tv().copy(tungeom[jn].Geo3d.globavg).sub(tungeom[tun2].Geo3d.globavg);Ln.y=-Ln.y,Mn.position.set(Ln.x,Ln.y,Ln.z)}globavg=tungeom[params.tunnel].Geo3d.globavg,globtc=tungeom[params.tunnel].Geo3d.globtc,globtc[0].pel-=0.1,('Kjorholt'==params.tunnel||'Tunnel1'==params.tunnel)&&(globtc[0].pel=13650),globtc[globtc.length-1].pel+=0.1,Vn=Vt(params.tunnel),''!=strin&&(Ls=makecloud(strin))}function Tt(){var jn=linez.length;if(!(2>jn)){for(var Pn,Ln=1;Ln<jn;Ln++)Pn=new ja,Pn.addline(linez[Ln-1].xs,linez[Ln-1].ys,1,linez[Ln].xs,linez[Ln].ys,1,Math.round(30*params.size),'#000000'),oman.add(Pn);var En=linez[0].v,Tn=linez[Math.floor(jn/2)].v,On=linez[jn-1].v,Bn=Ot();return Bn}}function Ot(){for(var jn=linez.length,Ln=Math.floor(jn/3),Pn=Math.floor(2*jn/3),En=tv(),Tn=tv(),On=tv(),Bn=0;Bn<Ln;Bn++)En.add(linez[Bn].v);En.multiplyScalar(1/Ln);for(var Bn=Ln;Bn<Pn;Bn++)Tn.add(linez[Bn].v);Tn.multiplyScalar(1/(Pn-Ln));for(var Bn=Pn;Bn<jn;Bn++)On.add(linez[Bn].v);return On.multiplyScalar(1/(jn-Pn)),[En,Tn,On]}function Gt(jn){var Ln=new THREE.Plane().setFromCoplanarPoints(jn[0],jn[1],jn[2]),Pn=new THREE.Vector3((jn[0].x+jn[1].x+jn[2].x)/3,(jn[0].y+jn[1].y+jn[2].y)/3,(jn[0].z+jn[1].z+jn[2].z)/3),En=new THREE.BoxGeometry(150,150,0.5),Tn=new THREE.MeshBasicMaterial({color:17408,transparent:!0,opacity:0.1}),On=new THREE.Mesh(En,Tn),Bn=new THREE.Quaternion;Bn.setFromUnitVectors(new THREE.Vector3(0,0,1),Ln.normal),On.applyQuaternion(Bn),On.position.set(Pn.x,Pn.y,Pn.z),On.scale.set(fscale.val,fscale.val,1),fallar.add(On)}function Nt(jn){var Ln=new THREE.Plane().setFromCoplanarPoints(jn[0],jn[1],jn[2]),Pn=new THREE.Vector3((jn[0].x+jn[1].x+jn[2].x)/3,(jn[0].y+jn[1].y+jn[2].y)/3,(jn[0].z+jn[1].z+jn[2].z)/3),En=Ln.normal;0>En.y&&En.negate();var Tn=180*new THREE.Vector3(0,1,0).angleTo(En)/Math.PI,On=Pa(linez[0].ys),Bn=getglobc(On+1).sub(getglobc(On));Bn=Bn.normalize();var In=getglobc((Sl+kl)/2),Gn=new THREE.Quaternion;Gn.setFromUnitVectors(new THREE.Vector3(0,0,1),new THREE.Vector3(0,1,0)),Bn.applyQuaternion(Gn);var Nn=new THREE.Quaternion;Nn.setFromUnitVectors(new THREE.Vector3(0,1,0).applyQuaternion(Gn),new THREE.Vector3(1,0,0).applyQuaternion(Gn));var _n=tv().copy(Bn).applyQuaternion(Nn),Wn=new THREE.Plane().setFromCoplanarPoints(Pn,tv().copy(Pn).add(_n),tv().copy(Pn).add(Bn)),Un=tv().copy(En).projectOnPlane(Wn.normal),Hn=Un.angleTo(Bn)<Math.PI/2?1:0,Xn=180*Un.angleTo(_n)/Math.PI;return Xn=Hn?360-Xn:Xn,console.log('Strike:',Xn),console.log('Dip/Fall',Tn),[Math.floor(Xn),Math.round(Tn)]}function Ut(){if(linez.length){var jn=new ConvexHullGrahamScan;for(var Ln in linez)jn.addPoint(linez[Ln].xs,linez[Ln].ys);var Pn=jn.getHull(),En=[];for(var Tn in linez)for(var Ln in Pn){var On=linez[Tn];Pn[Ln].x==On.xs&&Pn[Ln].y==On.ys&&En.push(On)}linez=En,linez.sort(function(_n,Wn){return Wn.xs-_n.xs});var Bn=y=0;for(var Tn in linez)Bn+=linez[Tn].xs,y+=linez[Tn].ys;Bn/=linez.length,y/=linez.length;var In=Tt(),Gn=Nt(In),Nn=new ja;Nn.addfall(Bn,y,8,Gn[0],Gn[1],1),Nn.color=In,oman.plot(Nn),oman.add(Nn),Ht(linez),Qa(),ae(),linez=[],controls.enableRotate=!0,check3dbox.checked=!0,Ji.updateDisplay()}}function Ht(jn){var Ln=[];for(var Pn in jn)Ln.push(jn[Pn].v.x,jn[Pn].v.y,jn[Pn].v.z);if(Ln.length){var En=N(Ln,Math.round(40*params.size),'#000000',1);line3dgroup.add(En)}}function Xt(jn,Ln){var Pn=new Date().getTime(),En=5e3;if(null!=Ln&&(En=Ln),Pn-ms>En){for(var Tn in Rl){var On=Rl[Tn];On.redrawInterval=1}for(var Tn in ae(jn),Rl){var On=Rl[Tn];On.redrawInterval=1e5}ms=Pn}else ae(jn)}function ea(){params.withbg?ia(gl):ia(''),fi.material=bi,ae()}function ia(jn){if(''==jn)bi=new THREE.MeshBasicMaterial({color:16777215});else{var Ln=new THREE.TextureLoader;Ln.crossOrigin='anonymous';var Pn=Ln.load(jn,function(){ae()});Pn.magFilter=THREE.NearestFilter,Pn.minFilter=THREE.LinearMipMapLinearFilter,Pn.anisotropy=2,Sl>kl&&(Pn.flipY=!1),bi=new THREE.MeshBasicMaterial({map:Pn})}}function oa(jn,Ln){wl=getsessionid(),M(),kl=parseInt(Ln),Sl=parseInt(jn),pmult=Sl<kl?1:-1,Dl=(Sl+kl)/2,zl=Math.abs(parseInt(Sl)-parseInt(kl)),Fl=50,11>zl&&(Fl=100),6>zl&&(Fl=200),hl=Fl*zl,Cl=hl,_s=hl/Gs,E(Sl,kl,Ws),vt(Sl,kl),ca(gl,0),ua(Sl,kl,-1),params.resetcam(),ae(),picparams.ps=Sl,picparams.pe=kl,saveifokdist(picparams.ps,picparams.pe),fgui.updateDisplay()}function ra(jn,Ln,Pn){var En=params.tunnel;null!=Pn&&(En=Pn);var Tn=jn>Ln,On=Math.min(jn,Ln),Bn=Math.max(jn,Ln);if(20>Math.abs(On-Bn))var In=20*Math.floor(On/20),Gn=20*Math.floor((Bn-0.01)/20+1);else var In=1*Math.floor(On/1),Gn=1*Math.floor((Bn-0.01)/1+1);var Nn=gettunlim(En);('Kjorholt'==params.tunnel||'Tunnel1'==params.tunnel)&&(Nn.pmin=13650),'34100'==params.tunnel&&(Nn.pmin=0);var _n=checklims(In,Gn,Nn);In=_n[0],Gn=_n[1],gl='',Tn?oa(Gn,In):oa(In,Gn),picdb.sortbypelasc();for(var Wn=getpicsinrange(En,In,Gn),Un=Wn[0];Un<=Wn[1];Un++)pa(picdb.files[Un],Tn);rt(),fgui.close(),Ji.close()}function pa(jn,Ln){var Pn=Sl>kl;null!=Ln&&(Pn=Ln);var En=new THREE.TextureLoader;En.crossOrigin='anonymous';var Tn=En.load(jn.pic,function(){ae()});Tn.magFilter=THREE.NearestFilter,Tn.minFilter=THREE.LinearMipMapLinearFilter,Tn.anisotropy=2,Pn&&(Tn.flipY=!1);var On=new THREE.MeshBasicMaterial({map:Tn}),Bn=Math.abs(La(Math.max(jn.ps,jn.pe))-La(Math.min(jn.ps,jn.pe))),In=La((jn.ps- -jn.pe)/2),Gn=new THREE.PlaneGeometry(Bn,2*Ns,1,1);fi=new THREE.Mesh(Gn,On),fi.position.set(0,In,0.01);var Nn=Pn?Math.PI:0;fi.rotateZ(Math.PI/2+Nn),Hl.push(fi),Qs.add(fi)}function ca(jn,Ln){Jl.remove(Qs),Qs=new THREE.Object3D,Hl.length=0,ia(jn);var Pn=new THREE.PlaneGeometry(2*_s,2*Ns,1,1);fi=new THREE.Mesh(Pn,bi),fi.position.set(0,Ln/Fl,0);var En=Sl>kl?Math.PI:0;fi.rotateZ(Math.PI/2+En),Hl.push(fi),Qs.add(fi),Jl.add(Qs)}function ua(jn,Ln,Pn,En,Tn){var On,Bn=!1;-1==Pn?(Bn=!0,On=11184810):(On=16711680,1<Pn&&(On=16769024),4<Pn&&(On=16746240),10<Pn&&(On=2258722));var In=Bn?1:0.8,Gn=new THREE.MeshBasicMaterial({color:On,transparent:!0,opacity:In}),Nn=La((jn+Ln)/2),_n=Math.abs(La(Ln)-La(jn)),Wn=Ns/3,Un=-Ns-Wn+Ns/10,Hn=new THREE.PlaneGeometry(Wn,_n,1,1),Xn=new THREE.Mesh(Hn,Gn);if(Xn.position.set(Un,Nn,Bn?0:1),Bn){var Yn=Ts.children[0];null!=Yn&&Ts.remove(Yn),Ts.add(Xn),Hl.push(Xn)}else{Es.add(Xn);var Kn=X('Q='+Pn+' '+En,Un,Nn,10,0);if(Es.add(Kn),null!=Tn&&''!=Tn){for(var Zn='',$n=0;$n<Math.min(4,Tn.length);$n++)Zn+=Tn[$n];Zn+='..!';var eo=X(Zn,Un-0.35*Us,Nn+0.38*_n,10,1);Es.add(eo)}}}function ha(){for(;Es.children.length;){var jn=Es.children[0];'undefined'!=typeof jn.material&&jn.material.dispose(),'undefined'!=typeof jn.geometry&&jn.geometry.dispose(),Es.remove(jn)}}function ga(){for(;Os.children.length;){var jn=Os.children[0];'undefined'!=typeof jn.material&&jn.material.dispose(),'undefined'!=typeof jn.geometry&&jn.geometry.dispose(),Os.remove(jn)}}function ya(){for(;Cs.children.length;){var jn=Cs.children[0];'undefined'!=typeof jn.material&&jn.material.dispose(),'undefined'!=typeof jn.geometry&&jn.geometry.dispose(),Cs.remove(jn)}for(;js.children.length;){var jn=js.children[0];'undefined'!=typeof jn.material&&jn.material.dispose(),'undefined'!=typeof jn.geometry&&jn.geometry.dispose(),js.remove(jn)}for(;Ms.children.length;){var jn=Ms.children[0];'undefined'!=typeof jn.material&&jn.material.dispose(),'undefined'!=typeof jn.geometry&&jn.geometry.dispose(),Ms.remove(jn)}}function ba(jn,Ln){var Pn=document.createElement('input',Ln);Pn.setAttribute('class','inguib'),Pn.setAttribute('type','button'),Pn.setAttribute('value',jn),Pn.setAttribute('id','mgb'+jn);var En=new Hammer(Pn);return Pn.onfocus=function(){Pn.blur()},En.on('press',function(){mycswitch(Pn,'ibpressed',500),null!=Ln&&setTimeout(function(){Ln()},150)}),En.get('press').set({threshold:100,time:3}),Pn}function xa(){var jn=new FormData;jn.append('data',params.author);try{var Ln=window.XMLHttpRequest?new XMLHttpRequest:new activeXObject('Microsoft.XMLHTTP');Ln.onreadystatechange=function(){if(4===Ln.readyState){var Pn=JSON.parse(Ln.response);filetable(container,Pn,function(En){var Tn=pelfromfname(En),On=Tn[0],Bn=Tn[1];saveifokdist(On,Bn),wa(En)})}},Ln.open('post',baseaddr+'getflist.php',!0),Ln.send(jn)}catch(Pn){console.log(Pn)}}function wa(jn){var Ln=new FormData;Ln.append('fname',jn);try{var Pn=window.XMLHttpRequest?new XMLHttpRequest:new activeXObject('Microsoft.XMLHTTP');Pn.onreadystatechange=function(){if(4===Pn.readyState){if(params.overridepel){var En=pelfromfname(jn),Tn=getpelrange(Pn.response,En[0],En[1]);Cn=[],gl='',oa(Tn[0],Tn[1])}Ra(Pn.response),allq.update(),Qa(),ae()}},Pn.open('post',baseaddr+'gettxt.php',!0),Pn.send(Ln)}catch(En){console.log(En)}}function Sa(jn){var Ln=basekjor;'Kjorholt'==jn&&(Ln=basekjor),'Bamle'==jn&&(Ln=basebamble);var Pn=jn+picparams.ps+'_'+picparams.pe+'.xml',En=Ln+Ta(jn)+endfile,Tn=vkbeautify.xml(En);download(Tn,Pn)}function ka(jn,Ln){var Pn=Ji.add(bf,'blank').name('Geology:');Pn.onChange(function(){Ji.close()}),Pn.__li.setAttribute('class','cr function first');var En=parseFloat(Ji.domElement.style.width)-1;Pn.__li.style.width=En+'px';var Tn=Qe(Ji),On=ba('ShowDB',function(){Ai.showdb()});On.setAttribute('class','inguib but2gui'),Tn.appendChild(On),On=ba('Save',function(){params.save()}),On.setAttribute('class','inguib but2gui'),Tn.appendChild(On),Fi=Ji.addFolder('Save/Open file'),Fi.add(params,'loadprev').name(qa.restoresession),Fi.add(params,'savealpha').name(qa.savepicture),Fi.add(params,'author').name(qa.author).onChange(function(){ke()}).domElement.children[0].setAttribute('maxlength','20'),Fi.add(params,'save').name(qa.savegeology),Fi.add(params,'openfile').name(qa.openfilegeology);var Bn=Fi.addFolder('Expert');if(Bn.add(params,'ex').name('Expert user').onChange(function(){Ji.close(),Da(Yl)}),Bn.add(params,'overridepel').name('Override pel'),Bn.add(params,'withbg').name(qa.showmwd).onChange(function(){ea()}),Bn.add(params,'showbergart').name(qa.showrocktype).onChange(function(){allp.update(),ae()}),Bn.add(params,'forcesync').name('ForcedSync'),null!=jn&&(jn==qa.qval&&za(),'Select'==jn)){Mi=Ji.addFolder(qa.setproperties);var In=sid2txtdate(_i.sid)+' '+_i.author;if(Mi.add(bf,'blank').name(In),Mi.add(_i,'author').name(qa.author),'T'!=Ln){q22=Mi.add(_i,'comment').name('');var Gn=q22.domElement.children[0];Gn.setAttribute('class','myta'),q22.domElement.setAttribute('class','c bigtadiv'),Gn.placeholder='Comment...',Gn.onkeyup=function(){Me(this)},Gn.onchange=function(){Be()},q22.__li.setAttribute('class','cr string bigta')}if('T'==Ln&&(Mi.add(Xl[Bs],'text').name(qa.text).onChange(function(){Z(Bs,Xl[Bs].text)}),Mi.add(params,'openfoto').name(qa.takephoto),Mi.add(params,'makelab').name(qa.labtest)),null==Ln||'L'==Ln){Mi.add(_i,'bergart',vi).name(qa.rocktype).listen().onChange(function(){params.parcolor=Ce(_i.bergart),Ji.updateDisplay()});var Tn=Mi.addColor(params,'parcolor').name(qa.color).listen().onChange(function(){params.parcolor=Ce(_i.bergart),Ji.updateDisplay()}),Nn=Tn.domElement.children[0];Nn.style.width='70%'}return'W'==Ln&&(Mi.add(_i,'dsc',qa.dsc).name(qa.description),Mi.add(_i,'wdrip').name(qa.dripmin),Mi.add(_i,'wleak').name(qa.litmin)),'F'==Ln&&(Mi.add(Xl[Bs],'angle',0,360).step(1).name(qa.angle).onChange(function(){$(Bs,Xl[Bs].fall,Xl[Bs].angle)}),Mi.add(Xl[Bs],'fall',0,90).step(1).name(qa.fall).onChange(function(){$(Bs,Xl[Bs].fall,Xl[Bs].angle)})),Mi.add(bf,'blank').name(''),void Mi.add(params,'applyP').name(qa.ap)}Qi=Ji.addFolder(qa.main),Qi.add(bf,'blank').name(''),params.ex&&(Qi.add(params,'bolt').name(qa.bolt),F(Qi),Qi.add(params,'clear').name(qa.clearall),F(Qi),Qi.add(params,'resetcam').name(qa.resetcamera),F(Qi))}function za(){Vi=Ji.addFolder(qa.qval);var jn=sid2txtdate(Ni.lastchange)+' by \''+Ni.author+'\'';Vi.add(bf,'blank').name('Updated '+jn);var Ln=Vi.add(Ni,'ps').name('Pel start').domElement.children[0];Ln.type='tel',Ln.setAttribute('maxlength','5'),Ln=Vi.add(Ni,'pe').name('Pel end').domElement.children[0],Ln.type='tel',Ln.setAttribute('maxlength','5'),q22=Vi.add(Ni,'comment').name('');var Pn=q22.domElement.children[0];Pn.setAttribute('class','myta'),q22.domElement.setAttribute('class','c bigtadiv'),Pn.placeholder='Comment...',Pn.onkeyup=function(){Me(this)},20<Ni.comment.length&&Me(Pn),Pn.onchange=function(){Te()},q22.__li.setAttribute('class','cr string bigta');var Ln=Qe(Vi);Ci.rqd=ba('RQD',function(){params.editRQD()}),Ln.appendChild(Ci.rqd),Ci.Jr=ba('Jr',function(){params.editJr()}),Ln.appendChild(Ci.Jr),Ci.Jw=ba('Jw',function(){params.editJw()}),Ln.appendChild(Ci.Jw),Ci.Jn=ba('Jn',function(){params.editJn()}),Ln.appendChild(Ci.Jn),Ci.Ja=ba('Ja',function(){params.editJa()}),Ln.appendChild(Ci.Ja),Ci.SRF=ba('SRF',function(){params.editSRF()}),Ln.appendChild(Ci.SRF);var En=Vi.add(bf,'blank').name('');En.__li.setAttribute('class','cr function qtext'),Ci.Q=En,Vi.add(Ni,'bergart',vi).name(qa.rocktype);var Ln=Qe(Vi),Tn=ba(qa.apply,function(){Te()});Tn.setAttribute('class','inguib but2gui'),Ln.appendChild(Tn);var Tn=ba(qa.removeq,function(){params.removeq()});Tn.setAttribute('class','inguib but2gui'),Ln.appendChild(Tn)}function Fa(){Ji=new dat.GUI({autoPlace:!1,width:Math.min(400,ii/2-4)}),container.appendChild(Ji.domElement),Ji.domElement.id='guipos'}function Da(jn,Ln){Yl=jn;var Pn=jn;Ql?(Pn='3d',globgeo='Settings'):globgeo='Geology',kt(),null==Pn&&(Il=[],chosenp=-2);var En=Ji.closed;if(container.removeChild(Ji.domElement),Ji.destroy(),Fa(),'3d'==Pn){var Tn=Ji.add(bf,'blank').name('Settings:');Tn.onChange(function(){Ji.close()}),Tn.__li.setAttribute('class','cr function first');var On=parseFloat(Ji.domElement.style.width)-1;return Tn.__li.style.width=On+'px',Ji.add(lingeom,'visible').name('Tunnel frame').onChange(function(){ae()}),Rn&&(pointval.valmin=23,params.opacity=0.3,pointCloud.geometry.drawRange.start=pointval.ar[pointval.valmin-1],pointCloud.geometry.drawRange.count=pointval.ar[pointval.valmax-1]-pointCloud.geometry.drawRange.start,meshes.children[0].material.opacity=params.opacity,pMaterial.size=10,ae(),Rn=0),''!=strin&&(Ji.add(pointval,'valmin',1,pointval.ar.length).name('Min').step(1).onChange(function(){pointCloud.geometry.drawRange.start=pointval.ar[pointval.valmin-1],pointCloud.geometry.drawRange.count=pointval.ar[pointval.valmax-1]-pointCloud.geometry.drawRange.start,ae()}),Ji.add(pointval,'valmax',1,pointval.ar.length).name('Max').step(1).onChange(function(){pointCloud.geometry.drawRange.count=pointval.ar[pointval.valmax-1]-pointCloud.geometry.drawRange.start,ae()}),Ji.add(pMaterial,'size',5,35).name('Point size').step(1).onChange(function(){ae()}),Ji.add(params,'opacity',0,1).name('Tunnel opacity').step(0.1).onChange(function(){meshes.children[0].material.opacity=params.opacity,ae()})),Ji.add(fscale,'val',0,1).name('Plane size').step(0.02).onChange(function(){for(var In in fallar.children)fallar.children[In].scale.set(fscale.val,fscale.val,1);ae()}),void Ji.updateDisplay()}if(ka(Pn,Ln),null==Ln&&Na(),zt(),'Line'==Pn&&(Zs.setAttribute('class','geobuttonf'),params.linetype='Line',Qi.add(params,'lineStyle',qa.lineStylear).name(qa.ls),Qi.add(params,'linemagnet').name('Magnet'),params.ex&&Qi.add(params,'size',0.1,1).name('Size').step(0.1),Qi.add(bf,'blank').name('')),'Water'==Pn&&($s.setAttribute('class','geobuttonf'),params.linetype='Water',Qi.add(params,'wsize',0.1,1).step(0.1).name('Size'),Qi.add(bf,'blank').name('')),'Text'==Pn){ei.setAttribute('class','geobuttonf'),params.linetype='Text',q22=Qi.add(params,'text').name(qa.ttp),Qi.add(bf,'blank').name('');var Bn=q22.domElement.children[0];Bn.setAttribute('class','myta'),Bn.placeholder='Text...',En=!1}'Fall'==Pn&&(ti.setAttribute('class','geobuttonf'),params.linetype='Fall',q22=Qi.add(params,'angle',0,360).step(1).name(qa.angle),Qi.add(params,'fall',0,90).step(1).name(qa.fall),Qi.add(bf,'blank').name(''),En=!1),'Bolt'==Pn&&(params.linetype='Bolt',Qi.add(params,'boltlen',1,10).step(0.5).name(qa.len),Qi.add(params,'bolttype',qa.boltlist).name(qa.material),Qi.add(bf,'blank').name('')),'Select'==Pn||'Q - value'==Pn?(li.setAttribute('class','geobuttonf'),params.linetype='Select'):Qi.open(),Ji.updateDisplay(),En?Ee():Pe()}function Va(){for(var jn in Rs.children.length=0,oman.ao){var Ln=oman.ao[jn];Ln.toskip||'B'!=Ln.type||oman.plot(Ln)}}function Qa(){ya(),xt();for(var jn=[],Ln=0;Ln<Xl.length;Ln++)0==Xl[Ln].skip&&jn.push(Xl[Ln]);for(var Tn,On,Pn=yprev=cprev=sprev=-1e3,En=[],Ln=0;Ln<jn.length;Ln++)if('L'==jn[Ln].type)if(Pn==jn[Ln].xs&&yprev==jn[Ln].ys&&cprev==jn[Ln].color&&sprev==jn[Ln].size){var Bn=[jn[Ln].xe,jn[Ln].ye,jn[Ln].zs];Pn=jn[Ln].xe,yprev=jn[Ln].ye,En.push(Bn[0]),En.push(Bn[1]),En.push(Bn[2])}else N(En,On,Tn),Pn=jn[Ln].xe,yprev=jn[Ln].ye,cprev=jn[Ln].color,sprev=jn[Ln].size,En=[jn[Ln].xs,jn[Ln].ys,jn[Ln].zs,Pn,yprev,jn[Ln].zs],Tn=jn[Ln].color,On=jn[Ln].size;N(En,On,Tn)}function Ma(){this.oldzero=1,this.oldppu=1,this.oldpw=1,this.getnewy=function(jn){var Pn=La(jn);return Pn=mr(Pn),Pn},this.getnewx=function(jn){var Ln=jn/this.oldpw*Ns;return Ln=mr(Ln),Ln}}function Ca(jn,Ln){for(var Pn in Ln)for(var En=Ln[Pn],Tn=0;Tn<En.length;Tn++)if(En[Tn]==jn)return''+Pn;return null}function Ra(jn){mt.start('Get json');var Ln='object'==typeof jn?JSON.parse(JSON.stringify(jn)):JSON.parse(jn);var Pn=Ln.objdata;mt.end('Get json');var En=new Ma,Tn=Ln.authors,On=Ln.sids,Bn=Ln.chlist;if(null==Bn||isEmpty(Bn))for(var In in On)oman.changelist[In]=In;else for(var In in On)oman.changelist[In]=Bn[In];En.oldzero=Ln.zeropel,An=Ln.author,En.oldppu=Ln.pelperunit,En.oldpw=Ln.pw,Jn=Ln.sid,allq.restore(Ln.qval,1);for(var Gn=Ln.pval,Nn=0;Nn<Gn.par.length;Nn++)for(var In=0;In<Gn.par[Nn].coords.length;In+=2)Gn.par[Nn].coords[In]=En.getnewx(Gn.par[Nn].coords[In]),Gn.par[Nn].coords[In+1]=En.getnewy(Gn.par[Nn].coords[In+1],1);allp.restore(Gn,1);for(var Xn,_n=Pn.length,Wn=6,Un='#000000',Hn=qy=qz=tmpy=tmpx=-1e3,In=0;In<_n;In++){if(Xn=new ja,null==On)Xn.sid=Jn;else{var Yn=Ca(In,On);Xn.sid=null==Yn?Jn:Yn}if(null==Tn)Xn.author=An;else{var Yn=Ca(In,Tn);Xn.author=null==Yn?An:Yn}var Kn=Pn[In];if(2==Kn.length){tmpx=En.getnewx(Kn[0]/qprec),tmpy=En.getnewy(Kn[1]/qprec),Xn.addline(Hn,qy,qz,tmpx,tmpy,qz,Wn,Un),Hn=En.getnewx(Kn[0]/qprec),qy=En.getnewy(Kn[1]/qprec),oman.isdublicate(Xn),oman.plot(Xn),oman.add(Xn);continue}if(0==Kn[0]){Wn=15,Un='#000000',6<Kn.length&&('number'==typeof Kn[6]&&(Wn=Kn[6]),'string'==typeof Kn[6]&&(Un=Kn[6])),8==Kn.length&&(Un=Kn[7]),Hn=En.getnewx(Kn[4]/qprec),qy=En.getnewy(Kn[5]/qprec),qz=Kn[3],tmpx=En.getnewx(Kn[1]/qprec),tmpy=En.getnewy(Kn[2]/qprec),Xn.addline(tmpx,tmpy,qz,Hn,qy,qz,Wn,Un),oman.isdublicate(Xn),oman.plot(Xn),oman.add(Xn);continue}if(1==Kn[0]){Wn=0.5,3<Wn.length&&(Wn=Kn[3]),tmpx=En.getnewx(Kn[1]/qprec),tmpy=En.getnewy(Kn[2]/qprec),Xn.addwater(tmpx,tmpy,10,Wn),oman.isdublicate(Xn),oman.plot(Xn),oman.add(Xn);continue}if(2==Kn[0]){tmpx=En.getnewx(Kn[1]/qprec),tmpy=En.getnewy(Kn[2]/qprec);var Zn=Kn[4];'_pho_'==Zn.slice(0,5)&&(Xn.fall=1,Zn=Zn.slice(5),console.log(Zn)),'_lab_'==Zn.slice(0,5)&&(Xn.fall=2,Zn=Zn.slice(5)),Xn.addtext(Zn,tmpx,tmpy,Kn[3],1),oman.isdublicate(Xn),oman.plot(Xn),oman.add(Xn);continue}if(3==Kn[0]&&(tmpx=En.getnewx(Kn[1]/qprec),tmpy=En.getnewy(Kn[2]/qprec),Xn.addfall(tmpx,tmpy,10,Kn[3],Kn[4],Kn[5]),null!=Kn[6]&&(Xn.color=[tv(Kn[6][0].x,Kn[6][0].y,Kn[6][0].z),tv(Kn[6][1].x,Kn[6][1].y,Kn[6][1].z),tv(Kn[6][2].x,Kn[6][2].y,Kn[6][2].z)]),oman.isdublicate(Xn),oman.plot(Xn),oman.add(Xn)),4==Kn[0]){Xn.addbolt(En.getnewx(Kn[1]/qprec),En.getnewy(Kn[2]/qprec),Kn[3],En.getnewx(Kn[4]/qprec),En.getnewy(Kn[5]/qprec),Kn[6],Kn[7]),oman.isdublicate(Xn),oman.plot(Xn),oman.add(Xn);continue}}}function Ja(jn,Ln,Pn){var En=0.02/Math.abs(Sl-kl);null!=Pn&&(En=Pn);var Tn=Math.abs(parseFloat(jn)-parseFloat(Ln));return!!(Tn<En)}function Aa(jn,Ln){var En=Math.abs(parseFloat(jn)-parseFloat(Ln));return En}function ja(){this.type='',this.sid=wl,this.author=params.author,this.id=0,this.skip=0,this.text='',this.xs=0,this.ys=0,this.zs=0,this.xe=0,this.ye=1,this.ze=1,this.size=3,this.color='',this.fall=0,this.angle=0,this.lastmx=-1e3,this.lastmy=-1e3,this.sameas=function(jn){return this.type==jn.type&&Ja(this.xs,jn.xs)&&Ja(this.ys,jn.ys)},this.addline=function(jn,Ln,Pn,En,Tn,On,Bn,In){this.type='L',this.size=Bn,this.color=In,this.xs=jn,this.ys=Ln,this.zs=Pn,this.xe=En,this.ye=Tn,this.ze=On},this.addbolt=function(jn,Ln,Pn,En,Tn,On,Bn){this.type='B',this.text=Bn,this.xs=jn,this.ys=Ln,this.zs=Pn,this.xe=En,this.ye=Tn,this.ze=On},this.addwater=function(jn,Ln,Pn,En,Tn,On,Bn,In){this.type='W',this.size=En,this.xs=jn,this.ys=Ln,this.zs=Pn,null!==Tn&&(this.text=Tn),null!==On&&(this.xe=On),null!==Bn&&(this.fall=Bn),null!==In&&(this.angle=In)},this.addfall=function(jn,Ln,Pn,En,Tn,On){this.type='F',this.xs=jn,this.ys=Ln,this.zs=Pn,this.angle=En,this.fall=Tn,this.size=null==On?_e(Pa(Ln)):On},this.addtext=function(jn,Ln,Pn,En){this.type='T',this.text=jn,this.xs=Ln,this.ys=Pn,this.zs=En}}function La(jn){var Ln=parseFloat(2*(pmult*(jn-parseFloat(Dl))*Fl/Gs));return Ln}function Pa(jn){var Ln=parseFloat(pmult*jn/(2*(Fl/Gs))+Dl);return Ln}function Ea(){var jn=new Date,Ln=parseInt(jn.getMonth()+1),Pn={date:jn.getFullYear()+'-'+az(Ln)+'-'+az(jn.getDate()),author:params.author};return Pn}function Ta(jn){for(var Ln=[],Pn=[],En={pmult:pmult,pelperunit:1/(2*(Fl/Gs)),zeropel:Dl,pw:Ns,author:params.author,tunnel:jn},Tn=new myxml(En),On={type:'w',da:Ea(),coords:[0,1],comment:'',dsc:0,drip:'',leak:''},Bn={type:'t',da:Ea(),coords:[0,1],comment:'',fall:0},In={type:'f',da:Ea(),coords:[0,1],comment:'',angle:0,fall:0},Gn={type:'l',da:Ea(),coords:[0,1],ltype:0,comment:'',bergart:'none',color:'',width:0},Nn={type:'q',da:Ea(),coords:[0,1],QVal:[],bergart:'none',color:0,comment:''},_n=0;_n<allq.qar.length;_n++){var Wn=allq.qar[_n],Un=Nn;Un.da.author=Wn.author,Un.da.date=sid2date(Wn.lastchange),Un.coords=[Wn.ps,Wn.pe],Un.QVal=[Wn.RQD,Wn.Jn,Wn.Jr,Wn.Ja,Wn.Jw,Wn.SRF,Wn.Q],Un.bergart=Wn.bergart,Un.comment=Wn.comment,Un.color=St(Ce(Wn.bergart)),Tn.parseos(Un)}for(var _n=0;_n<Xl.length;_n++)if(!Xl[_n].skip&&!isinarray(Pn,_n)){var Hn=Ae(_n);if(!isinarray(Ln,Hn)){var Kn,Xn=Re(_n),Yn=-2<Hn?1:0;Yn&&(Ln.push(Hn),Kn=allp.par[Hn]);var $n,Zn=Xl[_n];if('L'==Xn)if($n=Gn,$n.da.author=Zn.author,$n.da.date=sid2date(Zn.sid),$n.ltype=Zn.color[0],Yn)Kn.isarea&&($n.ltype=5),$n.coords=Kn.coords,$n.comment=Kn.comment,$n.bergart=Kn.bergart,$n.color=Kn.color,$n.width=Kn.width;else{for(var eo=he(_n),to=0;to<eo.length;to++)Pn.push(eo[to]);$n.coords=ge(eo)}'W'==Xn&&($n=On,$n.da.author=Zn.author,$n.da.date=sid2date(Zn.sid),$n.coords=[Zn.xs,Zn.ys],Yn&&(Kn.comment&&($n.comment=Kn.comment),Kn.dsc&&($n.dsc=Kn.dsc),Kn.wdrip&&($n.drip=Kn.wdrip),Kn.wleak&&($n.leak=Kn.wleak))),'T'==Xn&&($n=Bn,$n.da.author=Zn.author,$n.da.date=sid2date(Zn.sid),$n.coords=[Zn.xs,Zn.ys],$n.comment=Zn.text,$n.fall=Zn.fall),'B'==Xn&&($n=Bn,$n.da.author=Zn.author,$n.da.date=sid2date(Zn.sid),$n.coords=[Zn.xs,Zn.ys],$n.comment='B'),'F'==Xn&&($n=In,$n.da.author=Zn.author,$n.da.date=sid2date(Zn.sid),$n.coords=[Zn.xs,Zn.ys],$n.angle=Zn.size?Zn.angle:360-Zn.angle,$n.fall=Zn.fall),Tn.parseos($n)}}return Tn.showstrout()}function Oa(jn,Ln){for(var Pn=[],En=[],Tn=JSON.parse(JSON.stringify(jn)),On=0;On<Tn.length;On++)if(!isinarray(En,On)){var Bn=params.onlynew&&!Ln?Tn[On].sid==wl:1;1<params.onlynew&&(Bn=Tn[On].sid==params.onlynew?1:0);var In=1;if(params.onlycurpel&&!Ln&&!Ya(Pa(Tn[On].ys))){var Gn=he(On);add2array(En,Gn),In=0}!Tn[On].skip&&Bn&&In&&Pn.push(Tn[On])}return Pn}function Ba(jn){var Ln=0;null!=jn&&(Ln=jn);var Pn=Oa(Xl,Ln),En=new fe;En.lastchange=oman.changelist[params.onlynew],null==En.lastchange&&(En.lastchange=wl),En.zeropel=Dl,En.pelperunit=Fl*pmult,En.pw=Ns,En.pelstart=Sl,En.pelend=kl,En.author=params.author,En.authors={},En.sid=wl,En.sids={},En.tunnel=params.tunnel;var Tn=new We;Ln?Tn.restore(allq,1):Tn.restore(allq,1,params.onlynew),En.qval=Tn;var On=new Ge;On.restore(allp,1,params.onlynew&&!Ln),Ln?On.restore(allp,1):On.restore(allp,1,params.onlynew),On.cleanFromQ(),On.y2pelcoords(),params.onlycurpel&&On.cleanFromPel(),En.pval=On;for(var Bn=yprev=cprev=sprev=-1e3,In=0;In<Pn.length;In++)Pn[In].ys=Pa(Pn[In].ys),Pn[In].ye=Pa(Pn[In].ye);for(var Gn,In=0;In<Pn.length;In++){Gn=Pn[In].author,null==En.authors[Gn]?En.authors[Gn]=[In]:En.authors[Gn].push(In);var Nn=Pn[In].sid;if(null==En.sids[Nn]?En.sids[Nn]=[In]:En.sids[Nn].push(In),'L'==Pn[In].type){if(Bn==Math.round(Pn[In].xs*qprec)&&yprev==Math.round(Pn[In].ys*qprec)&&cprev==Pn[In].color&&sprev==Pn[In].size){var _n=[Math.round(Pn[In].xe*qprec),Math.round(Pn[In].ye*qprec)];Bn=Math.round(Pn[In].xe*qprec),yprev=Math.round(Pn[In].ye*qprec)}else{Bn=Math.round(Pn[In].xe*qprec),yprev=Math.round(Pn[In].ye*qprec),cprev=Pn[In].color,sprev=Pn[In].size;var _n=[0,Math.round(Pn[In].xs*qprec),Math.round(Pn[In].ys*qprec),Pn[In].zs,Bn,yprev];6!=Pn[In].size&&_n.push(Pn[In].size),'#000000'!=Pn[In].color&&_n.push(Pn[In].color)}En.objdata.push(_n)}if('W'==Pn[In].type){Bn=-1e3;var _n=[1,Pn[In].xs*qprec,Pn[In].ys*qprec];0.5!=Pn[In].size&&_n.push(Pn[In].size),En.objdata.push(_n)}if('T'==Pn[In].type){Bn=-1e3;var Wn=Pn[In].text;1==Pn[In].fall&&(Wn='_pho_'+Wn),2==Pn[In].fall&&(Wn='_lab_'+Wn);var _n=[2,Pn[In].xs*qprec,Pn[In].ys*qprec,Pn[In].zs,Wn];En.objdata.push(_n)}if('F'==Pn[In].type){if(Bn=-1e3,''!=Pn[In].color)var _n=[3,Pn[In].xs*qprec,Pn[In].ys*qprec,Pn[In].angle,Pn[In].fall,Pn[In].size,Pn[In].color];else var _n=[3,Pn[In].xs*qprec,Pn[In].ys*qprec,Pn[In].angle,Pn[In].fall,Pn[In].size];En.objdata.push(_n)}if('B'==Pn[In].type){Bn=-1e3;var _n=[4,Pn[In].xs*qprec,Pn[In].ys*qprec,Pn[In].zs,Pn[In].xe*qprec,Pn[In].ye*qprec,Pn[In].ze,Pn[In].text];En.objdata.push(_n)}}var Un=Object.keys(En.authors).length;if(1==Un){var Hn=Ca(0,En.authors);null!=Hn&&(En.author=Ca(0,En.authors)),null==En.authors}var Xn=Object.keys(En.sids).length;if(1==Xn){var Hn=Ca(0,En.sids);null!=Hn&&(En.sid=Ca(0,En.sids)),null==En.sids}for(var Yn in En.chlist={},En.sids){var Gn=oman.changelist[Yn];console.log('Element of changelist',Yn,Gn),null!=Gn&&(En.chlist[Yn]=Gn)}return console.log('Saved change list',En.chlist),0==En.qval.qar.length&&console.log('No Q to save'),0==En.pval.par.length&&console.log('No Props to save'),0==En.objdata.length&&console.log('No registrations to save'),0==En.objdata.length&&0==En.pval.par.length&&0==En.qval.qar.length&&(En=0),En}function Ia(jn,Ln){if(Ri=1,renderblock=1,Ln>=jn.files.length)return Xs.value=null,allq.update(),Qa(),renderblock=0,ae(),void(Ri=0);var Pn=new FileReader;Pn.onload=function(En){return 1==jn.files.length&&params.overridepel?(console.log('open one blank file'),openblankimage(En.target.result),Ri=0,void(renderblock=0)):void(Ra(En.target.result),console.log('Done reading ',Ln),Ia(Xs,Ln+1))},Pn.readAsText(jn.files[Ln])}function Na(){Ds.visible=!1,Wl=yp=zp=-1e3,Bs=-1,Vs.visible=!1}function _a(jn,Ln){var En=180*(Math.atan2(jn-Xl[Xl.length-1].xs,Ln-Xl[Xl.length-1].ys)/Math.PI);En=Math.round(En),0>En&&(En=360+En),as.rotation=Math.round(1e3*(-Math.PI/180*En))/1e3,params.angle=En,Xl[Xl.length-1].angle=En,Ji.updateDisplay(),oman.updchangelist(Xl[Xl.length-1].sid)}function Wa(jn,Ln,Pn,En,Tn,On){var Bn=new THREE.CircleGeometry(En,32,Math.PI/4,2.12*Math.PI),In=new THREE.Line(Bn,new THREE.LineBasicMaterial({color:On,linewidth:Tn}));return In.position.set(jn,Ln,Pn),In}function Ua(jn,Ln,Pn){var Tn=0;null!=Ln&&(Tn=St(Ln,1));var On='object'==typeof Pn?Pn.val:1,Bn=new THREE.TextSprite({textSize:0.25*Hs*On,redrawInterval:1e7,texture:{text:jn+'',fontFamily:'Arial, Helvetica, sans-serif, Bold',fontWeight:'bold',autoRedraw:!1},material:{color:Tn,fog:!1}});return 15!=On&&Rl.push(Bn),Bn.position.set(0,0,1),fcp&&(setTimeout(function(){ae()},100),fcp=0),Bn}function Xa(){Te(),Ve(),Pe()}function Ya(jn){var Ln=picparams.ps,Pn=picparams.pe;if(0<pmult){if(jn>=Ln&&jn<=Pn)return!0;}else if(jn>=Pn&&jn<=Ln)return!0;return!1}function Ka(jn,Ln,Pn){var En=Ln,Tn=Pn;if(Pn>Ln){if(jn>=En&&jn<=Tn)return!0;}else if(jn>=Tn&&jn<=En)return!0;return!1}(function(){try{var jn=new FormData,Ln=window.XMLHttpRequest?new XMLHttpRequest:new activeXObject('Microsoft.XMLHTTP');Ln.open('get',baseaddr+'getip.php',!0),Ln.send('')}catch(Pn){console.log(Pn)}})();var $a=window.getComputedStyle(document.body,null).getPropertyValue('--myyellow'),el=window.getComputedStyle(document.body,null).getPropertyValue('--myblack'),sl=window.getComputedStyle(document.body,null).getPropertyValue('--mybackground'),il,rl;this.getrs=function(){return il},this.callresultstring=function(jn){le(jn)},this.getrp=function(){return rl},this.callresultpic=function(jn){oe(jn)},this.loadlines=function(jn){Ra(jn),allq.update(),Qa(),ae()},this.setauthor=function(jn){params.author=jn,Ji.updateDisplay()},this.showvederlag=function(){console.log('vederlag to be done')},this.makenovaxml=function(jn,Ln){console.log('novaxmlto to be done'),Ln},this.getnxml=function(){return'to be xml text'},this.show3d=function(){it()},this.show2d=function(){rt()};var ul=S.picsizex,hl=S.picsizey,gl=S.picadress,yl=gl,fl=S.tung,vl=S.ling,wl=getsessionid();newdb=new mydb,newdb.ldb(),picdb=new mypicdb,6>picdb.files.length&&(picdb.files=picfiles,picdb.sdb()),tungeom.Tunnel1=tungeom1.Tunnel1;var Sl=S.pelstart,kl=S.pelend,zl=Math.abs(parseInt(Sl)-parseInt(kl)),Fl=50;11>zl&&(Fl=100),6>zl&&(Fl=200),hl=Fl*zl;var Dl=S.zeropel,Vl=S.picpack,Ql=!1,Ml=ul,Cl=hl,Rl=[];container=condiv();var Jl,Al=new THREE.Raycaster,jl=new THREE.Vector2,Pl=0,El=0,Tl=0,Il=[],Wl=yp=zp=-1e3,Ul=yp2d=zp2d=-1e3,Hl=[],Xl=[],Yl='Line';oman=new C;var Kl=function(){return{s:'bevgsave1',l:'bevgsave1'}}(),Zl=new function(){this.idx=[],this.type=[],this.remprev=[],this.xl=[],this.yl=[],this.add=function(jn,Ln,Pn){this.idx.push(jn),this.type.push(Ln),this.remprev.push(Pn),this.xl.push(0),this.yl.push(0)},this.addMove=function(jn,Ln,Pn,En,Tn){this.idx.push(jn),this.type.push(Ln),this.remprev.push(Pn),this.xl.push(En),this.yl.push(Tn)},this.removelast=function(){this.type.splice(this.type.length-1,1),this.idx.splice(this.idx.length-1,1),this.remprev.splice(this.remprev.length-1,1),this.xl.splice(this.xl.length-1,1),this.yl.splice(this.xl.length-1,1)}},$l,es,as,ds,us,ms=0,fs=lastmovey=-1e3,bs=0;Detector.canvas||alert('Browser does not support canvas 3d'),Jl=new THREE.Scene;var Ss=new THREE.Scene,ks=new THREE.Scene,Fs=Jl,Ds=new THREE.Object3D,Vs=new THREE.Object3D,Qs=new THREE.Object3D,Ms=new THREE.Object3D,Cs=new THREE.Object3D,Rs=new THREE.Object3D,Js=new THREE.Object3D,As=new THREE.Object3D,js=new THREE.Object3D,Ls=new THREE.Object3D,Ps;fallar=new THREE.Object3D,line3dgroup=new THREE.Object3D,line3dtemp=new THREE.Object3D,Jl.add(Js),Jl.add(As),Jl.add(js);var Es=new THREE.Object3D,Ts=new THREE.Object3D,Os=new THREE.Object3D,Bs=-1;Ds.visible=!1,Vs.visible=!1,pmult=Sl<kl?1:-1;var Gs=200,Ns=ul/200,_s=hl/Gs,Ws=0,Us=1,Hs=1,Xs=document.createElement('input');document.body.appendChild(Xs),Xs.type='file',Xs.accept='.txt',Xs.multiple=!0,Xs.style.display='none',Xs.onchange=function(){if(console.log('Start file read'),null==this.files[0])return void console.log('No files chosen');var jn=this.files[0].name,Ln=pelfromfname(jn);params.overridepel&&saveifokdist(Ln[0],Ln[1]),('t'==jn[jn.length-1]||'T'==jn[jn.length-1])&&Ia(this,0)};var Ys=document.createElement('input');document.body.appendChild(Ys),Ys.type='file',Ys.style.display='none',Ys.onchange=function(){if(null==this.files[0])return void console.log('No photo chosen');var jn=this.files[0].name;('g'==jn[jn.length-1]||'G'==jn[jn.length-1])&&Y(this)};var Ks=new Image,Zs=document.getElementById('linbtn'),$s=document.getElementById('watbtn'),ei=document.getElementById('txtbtn'),ti=document.getElementById('falbtn'),li=document.getElementById('selbtn'),si=document.getElementById('undbtn');renderer=new THREE.WebGLRenderer({antialias:!1,alpha:!0,premultipliedAlpha:!0}),renderer.setPixelRatio(window.devicePixelRatio),renderer.setClearColor(St(sl,1));var ii,oi;z();var ri=new THREE.Vector2(ii,oi);renderer.setSize(ii,oi),document.getElementById(h).appendChild(renderer.domElement);var di=document.getElementById(h).offsetTop,pi=document.getElementById(h).offsetLeft,ci=ii/oi,ui=2.5*_s*Math.sqrt(2.28/(_s/Ns)),hi=ui;Jl.add(Qs),Jl.add(Es),Jl.add(Os),Jl.add(Ts),Jl.add(Cs),Jl.add(Rs),Jl.add(Ms),camera=new THREE.OrthographicCamera(-ui*ci/2,ui*ci/2,hi/2,-hi/2,-5e3,5e3),controls=new THREE.OrbitControls(camera,renderer.domElement),controls.enableDamping=!1,controls.dampingFactor=0.3,controls.enableRotate=!1,controls.rotateSpeed=0.45,controls.zoomSpeed=1,android||iOS||(controls.zoomSpeed=3);var gi=1;controls.target.set(0,0,0),camera.position.set(0,0,gi);camera.zoom;controls.addEventListener('change',function(){Xt(1)}),controls.addEventListener('end',function(){Xt(1)}),cameraFix=new THREE.OrthographicCamera(-ui*ci/2,ui*ci/2,hi/2,-hi/2,-5e3,5e3);var fi,bi;ca(gl,0),function(){var jn=0.07*Hs,Ln=0.14*Hs,Pn=_(-jn,-jn,10,jn,jn,10,8*Hs,'#000000'),En=_(jn,-jn,10,-jn,jn,10,8*Hs,'#000000');Ds.add(Pn,En),Jl.add(Ds);var Tn=_(-Ln,-Ln,10,Ln,-Ln,10,5*Hs,'#000000'),On=_(Ln,-Ln,10,Ln,Ln,10,5*Hs,'#0000ff'),Bn=_(Ln,Ln,10,-Ln,Ln,10,5*Hs,'#ff0000'),In=_(-Ln,Ln,10,-Ln,-Ln,10,5*Hs,'#00ff00');Vs.add(Tn,On,Bn,In),Jl.add(Vs)}();var vi=['none','Hornfels','Svartskifer','Sill','Spr\xF8ytebetong','Special','Weakness','Basalt','Calcite','Granite','Pyrite'],xi=['#ffffff','#D0D470','#817A85','#EDA155','#877D7B','#ED4AE8','#771111','#000000','#aaffaa','#aa7777','#ff2222'],Fi,Vi,Qi,Mi,Ci={rqd:'',Jn:'',Jr:'',Ja:'',Jw:'',SRF:'',Q:''},Ri=0;(android||iOS)&&setInterval(function(){gt()},3e4),params={ex:!1,restses:1,loadprev:function(){myask(container,qa.unsaved,function(){M(),yt()})},savexml:function(){Sa(params.tunnel)},forcesync:!1,enrot:!1,linetype:'Line',linemagnet:!0,lineStyle:qa.lineStylear[0],tunnel:picparams.ps>tunborder?'Bamble':'Kjorholt',vederlag:!1,text:'',author:'V',onlynew:!1,onlycurpel:!1,rutenett:!1,size:0.5,wsize:0.5,opacity:0.5,angle:0,fall:45,layer:0,move:!1,movestart:!1,color:'#000000',parcolor:'#000000',savealpha:function(){tt(),Xt(null,1),ae();var jn=renderer.domElement.toDataURL(),Ln=new Date,Pn='';Pn=Pn+'geo'+Ln.getHours()+'h'+Ln.getMinutes()+'m'+Ln.getSeconds()+'s.png',zn(jn,Pn),ut(),lsc=1,Qa()},what2plot:'Geo+Q+Pel',withbg:!0,showbergart:!0,tstval:45,bolt:function(){li.value='Select',Da('Bolt')},boltlen:5,bolttype:'Steel',wtxt:'',dsc:'Not given',wleak:0,wdrip:0,save:function(){var jn='Save all registrations as \n'+params.tunnel+' tunnel?';myask(container,jn,function(){params.onlynew=!1,disassemble(),Ji.updateDisplay()})},textsave:'',clear:function(){myask(container,qa.unsaved,function(){M()})},load:function(){Ra(params.textsave),ae()},go3d:it,go2d:rt,getflist:function(){xa()},add5m:function(){fgui.close(),Ji.close(),dt()},resetcam:function(){Ji.updateDisplay(),controls.reset(),controls.target.set(0,0,0),camera.position.set(0,0,gi),Na(),ae()},openfile:function(){params.overridepel?myask(container,qa.unsaved,function(){Xs.click()}):Xs.click()},overridepel:!0,openfoto:function(){Ys.click()},makelab:function(){Z(Bs,qa.labtest,2),Ji.updateDisplay()},dummy:function(){},apply:function(){Te()},applyP:function(){Be()},qedit:function(){},editRQD:function(){rqdmenu(Ni,container,Xa)},editJn:function(){jnmenu(Ni,container,Xa)},editJr:function(){jrmenu(Ni,container,Xa)},editJa:function(){jamenu(Ni,container,Xa)},editJw:function(){jwmenu(Ni,container,Xa)},editSRF:function(){srfmenu(Ni,container,Xa)},removeq:function(){myask(container,qa.removeqmes,function(){Oe()})}},params.author=function(){return localStorage.getItem('lastauthor')?localStorage.getItem('lastauthor'):'none'}(),params.tunnel=gettunnel()?gettunnel():tunlist[0];var Ji=new dat.GUI({autoPlace:!1});Ji.domElement.id='guipos',Ji.close(),container.appendChild(Ji.domElement),Da('Line'),lasst=params.tunnel,myaddfunc.flip=function(){renderblock=1;var jn=gt();M();var Ln=picparams.ps;picparams.ps=picparams.pe,picparams.pe=Ln,fgui.updateDisplay(),saveifokdist(picparams.ps,picparams.pe),''==gl?ra(picparams.ps,picparams.pe):oa(picparams.ps,picparams.pe),jn&&yt(),renderblock=0,ae(),Da('Line'),li.value='Select',fgui.close(),Ji.close()},myaddfunc.openblank=function(){console.log('Oblank'),fgui.close(),myask(container,qa.unsaved,function(){getbypl(picparams.ps,picparams.pe)})};var Ai={showdb:function(){var jn=function(){for(var Pn=0,En=0;En<newdb.files.length;En++)newdb.files[En].ischosen&&!newdb.files[En].toskip&&Pn++;if(Pn){if(params.overridepel){var Tn=getchosenpels(newdb),On=Tn[0],Bn=Tn[1];picparams.ps=On,picparams.pe=Bn,fgui.updateDisplay(),saveifokdist(picparams.ps,picparams.pe),ra(picparams.ps,picparams.pe)}var In=0;renderblock=1;for(var Gn,En=0;En<newdb.files.length;En++)Gn=newdb.files[En],Gn.ischosen&&!newdb.files[En].toskip&&(In++,Ra(Gn.savedata));Qa(),allq.update(),renderblock=0,ae(),newdb.uncheckall(),Da('Line')}};dbtable(container,function(){params.ex?myask3(container,qa.openneworex,qa.opennew,function(){params.overridepel=!0,jn(),Ji.updateDisplay()},qa.opentoexisting,function(){params.overridepel=!1,jn()}):(jn(),Ji.updateDisplay())})},showpicdb:function(){dbpictable(container,ji)},newblank:function(){oa(picparams.ps,picparams.pe)}};picparams.openf=function(){myask(container,qa.unsaved,function(){picdb.makefromfiles(function(){for(var jn in picdb.sortbytime(),picdb.files)if(!picdb.files[jn].toskip){picdb.files[jn].ischosen=1;break}ji(1)})})};var ji=function(jn){var Ln=getchosenpels(picdb);if(null!=Ln){var Pn=Ln[0],En=Ln[1],Tn=Ln[2];picparams.ps=Pn,picparams.pe=En,fgui.updateDisplay(),saveifokdist(picparams.ps,picparams.pe),console.log('Chosen are',picparams.ps,picparams.pe),jn?getbypl(picparams.ps,picparams.pe):ra(picparams.ps,picparams.pe,Tn),Et(),picdb.uncheckall()}},Li=Qe(fgui),Pi=ba('Start!',function(){myaddfunc.openblank()});Pi.setAttribute('class','inguib but1gui aguibut'),Li.appendChild(Pi);var Li=Qe(fgui),Pi=ba('Flip pic',function(){myaddfunc.flip()});Pi.setAttribute('class','inguib but2gui'),Li.appendChild(Pi),Pi=ba('Add 5m',function(){params.add5m()}),Pi.setAttribute('class','inguib but2gui'),Li.appendChild(Pi);var Li=Qe(fgui),Pi=ba('MWDdb',function(){Ai.showpicdb()});Pi.setAttribute('class','inguib but2gui aguibut'),Li.appendChild(Pi),Pi=ba('Open geom',function(){picparams.openf()}),Pi.setAttribute('class','inguib but2gui aguibut'),Li.appendChild(Pi);var Li=Qe(fgui),Pi=ba('Go 2d',function(){params.go2d()});Pi.setAttribute('class','inguib but2gui'),Li.appendChild(Pi),Pi=ba('Go 3d',function(){params.go3d()}),Pi.setAttribute('class','inguib but2gui'),Li.appendChild(Pi),fgui.add(params,'tunnel',tunlist).name('Tunnel:').onChange(function(){savetunnel(params.tunnel),Et()}),fgui.add(params,'vederlag').name(qa.showved).onChange(function(){Qa(),ae()}),fgui.add(params,'rutenett').name(qa.rutenett).onChange(function(){vt(Sl,kl),ae()}),E(Sl,kl),vt(Sl,kl);var Ei=new THREE.TextureLoader;Ei.crossOrigin='anonymous';var Ti=Ei.load(spcline),Oi=Ei.load(spcline1,function(){Oi.wrapS=Oi.wrapT=THREE.RepeatWrapping,Oi.offset.set(0,0),Oi.repeat.set(1,1)}),Bi=Ei.load(spcline2,function(){Bi.wrapS=Bi.wrapT=THREE.RepeatWrapping,Bi.offset.set(0,0),Bi.repeat.set(1,1)}),Gi=new ja,Ni=new Ue,_i=new Ie;Ni.getQ(),allq=new We,allp=new Ge;var Wi=chosenp=-2;ua(Sl,kl,-1);var Ui=0,Hi=new Hammer(Zs);Zs.onclick=function(){if(Ui)return void(Ui=0);var Ln=0,Pn=Ji.closed;'Line'==params.linetype&&(Ln=1),Da('Line'),D(this),Ln&&P(),Pn&&Ji.close(),Ji.removeFolder(qa.qval),Ji.removeFolder(qa.setproperties),li.value='Select'},(iOS||android)&&Hi.on('press',function(){Zs.click(),Ui=1,setTimeout(function(){Ui=0},250)}),Hi.get('press').set({threshold:100,time:3});var Xi=new Hammer($s);$s.onclick=function(){return Ui?void(Ui=0):void(Da('Water'),li.value='Select',D(this))},(iOS||android)&&Xi.on('press',function(){$s.click(),Ui=1,setTimeout(function(){Ui=0},250)}),Xi.get('press').set({threshold:100,time:3});var Yi=new Hammer(ei);ei.onclick=function(){Da('Text'),li.value='Select',D(this)},(iOS||android)&&Yi.on('press',function(){ei.click(),Ui=1,setTimeout(function(){Ui=0},250)}),Yi.get('press').set({threshold:100,time:3});var Ki=new Hammer(ti);ti.onclick=function(){return Ql?void Ut():void(Da('Fall'),li.value='Select',D(this))},(iOS||android)&&Ki.on('press',function(){ti.click(),Ui=1,setTimeout(function(){Ui=0},250)}),Ki.get('press').set({threshold:100,time:3});var Zi=new Hammer(si);si.onclick=function(){android&&me(),li.value='Select',zt()},Zi.on('press',function(){android||(me(),li.value='Select',Ui=1,setTimeout(function(){Ui=0},250))}),Zi.get('press').set({threshold:100,time:3});var $i=0,en=new Hammer(li);android&&(li.onclick=function(){$i||tn(1)}),en.on('press',function(){tn(0),$i=1,setTimeout(function(){$i=0},250)}),en.get('press').set({threshold:100,time:3});var tn=function(){return'Select'==li.value?(li.value='Group',void Da('Select')):'One'==li.value?void(li.value='Group'):'Group'==li.value?void(li.value='One'):void 0};Ee();Jl.children.length;document.addEventListener('keydown',function(jn){switch(jn.keyCode){case 65:break;case 66:break;case 67:break;case 68:}},!1),window.addEventListener('resize',ut,!1),window.addEventListener('orientationchange',ut,!1);var nn=null,rn=new Hammer(renderer.domElement),dn=lasty=-1e3,cn=firsty=firstz=-1e3,un=endy=-1e3;rn.on('press',function(jn){bs=new Date().getTime(),R(jn),Qa()}),rn.on('pan',function(jn){if('Line'==params.linetype){var Ln=(dn-jn.center.x+pi)*(dn-jn.center.x+pi)+(lasty-jn.center.y+di)*(lasty-jn.center.y+di);Ln>sensivity*sensivity&&R(jn)}if('Select'==params.linetype){if(Pl)return;var Ln=(dn-jn.center.x+pi)*(dn-jn.center.x+pi)+(lasty-jn.center.y+di)*(lasty-jn.center.y+di),Pn=jn.velocityX*jn.velocityX+jn.velocityY*jn.velocityY;20<Pn&&(de(),Pl=1),params.move&&5>Pn&&(1e4<Ln||params.movestart)&&(R(jn),params.movestart=!0)}'Bolt'==params.linetype&&R(jn),'Fall'==params.linetype&&R(jn)}),rn.on('panstart',function(){El=1,Tl=1,Pl=0,params.move=!0,params.movestart=!1,!Ql||controls.enableRotate}),rn.on('panend',function(){'Line'==params.linetype&&(Na(),bs=new Date().getTime()),params.move=!1,Qa(),ae(),Pl=0,El=0,Tl=0,Ql}),rn.on('pinchstart',function(){clearTimeout(nn),nn=null,Na()}),V();ae();var Ei=new THREE.TextureLoader;Ei.crossOrigin='anonymous';var gn=Ei.load(Vl.imdrop),mn=new THREE.SpriteMaterial({map:gn,color:16777215}),yn=Ei.load(Vl.fallMap),fn=Ei.load(Vl.fallMapA180),bn=Ei.load(Vl.fallMapF0),xn=Ei.load(imflask),wn=Ei.load(imphoto),Sn=new THREE.SpriteMaterial({map:xn}),kn=new THREE.SpriteMaterial({map:wn}),zn=function(jn,Ln){var Pn=document.createElement('a');'string'==typeof Pn.download?(document.body.appendChild(Pn),Pn.download=Ln,Pn.href=jn,Pn.click(),document.body.removeChild(Pn)):location.replace(uri)};var Fn=function(jn,Ln){var Pn=new THREE.Vector3().subVectors(Ln,jn),En=new THREE.Matrix4;En.lookAt(jn,Ln,new THREE.Object3D().up);var Tn=new THREE.Matrix4;Tn.set(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),En.multiply(Tn);var On=new THREE.CylinderGeometry(0.1,0.1,Pn.multiplyScalar(0.3).length(),48,1),Bn=new THREE.Mesh(On,new THREE.MeshBasicMaterial({color:0}));Bn.applyMatrix(En);var In=new THREE.Vector3().addVectors(jn,Pn.multiplyScalar(0.5));return Bn.position.set(In.x,In.y,In.z),Bn},qn=function(jn,Ln){var Pn,En,Tn,On,Bn,In,Gn,Nn,_n,Wn,Un,Hn,Xn,Yn;for(Xn=[],Gn=jn.geometry.faceVertexUvs[0],Nn=jn.geometry.faces,_n=jn.geometry.vertices,Wn=new THREE.Matrix4,Un=new THREE.Matrix4,Yn=new THREE.Matrix4,Ss.updateMatrixWorld(!0),On=0;On<Gn.length;On++)if(Bn=Gn[On],In=Nn[On],et(Bn,Ln)){Pn=_n[In.a].clone().applyMatrix4(jn.matrixWorld),En=_n[In.b].clone().applyMatrix4(jn.matrixWorld),Tn=_n[In.c].clone().applyMatrix4(jn.matrixWorld),Wn.set(Pn.x,Pn.y,Pn.z,0,En.x,En.y,En.z,0,Tn.x,Tn.y,Tn.z,0,0,0,0,1),Un.set(Bn[0].x,Bn[0].y,0,1,Bn[1].x,Bn[1].y,0,1,Bn[2].x,Bn[2].y,0,1,0,0,1,0),Un.getInverse(Un),Wn.multiplyMatrices(Un,Wn),Wn.elements=Ke(Wn),Wn.transpose(),Hn=new THREE.Vector3(Ln.x,Ln.y,1);var Kn=Hn.applyMatrix4(Wn);Xn.push(Kn),Xn.push(In.normal)}return Xn};check3dbox.onchange=function(){controls.enableRotate=check3dbox.checked,Ji.updateDisplay()},syncfun=function(Ln,Pn){var En=function(){putdbf(Ln),wl=getsessionid()},Tn=function(){mt.end('Merging'),newdb.syncall(),En()},On=function(In){mt.start('Merging'),syncbtn.textContent='Merge start',newdb.wipeold(function(){newdb.mergewithstring(In,Tn)})};getver(function(In){var Gn=In[0];console.log('localver=',newdb.getsid(),'onlinever',Gn);var Nn=!0;for(var _n in newdb.files)Nn=Nn&&newdb.files[_n].issynced;syncbtn.textContent='Got versions',newdb.getsid()!=Gn||!Nn||params.forcesync?(syncbtn.textContent=newdb.getsid()+' '+Gn,getdbf(On)):(console.log('Version is up to date'),syncbtn.textContent='Version is up to date',null!=Pn&&Pn())})};getbypl=function(Ln,Pn){var En=normPel(Ln,Pn),Tn=En[0],On=En[1],Bn=Tn,In=On,Gn=newdb.sorted;newdb.sortbypelasc();var Nn=[],_n=JSON.parse(JSON.stringify(newdb.files));for(var Wn in _n){var Un=_n[Wn];if(!Un.toskip){var Hn=normPel(Un.ps,Un.pe);numintersect(Tn,On,Hn[0],Hn[1])&&(Bn=Math.min(Bn,Tn,On,Hn[0],Hn[1]),In=Math.max(In,Tn,On,Hn[0],Hn[1]),Nn.push(Un.savedata))}}for(var Wn in newdb.sortbytime(),ra(Bn,In),renderblock=1,Nn)Ra(Nn[Wn]);Qa(),allq.update(),renderblock=0,ae()};var Vn,Mn;Et();var Cn=[],Rn=1,Jn,An;cutpels=function(){params.onlycurpel=!0;var jn=Ba();M(),Ra(jn),Qa(),allq.update(),ae(),params.onlycurpel=!1},disassemble=function(){var jn=Ba();console.log('Sids are',jn.sids);var Ln=[];for(var Pn in jn.sids)Ln.push(Pn);for(var En in Ln)params.onlynew=parseInt(Ln[En]),En==Ln.length-1?le(1):le(1,1);params.onlynew=0,se()},dat.GUI.prototype.removeFolder=function(jn){var Ln=this.__folders[jn];Ln&&(Ln.close(),this.__ul.removeChild(Ln.domElement.parentNode),delete this.__folders[jn],this.onResize())},S.callback(),picdb.ldb(function(){ra(picparams.ps,picparams.pe,params.tunnel)})}