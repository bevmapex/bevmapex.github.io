function bevgeoplot(h,S){function F(){fi=document.getElementById(h).offsetWidth,bi=document.getElementById(h).offsetHeight}function D(Kn){console.log('Resetting render'),null!=renderer&&document.getElementById(h).removeChild(renderer.domElement),renderer=new THREE.WebGLRenderer({antialias:!1,alpha:!0,premultipliedAlpha:!0});var Zn=android?0.8:1;renderer.setPixelRatio(window.devicePixelRatio/Zn),renderer.setClearColor(Mt(vl,1)),renderer.setSize(fi,bi),document.getElementById(h).appendChild(renderer.domElement),cameraFix=new THREE.OrthographicCamera(-Si*xi/2,Si*xi/2,ki/2,-ki/2,-5e3,5e3),camera=new THREE.OrthographicCamera(-Si*xi/2,Si*xi/2,ki/2,-ki/2,-5e3,5e3),camera.position.set(0,0,ti),zi=camera.zoom,controls=new THREE.OrbitControls(camera,renderer.domElement),controls.enableDamping=!1,controls.dampingFactor=0.3,controls.enableRotate=!1,controls.rotateSpeed=0.45,controls.zoomSpeed=1,android||iOS||(controls.zoomSpeed=3),controls.target.set(0,0,0),controls.addEventListener('change',function(){ia(1)});var $n=new Hammer(renderer.domElement);Q($n),null!=Kn&&Kn()}function M(Kn){var Zn=Kn.add(bf,'blank').name('').__li;Zn.setAttribute('class','cr function mydum')}function V(){}function Q(Kn){Kn.on('press',function(Zn){Rs=new Date().getTime(),A(Zn),'Line'==params.linetype&&X()}),Kn.on('pan',function(Zn){if('Line'==params.linetype){var $n=(xn-Zn.center.x+Mi)*(xn-Zn.center.x+Mi)+(lasty-Zn.center.y+Di)*(lasty-Zn.center.y+Di);$n>sensivity*sensivity&&A(Zn)}if('Select'==params.linetype){if(Ul)return;var $n=(xn-Zn.center.x+Mi)*(xn-Zn.center.x+Mi)+(lasty-Zn.center.y+Di)*(lasty-Zn.center.y+Di),eo=Zn.velocityX*Zn.velocityX+Zn.velocityY*Zn.velocityY;20<eo&&(be(),Ul=1),params.move&&5>eo&&(1e4<$n||params.movestart)&&(A(Zn),params.movestart=!0)}'Bolt'==params.linetype&&A(Zn),'Fall'==params.linetype&&A(Zn)}),Kn.on('panstart',function(){Hl=1,Xl=1,Ul=0,params.move=!0,params.movestart=!1,!Ol||controls.enableRotate}),Kn.on('panend',function(){'Line'==params.linetype&&($a(),Rs=new Date().getTime()),params.move=!1,'Line'==params.linetype&&X(),de(),Ul=0,Hl=0,Xl=0,Ol}),Kn.on('pinchstart',function(){clearTimeout(bn),bn=null,$a()}),C(Kn)}function C(Kn){Kn.get('tap').set({threshold:1,posThreshold:1,time:1,interval:2}),Kn.get('press').set({threshold:50,time:3}),Kn.get('pan').set({threshold:sensivity,time:4,direction:Hammer.DIRECTION_ALL}),Kn.get('pinch').set({enable:!0})}function R(Kn,Zn){var $n=null==Zn?Gl:Zn;if(null==Kn)return console.log('Null object!'),null;for(var eo,to=0;to<$n.children.length;to++)if($n.children[to].uuid==Kn){eo=$n.children[to];break}return eo}function L(Kn,Zn){var $n=document.getElementsByClassName('close-button close-bottom'),eo=null==Zn?0:1;$n[eo].innerHTML=Kn}function J(){D(),line3dtemp.children.length=0,line3dgroup.children.length=0,fallar.children.length=0,As.visible=!1,ls=yp=zp=-1e3,Sn=-1e3,renderblock=1;for(var Kn=0;Kn<oman.ao.length;Kn++)oman.removefromscene(oman.get(Kn));ns=[],oman=new P,Fa(),allp=new Xe,allq=new Ze,X(),allq.update(),renderblock=0,de()}function P(){this.ao=ns,this.history=[],this.sid=Cl,this.so=null,this.sp=null,this.selidx=null,this.changelist={},this.updchangelist=function(Kn){this.changelist[Kn]=Cl},this.select=function(Kn,Zn){this.so=null,this.sp=null,this.selidx=null;var $n=De(Kn,Zn);if($n[3]>Math.sqrt(li*li+ei*ei)/7)return console.log('Nothing selected'),[null,null];var eo=$n[0];return this.selidx=eo,this.so=this.get(eo),this.so||console.log('No object selected'),this.sp=allp.par[Oe(eo)],this.sp||console.log('No property selected'),Es.visible=!!this.so,[this.so,this.sp]},this.get=function(Kn){var Zn=this.ao[Kn];return null==Zn?(console.log('No object ',Kn),null):Zn},this.add=function(Kn){this.ao.push(Kn)},this.undo=function(){var Kn=this.history.pop();return Kn?void('add'==Kn[0]&&(this.removefromscene(Kn[1]),this.history.pop()),'remove'==Kn[0]&&(this.plot(Kn[1]),this.history.pop()),'removeSequence'==Kn[0]&&(this.plot(Kn[1]),this.history.pop(),'removeSequence'==this.history[this.history.length-1][0]&&this.undo()),'movefrom'==Kn[0]&&this.move(Kn[1],Kn[2],Kn[3]),X(),de()):void console.log('No history elements')},this.move=function(Kn,Zn,$n){if(null==Kn)return void console.log('Trying to move null object');var eo=R(Kn.id,'B'==Kn.type?Bs:null);if(eo){var to=Zn-Kn.xs,ao=$n-Kn.ys;eo.position.x+=to,eo.position.y+=ao,params.movestart||this.history.push(['movefrom',Kn,Kn.xs,Kn.ys]),Kn.xs=Zn,Kn.ys=$n,Es.visible=!0,Es.position.set(Zn,$n,10),this.updchangelist(Kn.sid)}},this.erasefromhistory=function(Kn){for(var Zn=0;Zn<this.history.length;Zn)this.history[Zn][1].sameas(Kn)?this.history.splice(Zn,1):Zn++},this.removefromscene=function(Kn,Zn){if(1==Kn.skip)return!1;if('L'==Kn.type)return Kn.skip=1,Zn?this.history.push(['removeSequence',Kn]):this.history.push(['remove',Kn]),renderblock||this.updchangelist(Kn.sid),!0;var $n=R(Kn.id,'B'==Kn.type?Bs:null);return null==$n?(console.log('No such object on scene',Kn),!1):('B'==Kn.type?Bs.remove($n):Gl.remove($n),this.history.push(['remove',Kn]),de(),Kn.skip=1,renderblock||this.updchangelist(Kn.sid),!0)},this.isdublicate=function(Kn){for(var $n,Zn=0;Zn<this.ao.length;Zn++)$n=this.get(Zn),$n.sameas(Kn)&&(this.removefromscene($n),this.erasefromhistory(Kn))},this.plot=function(Kn){if('L'==Kn.type)return Kn.skip=0,void this.history.push(['add',Kn]);var Zn;'W'==Kn.type&&(Zn=ee(Kn.xs,Kn.ys,Kn.zs,Kn.size)),'F'==Kn.type&&(Zn=re(Kn.xs,Kn.ys,Kn.zs,Kn.angle,Kn.fall,Kn.size),''!=Kn.color&&Ht(Kn.color)),'T'==Kn.type&&(Zn=ae(Kn.text,Kn.xs,Kn.ys,Kn.zs,1- -Kn.fall)),'B'==Kn.type&&(Zn=_(Kn.xs,Kn.ys,Kn.zs,Kn.xe,Kn.ye,Kn.ze),Ms=[Zn,Kn],Bs.add(Zn));Zn&&(Zn.name=ns.length,Kn.id=Zn.uuid,Kn.skip=0,this.history.push(['add',Kn]),'B'!=Kn.type&&Gl.add(Zn),de())}}function A(Kn){!0==controls.enableRotate||((!params.move||'Line'==params.linetype)&&(xn=Kn.center.x-Mi,lasty=Kn.center.y-Di),_l.x=2*((Kn.center.x-Mi)/fi)-1,_l.y=2*-((Kn.center.y-Di)/bi)+1,Ol?E():O())}function E(){fcp=1,Nl.setFromCamera(_l,camera);var Kn=Nl.intersectObjects(meshes.children);if(0<Kn.length){var Zn=new Na;Zn.sid=Cl;var $n=mr(ls),eo=mr(yp),to=mr(zp),ao=mr(ss),lo=mr(yp2d),no=mr(Kn[0].point.x),oo=mr(Kn[0].point.y),po=mr(Kn[0].point.z),co=mr(2*(Kn[0].uv.x-0.5)*ei),uo=mr(2*(Kn[0].uv.y-0.5)*li);if(-1e3<ls){var ho=params.lineStyle==qa.lineStylear[0]?0:params.lineStyle==qa.lineStylear[1]?1:params.lineStyle==qa.lineStylear[2]?2:3,go=ho+params.color,mo=K($n,eo,to,no,oo,po,Math.round(40*params.size),params.color);if(2==Kn.length){var yo=mr(2*(Kn[1].uv.x-0.5)*ei),fo=mr(2*(Kn[1].uv.y-0.5)*li),bo={xs:yo,ys:fo,v:new THREE.Vector3(Kn[1].point.x,Kn[1].point.y,Kn[1].point.z)};linez.push(bo)}var bo={xs:ao,ys:lo,v:new THREE.Vector3($n,eo,to)};linez.push(bo),line3dtemp.add(mo)}ls=no,yp=oo,zp=po,ss=co,yp2d=uo,zp2d=po}de()}function T(Kn){return Math.min(ei,Math.max(Kn,-ei))}function O(){fcp=1,Nl.setFromCamera(_l,camera);var Kn=Nl.intersectObjects(is);if(0<Kn.length){var Zn=new Na;Zn.sid=Cl;var $n=mr(ls),eo=mr(yp),to=mr(zp),ao=mr(Kn[0].point.x),lo=mr(Kn[0].point.y),no=mr(Kn[0].point.z);if(!Ol&&!params.move&&ao<-ei&&'Select'==params.linetype)return Be(lo),Ge(),void de();if('Line'==params.linetype){if($n=T($n),ao=T(ao),-1e3<ls){As.visible=!0,As.position.set(ao,lo,10);var oo=params.lineStyle==qa.lineStylear[0]?0:params.lineStyle==qa.lineStylear[1]?1:params.lineStyle==qa.lineStylear[2]?2:3,po=oo+params.color,co=0,uo=(ao-$n)*co,go=K($n,eo,to,ao+uo,lo+(lo-eo)*co,no+params.layer+1,Math.round(30*params.size),params.color);go.name=ns.length,Zn.addline($n,eo,to,ao,lo,no+params.layer+1,Math.round(30*params.size),po),oman.plot(Zn),oman.add(Zn),Os.add(go),Sn=ao,endy=lo}else wn=ao,firsty=lo,firstz=no;As.visible=!0,As.position.set(ao,lo,10),ls=ao,yp=lo,zp=no+params.layer+1}if('Bolt'==params.linetype&&ao>=-ei&&ao<=ei)if(!Hl)Zn.addbolt(ao,lo,no+7,ao,lo,no+7,params.bolttype),oman.plot(Zn),oman.add(Zn);else{H(ao,lo,no+7);var mo=oman.get(ns.length-1);mo.xe=fs.vertices[1].x,mo.ye=fs.vertices[1].y,mo.ze=fs.vertices[1].z}if('Fall'==params.linetype&&ao>=-ei&&ao<=ei&&(Xl?0!=params.fall&&el(ao,lo,no+7):(Zn.addfall(ao,lo,no+7,params.angle,params.fall,jl<Jl),oman.plot(Zn),oman.add(Zn))),'Water'==params.linetype&&ao>=-ei&&ao<=ei&&(Zn.addwater(ao,lo,no+7,Math.round(10*params.wsize)/10),oman.plot(Zn),oman.add(Zn)),'Text'==params.linetype&&ao>=-ei&&ao<=ei&&''!=params.text&&(Zn.addtext(params.text,ao,lo,no+params.layer+1),oman.plot(Zn),oman.add(Zn)),'Select'==params.linetype&&ao>=-ei&&ao<=ei)if(!params.move){oman.select(ao,lo);var yo=De(ao,lo);if(yo[3]>Math.sqrt(li*li+ei*ei)/7)return;Es.visible=!0,Es.position.set(yo[1],yo[2],10),Ks=yo[0],Te(Ks)}else if(oman.so){var fo=ao-0.1*ei/camera.zoom,bo=lo+0.1*li/camera.zoom;oman.move(oman.get(Ks),fo,bo)}}else'Select'==params.linetype?params.move&&be():($a(),Es.visible=!1);de()}function I(){if(-1e3<Sn){var Kn=new Na;Kn.sid=Cl;var Zn=params.lineStyle==qa.lineStylear[0]?0:params.lineStyle==qa.lineStylear[1]?1:params.lineStyle==qa.lineStylear[2]?2:3;if(0<Zn)return void(Sn=endy=wn=firsty=firstz=-1e3);var $n=Zn+params.color;Kn.addline(Sn,endy,firstz+params.layer+1,wn,firsty,firstz+params.layer+1,Math.round(30*params.size),$n),oman.plot(Kn),oman.add(Kn),Sn=endy=wn=firsty=firstz=-1e3,X(),de()}}function B(Kn,Zn,$n){var eo=new THREE.LineSegmentsGeometry;eo.setPositions(Kn);var to=new THREE.LineMaterial({color:0,linewidth:Zn,dashed:!1}),ao=renderer.getSize();to.resolution.set(ao.width,ao.height);var lo=new THREE.LineSegments2(eo,to);return null==$n&&Is.add(lo),lo}function G(Kn,Zn,$n){Gl.remove(Gs);var eo=[],ao=0.1*oi;Gs=new THREE.Object3D;var lo=-li,no=li,oo=1.13*ei,po=1.067*ei;eo.push(oo,lo,2,oo,no,2);var co={val:15},uo=ae(Kn,oo+0.11*ei,lo+ao,0,0,yl);Gs.add(uo),eo.push(oo,lo,2,po,lo,2),eo.push(oo,lo,2,po,lo,2);var ho=ae(Zn,oo+0.11*ei,no-ao,0,0,yl);Gs.add(ho),eo.push(oo,no,2,po,no,2,-oo,no,10,-po,no,10);for(var go=1;go<pmult*(Zn-Kn)/5;++go){var mo=-li+5*(pmult*go*(no-lo))/(Zn-Kn),yo=5*pmult*go+parseInt(Kn),fo=ae(yo,oo+0.11*ei,mo,0,0,yl);Gs.add(fo),eo.push(oo,mo,2,po,mo,2,-oo,mo,10,-po,mo,10)}Gs.add(B(eo,2,1));var bo=normPel(Kn,Zn);if(100<bo[1]-bo[0])for(var go=bo[0]-1;go<=bo[1];go++)if(0==go%100){fcp=1;var vo=ae(go,4*ei,_a(go),co,0,yl);Gs.add(vo),fcp=0}if(null!=$n){Gs.position.set(0,$n,0)}Gl.add(Gs)}function _(Kn,Zn,$n,eo,to,ao){var lo=new THREE.Object3D,no=0.07,oo=K(Kn+no,Zn+no,$n,Kn-no,Zn-no,$n-0.01,2,'#000000'),po=K(Kn-no,Zn+no,$n,Kn+no,Zn-no,$n-0.01,2,'#000000'),co=sl(Kn,Zn,$n,2*(no/Math.sqrt(2)),2,'#000000');return Vs=U(Kn,Zn,$n,eo,to,ao,1,'#000000'),lo.add(oo),lo.add(po),lo.add(co),lo.add(Vs),lo}function W(){return 1/2e3}function U(Kn,Zn,$n,eo,to,ao,lo,no){fs=new THREE.Geometry,bs=new THREE.Vector3(Kn,Zn,$n),fs.vertices.push(bs),fs.vertices.push(new THREE.Vector3(eo,to,ao));return Y([Kn,Zn,$n,eo,to,ao],10,no)}function H(Kn,Zn,$n){var eo=(bs.x-Kn)*(bs.x-Kn)+(bs.y-Zn)*(bs.y-Zn),to=2*(Al/$s),ao=params.boltlen*Math.sin(Math.PI/24);if(eo=Math.sqrt(eo)/to,eo<ao)Ms[0].remove(Vs),Vs=U(bs.x,bs.y,bs.z,Kn,Zn,$n,1,'#000000'),Ms[0].add(Vs),Ms[1].xe=Kn,Ms[1].ye=Zn,Ms[1].ze=$n;else{var no,oo;no=bs.x+(Kn-bs.x)/eo*ao,oo=bs.y+(Zn-bs.y)/eo*ao,Ms[0].remove(Vs),Vs=U(bs.x,bs.y,bs.z,no,oo,$n,1,'#000000'),Ms[0].add(Vs),Ms[1].xe=no,Ms[1].ye=oo,Ms[1].ze=$n}}function X(){Da(),Ft();for(var Kn=[],Zn=0;Zn<ns.length;Zn++)0==ns[Zn].skip&&Kn.push(ns[Zn]);for(var to,ao,$n=yprev=cprev=sprev=-1e3,eo=[],lo=[1],no=[],Zn=0;Zn<Kn.length;Zn++)if('L'==Kn[Zn].type){if($n==Kn[Zn].xs&&yprev==Kn[Zn].ys&&cprev==Kn[Zn].color&&sprev==Kn[Zn].size){var oo=[Kn[Zn].xe,Kn[Zn].ye,Kn[Zn].zs];$n=Kn[Zn].xe,yprev=Kn[Zn].ye,eo.push(oo[0],oo[1],oo[2])}else'0'==lo[0]||'#'==lo[0]||Y(eo,ao,to),$n=Kn[Zn].xe,yprev=Kn[Zn].ye,cprev=Kn[Zn].color,sprev=Kn[Zn].size,eo=[Kn[Zn].xs,Kn[Zn].ys,Kn[Zn].zs,$n,yprev,Kn[Zn].zs],to=Kn[Zn].color,ao=Kn[Zn].size,lo=to+'';('0'==lo[0]||'#'==lo[0])&&no.push(Kn[Zn].xs,Kn[Zn].ys,Kn[Zn].zs,Kn[Zn].xe,Kn[Zn].ye,Kn[Zn].ze)}'0'==lo[0]||'#'==lo[0]||Y(eo,ao,to),B(no,5)}function Y(Kn,Zn,$n,eo){if(0!=Kn.length){var to=$n+'',ao=0;if(7<to.length&&(ao=to[0],to=to.slice(1,8)),0<ao){var lo=Z(Kn,Zn,$n,eo);return lo}var no=Math.abs(Zn),oo=new THREE.LineGeometry;oo.setPositions(Kn);var po=new THREE.LineMaterial({color:0,linewidth:no/3,dashed:!1}),co=renderer.getSize();po.resolution.set(co.width,co.height);var lo=new THREE.LineSegments2(oo,po);return null==eo&&Is.add(lo),lo}}function K(Kn,Zn,$n,eo,to,ao,lo,no){var oo=new Float32Array(6);oo[0]=Kn,oo[1]=Zn,oo[2]=$n,oo[3]=eo,oo[4]=to,oo[5]=ao;var po=Y(oo,lo,no,1);return po}function Z(Kn,Zn,$n,eo){if(0!=Kn.length){var to=Kn.length,ao=$n+'',lo=0;7<ao.length&&(lo=ao[0],ao=ao.slice(1,8));for(var no=0,oo=3;oo<to;oo+=3)no+=Math.sqrt((Kn[oo]-Kn[oo-3])*(Kn[oo]-Kn[oo-3])+(Kn[oo+1]-Kn[oo-2])*(Kn[oo+1]-Kn[oo-2]));var po=new Float32Array(to);iOS&&(po=new Float32Array(2*to-3));for(var oo=0;oo<Kn.length;oo++)po[oo]=Kn[oo];if(iOS)for(var uo,oo=0;oo<to-3;oo+=3)uo=2*to-3-oo-3,po[uo]=Kn[oo],po[uo+1]=Kn[oo+1],po[uo+2]=Kn[oo+2];var ho=new THREE.Color(ao),go=Math.abs(Zn)*W(),mo=new MeshLineMaterial({color:ho,lineWidth:go*lsc,useMap:!1,transparent:!!(0>Zn),opacity:0>Zn?0.6:1,resolution:vi});if(1==lo)var mo=new MeshLineMaterial({color:ho,lineWidth:go*lsc,useMap:!1,useAlphaMap:1,transparent:!0,alphaMap:Xi,resolution:vi});if(2==lo){var yo=Math.round(1.5*no);yo=1>yo?1:yo;var mo=new MeshLineMaterial({color:ho,lineWidth:go*lsc,useMap:!1,useAlphaMap:1,repeat:new THREE.Vector2(yo,1),transparent:!0,alphaMap:Yi,resolution:vi})}if(3==lo){var yo=Math.round(no);ho=new THREE.Color('#aaaaaa'),yo=1>yo?1:yo;var mo=new MeshLineMaterial({color:ho,lineWidth:1.5*(go*lsc),useMap:!0,map:Ki,useAlphaMap:1,repeat:new THREE.Vector2(yo,1),transparent:!0,alphaMap:Ki,resolution:vi})}var fo=new MeshLine;fo.setGeometry(po);var bo=new THREE.Mesh(fo.geometry,mo);return null==eo&&Is.add(bo),bo}}function $(Kn,Zn){var $n=new THREE.Sprite;return $n.position.set(Kn,Zn,2),$n.scale.set(0.4,0.4,0.4),$n}function ee(Kn,Zn,$n,eo){var to=new THREE.Sprite(qn);return to.position.set(Kn,Zn,$n),to.scale.x=to.scale.y=eo*oi,to}function ae(Kn,Zn,$n,eo,to,ao){var lo=10,no=new THREE.Object3D,oo=il(Kn,ao,eo);if(oo.position.set(Zn+0.1,$n-0.05,lo/5),no.add(oo),to){oo.position.set(Zn+0.35,$n-0.2,lo/5);var po=0.07,co=K(-po,-po,10,po,po,10,lo/5,'#000000'),uo=K(po,-po,10,-po,po,10,lo/5,'#000000');co.position.set(Zn,$n,0),uo.position.set(Zn,$n,0);var ho=$(Zn+0.35,$n+0.12);ho.visible=!1,no.add(co),no.add(uo),no.add(ho),2==to&&(ho.material=Ln,ho.visible=!0,console.log('photo added')),3==to&&(ho.material=Rn,ho.visible=!0,console.log('labtest added'))}return no}function le(Kn){var Zn=new FileReader;Zn.onloadend=function($n){var eo=jl;Ee()&&(eo=Math.round(Wa(ns[Ks].ys)));var to=new Date,ao='';ao='pic_'+eo+'_'+to.getMinutes()+'m'+to.getSeconds()+'s',Pn($n.target.result,ao+'.jpg'),ie(Ks,ao,1),Gi.updateDisplay(),ie(Ks,ao)},Zn.readAsDataURL(Kn.files[0])}function ie(Kn,Zn,$n){var eo=ns[Kn];if('T'!=Ee(Kn))return void console.log('not T');var to=Gl.getObjectByName(Kn),ao=to.children[0];console.log(ao),ao.lastRedraw=0,ao.material.map.text=''+Zn,eo.text=Zn,oman.updchangelist(eo.sid),null!=$n&&(1==$n&&(eo.fall=1,to.children[3].material=Ln),2==$n&&(eo.fall=2,to.children[3].material=Rn),to.children[3].visible=1),ao.lastRedraw=0,requestAnimationFrame(function(){ao.redrawInterval=1e5,ao.lastRedraw=0,ia()}),setTimeout(function(){ia()},50)}function oe(Kn,Zn,$n){var eo=ns[Kn];if('F'!=Ee(Kn))return void console.log('not F');var to=eo.size&&jl<Jl?$n:360-$n,ao=Gl.getObjectByName(Kn),lo=ao.children[1].children[0];lo.redrawInterval=1,0!=Zn&&90!=Zn&&(ao.children[1].children[0].material.map.text=''+Zn),ao.children[0].material.rotation=Math.round(1e3*(-Math.PI/180*to))/1e3,0==Zn&&(ao.children[0].material.map=Vn,ao.children[1].children[0].material.map.text='',ao.children[0].material.rotation=0),90==Zn&&(ao.children[0].material.map=Mn,ao.children[1].children[0].material.map.text=''),0!=Zn&&90!=Zn&&(ao.children[0].material.map=Dn),eo.fall=parseInt(Zn),eo.angle=parseInt($n),oman.updchangelist(eo.sid),de(),setTimeout(function(){lo.redrawInterval=1e8,de()},50)}function re(Kn,Zn,$n,eo,to,ao){var lo=ao==jl<Jl?eo:360-eo,no='',oo=new THREE.Object3D;if(0!=to&&90!=to){ws=new THREE.SpriteMaterial({map:Dn,color:16777215,rotation:-Math.PI/180*lo});var po=new THREE.Sprite(ws);no=to+''}if(0==to)var co=new THREE.SpriteMaterial({map:Vn,color:16777215}),po=new THREE.Sprite(co);if(90==to){ws=new THREE.SpriteMaterial({map:Mn,color:16777215,rotation:-Math.PI/180*lo});var po=new THREE.Sprite(ws)}po.position.set(Kn,Zn,$n),po.scale.x=po.scale.y=0.4*oi;var uo=ae(no,Kn+0.25*ii,Zn-0.12*oi,$n,0);return oo.add(po),oo.add(uo),oo}function de(Kn,Zn){renderblock||(jn=0,mt.start('render'),requestAnimationFrame(function(){if(null==Kn&&controls.update(),Ol?renderer.render(js,camera):null==Zn?renderer.render(Gl,camera):renderer.render(Zn,camera),null==Kn&&(1==rendebug&&console.log('r'),2==rendebug)){var $n=de.caller;console.log($n)}if(null!=null,jn=1,'debug1'==params.author){var eo=mt.end('render');L('FPS '+Math.round(1e3/eo))}}))}function ue(Kn,Zn){var $n=Ya();if(!$n)return void console.log('Nothing to save');var eo=JSON.stringify($n),to=getpelrange(eo,picparams.ps,picparams.pe);params.textsave=eo,Gi.updateDisplay();var ao=new Date,lo='',no=getauthorandsid($n);lo='pel'+to[0]+'_'+to[1]+'\''+params.tunnel+'\''+no.author+shortsid(no.sid)+'.txt';var oo={name:lo,size:eo.length,content:eo},po=elemfromfile(oo),co=function(mo){dbputreg(mo,function(){null==Zn&&(newdb.ldb(),allq.update())})};console.log('Attempt to add new file to db',po);var uo=newdb.comparef(po);if(uo){console.log('File already exists in db',uo);var ho=po.savedata,go=uo.savedata;comparesave(ho,go)?console.log('Files are same, not saving'):(console.log('Adding because files are different'),co(po))}else console.log('Adding new file to db',po),co(po);he(Kn)}function he(){var Zn=Ya(1);if(!Zn)return void console.log('Nothing to save');var $n=JSON.stringify(Zn),eo=getpelrange($n,picparams.ps,picparams.pe);params.textsave=$n,Gi.updateDisplay();var to=new Date,ao='',lo=getauthorandsid(Zn);ao='pel'+eo[0]+'_'+eo[1]+'\''+params.tunnel+'\''+lo.author+shortsid(lo.sid)+'.txt';({name:ao,size:$n.length,content:$n})}function me(Kn,Zn){params.withbg||(Ts.visible=!1),pt();var $n=new THREE.Scene;$n.add(Ys),de(null,$n),console.log('start save as image'),fe(function(eo){Gl.add(Ys),de(),fe(Kn,eo),Ts.visible=!0,bt(),X(),de(),null!=Zn&&(params.what2plot='Geo+Q+Pel')},1)}function fe(Kn,Zn){var $n,to=window.devicePixelRatio;try{$n=renderer.domElement.toDataURL('image/png');var lo=new Image,no='For 3d'==params.what2plot?1:0,oo='Only texture'==params.what2plot?1:0;lo.onload=function(){var co=document.createElement('canvas');co.width=oo?2*Bl:Il,co.height=oo?2*Bl:Bl,co.width*=to,co.height*=to,co.visible=0;var uo=co.getContext('2d');uo.drawImage(lo,0,0);var ho=uo.getImageData(0,0,co.width,co.height),go=ho.data,mo=go.length,yo=[];if(null!=Zn&&!Array.isArray(Zn))for(var fo=0;fo<mo;fo+=4)if(208==go[fo]&&208==go[fo+1]&&208==go[fo+2]);else yo.push(fo);if(null!=Zn&&!Array.isArray(Zn))return void Kn(yo);if(!params.withbg){for(var fo=0;fo<mo;fo+=4)208==go[fo]&&208==go[fo+1]&&208==go[fo+2]&&(go[fo+3]=0);if(Array.isArray(Zn))for(var fo=0;fo<Zn.length;fo++)go[Zn[fo]+3]=100}console.log('done pic'),ho.data=go,uo.putImageData(ho,0,0);var bo=document.createElement('canvas');bo.visible=0;var vo=uo.getImageData(Bl,0,Bl+Il,Bl);bo.width=Bl,bo.height=Il;var xo=bo.getContext('2d');if(xo.putImageData(vo,0,0),$n=oo?bo.toDataURL():co.toDataURL(),Ml=$n,console.log('tmp pic saved'),void 0!==Kn)return Sl=$n,void Kn();if(!no){var wo=new Date,So='';So=So+'geo'+wo.getHours()+'h'+wo.getMinutes()+'m'+wo.getSeconds()+'s.png',Pn($n,So)}},lo.src=$n}catch(co){return void console.log(co)}}function be(){if(!Ul){var Kn=Ee();Kn&&('L'==Kn?myask(container,'Remove line?',function(){we(),Sn=-1e3,X(),de()}):(we(),X(),de()))}}function we(){if(oman.so){allp.remove(oman.sp);var Kn=[];if(Kn=Se(oman.selidx),'Group'==mi.value&&1<Kn.length)for(var Zn=0;Zn<Kn.length;Zn++)oman.removefromscene(oman.get(Kn[Zn]),1);else oman.removefromscene(oman.so);Es.visible=!1,oman.so=null,oman.selidx=null}}function Se(Kn){for(var Zn=[Kn],$n=Kn-1;0<=$n&&1!=ns[$n].skip&&ns[$n].xe==ns[$n+1].xs&&ns[$n].ye==ns[$n+1].ys;$n--)Zn.push($n);for(var $n=Kn+1;$n<ns.length&&1!=ns[$n].skip&&ns[$n-1].xe==ns[$n].xs&&ns[$n-1].ye==ns[$n].ys;$n++)Zn.push($n);return Zn.sort((eo,to)=>eo-to),Zn}function ke(Kn){var Zn=[];if(-1==Kn[0])return Zn;for(var eo,$n=0;$n<Kn.length;$n++)eo=Kn[$n],0==$n&&(Zn.push(ns[eo].xs),Zn.push(ns[eo].ys)),Zn.push(ns[eo].xe),Zn.push(ns[eo].ye);return Zn}function Fe(){oman.undo(),X(),yi.setAttribute('class','geobutton1'),setTimeout(function(){yi.setAttribute('class','geobutton')},200)}function qe(){this.tunnel='',this.zeropel=0,this.pelperunit=1,this.pelstart=0,this.pelend=20,this.qval={},this.pval={},this.pw=ei,this.author='V',this.sid=Cl,this.lastchange=0,this.objdata=[]}function De(Kn,Zn){for(var $n=ns.length,eo=1e3,to=-1,ao=-20,lo=-20,no=1,oo=0;oo<$n;oo++)if(!ns[oo].skip){no=1;var po=ns[oo].xs,co=ns[oo].ys,uo=(Kn-po)*(Kn-po)+(Zn-co)*(Zn-co);if('L'==ns[oo].type){var ho=Me(ns[oo],Kn,Zn);uo=ho[0],po=ho[2],co=ho[3],(0>ho[1]||1<ho[1])&&(no=0)}eo>=uo&&no&&(eo=uo,to=oo,ao=po,lo=co)}return[to,ao,lo,Math.sqrt(eo)]}function Me(Kn,Zn,$n){var eo=Kn.xs,to=Kn.xe,ao=Kn.ys,lo=Kn.ye,no=Math.sqrt((to-eo)*(to-eo)+(lo-ao)*(lo-ao)),co=[0,1,2,3,4],ho=((to-eo)*(Zn-eo)+(lo-ao)*($n-ao))/no/no,go=eo+ho*no*((to-eo)/no),mo=ao+ho*no*((lo-ao)/no),yo=Math.sqrt((Zn-eo)*(Zn-eo)+($n-ao)*($n-ao)),fo=Math.sqrt((Zn-to)*(Zn-to)+($n-lo)*($n-lo)),bo=Math.sqrt((Zn-go)*(Zn-go)+($n-mo)*($n-mo));return co[0]=Math.sqrt((Zn-go)*(Zn-go)+($n-mo)*($n-mo)),Ve(ho)||(co[0]=Math.min(yo,fo)),co[1]=ho,co[2]=go,co[3]=mo,co[4]=0,0>=(to-eo)*($n-ao)-(lo-ao)*(Zn-eo)&&(co[4]=1),co}function Ve(Kn){return 0<=Kn&&1>=Kn}function Qe(){localStorage.setItem('lastauthor',params.author)}function Re(Kn){return': -1??'==Kn?'':Kn}function Le(Kn,Zn,$n){Zn.value=Kn+Re(': '+$n),'-1??'!=$n&&Zn.setAttribute('class','inguib aguibut')}function je(){Le('RQD',Ii.rqd,en.RQD+en.RQDc),Le('Jn',Ii.Jn,en.Jn+en.Jnc),Le('Jr',Ii.Jr,en.Jr+en.Jrc),Le('Ja',Ii.Ja,en.Ja+en.Jac),Le('Jw',Ii.Jw,en.Jw+en.Jwc),Le('SRF',Ii.SRF,en.SRF+en.SRFc),en.getQ(),'????'==en.Q+en.class?Ii.Q.name('Q = ?'):Ii.Q.name('Q = '+en.Q+en.class),Gi.updateDisplay()}function Je(Kn,Zn){var $n=Kn.add(bf,'blank').name(Zn).__li;return $n.setAttribute('class','cr function myguibut'),null==Zn&&$n.removeChild($n.children[0]),$n}function Pe(Kn){Kn.style.height='5px',Kn.style.height=Kn.scrollHeight-5+'px'}function Ae(Kn){for(var Zn=0;Zn<Ci.length;Zn++)if(Kn==Ci[Zn])return Ri[Zn]}function Ee(Kn){var Zn=0,$n=Ks;null!=Kn&&($n=Kn);Gl.getObjectByName($n);return null==ns[$n]?Zn:1==ns[$n].skip?Zn:ns[$n].type}function Te(Kn){var Zn=Oe(Kn);if(-3==Zn)return void console.log('Nothing selected');var $n=Ee(Kn);chosenp=Zn,-2==chosenp?(tn=new He,tn.type=$n,tn.coords=Zl,tn.isarea=Ye(Zl)):tn.restore(allp.par[chosenp]),Aa('Select',$n),Gi.updateDisplay()}function Oe(Kn){var Zn=Ee(Kn);if(!Zn)return console.log('Nothing selected'),-3;if('L'==Zn){var $n=Se(Kn);Zl=ke($n),0==Zl.length&&console.log('No lines selected')}else Zl=[ns[Kn].xs,ns[Kn].ys];return allp.get(Zl)}function Ie(Kn){for(var Zn=normPel(jl,Jl),$n=Zn[0];$n<Zn[1];$n+=5)if(Kn>=$n&&Kn<$n+5){var eo=allq.get($n),to=allq.get($n+5);if(-2==eo&&-2==to)return console.log('No Q near'),[$n,$n+5];var ao=$n,lo=-2==to?eo:to;ao=-2==to?Math.max(allq.qar[eo].ps,allq.qar[eo].pe):Math.min(allq.qar[to].ps,allq.qar[to].pe);var no=-2==to?5:-5;return[ao,ao+no]}return console.log('No q found'),[Kn,Kn+5*Zn[2]]}function Be(Kn){var Zn=Wa(Kn);if(ln=allq.get(Zn),-2==ln){en=new $e,en.getQ();var $n=Ie(Zn);en.ps=$n[0],en.pe=$n[1],en.comment=''}else en.restore(allq.qar[ln]);de(),ds==qa.qval?(Gi.removeFolder(qa.qval),Ja()):Aa(qa.qval),Pi.close(),Gi.removeFolder(qa.main),Gi.removeFolder(qa.setproperties),Ei.open(),Es.visible=!0,Es.position.set(1.2*-ei,0.35*_a(en.pe)+0.65*_a(en.ps),10),je(),Gi.updateDisplay()}function Ge(){setTimeout(function(){Gi.open()},200)}function Ne(){Gi.close()}function _e(){-1<ln?(en.lastchange=Cl,allq.qar[ln].restore(en)):(allq.add(en),ln=allq.qar.length-1),oman.updchangelist(en.sid),allq.update(),ia(null,1)}function We(){allq.remove(ln),allq.update(),de(),en=new $e,je()}function Ue(){if(0==Zl.length)return void console.log('No lines selected');if(-1<chosenp){if('undefined'==typeof allp.par[chosenp])return void console.log('No lines selected');allp.par[chosenp].restore(tn),allp.par[chosenp].author=params.author,allp.par[chosenp].lastchange=Cl,'L'==allp.par[chosenp].type&&(allp.par[chosenp].color=Mt(Ae(tn.bergart)))}else tn.author=params.author,'L'==tn.type&&(tn.color=Mt(Ae(tn.bergart))),tn.sid=Cl,allp.add(tn),chosenp=allp.amtok()-1;oman.sp=allp.par[chosenp],allq.update(),de()}function He(){this.author=params.author,this.sid=Cl,this.lastchange=Cl,this.type='',this.bergart='none',this.ispartofQ=0,this.id='',this.coords=[],this.color=0,this.comment='',this.width=0,this.dsc='Not given',this.wdrip=0,this.wleak=0,this.isarea=!1,this.restore=function(Kn){var Zn=JSON.parse(JSON.stringify(Kn));this.sid=Zn.sid,this.lastchange=null==Zn.lastchange?this.sid:Zn.lastchange,this.type=Zn.type,this.id=Zn.id,this.coords=Zn.coords,this.bergart=Zn.bergart,this.width=Zn.width,this.comment=Zn.comment,this.ispartofQ=Zn.ispartofQ,null!=Zn.author&&(this.author=Zn.author),this.isarea=Zn.isarea,this.color=Zn.color,null!=Zn.dsc&&(this.dsc=Zn.dsc,this.wdrip=Zn.wdrip,this.wleak=Zn.wleak)},this.sameas=function(Kn){if(0==Kn.length)return!1;for(var Zn=0;Zn<Math.min(Kn.length,this.coords.length)&&!(6<Zn);Zn++){if(20<Zn)return console.log('Same',this.coords),!0;if(10<Kn.length){var $n=Ga(Kn[Zn],this.coords[Zn]);if(!$n)return!0}if(!Ba(Kn[Zn],this.coords[Zn]))return!1}return!0},this.showprops=function(){var Kn;return Kn='W'==this.type?this.coords+' wdrip='+this.wdrip+' wleak='+this.wleak:this.bergart+' '+this.coords,Kn}}function Xe(){this.par=[],this.getareas=function(){var Kn=[];for(var Zn in this.par){var $n=this.par[Zn];$n.isarea&&!$n.ispartofQ&&Kn.push($n)}return Kn},this.amtok=function(){for(var Kn=0,Zn=0;Zn<this.par.length;Zn++)this.par[Zn].ispartofQ||Kn++;return Kn},this.add=function(Kn,Zn){var $n=new He;$n.restore(Kn),this.par.push($n),null==Zn&&this.update()},this.remove=function(Kn,Zn){if('object'==typeof Kn)for(var $n in console.log('Trying to remove',Kn),this.par){var eo=this.par[$n];if(eo==Kn){this.par.splice($n,1);break}}else-1<Kn&&this.par.splice(Kn,1);null==Zn&&this.update()},this.cleanFromQ=function(){for(var Kn=0;Kn<this.par.length;Kn++)1==this.par[Kn].ispartofQ&&(this.remove(Kn,1),Kn--)},this.y2pelcoords=function(){for(var Kn=0;Kn<this.par.length;Kn++)for(var Zn=0;Zn<this.par[Kn].coords.length;Zn+=2)this.par[Kn].coords[Zn+1]=Wa(this.par[Kn].coords[Zn+1])},this.cleanFromPel=function(){for(var Kn=0;Kn<this.par.length;Kn++)ul(this.par[Kn].coords[1])||(console.log('Skipping property',this.par[Kn]),this.remove(Kn),Kn--)},this.get=function(Kn){for(var Zn=0;Zn<this.par.length;Zn++)if(this.par[Zn].sameas(Kn))return Zn;return-2},this.restore=function(Kn,Zn,$n){var eo=!1;null!=$n&&(eo=$n);for(var ao,to=0;to<Kn.par.length;to++)(ao=this.ismemberalready(Kn.par[to]),null==Kn.par[to].sid&&(Kn.par[to].sid=Xn),null==Kn.par[to].author&&(Kn.par[to].author=Yn),!(1==eo&&Kn.par[to].sid<Cl))&&(1<eo&&Kn.par[to].sid!=eo||(-1<ao?this.par[ao].restore(Kn.par[to]):this.add(Kn.par[to],Zn)));null==Zn&&(console.log('Update inside restore'),this.update())},this.ismemberalready=function(Kn){for(var Zn=0;Zn<this.par.length;Zn++)if(this.par[Zn].sameas(Kn.coords))return Zn;return-1},this.update=function(){mt.start('updatePinside');var Kn=renderblock;if(renderblock=1,Fa(),params.showbergart)for(var Zn=0;Zn<this.par.length;Zn++)if(('L'==this.par[Zn].type||this.par[Zn].ispartofQ)&&(this.par[Zn].isarea&&at(this.par[Zn].coords,Ae(this.par[Zn].bergart),this.par[Zn].ispartofQ),''!=this.par[Zn].comment)){var eo,to,$n=this.par[Zn].coords.length;eo=this.par[Zn].coords[$n-2],to=this.par[Zn].coords[$n-1];var ao=ae('comment!',eo,to,5,1);Ys.add(ao)}renderblock=Kn,mt.end('updatePinside')}}function Ye(Kn){var Zn=Kn.length;return Zn%2?(console.log('Odd amount of coordinates?'),console.log(Kn),!1):!(8>Zn)&&Kn[0]==Kn[Zn-2]&&Kn[1]==Kn[Zn-1]}function Ke(Kn){var Zn=jl<Jl,$n=allq.get(Kn);return-1<$n&&(Zn=allq.qar[$n].ps>allq.qar[$n].pe?0:Zn),jl<tunborder&&(Zn=13730<Kn&&13915>Kn||14350<Kn&&14980>Kn?0:1),17057<Kn&&17068>Kn&&(Zn=1),Zn}function Ze(){this.qar=[],this.add=function(Kn){var Zn=new $e;Zn.restore(Kn),this.qar.push(Zn)},this.get=function(Kn){for(var to,Zn=1e3,$n=-2,eo=0;eo<this.qar.length;eo++)to=Zn,(this.qar[eo].pe>Kn&&this.qar[eo].ps<Kn||this.qar[eo].ps>Kn&&this.qar[eo].pe<Kn)&&(Zn=Math.min(Zn,Math.abs(Kn-this.qar[eo].ps),Math.abs(Kn-this.qar[eo].pe),Math.abs(Kn-(this.qar[eo].pe+this.qar[eo].ps)/2)),to!=Zn&&($n=eo));return $n},this.remove=function(Kn){-1<Kn&&(console.log('Removed Q'),oman.updchangelist(this.qar[Kn].sid),this.qar.splice(Kn,1))},this.removeP=function(Kn){var Zn=this.get(Kn);-1<Zn?this.qar.splice(Zn,1):console.log('No such Q with pel'+Kn)},this.getoverlaps=function(){for(var Kn=[],Zn=0;Zn<this.qar.length;Zn++){for(var $n=0,eo=this.qar[Zn],to=Math.min(eo.ps,eo.pe),ao=Math.max(eo.ps,eo.pe),lo=Zn+1;lo<this.qar.length;lo++){var no=this.qar[lo],oo=Math.min(no.ps,no.pe),po=Math.max(no.ps,no.pe);if(oo<=ao&&oo>=to){if(oo==ao)continue;var co=[oo,Math.min(po,ao)];Kn.push(co),eo.Q==no.Q&&eo.comment==no.comment&&(eo.sid>no.sid?(console.log('Removing overlap',no),this.remove(lo),lo--):$n=1);continue}if(po<=ao&&po>=to){if(po==to)continue;var co=[Math.max(oo,to),po];Kn.push(co),eo.Q==no.Q&&eo.comment==no.comment&&(eo.sid>no.sid?(console.log('Removing overlap',no),this.remove(lo),lo--):$n=1)}}$n&&(console.log('Removing i',eo),this.remove(Zn),Zn--)}return 2<Kn.length&&console.log('Overlaps',Kn),Kn},this.update=function(){mt.start('updateQ'),mt.start('Get Q overlaps'),this.getoverlaps(),mt.end('Get Q overlaps'),za(),mt.start('Clean Q'),allp.cleanFromQ(),mt.end('Clean Q');for(var Kn=0;Kn<this.qar.length;Kn++)if(ka(this.qar[Kn].ps,this.qar[Kn].pe,this.qar[Kn].getQ(),this.qar[Kn].class,this.qar[Kn].comment),'none'!=this.qar[Kn].bergart){var Zn=new Xe,$n=new He;$n.ispartofQ=1;var eo=_a(this.qar[Kn].ps),to=_a(this.qar[Kn].pe);$n.coords=[-ei,eo,-ei,to,ei,to,ei,eo],$n.bergart=this.qar[Kn].bergart,$n.isarea=!0,Zn.add($n,1),allp.restore(Zn,1)}mt.start('updatePFinal'),allp.update(),mt.end('updatePFinal'),mt.end('updateQ')},this.clear=function(){za(),this.qar=[]},this.restore=function(Kn,Zn,$n){var eo=!1;null!=$n&&(eo=$n);for(var to=0;to<Kn.qar.length;to++)if((null==Kn.qar[to].sid&&(Kn.qar[to].sid=Xn),null==Kn.qar[to].author&&(Kn.qar[to].author=Yn),!(1==eo&&Kn.qar[to].sid<Cl))&&!(1<eo&&Kn.qar[to].sid!=eo)){if(params.onlycurpel&&(!ul(Kn.qar[to].ps)||!ul(Kn.qar[to].pe))){console.log('Q not in limits'+Kn.qar[to].ps+' '+Kn.qar[to].pe);continue}var ao=this.isequal(Kn.qar[to]);-1<ao?this.qar[ao].restore(Kn.qar[to]):this.add(Kn.qar[to])}null==Zn&&this.update()},this.isequal=function(Kn){for(var Zn=0;Zn<this.qar.length;Zn++)if(this.qar[Zn].ps==Kn.ps&&this.qar[Zn].pe==Kn.pe)return Zn;return-1}}function $e(){this.author=params.author,this.sid=Cl,this.lastchange=Cl,this.ps=jl,this.pe=Jl,this.RQDc='??',this.Jrc='??',this.Jwc='??',this.Jnc='??',this.Jac='??',this.SRFc='??',this.Jnmult=1,this.RQD=-1,this.Jr=-1,this.Jw=-1,this.Jn=-1,this.Ja=-1,this.SRF=-1,this.Q='??',this.class='??',this.comment='',this.bergart='none',this.getQ=function(){return 0>this.RQD||0>this.Jr||0>this.Jr||0>this.Jn||0>this.Ja||0>this.SRF?this.Q:(this.Q=Math.round(1e3*(Math.max(this.RQD,10)*this.Jr*this.Jw/(this.Jn*this.Ja*this.SRF)))/1e3,0.01<this.Q&&(this.Q=Math.round(100*this.Q)/100),1<this.Q&&(this.Q=Math.round(10*this.Q)/10),this.class='G',0.01<this.Q&&(this.class='F'),0.1<this.Q&&(this.class='E'),1<this.Q&&(this.class='D'),4<this.Q&&(this.class='C'),10<this.Q&&(this.class='A/B'),this.Q)},this.restore=function(Kn){this.ps=Kn.ps,this.pe=Kn.pe,this.comment=Kn.comment,this.bergart=Kn.bergart,this.RQDc=Kn.RQDc,this.Jrc=Kn.Jrc,this.Jwc=Kn.Jwc,this.Jnc=Kn.Jnc,this.Jac=Kn.Jac,this.SRFc=Kn.SRFc,this.Jnmultc=1,this.RQD=Kn.RQD,this.Jr=Kn.Jr,this.Jw=Kn.Jw,this.Jn=Kn.Jn,this.Ja=Kn.Ja,this.SRF=Kn.SRF,null!=Kn.author&&(this.author=Kn.author),null!=Kn.sid&&(this.sid=Kn.sid),this.lastchange=null==Kn.lastchange?this.sid:Kn.lastchange,this.getQ()}}function at(Kn,Zn,$n){for(var ao,eo=[],to=0;to<Kn.length;to+=2)ao=new THREE.Vector3(Kn[to],Kn[to+1],1-0.02*$n),eo.push(ao);var no,oo,po=new THREE.Geometry,co=new THREE.MeshBasicMaterial({color:Zn,transparent:!0,opacity:0.7});co.side=THREE.DoubleSide,po.vertices=eo,no=THREE.ShapeUtils.triangulateShape(eo,[]);for(var to=0;to<no.length;to++)po.faces.push(new THREE.Face3(no[to][0],no[to][1],no[to][2]));oo=new THREE.Mesh(po,co),Ys.add(oo),de()}function lt(Kn){for(var Zn=Kn.elements,$n=0;$n<Zn.length;$n++)Zn[$n]=mr(Zn[$n]);return Zn}function rt(Kn,Zn){var $n={x:(Kn/ei+1)/2,y:(Zn/li+1)/2};return $n}function dt(Kn,Zn){var $n=Zn.x-Kn[0].x,eo=Zn.y-Kn[0].y,to=0<(Kn[1].x-Kn[0].x)*eo-(Kn[1].y-Kn[0].y)*$n;return 0<(Kn[2].x-Kn[0].x)*eo-(Kn[2].y-Kn[0].y)*$n!=to&&0<(Kn[2].x-Kn[1].x)*(Zn.y-Kn[1].y)-(Kn[2].y-Kn[1].y)*(Zn.x-Kn[1].x)==to}function pt(){controls.reset(),controls.target.set(0,0,0),camera.position.set(0,0,ti),cameraFix.position.set(0,0,ti),$a(),ht(),X()}function ht(){var Kn=window.devicePixelRatio;Il=zl,Bl=Fl,camera.left=-ei,camera.right=ei,camera.top=li+si,camera.bottom=-li+si,cameraFix.left=-ei,cameraFix.right=ei,cameraFix.top=li+si,cameraFix.bottom=-li+si,'Geo+Q+Pel'==params.what2plot&&(camera.left=-ei-1.2,camera.right=ei+1.2,Il*=1.3,lsc=0.5),Il/=Kn,Bl/=Kn;'For 3d'!=params.what2plot&&4096<Bl&&(Il=4096*Il/Bl,Bl=4096);var $n=Il,eo=Bl;'For 3d'==params.what2plot,renderer.setSize($n,eo),vi=new THREE.Vector2($n,eo),'For 3d'==params.what2plot&&(lsc=Math.min(0.5,5e3/eo));var to=android||iOS?4:1;buftext=new THREE.WebGLRenderTarget(4096/to,16384/to,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat}),camera.updateProjectionMatrix(),cameraFix.updateProjectionMatrix()}function gt(){Ol||(sensivity=1,params.what2plot='For 3d',zt(jl,Jl,1),pt(),Ea(),Ol=!0,renderer.render(Gl,cameraFix,buftext),bt(),Jt(),camera.position.set(0,0,1e3),params.what2plot='Geo+Q+Pel',controls.enableRotate=!0,de(),check3dbox.style.display='',check3dbox.checked=!0,fgui.close(),Aa('3d'))}function yt(){if(Ol){for(sensivity=5;0<js.children.length;)js.remove(js.children[0]);buftext.dispose(),Gl=Ps,params.resetcam(),controls.enableRotate=!1,Ol=!1,camera.position.set(0,0,ti),lsc=1,bt(),X(),Ea(),zt(jl,Jl),setTimeout(function(){de()},50),mi.value='Select',Aa('Line'),check3dbox.style.display='none',fgui.close(),Gi.close()}}function ft(){Jl+=5*pmult,jl-=5*pmult,Pl=Math.abs(parseInt(jl)-parseInt(Jl)),Fl=Al*Pl,Bl=Fl,li=Fl/$s,G(jl,Jl,si),zt(jl,Jl),ka(jl,Jl,-1),Sa(Dl,_a(Jl-2.5*pmult)),Sa(Dl,_a(jl+2.5*pmult)),de()}function bt(){F(),vi=new THREE.Vector2(fi,bi),xi=fi/bi,camera.left=-Si*xi/2,camera.right=Si*xi/2,camera.top=ki/2,camera.bottom=-ki/2,camera.updateProjectionMatrix(),renderer.setSize(fi,bi),de()}function xt(){if(Bi)return!1;for(var Kn=0,Zn=0;Zn<ns.length;Zn++)1!=ns[0].skip&&(Kn=1);if(allq.qar.length&&(Kn=1),!Kn)return!1;var $n=new Date().getTime(),eo=Ya(1),to=JSON.stringify(eo);localStorage.setItem(us.s,to);var ao=new Date().getTime()-$n;return console.log('dT = '+ao),!0}function wt(){if(localStorage.getItem(us.l)){var Kn=localStorage.getItem(us.l),Zn=JSON.parse(Kn);console.log('Sid set to',Zn.sid),Ia(Zn),allq.update(),X(),de(),params.restses=0,Aa('Line')}}function zt(Kn,Zn,$n){if(Gl.remove(Ns),!!params.rutenett){Ns=new THREE.Object3D;var eo=normPel(Kn,Zn),to=eo[0],ao=eo[1],lo=-4;null!=$n&&(lo=-0.5);for(var ho,uo=to;uo<=ao;uo++){ho=[],ho.push(-ei,_a(uo),1,1.13*ei,_a(uo),1);var go=Y(ho,lo,'0#000000');Ns.add(go)}Gl.add(Ns)}}function Ft(){if(params.vederlag){var Kn=tungeom[params.tunnel].Width,Zn=[];for(var $n in Kn){var eo=Kn[$n][1],to=Kn[$n][3],ao=Kn[$n][5],lo=ao-eo;Zn.push([Kn[$n][0],2*((Kn[$n][2]-eo)/lo)-1,2*((Kn[$n][3]-eo)/lo)-1,2*((Kn[$n][4]-eo)/lo)-1])}for(var go,mo,yo,fo,lo,no=normPel(jl,Jl),oo=no[0],po=no[1],co=[],uo=[],ho=[],bo=1,$n=oo;$n<po;$n++){if(lo=Math.max($n,Zn[0][0]),lo=$n,go=Dt(lo,Zn),yo=_a(lo),mo=Dt(lo+pmult,Zn),fo=_a(lo+1),!go||!mo){console.log('No vederlag data for pel=',$n),bo=0;break}co.push(go[0]),co.push(yo),co.push(1),uo.push(go[1]),uo.push(yo),uo.push(1),ho.push(go[2]),ho.push(yo),ho.push(1)}bo&&(co.push(mo[0]),co.push(fo),co.push(1),uo.push(mo[1]),uo.push(fo),uo.push(1),ho.push(mo[2]),ho.push(fo),ho.push(1)),Y(co,-4,'0#000000'),Y(uo,-4,'0#000000'),Y(ho,-4,'0#000000')}}function Dt(Kn,Zn){for(var $n=Zn.length,eo=xct=xrt=0,to=0,ao=0,lo=0;lo<$n-1;lo++)if(Kn>=Zn[lo][0]&&Kn<Zn[lo+1][0]||Kn<=Zn[lo][0]&&Kn>Zn[lo+1][0]){var no=Zn[lo+1][0]-Zn[lo][0];0==no?to=[Zn[lo][1]*ei,Zn[lo][2]*ei,Zn[lo][3]*ei]:(ao=(Kn-Zn[lo][0])/(Zn[lo+1][0]-Zn[lo][0]),eo=Zn[lo][1]+ao*(Zn[lo+1][1]-Zn[lo][1]),xct=Zn[lo][2]+ao*(Zn[lo+1][2]-Zn[lo][2]),xrt=Zn[lo][3]+ao*(Zn[lo+1][3]-Zn[lo][3]),to=[eo*ei,xct*ei,xrt*ei])}return to?to:Kn<Zn[0][0]?[Zn[0][1]*ei,Zn[0][2]*ei,Zn[0][3]*ei]:[Zn[$n-1][1]*ei,Zn[$n-1][2]*ei,Zn[$n-1][3]*ei]}function Mt(Kn,Zn){var $n=Kn;return 7==$n.length?($n=null==Zn?'0x'+$n[5]+$n[6]+$n[3]+$n[4]+$n[1]+$n[2]:'0x'+$n[1]+$n[2]+$n[3]+$n[4]+$n[5]+$n[6],parseInt($n)):0}function Vt(){Ol?(ci.style.display='none',ui.style.display='none',hi.style.display='none',mi.style.display='none',yi.style.display='none'):(ci.style.display='',ui.style.display='',hi.style.display='',mi.style.display='',yi.style.display='')}function Qt(){ci.setAttribute('class','geobutton'),ui.setAttribute('class','geobutton'),hi.setAttribute('class','geobutton'),gi.setAttribute('class','geobutton'),mi.setAttribute('class','geobutton')}function Rt(Kn){var Zn=[],$n=Kn.length;for(var eo in Zn.push(It(Kn[0][0]+1,Kn)),Kn)Kn[eo][0]>Kn[0][0]+1&&Kn[eo][0]<Kn[$n-1][0]-1&&Zn.push(It(Kn[eo][0],Kn));return Zn.push(It(Kn[$n-1][0]-1,Kn)),Zn}function Lt(Kn){var Zn=tungeom[Kn].TunProfile,$n=parse3dmod(Zn),eo=Rt($n),to=At($n);for(var ao in eo)to.add(jt(eo[ao]));var lo=($n[0][0]+$n[$n.length-1][0])/2,no=-_a(lo);return[$n,to]}function jt(Kn){var Zn=[];for(var $n in Kn.v)Zn.push(Kn.v[$n].x),Zn.push(Kn.v[$n].y),Zn.push(Kn.v[$n].z);var eo=new THREE.Object3D,to=Y(Zn,10,'0#000000');return eo.add(to),eo}function Jt(){p2y=_a;var Kn=On,Zn=Kn[0];lingeom=new THREE.Object3D,lingeom.add(On[1]),lingeom.add(Bn);var $n=(Zn[0][0]+Zn[Zn.length-1][0])/2,eo=_a($n),to=getglobc((jl+Jl)/2);lingeom.position.set(-to.x,-to.y,-to.z);var ao=Ot(Zn),lo=ao[0];for(var no in partlingeom=ao[1],pmat=new THREE.MeshBasicMaterial({map:buftext.texture,transparent:!0,opacity:0.5,depthTest:!0}),pmat.side=THREE.DoubleSide,my3dgroup=new THREE.Object3D,meshes=new THREE.Object3D,lo){var oo=new THREE.Mesh(lo[no][2],pmat);oo.castShadow=!1,oo.receiveShadow=!1,meshes.add(oo)}meshes.position.set(-to.x,-to.y,-to.z),my3dgroup.add(meshes),js=new THREE.Scene,Ps=Gl;var po=new THREE.Object3D;params.showholes&&(po.add(Ws),po.position.set(-to.x,-to.y,-to.z),my3dgroup.add(po));var co=new THREE.Object3D;my3dgroup.add(co),lo[0][2].computeBoundingSphere();var uo=lo[0][2].boundingSphere.center,ho=new THREE.Quaternion;ho.setFromUnitVectors(new THREE.Vector3(0,0,1),new THREE.Vector3(0,1,0));for(var go,mo,yo=0;yo<oman.ao.length;yo++)if('B'==oman.ao[yo].type){var fo=rt(oman.get(yo).xs,oman.get(yo).ys),bo=Wa(oman.get(yo).ys),vo=new THREE.Vector2(fo.x,fo.y);for(var xo in lo)if(numintersect(lo[xo][0],lo[xo][1],bo,bo)){go=En(meshes.children[xo],vo);break}var wo=rt(oman.get(yo).xe,oman.get(yo).ye),bo=Wa(oman.get(yo).ye),vo=new THREE.Vector2(wo.x,wo.y);for(var xo in lo)if(numintersect(lo[xo][0],lo[xo][1],bo,bo)){mo=En(meshes.children[xo],vo);break}var So=mo[0],ko=mo[1],zo=go[0],Fo=go[1],qo=10,Do=An(new THREE.Vector3(zo.x,zo.y,zo.z),new THREE.Vector3(So.x+1*(Fo.x*qo),So.y+1*(Fo.y*qo),So.z+1*(Fo.z*qo)));co.add(Do)}my3dgroup.applyQuaternion(ho),my3dgroup.add(lingeom),my3dgroup.add(partlingeom),js.add(my3dgroup),js.add(fallar),js.add(line3dgroup),js.add(line3dtemp),controls.enableRotate=!0,de()}function At(Kn){for(var Zn=Kn[0][1].length,$n=new THREE.Object3D,eo=[],to=Kn[0][1],ao=[],lo=Kn[0][0]+1;lo<Kn[Kn.length-1][0]-1;lo+=2)ao.push(It(lo,Kn));for(var no in to){for(var oo in eo=[],ao){var po=ao[oo],co=po.v[no];eo.push(co.x,co.y,co.z)}var no=Y(eo,5,'0#000000');$n.add(no)}return $n}function Tt(Kn,Zn){var $n=[];if(Kn<Zn[0][0])return Us=[Kn,Zn[0][1]],Us;if(Kn>Zn[Zn.length-1][0])return Us=[Kn,Zn[Zn.length-1][1]],Us;for(var eo=1;eo<Zn.length;eo++)if(Kn>=Zn[eo-1][0]&&Kn<=Zn[eo][0]){var to=Zn[eo-1][0],ao=Zn[eo][0],lo=(Kn-to)/(ao-to);for(var no in Zn[eo][1]){var oo=Zn[eo][1][no],po=Zn[eo-1][1][no];$n.push(new THREE.Vector2(oo.x*lo+po.x*(1-lo),oo.y*lo+po.y*(1-lo)))}break}return $n.length||console.log('Error! Vout not defined in getcurveatpel'),[Kn,$n]}function Ot(Kn){for(var po,Zn=jl,$n=Jl,eo=Tt(Zn,Kn),to=Tt($n,Kn),ao=-1,lo=[[0,eo]],no=[],oo=0;oo<Kn.length;oo++)if((po=Kn[oo][0],Math.round(ao)!=Math.round(po))&&(ao=po,po=Math.round(po),hl(po,Zn,$n))){var co=(po-Zn)/($n-Zn);no.push([co,Kn[oo]])}if(0<pmult)for(var uo=0;uo<no.length;uo++)lo.push(no[uo]);else for(var uo=no.length-1;-1<uo;uo--)lo.push(no[uo]);lo.push([1,to]);for(var ho=new THREE.Object3D,go=[],mo=[],uo=0;uo<lo.length-1;uo++)for(var yo=lo[uo][1][0],fo=lo[uo+1][1][0],bo=0,oo=yo;0>(oo-fo)*pmult;oo+=5*pmult){bo++;var co=(oo-Zn)/($n-Zn);if(mo.push([co,Tt(oo,Kn)]),500<bo)return}mo.push(lo[lo.length-1]);for(var uo=1;uo<mo.length;uo++){var vo=It(mo[uo][1][0],Kn),xo=It(mo[uo-1][1][0],Kn);go.push([mo[uo-1][1][0],mo[uo][1][0],Bt(xo,vo,mo[uo-1][0],mo[uo][0])])}return[go,ho]}function It(Kn,Zn){var $n=Tt(Kn,Zn),eo=getglobc(Kn),to=getglobc(Kn,1)[1]/180*Math.PI,ao=getglobc(Kn+0.01),lo=new THREE.Quaternion;null==ao?(ao=getglobc(Kn).sub(getglobc(Kn-0.01)).normalize(),ao=ao.normalize(),ao.z=0,lo.setFromUnitVectors(new THREE.Vector3(1,0,0),ao)):(ao=getglobc(Kn+0.01).sub(eo),ao=ao.normalize(),ao.z=0,lo.setFromUnitVectors(new THREE.Vector3(1,0,0),ao)),0.1<Math.abs(lo.y)&&(console.log(Kn,eo,ao),console.log(Kn,lo));var no={pel:Kn,v:[]};for(var oo in $n[1]){var po=$n[1][oo],co=Math.sin(to),uo=Math.cos(to),ho=new THREE.Vector3(0,po.x,po.y);ho.applyAxisAngle(new THREE.Vector3(1,0,0),to),ho.applyQuaternion(lo),ho.add(eo),no.v.push(ho)}return no}function Bt(Kn,Zn,$n,eo){var to=new THREE.Geometry,ao=0,lo=Kn.v.length;to.faceVertexUvs[0]=[];for(var no=0;no<lo-1;++no){var oo=Kn.v[no],po=Kn.v[no+1],co=Zn.v[no],uo=Zn.v[no+1],ho=no/(lo-1),go=(no+1)/(lo-1),mo=null==$n?0:$n,yo=null==eo?1:eo;to.vertices.push(new THREE.Vector3(oo.x,oo.y,oo.z)),to.vertices.push(new THREE.Vector3(po.x,po.y,po.z)),to.vertices.push(new THREE.Vector3(co.x,co.y,co.z)),to.vertices.push(new THREE.Vector3(uo.x,uo.y,uo.z)),to.faces.push(new THREE.Face3(ao+2,ao+1,ao)),to.faces.push(new THREE.Face3(ao+1,ao+2,ao+3)),to.faceVertexUvs[0].push([new THREE.Vector2(ho,yo),new THREE.Vector2(go,mo),new THREE.Vector2(ho,mo)]),to.faceVertexUvs[0].push([new THREE.Vector2(go,mo),new THREE.Vector2(ho,yo),new THREE.Vector2(go,yo)]),ao+=4}return to.uvsNeedUpdate=!0,to.computeFaceNormals(),to}function Gt(){Bn=new THREE.Object3D;var Kn=tun2='';if('34100'==params.tunnel&&(tun2='34100',Kn='34000'),'34000'==params.tunnel&&(tun2='34000',Kn='34100'),Kn){globavg=tungeom[Kn].Geo3d.globavg,globtc=tungeom[Kn].Geo3d.globtc,Bn=Lt(Kn)[1];var Zn=tv().copy(tungeom[Kn].Geo3d.globavg).sub(tungeom[tun2].Geo3d.globavg);Zn.y=-Zn.y,Bn.position.set(Zn.x,Zn.y,Zn.z)}globavg=tungeom[params.tunnel].Geo3d.globavg,globtc=tungeom[params.tunnel].Geo3d.globtc,globtc[0].pel-=0.1,('Kjorholt'==params.tunnel||'Tunnel1'==params.tunnel)&&(globtc[0].pel=13650),globtc[globtc.length-1].pel+=0.1,On=Lt(params.tunnel)}function Nt(){var Kn=linez.length;if(!(2>Kn)){for(var $n,Zn=1;Zn<Kn;Zn++)$n=new Na,$n.addline(linez[Zn-1].xs,linez[Zn-1].ys,1,linez[Zn].xs,linez[Zn].ys,1,Math.round(30*params.size),'#000000'),oman.add($n);var eo=linez[0].v,to=linez[Math.floor(Kn/2)].v,ao=linez[Kn-1].v,lo=_t();return lo}}function _t(){for(var Kn=linez.length,Zn=Math.floor(Kn/3),$n=Math.floor(2*Kn/3),eo=tv(),to=tv(),ao=tv(),lo=0;lo<Zn;lo++)eo.add(linez[lo].v);eo.multiplyScalar(1/Zn);for(var lo=Zn;lo<$n;lo++)to.add(linez[lo].v);to.multiplyScalar(1/($n-Zn));for(var lo=$n;lo<Kn;lo++)ao.add(linez[lo].v);return ao.multiplyScalar(1/(Kn-$n)),[eo,to,ao]}function Ht(Kn){var Zn=new THREE.Plane().setFromCoplanarPoints(Kn[0],Kn[1],Kn[2]),$n=new THREE.Vector3((Kn[0].x+Kn[1].x+Kn[2].x)/3,(Kn[0].y+Kn[1].y+Kn[2].y)/3,(Kn[0].z+Kn[1].z+Kn[2].z)/3),eo=new THREE.BoxGeometry(150,150,0.5),to=new THREE.MeshBasicMaterial({color:17408,transparent:!0,opacity:0.1}),ao=new THREE.Mesh(eo,to),lo=new THREE.Quaternion;lo.setFromUnitVectors(new THREE.Vector3(0,0,1),Zn.normal),ao.applyQuaternion(lo),ao.position.set($n.x,$n.y,$n.z),ao.scale.set(fscale.val,fscale.val,1),fallar.add(ao)}function Xt(Kn){var Zn=new THREE.Plane().setFromCoplanarPoints(Kn[0],Kn[1],Kn[2]),$n=new THREE.Vector3((Kn[0].x+Kn[1].x+Kn[2].x)/3,(Kn[0].y+Kn[1].y+Kn[2].y)/3,(Kn[0].z+Kn[1].z+Kn[2].z)/3),eo=Zn.normal;0>eo.y&&eo.negate();var to=180*new THREE.Vector3(0,1,0).angleTo(eo)/Math.PI,ao=Wa(linez[0].ys),lo=getglobc(ao+1).sub(getglobc(ao));lo=lo.normalize();var no=getglobc((jl+Jl)/2),oo=new THREE.Quaternion;oo.setFromUnitVectors(new THREE.Vector3(0,0,1),new THREE.Vector3(0,1,0)),lo.applyQuaternion(oo);var po=new THREE.Quaternion;po.setFromUnitVectors(new THREE.Vector3(0,1,0).applyQuaternion(oo),new THREE.Vector3(1,0,0).applyQuaternion(oo));var co=tv().copy(lo).applyQuaternion(po),uo=new THREE.Plane().setFromCoplanarPoints($n,tv().copy($n).add(co),tv().copy($n).add(lo)),ho=tv().copy(eo).projectOnPlane(uo.normal),go=ho.angleTo(lo)<Math.PI/2?1:0,mo=180*ho.angleTo(co)/Math.PI;return mo=go?360-mo:mo,console.log('Strike:',mo),console.log('Dip/Fall',to),[Math.floor(mo),Math.round(to)]}function Zt(){if(linez.length){var Kn=new ConvexHullGrahamScan;for(var Zn in linez)Kn.addPoint(linez[Zn].xs,linez[Zn].ys);var $n=Kn.getHull(),eo=[];for(var to in linez)for(var Zn in $n){var ao=linez[to];$n[Zn].x==ao.xs&&$n[Zn].y==ao.ys&&eo.push(ao)}linez=eo,linez.sort(function(co,uo){return uo.xs-co.xs});var lo=y=0;for(var to in linez)lo+=linez[to].xs,y+=linez[to].ys;lo/=linez.length,y/=linez.length;var no=Nt(),oo=Xt(no),po=new Na;po.addfall(lo,y,8,oo[0],oo[1],1),po.color=no,oman.plot(po),oman.add(po),$t(linez),X(),de(),linez=[],controls.enableRotate=!0,check3dbox.checked=!0,Gi.updateDisplay()}}function $t(Kn){var Zn=[];for(var $n in Kn)Zn.push(Kn[$n].v.x,Kn[$n].v.y,Kn[$n].v.z);if(Zn.length){var eo=Y(Zn,Math.round(40*params.size),'#000000',1);line3dgroup.add(eo)}}function ea(){camera.zoom;return!!(0.5>camera.zoom)}function ia(Kn,Zn){if(ea()){for(var $n in globtxt)globtxt[$n].visible=!1;return void de(Kn)}for(var $n in globtxt)globtxt[$n].visible=!0;var eo=new Date().getTime(),to=5e3;if(null!=Zn&&(to=Zn),eo-Qs>to){for(var $n in globtxt){var ao=globtxt[$n];ao.redrawInterval=1}for(var $n in de(Kn),globtxt){var ao=globtxt[$n];ao.redrawInterval=1e5}Qs=eo}else de(Kn)}function oa(){var Kn=Nn-1;Wn.add(K(Math.cos(5*(Kn/100)*Math.PI)*Kn/50,Math.sin(5*(Kn/100)*Math.PI)*Kn/50,1,Math.cos(5*(Nn/100)*Math.PI)*Nn/50,Math.sin(5*(Nn/100)*Math.PI)*Nn/50,1,5,'#000000')),de(),Nn++,Nn<Gn?requestAnimationFrame(oa):pa()}function ra(){0!=Nn||(Gl.remove(Wn),Wn=new THREE.Object3D,Gl.add(Wn),_n=new mytimer('Time1000',5),requestAnimationFrame(oa))}function pa(){var Kn=_n.end('Time1000');globgeo='FPS '+1e3/(Kn/Gn),lastgeo.innerHTML=globgeo,Nn=0}function ya(){params.withbg?fa(Dl):fa(''),Vi.material=Qi,de()}function fa(Kn){if(''==Kn)Qi=new THREE.MeshBasicMaterial({color:16777215});else{var Zn=new THREE.TextureLoader;Zn.crossOrigin='anonymous';var $n=Zn.load(Kn,function(){de()});$n.magFilter=THREE.NearestFilter,$n.minFilter=THREE.LinearMipMapLinearFilter,$n.anisotropy=2,jl>Jl&&($n.flipY=!1),Qi=new THREE.MeshBasicMaterial({map:$n})}}function ba(Kn,Zn){Cl=getsessionid(),J(),Jl=parseInt(Zn),jl=parseInt(Kn),pmult=jl<Jl?1:-1,El=(jl+Jl)/2,Pl=Math.abs(parseInt(jl)-parseInt(Jl)),Al=50,11>Pl&&(Al=100),6>Pl&&(Al=200),Fl=Al*Pl,Bl=Fl,li=Fl/$s,G(jl,Jl,si),zt(jl,Jl),wa(Dl,0),ka(jl,Jl,-1),params.resetcam(),de(),picparams.ps=jl,picparams.pe=Jl,saveifokdist(picparams.ps,picparams.pe),fgui.updateDisplay()}function va(Kn,Zn,$n){var to=params.tunnel;null!=$n&&(to=$n);var ao=Kn>Zn,lo=Math.min(Kn,Zn),no=Math.max(Kn,Zn),oo=1*Math.floor(lo/1),po=1*Math.floor((no-0.01)/1+1),co=gettunlim(to);('Kjorholt'==params.tunnel||'Tunnel1'==params.tunnel)&&(co.pmin=13650),'34100'==params.tunnel&&(co.pmin=0);var uo=checklims(oo,po,co);oo=uo[0],po=uo[1],picdb.sortbypelasc();var ho=getpicsinrange(to,oo,po);Dl='';var go=ho.length;go&&(oo=parseFloat(picdb.files[ho[0]].ps),po=parseFloat(picdb.files[ho[go-1]].pe)),ao?ba(po,oo):ba(oo,po);var mo={c:-1},yo=function(){mo.c++,mo.c<ho.length?xa(picdb.files[ho[mo.c]],ao,function(){yo()}):console.log('Done')};yo(),yt(),fgui.close(),Gi.close()}function xa(Kn,Zn,$n){var eo=jl>Jl;null!=Zn&&(eo=Zn);var to=new THREE.TextureLoader;to.crossOrigin='anonymous';var ao=to.load(Kn.pic,function(){de(),null!=$n&&$n()});ao.magFilter=THREE.NearestFilter,ao.minFilter=THREE.LinearMipMapLinearFilter,ao.anisotropy=2,eo&&(ao.flipY=!1);var lo=new THREE.MeshBasicMaterial({map:ao}),no=Math.abs(_a(Math.max(Kn.ps,Kn.pe))-_a(Math.min(Kn.ps,Kn.pe))),oo=_a((Kn.ps- -Kn.pe)/2),po=new THREE.PlaneGeometry(no,2*ei,1,1);Vi=new THREE.Mesh(po,lo),Vi.visible=Rl,Vi.position.set(0,oo,0.01);var co=eo?Math.PI:0;Vi.rotateZ(Math.PI/2+co),is.push(Vi),Ts.add(Vi)}function wa(Kn,Zn){Gl.remove(Ts),Ts=new THREE.Object3D,is.length=0,fa(Kn);var $n=new THREE.PlaneGeometry(2*li,2*ei,1,1);Vi=new THREE.Mesh($n,Qi),Vi.position.set(0,Zn/Al,0);var eo=jl>Jl?Math.PI:0;Vi.rotateZ(Math.PI/2+eo),is.push(Vi),Ts.add(Vi),Gl.add(Ts);var to=new THREE.PlaneGeometry(2*li,2.8*ei,1,1),ao=new THREE.Mesh(to,Qi);ao.position.set(0,Zn/Al,0),ao.rotateZ(Math.PI/2+eo),is.push(ao),Ts.add(ao)}function Sa(Kn,Zn){var $n=new THREE.MeshBasicMaterial({color:16777215}),eo=new THREE.PlaneGeometry(5*(2*(Al/$s)),2*ei,1,1),to=new THREE.Mesh(eo,$n);to.position.set(0,Zn,0),to.rotateZ(Math.PI/2),is.push(to),Ts.add(to);var ao=new THREE.PlaneGeometry(5*(2*(Al/$s)),3*ei,1,1),lo=new THREE.Mesh(ao,Ll);lo.position.set(0,Zn,0),lo.rotateZ(Math.PI/2),is.push(lo),Ts.add(lo)}function ka(Kn,Zn,$n,eo,to){var ao,lo=!1;-1==$n?(lo=!0,ao=11184810):(ao=16711680,1<$n&&(ao=16769024),4<$n&&(ao=16746240),10<$n&&(ao=2258722));var no=lo?1:0.8,oo=new THREE.MeshBasicMaterial({color:ao,transparent:!0,opacity:no}),po=_a((Kn+Zn)/2),co=Math.abs(_a(Zn)-_a(Kn)),uo=ei/3,ho=-ei-uo+ei/10,go=new THREE.PlaneGeometry(uo,co,1,1),mo=new THREE.Mesh(go,oo);if(mo.position.set(ho,po,lo?0:1),lo){var yo=Xs.children[0];null!=yo&&Xs.remove(yo),Xs.add(mo),is.push(mo)}else{Hs.add(mo);var fo=ae('Q='+$n+' '+eo,ho,po,10,0);if(Hs.add(fo),null!=to&&''!=to){for(var bo='',vo=0;vo<Math.min(4,to.length);vo++)bo+=to[vo];bo+='..!';var xo=ae(bo,ho-0.35*ii,po+0.38*co,10,1);Hs.add(xo)}}}function za(){for(;Hs.children.length;){var Kn=Hs.children[0];'undefined'!=typeof Kn.material&&Kn.material.dispose(),'undefined'!=typeof Kn.geometry&&Kn.geometry.dispose(),Hs.remove(Kn)}}function Fa(){for(;Ys.children.length;){var Kn=Ys.children[0];'undefined'!=typeof Kn.material&&Kn.material.dispose(),'undefined'!=typeof Kn.geometry&&Kn.geometry.dispose(),Ys.remove(Kn)}}function Da(){for(;Is.children.length;){var Kn=Is.children[0];'undefined'!=typeof Kn.material&&Kn.material.dispose(),'undefined'!=typeof Kn.geometry&&Kn.geometry.dispose(),Is.remove(Kn)}for(;_s.children.length;){var Kn=_s.children[0];'undefined'!=typeof Kn.material&&Kn.material.dispose(),'undefined'!=typeof Kn.geometry&&Kn.geometry.dispose(),_s.remove(Kn)}for(;Os.children.length;){var Kn=Os.children[0];'undefined'!=typeof Kn.material&&Kn.material.dispose(),'undefined'!=typeof Kn.geometry&&Kn.geometry.dispose(),Os.remove(Kn)}}function Va(Kn,Zn){var $n=document.createElement('input',Zn);$n.setAttribute('class','inguib'),$n.setAttribute('type','button'),$n.setAttribute('value',Kn),$n.setAttribute('id','mgb'+Kn);var eo=new Hammer($n);return $n.onfocus=function(){$n.blur()},eo.on('press',function(){mycswitch($n,'ibpressed',500),null!=Zn&&setTimeout(function(){Zn()},150)}),C(eo),$n}function Ca(){var Kn=new FormData;Kn.append('data',params.author);try{var Zn=window.XMLHttpRequest?new XMLHttpRequest:new activeXObject('Microsoft.XMLHTTP');Zn.onreadystatechange=function(){if(4===Zn.readyState){var $n=JSON.parse(Zn.response);filetable(container,$n,function(eo){var to=pelfromfname(eo),ao=to[0],lo=to[1];saveifokdist(ao,lo),Ra(eo)})}},Zn.open('post',baseaddr+'getflist.php',!0),Zn.send(Kn)}catch($n){console.log($n)}}function Ra(Kn){var Zn=new FormData;Zn.append('fname',Kn);try{var $n=window.XMLHttpRequest?new XMLHttpRequest:new activeXObject('Microsoft.XMLHTTP');$n.onreadystatechange=function(){if(4===$n.readyState){if(params.overridepel){var eo=pelfromfname(Kn),to=getpelrange($n.response,eo[0],eo[1]);Un=[],Dl='',ba(to[0],to[1])}Ia($n.response),allq.update(),X(),de()}},$n.open('post',baseaddr+'gettxt.php',!0),$n.send(Zn)}catch(eo){console.log(eo)}}function La(Kn){var Zn=basekjor;'Kjorholt'==Kn&&(Zn=basekjor),'Bamle'==Kn&&(Zn=basebamble);var $n=Kn+picparams.ps+'_'+picparams.pe+'.xml',eo=Zn+Ha(Kn)+endfile,to=vkbeautify.xml(eo);download(to,$n)}function ja(Kn,Zn){var $n=Gi.add(bf,'blank').name('Geology:');$n.onChange(function(){Gi.close()}),$n.__li.setAttribute('class','cr function first');var eo=parseFloat(Gi.domElement.style.width)-1;$n.__li.style.width=eo+'px';var to=Je(Gi),ao=Va('ShowDB',function(){Ni.showdb()});if(ao.setAttribute('class','inguib but2gui'),to.appendChild(ao),ao=Va('Save',function(){params.save()}),ao.setAttribute('class','inguib but2gui'),to.appendChild(ao),Pi=Gi.addFolder('Settings'),Pi.add(params,'loadprev').name(qa.restoresession),Pi.add(params,'savealpha').name(qa.savepicture),Pi.add(params,'author').name(qa.author).onChange(function(){Qe()}).domElement.children[0].setAttribute('maxlength','20'),Pi.add(params,'openfile').name(qa.openfilegeology),Pi.add(params,'ex').name('Expert user').onChange(function(){Gi.close(),Aa(ds)}),Pi.add(params,'clear').name(qa.clearall),Pi.add(params,'overridepel').name('Override pel'),Pi.add(params,'withbg').name(qa.showmwd).onChange(function(){ya()}),Pi.add(params,'showbergart').name(qa.showrocktype).onChange(function(){allp.update(),de()}),Pi.add(params,'forcesync').name('ForcedSync'),null!=Kn&&(Kn==qa.qval&&Ja(),'Select'==Kn)){Oi=Gi.addFolder(qa.setproperties);var lo=sid2txtdate(tn.sid)+' '+tn.author;if(Oi.add(bf,'blank').name(lo),Oi.add(tn,'author').name(qa.author),'T'!=Zn){q22=Oi.add(tn,'comment').name('');var no=q22.domElement.children[0];no.setAttribute('class','myta'),q22.domElement.setAttribute('class','c bigtadiv'),no.placeholder='Comment...',no.onkeyup=function(){Pe(this)},no.onchange=function(){Ue()},q22.__li.setAttribute('class','cr string bigta')}if('T'==Zn&&(Oi.add(ns[Ks],'text').name(qa.text).onChange(function(){console.log('Change'),ie(Ks,ns[Ks].text)}),Oi.add(params,'openfoto').name(qa.takephoto),Oi.add(params,'makelab').name(qa.labtest)),null==Zn||'L'==Zn){Oi.add(tn,'bergart',Ci).name(qa.rocktype).listen().onChange(function(){params.parcolor=Ae(tn.bergart),Gi.updateDisplay()});var to=Oi.addColor(params,'parcolor').name(qa.color).listen().onChange(function(){params.parcolor=Ae(tn.bergart),Gi.updateDisplay()}),oo=to.domElement.children[0];oo.style.width='70%'}return'W'==Zn&&(Oi.add(tn,'dsc',qa.dsc).name(qa.description),Oi.add(tn,'wdrip').name(qa.dripmin),Oi.add(tn,'wleak').name(qa.litmin)),'F'==Zn&&(Oi.add(ns[Ks],'angle',0,360).step(1).name(qa.angle).onChange(function(){oe(Ks,ns[Ks].fall,ns[Ks].angle)}),Oi.add(ns[Ks],'fall',0,90).step(1).name(qa.fall).onChange(function(){oe(Ks,ns[Ks].fall,ns[Ks].angle)})),Oi.add(bf,'blank').name(''),void Oi.add(params,'applyP').name(qa.ap)}Ti=Gi.addFolder(qa.main),Ti.add(bf,'blank').name(''),params.ex&&(M(Ti),M(Ti),Ti.add(params,'resetcam').name(qa.resetcamera),M(Ti))}function Ja(){Ei=Gi.addFolder(qa.qval);var Kn=sid2txtdate(en.lastchange)+' by \''+en.author+'\'';Ei.add(bf,'blank').name('Updated '+Kn);var Zn=Ei.add(en,'ps').name('Pel start').domElement.children[0];Zn.type='tel',Zn.setAttribute('maxlength','5'),Zn=Ei.add(en,'pe').name('Pel end').domElement.children[0],Zn.type='tel',Zn.setAttribute('maxlength','5'),q22=Ei.add(en,'comment').name('');var $n=q22.domElement.children[0];$n.setAttribute('class','myta'),q22.domElement.setAttribute('class','c bigtadiv'),$n.placeholder='Comment...',$n.onkeyup=function(){Pe(this)},20<en.comment.length&&Pe($n),$n.onchange=function(){_e()},q22.__li.setAttribute('class','cr string bigta');var Zn=Je(Ei);Ii.rqd=Va('RQD',function(){params.editRQD()}),Zn.appendChild(Ii.rqd),Ii.Jr=Va('Jr',function(){params.editJr()}),Zn.appendChild(Ii.Jr),Ii.Jw=Va('Jw',function(){params.editJw()}),Zn.appendChild(Ii.Jw),Ii.Jn=Va('Jn',function(){params.editJn()}),Zn.appendChild(Ii.Jn),Ii.Ja=Va('Ja',function(){params.editJa()}),Zn.appendChild(Ii.Ja),Ii.SRF=Va('SRF',function(){params.editSRF()}),Zn.appendChild(Ii.SRF);var eo=Ei.add(bf,'blank').name('');eo.__li.setAttribute('class','cr function qtext'),Ii.Q=eo,Ei.add(en,'bergart',Ci).name(qa.rocktype);var Zn=Je(Ei),to=Va(qa.apply,function(){_e()});to.setAttribute('class','inguib but2gui'),Zn.appendChild(to);var to=Va(qa.removeq,function(){params.removeq()});to.setAttribute('class','inguib but2gui'),Zn.appendChild(to)}function Pa(){Gi=new dat.GUI({autoPlace:!1,width:Math.min(400,fi/2-4)}),container.appendChild(Gi.domElement),Gi.domElement.id='guipos'}function Aa(Kn,Zn){ds=Kn;var $n=Kn;Ol?($n='3d',globgeo='Settings'):globgeo='Geology',Vt(),null==$n&&(Zl=[],chosenp=-2);var eo=Gi.closed;if(container.removeChild(Gi.domElement),Gi.destroy(),Pa(),'3d'==$n){var to=Gi.add(bf,'blank').name('Settings:');to.onChange(function(){Gi.close()}),to.__li.setAttribute('class','cr function first');var ao=parseFloat(Gi.domElement.style.width)-1;return to.__li.style.width=ao+'px',Gi.add(lingeom,'visible').name('Tunnel frame').onChange(function(){de()}),Hn&&(params.showholes&&(pointval.valmin=23,pMaterial.size=12,pointCloud.geometry.drawRange.start=pointval.ar[pointval.valmin-1],pointCloud.geometry.drawRange.count=pointval.ar[pointval.valmax-1]-pointCloud.geometry.drawRange.start,Hn=0),params.opacity=0.3,meshes.children[0].material.opacity=params.opacity,de()),params.showholes&&(Gi.add(pointval,'valmin',1,pointval.ar.length).name('Min').step(1).onChange(function(){pointCloud.geometry.drawRange.start=pointval.ar[pointval.valmin-1],pointCloud.geometry.drawRange.count=pointval.ar[pointval.valmax-1]-pointCloud.geometry.drawRange.start,de()}),Gi.add(pointval,'valmax',1,pointval.ar.length).name('Max').step(1).onChange(function(){pointCloud.geometry.drawRange.count=pointval.ar[pointval.valmax-1]-pointCloud.geometry.drawRange.start,de()}),Gi.add(pMaterial,'size',5,35).name('Point size').step(1).onChange(function(){de()})),Gi.add(params,'opacity',0,1).name('Tunnel opacity').step(0.1).onChange(function(){meshes.children[0].material.opacity=params.opacity,de()}),Gi.add(fscale,'val',0,1).name('Plane size').step(0.02).onChange(function(){for(var no in fallar.children)fallar.children[no].scale.set(fscale.val,fscale.val,1);de()}),params.showholes||Gi.add(params,'showholeask').name('Show holes'),void Gi.updateDisplay()}if(ja($n,Zn),null==Zn&&$a(),Qt(),'Line'==$n&&(ci.setAttribute('class','geobuttonf'),params.linetype='Line',Ti.add(params,'bolt').name(qa.bolt),Ti.add(params,'lineStyle',qa.lineStylear).name(qa.ls),params.ex&&Ti.add(params,'size',0.1,1).name('Size').step(0.1),Ti.add(bf,'blank').name('')),'Water'==$n&&(ui.setAttribute('class','geobuttonf'),params.linetype='Water',Ti.add(params,'wsize',0.1,1).step(0.1).name('Size'),Ti.add(bf,'blank').name('')),'Text'==$n){hi.setAttribute('class','geobuttonf'),params.linetype='Text',q22=Ti.add(params,'text').name(qa.ttp),Ti.add(bf,'blank').name('');var lo=q22.domElement.children[0];lo.setAttribute('class','myta'),lo.placeholder='Text...',eo=!1}'Fall'==$n&&(gi.setAttribute('class','geobuttonf'),params.linetype='Fall',q22=Ti.add(params,'angle',0,360).step(1).name(qa.angle),Ti.add(params,'fall',0,90).step(1).name(qa.fall),Ti.add(bf,'blank').name(''),eo=!1),'Bolt'==$n&&(params.linetype='Bolt',Ti.add(params,'boltlen',1,10).step(0.5).name(qa.len),Ti.add(params,'bolttype',qa.boltlist).name(qa.material),Ti.add(bf,'blank').name('')),'Select'==$n||'Q - value'==$n?(mi.setAttribute('class','geobuttonf'),params.linetype='Select'):Ti.open(),Gi.updateDisplay(),eo?Ne():Ge()}function Ea(){for(var Kn in Bs.children.length=0,oman.ao){var Zn=oman.ao[Kn];Zn.toskip||'B'!=Zn.type||oman.plot(Zn)}}function Ta(){this.oldzero=1,this.oldppu=1,this.oldpw=1,this.getnewy=function(Kn){var $n=_a(Kn);return $n=mr($n),$n},this.getnewx=function(Kn){var Zn=Kn/this.oldpw*ei;return Zn=mr(Zn),Zn}}function Oa(Kn,Zn){for(var $n in Zn)for(var eo=Zn[$n],to=0;to<eo.length;to++)if(eo[to]==Kn)return''+$n;return null}function Ia(Kn){mt.start('Get json');var Zn='object'==typeof Kn?JSON.parse(JSON.stringify(Kn)):JSON.parse(Kn);var $n=Zn.objdata;mt.end('Get json');var eo=new Ta,to=Zn.authors,ao=Zn.sids,lo=Zn.chlist;if(null==lo||isEmpty(lo))for(var no in ao)oman.changelist[no]=no;else for(var no in ao)oman.changelist[no]=lo[no];eo.oldzero=Zn.zeropel,Yn=Zn.author,eo.oldppu=Zn.pelperunit,eo.oldpw=Zn.pw,Xn=Zn.sid,allq.restore(Zn.qval,1);for(var oo=Zn.pval,po=0;po<oo.par.length;po++)for(var no=0;no<oo.par[po].coords.length;no+=2)oo.par[po].coords[no]=eo.getnewx(oo.par[po].coords[no]),oo.par[po].coords[no+1]=eo.getnewy(oo.par[po].coords[no+1],1);allp.restore(oo,1);for(var mo,co=$n.length,uo=6,ho='#000000',go=qy=qz=tmpy=tmpx=-1e3,no=0;no<co;no++){if(mo=new Na,null==ao)mo.sid=Xn;else{var yo=Oa(no,ao);mo.sid=null==yo?Xn:yo}if(null==to)mo.author=Yn;else{var yo=Oa(no,to);mo.author=null==yo?Yn:yo}var fo=$n[no];if(2==fo.length){tmpx=eo.getnewx(fo[0]/qprec),tmpy=eo.getnewy(fo[1]/qprec),mo.addline(go,qy,qz,tmpx,tmpy,qz,uo,ho),go=eo.getnewx(fo[0]/qprec),qy=eo.getnewy(fo[1]/qprec),oman.isdublicate(mo),oman.plot(mo),oman.add(mo);continue}if(0==fo[0]){uo=15,ho='#000000',6<fo.length&&('number'==typeof fo[6]&&(uo=fo[6]),'string'==typeof fo[6]&&(ho=fo[6])),8==fo.length&&(ho=fo[7]),go=eo.getnewx(fo[4]/qprec),qy=eo.getnewy(fo[5]/qprec),qz=fo[3],tmpx=eo.getnewx(fo[1]/qprec),tmpy=eo.getnewy(fo[2]/qprec),mo.addline(tmpx,tmpy,qz,go,qy,qz,uo,ho),oman.isdublicate(mo),oman.plot(mo),oman.add(mo);continue}if(1==fo[0]){uo=0.5,3<uo.length&&(uo=fo[3]),tmpx=eo.getnewx(fo[1]/qprec),tmpy=eo.getnewy(fo[2]/qprec),mo.addwater(tmpx,tmpy,10,uo),oman.isdublicate(mo),oman.plot(mo),oman.add(mo);continue}if(2==fo[0]){tmpx=eo.getnewx(fo[1]/qprec),tmpy=eo.getnewy(fo[2]/qprec);var bo=fo[4];'_pho_'==bo.slice(0,5)&&(mo.fall=1,bo=bo.slice(5),console.log(bo)),'_lab_'==bo.slice(0,5)&&(mo.fall=2,bo=bo.slice(5)),mo.addtext(bo,tmpx,tmpy,fo[3],1),oman.isdublicate(mo),oman.plot(mo),oman.add(mo);continue}if(3==fo[0]&&(tmpx=eo.getnewx(fo[1]/qprec),tmpy=eo.getnewy(fo[2]/qprec),mo.addfall(tmpx,tmpy,10,fo[3],fo[4],fo[5]),null!=fo[6]&&(mo.color=[tv(fo[6][0].x,fo[6][0].y,fo[6][0].z),tv(fo[6][1].x,fo[6][1].y,fo[6][1].z),tv(fo[6][2].x,fo[6][2].y,fo[6][2].z)]),oman.isdublicate(mo),oman.plot(mo),oman.add(mo)),4==fo[0]){mo.addbolt(eo.getnewx(fo[1]/qprec),eo.getnewy(fo[2]/qprec),fo[3],eo.getnewx(fo[4]/qprec),eo.getnewy(fo[5]/qprec),fo[6],fo[7]),oman.isdublicate(mo),oman.plot(mo),oman.add(mo);continue}}}function Ba(Kn,Zn,$n){var eo=0.02/Math.abs(jl-Jl);null!=$n&&(eo=$n);var to=Math.abs(parseFloat(Kn)-parseFloat(Zn));return!!(to<eo)}function Ga(Kn,Zn){var eo=Math.abs(parseFloat(Kn)-parseFloat(Zn));return eo}function Na(){this.type='',this.sid=Cl,this.author=params.author,this.id=0,this.skip=0,this.text='',this.xs=0,this.ys=0,this.zs=0,this.xe=0,this.ye=1,this.ze=1,this.size=3,this.color='',this.fall=0,this.angle=0,this.lastmx=-1e3,this.lastmy=-1e3,this.sameas=function(Kn){return this.type==Kn.type&&Ba(this.xs,Kn.xs)&&Ba(this.ys,Kn.ys)},this.addline=function(Kn,Zn,$n,eo,to,ao,lo,no){this.type='L',this.size=lo,this.color=no,this.xs=Kn,this.ys=Zn,this.zs=$n,this.xe=eo,this.ye=to,this.ze=ao},this.addbolt=function(Kn,Zn,$n,eo,to,ao,lo){this.type='B',this.text=lo,this.xs=Kn,this.ys=Zn,this.zs=$n,this.xe=eo,this.ye=to,this.ze=ao},this.addwater=function(Kn,Zn,$n,eo,to,ao,lo,no){this.type='W',this.size=eo,this.xs=Kn,this.ys=Zn,this.zs=$n,null!==to&&(this.text=to),null!==ao&&(this.xe=ao),null!==lo&&(this.fall=lo),null!==no&&(this.angle=no)},this.addfall=function(Kn,Zn,$n,eo,to,ao){this.type='F',this.xs=Kn,this.ys=Zn,this.zs=$n,this.angle=eo,this.fall=to,this.size=null==ao?Ke(Wa(Zn)):ao},this.addtext=function(Kn,Zn,$n,eo){this.type='T',this.text=Kn,this.xs=Zn,this.ys=$n,this.zs=eo}}function _a(Kn){var Zn=parseFloat(2*(pmult*(Kn-parseFloat(El))*Al/$s));return Zn}function Wa(Kn){var Zn=parseFloat(pmult*Kn/(2*(Al/$s))+El);return Zn}function Ua(){var Kn=new Date,Zn=parseInt(Kn.getMonth()+1),$n={date:Kn.getFullYear()+'-'+az(Zn)+'-'+az(Kn.getDate()),author:params.author};return $n}function Ha(Kn){for(var Zn=[],$n=[],eo={pmult:pmult,pelperunit:1/(2*(Al/$s)),zeropel:El,pw:ei,author:params.author,tunnel:Kn},to=new myxml(eo),ao={type:'w',da:Ua(),coords:[0,1],comment:'',dsc:0,drip:'',leak:''},lo={type:'t',da:Ua(),coords:[0,1],comment:'',fall:0},no={type:'f',da:Ua(),coords:[0,1],comment:'',angle:0,fall:0},oo={type:'l',da:Ua(),coords:[0,1],ltype:0,comment:'',bergart:'none',color:'',width:0},po={type:'q',da:Ua(),coords:[0,1],QVal:[],bergart:'none',color:0,comment:''},co=0;co<allq.qar.length;co++){var uo=allq.qar[co],ho=po;ho.da.author=uo.author,ho.da.date=sid2date(uo.lastchange),ho.coords=[uo.ps,uo.pe],ho.QVal=[uo.RQD,uo.Jn,uo.Jr,uo.Ja,uo.Jw,uo.SRF,uo.Q],ho.bergart=uo.bergart,ho.comment=uo.comment,ho.color=Mt(Ae(uo.bergart)),to.parseos(ho)}for(var co=0;co<ns.length;co++)if(!ns[co].skip&&!isinarray($n,co)){var go=Oe(co);if(!isinarray(Zn,go)){var fo,mo=Ee(co),yo=-2<go?1:0;yo&&(Zn.push(go),fo=allp.par[go]);var vo,bo=ns[co];if('L'==mo)if(vo=oo,vo.da.author=bo.author,vo.da.date=sid2date(bo.sid),vo.ltype=bo.color[0],yo)fo.isarea&&(vo.ltype=5),vo.coords=fo.coords,vo.comment=fo.comment,vo.bergart=fo.bergart,vo.color=fo.color,vo.width=fo.width;else{for(var xo=Se(co),wo=0;wo<xo.length;wo++)$n.push(xo[wo]);vo.coords=ke(xo)}'W'==mo&&(vo=ao,vo.da.author=bo.author,vo.da.date=sid2date(bo.sid),vo.coords=[bo.xs,bo.ys],yo&&(fo.comment&&(vo.comment=fo.comment),fo.dsc&&(vo.dsc=fo.dsc),fo.wdrip&&(vo.drip=fo.wdrip),fo.wleak&&(vo.leak=fo.wleak))),'T'==mo&&(vo=lo,vo.da.author=bo.author,vo.da.date=sid2date(bo.sid),vo.coords=[bo.xs,bo.ys],vo.comment=bo.text,vo.fall=bo.fall),'B'==mo&&(vo=lo,vo.da.author=bo.author,vo.da.date=sid2date(bo.sid),vo.coords=[bo.xs,bo.ys],vo.comment='B'),'F'==mo&&(vo=no,vo.da.author=bo.author,vo.da.date=sid2date(bo.sid),vo.coords=[bo.xs,bo.ys],vo.angle=bo.size?bo.angle:360-bo.angle,vo.fall=bo.fall),to.parseos(vo)}}return to.showstrout()}function Xa(Kn,Zn){for(var $n=[],eo=[],to=JSON.parse(JSON.stringify(Kn)),ao=0;ao<to.length;ao++)if(!isinarray(eo,ao)){var lo=params.onlynew&&!Zn?to[ao].sid==Cl:1;1<params.onlynew&&(lo=to[ao].sid==params.onlynew?1:0);var no=1;if(params.onlycurpel&&!Zn&&!ul(Wa(to[ao].ys))){var oo=Se(ao);add2array(eo,oo),no=0}!to[ao].skip&&lo&&no&&$n.push(to[ao])}return $n}function Ya(Kn){var Zn=0;null!=Kn&&(Zn=Kn);var $n=Xa(ns,Zn),eo=new qe;eo.lastchange=oman.changelist[params.onlynew],null==eo.lastchange&&(eo.lastchange=Cl),eo.zeropel=El,eo.pelperunit=Al*pmult,eo.pw=ei,eo.pelstart=jl,eo.pelend=Jl,eo.author=params.author,eo.authors={},eo.sid=Cl,eo.sids={},eo.tunnel=params.tunnel;var to=new Ze;Zn?to.restore(allq,1):to.restore(allq,1,params.onlynew),eo.qval=to;var ao=new Xe;ao.restore(allp,1,params.onlynew&&!Zn),Zn?ao.restore(allp,1):ao.restore(allp,1,params.onlynew),ao.cleanFromQ(),ao.y2pelcoords(),params.onlycurpel&&ao.cleanFromPel(),eo.pval=ao;for(var lo=yprev=cprev=sprev=-1e3,no=0;no<$n.length;no++)$n[no].ys=Wa($n[no].ys),$n[no].ye=Wa($n[no].ye);for(var oo,no=0;no<$n.length;no++){oo=$n[no].author,null==eo.authors[oo]?eo.authors[oo]=[no]:eo.authors[oo].push(no);var po=$n[no].sid;if(null==eo.sids[po]?eo.sids[po]=[no]:eo.sids[po].push(no),'L'==$n[no].type){if(lo==Math.round($n[no].xs*qprec)&&yprev==Math.round($n[no].ys*qprec)&&cprev==$n[no].color&&sprev==$n[no].size){var co=[Math.round($n[no].xe*qprec),Math.round($n[no].ye*qprec)];lo=Math.round($n[no].xe*qprec),yprev=Math.round($n[no].ye*qprec)}else{lo=Math.round($n[no].xe*qprec),yprev=Math.round($n[no].ye*qprec),cprev=$n[no].color,sprev=$n[no].size;var co=[0,Math.round($n[no].xs*qprec),Math.round($n[no].ys*qprec),$n[no].zs,lo,yprev];6!=$n[no].size&&co.push($n[no].size),'#000000'!=$n[no].color&&co.push($n[no].color)}eo.objdata.push(co)}if('W'==$n[no].type){lo=-1e3;var co=[1,$n[no].xs*qprec,$n[no].ys*qprec];0.5!=$n[no].size&&co.push($n[no].size),eo.objdata.push(co)}if('T'==$n[no].type){lo=-1e3;var uo=$n[no].text;1==$n[no].fall&&(uo='_pho_'+uo),2==$n[no].fall&&(uo='_lab_'+uo);var co=[2,$n[no].xs*qprec,$n[no].ys*qprec,$n[no].zs,uo];eo.objdata.push(co)}if('F'==$n[no].type){if(lo=-1e3,''!=$n[no].color)var co=[3,$n[no].xs*qprec,$n[no].ys*qprec,$n[no].angle,$n[no].fall,$n[no].size,$n[no].color];else var co=[3,$n[no].xs*qprec,$n[no].ys*qprec,$n[no].angle,$n[no].fall,$n[no].size];eo.objdata.push(co)}if('B'==$n[no].type){lo=-1e3;var co=[4,$n[no].xs*qprec,$n[no].ys*qprec,$n[no].zs,$n[no].xe*qprec,$n[no].ye*qprec,$n[no].ze,$n[no].text];eo.objdata.push(co)}}var ho=Object.keys(eo.authors).length;if(1==ho){var go=Oa(0,eo.authors);null!=go&&(eo.author=Oa(0,eo.authors)),null==eo.authors}var mo=Object.keys(eo.sids).length;if(1==mo){var go=Oa(0,eo.sids);null!=go&&(eo.sid=Oa(0,eo.sids)),null==eo.sids}for(var yo in eo.chlist={},eo.sids){var oo=oman.changelist[yo];console.log('Element of changelist',yo,oo),null!=oo&&(eo.chlist[yo]=oo)}return console.log('Saved change list',eo.chlist),0==eo.qval.qar.length&&console.log('No Q to save'),0==eo.pval.par.length&&console.log('No Props to save'),0==eo.objdata.length&&console.log('No registrations to save'),0==eo.objdata.length&&0==eo.pval.par.length&&0==eo.qval.qar.length&&(eo=0),eo}function Ka(Kn,Zn){if(Bi=1,renderblock=1,Zn>=Kn.files.length)return ri.value=null,allq.update(),X(),renderblock=0,de(),void(Bi=0);var $n=new FileReader;$n.onload=function(eo){return 1==Kn.files.length&&params.overridepel?(console.log('open one blank file'),openblankimage(eo.target.result),Bi=0,void(renderblock=0)):void(Ia(eo.target.result),console.log('Done reading ',Zn),Ka(ri,Zn+1))},$n.readAsText(Kn.files[Zn])}function $a(){As.visible=!1,ls=yp=zp=-1e3,Ks=-1,Es.visible=!1}function el(Kn,Zn){var eo=180*(Math.atan2(Kn-ns[ns.length-1].xs,Zn-ns[ns.length-1].ys)/Math.PI);eo=Math.round(eo),0>eo&&(eo=360+eo),ws.rotation=Math.round(1e3*(-Math.PI/180*eo))/1e3,params.angle=eo,ns[ns.length-1].angle=eo,Gi.updateDisplay(),oman.updchangelist(ns[ns.length-1].sid)}function sl(Kn,Zn,$n,eo,to,ao){var lo=new THREE.CircleGeometry(eo,32,Math.PI/4,2.12*Math.PI),no=new THREE.Line(lo,new THREE.LineBasicMaterial({color:ao,linewidth:to}));return no.position.set(Kn,Zn,$n),no}function il(Kn,Zn,$n){var to=0;null!=Zn&&(to=Mt(Zn,1));var ao='object'==typeof $n?$n.val:1,lo=new THREE.Object3D,lo=new THREE.TextSprite({textSize:0.25*oi*ao,redrawInterval:1e7,texture:{text:Kn+'',fontFamily:'Arial, Helvetica, sans-serif, Bold',fontWeight:'bold',autoRedraw:!1},material:{color:to,fog:!1}});return 15!=ao&&globtxt.push(lo),lo.position.set(0,0,1),fcp&&(setTimeout(function(){de()},100),fcp=0),lo}function dl(){_e(),je(),Ge()}function ul(Kn){var Zn=picparams.ps,$n=picparams.pe;if(0<pmult){if(Kn>=Zn&&Kn<=$n)return!0;}else if(Kn>=$n&&Kn<=Zn)return!0;return!1}function hl(Kn,Zn,$n){var eo=Zn,to=$n;if($n>Zn){if(Kn>=eo&&Kn<=to)return!0;}else if(Kn>=to&&Kn<=eo)return!0;return!1}var yl=window.getComputedStyle(document.body,null).getPropertyValue('--myyellow'),fl=window.getComputedStyle(document.body,null).getPropertyValue('--myblack'),vl=window.getComputedStyle(document.body,null).getPropertyValue('--mybackground'),wl,Sl;this.getrs=function(){return wl},this.callresultstring=function(Kn){ue(Kn)},this.getrp=function(){return Sl},this.callresultpic=function(Kn){me(Kn)},this.loadlines=function(Kn){Ia(Kn),allq.update(),X(),de()},this.setauthor=function(Kn){params.author=Kn,Gi.updateDisplay()},this.showvederlag=function(){console.log('vederlag to be done')},this.makenovaxml=function(Kn,Zn){console.log('novaxmlto to be done'),Zn},this.getnxml=function(){return'to be xml text'},this.show3d=function(){gt()},this.show2d=function(){yt()};var zl=S.picsizex,Fl=S.picsizey,Dl=S.picadress;Dl='';var Ml=Dl,Vl=S.tung,Ql=S.ling,Cl=getsessionid();newdb=new mydb,newdb.ldb(),picdb=new mypicdb;var Rl=!1;picdb.ldb(function(){6>picdb.files.length&&(picdb.files=picfiles,picdb.sdb());var Kn=picparams.ps,Zn=picparams.pe;android&&va(Kn,Zn,params.tunnel),setTimeout(function(){Rl=!0,va(Kn,Zn,params.tunnel)},100)}),tungeom.Tunnel1=tungeom1.Tunnel1;var Ll=new THREE.MeshBasicMaterial({color:16777215,transparent:!0,opacity:0}),jl=S.pelstart,Jl=S.pelend,Pl=Math.abs(parseInt(jl)-parseInt(Jl)),Al=50;11>Pl&&(Al=100),6>Pl&&(Al=200),Fl=Al*Pl;var El=S.zeropel,Tl=S.picpack,Ol=!1,Il=zl,Bl=Fl;container=condiv();var Gl,Nl=new THREE.Raycaster,_l=new THREE.Vector2,Ul=0,Hl=0,Xl=0,Zl=[],ls=yp=zp=-1e3,ss=yp2d=zp2d=-1e3,is=[],ns=[],ds='Line';oman=new P;var us=function(){return{s:'bevgsave1',l:'bevgsave1'}}(),ms=new function(){this.idx=[],this.type=[],this.remprev=[],this.xl=[],this.yl=[],this.add=function(Kn,Zn,$n){this.idx.push(Kn),this.type.push(Zn),this.remprev.push($n),this.xl.push(0),this.yl.push(0)},this.addMove=function(Kn,Zn,$n,eo,to){this.idx.push(Kn),this.type.push(Zn),this.remprev.push($n),this.xl.push(eo),this.yl.push(to)},this.removelast=function(){this.type.splice(this.type.length-1,1),this.idx.splice(this.idx.length-1,1),this.remprev.splice(this.remprev.length-1,1),this.xl.splice(this.xl.length-1,1),this.yl.splice(this.xl.length-1,1)}},fs,bs,ws,Ms,Vs,Qs=0,Cs=lastmovey=-1e3,Rs=0;Detector.canvas||alert('Browser does not support canvas 3d'),Gl=new THREE.Scene;var js=new THREE.Scene,Js=new THREE.Scene,Ps=Gl,As=new THREE.Object3D,Es=new THREE.Object3D,Ts=new THREE.Object3D,Os=new THREE.Object3D,Is=new THREE.Object3D,Bs=new THREE.Object3D,Gs=new THREE.Object3D,Ns=new THREE.Object3D,_s=new THREE.Object3D,Ws=new THREE.Object3D,Us;fallar=new THREE.Object3D,line3dgroup=new THREE.Object3D,line3dtemp=new THREE.Object3D,Gl.add(Gs),Gl.add(Ns),Gl.add(_s);var Hs=new THREE.Object3D,Xs=new THREE.Object3D,Ys=new THREE.Object3D,Ks=-1;As.visible=!1,Es.visible=!1,pmult=jl<Jl?1:-1;var $s=200,ei=zl/$s,ti=1,li=Fl/$s,si=0,ii=1,oi=1,ri=document.createElement('input');document.body.appendChild(ri),ri.type='file',ri.accept='.txt',ri.multiple=!0,ri.style.display='none',ri.onchange=function(){if(console.log('Start file read'),null==this.files[0])return void console.log('No files chosen');var Kn=this.files[0].name,Zn=pelfromfname(Kn);params.overridepel&&saveifokdist(Zn[0],Zn[1]),('t'==Kn[Kn.length-1]||'T'==Kn[Kn.length-1])&&Ka(this,0)};var di=document.createElement('input');document.body.appendChild(di),di.type='file',di.style.display='none',di.onchange=function(){if(null==this.files[0])return void console.log('No photo chosen');var Kn=this.files[0].name;('g'==Kn[Kn.length-1]||'G'==Kn[Kn.length-1])&&le(this)};var pi=new Image,ci=document.getElementById('linbtn'),ui=document.getElementById('watbtn'),hi=document.getElementById('txtbtn'),gi=document.getElementById('falbtn'),mi=document.getElementById('selbtn'),yi=document.getElementById('undbtn'),fi,bi;F();var vi=new THREE.Vector2(fi,bi),xi=fi/bi,Si=2.5*li*Math.sqrt(2.28/(li/ei)),ki=Si,zi;D();var Di=document.getElementById(h).offsetTop,Mi=document.getElementById(h).offsetLeft;Gl.add(Ts),Gl.add(Hs),Gl.add(Ys),Gl.add(Xs),Gl.add(Is),Gl.add(Bs),Gl.add(Os);var Vi,Qi;wa(Dl,0),function(){var Kn=0.07*oi,Zn=0.14*oi,$n=K(-Kn,-Kn,10,Kn,Kn,10,8*oi,'#000000'),eo=K(Kn,-Kn,10,-Kn,Kn,10,8*oi,'#000000');As.add($n,eo),Gl.add(As);var to=K(-Zn,-Zn,10,Zn,-Zn,10,5*oi,'#000000'),ao=K(Zn,-Zn,10,Zn,Zn,10,5*oi,'#0000ff'),lo=K(Zn,Zn,10,-Zn,Zn,10,5*oi,'#ff0000'),no=K(-Zn,Zn,10,-Zn,-Zn,10,5*oi,'#00ff00');Es.add(to,ao,lo,no),Gl.add(Es)}();var Ci=['none','Hornfels','Svartskifer','Sill','Spr\xF8ytebetong','Special','Weakness','Basalt','Calcite','Granite','Pyrite'],Ri=['#ffffff','#D0D470','#817A85','#EDA155','#877D7B','#ED4AE8','#771111','#000000','#aaffaa','#aa7777','#ff2222'],Pi,Ei,Ti,Oi,Ii={rqd:'',Jn:'',Jr:'',Ja:'',Jw:'',SRF:'',Q:''},Bi=0;(android||iOS)&&setInterval(function(){xt()},3e4),params={ex:!1,restses:1,loadprev:function(){myask(container,qa.unsaved,function(){J(),wt()})},savexml:function(){La(params.tunnel)},forcesync:!1,enrot:!1,linetype:'Line',linemagnet:!0,lineStyle:qa.lineStylear[0],tunnel:picparams.ps>tunborder?'Bamble':'Kjorholt',vederlag:!1,text:'',author:'V',onlynew:!1,onlycurpel:!1,rutenett:!1,size:0.5,wsize:0.5,opacity:0.5,angle:0,fall:45,layer:0,showholes:!1,showholeask:function(){myask(container,'This will take up to 10 seconds calculations.',function(){params.showholefunc()})},showholefunc:function(){params.showholes=!0,''!=strin&&(!android&&(strin=strin2),Ws=makecloud(strin));var Kn=getglobc((jl+Jl)/2),Zn=new THREE.Object3D;Zn.add(Ws),Zn.position.set(-Kn.x,-Kn.y,-Kn.z),my3dgroup.add(Zn),de(),Aa('3d')},move:!1,movestart:!1,color:'#000000',parcolor:'#000000',savealpha:function(){pt(),ia(null,1),de();var Kn=renderer.domElement.toDataURL(),Zn=new Date,$n='';$n=$n+'geo'+Zn.getHours()+'h'+Zn.getMinutes()+'m'+Zn.getSeconds()+'s.png',Pn(Kn,$n),bt(),lsc=1,X()},what2plot:'Geo+Q+Pel',withbg:!0,showbergart:!0,tstval:45,bolt:function(){mi.value='Select',Aa('Bolt')},boltlen:5,bolttype:'Steel',wtxt:'',dsc:'Not given',wleak:0,wdrip:0,save:function(){var Kn='Save all registrations as \n'+params.tunnel+' tunnel?';myask(container,Kn,function(){params.onlynew=!1,disassemble(),Gi.updateDisplay()})},textsave:'',clear:function(){myask(container,qa.unsaved,function(){J()})},load:function(){Ia(params.textsave),de()},go3d:gt,go2d:yt,getflist:function(){Ca()},add5m:function(){fgui.close(),Gi.close(),ft()},resetcam:function(){Gi.updateDisplay(),controls.reset(),controls.target.set(0,0,0),camera.position.set(0,0,ti),$a(),de()},openfile:function(){params.overridepel?myask(container,qa.unsaved,function(){ri.click()}):ri.click()},overridepel:!0,openfoto:function(){di.click()},makelab:function(){ie(Ks,qa.labtest,2),Gi.updateDisplay()},dummy:function(){},apply:function(){_e()},applyP:function(){Ue()},qedit:function(){},editRQD:function(){rqdmenu(en,container,dl)},editJn:function(){jnmenu(en,container,dl)},editJr:function(){jrmenu(en,container,dl)},editJa:function(){jamenu(en,container,dl)},editJw:function(){jwmenu(en,container,dl)},editSRF:function(){srfmenu(en,container,dl)},removeq:function(){myask(container,qa.removeqmes,function(){We()})}},params.author=function(){return localStorage.getItem('lastauthor')?localStorage.getItem('lastauthor'):'none'}(),params.tunnel=gettunnel()?gettunnel():tunlist[0];var Gi=new dat.GUI({autoPlace:!1});Gi.domElement.id='guipos',Gi.close(),container.appendChild(Gi.domElement),Aa('Line'),lasst=params.tunnel,myaddfunc.flip=function(){renderblock=1;var Kn=xt();J();var Zn=picparams.ps;picparams.ps=picparams.pe,picparams.pe=Zn,fgui.updateDisplay(),saveifokdist(picparams.ps,picparams.pe),''==Dl?va(picparams.ps,picparams.pe):ba(picparams.ps,picparams.pe),Kn&&wt(),renderblock=0,de(),Aa('Line'),mi.value='Select',fgui.close(),Gi.close()},myaddfunc.openblank=function(){console.log('Oblank'),fgui.close(),myask(container,qa.unsaved,function(){getbypl(picparams.ps,picparams.pe)})};var Ni={showdb:function(){var Kn=function(){mt.start('Opening files');for(var $n=0,eo=0;eo<newdb.files.length;eo++)newdb.files[eo].ischosen&&!newdb.files[eo].toskip&&$n++;if($n){if(params.overridepel){var to=getchosenpels(newdb),ao=to[0],lo=to[1];picparams.ps=ao,picparams.pe=lo,fgui.updateDisplay(),saveifokdist(picparams.ps,picparams.pe),va(picparams.ps,picparams.pe)}var no=0;renderblock=1;for(var oo,eo=0;eo<newdb.files.length;eo++)oo=newdb.files[eo],oo.ischosen&&!newdb.files[eo].toskip&&(no++,Ia(oo.savedata));X(),allq.update(),renderblock=0,de(),newdb.uncheckall();var po=mt.end('Opening files');Aa('Line'),'debug'==params.author&&L('Files '+po+'ms',1)}};dbtable(container,function(){params.ex?myask3(container,qa.openneworex,qa.opennew,function(){params.overridepel=!0,Kn(),Gi.updateDisplay()},qa.opentoexisting,function(){params.overridepel=!1,Kn()}):(Kn(),Gi.updateDisplay())})},showpicdb:function(){dbpictable(container,_i)},newblank:function(){ba(picparams.ps,picparams.pe)}};picparams.openf=function(){myask(container,qa.unsaved,function(){picdb.makefromfiles(function(){for(var Kn in picdb.sortbytime(),picdb.files)if(!picdb.files[Kn].toskip){picdb.files[Kn].ischosen=1;break}_i(1)})})};var _i=function(Kn){var Zn=getchosenpels(picdb);if(null!=Zn){var $n=Zn[0],eo=Zn[1],to=Zn[2];picparams.ps=$n,picparams.pe=eo,fgui.updateDisplay(),saveifokdist(picparams.ps,picparams.pe),console.log('Chosen are',picparams.ps,picparams.pe),Kn?getbypl(picparams.ps,picparams.pe):va(picparams.ps,picparams.pe,to),Gt(),picdb.uncheckall()}},Wi=Je(fgui),Ui=Va('Start!',function(){myaddfunc.openblank()});Ui.setAttribute('class','inguib but1gui aguibut'),Wi.appendChild(Ui);var Wi=Je(fgui),Ui=Va('Flip pic',function(){myaddfunc.flip()});Ui.setAttribute('class','inguib but2gui'),Wi.appendChild(Ui),Ui=Va('Add 5m',function(){params.add5m()}),Ui.setAttribute('class','inguib but2gui'),Wi.appendChild(Ui);var Wi=Je(fgui),Ui=Va('MWDdb',function(){Ni.showpicdb()});Ui.setAttribute('class','inguib but2gui aguibut'),Wi.appendChild(Ui),Ui=Va('Open geom',function(){picparams.openf()}),Ui.setAttribute('class','inguib but2gui aguibut'),Wi.appendChild(Ui);var Wi=Je(fgui),Ui=Va('Go 2d',function(){params.go2d()});Ui.setAttribute('class','inguib but2gui'),Wi.appendChild(Ui),Ui=Va('Go 3d',function(){params.go3d()}),Ui.setAttribute('class','inguib but2gui'),Wi.appendChild(Ui),fgui.add(params,'tunnel',tunlist).name('Tunnel:').onChange(function(){savetunnel(params.tunnel),Gt()}),fgui.add(params,'vederlag').name(qa.showved).onChange(function(){X(),de()}),fgui.add(params,'rutenett').name(qa.rutenett).onChange(function(){zt(jl,Jl),de()}),G(jl,Jl);var Hi=new THREE.TextureLoader;Hi.crossOrigin='anonymous';var Xi=Hi.load(spcline),Yi=Hi.load(spcline1,function(){Yi.wrapS=Yi.wrapT=THREE.RepeatWrapping,Yi.offset.set(0,0),Yi.repeat.set(1,1)}),Ki=Hi.load(spcline2,function(){Ki.wrapS=Ki.wrapT=THREE.RepeatWrapping,Ki.offset.set(0,0),Ki.repeat.set(1,1)}),$i=new Na,en=new $e,tn=new He;en.getQ(),allq=new Ze,allp=new Xe;var ln=chosenp=-2;ka(jl,Jl,-1);var nn=0,rn=new Hammer(ci);ci.onclick=function(){if(nn)return void(nn=0);var Zn=0,$n=Gi.closed;'Line'==params.linetype&&(Zn=1),Aa('Line'),V(this),Zn&&I(),$n&&Gi.close(),Gi.removeFolder(qa.qval),Gi.removeFolder(qa.setproperties),mi.value='Select'},(iOS||android)&&rn.on('press',function(){ci.click(),nn=1,setTimeout(function(){nn=0},250)}),rn.get('press').set({threshold:100,time:3});var dn=new Hammer(ui);ui.onclick=function(){return nn?void(nn=0):void(Aa('Water'),mi.value='Select',V(this),'debug'==params.author&&ra())},(iOS||android)&&dn.on('press',function(){ui.click(),nn=1,setTimeout(function(){nn=0},250)}),dn.get('press').set({threshold:100,time:3});var cn=new Hammer(hi);hi.onclick=function(){Aa('Text'),mi.value='Select',V(this)},(iOS||android)&&cn.on('press',function(){hi.click(),nn=1,setTimeout(function(){nn=0},250)}),cn.get('press').set({threshold:100,time:3});var un=new Hammer(gi);gi.onclick=function(){return Ol?void Zt():void(Aa('Fall'),mi.value='Select',V(this))},(iOS||android)&&un.on('press',function(){gi.click(),nn=1,setTimeout(function(){nn=0},250)}),un.get('press').set({threshold:100,time:3});var hn=new Hammer(yi);yi.onclick=function(){android&&Fe(),mi.value='Select',Qt()},hn.on('press',function(){android||(Fe(),mi.value='Select',nn=1,setTimeout(function(){nn=0},250))}),hn.get('press').set({threshold:100,time:3});var gn=0,mn=new Hammer(mi);android&&(mi.onclick=function(){gn||yn(1)}),mn.on('press',function(){yn(0),gn=1,setTimeout(function(){gn=0},250)}),mn.get('press').set({threshold:100,time:3});var yn=function(){return'Select'==mi.value?(mi.value='Group',void Aa('Select')):'One'==mi.value?void(mi.value='Group'):'Group'==mi.value?void(mi.value='One'):void 0};Ne();Gl.children.length;document.addEventListener('keydown',function(Kn){switch(Kn.keyCode){case 65:D();break;case 66:break;case 67:break;case 68:}},!1),window.addEventListener('resize',bt,!1),window.addEventListener('orientationchange',bt,!1);var bn=null,xn=lasty=-1e3,wn=firsty=firstz=-1e3,Sn=endy=-1e3,zn=new Hammer(renderer.domElement);Q(zn);de();var Hi=new THREE.TextureLoader;Hi.crossOrigin='anonymous';var Fn=Hi.load(Tl.imdrop),qn=new THREE.SpriteMaterial({map:Fn,color:16777215}),Dn=Hi.load(Tl.fallMap),Mn=Hi.load(Tl.fallMapA180),Vn=Hi.load(Tl.fallMapF0),Qn=Hi.load(imflask),Cn=Hi.load(imphoto),Rn=new THREE.SpriteMaterial({map:Qn}),Ln=new THREE.SpriteMaterial({map:Cn}),jn=1,Pn=function(Kn,Zn){var $n=document.createElement('a');'string'==typeof $n.download?(document.body.appendChild($n),$n.download=Zn,$n.href=Kn,$n.click(),document.body.removeChild($n)):location.replace(uri)};var An=function(Kn,Zn){var $n=new THREE.Vector3().subVectors(Zn,Kn),eo=new THREE.Matrix4;eo.lookAt(Kn,Zn,new THREE.Object3D().up);var to=new THREE.Matrix4;to.set(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),eo.multiply(to);var ao=new THREE.CylinderGeometry(0.1,0.1,$n.multiplyScalar(0.3).length(),48,1),lo=new THREE.Mesh(ao,new THREE.MeshBasicMaterial({color:0}));lo.applyMatrix(eo);var no=new THREE.Vector3().addVectors(Kn,$n.multiplyScalar(0.5));return lo.position.set(no.x,no.y,no.z),lo},En=function(Kn,Zn){var $n,eo,to,ao,lo,no,oo,po,co,uo,ho,go,mo,yo;for(mo=[],oo=Kn.geometry.faceVertexUvs[0],po=Kn.geometry.faces,co=Kn.geometry.vertices,uo=new THREE.Matrix4,ho=new THREE.Matrix4,yo=new THREE.Matrix4,js.updateMatrixWorld(!0),ao=0;ao<oo.length;ao++)if(lo=oo[ao],no=po[ao],dt(lo,Zn)){$n=co[no.a].clone().applyMatrix4(Kn.matrixWorld),eo=co[no.b].clone().applyMatrix4(Kn.matrixWorld),to=co[no.c].clone().applyMatrix4(Kn.matrixWorld),uo.set($n.x,$n.y,$n.z,0,eo.x,eo.y,eo.z,0,to.x,to.y,to.z,0,0,0,0,1),ho.set(lo[0].x,lo[0].y,0,1,lo[1].x,lo[1].y,0,1,lo[2].x,lo[2].y,0,1,0,0,1,0),ho.getInverse(ho),uo.multiplyMatrices(ho,uo),uo.elements=lt(uo),uo.transpose(),go=new THREE.Vector3(Zn.x,Zn.y,1);var fo=go.applyMatrix4(uo);mo.push(fo),mo.push(no.normal)}return mo};check3dbox.onchange=function(){controls.enableRotate=check3dbox.checked,Gi.updateDisplay()},syncfun=function(Zn,$n){var eo=function(){putdbf(Zn),Cl=getsessionid()},to=function(){mt.end('Merging'),newdb.syncall(),eo()},ao=function(no){mt.start('Merging'),syncbtn.textContent='Merge start',newdb.wipeold(function(){newdb.mergewithstring(no,to)})};getver(function(no){var oo=no[0];console.log('localver=',newdb.getsid(),'onlinever',oo);var po=!0;for(var co in newdb.files)po=po&&newdb.files[co].issynced;syncbtn.textContent='Got versions',newdb.getsid()!=oo||!po||params.forcesync?(syncbtn.textContent=newdb.getsid()+' '+oo,getdbf(ao)):(console.log('Version is up to date'),syncbtn.textContent='Version is up to date',null!=$n&&$n())})};getbypl=function(Zn,$n){var eo=normPel(Zn,$n),to=eo[0],ao=eo[1],lo=to,no=ao,oo=newdb.sorted;newdb.sortbypelasc();var po=[],co=JSON.parse(JSON.stringify(newdb.files));for(var uo in co){var ho=co[uo];if(!ho.toskip){var go=normPel(ho.ps,ho.pe);numintersect(to,ao,go[0],go[1])&&(lo=Math.min(lo,to,ao,go[0],go[1]),no=Math.max(no,to,ao,go[0],go[1]),po.push(ho.savedata))}}for(var uo in newdb.sortbytime(),va(lo,no),renderblock=1,po)Ia(po[uo]);X(),allq.update(),renderblock=0,de()};var On,Bn;Gt();var Gn=300,Nn=0,_n,Wn=new THREE.Object3D;Gl.add(Wn);var Un=[],Hn=1,Xn,Yn;cutpels=function(){params.onlycurpel=!0;var Kn=Ya();J(),Ia(Kn),X(),allq.update(),de(),params.onlycurpel=!1},disassemble=function(){var Kn=Ya();console.log('Sids are',Kn.sids);var Zn=[];for(var $n in Kn.sids)Zn.push($n);for(var eo in Zn)params.onlynew=parseInt(Zn[eo]),eo==Zn.length-1?ue(1):ue(1,1);params.onlynew=0,he()},dat.GUI.prototype.removeFolder=function(Kn){var Zn=this.__folders[Kn];Zn&&(Zn.close(),this.__ul.removeChild(Zn.domElement.parentNode),delete this.__folders[Kn],this.onResize())}}