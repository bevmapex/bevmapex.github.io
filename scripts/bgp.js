function bevgeoplot(h,S){function z(){oi=document.getElementById(h).offsetWidth,ri=document.getElementById(h).offsetHeight}function F(Ln){var Pn=Ln.add(bf,'blank').name('').__li;Pn.setAttribute('class','cr function mydum')}function D(){}function M(Ln){Ln.get('tap').set({threshold:1,posThreshold:1,time:1,interval:2}),Ln.get('press').set({threshold:50,time:3}),Ln.get('pan').set({threshold:sensivity,time:4,direction:Hammer.DIRECTION_ALL}),Ln.get('pinch').set({enable:!0})}function V(Ln,Pn){var En=null==Pn?jl:Pn;if(null==Ln)return console.log('Null object!'),null;for(var Tn,On=0;On<En.children.length;On++)if(En.children[On].uuid==Ln){Tn=En.children[On];break}return Tn}function Q(){line3dtemp.children.length=0,line3dgroup.children.length=0,fallar.children.length=0,Ms.visible=!1,Ul=yp=zp=-1e3,hn=-1e3,renderblock=1;for(var Ln=0;Ln<oman.ao.length;Ln++)oman.removefromscene(oman.get(Ln));Yl=[],oman=new C,ga(),allp=new Ge,allq=new We,Va(),allq.update(),renderblock=0,ae()}function C(){this.ao=Yl,this.history=[],this.sid=wl,this.so=null,this.sp=null,this.selidx=null,this.changelist={},this.updchangelist=function(Ln){this.changelist[Ln]=wl},this.select=function(Ln,Pn){this.so=null,this.sp=null,this.selidx=null;var En=be(Ln,Pn);if(En[3]>Math.sqrt(Ws*Ws+_s*_s)/7)return console.log('Nothing selected'),[null,null];var Tn=En[0];return this.selidx=Tn,this.so=this.get(Tn),this.so||console.log('No object selected'),this.sp=allp.par[je(Tn)],this.sp||console.log('No property selected'),Vs.visible=!!this.so,[this.so,this.sp]},this.get=function(Ln){var Pn=this.ao[Ln];return null==Pn?(console.log('No object ',Ln),null):Pn},this.add=function(Ln){this.ao.push(Ln)},this.undo=function(){var Ln=this.history.pop();return Ln?void('add'==Ln[0]&&(this.removefromscene(Ln[1]),this.history.pop()),'remove'==Ln[0]&&(this.plot(Ln[1]),this.history.pop()),'removeSequence'==Ln[0]&&(this.plot(Ln[1]),this.history.pop(),'removeSequence'==this.history[this.history.length-1][0]&&this.undo()),'movefrom'==Ln[0]&&this.move(Ln[1],Ln[2],Ln[3]),Va(),ae()):void console.log('No history elements')},this.move=function(Ln,Pn,En){if(null==Ln)return void console.log('Trying to move null object');var Tn=V(Ln.id,'B'==Ln.type?Js:null);if(Tn){var On=Pn-Ln.xs,In=En-Ln.ys;Tn.position.x+=On,Tn.position.y+=In,params.movestart||this.history.push(['movefrom',Ln,Ln.xs,Ln.ys]),Ln.xs=Pn,Ln.ys=En,Vs.visible=!0,Vs.position.set(Pn,En,10),this.updchangelist(Ln.sid)}},this.erasefromhistory=function(Ln){for(var Pn=0;Pn<this.history.length;Pn)this.history[Pn][1].sameas(Ln)?this.history.splice(Pn,1):Pn++},this.removefromscene=function(Ln,Pn){if(1==Ln.skip)return!1;if('L'==Ln.type)return Ln.skip=1,Pn?this.history.push(['removeSequence',Ln]):this.history.push(['remove',Ln]),renderblock||this.updchangelist(Ln.sid),!0;var En=V(Ln.id,'B'==Ln.type?Js:null);return null==En?(console.log('No such object on scene',Ln),!1):('B'==Ln.type?Js.remove(En):jl.remove(En),this.history.push(['remove',Ln]),ae(),Ln.skip=1,renderblock||this.updchangelist(Ln.sid),!0)},this.isdublicate=function(Ln){for(var En,Pn=0;Pn<this.ao.length;Pn++)En=this.get(Pn),En.sameas(Ln)&&(this.removefromscene(En),this.erasefromhistory(Ln))},this.plot=function(Ln){if('L'==Ln.type)return Ln.skip=0,void this.history.push(['add',Ln]);var Pn;'W'==Ln.type&&(Pn=H(Ln.xs,Ln.ys,Ln.zs,Ln.size)),'F'==Ln.type&&(Pn=ee(Ln.xs,Ln.ys,Ln.zs,Ln.angle,Ln.fall,Ln.size),''!=Ln.color&&Bt(Ln.color)),'T'==Ln.type&&(Pn=X(Ln.text,Ln.xs,Ln.ys,Ln.zs,1- -Ln.fall)),'B'==Ln.type&&(Pn=O(Ln.xs,Ln.ys,Ln.zs,Ln.xe,Ln.ye,Ln.ze),us=[Pn,Ln],Js.add(Pn));Pn&&(Pn.name=Yl.length,Ln.id=Pn.uuid,Ln.skip=0,this.history.push(['add',Ln]),'B'!=Ln.type&&jl.add(Pn),ae())}}function R(Ln){!0==controls.enableRotate||((!params.move||'Line'==params.linetype)&&(cn=Ln.center.x-ci,lasty=Ln.center.y-pi),Ll.x=2*((Ln.center.x-ci)/oi)-1,Ll.y=2*-((Ln.center.y-pi)/ri)+1,Ql?J():L())}function J(){fcp=1,Al.setFromCamera(Ll,camera);var Ln=Al.intersectObjects(meshes.children);if(0<Ln.length){var Pn=new Aa;Pn.sid=wl;var En=mr(Ul),Tn=mr(yp),On=mr(zp),In=mr(Hl),Bn=mr(yp2d),Gn=mr(Ln[0].point.x),Nn=mr(Ln[0].point.y),_n=mr(Ln[0].point.z),Wn=mr(2*(Ln[0].uv.x-0.5)*_s),Un=mr(2*(Ln[0].uv.y-0.5)*Ws);if(-1e3<Ul){var Hn=params.lineStyle==qa.lineStylear[0]?0:params.lineStyle==qa.lineStylear[1]?1:params.lineStyle==qa.lineStylear[2]?2:3,Xn=Hn+params.color,Yn=_(En,Tn,On,Gn,Nn,_n,Math.round(40*params.size),params.color);if(2==Ln.length){var Kn=mr(2*(Ln[1].uv.x-0.5)*_s),Zn=mr(2*(Ln[1].uv.y-0.5)*Ws),$n={xs:Kn,ys:Zn,v:new THREE.Vector3(Ln[1].point.x,Ln[1].point.y,Ln[1].point.z)};linez.push($n)}var $n={xs:In,ys:Bn,v:new THREE.Vector3(En,Tn,On)};linez.push($n),line3dtemp.add(Yn)}Ul=Gn,yp=Nn,zp=_n,Hl=Wn,yp2d=Un,zp2d=_n}ae()}function A(Ln){return Math.min(_s,Math.max(Ln,-_s))}function L(){fcp=1,Al.setFromCamera(Ll,camera);var Ln=Al.intersectObjects(Xl);if(0<Ln.length){var Pn=new Aa;Pn.sid=wl;var En=mr(Ul),Tn=mr(yp),On=mr(zp),In=mr(Ln[0].point.x),Bn=mr(Ln[0].point.y),Gn=mr(Ln[0].point.z);if(!Ql&&!params.move&&In<-_s&&'Select'==params.linetype)return Le(Bn),Pe(),void ae();if('Line'==params.linetype){if(En=A(En),In=A(In),-1e3<Ul){Ms.visible=!0,Ms.position.set(In,Bn,10);var Nn=params.lineStyle==qa.lineStylear[0]?0:params.lineStyle==qa.lineStylear[1]?1:params.lineStyle==qa.lineStylear[2]?2:3,_n=Nn+params.color,Wn=_(En,Tn,On,In,Bn,Gn+params.layer+1,Math.round(30*params.size),params.color);Wn.name=Yl.length,Pn.addline(En,Tn,On,In,Bn,Gn+params.layer+1,Math.round(30*params.size),_n),oman.plot(Pn),oman.add(Pn),Cs.add(Wn),hn=In,endy=Bn}else un=In,firsty=Bn,firstz=Gn;Ms.visible=!0,Ms.position.set(In,Bn,10),Ul=In,yp=Bn,zp=Gn+params.layer+1}if('Bolt'==params.linetype&&In>=-_s&&In<=_s)if(!Tl)Pn.addbolt(In,Bn,Gn+7,In,Bn,Gn+7,params.bolttype),oman.plot(Pn),oman.add(Pn);else{G(In,Bn,Gn+7);var Un=oman.get(Yl.length-1);Un.xe=es.vertices[1].x,Un.ye=es.vertices[1].y,Un.ze=es.vertices[1].z}if('Fall'==params.linetype&&In>=-_s&&In<=_s&&(Ol?0!=params.fall&&_a(In,Bn,Gn+7):(Pn.addfall(In,Bn,Gn+7,params.angle,params.fall,Sl<zl),oman.plot(Pn),oman.add(Pn))),'Water'==params.linetype&&In>=-_s&&In<=_s&&(Pn.addwater(In,Bn,Gn+7,Math.round(10*params.wsize)/10),oman.plot(Pn),oman.add(Pn)),'Text'==params.linetype&&In>=-_s&&In<=_s&&''!=params.text&&(Pn.addtext(params.text,In,Bn,Gn+params.layer+1),oman.plot(Pn),oman.add(Pn)),'Select'==params.linetype&&In>=-_s&&In<=_s)if(!params.move){oman.select(In,Bn);var Hn=be(In,Bn);if(Hn[3]>Math.sqrt(Ws*Ws+_s*_s)/7)return;Vs.visible=!0,Vs.position.set(Hn[1],Hn[2],10),Bs=Hn[0],Je(Bs)}else if(oman.so){var Xn=In-0.1*_s/camera.zoom,Yn=Bn+0.1*Ws/camera.zoom;oman.move(oman.get(Bs),Xn,Yn)}}else'Select'==params.linetype?params.move&&de():(Na(),Vs.visible=!1);ae()}function P(){if(-1e3<hn){var Ln=new Aa;Ln.sid=wl;var Pn=params.lineStyle==qa.lineStylear[0]?0:params.lineStyle==qa.lineStylear[1]?1:params.lineStyle==qa.lineStylear[2]?2:3;if(0<Pn)return void(hn=endy=un=firsty=firstz=-1e3);var En=Pn+params.color;Ln.addline(hn,endy,firstz+params.layer+1,un,firsty,firstz+params.layer+1,Math.round(30*params.size),En),oman.plot(Ln),oman.add(Ln),hn=endy=un=firsty=firstz=-1e3,Va(),ae()}}function E(Ln,Pn,En){jl.remove(js);var Tn=6,On=0.1*Xs;js=new THREE.Object3D;var In=-Ws,Bn=Ws,Gn=_(1.13*_s,In,0,1.13*_s,Bn,0,10,$a);js.add(Gn);var Nn={val:15},_n=X(Ln,1.13*_s+0.11*_s,In+On,0,0,$a);js.add(_n);var Wn=_(1.13*_s,In,0,1.067*_s,In,0,Tn,$a);js.add(Wn);var Un=_(1.13*-_s,In,10,1.067*-_s,In,10,Tn,$a);js.add(Un);var Hn=X(Pn,1.13*_s+0.11*_s,Bn-On,0,0,$a);js.add(Hn);var Xn=_(1.13*_s,Bn,0,1.067*_s,Bn,0,Tn,$a),Yn=_(1.13*-_s,Bn,10,1.067*-_s,Bn,10,Tn,$a);js.add(Xn),js.add(Yn);for(var Kn=1;Kn<pmult*(Pn-Ln)/5;++Kn){var Zn=-Ws+5*(pmult*Kn*(Bn-In))/(Pn-Ln),$n=_(1.13*_s,Zn,0,1.067*_s,Zn,0,Tn,$a),eo=_(1.13*-_s,Zn,10,1.067*-_s,Zn,10,Tn,$a),to=5*pmult*Kn+parseInt(Ln),ao=X(to,1.13*_s+0.11*_s,Zn,0,0,$a);js.add($n),js.add(ao),js.add(eo)}var lo=normPel(Ln,Pn);if(100<lo[1]-lo[0])for(var Kn=lo[0]-1;Kn<=lo[1];Kn++)if(0==Kn%100){fcp=1;var no=X(Kn,4*_s,La(Kn),Nn,0,$a);js.add(no),fcp=0}if(null!=En){js.position.set(0,En,0)}jl.add(js)}function O(Ln,Pn,En,Tn,On,In){var Bn=new THREE.Object3D,Gn=0.07,Nn=_(Ln+Gn,Pn+Gn,En,Ln-Gn,Pn-Gn,En-0.01,2,'#000000'),_n=_(Ln-Gn,Pn+Gn,En,Ln+Gn,Pn-Gn,En-0.01,2,'#000000'),Wn=Wa(Ln,Pn,En,2*(Gn/Math.sqrt(2)),2,'#000000');return ms=B(Ln,Pn,En,Tn,On,In,1,'#000000'),Bn.add(Nn),Bn.add(_n),Bn.add(Wn),Bn.add(ms),Bn}function I(){return 1/2e3}function B(Ln,Pn,En,Tn,On,In,Bn,Gn){es=new THREE.Geometry,as=new THREE.Vector3(Ln,Pn,En),es.vertices.push(as),es.vertices.push(new THREE.Vector3(Tn,On,In));return N([Ln,Pn,En,Tn,On,In],10,Gn)}function G(Ln,Pn,En){var Tn=(as.x-Ln)*(as.x-Ln)+(as.y-Pn)*(as.y-Pn),On=2*(Dl/Ns),In=params.boltlen*Math.sin(Math.PI/24);if(Tn=Math.sqrt(Tn)/On,Tn<In)us[0].remove(ms),ms=B(as.x,as.y,as.z,Ln,Pn,En,1,'#000000'),us[0].add(ms),us[1].xe=Ln,us[1].ye=Pn,us[1].ze=En;else{var Gn,Nn;Gn=as.x+(Ln-as.x)/Tn*In,Nn=as.y+(Pn-as.y)/Tn*In,us[0].remove(ms),ms=B(as.x,as.y,as.z,Gn,Nn,En,1,'#000000'),us[0].add(ms),us[1].xe=Gn,us[1].ye=Nn,us[1].ze=En}}function N(Ln,Pn,En,Tn){if(0!=Ln.length){var On=new THREE.LineGeometry;On.setPositions(Ln);var In=En+'',Bn=0;if(7<In.length&&(Bn=In[0],In=In.slice(1,8)),0<Bn){var Gn=W(Ln,Pn,En,Tn);return Gn}var Nn=Math.abs(Pn),_n=Ql?5:3,Wn=new THREE.LineMaterial({color:new THREE.Color(In),linewidth:Nn/3,dashed:!1}),Un=renderer.getSize();Wn.resolution.set(Un.width,Un.height);var Gn=new THREE.Line2(On,Wn);return null==Tn&&Rs.add(Gn),Gn}}function _(Ln,Pn,En,Tn,On,In,Bn,Gn){var Nn=new Float32Array(6);Nn[0]=Ln,Nn[1]=Pn,Nn[2]=En,Nn[3]=Tn,Nn[4]=On,Nn[5]=In;var _n=N(Nn,Bn,Gn,1);return _n}function W(Ln,Pn,En,Tn){if(0!=Ln.length){var On=Ln.length,In=En+'',Bn=0;7<In.length&&(Bn=In[0],In=In.slice(1,8));for(var Gn=0,Nn=3;Nn<On;Nn+=3)Gn+=Math.sqrt((Ln[Nn]-Ln[Nn-3])*(Ln[Nn]-Ln[Nn-3])+(Ln[Nn+1]-Ln[Nn-2])*(Ln[Nn+1]-Ln[Nn-2]));var _n=new Float32Array(On);iOS&&(_n=new Float32Array(2*On-3));for(var Nn=0;Nn<Ln.length;Nn++)_n[Nn]=Ln[Nn];if(iOS)for(var Un,Nn=0;Nn<On-3;Nn+=3)Un=2*On-3-Nn-3,_n[Un]=Ln[Nn],_n[Un+1]=Ln[Nn+1],_n[Un+2]=Ln[Nn+2];var Hn=new THREE.Color(In),Xn=Math.abs(Pn)*I(),Yn=new MeshLineMaterial({color:Hn,lineWidth:Xn*lsc,useMap:!1,transparent:!!(0>Pn),opacity:0>Pn?0.6:1,resolution:di});if(1==Bn)var Yn=new MeshLineMaterial({color:Hn,lineWidth:Xn*lsc,useMap:!1,useAlphaMap:1,transparent:!0,alphaMap:Oi,resolution:di});if(2==Bn){var Kn=Math.round(1.5*Gn);Kn=1>Kn?1:Kn;var Yn=new MeshLineMaterial({color:Hn,lineWidth:Xn*lsc,useMap:!1,useAlphaMap:1,repeat:new THREE.Vector2(Kn,1),transparent:!0,alphaMap:Ii,resolution:di})}if(3==Bn){var Kn=Math.round(Gn);Hn=new THREE.Color('#aaaaaa'),Kn=1>Kn?1:Kn;var Yn=new MeshLineMaterial({color:Hn,lineWidth:1.5*(Xn*lsc),useMap:!0,map:Bi,useAlphaMap:1,repeat:new THREE.Vector2(Kn,1),transparent:!0,alphaMap:Bi,resolution:di})}var Zn=new MeshLine;Zn.setGeometry(_n);var $n=new THREE.Mesh(Zn.geometry,Yn);return null==Tn&&Rs.add($n),$n}}function U(Ln,Pn){var En=new THREE.Sprite;return En.position.set(Ln,Pn,2),En.scale.set(0.4,0.4,0.4),En}function H(Ln,Pn,En,Tn){var On=new THREE.Sprite(yn);return On.position.set(Ln,Pn,En),On.scale.x=On.scale.y=Tn*Xs,On}function X(Ln,Pn,En,Tn,On,In){var Bn=10,Gn=new THREE.Object3D,Nn=Ua(Ln,In,Tn);if(Nn.position.set(Pn+0.1,En-0.05,Bn/5),Gn.add(Nn),On){Nn.position.set(Pn+0.35,En-0.2,Bn/5);var _n=0.07,Wn=_(-_n,-_n,10,_n,_n,10,Bn/5,'#000000'),Un=_(_n,-_n,10,-_n,_n,10,Bn/5,'#000000');Wn.position.set(Pn,En,0),Un.position.set(Pn,En,0);var Hn=U(Pn+0.35,En+0.12);Hn.visible=!1,Gn.add(Wn),Gn.add(Un),Gn.add(Hn),2==On&&(Hn.material=zn,Hn.visible=!0,console.log('photo added')),3==On&&(Hn.material=Sn,Hn.visible=!0,console.log('labtest added'))}return Gn}function Y(Ln){var Pn=new FileReader;Pn.onloadend=function(En){var Tn=Sl;Re()&&(Tn=Math.round(Pa(Yl[Bs].ys)));var On=new Date,In='';In='pic_'+Tn+'_'+On.getMinutes()+'m'+On.getSeconds()+'s',Fn(En.target.result,In+'.jpg'),Z(Bs,In,1),ji.updateDisplay()},Pn.readAsDataURL(Ln.files[0])}function Z(Ln,Pn,En){var Tn=Yl[Ln];if('T'!=Re(Ln))return void console.log('not T');var On=jl.getObjectByName(Ln),In=On.children[0];In.redrawInterval=1,On.children[0].material.map.text=''+Pn,Tn.text=Pn,oman.updchangelist(Tn.sid),null!=En&&(1==En&&(Tn.fall=1,On.children[3].material=zn),2==En&&(Tn.fall=2,On.children[3].material=Sn),On.children[3].visible=1),ae(),setTimeout(function(){In.redrawInterval=1e8,ae()},1)}function $(Ln,Pn,En){var Tn=Yl[Ln];if('F'!=Re(Ln))return void console.log('not F');var On=Tn.size&&Sl<zl?En:360-En,In=jl.getObjectByName(Ln),Bn=In.children[1].children[0];Bn.redrawInterval=1,0!=Pn&&90!=Pn&&(In.children[1].children[0].material.map.text=''+Pn),In.children[0].material.rotation=Math.round(1e3*(-Math.PI/180*On))/1e3,0==Pn&&(In.children[0].material.map=xn,In.children[1].children[0].material.map.text='',In.children[0].material.rotation=0),90==Pn&&(In.children[0].material.map=bn,In.children[1].children[0].material.map.text=''),0!=Pn&&90!=Pn&&(In.children[0].material.map=fn),Tn.fall=parseInt(Pn),Tn.angle=parseInt(En),oman.updchangelist(Tn.sid),ae(),setTimeout(function(){Bn.redrawInterval=1e8,ae()},50)}function ee(Ln,Pn,En,Tn,On,In){var Bn=In==Sl<zl?Tn:360-Tn,Gn='',Nn=new THREE.Object3D;if(0!=On&&90!=On){ls=new THREE.SpriteMaterial({map:fn,color:16777215,rotation:-Math.PI/180*Bn});var _n=new THREE.Sprite(ls);Gn=On+''}if(0==On)var Wn=new THREE.SpriteMaterial({map:xn,color:16777215}),_n=new THREE.Sprite(Wn);if(90==On){ls=new THREE.SpriteMaterial({map:bn,color:16777215,rotation:-Math.PI/180*Bn});var _n=new THREE.Sprite(ls)}_n.position.set(Ln,Pn,En),_n.scale.x=_n.scale.y=0.4*Xs;var Un=X(Gn,Ln+0.25*Hs,Pn-0.12*Xs,En,0);return Nn.add(_n),Nn.add(Un),Nn}function ae(Ln,Pn){if(!renderblock){if(mt.start('render'),null==Ln&&controls.update(),Ql?renderer.render(Ss,camera):null==Pn?renderer.render(jl,camera):renderer.render(Pn,camera),null==Ln&&(1==rendebug&&console.log('r'),2==rendebug)){var En=ae.caller;console.log(En)}mt.end('render')}}function le(Ln,Pn){var En=Ia();if(!En)return void console.log('Nothing to save');var Tn=JSON.stringify(En),On=getpelrange(Tn,picparams.ps,picparams.pe);params.textsave=Tn,ji.updateDisplay();var In=new Date,Bn='',Gn=getauthorandsid(En);Bn='pel'+On[0]+'_'+On[1]+'\''+params.tunnel+'\''+Gn.author+shortsid(Gn.sid)+'.txt';var Nn={name:Bn,size:Tn.length,content:Tn},_n=elemfromfile(Nn),Wn=function(Yn){dbputreg(Yn,function(){null==Pn&&(newdb.ldb(),allq.update())})};console.log('Attempt to add new file to db',_n);var Un=newdb.comparef(_n);if(Un){console.log('File already exists in db',Un);var Hn=_n.savedata,Xn=Un.savedata;comparesave(Hn,Xn)?console.log('Files are same, not saving'):(console.log('Adding because files are different'),Wn(_n))}else console.log('Adding new file to db',_n),Wn(_n);se(Ln)}function se(){var Pn=Ia(1);if(!Pn)return void console.log('Nothing to save');var En=JSON.stringify(Pn),Tn=getpelrange(En,picparams.ps,picparams.pe);params.textsave=En,ji.updateDisplay();var On=new Date,In='',Bn=getauthorandsid(Pn);In='pel'+Tn[0]+'_'+Tn[1]+'\''+params.tunnel+'\''+Bn.author+shortsid(Bn.sid)+'.txt';({name:In,size:En.length,content:En})}function oe(Ln,Pn){params.withbg||(Qs.visible=!1),tt();var En=new THREE.Scene;En.add(Is),ae(null,En),console.log('start save as image'),re(function(Tn){jl.add(Is),ae(),re(Ln,Tn),Qs.visible=!0,pt(),Va(),ae(),null!=Pn&&(params.what2plot='Geo+Q+Pel')},1)}function re(Ln,Pn){var En,On=window.devicePixelRatio;try{En=renderer.domElement.toDataURL('image/png');var Bn=new Image,Gn='For 3d'==params.what2plot?1:0,Nn='Only texture'==params.what2plot?1:0;Bn.onload=function(){var Wn=document.createElement('canvas');Wn.width=Nn?2*Rl:Cl,Wn.height=Nn?2*Rl:Rl,Wn.width*=On,Wn.height*=On,Wn.visible=0;var Un=Wn.getContext('2d');Un.drawImage(Bn,0,0);var Hn=Un.getImageData(0,0,Wn.width,Wn.height),Xn=Hn.data,Yn=Xn.length,Kn=[];if(null!=Pn&&!Array.isArray(Pn))for(var Zn=0;Zn<Yn;Zn+=4)if(208==Xn[Zn]&&208==Xn[Zn+1]&&208==Xn[Zn+2]);else Kn.push(Zn);if(null!=Pn&&!Array.isArray(Pn))return void Ln(Kn);if(!params.withbg){for(var Zn=0;Zn<Yn;Zn+=4)208==Xn[Zn]&&208==Xn[Zn+1]&&208==Xn[Zn+2]&&(Xn[Zn+3]=0);if(Array.isArray(Pn))for(var Zn=0;Zn<Pn.length;Zn++)Xn[Pn[Zn]+3]=100}console.log('done pic'),Hn.data=Xn,Un.putImageData(Hn,0,0);var $n=document.createElement('canvas');$n.visible=0;var eo=Un.getImageData(Rl,0,Rl+Cl,Rl);$n.width=Rl,$n.height=Cl;var to=$n.getContext('2d');if(to.putImageData(eo,0,0),En=Nn?$n.toDataURL():Wn.toDataURL(),yl=En,console.log('tmp pic saved'),void 0!==Ln)return rl=En,void Ln();if(!Gn){var ao=new Date,lo='';lo=lo+'geo'+ao.getHours()+'h'+ao.getMinutes()+'m'+ao.getSeconds()+'s.png',Fn(En,lo)}},Bn.src=En}catch(Wn){return void console.log(Wn)}}function de(){if(!El){var Ln=Re();Ln&&('L'==Ln?myask(container,'Remove line?',function(){ue(),hn=-1e3,Va(),ae()}):(ue(),Va(),ae()))}}function ue(){if(oman.so){allp.remove(oman.sp);var Ln=[];if(Ln=he(oman.selidx),'Group'==si.value&&1<Ln.length)for(var Pn=0;Pn<Ln.length;Pn++)oman.removefromscene(oman.get(Ln[Pn]),1);else oman.removefromscene(oman.so);Vs.visible=!1,oman.so=null,oman.selidx=null}}function he(Ln){for(var Pn=[Ln],En=Ln-1;0<=En&&1!=Yl[En].skip&&Yl[En].xe==Yl[En+1].xs&&Yl[En].ye==Yl[En+1].ys;En--)Pn.push(En);for(var En=Ln+1;En<Yl.length&&1!=Yl[En].skip&&Yl[En-1].xe==Yl[En].xs&&Yl[En-1].ye==Yl[En].ys;En++)Pn.push(En);return Pn.sort((Tn,On)=>Tn-On),Pn}function ge(Ln){var Pn=[];if(-1==Ln[0])return Pn;for(var Tn,En=0;En<Ln.length;En++)Tn=Ln[En],0==En&&(Pn.push(Yl[Tn].xs),Pn.push(Yl[Tn].ys)),Pn.push(Yl[Tn].xe),Pn.push(Yl[Tn].ye);return Pn}function me(){oman.undo(),Va(),ii.setAttribute('class','geobutton1'),setTimeout(function(){ii.setAttribute('class','geobutton')},200)}function fe(){this.tunnel='',this.zeropel=0,this.pelperunit=1,this.pelstart=0,this.pelend=20,this.qval={},this.pval={},this.pw=_s,this.author='V',this.sid=wl,this.lastchange=0,this.objdata=[]}function be(Ln,Pn){for(var En=Yl.length,Tn=1e3,On=-1,In=-20,Bn=-20,Gn=1,Nn=0;Nn<En;Nn++)if(!Yl[Nn].skip){Gn=1;var _n=Yl[Nn].xs,Wn=Yl[Nn].ys,Un=(Ln-_n)*(Ln-_n)+(Pn-Wn)*(Pn-Wn);if('L'==Yl[Nn].type){var Hn=we(Yl[Nn],Ln,Pn);Un=Hn[0],_n=Hn[2],Wn=Hn[3],(0>Hn[1]||1<Hn[1])&&(Gn=0)}Tn>=Un&&Gn&&(Tn=Un,On=Nn,In=_n,Bn=Wn)}return[On,In,Bn,Math.sqrt(Tn)]}function we(Ln,Pn,En){var Tn=Ln.xs,On=Ln.xe,In=Ln.ys,Bn=Ln.ye,Gn=Math.sqrt((On-Tn)*(On-Tn)+(Bn-In)*(Bn-In)),Wn=[0,1,2,3,4],Hn=((On-Tn)*(Pn-Tn)+(Bn-In)*(En-In))/Gn/Gn,Xn=Tn+Hn*Gn*((On-Tn)/Gn),Yn=In+Hn*Gn*((Bn-In)/Gn),Kn=Math.sqrt((Pn-Tn)*(Pn-Tn)+(En-In)*(En-In)),Zn=Math.sqrt((Pn-On)*(Pn-On)+(En-Bn)*(En-Bn)),$n=Math.sqrt((Pn-Xn)*(Pn-Xn)+(En-Yn)*(En-Yn));return Wn[0]=Math.sqrt((Pn-Xn)*(Pn-Xn)+(En-Yn)*(En-Yn)),ke(Hn)||(Wn[0]=Math.min(Kn,Zn)),Wn[1]=Hn,Wn[2]=Xn,Wn[3]=Yn,Wn[4]=0,0>=(On-Tn)*(En-In)-(Bn-In)*(Pn-Tn)&&(Wn[4]=1),Wn}function ke(Ln){return 0<=Ln&&1>=Ln}function Se(){localStorage.setItem('lastauthor',params.author)}function qe(Ln){return': -1??'==Ln?'':Ln}function De(Ln,Pn,En){Pn.value=Ln+qe(': '+En),'-1??'!=En&&Pn.setAttribute('class','inguib aguibut')}function Me(){De('RQD',Ri.rqd,_i.RQD+_i.RQDc),De('Jn',Ri.Jn,_i.Jn+_i.Jnc),De('Jr',Ri.Jr,_i.Jr+_i.Jrc),De('Ja',Ri.Ja,_i.Ja+_i.Jac),De('Jw',Ri.Jw,_i.Jw+_i.Jwc),De('SRF',Ri.SRF,_i.SRF+_i.SRFc),_i.getQ(),'????'==_i.Q+_i.class?Ri.Q.name('Q = ?'):Ri.Q.name('Q = '+_i.Q+_i.class),ji.updateDisplay()}function Ve(Ln,Pn){var En=Ln.add(bf,'blank').name(Pn).__li;return En.setAttribute('class','cr function myguibut'),null==Pn&&En.removeChild(En.children[0]),En}function Qe(Ln){Ln.style.height='5px',Ln.style.height=Ln.scrollHeight-5+'px'}function Ce(Ln){for(var Pn=0;Pn<xi.length;Pn++)if(Ln==xi[Pn])return ki[Pn]}function Re(Ln){var Pn=0,En=Bs;null!=Ln&&(En=Ln);jl.getObjectByName(En);return null==Yl[En]?Pn:1==Yl[En].skip?Pn:Yl[En].type}function Je(Ln){var Pn=je(Ln);if(-3==Pn)return void console.log('Nothing selected');var En=Re(Ln);chosenp=Pn,-2==chosenp?(Wi=new Be,Wi.type=En,Wi.coords=Gl,Wi.isarea=Ne(Gl)):Wi.restore(allp.par[chosenp]),Da('Select',En),ji.updateDisplay()}function je(Ln){var Pn=Re(Ln);if(!Pn)return console.log('Nothing selected'),-3;if('L'==Pn){var En=he(Ln);Gl=ge(En),0==Gl.length&&console.log('No lines selected')}else Gl=[Yl[Ln].xs,Yl[Ln].ys];return allp.get(Gl)}function Ae(Ln){for(var Pn=normPel(Sl,zl),En=Pn[0];En<Pn[1];En+=5)if(Ln>=En&&Ln<En+5){var Tn=allq.get(En),On=allq.get(En+5);if(-2==Tn&&-2==On)return console.log('No Q near'),[En,En+5];var In=En,Bn=-2==On?Tn:On;In=-2==On?Math.max(allq.qar[Tn].ps,allq.qar[Tn].pe):Math.min(allq.qar[On].ps,allq.qar[On].pe);var Gn=-2==On?5:-5;return[In,In+Gn]}return console.log('No q found'),[Ln,Ln+5*Pn[2]]}function Le(Ln){var Pn=Pa(Ln);if(Ui=allq.get(Pn),-2==Ui){_i=new Ue,_i.getQ();var En=Ae(Pn);_i.ps=En[0],_i.pe=En[1],_i.comment=''}else _i.restore(allq.qar[Ui]);ae(),Kl==qa.qval?(ji.removeFolder(qa.qval),za()):Da(qa.qval),Di.close(),ji.removeFolder(qa.main),ji.removeFolder(qa.setproperties),Vi.open(),Vs.visible=!0,Vs.position.set(1.2*-_s,0.35*La(_i.pe)+0.65*La(_i.ps),10),Me(),ji.updateDisplay()}function Pe(){setTimeout(function(){ji.open()},200)}function Ee(){ji.close()}function Te(){-1<Ui?(_i.lastchange=wl,allq.qar[Ui].restore(_i)):(allq.add(_i),Ui=allq.qar.length-1),oman.updchangelist(_i.sid),allq.update(),Ht(null,1)}function Oe(){allq.remove(Ui),allq.update(),ae(),_i=new Ue,Me()}function Ie(){if(0==Gl.length)return void console.log('No lines selected');if(-1<chosenp){if('undefined'==typeof allp.par[chosenp])return void console.log('No lines selected');allp.par[chosenp].restore(Wi),allp.par[chosenp].author=params.author,allp.par[chosenp].lastchange=wl,'L'==allp.par[chosenp].type&&(allp.par[chosenp].color=wt(Ce(Wi.bergart)))}else Wi.author=params.author,'L'==Wi.type&&(Wi.color=wt(Ce(Wi.bergart))),Wi.sid=wl,allp.add(Wi),chosenp=allp.amtok()-1;oman.sp=allp.par[chosenp],allq.update(),ae()}function Be(){this.author=params.author,this.sid=wl,this.lastchange=wl,this.type='',this.bergart='none',this.ispartofQ=0,this.id='',this.coords=[],this.color=0,this.comment='',this.width=0,this.dsc='Not given',this.wdrip=0,this.wleak=0,this.isarea=!1,this.restore=function(Ln){var Pn=JSON.parse(JSON.stringify(Ln));this.sid=Pn.sid,this.lastchange=null==Pn.lastchange?this.sid:Pn.lastchange,this.type=Pn.type,this.id=Pn.id,this.coords=Pn.coords,this.bergart=Pn.bergart,this.width=Pn.width,this.comment=Pn.comment,this.ispartofQ=Pn.ispartofQ,null!=Pn.author&&(this.author=Pn.author),this.isarea=Pn.isarea,this.color=Pn.color,null!=Pn.dsc&&(this.dsc=Pn.dsc,this.wdrip=Pn.wdrip,this.wleak=Pn.wleak)},this.sameas=function(Ln){if(0==Ln.length)return!1;for(var Pn=0;Pn<Math.min(Ln.length,this.coords.length)&&!(6<Pn);Pn++){if(20<Pn)return console.log('Same',this.coords),!0;if(10<Ln.length){var En=ja(Ln[Pn],this.coords[Pn]);if(!En)return!0}if(!Ja(Ln[Pn],this.coords[Pn]))return!1}return!0},this.showprops=function(){var Ln;return Ln='W'==this.type?this.coords+' wdrip='+this.wdrip+' wleak='+this.wleak:this.bergart+' '+this.coords,Ln}}function Ge(){this.par=[],this.getareas=function(){var Ln=[];for(var Pn in this.par){var En=this.par[Pn];En.isarea&&!En.ispartofQ&&Ln.push(En)}return Ln},this.amtok=function(){for(var Ln=0,Pn=0;Pn<this.par.length;Pn++)this.par[Pn].ispartofQ||Ln++;return Ln},this.add=function(Ln,Pn){var En=new Be;En.restore(Ln),this.par.push(En),null==Pn&&this.update()},this.remove=function(Ln,Pn){if('object'==typeof Ln)for(var En in console.log('Trying to remove',Ln),this.par){var Tn=this.par[En];if(Tn==Ln){this.par.splice(En,1);break}}else-1<Ln&&this.par.splice(Ln,1);null==Pn&&this.update()},this.cleanFromQ=function(){for(var Ln=0;Ln<this.par.length;Ln++)1==this.par[Ln].ispartofQ&&(this.remove(Ln,1),Ln--)},this.y2pelcoords=function(){for(var Ln=0;Ln<this.par.length;Ln++)for(var Pn=0;Pn<this.par[Ln].coords.length;Pn+=2)this.par[Ln].coords[Pn+1]=Pa(this.par[Ln].coords[Pn+1])},this.cleanFromPel=function(){for(var Ln=0;Ln<this.par.length;Ln++)Ya(this.par[Ln].coords[1])||(console.log('Skipping property',this.par[Ln]),this.remove(Ln),Ln--)},this.get=function(Ln){for(var Pn=0;Pn<this.par.length;Pn++)if(this.par[Pn].sameas(Ln))return Pn;return-2},this.restore=function(Ln,Pn,En){var Tn=!1;null!=En&&(Tn=En);for(var In,On=0;On<Ln.par.length;On++)(In=this.ismemberalready(Ln.par[On]),null==Ln.par[On].sid&&(Ln.par[On].sid=jn),null==Ln.par[On].author&&(Ln.par[On].author=An),!(1==Tn&&Ln.par[On].sid<wl))&&(1<Tn&&Ln.par[On].sid!=Tn||(-1<In?this.par[In].restore(Ln.par[On]):this.add(Ln.par[On],Pn)));null==Pn&&(console.log('Update inside restore'),this.update())},this.ismemberalready=function(Ln){for(var Pn=0;Pn<this.par.length;Pn++)if(this.par[Pn].sameas(Ln.coords))return Pn;return-1},this.update=function(){mt.start('updatePinside');var Ln=renderblock;if(renderblock=1,ga(),params.showbergart)for(var Pn=0;Pn<this.par.length;Pn++)if(('L'==this.par[Pn].type||this.par[Pn].ispartofQ)&&(this.par[Pn].isarea&&Ye(this.par[Pn].coords,Ce(this.par[Pn].bergart),this.par[Pn].ispartofQ),''!=this.par[Pn].comment)){var Tn,On,En=this.par[Pn].coords.length;Tn=this.par[Pn].coords[En-2],On=this.par[Pn].coords[En-1];var In=X('comment!',Tn,On,5,1);Is.add(In)}renderblock=Ln,mt.end('updatePinside')}}function Ne(Ln){var Pn=Ln.length;return Pn%2?(console.log('Odd amount of coordinates?'),console.log(Ln),!1):!(8>Pn)&&Ln[0]==Ln[Pn-2]&&Ln[1]==Ln[Pn-1]}function _e(Ln){var Pn=Sl<zl,En=allq.get(Ln);return-1<En&&(Pn=allq.qar[En].ps>allq.qar[En].pe?0:Pn),Sl<tunborder&&(Pn=13730<Ln&&13915>Ln||14350<Ln&&14980>Ln?0:1),17057<Ln&&17068>Ln&&(Pn=1),Pn}function We(){this.qar=[],this.add=function(Ln){var Pn=new Ue;Pn.restore(Ln),this.qar.push(Pn)},this.get=function(Ln){for(var On,Pn=1e3,En=-2,Tn=0;Tn<this.qar.length;Tn++)On=Pn,(this.qar[Tn].pe>Ln&&this.qar[Tn].ps<Ln||this.qar[Tn].ps>Ln&&this.qar[Tn].pe<Ln)&&(Pn=Math.min(Pn,Math.abs(Ln-this.qar[Tn].ps),Math.abs(Ln-this.qar[Tn].pe),Math.abs(Ln-(this.qar[Tn].pe+this.qar[Tn].ps)/2)),On!=Pn&&(En=Tn));return En},this.remove=function(Ln){-1<Ln&&(console.log('Removed Q'),oman.updchangelist(this.qar[Ln].sid),this.qar.splice(Ln,1))},this.removeP=function(Ln){var Pn=this.get(Ln);-1<Pn?this.qar.splice(Pn,1):console.log('No such Q with pel'+Ln)},this.getoverlaps=function(){for(var Ln=[],Pn=0;Pn<this.qar.length;Pn++){for(var En=0,Tn=this.qar[Pn],On=Math.min(Tn.ps,Tn.pe),In=Math.max(Tn.ps,Tn.pe),Bn=Pn+1;Bn<this.qar.length;Bn++){var Gn=this.qar[Bn],Nn=Math.min(Gn.ps,Gn.pe),_n=Math.max(Gn.ps,Gn.pe);if(Nn<=In&&Nn>=On){if(Nn==In)continue;var Wn=[Nn,Math.min(_n,In)];Ln.push(Wn),Tn.Q==Gn.Q&&Tn.comment==Gn.comment&&(Tn.sid>Gn.sid?(console.log('Removing overlap',Gn),this.remove(Bn),Bn--):En=1);continue}if(_n<=In&&_n>=On){if(_n==On)continue;var Wn=[Math.max(Nn,On),_n];Ln.push(Wn),Tn.Q==Gn.Q&&Tn.comment==Gn.comment&&(Tn.sid>Gn.sid?(console.log('Removing overlap',Gn),this.remove(Bn),Bn--):En=1)}}En&&(console.log('Removing i',Tn),this.remove(Pn),Pn--)}return 2<Ln.length&&console.log('Overlaps',Ln),Ln},this.update=function(){mt.start('updateQ'),mt.start('Get Q overlaps'),this.getoverlaps(),mt.end('Get Q overlaps'),ha(),mt.start('Clean Q'),allp.cleanFromQ(),mt.end('Clean Q');for(var Ln=0;Ln<this.qar.length;Ln++)if(ua(this.qar[Ln].ps,this.qar[Ln].pe,this.qar[Ln].getQ(),this.qar[Ln].class,this.qar[Ln].comment),'none'!=this.qar[Ln].bergart){var Pn=new Ge,En=new Be;En.ispartofQ=1;var Tn=La(this.qar[Ln].ps),On=La(this.qar[Ln].pe);En.coords=[-_s,Tn,-_s,On,_s,On,_s,Tn],En.bergart=this.qar[Ln].bergart,En.isarea=!0,Pn.add(En,1),allp.restore(Pn,1)}mt.start('updatePFinal'),allp.update(),mt.end('updatePFinal'),mt.end('updateQ')},this.clear=function(){ha(),this.qar=[]},this.restore=function(Ln,Pn,En){var Tn=!1;null!=En&&(Tn=En);for(var On=0;On<Ln.qar.length;On++)if((null==Ln.qar[On].sid&&(Ln.qar[On].sid=jn),null==Ln.qar[On].author&&(Ln.qar[On].author=An),!(1==Tn&&Ln.qar[On].sid<wl))&&!(1<Tn&&Ln.qar[On].sid!=Tn)){if(params.onlycurpel&&(!Ya(Ln.qar[On].ps)||!Ya(Ln.qar[On].pe))){console.log('Q not in limits'+Ln.qar[On].ps+' '+Ln.qar[On].pe);continue}var In=this.isequal(Ln.qar[On]);-1<In?this.qar[In].restore(Ln.qar[On]):this.add(Ln.qar[On])}null==Pn&&this.update()},this.isequal=function(Ln){for(var Pn=0;Pn<this.qar.length;Pn++)if(this.qar[Pn].ps==Ln.ps&&this.qar[Pn].pe==Ln.pe)return Pn;return-1}}function Ue(){this.author=params.author,this.sid=wl,this.lastchange=wl,this.ps=Sl,this.pe=zl,this.RQDc='??',this.Jrc='??',this.Jwc='??',this.Jnc='??',this.Jac='??',this.SRFc='??',this.Jnmult=1,this.RQD=-1,this.Jr=-1,this.Jw=-1,this.Jn=-1,this.Ja=-1,this.SRF=-1,this.Q='??',this.class='??',this.comment='',this.bergart='none',this.getQ=function(){return 0>this.RQD||0>this.Jr||0>this.Jr||0>this.Jn||0>this.Ja||0>this.SRF?this.Q:(this.Q=Math.round(1e3*(Math.max(this.RQD,10)*this.Jr*this.Jw/(this.Jn*this.Ja*this.SRF)))/1e3,0.01<this.Q&&(this.Q=Math.round(100*this.Q)/100),1<this.Q&&(this.Q=Math.round(10*this.Q)/10),this.class='G',0.01<this.Q&&(this.class='F'),0.1<this.Q&&(this.class='E'),1<this.Q&&(this.class='D'),4<this.Q&&(this.class='C'),10<this.Q&&(this.class='A/B'),this.Q)},this.restore=function(Ln){this.ps=Ln.ps,this.pe=Ln.pe,this.comment=Ln.comment,this.bergart=Ln.bergart,this.RQDc=Ln.RQDc,this.Jrc=Ln.Jrc,this.Jwc=Ln.Jwc,this.Jnc=Ln.Jnc,this.Jac=Ln.Jac,this.SRFc=Ln.SRFc,this.Jnmultc=1,this.RQD=Ln.RQD,this.Jr=Ln.Jr,this.Jw=Ln.Jw,this.Jn=Ln.Jn,this.Ja=Ln.Ja,this.SRF=Ln.SRF,null!=Ln.author&&(this.author=Ln.author),null!=Ln.sid&&(this.sid=Ln.sid),this.lastchange=null==Ln.lastchange?this.sid:Ln.lastchange,this.getQ()}}function Ye(Ln,Pn,En){for(var In,Tn=[],On=0;On<Ln.length;On+=2)In=new THREE.Vector3(Ln[On],Ln[On+1],1-0.02*En),Tn.push(In);var Gn,Nn,_n=new THREE.Geometry,Wn=new THREE.MeshBasicMaterial({color:Pn,transparent:!0,opacity:0.7});Wn.side=THREE.DoubleSide,_n.vertices=Tn,Gn=THREE.ShapeUtils.triangulateShape(Tn,[]);for(var On=0;On<Gn.length;On++)_n.faces.push(new THREE.Face3(Gn[On][0],Gn[On][1],Gn[On][2]));Nn=new THREE.Mesh(_n,Wn),Is.add(Nn),ae()}function Ke(Ln){for(var Pn=Ln.elements,En=0;En<Pn.length;En++)Pn[En]=mr(Pn[En]);return Pn}function $e(Ln,Pn){var En={x:(Ln/_s+1)/2,y:(Pn/Ws+1)/2};return En}function et(Ln,Pn){var En=Pn.x-Ln[0].x,Tn=Pn.y-Ln[0].y,On=0<(Ln[1].x-Ln[0].x)*Tn-(Ln[1].y-Ln[0].y)*En;return 0<(Ln[2].x-Ln[0].x)*Tn-(Ln[2].y-Ln[0].y)*En!=On&&0<(Ln[2].x-Ln[1].x)*(Pn.y-Ln[1].y)-(Ln[2].y-Ln[1].y)*(Pn.x-Ln[1].x)==On}function tt(){controls.reset(),controls.target.set(0,0,0),camera.position.set(0,0,mi),cameraFix.position.set(0,0,mi),Na(),lt(),Va()}function lt(){var Ln=window.devicePixelRatio;Cl=ul,Rl=hl,camera.left=-_s,camera.right=_s,camera.top=Ws+Us,camera.bottom=-Ws+Us,cameraFix.left=-_s,cameraFix.right=_s,cameraFix.top=Ws+Us,cameraFix.bottom=-Ws+Us,'Geo+Q+Pel'==params.what2plot&&(camera.left=-_s-1.2,camera.right=_s+1.2,Cl*=1.3,lsc=0.5),Cl/=Ln,Rl/=Ln;'For 3d'!=params.what2plot&&4096<Rl&&(Cl=4096*Cl/Rl,Rl=4096);var En=Cl,Tn=Rl;'For 3d'==params.what2plot,renderer.setSize(En,Tn),di=new THREE.Vector2(En,Tn),'For 3d'==params.what2plot&&(lsc=Math.min(0.5,5e3/Tn));var On=android||iOS?4:1;buftext=new THREE.WebGLRenderTarget(4096/On,16384/On,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat}),camera.updateProjectionMatrix(),cameraFix.updateProjectionMatrix()}function it(){Ql||(sensivity=1,params.what2plot='For 3d',bt(Sl,zl,1),tt(),Ma(),Ql=!0,renderer.render(jl,cameraFix,buftext),pt(),Vt(),camera.position.set(0,0,1e3),params.what2plot='Geo+Q+Pel',controls.enableRotate=!0,ae(),check3dbox.style.display='',check3dbox.checked=!0,fgui.close(),Da('3d'))}function rt(){if(Ql){for(sensivity=5;0<Ss.children.length;)Ss.remove(Ss.children[0]);buftext.dispose(),jl=Ds,params.resetcam(),controls.enableRotate=!1,Ql=!1,camera.position.set(0,0,mi),lsc=1,pt(),Va(),Ma(),bt(Sl,zl),setTimeout(function(){ae()},50),si.value='Select',Da('Line'),check3dbox.style.display='none',fgui.close(),ji.close()}}function dt(){zl+=5*pmult,Sl-=5*pmult,Fl=Math.abs(parseInt(Sl)-parseInt(zl)),hl=Dl*Fl,Rl=hl,Ws=hl/Ns,E(Sl,zl,Us),bt(Sl,zl),ua(Sl,zl,-1),ca(gl,La(zl-2.5*pmult)),ca(gl,La(Sl+2.5*pmult)),ae()}function pt(){z(),di=new THREE.Vector2(oi,ri),ui=oi/ri,camera.left=-hi*ui/2,camera.right=hi*ui/2,camera.top=gi/2,camera.bottom=-gi/2,camera.updateProjectionMatrix(),renderer.setSize(oi,ri),ae()}function ht(){if(Ji)return!1;for(var Ln=0,Pn=0;Pn<Yl.length;Pn++)1!=Yl[0].skip&&(Ln=1);if(allq.qar.length&&(Ln=1),!Ln)return!1;var En=new Date().getTime(),Tn=Ia(1),On=JSON.stringify(Tn);localStorage.setItem(Zl.s,On);var In=new Date().getTime()-En;return console.log('dT = '+In),!0}function gt(){if(localStorage.getItem(Zl.l)){var Ln=localStorage.getItem(Zl.l),Pn=JSON.parse(Ln);console.log('Sid set to',Pn.sid),Ra(Pn),allq.update(),Va(),ae(),params.restses=0,Da('Line')}}function bt(Ln,Pn,En){if(jl.remove(As),!!params.rutenett){As=new THREE.Object3D;var Tn=normPel(Ln,Pn),On=Tn[0],In=Tn[1],Bn=-4;null!=En&&(Bn=-0.5);for(var Hn,Un=On;Un<=In;Un++){Hn=[],Hn.push(-_s,La(Un),1,1.13*_s,La(Un),1);var Xn=N(Hn,Bn,'0#000000');As.add(Xn)}jl.add(As)}}function vt(){if(params.vederlag){var Ln=tungeom[params.tunnel].Width,Pn=[];for(var En in Ln){var Tn=Ln[En][1],On=Ln[En][3],In=Ln[En][5],Bn=In-Tn;Pn.push([Ln[En][0],2*((Ln[En][2]-Tn)/Bn)-1,2*((Ln[En][3]-Tn)/Bn)-1,2*((Ln[En][4]-Tn)/Bn)-1])}for(var Xn,Yn,Kn,Zn,Bn,Gn=normPel(Sl,zl),Nn=Gn[0],_n=Gn[1],Wn=[],Un=[],Hn=[],$n=1,En=Nn;En<_n;En++){if(Bn=Math.max(En,Pn[0][0]),Bn=En,Xn=xt(Bn,Pn),Kn=La(Bn),Yn=xt(Bn+pmult,Pn),Zn=La(Bn+1),!Xn||!Yn){console.log('No vederlag data for pel=',En),$n=0;break}Wn.push(Xn[0]),Wn.push(Kn),Wn.push(1),Un.push(Xn[1]),Un.push(Kn),Un.push(1),Hn.push(Xn[2]),Hn.push(Kn),Hn.push(1)}$n&&(Wn.push(Yn[0]),Wn.push(Zn),Wn.push(1),Un.push(Yn[1]),Un.push(Zn),Un.push(1),Hn.push(Yn[2]),Hn.push(Zn),Hn.push(1)),N(Wn,-4,'0#000000'),N(Un,-4,'0#000000'),N(Hn,-4,'0#000000')}}function xt(Ln,Pn){for(var En=Pn.length,Tn=xct=xrt=0,On=0,In=0,Bn=0;Bn<En-1;Bn++)if(Ln>=Pn[Bn][0]&&Ln<Pn[Bn+1][0]||Ln<=Pn[Bn][0]&&Ln>Pn[Bn+1][0]){var Gn=Pn[Bn+1][0]-Pn[Bn][0];0==Gn?On=[Pn[Bn][1]*_s,Pn[Bn][2]*_s,Pn[Bn][3]*_s]:(In=(Ln-Pn[Bn][0])/(Pn[Bn+1][0]-Pn[Bn][0]),Tn=Pn[Bn][1]+In*(Pn[Bn+1][1]-Pn[Bn][1]),xct=Pn[Bn][2]+In*(Pn[Bn+1][2]-Pn[Bn][2]),xrt=Pn[Bn][3]+In*(Pn[Bn+1][3]-Pn[Bn][3]),On=[Tn*_s,xct*_s,xrt*_s])}return On?On:Ln<Pn[0][0]?[Pn[0][1]*_s,Pn[0][2]*_s,Pn[0][3]*_s]:[Pn[En-1][1]*_s,Pn[En-1][2]*_s,Pn[En-1][3]*_s]}function wt(Ln,Pn){var En=Ln;return 7==En.length?(En=null==Pn?'0x'+En[5]+En[6]+En[3]+En[4]+En[1]+En[2]:'0x'+En[1]+En[2]+En[3]+En[4]+En[5]+En[6],parseInt(En)):0}function kt(){Ql?($s.style.display='none',ei.style.display='none',ti.style.display='none',si.style.display='none',ii.style.display='none'):($s.style.display='',ei.style.display='',ti.style.display='',si.style.display='',ii.style.display='')}function St(){$s.setAttribute('class','geobutton'),ei.setAttribute('class','geobutton'),ti.setAttribute('class','geobutton'),li.setAttribute('class','geobutton'),si.setAttribute('class','geobutton')}function Ft(Ln){var Pn=[],En=Ln.length;for(var Tn in Pn.push(At(Ln[0][0]+1,Ln)),Ln)Ln[Tn][0]>Ln[0][0]+1&&Ln[Tn][0]<Ln[En-1][0]-1&&Pn.push(At(Ln[Tn][0],Ln));return Pn.push(At(Ln[En-1][0]-1,Ln)),Pn}function Dt(Ln){var Pn=tungeom[Ln].TunProfile,En=parse3dmod(Pn),Tn=Ft(En),On=Ct(En);for(var In in Tn)On.add(Mt(Tn[In]));var Bn=(En[0][0]+En[En.length-1][0])/2,Gn=-La(Bn);return[En,On]}function Mt(Ln){var Pn=[];for(var En in Ln.v)Pn.push(Ln.v[En].x),Pn.push(Ln.v[En].y),Pn.push(Ln.v[En].z);var Tn=new THREE.Object3D,On=N(Pn,10,'0#000000');return Tn.add(On),Tn}function Vt(){p2y=La;var Ln=Vn,Pn=Ln[0];lingeom=new THREE.Object3D,lingeom.add(Vn[1]),lingeom.add(Cn);var En=(Pn[0][0]+Pn[Pn.length-1][0])/2,Tn=La(En),On=getglobc((Sl+zl)/2);lingeom.position.set(-On.x,-On.y,-On.z);var In=jt(Pn),Bn=In[0];for(var Gn in partlingeom=In[1],pmat=new THREE.MeshBasicMaterial({map:buftext.texture,transparent:!0,opacity:0.5,depthTest:!0}),pmat.side=THREE.DoubleSide,my3dgroup=new THREE.Object3D,meshes=new THREE.Object3D,Bn){var Nn=new THREE.Mesh(Bn[Gn][2],pmat);Nn.castShadow=!1,Nn.receiveShadow=!1,meshes.add(Nn)}meshes.position.set(-On.x,-On.y,-On.z),my3dgroup.add(meshes),Ss=new THREE.Scene,Ds=jl;var _n=new THREE.Object3D;params.showholes&&(_n.add(Ps),_n.position.set(-On.x,-On.y,-On.z),my3dgroup.add(_n));var Wn=new THREE.Object3D;my3dgroup.add(Wn),Bn[0][2].computeBoundingSphere();var Un=Bn[0][2].boundingSphere.center,Hn=new THREE.Quaternion;Hn.setFromUnitVectors(new THREE.Vector3(0,0,1),new THREE.Vector3(0,1,0));for(var Xn,Yn,Kn=0;Kn<oman.ao.length;Kn++)if('B'==oman.ao[Kn].type){var Zn=$e(oman.get(Kn).xs,oman.get(Kn).ys),$n=Pa(oman.get(Kn).ys),eo=new THREE.Vector2(Zn.x,Zn.y);for(var to in Bn)if(numintersect(Bn[to][0],Bn[to][1],$n,$n)){Xn=Dn(meshes.children[to],eo);break}var ao=$e(oman.get(Kn).xe,oman.get(Kn).ye),$n=Pa(oman.get(Kn).ye),eo=new THREE.Vector2(ao.x,ao.y);for(var to in Bn)if(numintersect(Bn[to][0],Bn[to][1],$n,$n)){Yn=Dn(meshes.children[to],eo);break}var lo=Yn[0],no=Yn[1],oo=Xn[0],po=Xn[1],co=10,uo=qn(new THREE.Vector3(oo.x,oo.y,oo.z),new THREE.Vector3(lo.x+1*(po.x*co),lo.y+1*(po.y*co),lo.z+1*(po.z*co)));Wn.add(uo)}my3dgroup.applyQuaternion(Hn),my3dgroup.add(lingeom),my3dgroup.add(partlingeom),Ss.add(my3dgroup),Ss.add(fallar),Ss.add(line3dgroup),Ss.add(line3dtemp),controls.enableRotate=!0,ae()}function Ct(Ln){for(var Pn=Ln[0][1].length,En=new THREE.Object3D,Tn=[],On=Ln[0][1],In=[],Bn=Ln[0][0]+1;Bn<Ln[Ln.length-1][0]-1;Bn+=2)In.push(At(Bn,Ln));for(var Gn in On){for(var Nn in Tn=[],In){var _n=In[Nn],Wn=_n.v[Gn];Tn.push(Wn.x,Wn.y,Wn.z)}var Gn=N(Tn,5,'0#000000');En.add(Gn)}return En}function Jt(Ln,Pn){var En=[];if(Ln<Pn[0][0])return Es=[Ln,Pn[0][1]],Es;if(Ln>Pn[Pn.length-1][0])return Es=[Ln,Pn[Pn.length-1][1]],Es;for(var Tn=1;Tn<Pn.length;Tn++)if(Ln>=Pn[Tn-1][0]&&Ln<=Pn[Tn][0]){var On=Pn[Tn-1][0],In=Pn[Tn][0],Bn=(Ln-On)/(In-On);for(var Gn in Pn[Tn][1]){var Nn=Pn[Tn][1][Gn],_n=Pn[Tn-1][1][Gn];En.push(new THREE.Vector2(Nn.x*Bn+_n.x*(1-Bn),Nn.y*Bn+_n.y*(1-Bn)))}break}return En.length||console.log('Error! Vout not defined in getcurveatpel'),[Ln,En]}function jt(Ln){for(var _n,Pn=Sl,En=zl,Tn=Jt(Pn,Ln),On=Jt(En,Ln),In=-1,Bn=[[0,Tn]],Gn=[],Nn=0;Nn<Ln.length;Nn++)if((_n=Ln[Nn][0],Math.round(In)!=Math.round(_n))&&(In=_n,_n=Math.round(_n),Ka(_n,Pn,En))){var Wn=(_n-Pn)/(En-Pn);Gn.push([Wn,Ln[Nn]])}if(0<pmult)for(var Un=0;Un<Gn.length;Un++)Bn.push(Gn[Un]);else for(var Un=Gn.length-1;-1<Un;Un--)Bn.push(Gn[Un]);Bn.push([1,On]);for(var Hn=new THREE.Object3D,Xn=[],Yn=[],Un=0;Un<Bn.length-1;Un++)for(var Kn=Bn[Un][1][0],Zn=Bn[Un+1][1][0],$n=0,Nn=Kn;0>(Nn-Zn)*pmult;Nn+=5*pmult){$n++;var Wn=(Nn-Pn)/(En-Pn);if(Yn.push([Wn,Jt(Nn,Ln)]),500<$n)return}Yn.push(Bn[Bn.length-1]);for(var Un=1;Un<Yn.length;Un++){var eo=At(Yn[Un][1][0],Ln),to=At(Yn[Un-1][1][0],Ln);Xn.push([Yn[Un-1][1][0],Yn[Un][1][0],Lt(to,eo,Yn[Un-1][0],Yn[Un][0])])}return[Xn,Hn]}function At(Ln,Pn){var En=Jt(Ln,Pn),Tn=getglobc(Ln),On=getglobc(Ln,1)[1]/180*Math.PI,In=getglobc(Ln+0.01),Bn=new THREE.Quaternion;null==In?(In=getglobc(Ln).sub(getglobc(Ln-0.01)).normalize(),In=In.normalize(),In.z=0,Bn.setFromUnitVectors(new THREE.Vector3(1,0,0),In)):(In=getglobc(Ln+0.01).sub(Tn),In=In.normalize(),In.z=0,Bn.setFromUnitVectors(new THREE.Vector3(1,0,0),In)),0.1<Math.abs(Bn.y)&&(console.log(Ln,Tn,In),console.log(Ln,Bn));var Gn={pel:Ln,v:[]};for(var Nn in En[1]){var _n=En[1][Nn],Wn=Math.sin(On),Un=Math.cos(On),Hn=new THREE.Vector3(0,_n.x,_n.y);Hn.applyAxisAngle(new THREE.Vector3(1,0,0),On),Hn.applyQuaternion(Bn),Hn.add(Tn),Gn.v.push(Hn)}return Gn}function Lt(Ln,Pn,En,Tn){var On=new THREE.Geometry,In=0,Bn=Ln.v.length;On.faceVertexUvs[0]=[];for(var Gn=0;Gn<Bn-1;++Gn){var Nn=Ln.v[Gn],_n=Ln.v[Gn+1],Wn=Pn.v[Gn],Un=Pn.v[Gn+1],Hn=Gn/(Bn-1),Xn=(Gn+1)/(Bn-1),Yn=null==En?0:En,Kn=null==Tn?1:Tn;On.vertices.push(new THREE.Vector3(Nn.x,Nn.y,Nn.z)),On.vertices.push(new THREE.Vector3(_n.x,_n.y,_n.z)),On.vertices.push(new THREE.Vector3(Wn.x,Wn.y,Wn.z)),On.vertices.push(new THREE.Vector3(Un.x,Un.y,Un.z)),On.faces.push(new THREE.Face3(In+2,In+1,In)),On.faces.push(new THREE.Face3(In+1,In+2,In+3)),On.faceVertexUvs[0].push([new THREE.Vector2(Hn,Kn),new THREE.Vector2(Xn,Yn),new THREE.Vector2(Hn,Yn)]),On.faceVertexUvs[0].push([new THREE.Vector2(Xn,Yn),new THREE.Vector2(Hn,Kn),new THREE.Vector2(Xn,Kn)]),In+=4}return On.uvsNeedUpdate=!0,On.computeFaceNormals(),On}function Pt(){Cn=new THREE.Object3D;var Ln=tun2='';if('34100'==params.tunnel&&(tun2='34100',Ln='34000'),'34000'==params.tunnel&&(tun2='34000',Ln='34100'),Ln){globavg=tungeom[Ln].Geo3d.globavg,globtc=tungeom[Ln].Geo3d.globtc,Cn=Dt(Ln)[1];var Pn=tv().copy(tungeom[Ln].Geo3d.globavg).sub(tungeom[tun2].Geo3d.globavg);Pn.y=-Pn.y,Cn.position.set(Pn.x,Pn.y,Pn.z)}globavg=tungeom[params.tunnel].Geo3d.globavg,globtc=tungeom[params.tunnel].Geo3d.globtc,globtc[0].pel-=0.1,('Kjorholt'==params.tunnel||'Tunnel1'==params.tunnel)&&(globtc[0].pel=13650),globtc[globtc.length-1].pel+=0.1,Vn=Dt(params.tunnel)}function Et(){var Ln=linez.length;if(!(2>Ln)){for(var En,Pn=1;Pn<Ln;Pn++)En=new Aa,En.addline(linez[Pn-1].xs,linez[Pn-1].ys,1,linez[Pn].xs,linez[Pn].ys,1,Math.round(30*params.size),'#000000'),oman.add(En);var Tn=linez[0].v,On=linez[Math.floor(Ln/2)].v,In=linez[Ln-1].v,Bn=Tt();return Bn}}function Tt(){for(var Ln=linez.length,Pn=Math.floor(Ln/3),En=Math.floor(2*Ln/3),Tn=tv(),On=tv(),In=tv(),Bn=0;Bn<Pn;Bn++)Tn.add(linez[Bn].v);Tn.multiplyScalar(1/Pn);for(var Bn=Pn;Bn<En;Bn++)On.add(linez[Bn].v);On.multiplyScalar(1/(En-Pn));for(var Bn=En;Bn<Ln;Bn++)In.add(linez[Bn].v);return In.multiplyScalar(1/(Ln-En)),[Tn,On,In]}function Bt(Ln){var Pn=new THREE.Plane().setFromCoplanarPoints(Ln[0],Ln[1],Ln[2]),En=new THREE.Vector3((Ln[0].x+Ln[1].x+Ln[2].x)/3,(Ln[0].y+Ln[1].y+Ln[2].y)/3,(Ln[0].z+Ln[1].z+Ln[2].z)/3),Tn=new THREE.BoxGeometry(150,150,0.5),On=new THREE.MeshBasicMaterial({color:17408,transparent:!0,opacity:0.1}),In=new THREE.Mesh(Tn,On),Bn=new THREE.Quaternion;Bn.setFromUnitVectors(new THREE.Vector3(0,0,1),Pn.normal),In.applyQuaternion(Bn),In.position.set(En.x,En.y,En.z),In.scale.set(fscale.val,fscale.val,1),fallar.add(In)}function Gt(Ln){var Pn=new THREE.Plane().setFromCoplanarPoints(Ln[0],Ln[1],Ln[2]),En=new THREE.Vector3((Ln[0].x+Ln[1].x+Ln[2].x)/3,(Ln[0].y+Ln[1].y+Ln[2].y)/3,(Ln[0].z+Ln[1].z+Ln[2].z)/3),Tn=Pn.normal;0>Tn.y&&Tn.negate();var On=180*new THREE.Vector3(0,1,0).angleTo(Tn)/Math.PI,In=Pa(linez[0].ys),Bn=getglobc(In+1).sub(getglobc(In));Bn=Bn.normalize();var Gn=getglobc((Sl+zl)/2),Nn=new THREE.Quaternion;Nn.setFromUnitVectors(new THREE.Vector3(0,0,1),new THREE.Vector3(0,1,0)),Bn.applyQuaternion(Nn);var _n=new THREE.Quaternion;_n.setFromUnitVectors(new THREE.Vector3(0,1,0).applyQuaternion(Nn),new THREE.Vector3(1,0,0).applyQuaternion(Nn));var Wn=tv().copy(Bn).applyQuaternion(_n),Un=new THREE.Plane().setFromCoplanarPoints(En,tv().copy(En).add(Wn),tv().copy(En).add(Bn)),Hn=tv().copy(Tn).projectOnPlane(Un.normal),Xn=Hn.angleTo(Bn)<Math.PI/2?1:0,Yn=180*Hn.angleTo(Wn)/Math.PI;return Yn=Xn?360-Yn:Yn,console.log('Strike:',Yn),console.log('Dip/Fall',On),[Math.floor(Yn),Math.round(On)]}function Wt(){if(linez.length){var Ln=new ConvexHullGrahamScan;for(var Pn in linez)Ln.addPoint(linez[Pn].xs,linez[Pn].ys);var En=Ln.getHull(),Tn=[];for(var On in linez)for(var Pn in En){var In=linez[On];En[Pn].x==In.xs&&En[Pn].y==In.ys&&Tn.push(In)}linez=Tn,linez.sort(function(Wn,Un){return Un.xs-Wn.xs});var Bn=y=0;for(var On in linez)Bn+=linez[On].xs,y+=linez[On].ys;Bn/=linez.length,y/=linez.length;var Gn=Et(),Nn=Gt(Gn),_n=new Aa;_n.addfall(Bn,y,8,Nn[0],Nn[1],1),_n.color=Gn,oman.plot(_n),oman.add(_n),Ut(linez),Va(),ae(),linez=[],controls.enableRotate=!0,check3dbox.checked=!0,ji.updateDisplay()}}function Ut(Ln){var Pn=[];for(var En in Ln)Pn.push(Ln[En].v.x,Ln[En].v.y,Ln[En].v.z);if(Pn.length){var Tn=N(Pn,Math.round(40*params.size),'#000000',1);line3dgroup.add(Tn)}}function Ht(Ln,Pn){var En=new Date().getTime(),Tn=5e3;if(null!=Pn&&(Tn=Pn),En-fs>Tn){for(var On in Jl){var In=Jl[On];In.redrawInterval=1}for(var On in ae(Ln),Jl){var In=Jl[On];In.redrawInterval=1e5}fs=En}else ae(Ln)}function $t(){params.withbg?ea(gl):ea(''),bi.material=vi,ae()}function ea(Ln){if(''==Ln)vi=new THREE.MeshBasicMaterial({color:16777215});else{var Pn=new THREE.TextureLoader;Pn.crossOrigin='anonymous';var En=Pn.load(Ln,function(){ae()});En.magFilter=THREE.NearestFilter,En.minFilter=THREE.LinearMipMapLinearFilter,En.anisotropy=2,Sl>zl&&(En.flipY=!1),vi=new THREE.MeshBasicMaterial({map:En})}}function ia(Ln,Pn){wl=getsessionid(),Q(),zl=parseInt(Pn),Sl=parseInt(Ln),pmult=Sl<zl?1:-1,Ml=(Sl+zl)/2,Fl=Math.abs(parseInt(Sl)-parseInt(zl)),Dl=50,11>Fl&&(Dl=100),6>Fl&&(Dl=200),hl=Dl*Fl,Rl=hl,Ws=hl/Ns,E(Sl,zl,Us),bt(Sl,zl),pa(gl,0),ua(Sl,zl,-1),params.resetcam(),ae(),picparams.ps=Sl,picparams.pe=zl,saveifokdist(picparams.ps,picparams.pe),fgui.updateDisplay()}function oa(Ln,Pn,En){var Tn=params.tunnel;null!=En&&(Tn=En);var On=Ln>Pn,In=Math.min(Ln,Pn),Bn=Math.max(Ln,Pn),Gn=1*Math.floor(In/1),Nn=1*Math.floor((Bn-0.01)/1+1),_n=gettunlim(Tn);('Kjorholt'==params.tunnel||'Tunnel1'==params.tunnel)&&(_n.pmin=13650),'34100'==params.tunnel&&(_n.pmin=0);var Wn=checklims(Gn,Nn,_n);Gn=Wn[0],Nn=Wn[1],picdb.sortbypelasc();var Un=getpicsinrange(Tn,Gn,Nn);gl='';var Hn=Un.length;for(var Xn in Hn&&(Gn=parseFloat(picdb.files[Un[0]].ps),Nn=parseFloat(picdb.files[Un[Hn-1]].pe)),On?ia(Nn,Gn):ia(Gn,Nn),Un)ra(picdb.files[Un[Xn]],On);rt(),fgui.close(),ji.close()}function ra(Ln,Pn){var En=Sl>zl;null!=Pn&&(En=Pn);var Tn=new THREE.TextureLoader;Tn.crossOrigin='anonymous';var On=Tn.load(Ln.pic,function(){ae()});On.magFilter=THREE.NearestFilter,On.minFilter=THREE.LinearMipMapLinearFilter,On.anisotropy=2,En&&(On.flipY=!1);var In=new THREE.MeshBasicMaterial({map:On}),Bn=Math.abs(La(Math.max(Ln.ps,Ln.pe))-La(Math.min(Ln.ps,Ln.pe))),Gn=La((Ln.ps- -Ln.pe)/2),Nn=new THREE.PlaneGeometry(Bn,2*_s,1,1);bi=new THREE.Mesh(Nn,In),bi.position.set(0,Gn,0.01);var _n=En?Math.PI:0;bi.rotateZ(Math.PI/2+_n),Xl.push(bi),Qs.add(bi)}function pa(Ln,Pn){jl.remove(Qs),Qs=new THREE.Object3D,Xl.length=0,ea(Ln);var En=new THREE.PlaneGeometry(2*Ws,2*_s,1,1);bi=new THREE.Mesh(En,vi),bi.position.set(0,Pn/Dl,0);var Tn=Sl>zl?Math.PI:0;bi.rotateZ(Math.PI/2+Tn),Xl.push(bi),Qs.add(bi),jl.add(Qs);var On=new THREE.PlaneGeometry(2*Ws,2.8*_s,1,1),In=new THREE.Mesh(On,vi);In.position.set(0,Pn/Dl,0),In.rotateZ(Math.PI/2+Tn),Xl.push(In),Qs.add(In)}function ca(Ln,Pn){var En=new THREE.MeshBasicMaterial({color:16777215}),Tn=new THREE.PlaneGeometry(5*(2*(Dl/Ns)),2*_s,1,1),On=new THREE.Mesh(Tn,En);On.position.set(0,Pn,0),On.rotateZ(Math.PI/2),Xl.push(On),Qs.add(On);var In=new THREE.PlaneGeometry(5*(2*(Dl/Ns)),3*_s,1,1),Bn=new THREE.Mesh(In,kl);Bn.position.set(0,Pn,0),Bn.rotateZ(Math.PI/2),Xl.push(Bn),Qs.add(Bn)}function ua(Ln,Pn,En,Tn,On){var In,Bn=!1;-1==En?(Bn=!0,In=11184810):(In=16711680,1<En&&(In=16769024),4<En&&(In=16746240),10<En&&(In=2258722));var Gn=Bn?1:0.8,Nn=new THREE.MeshBasicMaterial({color:In,transparent:!0,opacity:Gn}),_n=La((Ln+Pn)/2),Wn=Math.abs(La(Pn)-La(Ln)),Un=_s/3,Hn=-_s-Un+_s/10,Xn=new THREE.PlaneGeometry(Un,Wn,1,1),Yn=new THREE.Mesh(Xn,Nn);if(Yn.position.set(Hn,_n,Bn?0:1),Bn){var Kn=Os.children[0];null!=Kn&&Os.remove(Kn),Os.add(Yn),Xl.push(Yn)}else{Ts.add(Yn);var Zn=X('Q='+En+' '+Tn,Hn,_n,10,0);if(Ts.add(Zn),null!=On&&''!=On){for(var $n='',eo=0;eo<Math.min(4,On.length);eo++)$n+=On[eo];$n+='..!';var to=X($n,Hn-0.35*Hs,_n+0.38*Wn,10,1);Ts.add(to)}}}function ha(){for(;Ts.children.length;){var Ln=Ts.children[0];'undefined'!=typeof Ln.material&&Ln.material.dispose(),'undefined'!=typeof Ln.geometry&&Ln.geometry.dispose(),Ts.remove(Ln)}}function ga(){for(;Is.children.length;){var Ln=Is.children[0];'undefined'!=typeof Ln.material&&Ln.material.dispose(),'undefined'!=typeof Ln.geometry&&Ln.geometry.dispose(),Is.remove(Ln)}}function ya(){for(;Rs.children.length;){var Ln=Rs.children[0];'undefined'!=typeof Ln.material&&Ln.material.dispose(),'undefined'!=typeof Ln.geometry&&Ln.geometry.dispose(),Rs.remove(Ln)}for(;Ls.children.length;){var Ln=Ls.children[0];'undefined'!=typeof Ln.material&&Ln.material.dispose(),'undefined'!=typeof Ln.geometry&&Ln.geometry.dispose(),Ls.remove(Ln)}for(;Cs.children.length;){var Ln=Cs.children[0];'undefined'!=typeof Ln.material&&Ln.material.dispose(),'undefined'!=typeof Ln.geometry&&Ln.geometry.dispose(),Cs.remove(Ln)}}function ba(Ln,Pn){var En=document.createElement('input',Pn);En.setAttribute('class','inguib'),En.setAttribute('type','button'),En.setAttribute('value',Ln),En.setAttribute('id','mgb'+Ln);var Tn=new Hammer(En);return En.onfocus=function(){En.blur()},Tn.on('press',function(){mycswitch(En,'ibpressed',500),null!=Pn&&setTimeout(function(){Pn()},150)}),M(Tn),En}function xa(){var Ln=new FormData;Ln.append('data',params.author);try{var Pn=window.XMLHttpRequest?new XMLHttpRequest:new activeXObject('Microsoft.XMLHTTP');Pn.onreadystatechange=function(){if(4===Pn.readyState){var En=JSON.parse(Pn.response);filetable(container,En,function(Tn){var On=pelfromfname(Tn),In=On[0],Bn=On[1];saveifokdist(In,Bn),wa(Tn)})}},Pn.open('post',baseaddr+'getflist.php',!0),Pn.send(Ln)}catch(En){console.log(En)}}function wa(Ln){var Pn=new FormData;Pn.append('fname',Ln);try{var En=window.XMLHttpRequest?new XMLHttpRequest:new activeXObject('Microsoft.XMLHTTP');En.onreadystatechange=function(){if(4===En.readyState){if(params.overridepel){var Tn=pelfromfname(Ln),On=getpelrange(En.response,Tn[0],Tn[1]);Rn=[],gl='',ia(On[0],On[1])}Ra(En.response),allq.update(),Va(),ae()}},En.open('post',baseaddr+'gettxt.php',!0),En.send(Pn)}catch(Tn){console.log(Tn)}}function ka(Ln){var Pn=basekjor;'Kjorholt'==Ln&&(Pn=basekjor),'Bamle'==Ln&&(Pn=basebamble);var En=Ln+picparams.ps+'_'+picparams.pe+'.xml',Tn=Pn+Ta(Ln)+endfile,On=vkbeautify.xml(Tn);download(On,En)}function Sa(Ln,Pn){var En=ji.add(bf,'blank').name('Geology:');En.onChange(function(){ji.close()}),En.__li.setAttribute('class','cr function first');var Tn=parseFloat(ji.domElement.style.width)-1;En.__li.style.width=Tn+'px';var On=Ve(ji),In=ba('ShowDB',function(){Ai.showdb()});if(In.setAttribute('class','inguib but2gui'),On.appendChild(In),In=ba('Save',function(){params.save()}),In.setAttribute('class','inguib but2gui'),On.appendChild(In),Di=ji.addFolder('Settings'),Di.add(params,'loadprev').name(qa.restoresession),Di.add(params,'savealpha').name(qa.savepicture),Di.add(params,'author').name(qa.author).onChange(function(){Se()}).domElement.children[0].setAttribute('maxlength','20'),Di.add(params,'openfile').name(qa.openfilegeology),Di.add(params,'ex').name('Expert user').onChange(function(){ji.close(),Da(Kl)}),Di.add(params,'clear').name(qa.clearall),Di.add(params,'overridepel').name('Override pel'),Di.add(params,'withbg').name(qa.showmwd).onChange(function(){$t()}),Di.add(params,'showbergart').name(qa.showrocktype).onChange(function(){allp.update(),ae()}),Di.add(params,'forcesync').name('ForcedSync'),null!=Ln&&(Ln==qa.qval&&za(),'Select'==Ln)){Ci=ji.addFolder(qa.setproperties);var Bn=sid2txtdate(Wi.sid)+' '+Wi.author;if(Ci.add(bf,'blank').name(Bn),Ci.add(Wi,'author').name(qa.author),'T'!=Pn){q22=Ci.add(Wi,'comment').name('');var Gn=q22.domElement.children[0];Gn.setAttribute('class','myta'),q22.domElement.setAttribute('class','c bigtadiv'),Gn.placeholder='Comment...',Gn.onkeyup=function(){Qe(this)},Gn.onchange=function(){Ie()},q22.__li.setAttribute('class','cr string bigta')}if('T'==Pn&&(Ci.add(Yl[Bs],'text').name(qa.text).onChange(function(){Z(Bs,Yl[Bs].text)}),Ci.add(params,'openfoto').name(qa.takephoto),Ci.add(params,'makelab').name(qa.labtest)),null==Pn||'L'==Pn){Ci.add(Wi,'bergart',xi).name(qa.rocktype).listen().onChange(function(){params.parcolor=Ce(Wi.bergart),ji.updateDisplay()});var On=Ci.addColor(params,'parcolor').name(qa.color).listen().onChange(function(){params.parcolor=Ce(Wi.bergart),ji.updateDisplay()}),Nn=On.domElement.children[0];Nn.style.width='70%'}return'W'==Pn&&(Ci.add(Wi,'dsc',qa.dsc).name(qa.description),Ci.add(Wi,'wdrip').name(qa.dripmin),Ci.add(Wi,'wleak').name(qa.litmin)),'F'==Pn&&(Ci.add(Yl[Bs],'angle',0,360).step(1).name(qa.angle).onChange(function(){$(Bs,Yl[Bs].fall,Yl[Bs].angle)}),Ci.add(Yl[Bs],'fall',0,90).step(1).name(qa.fall).onChange(function(){$(Bs,Yl[Bs].fall,Yl[Bs].angle)})),Ci.add(bf,'blank').name(''),void Ci.add(params,'applyP').name(qa.ap)}Qi=ji.addFolder(qa.main),Qi.add(bf,'blank').name(''),params.ex&&(F(Qi),F(Qi),Qi.add(params,'resetcam').name(qa.resetcamera),F(Qi))}function za(){Vi=ji.addFolder(qa.qval);var Ln=sid2txtdate(_i.lastchange)+' by \''+_i.author+'\'';Vi.add(bf,'blank').name('Updated '+Ln);var Pn=Vi.add(_i,'ps').name('Pel start').domElement.children[0];Pn.type='tel',Pn.setAttribute('maxlength','5'),Pn=Vi.add(_i,'pe').name('Pel end').domElement.children[0],Pn.type='tel',Pn.setAttribute('maxlength','5'),q22=Vi.add(_i,'comment').name('');var En=q22.domElement.children[0];En.setAttribute('class','myta'),q22.domElement.setAttribute('class','c bigtadiv'),En.placeholder='Comment...',En.onkeyup=function(){Qe(this)},20<_i.comment.length&&Qe(En),En.onchange=function(){Te()},q22.__li.setAttribute('class','cr string bigta');var Pn=Ve(Vi);Ri.rqd=ba('RQD',function(){params.editRQD()}),Pn.appendChild(Ri.rqd),Ri.Jr=ba('Jr',function(){params.editJr()}),Pn.appendChild(Ri.Jr),Ri.Jw=ba('Jw',function(){params.editJw()}),Pn.appendChild(Ri.Jw),Ri.Jn=ba('Jn',function(){params.editJn()}),Pn.appendChild(Ri.Jn),Ri.Ja=ba('Ja',function(){params.editJa()}),Pn.appendChild(Ri.Ja),Ri.SRF=ba('SRF',function(){params.editSRF()}),Pn.appendChild(Ri.SRF);var Tn=Vi.add(bf,'blank').name('');Tn.__li.setAttribute('class','cr function qtext'),Ri.Q=Tn,Vi.add(_i,'bergart',xi).name(qa.rocktype);var Pn=Ve(Vi),On=ba(qa.apply,function(){Te()});On.setAttribute('class','inguib but2gui'),Pn.appendChild(On);var On=ba(qa.removeq,function(){params.removeq()});On.setAttribute('class','inguib but2gui'),Pn.appendChild(On)}function Fa(){ji=new dat.GUI({autoPlace:!1,width:Math.min(400,oi/2-4)}),container.appendChild(ji.domElement),ji.domElement.id='guipos'}function Da(Ln,Pn){Kl=Ln;var En=Ln;Ql?(En='3d',globgeo='Settings'):globgeo='Geology',kt(),null==En&&(Gl=[],chosenp=-2);var Tn=ji.closed;if(container.removeChild(ji.domElement),ji.destroy(),Fa(),'3d'==En){var On=ji.add(bf,'blank').name('Settings:');On.onChange(function(){ji.close()}),On.__li.setAttribute('class','cr function first');var In=parseFloat(ji.domElement.style.width)-1;return On.__li.style.width=In+'px',ji.add(lingeom,'visible').name('Tunnel frame').onChange(function(){ae()}),Jn&&(params.showholes&&(pointval.valmin=23,pMaterial.size=10,pointCloud.geometry.drawRange.start=pointval.ar[pointval.valmin-1],pointCloud.geometry.drawRange.count=pointval.ar[pointval.valmax-1]-pointCloud.geometry.drawRange.start,Jn=0),params.opacity=0.3,meshes.children[0].material.opacity=params.opacity,ae()),params.showholes&&(ji.add(pointval,'valmin',1,pointval.ar.length).name('Min').step(1).onChange(function(){pointCloud.geometry.drawRange.start=pointval.ar[pointval.valmin-1],pointCloud.geometry.drawRange.count=pointval.ar[pointval.valmax-1]-pointCloud.geometry.drawRange.start,ae()}),ji.add(pointval,'valmax',1,pointval.ar.length).name('Max').step(1).onChange(function(){pointCloud.geometry.drawRange.count=pointval.ar[pointval.valmax-1]-pointCloud.geometry.drawRange.start,ae()}),ji.add(pMaterial,'size',5,35).name('Point size').step(1).onChange(function(){ae()})),ji.add(params,'opacity',0,1).name('Tunnel opacity').step(0.1).onChange(function(){meshes.children[0].material.opacity=params.opacity,ae()}),ji.add(fscale,'val',0,1).name('Plane size').step(0.02).onChange(function(){for(var Gn in fallar.children)fallar.children[Gn].scale.set(fscale.val,fscale.val,1);ae()}),params.showholes||ji.add(params,'showholeask').name('Show holes'),void ji.updateDisplay()}if(Sa(En,Pn),null==Pn&&Na(),St(),'Line'==En&&($s.setAttribute('class','geobuttonf'),params.linetype='Line',Qi.add(params,'bolt').name(qa.bolt),Qi.add(params,'lineStyle',qa.lineStylear).name(qa.ls),params.ex&&Qi.add(params,'size',0.1,1).name('Size').step(0.1),Qi.add(bf,'blank').name('')),'Water'==En&&(ei.setAttribute('class','geobuttonf'),params.linetype='Water',Qi.add(params,'wsize',0.1,1).step(0.1).name('Size'),Qi.add(bf,'blank').name('')),'Text'==En){ti.setAttribute('class','geobuttonf'),params.linetype='Text',q22=Qi.add(params,'text').name(qa.ttp),Qi.add(bf,'blank').name('');var Bn=q22.domElement.children[0];Bn.setAttribute('class','myta'),Bn.placeholder='Text...',Tn=!1}'Fall'==En&&(li.setAttribute('class','geobuttonf'),params.linetype='Fall',q22=Qi.add(params,'angle',0,360).step(1).name(qa.angle),Qi.add(params,'fall',0,90).step(1).name(qa.fall),Qi.add(bf,'blank').name(''),Tn=!1),'Bolt'==En&&(params.linetype='Bolt',Qi.add(params,'boltlen',1,10).step(0.5).name(qa.len),Qi.add(params,'bolttype',qa.boltlist).name(qa.material),Qi.add(bf,'blank').name('')),'Select'==En||'Q - value'==En?(si.setAttribute('class','geobuttonf'),params.linetype='Select'):Qi.open(),ji.updateDisplay(),Tn?Ee():Pe()}function Ma(){for(var Ln in Js.children.length=0,oman.ao){var Pn=oman.ao[Ln];Pn.toskip||'B'!=Pn.type||oman.plot(Pn)}}function Va(){ya(),vt();for(var Ln=[],Pn=0;Pn<Yl.length;Pn++)0==Yl[Pn].skip&&Ln.push(Yl[Pn]);for(var On,In,En=yprev=cprev=sprev=-1e3,Tn=[],Pn=0;Pn<Ln.length;Pn++)if('L'==Ln[Pn].type)if(En==Ln[Pn].xs&&yprev==Ln[Pn].ys&&cprev==Ln[Pn].color&&sprev==Ln[Pn].size){var Bn=[Ln[Pn].xe,Ln[Pn].ye,Ln[Pn].zs];En=Ln[Pn].xe,yprev=Ln[Pn].ye,Tn.push(Bn[0]),Tn.push(Bn[1]),Tn.push(Bn[2])}else N(Tn,In,On),En=Ln[Pn].xe,yprev=Ln[Pn].ye,cprev=Ln[Pn].color,sprev=Ln[Pn].size,Tn=[Ln[Pn].xs,Ln[Pn].ys,Ln[Pn].zs,En,yprev,Ln[Pn].zs],On=Ln[Pn].color,In=Ln[Pn].size;N(Tn,In,On)}function Qa(){this.oldzero=1,this.oldppu=1,this.oldpw=1,this.getnewy=function(Ln){var En=La(Ln);return En=mr(En),En},this.getnewx=function(Ln){var Pn=Ln/this.oldpw*_s;return Pn=mr(Pn),Pn}}function Ca(Ln,Pn){for(var En in Pn)for(var Tn=Pn[En],On=0;On<Tn.length;On++)if(Tn[On]==Ln)return''+En;return null}function Ra(Ln){mt.start('Get json');var Pn='object'==typeof Ln?JSON.parse(JSON.stringify(Ln)):JSON.parse(Ln);var En=Pn.objdata;mt.end('Get json');var Tn=new Qa,On=Pn.authors,In=Pn.sids,Bn=Pn.chlist;if(null==Bn||isEmpty(Bn))for(var Gn in In)oman.changelist[Gn]=Gn;else for(var Gn in In)oman.changelist[Gn]=Bn[Gn];Tn.oldzero=Pn.zeropel,An=Pn.author,Tn.oldppu=Pn.pelperunit,Tn.oldpw=Pn.pw,jn=Pn.sid,allq.restore(Pn.qval,1);for(var Nn=Pn.pval,_n=0;_n<Nn.par.length;_n++)for(var Gn=0;Gn<Nn.par[_n].coords.length;Gn+=2)Nn.par[_n].coords[Gn]=Tn.getnewx(Nn.par[_n].coords[Gn]),Nn.par[_n].coords[Gn+1]=Tn.getnewy(Nn.par[_n].coords[Gn+1],1);allp.restore(Nn,1);for(var Yn,Wn=En.length,Un=6,Hn='#000000',Xn=qy=qz=tmpy=tmpx=-1e3,Gn=0;Gn<Wn;Gn++){if(Yn=new Aa,null==In)Yn.sid=jn;else{var Kn=Ca(Gn,In);Yn.sid=null==Kn?jn:Kn}if(null==On)Yn.author=An;else{var Kn=Ca(Gn,On);Yn.author=null==Kn?An:Kn}var Zn=En[Gn];if(2==Zn.length){tmpx=Tn.getnewx(Zn[0]/qprec),tmpy=Tn.getnewy(Zn[1]/qprec),Yn.addline(Xn,qy,qz,tmpx,tmpy,qz,Un,Hn),Xn=Tn.getnewx(Zn[0]/qprec),qy=Tn.getnewy(Zn[1]/qprec),oman.isdublicate(Yn),oman.plot(Yn),oman.add(Yn);continue}if(0==Zn[0]){Un=15,Hn='#000000',6<Zn.length&&('number'==typeof Zn[6]&&(Un=Zn[6]),'string'==typeof Zn[6]&&(Hn=Zn[6])),8==Zn.length&&(Hn=Zn[7]),Xn=Tn.getnewx(Zn[4]/qprec),qy=Tn.getnewy(Zn[5]/qprec),qz=Zn[3],tmpx=Tn.getnewx(Zn[1]/qprec),tmpy=Tn.getnewy(Zn[2]/qprec),Yn.addline(tmpx,tmpy,qz,Xn,qy,qz,Un,Hn),oman.isdublicate(Yn),oman.plot(Yn),oman.add(Yn);continue}if(1==Zn[0]){Un=0.5,3<Un.length&&(Un=Zn[3]),tmpx=Tn.getnewx(Zn[1]/qprec),tmpy=Tn.getnewy(Zn[2]/qprec),Yn.addwater(tmpx,tmpy,10,Un),oman.isdublicate(Yn),oman.plot(Yn),oman.add(Yn);continue}if(2==Zn[0]){tmpx=Tn.getnewx(Zn[1]/qprec),tmpy=Tn.getnewy(Zn[2]/qprec);var $n=Zn[4];'_pho_'==$n.slice(0,5)&&(Yn.fall=1,$n=$n.slice(5),console.log($n)),'_lab_'==$n.slice(0,5)&&(Yn.fall=2,$n=$n.slice(5)),Yn.addtext($n,tmpx,tmpy,Zn[3],1),oman.isdublicate(Yn),oman.plot(Yn),oman.add(Yn);continue}if(3==Zn[0]&&(tmpx=Tn.getnewx(Zn[1]/qprec),tmpy=Tn.getnewy(Zn[2]/qprec),Yn.addfall(tmpx,tmpy,10,Zn[3],Zn[4],Zn[5]),null!=Zn[6]&&(Yn.color=[tv(Zn[6][0].x,Zn[6][0].y,Zn[6][0].z),tv(Zn[6][1].x,Zn[6][1].y,Zn[6][1].z),tv(Zn[6][2].x,Zn[6][2].y,Zn[6][2].z)]),oman.isdublicate(Yn),oman.plot(Yn),oman.add(Yn)),4==Zn[0]){Yn.addbolt(Tn.getnewx(Zn[1]/qprec),Tn.getnewy(Zn[2]/qprec),Zn[3],Tn.getnewx(Zn[4]/qprec),Tn.getnewy(Zn[5]/qprec),Zn[6],Zn[7]),oman.isdublicate(Yn),oman.plot(Yn),oman.add(Yn);continue}}}function Ja(Ln,Pn,En){var Tn=0.02/Math.abs(Sl-zl);null!=En&&(Tn=En);var On=Math.abs(parseFloat(Ln)-parseFloat(Pn));return!!(On<Tn)}function ja(Ln,Pn){var Tn=Math.abs(parseFloat(Ln)-parseFloat(Pn));return Tn}function Aa(){this.type='',this.sid=wl,this.author=params.author,this.id=0,this.skip=0,this.text='',this.xs=0,this.ys=0,this.zs=0,this.xe=0,this.ye=1,this.ze=1,this.size=3,this.color='',this.fall=0,this.angle=0,this.lastmx=-1e3,this.lastmy=-1e3,this.sameas=function(Ln){return this.type==Ln.type&&Ja(this.xs,Ln.xs)&&Ja(this.ys,Ln.ys)},this.addline=function(Ln,Pn,En,Tn,On,In,Bn,Gn){this.type='L',this.size=Bn,this.color=Gn,this.xs=Ln,this.ys=Pn,this.zs=En,this.xe=Tn,this.ye=On,this.ze=In},this.addbolt=function(Ln,Pn,En,Tn,On,In,Bn){this.type='B',this.text=Bn,this.xs=Ln,this.ys=Pn,this.zs=En,this.xe=Tn,this.ye=On,this.ze=In},this.addwater=function(Ln,Pn,En,Tn,On,In,Bn,Gn){this.type='W',this.size=Tn,this.xs=Ln,this.ys=Pn,this.zs=En,null!==On&&(this.text=On),null!==In&&(this.xe=In),null!==Bn&&(this.fall=Bn),null!==Gn&&(this.angle=Gn)},this.addfall=function(Ln,Pn,En,Tn,On,In){this.type='F',this.xs=Ln,this.ys=Pn,this.zs=En,this.angle=Tn,this.fall=On,this.size=null==In?_e(Pa(Pn)):In},this.addtext=function(Ln,Pn,En,Tn){this.type='T',this.text=Ln,this.xs=Pn,this.ys=En,this.zs=Tn}}function La(Ln){var Pn=parseFloat(2*(pmult*(Ln-parseFloat(Ml))*Dl/Ns));return Pn}function Pa(Ln){var Pn=parseFloat(pmult*Ln/(2*(Dl/Ns))+Ml);return Pn}function Ea(){var Ln=new Date,Pn=parseInt(Ln.getMonth()+1),En={date:Ln.getFullYear()+'-'+az(Pn)+'-'+az(Ln.getDate()),author:params.author};return En}function Ta(Ln){for(var Pn=[],En=[],Tn={pmult:pmult,pelperunit:1/(2*(Dl/Ns)),zeropel:Ml,pw:_s,author:params.author,tunnel:Ln},On=new myxml(Tn),In={type:'w',da:Ea(),coords:[0,1],comment:'',dsc:0,drip:'',leak:''},Bn={type:'t',da:Ea(),coords:[0,1],comment:'',fall:0},Gn={type:'f',da:Ea(),coords:[0,1],comment:'',angle:0,fall:0},Nn={type:'l',da:Ea(),coords:[0,1],ltype:0,comment:'',bergart:'none',color:'',width:0},_n={type:'q',da:Ea(),coords:[0,1],QVal:[],bergart:'none',color:0,comment:''},Wn=0;Wn<allq.qar.length;Wn++){var Un=allq.qar[Wn],Hn=_n;Hn.da.author=Un.author,Hn.da.date=sid2date(Un.lastchange),Hn.coords=[Un.ps,Un.pe],Hn.QVal=[Un.RQD,Un.Jn,Un.Jr,Un.Ja,Un.Jw,Un.SRF,Un.Q],Hn.bergart=Un.bergart,Hn.comment=Un.comment,Hn.color=wt(Ce(Un.bergart)),On.parseos(Hn)}for(var Wn=0;Wn<Yl.length;Wn++)if(!Yl[Wn].skip&&!isinarray(En,Wn)){var Xn=je(Wn);if(!isinarray(Pn,Xn)){var Zn,Yn=Re(Wn),Kn=-2<Xn?1:0;Kn&&(Pn.push(Xn),Zn=allp.par[Xn]);var eo,$n=Yl[Wn];if('L'==Yn)if(eo=Nn,eo.da.author=$n.author,eo.da.date=sid2date($n.sid),eo.ltype=$n.color[0],Kn)Zn.isarea&&(eo.ltype=5),eo.coords=Zn.coords,eo.comment=Zn.comment,eo.bergart=Zn.bergart,eo.color=Zn.color,eo.width=Zn.width;else{for(var to=he(Wn),ao=0;ao<to.length;ao++)En.push(to[ao]);eo.coords=ge(to)}'W'==Yn&&(eo=In,eo.da.author=$n.author,eo.da.date=sid2date($n.sid),eo.coords=[$n.xs,$n.ys],Kn&&(Zn.comment&&(eo.comment=Zn.comment),Zn.dsc&&(eo.dsc=Zn.dsc),Zn.wdrip&&(eo.drip=Zn.wdrip),Zn.wleak&&(eo.leak=Zn.wleak))),'T'==Yn&&(eo=Bn,eo.da.author=$n.author,eo.da.date=sid2date($n.sid),eo.coords=[$n.xs,$n.ys],eo.comment=$n.text,eo.fall=$n.fall),'B'==Yn&&(eo=Bn,eo.da.author=$n.author,eo.da.date=sid2date($n.sid),eo.coords=[$n.xs,$n.ys],eo.comment='B'),'F'==Yn&&(eo=Gn,eo.da.author=$n.author,eo.da.date=sid2date($n.sid),eo.coords=[$n.xs,$n.ys],eo.angle=$n.size?$n.angle:360-$n.angle,eo.fall=$n.fall),On.parseos(eo)}}return On.showstrout()}function Oa(Ln,Pn){for(var En=[],Tn=[],On=JSON.parse(JSON.stringify(Ln)),In=0;In<On.length;In++)if(!isinarray(Tn,In)){var Bn=params.onlynew&&!Pn?On[In].sid==wl:1;1<params.onlynew&&(Bn=On[In].sid==params.onlynew?1:0);var Gn=1;if(params.onlycurpel&&!Pn&&!Ya(Pa(On[In].ys))){var Nn=he(In);add2array(Tn,Nn),Gn=0}!On[In].skip&&Bn&&Gn&&En.push(On[In])}return En}function Ia(Ln){var Pn=0;null!=Ln&&(Pn=Ln);var En=Oa(Yl,Pn),Tn=new fe;Tn.lastchange=oman.changelist[params.onlynew],null==Tn.lastchange&&(Tn.lastchange=wl),Tn.zeropel=Ml,Tn.pelperunit=Dl*pmult,Tn.pw=_s,Tn.pelstart=Sl,Tn.pelend=zl,Tn.author=params.author,Tn.authors={},Tn.sid=wl,Tn.sids={},Tn.tunnel=params.tunnel;var On=new We;Pn?On.restore(allq,1):On.restore(allq,1,params.onlynew),Tn.qval=On;var In=new Ge;In.restore(allp,1,params.onlynew&&!Pn),Pn?In.restore(allp,1):In.restore(allp,1,params.onlynew),In.cleanFromQ(),In.y2pelcoords(),params.onlycurpel&&In.cleanFromPel(),Tn.pval=In;for(var Bn=yprev=cprev=sprev=-1e3,Gn=0;Gn<En.length;Gn++)En[Gn].ys=Pa(En[Gn].ys),En[Gn].ye=Pa(En[Gn].ye);for(var Nn,Gn=0;Gn<En.length;Gn++){Nn=En[Gn].author,null==Tn.authors[Nn]?Tn.authors[Nn]=[Gn]:Tn.authors[Nn].push(Gn);var _n=En[Gn].sid;if(null==Tn.sids[_n]?Tn.sids[_n]=[Gn]:Tn.sids[_n].push(Gn),'L'==En[Gn].type){if(Bn==Math.round(En[Gn].xs*qprec)&&yprev==Math.round(En[Gn].ys*qprec)&&cprev==En[Gn].color&&sprev==En[Gn].size){var Wn=[Math.round(En[Gn].xe*qprec),Math.round(En[Gn].ye*qprec)];Bn=Math.round(En[Gn].xe*qprec),yprev=Math.round(En[Gn].ye*qprec)}else{Bn=Math.round(En[Gn].xe*qprec),yprev=Math.round(En[Gn].ye*qprec),cprev=En[Gn].color,sprev=En[Gn].size;var Wn=[0,Math.round(En[Gn].xs*qprec),Math.round(En[Gn].ys*qprec),En[Gn].zs,Bn,yprev];6!=En[Gn].size&&Wn.push(En[Gn].size),'#000000'!=En[Gn].color&&Wn.push(En[Gn].color)}Tn.objdata.push(Wn)}if('W'==En[Gn].type){Bn=-1e3;var Wn=[1,En[Gn].xs*qprec,En[Gn].ys*qprec];0.5!=En[Gn].size&&Wn.push(En[Gn].size),Tn.objdata.push(Wn)}if('T'==En[Gn].type){Bn=-1e3;var Un=En[Gn].text;1==En[Gn].fall&&(Un='_pho_'+Un),2==En[Gn].fall&&(Un='_lab_'+Un);var Wn=[2,En[Gn].xs*qprec,En[Gn].ys*qprec,En[Gn].zs,Un];Tn.objdata.push(Wn)}if('F'==En[Gn].type){if(Bn=-1e3,''!=En[Gn].color)var Wn=[3,En[Gn].xs*qprec,En[Gn].ys*qprec,En[Gn].angle,En[Gn].fall,En[Gn].size,En[Gn].color];else var Wn=[3,En[Gn].xs*qprec,En[Gn].ys*qprec,En[Gn].angle,En[Gn].fall,En[Gn].size];Tn.objdata.push(Wn)}if('B'==En[Gn].type){Bn=-1e3;var Wn=[4,En[Gn].xs*qprec,En[Gn].ys*qprec,En[Gn].zs,En[Gn].xe*qprec,En[Gn].ye*qprec,En[Gn].ze,En[Gn].text];Tn.objdata.push(Wn)}}var Hn=Object.keys(Tn.authors).length;if(1==Hn){var Xn=Ca(0,Tn.authors);null!=Xn&&(Tn.author=Ca(0,Tn.authors)),null==Tn.authors}var Yn=Object.keys(Tn.sids).length;if(1==Yn){var Xn=Ca(0,Tn.sids);null!=Xn&&(Tn.sid=Ca(0,Tn.sids)),null==Tn.sids}for(var Kn in Tn.chlist={},Tn.sids){var Nn=oman.changelist[Kn];console.log('Element of changelist',Kn,Nn),null!=Nn&&(Tn.chlist[Kn]=Nn)}return console.log('Saved change list',Tn.chlist),0==Tn.qval.qar.length&&console.log('No Q to save'),0==Tn.pval.par.length&&console.log('No Props to save'),0==Tn.objdata.length&&console.log('No registrations to save'),0==Tn.objdata.length&&0==Tn.pval.par.length&&0==Tn.qval.qar.length&&(Tn=0),Tn}function Ba(Ln,Pn){if(Ji=1,renderblock=1,Pn>=Ln.files.length)return Ys.value=null,allq.update(),Va(),renderblock=0,ae(),void(Ji=0);var En=new FileReader;En.onload=function(Tn){return 1==Ln.files.length&&params.overridepel?(console.log('open one blank file'),openblankimage(Tn.target.result),Ji=0,void(renderblock=0)):void(Ra(Tn.target.result),console.log('Done reading ',Pn),Ba(Ys,Pn+1))},En.readAsText(Ln.files[Pn])}function Na(){Ms.visible=!1,Ul=yp=zp=-1e3,Bs=-1,Vs.visible=!1}function _a(Ln,Pn){var Tn=180*(Math.atan2(Ln-Yl[Yl.length-1].xs,Pn-Yl[Yl.length-1].ys)/Math.PI);Tn=Math.round(Tn),0>Tn&&(Tn=360+Tn),ls.rotation=Math.round(1e3*(-Math.PI/180*Tn))/1e3,params.angle=Tn,Yl[Yl.length-1].angle=Tn,ji.updateDisplay(),oman.updchangelist(Yl[Yl.length-1].sid)}function Wa(Ln,Pn,En,Tn,On,In){var Bn=new THREE.CircleGeometry(Tn,32,Math.PI/4,2.12*Math.PI),Gn=new THREE.Line(Bn,new THREE.LineBasicMaterial({color:In,linewidth:On}));return Gn.position.set(Ln,Pn,En),Gn}function Ua(Ln,Pn,En){var On=0;null!=Pn&&(On=wt(Pn,1));var In='object'==typeof En?En.val:1,Bn=new THREE.TextSprite({textSize:0.25*Xs*In,redrawInterval:1e7,texture:{text:Ln+'',fontFamily:'Arial, Helvetica, sans-serif, Bold',fontWeight:'bold',autoRedraw:!1},material:{color:On,fog:!1}});return 15!=In&&Jl.push(Bn),Bn.position.set(0,0,1),fcp&&(setTimeout(function(){ae()},100),fcp=0),Bn}function Xa(){Te(),Me(),Pe()}function Ya(Ln){var Pn=picparams.ps,En=picparams.pe;if(0<pmult){if(Ln>=Pn&&Ln<=En)return!0;}else if(Ln>=En&&Ln<=Pn)return!0;return!1}function Ka(Ln,Pn,En){var Tn=Pn,On=En;if(En>Pn){if(Ln>=Tn&&Ln<=On)return!0;}else if(Ln>=On&&Ln<=Tn)return!0;return!1}var $a=window.getComputedStyle(document.body,null).getPropertyValue('--myyellow'),el=window.getComputedStyle(document.body,null).getPropertyValue('--myblack'),sl=window.getComputedStyle(document.body,null).getPropertyValue('--mybackground'),il,rl;this.getrs=function(){return il},this.callresultstring=function(Ln){le(Ln)},this.getrp=function(){return rl},this.callresultpic=function(Ln){oe(Ln)},this.loadlines=function(Ln){Ra(Ln),allq.update(),Va(),ae()},this.setauthor=function(Ln){params.author=Ln,ji.updateDisplay()},this.showvederlag=function(){console.log('vederlag to be done')},this.makenovaxml=function(Ln,Pn){console.log('novaxmlto to be done'),Pn},this.getnxml=function(){return'to be xml text'},this.show3d=function(){it()},this.show2d=function(){rt()};var ul=S.picsizex,hl=S.picsizey,gl=S.picadress;gl='';var yl=gl,fl=S.tung,vl=S.ling,wl=getsessionid();newdb=new mydb,newdb.ldb(),picdb=new mypicdb,6>picdb.files.length&&(picdb.files=picfiles,picdb.sdb()),tungeom.Tunnel1=tungeom1.Tunnel1;var kl=new THREE.MeshBasicMaterial({color:16777215,transparent:!0,opacity:0}),Sl=S.pelstart,zl=S.pelend,Fl=Math.abs(parseInt(Sl)-parseInt(zl)),Dl=50;11>Fl&&(Dl=100),6>Fl&&(Dl=200),hl=Dl*Fl;var Ml=S.zeropel,Vl=S.picpack,Ql=!1,Cl=ul,Rl=hl,Jl=[];container=condiv();var jl,Al=new THREE.Raycaster,Ll=new THREE.Vector2,El=0,Tl=0,Ol=0,Gl=[],Ul=yp=zp=-1e3,Hl=yp2d=zp2d=-1e3,Xl=[],Yl=[],Kl='Line';oman=new C;var Zl=function(){return{s:'bevgsave1',l:'bevgsave1'}}(),$l=new function(){this.idx=[],this.type=[],this.remprev=[],this.xl=[],this.yl=[],this.add=function(Ln,Pn,En){this.idx.push(Ln),this.type.push(Pn),this.remprev.push(En),this.xl.push(0),this.yl.push(0)},this.addMove=function(Ln,Pn,En,Tn,On){this.idx.push(Ln),this.type.push(Pn),this.remprev.push(En),this.xl.push(Tn),this.yl.push(On)},this.removelast=function(){this.type.splice(this.type.length-1,1),this.idx.splice(this.idx.length-1,1),this.remprev.splice(this.remprev.length-1,1),this.xl.splice(this.xl.length-1,1),this.yl.splice(this.xl.length-1,1)}},es,as,ls,us,ms,fs=0,bs=lastmovey=-1e3,ws=0;Detector.canvas||alert('Browser does not support canvas 3d'),jl=new THREE.Scene;var Ss=new THREE.Scene,Fs=new THREE.Scene,Ds=jl,Ms=new THREE.Object3D,Vs=new THREE.Object3D,Qs=new THREE.Object3D,Cs=new THREE.Object3D,Rs=new THREE.Object3D,Js=new THREE.Object3D,js=new THREE.Object3D,As=new THREE.Object3D,Ls=new THREE.Object3D,Ps=new THREE.Object3D,Es;fallar=new THREE.Object3D,line3dgroup=new THREE.Object3D,line3dtemp=new THREE.Object3D,jl.add(js),jl.add(As),jl.add(Ls);var Ts=new THREE.Object3D,Os=new THREE.Object3D,Is=new THREE.Object3D,Bs=-1;Ms.visible=!1,Vs.visible=!1,pmult=Sl<zl?1:-1;var Ns=200,_s=ul/200,Ws=hl/Ns,Us=0,Hs=1,Xs=1,Ys=document.createElement('input');document.body.appendChild(Ys),Ys.type='file',Ys.accept='.txt',Ys.multiple=!0,Ys.style.display='none',Ys.onchange=function(){if(console.log('Start file read'),null==this.files[0])return void console.log('No files chosen');var Ln=this.files[0].name,Pn=pelfromfname(Ln);params.overridepel&&saveifokdist(Pn[0],Pn[1]),('t'==Ln[Ln.length-1]||'T'==Ln[Ln.length-1])&&Ba(this,0)};var Ks=document.createElement('input');document.body.appendChild(Ks),Ks.type='file',Ks.style.display='none',Ks.onchange=function(){if(null==this.files[0])return void console.log('No photo chosen');var Ln=this.files[0].name;('g'==Ln[Ln.length-1]||'G'==Ln[Ln.length-1])&&Y(this)};var Zs=new Image,$s=document.getElementById('linbtn'),ei=document.getElementById('watbtn'),ti=document.getElementById('txtbtn'),li=document.getElementById('falbtn'),si=document.getElementById('selbtn'),ii=document.getElementById('undbtn');renderer=new THREE.WebGLRenderer({antialias:!1,alpha:!0,premultipliedAlpha:!0}),renderer.setPixelRatio(window.devicePixelRatio),renderer.setClearColor(wt(sl,1));var oi,ri;z();var di=new THREE.Vector2(oi,ri);renderer.setSize(oi,ri),document.getElementById(h).appendChild(renderer.domElement);var pi=document.getElementById(h).offsetTop,ci=document.getElementById(h).offsetLeft,ui=oi/ri,hi=2.5*Ws*Math.sqrt(2.28/(Ws/_s)),gi=hi;jl.add(Qs),jl.add(Ts),jl.add(Is),jl.add(Os),jl.add(Rs),jl.add(Js),jl.add(Cs),camera=new THREE.OrthographicCamera(-hi*ui/2,hi*ui/2,gi/2,-gi/2,-5e3,5e3),controls=new THREE.OrbitControls(camera,renderer.domElement),controls.enableDamping=!1,controls.dampingFactor=0.3,controls.enableRotate=!1,controls.rotateSpeed=0.45,controls.zoomSpeed=1,android||iOS||(controls.zoomSpeed=3);var mi=1;controls.target.set(0,0,0),camera.position.set(0,0,mi);camera.zoom;controls.addEventListener('change',function(){Ht(1)}),controls.addEventListener('end',function(){Ht(1)}),cameraFix=new THREE.OrthographicCamera(-hi*ui/2,hi*ui/2,gi/2,-gi/2,-5e3,5e3);var bi,vi;pa(gl,0),function(){var Ln=0.07*Xs,Pn=0.14*Xs,En=_(-Ln,-Ln,10,Ln,Ln,10,8*Xs,'#000000'),Tn=_(Ln,-Ln,10,-Ln,Ln,10,8*Xs,'#000000');Ms.add(En,Tn),jl.add(Ms);var On=_(-Pn,-Pn,10,Pn,-Pn,10,5*Xs,'#000000'),In=_(Pn,-Pn,10,Pn,Pn,10,5*Xs,'#0000ff'),Bn=_(Pn,Pn,10,-Pn,Pn,10,5*Xs,'#ff0000'),Gn=_(-Pn,Pn,10,-Pn,-Pn,10,5*Xs,'#00ff00');Vs.add(On,In,Bn,Gn),jl.add(Vs)}();var xi=['none','Hornfels','Svartskifer','Sill','Spr\xF8ytebetong','Special','Weakness','Basalt','Calcite','Granite','Pyrite'],ki=['#ffffff','#D0D470','#817A85','#EDA155','#877D7B','#ED4AE8','#771111','#000000','#aaffaa','#aa7777','#ff2222'],Di,Vi,Qi,Ci,Ri={rqd:'',Jn:'',Jr:'',Ja:'',Jw:'',SRF:'',Q:''},Ji=0;(android||iOS)&&setInterval(function(){ht()},3e4),params={ex:!1,restses:1,loadprev:function(){myask(container,qa.unsaved,function(){Q(),gt()})},savexml:function(){ka(params.tunnel)},forcesync:!1,enrot:!1,linetype:'Line',linemagnet:!0,lineStyle:qa.lineStylear[0],tunnel:picparams.ps>tunborder?'Bamble':'Kjorholt',vederlag:!1,text:'',author:'V',onlynew:!1,onlycurpel:!1,rutenett:!1,size:0.5,wsize:0.5,opacity:0.5,angle:0,fall:45,layer:0,showholes:!1,showholeask:function(){myask(container,'This will take up to 10 seconds calculations.',function(){params.showholefunc()})},showholefunc:function(){params.showholes=!0,''!=strin&&(!android&&(strin=strin2),Ps=makecloud(strin));var Ln=getglobc((Sl+zl)/2),Pn=new THREE.Object3D;Pn.add(Ps),Pn.position.set(-Ln.x,-Ln.y,-Ln.z),my3dgroup.add(Pn),ae(),Da('3d')},move:!1,movestart:!1,color:'#000000',parcolor:'#000000',savealpha:function(){tt(),Ht(null,1),ae();var Ln=renderer.domElement.toDataURL(),Pn=new Date,En='';En=En+'geo'+Pn.getHours()+'h'+Pn.getMinutes()+'m'+Pn.getSeconds()+'s.png',Fn(Ln,En),pt(),lsc=1,Va()},what2plot:'Geo+Q+Pel',withbg:!0,showbergart:!0,tstval:45,bolt:function(){si.value='Select',Da('Bolt')},boltlen:5,bolttype:'Steel',wtxt:'',dsc:'Not given',wleak:0,wdrip:0,save:function(){var Ln='Save all registrations as \n'+params.tunnel+' tunnel?';myask(container,Ln,function(){params.onlynew=!1,disassemble(),ji.updateDisplay()})},textsave:'',clear:function(){myask(container,qa.unsaved,function(){Q()})},load:function(){Ra(params.textsave),ae()},go3d:it,go2d:rt,getflist:function(){xa()},add5m:function(){fgui.close(),ji.close(),dt()},resetcam:function(){ji.updateDisplay(),controls.reset(),controls.target.set(0,0,0),camera.position.set(0,0,mi),Na(),ae()},openfile:function(){params.overridepel?myask(container,qa.unsaved,function(){Ys.click()}):Ys.click()},overridepel:!0,openfoto:function(){Ks.click()},makelab:function(){Z(Bs,qa.labtest,2),ji.updateDisplay()},dummy:function(){},apply:function(){Te()},applyP:function(){Ie()},qedit:function(){},editRQD:function(){rqdmenu(_i,container,Xa)},editJn:function(){jnmenu(_i,container,Xa)},editJr:function(){jrmenu(_i,container,Xa)},editJa:function(){jamenu(_i,container,Xa)},editJw:function(){jwmenu(_i,container,Xa)},editSRF:function(){srfmenu(_i,container,Xa)},removeq:function(){myask(container,qa.removeqmes,function(){Oe()})}},params.author=function(){return localStorage.getItem('lastauthor')?localStorage.getItem('lastauthor'):'none'}(),params.tunnel=gettunnel()?gettunnel():tunlist[0];var ji=new dat.GUI({autoPlace:!1});ji.domElement.id='guipos',ji.close(),container.appendChild(ji.domElement),Da('Line'),lasst=params.tunnel,myaddfunc.flip=function(){renderblock=1;var Ln=ht();Q();var Pn=picparams.ps;picparams.ps=picparams.pe,picparams.pe=Pn,fgui.updateDisplay(),saveifokdist(picparams.ps,picparams.pe),''==gl?oa(picparams.ps,picparams.pe):ia(picparams.ps,picparams.pe),Ln&&gt(),renderblock=0,ae(),Da('Line'),si.value='Select',fgui.close(),ji.close()},myaddfunc.openblank=function(){console.log('Oblank'),fgui.close(),myask(container,qa.unsaved,function(){getbypl(picparams.ps,picparams.pe)})};var Ai={showdb:function(){var Ln=function(){for(var En=0,Tn=0;Tn<newdb.files.length;Tn++)newdb.files[Tn].ischosen&&!newdb.files[Tn].toskip&&En++;if(En){if(params.overridepel){var On=getchosenpels(newdb),In=On[0],Bn=On[1];picparams.ps=In,picparams.pe=Bn,fgui.updateDisplay(),saveifokdist(picparams.ps,picparams.pe),oa(picparams.ps,picparams.pe)}var Gn=0;renderblock=1;for(var Nn,Tn=0;Tn<newdb.files.length;Tn++)Nn=newdb.files[Tn],Nn.ischosen&&!newdb.files[Tn].toskip&&(Gn++,Ra(Nn.savedata));Va(),allq.update(),renderblock=0,ae(),newdb.uncheckall(),Da('Line')}};dbtable(container,function(){params.ex?myask3(container,qa.openneworex,qa.opennew,function(){params.overridepel=!0,Ln(),ji.updateDisplay()},qa.opentoexisting,function(){params.overridepel=!1,Ln()}):(Ln(),ji.updateDisplay())})},showpicdb:function(){dbpictable(container,Li)},newblank:function(){ia(picparams.ps,picparams.pe)}};picparams.openf=function(){myask(container,qa.unsaved,function(){picdb.makefromfiles(function(){for(var Ln in picdb.sortbytime(),picdb.files)if(!picdb.files[Ln].toskip){picdb.files[Ln].ischosen=1;break}Li(1)})})};var Li=function(Ln){var Pn=getchosenpels(picdb);if(null!=Pn){var En=Pn[0],Tn=Pn[1],On=Pn[2];picparams.ps=En,picparams.pe=Tn,fgui.updateDisplay(),saveifokdist(picparams.ps,picparams.pe),console.log('Chosen are',picparams.ps,picparams.pe),Ln?getbypl(picparams.ps,picparams.pe):oa(picparams.ps,picparams.pe,On),Pt(),picdb.uncheckall()}},Pi=Ve(fgui),Ei=ba('Start!',function(){myaddfunc.openblank()});Ei.setAttribute('class','inguib but1gui aguibut'),Pi.appendChild(Ei);var Pi=Ve(fgui),Ei=ba('Flip pic',function(){myaddfunc.flip()});Ei.setAttribute('class','inguib but2gui'),Pi.appendChild(Ei),Ei=ba('Add 5m',function(){params.add5m()}),Ei.setAttribute('class','inguib but2gui'),Pi.appendChild(Ei);var Pi=Ve(fgui),Ei=ba('MWDdb',function(){Ai.showpicdb()});Ei.setAttribute('class','inguib but2gui aguibut'),Pi.appendChild(Ei),Ei=ba('Open geom',function(){picparams.openf()}),Ei.setAttribute('class','inguib but2gui aguibut'),Pi.appendChild(Ei);var Pi=Ve(fgui),Ei=ba('Go 2d',function(){params.go2d()});Ei.setAttribute('class','inguib but2gui'),Pi.appendChild(Ei),Ei=ba('Go 3d',function(){params.go3d()}),Ei.setAttribute('class','inguib but2gui'),Pi.appendChild(Ei),fgui.add(params,'tunnel',tunlist).name('Tunnel:').onChange(function(){savetunnel(params.tunnel),Pt()}),fgui.add(params,'vederlag').name(qa.showved).onChange(function(){Va(),ae()}),fgui.add(params,'rutenett').name(qa.rutenett).onChange(function(){bt(Sl,zl),ae()}),E(Sl,zl),bt(Sl,zl);var Ti=new THREE.TextureLoader;Ti.crossOrigin='anonymous';var Oi=Ti.load(spcline),Ii=Ti.load(spcline1,function(){Ii.wrapS=Ii.wrapT=THREE.RepeatWrapping,Ii.offset.set(0,0),Ii.repeat.set(1,1)}),Bi=Ti.load(spcline2,function(){Bi.wrapS=Bi.wrapT=THREE.RepeatWrapping,Bi.offset.set(0,0),Bi.repeat.set(1,1)}),Ni=new Aa,_i=new Ue,Wi=new Be;_i.getQ(),allq=new We,allp=new Ge;var Ui=chosenp=-2;ua(Sl,zl,-1);var Hi=0,Xi=new Hammer($s);$s.onclick=function(){if(Hi)return void(Hi=0);var Pn=0,En=ji.closed;'Line'==params.linetype&&(Pn=1),Da('Line'),D(this),Pn&&P(),En&&ji.close(),ji.removeFolder(qa.qval),ji.removeFolder(qa.setproperties),si.value='Select'},(iOS||android)&&Xi.on('press',function(){$s.click(),Hi=1,setTimeout(function(){Hi=0},250)}),Xi.get('press').set({threshold:100,time:3});var Yi=new Hammer(ei);ei.onclick=function(){return Hi?void(Hi=0):void(Da('Water'),si.value='Select',D(this))},(iOS||android)&&Yi.on('press',function(){ei.click(),Hi=1,setTimeout(function(){Hi=0},250)}),Yi.get('press').set({threshold:100,time:3});var Ki=new Hammer(ti);ti.onclick=function(){Da('Text'),si.value='Select',D(this)},(iOS||android)&&Ki.on('press',function(){ti.click(),Hi=1,setTimeout(function(){Hi=0},250)}),Ki.get('press').set({threshold:100,time:3});var Zi=new Hammer(li);li.onclick=function(){return Ql?void Wt():void(Da('Fall'),si.value='Select',D(this))},(iOS||android)&&Zi.on('press',function(){li.click(),Hi=1,setTimeout(function(){Hi=0},250)}),Zi.get('press').set({threshold:100,time:3});var $i=new Hammer(ii);ii.onclick=function(){android&&me(),si.value='Select',St()},$i.on('press',function(){android||(me(),si.value='Select',Hi=1,setTimeout(function(){Hi=0},250))}),$i.get('press').set({threshold:100,time:3});var en=0,tn=new Hammer(si);android&&(si.onclick=function(){en||ln(1)}),tn.on('press',function(){ln(0),en=1,setTimeout(function(){en=0},250)}),tn.get('press').set({threshold:100,time:3});var ln=function(){return'Select'==si.value?(si.value='Group',void Da('Select')):'One'==si.value?void(si.value='Group'):'Group'==si.value?void(si.value='One'):void 0};Ee();jl.children.length;document.addEventListener('keydown',function(Ln){switch(Ln.keyCode){case 65:break;case 66:break;case 67:break;case 68:}},!1),window.addEventListener('resize',pt,!1),window.addEventListener('orientationchange',pt,!1);var rn=null,dn=new Hammer(renderer.domElement),cn=lasty=-1e3,un=firsty=firstz=-1e3,hn=endy=-1e3;dn.on('press',function(Ln){ws=new Date().getTime(),R(Ln),Va()}),dn.on('pan',function(Ln){if('Line'==params.linetype){var Pn=(cn-Ln.center.x+ci)*(cn-Ln.center.x+ci)+(lasty-Ln.center.y+pi)*(lasty-Ln.center.y+pi);Pn>sensivity*sensivity&&R(Ln)}if('Select'==params.linetype){if(El)return;var Pn=(cn-Ln.center.x+ci)*(cn-Ln.center.x+ci)+(lasty-Ln.center.y+pi)*(lasty-Ln.center.y+pi),En=Ln.velocityX*Ln.velocityX+Ln.velocityY*Ln.velocityY;20<En&&(de(),El=1),params.move&&5>En&&(1e4<Pn||params.movestart)&&(R(Ln),params.movestart=!0)}'Bolt'==params.linetype&&R(Ln),'Fall'==params.linetype&&R(Ln)}),dn.on('panstart',function(){Tl=1,Ol=1,El=0,params.move=!0,params.movestart=!1,!Ql||controls.enableRotate}),dn.on('panend',function(){'Line'==params.linetype&&(Na(),ws=new Date().getTime()),params.move=!1,Va(),ae(),El=0,Tl=0,Ol=0,Ql}),dn.on('pinchstart',function(){clearTimeout(rn),rn=null,Na()}),M(dn);ae();var Ti=new THREE.TextureLoader;Ti.crossOrigin='anonymous';var mn=Ti.load(Vl.imdrop),yn=new THREE.SpriteMaterial({map:mn,color:16777215}),fn=Ti.load(Vl.fallMap),bn=Ti.load(Vl.fallMapA180),xn=Ti.load(Vl.fallMapF0),wn=Ti.load(imflask),kn=Ti.load(imphoto),Sn=new THREE.SpriteMaterial({map:wn}),zn=new THREE.SpriteMaterial({map:kn}),Fn=function(Ln,Pn){var En=document.createElement('a');'string'==typeof En.download?(document.body.appendChild(En),En.download=Pn,En.href=Ln,En.click(),document.body.removeChild(En)):location.replace(uri)};var qn=function(Ln,Pn){var En=new THREE.Vector3().subVectors(Pn,Ln),Tn=new THREE.Matrix4;Tn.lookAt(Ln,Pn,new THREE.Object3D().up);var On=new THREE.Matrix4;On.set(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),Tn.multiply(On);var In=new THREE.CylinderGeometry(0.1,0.1,En.multiplyScalar(0.3).length(),48,1),Bn=new THREE.Mesh(In,new THREE.MeshBasicMaterial({color:0}));Bn.applyMatrix(Tn);var Gn=new THREE.Vector3().addVectors(Ln,En.multiplyScalar(0.5));return Bn.position.set(Gn.x,Gn.y,Gn.z),Bn},Dn=function(Ln,Pn){var En,Tn,On,In,Bn,Gn,Nn,_n,Wn,Un,Hn,Xn,Yn,Kn;for(Yn=[],Nn=Ln.geometry.faceVertexUvs[0],_n=Ln.geometry.faces,Wn=Ln.geometry.vertices,Un=new THREE.Matrix4,Hn=new THREE.Matrix4,Kn=new THREE.Matrix4,Ss.updateMatrixWorld(!0),In=0;In<Nn.length;In++)if(Bn=Nn[In],Gn=_n[In],et(Bn,Pn)){En=Wn[Gn.a].clone().applyMatrix4(Ln.matrixWorld),Tn=Wn[Gn.b].clone().applyMatrix4(Ln.matrixWorld),On=Wn[Gn.c].clone().applyMatrix4(Ln.matrixWorld),Un.set(En.x,En.y,En.z,0,Tn.x,Tn.y,Tn.z,0,On.x,On.y,On.z,0,0,0,0,1),Hn.set(Bn[0].x,Bn[0].y,0,1,Bn[1].x,Bn[1].y,0,1,Bn[2].x,Bn[2].y,0,1,0,0,1,0),Hn.getInverse(Hn),Un.multiplyMatrices(Hn,Un),Un.elements=Ke(Un),Un.transpose(),Xn=new THREE.Vector3(Pn.x,Pn.y,1);var Zn=Xn.applyMatrix4(Un);Yn.push(Zn),Yn.push(Gn.normal)}return Yn};check3dbox.onchange=function(){controls.enableRotate=check3dbox.checked,ji.updateDisplay()},syncfun=function(Pn,En){var Tn=function(){putdbf(Pn),wl=getsessionid()},On=function(){mt.end('Merging'),newdb.syncall(),Tn()},In=function(Gn){mt.start('Merging'),syncbtn.textContent='Merge start',newdb.wipeold(function(){newdb.mergewithstring(Gn,On)})};getver(function(Gn){var Nn=Gn[0];console.log('localver=',newdb.getsid(),'onlinever',Nn);var _n=!0;for(var Wn in newdb.files)_n=_n&&newdb.files[Wn].issynced;syncbtn.textContent='Got versions',newdb.getsid()!=Nn||!_n||params.forcesync?(syncbtn.textContent=newdb.getsid()+' '+Nn,getdbf(In)):(console.log('Version is up to date'),syncbtn.textContent='Version is up to date',null!=En&&En())})};getbypl=function(Pn,En){var Tn=normPel(Pn,En),On=Tn[0],In=Tn[1],Bn=On,Gn=In,Nn=newdb.sorted;newdb.sortbypelasc();var _n=[],Wn=JSON.parse(JSON.stringify(newdb.files));for(var Un in Wn){var Hn=Wn[Un];if(!Hn.toskip){var Xn=normPel(Hn.ps,Hn.pe);numintersect(On,In,Xn[0],Xn[1])&&(Bn=Math.min(Bn,On,In,Xn[0],Xn[1]),Gn=Math.max(Gn,On,In,Xn[0],Xn[1]),_n.push(Hn.savedata))}}for(var Un in newdb.sortbytime(),oa(Bn,Gn),renderblock=1,_n)Ra(_n[Un]);Va(),allq.update(),renderblock=0,ae()};var Vn,Cn;Pt();var Rn=[],Jn=1,jn,An;cutpels=function(){params.onlycurpel=!0;var Ln=Ia();Q(),Ra(Ln),Va(),allq.update(),ae(),params.onlycurpel=!1},disassemble=function(){var Ln=Ia();console.log('Sids are',Ln.sids);var Pn=[];for(var En in Ln.sids)Pn.push(En);for(var Tn in Pn)params.onlynew=parseInt(Pn[Tn]),Tn==Pn.length-1?le(1):le(1,1);params.onlynew=0,se()},dat.GUI.prototype.removeFolder=function(Ln){var Pn=this.__folders[Ln];Pn&&(Pn.close(),this.__ul.removeChild(Pn.domElement.parentNode),delete this.__folders[Ln],this.onResize())},S.callback(),picdb.ldb(function(){oa(picparams.ps,picparams.pe,params.tunnel)})}