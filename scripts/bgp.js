function bevgeoplot(h,S){function F(){mi=document.getElementById(h).offsetWidth,yi=document.getElementById(h).offsetHeight}function M(Hn){var Xn=Hn.add(bf,'blank').name('').__li;Xn.setAttribute('class','cr function mydum')}function V(){}function Q(Hn){Hn.get('tap').set({threshold:1,posThreshold:1,time:1,interval:2}),Hn.get('press').set({threshold:50,time:3}),Hn.get('pan').set({threshold:sensivity,time:4,direction:Hammer.DIRECTION_ALL}),Hn.get('pinch').set({enable:!0})}function C(Hn,Xn){var Yn=null==Xn?Il:Xn;if(null==Hn)return console.log('Null object!'),null;for(var Kn,Zn=0;Zn<Yn.children.length;Zn++)if(Yn.children[Zn].uuid==Hn){Kn=Yn.children[Zn];break}return Kn}function R(Hn,Xn){var Yn=document.getElementsByClassName('close-button close-bottom'),Kn=null==Xn?0:1;Yn[Kn].innerHTML=Hn}function L(){line3dtemp.children.length=0,line3dgroup.children.length=0,fallar.children.length=0,Js.visible=!1,es=yp=zp=-1e3,wn=-1e3,renderblock=1;for(var Hn=0;Hn<oman.ao.length;Hn++)oman.removefromscene(oman.get(Hn));ss=[],oman=new J,za(),allp=new He,allq=new Ke,H(),allq.update(),renderblock=0,re()}function J(){this.ao=ss,this.history=[],this.sid=Ql,this.so=null,this.sp=null,this.selidx=null,this.changelist={},this.updchangelist=function(Hn){this.changelist[Hn]=Ql},this.select=function(Hn,Xn){this.so=null,this.sp=null,this.selidx=null;var Yn=qe(Hn,Xn);if(Yn[3]>Math.sqrt(ei*ei+Zs*Zs)/7)return console.log('Nothing selected'),[null,null];var Kn=Yn[0];return this.selidx=Kn,this.so=this.get(Kn),this.so||console.log('No object selected'),this.sp=allp.par[Te(Kn)],this.sp||console.log('No property selected'),Ps.visible=!!this.so,[this.so,this.sp]},this.get=function(Hn){var Xn=this.ao[Hn];return null==Xn?(console.log('No object ',Hn),null):Xn},this.add=function(Hn){this.ao.push(Hn)},this.undo=function(){var Hn=this.history.pop();return Hn?void('add'==Hn[0]&&(this.removefromscene(Hn[1]),this.history.pop()),'remove'==Hn[0]&&(this.plot(Hn[1]),this.history.pop()),'removeSequence'==Hn[0]&&(this.plot(Hn[1]),this.history.pop(),'removeSequence'==this.history[this.history.length-1][0]&&this.undo()),'movefrom'==Hn[0]&&this.move(Hn[1],Hn[2],Hn[3]),H(),re()):void console.log('No history elements')},this.move=function(Hn,Xn,Yn){if(null==Hn)return void console.log('Trying to move null object');var Kn=C(Hn.id,'B'==Hn.type?Os:null);if(Kn){var Zn=Xn-Hn.xs,$n=Yn-Hn.ys;Kn.position.x+=Zn,Kn.position.y+=$n,params.movestart||this.history.push(['movefrom',Hn,Hn.xs,Hn.ys]),Hn.xs=Xn,Hn.ys=Yn,Ps.visible=!0,Ps.position.set(Xn,Yn,10),this.updchangelist(Hn.sid)}},this.erasefromhistory=function(Hn){for(var Xn=0;Xn<this.history.length;Xn)this.history[Xn][1].sameas(Hn)?this.history.splice(Xn,1):Xn++},this.removefromscene=function(Hn,Xn){if(1==Hn.skip)return!1;if('L'==Hn.type)return Hn.skip=1,Xn?this.history.push(['removeSequence',Hn]):this.history.push(['remove',Hn]),renderblock||this.updchangelist(Hn.sid),!0;var Yn=C(Hn.id,'B'==Hn.type?Os:null);return null==Yn?(console.log('No such object on scene',Hn),!1):('B'==Hn.type?Os.remove(Yn):Il.remove(Yn),this.history.push(['remove',Hn]),re(),Hn.skip=1,renderblock||this.updchangelist(Hn.sid),!0)},this.isdublicate=function(Hn){for(var Yn,Xn=0;Xn<this.ao.length;Xn++)Yn=this.get(Xn),Yn.sameas(Hn)&&(this.removefromscene(Yn),this.erasefromhistory(Hn))},this.plot=function(Hn){if('L'==Hn.type)return Hn.skip=0,void this.history.push(['add',Hn]);var Xn;'W'==Hn.type&&(Xn=$(Hn.xs,Hn.ys,Hn.zs,Hn.size)),'F'==Hn.type&&(Xn=oe(Hn.xs,Hn.ys,Hn.zs,Hn.angle,Hn.fall,Hn.size),''!=Hn.color&&Ut(Hn.color)),'T'==Hn.type&&(Xn=ee(Hn.text,Hn.xs,Hn.ys,Hn.zs,1- -Hn.fall)),'B'==Hn.type&&(Xn=N(Hn.xs,Hn.ys,Hn.zs,Hn.xe,Hn.ye,Hn.ze),Fs=[Xn,Hn],Os.add(Xn));Xn&&(Xn.name=ss.length,Hn.id=Xn.uuid,Hn.skip=0,this.history.push(['add',Hn]),'B'!=Hn.type&&Il.add(Xn),re())}}function P(Hn){!0==controls.enableRotate||((!params.move||'Line'==params.linetype)&&(bn=Hn.center.x-Fi,lasty=Hn.center.y-zi),Gl.x=2*((Hn.center.x-Fi)/mi)-1,Gl.y=2*-((Hn.center.y-zi)/yi)+1,El?A():T())}function A(){fcp=1,Bl.setFromCamera(Gl,camera);var Hn=Bl.intersectObjects(meshes.children);if(0<Hn.length){var Xn=new Ga;Xn.sid=Ql;var Yn=mr(es),Kn=mr(yp),Zn=mr(zp),$n=mr(as),eo=mr(yp2d),to=mr(Hn[0].point.x),ao=mr(Hn[0].point.y),lo=mr(Hn[0].point.z),no=mr(2*(Hn[0].uv.x-0.5)*Zs),oo=mr(2*(Hn[0].uv.y-0.5)*ei);if(-1e3<es){var po=params.lineStyle==qa.lineStylear[0]?0:params.lineStyle==qa.lineStylear[1]?1:params.lineStyle==qa.lineStylear[2]?2:3,co=po+params.color,uo=Y(Yn,Kn,Zn,to,ao,lo,Math.round(40*params.size),params.color);if(2==Hn.length){var ho=mr(2*(Hn[1].uv.x-0.5)*Zs),go=mr(2*(Hn[1].uv.y-0.5)*ei),mo={xs:ho,ys:go,v:new THREE.Vector3(Hn[1].point.x,Hn[1].point.y,Hn[1].point.z)};linez.push(mo)}var mo={xs:$n,ys:eo,v:new THREE.Vector3(Yn,Kn,Zn)};linez.push(mo),line3dtemp.add(uo)}es=to,yp=ao,zp=lo,as=no,yp2d=oo,zp2d=lo}re()}function E(Hn){return Math.min(Zs,Math.max(Hn,-Zs))}function T(){fcp=1,Bl.setFromCamera(Gl,camera);var Hn=Bl.intersectObjects(ls);if(0<Hn.length){var Xn=new Ga;Xn.sid=Ql;var Yn=mr(es),Kn=mr(yp),Zn=mr(zp),$n=mr(Hn[0].point.x),eo=mr(Hn[0].point.y),to=mr(Hn[0].point.z);if(!El&&!params.move&&$n<-Zs&&'Select'==params.linetype)return Ie(eo),Be(),void re();if('Line'==params.linetype){if(Yn=E(Yn),$n=E($n),-1e3<es){Js.visible=!0,Js.position.set($n,eo,10);var ao=params.lineStyle==qa.lineStylear[0]?0:params.lineStyle==qa.lineStylear[1]?1:params.lineStyle==qa.lineStylear[2]?2:3,lo=ao+params.color,no=0,oo=($n-Yn)*no,co=Y(Yn,Kn,Zn,$n+oo,eo+(eo-Kn)*no,to+params.layer+1,Math.round(30*params.size),params.color);co.name=ss.length,Xn.addline(Yn,Kn,Zn,$n,eo,to+params.layer+1,Math.round(30*params.size),lo),oman.plot(Xn),oman.add(Xn),Es.add(co),wn=$n,endy=eo}else xn=$n,firsty=eo,firstz=to;Js.visible=!0,Js.position.set($n,eo,10),es=$n,yp=eo,zp=to+params.layer+1}if('Bolt'==params.linetype&&$n>=-Zs&&$n<=Zs)if(!Wl)Xn.addbolt($n,eo,to+7,$n,eo,to+7,params.bolttype),oman.plot(Xn),oman.add(Xn);else{U($n,eo,to+7);var uo=oman.get(ss.length-1);uo.xe=us.vertices[1].x,uo.ye=us.vertices[1].y,uo.ze=us.vertices[1].z}if('Fall'==params.linetype&&$n>=-Zs&&$n<=Zs&&(Ul?0!=params.fall&&$a($n,eo,to+7):(Xn.addfall($n,eo,to+7,params.angle,params.fall,Rl<Ll),oman.plot(Xn),oman.add(Xn))),'Water'==params.linetype&&$n>=-Zs&&$n<=Zs&&(Xn.addwater($n,eo,to+7,Math.round(10*params.wsize)/10),oman.plot(Xn),oman.add(Xn)),'Text'==params.linetype&&$n>=-Zs&&$n<=Zs&&''!=params.text&&(Xn.addtext(params.text,$n,eo,to+params.layer+1),oman.plot(Xn),oman.add(Xn)),'Select'==params.linetype&&$n>=-Zs&&$n<=Zs)if(!params.move){oman.select($n,eo);var ho=qe($n,eo);if(ho[3]>Math.sqrt(ei*ei+Zs*Zs)/7)return;Ps.visible=!0,Ps.position.set(ho[1],ho[2],10),Xs=ho[0],Ee(Xs)}else if(oman.so){var go=$n-0.1*Zs/camera.zoom,mo=eo+0.1*ei/camera.zoom;oman.move(oman.get(Xs),go,mo)}}else'Select'==params.linetype?params.move&&fe():(Za(),Ps.visible=!1);re()}function O(){if(-1e3<wn){var Hn=new Ga;Hn.sid=Ql;var Xn=params.lineStyle==qa.lineStylear[0]?0:params.lineStyle==qa.lineStylear[1]?1:params.lineStyle==qa.lineStylear[2]?2:3;if(0<Xn)return void(wn=endy=xn=firsty=firstz=-1e3);var Yn=Xn+params.color;Hn.addline(wn,endy,firstz+params.layer+1,xn,firsty,firstz+params.layer+1,Math.round(30*params.size),Yn),oman.plot(Hn),oman.add(Hn),wn=endy=xn=firsty=firstz=-1e3,H(),re()}}function I(Hn,Xn,Yn){var Kn=new THREE.LineSegmentsGeometry;Kn.setPositions(Hn);var Zn=new THREE.LineMaterial({color:0,linewidth:Xn,dashed:!1}),$n=renderer.getSize();Zn.resolution.set($n.width,$n.height);var eo=new THREE.LineSegments2(Kn,Zn);return null==Yn&&Ts.add(eo),eo}function B(Hn,Xn,Yn){Il.remove(Is);var Kn=[],$n=0.1*si;Is=new THREE.Object3D;var eo=-ei,to=ei,ao=1.13*Zs,lo=1.067*Zs;Kn.push(ao,eo,0,ao,to,0);var no={val:15},oo=ee(Hn,ao+0.11*Zs,eo+$n,0,0,gl);Is.add(oo),Kn.push(ao,eo,0,lo,eo,0),Kn.push(ao,eo,0,lo,eo,0);var po=ee(Xn,ao+0.11*Zs,to-$n,0,0,gl);Is.add(po),Kn.push(ao,to,0,lo,to,0,-ao,to,10,-lo,to,10);for(var co=1;co<pmult*(Xn-Hn)/5;++co){var uo=-ei+5*(pmult*co*(to-eo))/(Xn-Hn),ho=5*pmult*co+parseInt(Hn),go=ee(ho,ao+0.11*Zs,uo,0,0,gl);Is.add(go),Kn.push(ao,uo,0,lo,uo,0,-ao,uo,10,-lo,uo,10)}Is.add(I(Kn,2,1));var mo=normPel(Hn,Xn);if(100<mo[1]-mo[0])for(var co=mo[0]-1;co<=mo[1];co++)if(0==co%100){fcp=1;var yo=ee(co,4*Zs,Na(co),no,0,gl);Is.add(yo),fcp=0}if(null!=Yn){Is.position.set(0,Yn,0)}Il.add(Is)}function N(Hn,Xn,Yn,Kn,Zn,$n){var eo=new THREE.Object3D,to=0.07,ao=Y(Hn+to,Xn+to,Yn,Hn-to,Xn-to,Yn-0.01,2,'#000000'),lo=Y(Hn-to,Xn+to,Yn,Hn+to,Xn-to,Yn-0.01,2,'#000000'),no=el(Hn,Xn,Yn,2*(to/Math.sqrt(2)),2,'#000000');return Ds=W(Hn,Xn,Yn,Kn,Zn,$n,1,'#000000'),eo.add(ao),eo.add(lo),eo.add(no),eo.add(Ds),eo}function _(){return 1/2e3}function W(Hn,Xn,Yn,Kn,Zn,$n,eo,to){us=new THREE.Geometry,ms=new THREE.Vector3(Hn,Xn,Yn),us.vertices.push(ms),us.vertices.push(new THREE.Vector3(Kn,Zn,$n));return X([Hn,Xn,Yn,Kn,Zn,$n],10,to)}function U(Hn,Xn,Yn){var Kn=(ms.x-Hn)*(ms.x-Hn)+(ms.y-Xn)*(ms.y-Xn),Zn=2*(Jl/Ks),$n=params.boltlen*Math.sin(Math.PI/24);if(Kn=Math.sqrt(Kn)/Zn,Kn<$n)Fs[0].remove(Ds),Ds=W(ms.x,ms.y,ms.z,Hn,Xn,Yn,1,'#000000'),Fs[0].add(Ds),Fs[1].xe=Hn,Fs[1].ye=Xn,Fs[1].ze=Yn;else{var to,ao;to=ms.x+(Hn-ms.x)/Kn*$n,ao=ms.y+(Xn-ms.y)/Kn*$n,Fs[0].remove(Ds),Ds=W(ms.x,ms.y,ms.z,to,ao,Yn,1,'#000000'),Fs[0].add(Ds),Fs[1].xe=to,Fs[1].ye=ao,Fs[1].ze=Yn}}function H(){Fa(),zt();for(var Hn=[],Xn=0;Xn<ss.length;Xn++)0==ss[Xn].skip&&Hn.push(ss[Xn]);for(var Zn,$n,Yn=yprev=cprev=sprev=-1e3,Kn=[],eo=[1],to=[],Xn=0;Xn<Hn.length;Xn++)if('L'==Hn[Xn].type){if(Yn==Hn[Xn].xs&&yprev==Hn[Xn].ys&&cprev==Hn[Xn].color&&sprev==Hn[Xn].size){var ao=[Hn[Xn].xe,Hn[Xn].ye,Hn[Xn].zs];Yn=Hn[Xn].xe,yprev=Hn[Xn].ye,Kn.push(ao[0],ao[1],ao[2])}else'0'==eo[0]||'#'==eo[0]||X(Kn,$n,Zn),Yn=Hn[Xn].xe,yprev=Hn[Xn].ye,cprev=Hn[Xn].color,sprev=Hn[Xn].size,Kn=[Hn[Xn].xs,Hn[Xn].ys,Hn[Xn].zs,Yn,yprev,Hn[Xn].zs],Zn=Hn[Xn].color,$n=Hn[Xn].size,eo=Zn+'';('0'==eo[0]||'#'==eo[0])&&to.push(Hn[Xn].xs,Hn[Xn].ys,Hn[Xn].zs,Hn[Xn].xe,Hn[Xn].ye,Hn[Xn].ze)}'0'==eo[0]||'#'==eo[0]||X(Kn,$n,Zn),I(to,5)}function X(Hn,Xn,Yn,Kn){if(0!=Hn.length){var Zn=Yn+'',$n=0;if(7<Zn.length&&($n=Zn[0],Zn=Zn.slice(1,8)),0<$n){var eo=K(Hn,Xn,Yn,Kn);return eo}var to=Math.abs(Xn),ao=new THREE.LineGeometry;ao.setPositions(Hn);var lo=new THREE.LineMaterial({color:0,linewidth:to/3,dashed:!1}),no=renderer.getSize();lo.resolution.set(no.width,no.height);var eo=new THREE.LineSegments2(ao,lo);return null==Kn&&Ts.add(eo),eo}}function Y(Hn,Xn,Yn,Kn,Zn,$n,eo,to){var ao=new Float32Array(6);ao[0]=Hn,ao[1]=Xn,ao[2]=Yn,ao[3]=Kn,ao[4]=Zn,ao[5]=$n;var lo=X(ao,eo,to,1);return lo}function K(Hn,Xn,Yn,Kn){if(0!=Hn.length){var Zn=Hn.length,$n=Yn+'',eo=0;7<$n.length&&(eo=$n[0],$n=$n.slice(1,8));for(var to=0,ao=3;ao<Zn;ao+=3)to+=Math.sqrt((Hn[ao]-Hn[ao-3])*(Hn[ao]-Hn[ao-3])+(Hn[ao+1]-Hn[ao-2])*(Hn[ao+1]-Hn[ao-2]));var lo=new Float32Array(Zn);iOS&&(lo=new Float32Array(2*Zn-3));for(var ao=0;ao<Hn.length;ao++)lo[ao]=Hn[ao];if(iOS)for(var oo,ao=0;ao<Zn-3;ao+=3)oo=2*Zn-3-ao-3,lo[oo]=Hn[ao],lo[oo+1]=Hn[ao+1],lo[oo+2]=Hn[ao+2];var po=new THREE.Color($n),co=Math.abs(Xn)*_(),uo=new MeshLineMaterial({color:po,lineWidth:co*lsc,useMap:!1,transparent:!!(0>Xn),opacity:0>Xn?0.6:1,resolution:fi});if(1==eo)var uo=new MeshLineMaterial({color:po,lineWidth:co*lsc,useMap:!1,useAlphaMap:1,transparent:!0,alphaMap:Ui,resolution:fi});if(2==eo){var ho=Math.round(1.5*to);ho=1>ho?1:ho;var uo=new MeshLineMaterial({color:po,lineWidth:co*lsc,useMap:!1,useAlphaMap:1,repeat:new THREE.Vector2(ho,1),transparent:!0,alphaMap:Hi,resolution:fi})}if(3==eo){var ho=Math.round(to);po=new THREE.Color('#aaaaaa'),ho=1>ho?1:ho;var uo=new MeshLineMaterial({color:po,lineWidth:1.5*(co*lsc),useMap:!0,map:Xi,useAlphaMap:1,repeat:new THREE.Vector2(ho,1),transparent:!0,alphaMap:Xi,resolution:fi})}var go=new MeshLine;go.setGeometry(lo);var mo=new THREE.Mesh(go.geometry,uo);return null==Kn&&Ts.add(mo),mo}}function Z(Hn,Xn){var Yn=new THREE.Sprite;return Yn.position.set(Hn,Xn,2),Yn.scale.set(0.4,0.4,0.4),Yn}function $(Hn,Xn,Yn,Kn){var Zn=new THREE.Sprite(zn);return Zn.position.set(Hn,Xn,Yn),Zn.scale.x=Zn.scale.y=Kn*si,Zn}function ee(Hn,Xn,Yn,Kn,Zn,$n){var eo=10,to=new THREE.Object3D,ao=sl(Hn,$n,Kn);if(ao.position.set(Xn+0.1,Yn-0.05,eo/5),to.add(ao),Zn){ao.position.set(Xn+0.35,Yn-0.2,eo/5);var lo=0.07,no=Y(-lo,-lo,10,lo,lo,10,eo/5,'#000000'),oo=Y(lo,-lo,10,-lo,lo,10,eo/5,'#000000');no.position.set(Xn,Yn,0),oo.position.set(Xn,Yn,0);var po=Z(Xn+0.35,Yn+0.12);po.visible=!1,to.add(no),to.add(oo),to.add(po),2==Zn&&(po.material=Cn,po.visible=!0,console.log('photo added')),3==Zn&&(po.material=Qn,po.visible=!0,console.log('labtest added'))}return to}function ae(Hn){var Xn=new FileReader;Xn.onloadend=function(Yn){var Kn=Rl;Ae()&&(Kn=Math.round(_a(ss[Xs].ys)));var Zn=new Date,$n='';$n='pic_'+Kn+'_'+Zn.getMinutes()+'m'+Zn.getSeconds()+'s',Ln(Yn.target.result,$n+'.jpg'),se(Xs,$n,1),Ii.updateDisplay()},Xn.readAsDataURL(Hn.files[0])}function se(Hn,Xn,Yn){var Kn=ss[Hn];if('T'!=Ae(Hn))return void console.log('not T');var Zn=Il.getObjectByName(Hn),$n=Zn.children[0];$n.redrawInterval=1,Zn.children[0].material.map.text=''+Xn,Kn.text=Xn,oman.updchangelist(Kn.sid),null!=Yn&&(1==Yn&&(Kn.fall=1,Zn.children[3].material=Cn),2==Yn&&(Kn.fall=2,Zn.children[3].material=Qn),Zn.children[3].visible=1),re(),setTimeout(function(){$n.redrawInterval=1e8,re()},1)}function ie(Hn,Xn,Yn){var Kn=ss[Hn];if('F'!=Ae(Hn))return void console.log('not F');var Zn=Kn.size&&Rl<Ll?Yn:360-Yn,$n=Il.getObjectByName(Hn),eo=$n.children[1].children[0];eo.redrawInterval=1,0!=Xn&&90!=Xn&&($n.children[1].children[0].material.map.text=''+Xn),$n.children[0].material.rotation=Math.round(1e3*(-Math.PI/180*Zn))/1e3,0==Xn&&($n.children[0].material.map=Dn,$n.children[1].children[0].material.map.text='',$n.children[0].material.rotation=0),90==Xn&&($n.children[0].material.map=qn,$n.children[1].children[0].material.map.text=''),0!=Xn&&90!=Xn&&($n.children[0].material.map=Fn),Kn.fall=parseInt(Xn),Kn.angle=parseInt(Yn),oman.updchangelist(Kn.sid),re(),setTimeout(function(){eo.redrawInterval=1e8,re()},50)}function oe(Hn,Xn,Yn,Kn,Zn,$n){var eo=$n==Rl<Ll?Kn:360-Kn,to='',ao=new THREE.Object3D;if(0!=Zn&&90!=Zn){fs=new THREE.SpriteMaterial({map:Fn,color:16777215,rotation:-Math.PI/180*eo});var lo=new THREE.Sprite(fs);to=Zn+''}if(0==Zn)var no=new THREE.SpriteMaterial({map:Dn,color:16777215}),lo=new THREE.Sprite(no);if(90==Zn){fs=new THREE.SpriteMaterial({map:qn,color:16777215,rotation:-Math.PI/180*eo});var lo=new THREE.Sprite(fs)}lo.position.set(Hn,Xn,Yn),lo.scale.x=lo.scale.y=0.4*si;var oo=ee(to,Hn+0.25*li,Xn-0.12*si,Yn,0);return ao.add(lo),ao.add(oo),ao}function re(Hn,Xn){renderblock||(Rn=0,mt.start('render'),requestAnimationFrame(function(){if(null==Hn&&controls.update(),El?renderer.render(Rs,camera):null==Xn?renderer.render(Il,camera):renderer.render(Xn,camera),null==Hn&&(1==rendebug&&console.log('r'),2==rendebug)){var Yn=re.caller;console.log(Yn)}if(Rn=1,'debug1'==params.author){var Kn=mt.end('render');R('FPS '+Math.round(1e3/Kn))}}))}function de(Hn,Xn){var Yn=Xa();if(!Yn)return void console.log('Nothing to save');var Kn=JSON.stringify(Yn),Zn=getpelrange(Kn,picparams.ps,picparams.pe);params.textsave=Kn,Ii.updateDisplay();var $n=new Date,eo='',to=getauthorandsid(Yn);eo='pel'+Zn[0]+'_'+Zn[1]+'\''+params.tunnel+'\''+to.author+shortsid(to.sid)+'.txt';var ao={name:eo,size:Kn.length,content:Kn},lo=elemfromfile(ao),no=function(uo){dbputreg(uo,function(){null==Xn&&(newdb.ldb(),allq.update())})};console.log('Attempt to add new file to db',lo);var oo=newdb.comparef(lo);if(oo){console.log('File already exists in db',oo);var po=lo.savedata,co=oo.savedata;comparesave(po,co)?console.log('Files are same, not saving'):(console.log('Adding because files are different'),no(lo))}else console.log('Adding new file to db',lo),no(lo);ue(Hn)}function ue(){var Xn=Xa(1);if(!Xn)return void console.log('Nothing to save');var Yn=JSON.stringify(Xn),Kn=getpelrange(Yn,picparams.ps,picparams.pe);params.textsave=Yn,Ii.updateDisplay();var Zn=new Date,$n='',eo=getauthorandsid(Xn);$n='pel'+Kn[0]+'_'+Kn[1]+'\''+params.tunnel+'\''+eo.author+shortsid(eo.sid)+'.txt';({name:$n,size:Yn.length,content:Yn})}function ge(Hn,Xn){params.withbg||(As.visible=!1),dt();var Yn=new THREE.Scene;Yn.add(Hs),re(null,Yn),console.log('start save as image'),me(function(Kn){Il.add(Hs),re(),me(Hn,Kn),As.visible=!0,ft(),H(),re(),null!=Xn&&(params.what2plot='Geo+Q+Pel')},1)}function me(Hn,Xn){var Yn,Zn=window.devicePixelRatio;try{Yn=renderer.domElement.toDataURL('image/png');var eo=new Image,to='For 3d'==params.what2plot?1:0,ao='Only texture'==params.what2plot?1:0;eo.onload=function(){var no=document.createElement('canvas');no.width=ao?2*Ol:Tl,no.height=ao?2*Ol:Ol,no.width*=Zn,no.height*=Zn,no.visible=0;var oo=no.getContext('2d');oo.drawImage(eo,0,0);var po=oo.getImageData(0,0,no.width,no.height),co=po.data,uo=co.length,ho=[];if(null!=Xn&&!Array.isArray(Xn))for(var go=0;go<uo;go+=4)if(208==co[go]&&208==co[go+1]&&208==co[go+2]);else ho.push(go);if(null!=Xn&&!Array.isArray(Xn))return void Hn(ho);if(!params.withbg){for(var go=0;go<uo;go+=4)208==co[go]&&208==co[go+1]&&208==co[go+2]&&(co[go+3]=0);if(Array.isArray(Xn))for(var go=0;go<Xn.length;go++)co[Xn[go]+3]=100}console.log('done pic'),po.data=co,oo.putImageData(po,0,0);var mo=document.createElement('canvas');mo.visible=0;var yo=oo.getImageData(Ol,0,Ol+Tl,Ol);mo.width=Ol,mo.height=Tl;var fo=mo.getContext('2d');if(fo.putImageData(yo,0,0),Yn=ao?mo.toDataURL():no.toDataURL(),Dl=Yn,console.log('tmp pic saved'),void 0!==Hn)return wl=Yn,void Hn();if(!to){var bo=new Date,vo='';vo=vo+'geo'+bo.getHours()+'h'+bo.getMinutes()+'m'+bo.getSeconds()+'s.png',Ln(Yn,vo)}},eo.src=Yn}catch(no){return void console.log(no)}}function fe(){if(!_l){var Hn=Ae();Hn&&('L'==Hn?myask(container,'Remove line?',function(){be(),wn=-1e3,H(),re()}):(be(),H(),re()))}}function be(){if(oman.so){allp.remove(oman.sp);var Hn=[];if(Hn=we(oman.selidx),'Group'==hi.value&&1<Hn.length)for(var Xn=0;Xn<Hn.length;Xn++)oman.removefromscene(oman.get(Hn[Xn]),1);else oman.removefromscene(oman.so);Ps.visible=!1,oman.so=null,oman.selidx=null}}function we(Hn){for(var Xn=[Hn],Yn=Hn-1;0<=Yn&&1!=ss[Yn].skip&&ss[Yn].xe==ss[Yn+1].xs&&ss[Yn].ye==ss[Yn+1].ys;Yn--)Xn.push(Yn);for(var Yn=Hn+1;Yn<ss.length&&1!=ss[Yn].skip&&ss[Yn-1].xe==ss[Yn].xs&&ss[Yn-1].ye==ss[Yn].ys;Yn++)Xn.push(Yn);return Xn.sort((Kn,Zn)=>Kn-Zn),Xn}function Se(Hn){var Xn=[];if(-1==Hn[0])return Xn;for(var Kn,Yn=0;Yn<Hn.length;Yn++)Kn=Hn[Yn],0==Yn&&(Xn.push(ss[Kn].xs),Xn.push(ss[Kn].ys)),Xn.push(ss[Kn].xe),Xn.push(ss[Kn].ye);return Xn}function ke(){oman.undo(),H(),gi.setAttribute('class','geobutton1'),setTimeout(function(){gi.setAttribute('class','geobutton')},200)}function Fe(){this.tunnel='',this.zeropel=0,this.pelperunit=1,this.pelstart=0,this.pelend=20,this.qval={},this.pval={},this.pw=Zs,this.author='V',this.sid=Ql,this.lastchange=0,this.objdata=[]}function qe(Hn,Xn){for(var Yn=ss.length,Kn=1e3,Zn=-1,$n=-20,eo=-20,to=1,ao=0;ao<Yn;ao++)if(!ss[ao].skip){to=1;var lo=ss[ao].xs,no=ss[ao].ys,oo=(Hn-lo)*(Hn-lo)+(Xn-no)*(Xn-no);if('L'==ss[ao].type){var po=De(ss[ao],Hn,Xn);oo=po[0],lo=po[2],no=po[3],(0>po[1]||1<po[1])&&(to=0)}Kn>=oo&&to&&(Kn=oo,Zn=ao,$n=lo,eo=no)}return[Zn,$n,eo,Math.sqrt(Kn)]}function De(Hn,Xn,Yn){var Kn=Hn.xs,Zn=Hn.xe,$n=Hn.ys,eo=Hn.ye,to=Math.sqrt((Zn-Kn)*(Zn-Kn)+(eo-$n)*(eo-$n)),no=[0,1,2,3,4],po=((Zn-Kn)*(Xn-Kn)+(eo-$n)*(Yn-$n))/to/to,co=Kn+po*to*((Zn-Kn)/to),uo=$n+po*to*((eo-$n)/to),ho=Math.sqrt((Xn-Kn)*(Xn-Kn)+(Yn-$n)*(Yn-$n)),go=Math.sqrt((Xn-Zn)*(Xn-Zn)+(Yn-eo)*(Yn-eo)),mo=Math.sqrt((Xn-co)*(Xn-co)+(Yn-uo)*(Yn-uo));return no[0]=Math.sqrt((Xn-co)*(Xn-co)+(Yn-uo)*(Yn-uo)),Me(po)||(no[0]=Math.min(ho,go)),no[1]=po,no[2]=co,no[3]=uo,no[4]=0,0>=(Zn-Kn)*(Yn-$n)-(eo-$n)*(Xn-Kn)&&(no[4]=1),no}function Me(Hn){return 0<=Hn&&1>=Hn}function Ve(){localStorage.setItem('lastauthor',params.author)}function Ce(Hn){return': -1??'==Hn?'':Hn}function Re(Hn,Xn,Yn){Xn.value=Hn+Ce(': '+Yn),'-1??'!=Yn&&Xn.setAttribute('class','inguib aguibut')}function Le(){Re('RQD',Ti.rqd,Zi.RQD+Zi.RQDc),Re('Jn',Ti.Jn,Zi.Jn+Zi.Jnc),Re('Jr',Ti.Jr,Zi.Jr+Zi.Jrc),Re('Ja',Ti.Ja,Zi.Ja+Zi.Jac),Re('Jw',Ti.Jw,Zi.Jw+Zi.Jwc),Re('SRF',Ti.SRF,Zi.SRF+Zi.SRFc),Zi.getQ(),'????'==Zi.Q+Zi.class?Ti.Q.name('Q = ?'):Ti.Q.name('Q = '+Zi.Q+Zi.class),Ii.updateDisplay()}function je(Hn,Xn){var Yn=Hn.add(bf,'blank').name(Xn).__li;return Yn.setAttribute('class','cr function myguibut'),null==Xn&&Yn.removeChild(Yn.children[0]),Yn}function Je(Hn){Hn.style.height='5px',Hn.style.height=Hn.scrollHeight-5+'px'}function Pe(Hn){for(var Xn=0;Xn<Vi.length;Xn++)if(Hn==Vi[Xn])return Qi[Xn]}function Ae(Hn){var Xn=0,Yn=Xs;null!=Hn&&(Yn=Hn);Il.getObjectByName(Yn);return null==ss[Yn]?Xn:1==ss[Yn].skip?Xn:ss[Yn].type}function Ee(Hn){var Xn=Te(Hn);if(-3==Xn)return void console.log('Nothing selected');var Yn=Ae(Hn);chosenp=Xn,-2==chosenp?($i=new Ue,$i.type=Yn,$i.coords=Yl,$i.isarea=Xe(Yl)):$i.restore(allp.par[chosenp]),Pa('Select',Yn),Ii.updateDisplay()}function Te(Hn){var Xn=Ae(Hn);if(!Xn)return console.log('Nothing selected'),-3;if('L'==Xn){var Yn=we(Hn);Yl=Se(Yn),0==Yl.length&&console.log('No lines selected')}else Yl=[ss[Hn].xs,ss[Hn].ys];return allp.get(Yl)}function Oe(Hn){for(var Xn=normPel(Rl,Ll),Yn=Xn[0];Yn<Xn[1];Yn+=5)if(Hn>=Yn&&Hn<Yn+5){var Kn=allq.get(Yn),Zn=allq.get(Yn+5);if(-2==Kn&&-2==Zn)return console.log('No Q near'),[Yn,Yn+5];var $n=Yn,eo=-2==Zn?Kn:Zn;$n=-2==Zn?Math.max(allq.qar[Kn].ps,allq.qar[Kn].pe):Math.min(allq.qar[Zn].ps,allq.qar[Zn].pe);var to=-2==Zn?5:-5;return[$n,$n+to]}return console.log('No q found'),[Hn,Hn+5*Xn[2]]}function Ie(Hn){var Xn=_a(Hn);if(en=allq.get(Xn),-2==en){Zi=new Ze,Zi.getQ();var Yn=Oe(Xn);Zi.ps=Yn[0],Zi.pe=Yn[1],Zi.comment=''}else Zi.restore(allq.qar[en]);re(),is==qa.qval?(Ii.removeFolder(qa.qval),ja()):Pa(qa.qval),ji.close(),Ii.removeFolder(qa.main),Ii.removeFolder(qa.setproperties),Pi.open(),Ps.visible=!0,Ps.position.set(1.2*-Zs,0.35*Na(Zi.pe)+0.65*Na(Zi.ps),10),Le(),Ii.updateDisplay()}function Be(){setTimeout(function(){Ii.open()},200)}function Ge(){Ii.close()}function Ne(){-1<en?(Zi.lastchange=Ql,allq.qar[en].restore(Zi)):(allq.add(Zi),en=allq.qar.length-1),oman.updchangelist(Zi.sid),allq.update(),ea(null,1)}function _e(){allq.remove(en),allq.update(),re(),Zi=new Ze,Le()}function We(){if(0==Yl.length)return void console.log('No lines selected');if(-1<chosenp){if('undefined'==typeof allp.par[chosenp])return void console.log('No lines selected');allp.par[chosenp].restore($i),allp.par[chosenp].author=params.author,allp.par[chosenp].lastchange=Ql,'L'==allp.par[chosenp].type&&(allp.par[chosenp].color=Dt(Pe($i.bergart)))}else $i.author=params.author,'L'==$i.type&&($i.color=Dt(Pe($i.bergart))),$i.sid=Ql,allp.add($i),chosenp=allp.amtok()-1;oman.sp=allp.par[chosenp],allq.update(),re()}function Ue(){this.author=params.author,this.sid=Ql,this.lastchange=Ql,this.type='',this.bergart='none',this.ispartofQ=0,this.id='',this.coords=[],this.color=0,this.comment='',this.width=0,this.dsc='Not given',this.wdrip=0,this.wleak=0,this.isarea=!1,this.restore=function(Hn){var Xn=JSON.parse(JSON.stringify(Hn));this.sid=Xn.sid,this.lastchange=null==Xn.lastchange?this.sid:Xn.lastchange,this.type=Xn.type,this.id=Xn.id,this.coords=Xn.coords,this.bergart=Xn.bergart,this.width=Xn.width,this.comment=Xn.comment,this.ispartofQ=Xn.ispartofQ,null!=Xn.author&&(this.author=Xn.author),this.isarea=Xn.isarea,this.color=Xn.color,null!=Xn.dsc&&(this.dsc=Xn.dsc,this.wdrip=Xn.wdrip,this.wleak=Xn.wleak)},this.sameas=function(Hn){if(0==Hn.length)return!1;for(var Xn=0;Xn<Math.min(Hn.length,this.coords.length)&&!(6<Xn);Xn++){if(20<Xn)return console.log('Same',this.coords),!0;if(10<Hn.length){var Yn=Ba(Hn[Xn],this.coords[Xn]);if(!Yn)return!0}if(!Ia(Hn[Xn],this.coords[Xn]))return!1}return!0},this.showprops=function(){var Hn;return Hn='W'==this.type?this.coords+' wdrip='+this.wdrip+' wleak='+this.wleak:this.bergart+' '+this.coords,Hn}}function He(){this.par=[],this.getareas=function(){var Hn=[];for(var Xn in this.par){var Yn=this.par[Xn];Yn.isarea&&!Yn.ispartofQ&&Hn.push(Yn)}return Hn},this.amtok=function(){for(var Hn=0,Xn=0;Xn<this.par.length;Xn++)this.par[Xn].ispartofQ||Hn++;return Hn},this.add=function(Hn,Xn){var Yn=new Ue;Yn.restore(Hn),this.par.push(Yn),null==Xn&&this.update()},this.remove=function(Hn,Xn){if('object'==typeof Hn)for(var Yn in console.log('Trying to remove',Hn),this.par){var Kn=this.par[Yn];if(Kn==Hn){this.par.splice(Yn,1);break}}else-1<Hn&&this.par.splice(Hn,1);null==Xn&&this.update()},this.cleanFromQ=function(){for(var Hn=0;Hn<this.par.length;Hn++)1==this.par[Hn].ispartofQ&&(this.remove(Hn,1),Hn--)},this.y2pelcoords=function(){for(var Hn=0;Hn<this.par.length;Hn++)for(var Xn=0;Xn<this.par[Hn].coords.length;Xn+=2)this.par[Hn].coords[Xn+1]=_a(this.par[Hn].coords[Xn+1])},this.cleanFromPel=function(){for(var Hn=0;Hn<this.par.length;Hn++)dl(this.par[Hn].coords[1])||(console.log('Skipping property',this.par[Hn]),this.remove(Hn),Hn--)},this.get=function(Hn){for(var Xn=0;Xn<this.par.length;Xn++)if(this.par[Xn].sameas(Hn))return Xn;return-2},this.restore=function(Hn,Xn,Yn){var Kn=!1;null!=Yn&&(Kn=Yn);for(var $n,Zn=0;Zn<Hn.par.length;Zn++)($n=this.ismemberalready(Hn.par[Zn]),null==Hn.par[Zn].sid&&(Hn.par[Zn].sid=Wn),null==Hn.par[Zn].author&&(Hn.par[Zn].author=Un),!(1==Kn&&Hn.par[Zn].sid<Ql))&&(1<Kn&&Hn.par[Zn].sid!=Kn||(-1<$n?this.par[$n].restore(Hn.par[Zn]):this.add(Hn.par[Zn],Xn)));null==Xn&&(console.log('Update inside restore'),this.update())},this.ismemberalready=function(Hn){for(var Xn=0;Xn<this.par.length;Xn++)if(this.par[Xn].sameas(Hn.coords))return Xn;return-1},this.update=function(){mt.start('updatePinside');var Hn=renderblock;if(renderblock=1,za(),params.showbergart)for(var Xn=0;Xn<this.par.length;Xn++)if(('L'==this.par[Xn].type||this.par[Xn].ispartofQ)&&(this.par[Xn].isarea&&tt(this.par[Xn].coords,Pe(this.par[Xn].bergart),this.par[Xn].ispartofQ),''!=this.par[Xn].comment)){var Kn,Zn,Yn=this.par[Xn].coords.length;Kn=this.par[Xn].coords[Yn-2],Zn=this.par[Xn].coords[Yn-1];var $n=ee('comment!',Kn,Zn,5,1);Hs.add($n)}renderblock=Hn,mt.end('updatePinside')}}function Xe(Hn){var Xn=Hn.length;return Xn%2?(console.log('Odd amount of coordinates?'),console.log(Hn),!1):!(8>Xn)&&Hn[0]==Hn[Xn-2]&&Hn[1]==Hn[Xn-1]}function Ye(Hn){var Xn=Rl<Ll,Yn=allq.get(Hn);return-1<Yn&&(Xn=allq.qar[Yn].ps>allq.qar[Yn].pe?0:Xn),Rl<tunborder&&(Xn=13730<Hn&&13915>Hn||14350<Hn&&14980>Hn?0:1),17057<Hn&&17068>Hn&&(Xn=1),Xn}function Ke(){this.qar=[],this.add=function(Hn){var Xn=new Ze;Xn.restore(Hn),this.qar.push(Xn)},this.get=function(Hn){for(var Zn,Xn=1e3,Yn=-2,Kn=0;Kn<this.qar.length;Kn++)Zn=Xn,(this.qar[Kn].pe>Hn&&this.qar[Kn].ps<Hn||this.qar[Kn].ps>Hn&&this.qar[Kn].pe<Hn)&&(Xn=Math.min(Xn,Math.abs(Hn-this.qar[Kn].ps),Math.abs(Hn-this.qar[Kn].pe),Math.abs(Hn-(this.qar[Kn].pe+this.qar[Kn].ps)/2)),Zn!=Xn&&(Yn=Kn));return Yn},this.remove=function(Hn){-1<Hn&&(console.log('Removed Q'),oman.updchangelist(this.qar[Hn].sid),this.qar.splice(Hn,1))},this.removeP=function(Hn){var Xn=this.get(Hn);-1<Xn?this.qar.splice(Xn,1):console.log('No such Q with pel'+Hn)},this.getoverlaps=function(){for(var Hn=[],Xn=0;Xn<this.qar.length;Xn++){for(var Yn=0,Kn=this.qar[Xn],Zn=Math.min(Kn.ps,Kn.pe),$n=Math.max(Kn.ps,Kn.pe),eo=Xn+1;eo<this.qar.length;eo++){var to=this.qar[eo],ao=Math.min(to.ps,to.pe),lo=Math.max(to.ps,to.pe);if(ao<=$n&&ao>=Zn){if(ao==$n)continue;var no=[ao,Math.min(lo,$n)];Hn.push(no),Kn.Q==to.Q&&Kn.comment==to.comment&&(Kn.sid>to.sid?(console.log('Removing overlap',to),this.remove(eo),eo--):Yn=1);continue}if(lo<=$n&&lo>=Zn){if(lo==Zn)continue;var no=[Math.max(ao,Zn),lo];Hn.push(no),Kn.Q==to.Q&&Kn.comment==to.comment&&(Kn.sid>to.sid?(console.log('Removing overlap',to),this.remove(eo),eo--):Yn=1)}}Yn&&(console.log('Removing i',Kn),this.remove(Xn),Xn--)}return 2<Hn.length&&console.log('Overlaps',Hn),Hn},this.update=function(){mt.start('updateQ'),mt.start('Get Q overlaps'),this.getoverlaps(),mt.end('Get Q overlaps'),ka(),mt.start('Clean Q'),allp.cleanFromQ(),mt.end('Clean Q');for(var Hn=0;Hn<this.qar.length;Hn++)if(Sa(this.qar[Hn].ps,this.qar[Hn].pe,this.qar[Hn].getQ(),this.qar[Hn].class,this.qar[Hn].comment),'none'!=this.qar[Hn].bergart){var Xn=new He,Yn=new Ue;Yn.ispartofQ=1;var Kn=Na(this.qar[Hn].ps),Zn=Na(this.qar[Hn].pe);Yn.coords=[-Zs,Kn,-Zs,Zn,Zs,Zn,Zs,Kn],Yn.bergart=this.qar[Hn].bergart,Yn.isarea=!0,Xn.add(Yn,1),allp.restore(Xn,1)}mt.start('updatePFinal'),allp.update(),mt.end('updatePFinal'),mt.end('updateQ')},this.clear=function(){ka(),this.qar=[]},this.restore=function(Hn,Xn,Yn){var Kn=!1;null!=Yn&&(Kn=Yn);for(var Zn=0;Zn<Hn.qar.length;Zn++)if((null==Hn.qar[Zn].sid&&(Hn.qar[Zn].sid=Wn),null==Hn.qar[Zn].author&&(Hn.qar[Zn].author=Un),!(1==Kn&&Hn.qar[Zn].sid<Ql))&&!(1<Kn&&Hn.qar[Zn].sid!=Kn)){if(params.onlycurpel&&(!dl(Hn.qar[Zn].ps)||!dl(Hn.qar[Zn].pe))){console.log('Q not in limits'+Hn.qar[Zn].ps+' '+Hn.qar[Zn].pe);continue}var $n=this.isequal(Hn.qar[Zn]);-1<$n?this.qar[$n].restore(Hn.qar[Zn]):this.add(Hn.qar[Zn])}null==Xn&&this.update()},this.isequal=function(Hn){for(var Xn=0;Xn<this.qar.length;Xn++)if(this.qar[Xn].ps==Hn.ps&&this.qar[Xn].pe==Hn.pe)return Xn;return-1}}function Ze(){this.author=params.author,this.sid=Ql,this.lastchange=Ql,this.ps=Rl,this.pe=Ll,this.RQDc='??',this.Jrc='??',this.Jwc='??',this.Jnc='??',this.Jac='??',this.SRFc='??',this.Jnmult=1,this.RQD=-1,this.Jr=-1,this.Jw=-1,this.Jn=-1,this.Ja=-1,this.SRF=-1,this.Q='??',this.class='??',this.comment='',this.bergart='none',this.getQ=function(){return 0>this.RQD||0>this.Jr||0>this.Jr||0>this.Jn||0>this.Ja||0>this.SRF?this.Q:(this.Q=Math.round(1e3*(Math.max(this.RQD,10)*this.Jr*this.Jw/(this.Jn*this.Ja*this.SRF)))/1e3,0.01<this.Q&&(this.Q=Math.round(100*this.Q)/100),1<this.Q&&(this.Q=Math.round(10*this.Q)/10),this.class='G',0.01<this.Q&&(this.class='F'),0.1<this.Q&&(this.class='E'),1<this.Q&&(this.class='D'),4<this.Q&&(this.class='C'),10<this.Q&&(this.class='A/B'),this.Q)},this.restore=function(Hn){this.ps=Hn.ps,this.pe=Hn.pe,this.comment=Hn.comment,this.bergart=Hn.bergart,this.RQDc=Hn.RQDc,this.Jrc=Hn.Jrc,this.Jwc=Hn.Jwc,this.Jnc=Hn.Jnc,this.Jac=Hn.Jac,this.SRFc=Hn.SRFc,this.Jnmultc=1,this.RQD=Hn.RQD,this.Jr=Hn.Jr,this.Jw=Hn.Jw,this.Jn=Hn.Jn,this.Ja=Hn.Ja,this.SRF=Hn.SRF,null!=Hn.author&&(this.author=Hn.author),null!=Hn.sid&&(this.sid=Hn.sid),this.lastchange=null==Hn.lastchange?this.sid:Hn.lastchange,this.getQ()}}function tt(Hn,Xn,Yn){for(var $n,Kn=[],Zn=0;Zn<Hn.length;Zn+=2)$n=new THREE.Vector3(Hn[Zn],Hn[Zn+1],1-0.02*Yn),Kn.push($n);var to,ao,lo=new THREE.Geometry,no=new THREE.MeshBasicMaterial({color:Xn,transparent:!0,opacity:0.7});no.side=THREE.DoubleSide,lo.vertices=Kn,to=THREE.ShapeUtils.triangulateShape(Kn,[]);for(var Zn=0;Zn<to.length;Zn++)lo.faces.push(new THREE.Face3(to[Zn][0],to[Zn][1],to[Zn][2]));ao=new THREE.Mesh(lo,no),Hs.add(ao),re()}function at(Hn){for(var Xn=Hn.elements,Yn=0;Yn<Xn.length;Yn++)Xn[Yn]=mr(Xn[Yn]);return Xn}function it(Hn,Xn){var Yn={x:(Hn/Zs+1)/2,y:(Xn/ei+1)/2};return Yn}function rt(Hn,Xn){var Yn=Xn.x-Hn[0].x,Kn=Xn.y-Hn[0].y,Zn=0<(Hn[1].x-Hn[0].x)*Kn-(Hn[1].y-Hn[0].y)*Yn;return 0<(Hn[2].x-Hn[0].x)*Kn-(Hn[2].y-Hn[0].y)*Yn!=Zn&&0<(Hn[2].x-Hn[1].x)*(Xn.y-Hn[1].y)-(Hn[2].y-Hn[1].y)*(Xn.x-Hn[1].x)==Zn}function dt(){controls.reset(),controls.target.set(0,0,0),camera.position.set(0,0,$s),cameraFix.position.set(0,0,$s),Za(),ut(),H()}function ut(){var Hn=window.devicePixelRatio;Tl=kl,Ol=zl,camera.left=-Zs,camera.right=Zs,camera.top=ei+ti,camera.bottom=-ei+ti,cameraFix.left=-Zs,cameraFix.right=Zs,cameraFix.top=ei+ti,cameraFix.bottom=-ei+ti,'Geo+Q+Pel'==params.what2plot&&(camera.left=-Zs-1.2,camera.right=Zs+1.2,Tl*=1.3,lsc=0.5),Tl/=Hn,Ol/=Hn;'For 3d'!=params.what2plot&&4096<Ol&&(Tl=4096*Tl/Ol,Ol=4096);var Yn=Tl,Kn=Ol;'For 3d'==params.what2plot,renderer.setSize(Yn,Kn),fi=new THREE.Vector2(Yn,Kn),'For 3d'==params.what2plot&&(lsc=Math.min(0.5,5e3/Kn));var Zn=android||iOS?4:1;buftext=new THREE.WebGLRenderTarget(4096/Zn,16384/Zn,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat}),camera.updateProjectionMatrix(),cameraFix.updateProjectionMatrix()}function ht(){El||(sensivity=1,params.what2plot='For 3d',kt(Rl,Ll,1),dt(),Aa(),El=!0,renderer.render(Il,cameraFix,buftext),ft(),jt(),camera.position.set(0,0,1e3),params.what2plot='Geo+Q+Pel',controls.enableRotate=!0,re(),check3dbox.style.display='',check3dbox.checked=!0,fgui.close(),Pa('3d'))}function gt(){if(El){for(sensivity=5;0<Rs.children.length;)Rs.remove(Rs.children[0]);buftext.dispose(),Il=js,params.resetcam(),controls.enableRotate=!1,El=!1,camera.position.set(0,0,$s),lsc=1,ft(),H(),Aa(),kt(Rl,Ll),setTimeout(function(){re()},50),hi.value='Select',Pa('Line'),check3dbox.style.display='none',fgui.close(),Ii.close()}}function yt(){Ll+=5*pmult,Rl-=5*pmult,jl=Math.abs(parseInt(Rl)-parseInt(Ll)),zl=Jl*jl,Ol=zl,ei=zl/Ks,B(Rl,Ll,ti),kt(Rl,Ll),Sa(Rl,Ll,-1),wa(Fl,Na(Ll-2.5*pmult)),wa(Fl,Na(Rl+2.5*pmult)),re()}function ft(){F(),fi=new THREE.Vector2(mi,yi),bi=mi/yi,camera.left=-vi*bi/2,camera.right=vi*bi/2,camera.top=xi/2,camera.bottom=-xi/2,camera.updateProjectionMatrix(),renderer.setSize(mi,yi),re()}function vt(){if(Oi)return!1;for(var Hn=0,Xn=0;Xn<ss.length;Xn++)1!=ss[0].skip&&(Hn=1);if(allq.qar.length&&(Hn=1),!Hn)return!1;var Yn=new Date().getTime(),Kn=Xa(1),Zn=JSON.stringify(Kn);localStorage.setItem(ns.s,Zn);var $n=new Date().getTime()-Yn;return console.log('dT = '+$n),!0}function xt(){if(localStorage.getItem(ns.l)){var Hn=localStorage.getItem(ns.l),Xn=JSON.parse(Hn);console.log('Sid set to',Xn.sid),Oa(Xn),allq.update(),H(),re(),params.restses=0,Pa('Line')}}function kt(Hn,Xn,Yn){if(Il.remove(Bs),!!params.rutenett){Bs=new THREE.Object3D;var Kn=normPel(Hn,Xn),Zn=Kn[0],$n=Kn[1],eo=-4;null!=Yn&&(eo=-0.5);for(var po,oo=Zn;oo<=$n;oo++){po=[],po.push(-Zs,Na(oo),1,1.13*Zs,Na(oo),1);var co=X(po,eo,'0#000000');Bs.add(co)}Il.add(Bs)}}function zt(){if(params.vederlag){var Hn=tungeom[params.tunnel].Width,Xn=[];for(var Yn in Hn){var Kn=Hn[Yn][1],Zn=Hn[Yn][3],$n=Hn[Yn][5],eo=$n-Kn;Xn.push([Hn[Yn][0],2*((Hn[Yn][2]-Kn)/eo)-1,2*((Hn[Yn][3]-Kn)/eo)-1,2*((Hn[Yn][4]-Kn)/eo)-1])}for(var co,uo,ho,go,eo,to=normPel(Rl,Ll),ao=to[0],lo=to[1],no=[],oo=[],po=[],mo=1,Yn=ao;Yn<lo;Yn++){if(eo=Math.max(Yn,Xn[0][0]),eo=Yn,co=Ft(eo,Xn),ho=Na(eo),uo=Ft(eo+pmult,Xn),go=Na(eo+1),!co||!uo){console.log('No vederlag data for pel=',Yn),mo=0;break}no.push(co[0]),no.push(ho),no.push(1),oo.push(co[1]),oo.push(ho),oo.push(1),po.push(co[2]),po.push(ho),po.push(1)}mo&&(no.push(uo[0]),no.push(go),no.push(1),oo.push(uo[1]),oo.push(go),oo.push(1),po.push(uo[2]),po.push(go),po.push(1)),X(no,-4,'0#000000'),X(oo,-4,'0#000000'),X(po,-4,'0#000000')}}function Ft(Hn,Xn){for(var Yn=Xn.length,Kn=xct=xrt=0,Zn=0,$n=0,eo=0;eo<Yn-1;eo++)if(Hn>=Xn[eo][0]&&Hn<Xn[eo+1][0]||Hn<=Xn[eo][0]&&Hn>Xn[eo+1][0]){var to=Xn[eo+1][0]-Xn[eo][0];0==to?Zn=[Xn[eo][1]*Zs,Xn[eo][2]*Zs,Xn[eo][3]*Zs]:($n=(Hn-Xn[eo][0])/(Xn[eo+1][0]-Xn[eo][0]),Kn=Xn[eo][1]+$n*(Xn[eo+1][1]-Xn[eo][1]),xct=Xn[eo][2]+$n*(Xn[eo+1][2]-Xn[eo][2]),xrt=Xn[eo][3]+$n*(Xn[eo+1][3]-Xn[eo][3]),Zn=[Kn*Zs,xct*Zs,xrt*Zs])}return Zn?Zn:Hn<Xn[0][0]?[Xn[0][1]*Zs,Xn[0][2]*Zs,Xn[0][3]*Zs]:[Xn[Yn-1][1]*Zs,Xn[Yn-1][2]*Zs,Xn[Yn-1][3]*Zs]}function Dt(Hn,Xn){var Yn=Hn;return 7==Yn.length?(Yn=null==Xn?'0x'+Yn[5]+Yn[6]+Yn[3]+Yn[4]+Yn[1]+Yn[2]:'0x'+Yn[1]+Yn[2]+Yn[3]+Yn[4]+Yn[5]+Yn[6],parseInt(Yn)):0}function Mt(){El?(di.style.display='none',pi.style.display='none',ci.style.display='none',hi.style.display='none',gi.style.display='none'):(di.style.display='',pi.style.display='',ci.style.display='',hi.style.display='',gi.style.display='')}function Vt(){di.setAttribute('class','geobutton'),pi.setAttribute('class','geobutton'),ci.setAttribute('class','geobutton'),ui.setAttribute('class','geobutton'),hi.setAttribute('class','geobutton')}function Ct(Hn){var Xn=[],Yn=Hn.length;for(var Kn in Xn.push(Ot(Hn[0][0]+1,Hn)),Hn)Hn[Kn][0]>Hn[0][0]+1&&Hn[Kn][0]<Hn[Yn-1][0]-1&&Xn.push(Ot(Hn[Kn][0],Hn));return Xn.push(Ot(Hn[Yn-1][0]-1,Hn)),Xn}function Rt(Hn){var Xn=tungeom[Hn].TunProfile,Yn=parse3dmod(Xn),Kn=Ct(Yn),Zn=Pt(Yn);for(var $n in Kn)Zn.add(Lt(Kn[$n]));var eo=(Yn[0][0]+Yn[Yn.length-1][0])/2,to=-Na(eo);return[Yn,Zn]}function Lt(Hn){var Xn=[];for(var Yn in Hn.v)Xn.push(Hn.v[Yn].x),Xn.push(Hn.v[Yn].y),Xn.push(Hn.v[Yn].z);var Kn=new THREE.Object3D,Zn=X(Xn,10,'0#000000');return Kn.add(Zn),Kn}function jt(){p2y=Na;var Hn=An,Xn=Hn[0];lingeom=new THREE.Object3D,lingeom.add(An[1]),lingeom.add(Tn);var Yn=(Xn[0][0]+Xn[Xn.length-1][0])/2,Kn=Na(Yn),Zn=getglobc((Rl+Ll)/2);lingeom.position.set(-Zn.x,-Zn.y,-Zn.z);var $n=Tt(Xn),eo=$n[0];for(var to in partlingeom=$n[1],pmat=new THREE.MeshBasicMaterial({map:buftext.texture,transparent:!0,opacity:0.5,depthTest:!0}),pmat.side=THREE.DoubleSide,my3dgroup=new THREE.Object3D,meshes=new THREE.Object3D,eo){var ao=new THREE.Mesh(eo[to][2],pmat);ao.castShadow=!1,ao.receiveShadow=!1,meshes.add(ao)}meshes.position.set(-Zn.x,-Zn.y,-Zn.z),my3dgroup.add(meshes),Rs=new THREE.Scene,js=Il;var lo=new THREE.Object3D;params.showholes&&(lo.add(Ns),lo.position.set(-Zn.x,-Zn.y,-Zn.z),my3dgroup.add(lo));var no=new THREE.Object3D;my3dgroup.add(no),eo[0][2].computeBoundingSphere();var oo=eo[0][2].boundingSphere.center,po=new THREE.Quaternion;po.setFromUnitVectors(new THREE.Vector3(0,0,1),new THREE.Vector3(0,1,0));for(var co,uo,ho=0;ho<oman.ao.length;ho++)if('B'==oman.ao[ho].type){var go=it(oman.get(ho).xs,oman.get(ho).ys),mo=_a(oman.get(ho).ys),yo=new THREE.Vector2(go.x,go.y);for(var fo in eo)if(numintersect(eo[fo][0],eo[fo][1],mo,mo)){co=Jn(meshes.children[fo],yo);break}var bo=it(oman.get(ho).xe,oman.get(ho).ye),mo=_a(oman.get(ho).ye),yo=new THREE.Vector2(bo.x,bo.y);for(var fo in eo)if(numintersect(eo[fo][0],eo[fo][1],mo,mo)){uo=Jn(meshes.children[fo],yo);break}var vo=uo[0],xo=uo[1],wo=co[0],So=co[1],ko=10,zo=jn(new THREE.Vector3(wo.x,wo.y,wo.z),new THREE.Vector3(vo.x+1*(So.x*ko),vo.y+1*(So.y*ko),vo.z+1*(So.z*ko)));no.add(zo)}my3dgroup.applyQuaternion(po),my3dgroup.add(lingeom),my3dgroup.add(partlingeom),Rs.add(my3dgroup),Rs.add(fallar),Rs.add(line3dgroup),Rs.add(line3dtemp),controls.enableRotate=!0,re()}function Pt(Hn){for(var Xn=Hn[0][1].length,Yn=new THREE.Object3D,Kn=[],Zn=Hn[0][1],$n=[],eo=Hn[0][0]+1;eo<Hn[Hn.length-1][0]-1;eo+=2)$n.push(Ot(eo,Hn));for(var to in Zn){for(var ao in Kn=[],$n){var lo=$n[ao],no=lo.v[to];Kn.push(no.x,no.y,no.z)}var to=X(Kn,5,'0#000000');Yn.add(to)}return Yn}function Et(Hn,Xn){var Yn=[];if(Hn<Xn[0][0])return _s=[Hn,Xn[0][1]],_s;if(Hn>Xn[Xn.length-1][0])return _s=[Hn,Xn[Xn.length-1][1]],_s;for(var Kn=1;Kn<Xn.length;Kn++)if(Hn>=Xn[Kn-1][0]&&Hn<=Xn[Kn][0]){var Zn=Xn[Kn-1][0],$n=Xn[Kn][0],eo=(Hn-Zn)/($n-Zn);for(var to in Xn[Kn][1]){var ao=Xn[Kn][1][to],lo=Xn[Kn-1][1][to];Yn.push(new THREE.Vector2(ao.x*eo+lo.x*(1-eo),ao.y*eo+lo.y*(1-eo)))}break}return Yn.length||console.log('Error! Vout not defined in getcurveatpel'),[Hn,Yn]}function Tt(Hn){for(var lo,Xn=Rl,Yn=Ll,Kn=Et(Xn,Hn),Zn=Et(Yn,Hn),$n=-1,eo=[[0,Kn]],to=[],ao=0;ao<Hn.length;ao++)if((lo=Hn[ao][0],Math.round($n)!=Math.round(lo))&&($n=lo,lo=Math.round(lo),ul(lo,Xn,Yn))){var no=(lo-Xn)/(Yn-Xn);to.push([no,Hn[ao]])}if(0<pmult)for(var oo=0;oo<to.length;oo++)eo.push(to[oo]);else for(var oo=to.length-1;-1<oo;oo--)eo.push(to[oo]);eo.push([1,Zn]);for(var po=new THREE.Object3D,co=[],uo=[],oo=0;oo<eo.length-1;oo++)for(var ho=eo[oo][1][0],go=eo[oo+1][1][0],mo=0,ao=ho;0>(ao-go)*pmult;ao+=5*pmult){mo++;var no=(ao-Xn)/(Yn-Xn);if(uo.push([no,Et(ao,Hn)]),500<mo)return}uo.push(eo[eo.length-1]);for(var oo=1;oo<uo.length;oo++){var yo=Ot(uo[oo][1][0],Hn),fo=Ot(uo[oo-1][1][0],Hn);co.push([uo[oo-1][1][0],uo[oo][1][0],It(fo,yo,uo[oo-1][0],uo[oo][0])])}return[co,po]}function Ot(Hn,Xn){var Yn=Et(Hn,Xn),Kn=getglobc(Hn),Zn=getglobc(Hn,1)[1]/180*Math.PI,$n=getglobc(Hn+0.01),eo=new THREE.Quaternion;null==$n?($n=getglobc(Hn).sub(getglobc(Hn-0.01)).normalize(),$n=$n.normalize(),$n.z=0,eo.setFromUnitVectors(new THREE.Vector3(1,0,0),$n)):($n=getglobc(Hn+0.01).sub(Kn),$n=$n.normalize(),$n.z=0,eo.setFromUnitVectors(new THREE.Vector3(1,0,0),$n)),0.1<Math.abs(eo.y)&&(console.log(Hn,Kn,$n),console.log(Hn,eo));var to={pel:Hn,v:[]};for(var ao in Yn[1]){var lo=Yn[1][ao],no=Math.sin(Zn),oo=Math.cos(Zn),po=new THREE.Vector3(0,lo.x,lo.y);po.applyAxisAngle(new THREE.Vector3(1,0,0),Zn),po.applyQuaternion(eo),po.add(Kn),to.v.push(po)}return to}function It(Hn,Xn,Yn,Kn){var Zn=new THREE.Geometry,$n=0,eo=Hn.v.length;Zn.faceVertexUvs[0]=[];for(var to=0;to<eo-1;++to){var ao=Hn.v[to],lo=Hn.v[to+1],no=Xn.v[to],oo=Xn.v[to+1],po=to/(eo-1),co=(to+1)/(eo-1),uo=null==Yn?0:Yn,ho=null==Kn?1:Kn;Zn.vertices.push(new THREE.Vector3(ao.x,ao.y,ao.z)),Zn.vertices.push(new THREE.Vector3(lo.x,lo.y,lo.z)),Zn.vertices.push(new THREE.Vector3(no.x,no.y,no.z)),Zn.vertices.push(new THREE.Vector3(oo.x,oo.y,oo.z)),Zn.faces.push(new THREE.Face3($n+2,$n+1,$n)),Zn.faces.push(new THREE.Face3($n+1,$n+2,$n+3)),Zn.faceVertexUvs[0].push([new THREE.Vector2(po,ho),new THREE.Vector2(co,uo),new THREE.Vector2(po,uo)]),Zn.faceVertexUvs[0].push([new THREE.Vector2(co,uo),new THREE.Vector2(po,ho),new THREE.Vector2(co,ho)]),$n+=4}return Zn.uvsNeedUpdate=!0,Zn.computeFaceNormals(),Zn}function Bt(){Tn=new THREE.Object3D;var Hn=tun2='';if('34100'==params.tunnel&&(tun2='34100',Hn='34000'),'34000'==params.tunnel&&(tun2='34000',Hn='34100'),Hn){globavg=tungeom[Hn].Geo3d.globavg,globtc=tungeom[Hn].Geo3d.globtc,Tn=Rt(Hn)[1];var Xn=tv().copy(tungeom[Hn].Geo3d.globavg).sub(tungeom[tun2].Geo3d.globavg);Xn.y=-Xn.y,Tn.position.set(Xn.x,Xn.y,Xn.z)}globavg=tungeom[params.tunnel].Geo3d.globavg,globtc=tungeom[params.tunnel].Geo3d.globtc,globtc[0].pel-=0.1,('Kjorholt'==params.tunnel||'Tunnel1'==params.tunnel)&&(globtc[0].pel=13650),globtc[globtc.length-1].pel+=0.1,An=Rt(params.tunnel)}function Gt(){var Hn=linez.length;if(!(2>Hn)){for(var Yn,Xn=1;Xn<Hn;Xn++)Yn=new Ga,Yn.addline(linez[Xn-1].xs,linez[Xn-1].ys,1,linez[Xn].xs,linez[Xn].ys,1,Math.round(30*params.size),'#000000'),oman.add(Yn);var Kn=linez[0].v,Zn=linez[Math.floor(Hn/2)].v,$n=linez[Hn-1].v,eo=Nt();return eo}}function Nt(){for(var Hn=linez.length,Xn=Math.floor(Hn/3),Yn=Math.floor(2*Hn/3),Kn=tv(),Zn=tv(),$n=tv(),eo=0;eo<Xn;eo++)Kn.add(linez[eo].v);Kn.multiplyScalar(1/Xn);for(var eo=Xn;eo<Yn;eo++)Zn.add(linez[eo].v);Zn.multiplyScalar(1/(Yn-Xn));for(var eo=Yn;eo<Hn;eo++)$n.add(linez[eo].v);return $n.multiplyScalar(1/(Hn-Yn)),[Kn,Zn,$n]}function Ut(Hn){var Xn=new THREE.Plane().setFromCoplanarPoints(Hn[0],Hn[1],Hn[2]),Yn=new THREE.Vector3((Hn[0].x+Hn[1].x+Hn[2].x)/3,(Hn[0].y+Hn[1].y+Hn[2].y)/3,(Hn[0].z+Hn[1].z+Hn[2].z)/3),Kn=new THREE.BoxGeometry(150,150,0.5),Zn=new THREE.MeshBasicMaterial({color:17408,transparent:!0,opacity:0.1}),$n=new THREE.Mesh(Kn,Zn),eo=new THREE.Quaternion;eo.setFromUnitVectors(new THREE.Vector3(0,0,1),Xn.normal),$n.applyQuaternion(eo),$n.position.set(Yn.x,Yn.y,Yn.z),$n.scale.set(fscale.val,fscale.val,1),fallar.add($n)}function Ht(Hn){var Xn=new THREE.Plane().setFromCoplanarPoints(Hn[0],Hn[1],Hn[2]),Yn=new THREE.Vector3((Hn[0].x+Hn[1].x+Hn[2].x)/3,(Hn[0].y+Hn[1].y+Hn[2].y)/3,(Hn[0].z+Hn[1].z+Hn[2].z)/3),Kn=Xn.normal;0>Kn.y&&Kn.negate();var Zn=180*new THREE.Vector3(0,1,0).angleTo(Kn)/Math.PI,$n=_a(linez[0].ys),eo=getglobc($n+1).sub(getglobc($n));eo=eo.normalize();var to=getglobc((Rl+Ll)/2),ao=new THREE.Quaternion;ao.setFromUnitVectors(new THREE.Vector3(0,0,1),new THREE.Vector3(0,1,0)),eo.applyQuaternion(ao);var lo=new THREE.Quaternion;lo.setFromUnitVectors(new THREE.Vector3(0,1,0).applyQuaternion(ao),new THREE.Vector3(1,0,0).applyQuaternion(ao));var no=tv().copy(eo).applyQuaternion(lo),oo=new THREE.Plane().setFromCoplanarPoints(Yn,tv().copy(Yn).add(no),tv().copy(Yn).add(eo)),po=tv().copy(Kn).projectOnPlane(oo.normal),co=po.angleTo(eo)<Math.PI/2?1:0,uo=180*po.angleTo(no)/Math.PI;return uo=co?360-uo:uo,console.log('Strike:',uo),console.log('Dip/Fall',Zn),[Math.floor(uo),Math.round(Zn)]}function Kt(){if(linez.length){var Hn=new ConvexHullGrahamScan;for(var Xn in linez)Hn.addPoint(linez[Xn].xs,linez[Xn].ys);var Yn=Hn.getHull(),Kn=[];for(var Zn in linez)for(var Xn in Yn){var $n=linez[Zn];Yn[Xn].x==$n.xs&&Yn[Xn].y==$n.ys&&Kn.push($n)}linez=Kn,linez.sort(function(no,oo){return oo.xs-no.xs});var eo=y=0;for(var Zn in linez)eo+=linez[Zn].xs,y+=linez[Zn].ys;eo/=linez.length,y/=linez.length;var to=Gt(),ao=Ht(to),lo=new Ga;lo.addfall(eo,y,8,ao[0],ao[1],1),lo.color=to,oman.plot(lo),oman.add(lo),Zt(linez),H(),re(),linez=[],controls.enableRotate=!0,check3dbox.checked=!0,Ii.updateDisplay()}}function Zt(Hn){var Xn=[];for(var Yn in Hn)Xn.push(Hn[Yn].v.x,Hn[Yn].v.y,Hn[Yn].v.z);if(Xn.length){var Kn=X(Xn,Math.round(40*params.size),'#000000',1);line3dgroup.add(Kn)}}function $t(){camera.zoom;return!!(0.5>camera.zoom)}function ea(Hn,Xn){if($t()){for(var Yn in globtxt)globtxt[Yn].visible=!1;return void re(Hn)}for(var Yn in globtxt)globtxt[Yn].visible=!0;var Kn=new Date().getTime(),Zn=5e3;if(null!=Xn&&(Zn=Xn),Kn-Ms>Zn){for(var Yn in globtxt){var $n=globtxt[Yn];$n.redrawInterval=1}for(var Yn in re(Hn),globtxt){var $n=globtxt[Yn];$n.redrawInterval=1e5}Ms=Kn}else re(Hn)}function ia(){var Hn=In-1;Gn.add(Y(Math.cos(5*(Hn/100)*Math.PI)*Hn/50,Math.sin(5*(Hn/100)*Math.PI)*Hn/50,1,Math.cos(5*(In/100)*Math.PI)*In/50,Math.sin(5*(In/100)*Math.PI)*In/50,1,5,'#000000')),re(),In++,In<On?requestAnimationFrame(ia):ra()}function oa(){0!=In||(Il.remove(Gn),Gn=new THREE.Object3D,Il.add(Gn),Bn=new mytimer('Time1000',5),requestAnimationFrame(ia))}function ra(){var Hn=Bn.end('Time1000');globgeo='FPS '+1e3/(Hn/On),lastgeo.innerHTML=globgeo,In=0}function ga(){params.withbg?ya(Fl):ya(''),Di.material=Mi,re()}function ya(Hn){if(''==Hn)Mi=new THREE.MeshBasicMaterial({color:16777215});else{var Xn=new THREE.TextureLoader;Xn.crossOrigin='anonymous';var Yn=Xn.load(Hn,function(){re()});Yn.magFilter=THREE.NearestFilter,Yn.minFilter=THREE.LinearMipMapLinearFilter,Yn.anisotropy=2,Rl>Ll&&(Yn.flipY=!1),Mi=new THREE.MeshBasicMaterial({map:Yn})}}function fa(Hn,Xn){Ql=getsessionid(),L(),Ll=parseInt(Xn),Rl=parseInt(Hn),pmult=Rl<Ll?1:-1,Pl=(Rl+Ll)/2,jl=Math.abs(parseInt(Rl)-parseInt(Ll)),Jl=50,11>jl&&(Jl=100),6>jl&&(Jl=200),zl=Jl*jl,Ol=zl,ei=zl/Ks,B(Rl,Ll,ti),kt(Rl,Ll),xa(Fl,0),Sa(Rl,Ll,-1),params.resetcam(),re(),picparams.ps=Rl,picparams.pe=Ll,saveifokdist(picparams.ps,picparams.pe),fgui.updateDisplay()}function ba(Hn,Xn,Yn){var Kn=params.tunnel;null!=Yn&&(Kn=Yn);var Zn=Hn>Xn,$n=Math.min(Hn,Xn),eo=Math.max(Hn,Xn),to=1*Math.floor($n/1),ao=1*Math.floor((eo-0.01)/1+1),lo=gettunlim(Kn);('Kjorholt'==params.tunnel||'Tunnel1'==params.tunnel)&&(lo.pmin=13650),'34100'==params.tunnel&&(lo.pmin=0);var no=checklims(to,ao,lo);to=no[0],ao=no[1],picdb.sortbypelasc();var oo=getpicsinrange(Kn,to,ao);Fl='';var po=oo.length;for(var co in po&&(to=parseFloat(picdb.files[oo[0]].ps),ao=parseFloat(picdb.files[oo[po-1]].pe)),Zn?fa(ao,to):fa(to,ao),oo)va(picdb.files[oo[co]],Zn);gt(),fgui.close(),Ii.close()}function va(Hn,Xn){var Yn=Rl>Ll;null!=Xn&&(Yn=Xn);var Kn=new THREE.TextureLoader;Kn.crossOrigin='anonymous';var Zn=Kn.load(Hn.pic,function(){re()});Zn.magFilter=THREE.NearestFilter,Zn.minFilter=THREE.LinearMipMapLinearFilter,Zn.anisotropy=2,Yn&&(Zn.flipY=!1);var $n=new THREE.MeshBasicMaterial({map:Zn}),eo=Math.abs(Na(Math.max(Hn.ps,Hn.pe))-Na(Math.min(Hn.ps,Hn.pe))),to=Na((Hn.ps- -Hn.pe)/2),ao=new THREE.PlaneGeometry(eo,2*Zs,1,1);Di=new THREE.Mesh(ao,$n),Di.position.set(0,to,0.01);var lo=Yn?Math.PI:0;Di.rotateZ(Math.PI/2+lo),ls.push(Di),As.add(Di)}function xa(Hn,Xn){Il.remove(As),As=new THREE.Object3D,ls.length=0,ya(Hn);var Yn=new THREE.PlaneGeometry(2*ei,2*Zs,1,1);Di=new THREE.Mesh(Yn,Mi),Di.position.set(0,Xn/Jl,0);var Kn=Rl>Ll?Math.PI:0;Di.rotateZ(Math.PI/2+Kn),ls.push(Di),As.add(Di),Il.add(As);var Zn=new THREE.PlaneGeometry(2*ei,2.8*Zs,1,1),$n=new THREE.Mesh(Zn,Mi);$n.position.set(0,Xn/Jl,0),$n.rotateZ(Math.PI/2+Kn),ls.push($n),As.add($n)}function wa(Hn,Xn){var Yn=new THREE.MeshBasicMaterial({color:16777215}),Kn=new THREE.PlaneGeometry(5*(2*(Jl/Ks)),2*Zs,1,1),Zn=new THREE.Mesh(Kn,Yn);Zn.position.set(0,Xn,0),Zn.rotateZ(Math.PI/2),ls.push(Zn),As.add(Zn);var $n=new THREE.PlaneGeometry(5*(2*(Jl/Ks)),3*Zs,1,1),eo=new THREE.Mesh($n,Cl);eo.position.set(0,Xn,0),eo.rotateZ(Math.PI/2),ls.push(eo),As.add(eo)}function Sa(Hn,Xn,Yn,Kn,Zn){var $n,eo=!1;-1==Yn?(eo=!0,$n=11184810):($n=16711680,1<Yn&&($n=16769024),4<Yn&&($n=16746240),10<Yn&&($n=2258722));var to=eo?1:0.8,ao=new THREE.MeshBasicMaterial({color:$n,transparent:!0,opacity:to}),lo=Na((Hn+Xn)/2),no=Math.abs(Na(Xn)-Na(Hn)),oo=Zs/3,po=-Zs-oo+Zs/10,co=new THREE.PlaneGeometry(oo,no,1,1),uo=new THREE.Mesh(co,ao);if(uo.position.set(po,lo,eo?0:1),eo){var ho=Us.children[0];null!=ho&&Us.remove(ho),Us.add(uo),ls.push(uo)}else{Ws.add(uo);var go=ee('Q='+Yn+' '+Kn,po,lo,10,0);if(Ws.add(go),null!=Zn&&''!=Zn){for(var mo='',yo=0;yo<Math.min(4,Zn.length);yo++)mo+=Zn[yo];mo+='..!';var fo=ee(mo,po-0.35*li,lo+0.38*no,10,1);Ws.add(fo)}}}function ka(){for(;Ws.children.length;){var Hn=Ws.children[0];'undefined'!=typeof Hn.material&&Hn.material.dispose(),'undefined'!=typeof Hn.geometry&&Hn.geometry.dispose(),Ws.remove(Hn)}}function za(){for(;Hs.children.length;){var Hn=Hs.children[0];'undefined'!=typeof Hn.material&&Hn.material.dispose(),'undefined'!=typeof Hn.geometry&&Hn.geometry.dispose(),Hs.remove(Hn)}}function Fa(){for(;Ts.children.length;){var Hn=Ts.children[0];'undefined'!=typeof Hn.material&&Hn.material.dispose(),'undefined'!=typeof Hn.geometry&&Hn.geometry.dispose(),Ts.remove(Hn)}for(;Gs.children.length;){var Hn=Gs.children[0];'undefined'!=typeof Hn.material&&Hn.material.dispose(),'undefined'!=typeof Hn.geometry&&Hn.geometry.dispose(),Gs.remove(Hn)}for(;Es.children.length;){var Hn=Es.children[0];'undefined'!=typeof Hn.material&&Hn.material.dispose(),'undefined'!=typeof Hn.geometry&&Hn.geometry.dispose(),Es.remove(Hn)}}function Ma(Hn,Xn){var Yn=document.createElement('input',Xn);Yn.setAttribute('class','inguib'),Yn.setAttribute('type','button'),Yn.setAttribute('value',Hn),Yn.setAttribute('id','mgb'+Hn);var Kn=new Hammer(Yn);return Yn.onfocus=function(){Yn.blur()},Kn.on('press',function(){mycswitch(Yn,'ibpressed',500),null!=Xn&&setTimeout(function(){Xn()},150)}),Q(Kn),Yn}function Qa(){var Hn=new FormData;Hn.append('data',params.author);try{var Xn=window.XMLHttpRequest?new XMLHttpRequest:new activeXObject('Microsoft.XMLHTTP');Xn.onreadystatechange=function(){if(4===Xn.readyState){var Yn=JSON.parse(Xn.response);filetable(container,Yn,function(Kn){var Zn=pelfromfname(Kn),$n=Zn[0],eo=Zn[1];saveifokdist($n,eo),Ca(Kn)})}},Xn.open('post',baseaddr+'getflist.php',!0),Xn.send(Hn)}catch(Yn){console.log(Yn)}}function Ca(Hn){var Xn=new FormData;Xn.append('fname',Hn);try{var Yn=window.XMLHttpRequest?new XMLHttpRequest:new activeXObject('Microsoft.XMLHTTP');Yn.onreadystatechange=function(){if(4===Yn.readyState){if(params.overridepel){var Kn=pelfromfname(Hn),Zn=getpelrange(Yn.response,Kn[0],Kn[1]);Nn=[],Fl='',fa(Zn[0],Zn[1])}Oa(Yn.response),allq.update(),H(),re()}},Yn.open('post',baseaddr+'gettxt.php',!0),Yn.send(Xn)}catch(Kn){console.log(Kn)}}function Ra(Hn){var Xn=basekjor;'Kjorholt'==Hn&&(Xn=basekjor),'Bamle'==Hn&&(Xn=basebamble);var Yn=Hn+picparams.ps+'_'+picparams.pe+'.xml',Kn=Xn+Ua(Hn)+endfile,Zn=vkbeautify.xml(Kn);download(Zn,Yn)}function La(Hn,Xn){var Yn=Ii.add(bf,'blank').name('Geology:');Yn.onChange(function(){Ii.close()}),Yn.__li.setAttribute('class','cr function first');var Kn=parseFloat(Ii.domElement.style.width)-1;Yn.__li.style.width=Kn+'px';var Zn=je(Ii),$n=Ma('ShowDB',function(){Bi.showdb()});if($n.setAttribute('class','inguib but2gui'),Zn.appendChild($n),$n=Ma('Save',function(){params.save()}),$n.setAttribute('class','inguib but2gui'),Zn.appendChild($n),ji=Ii.addFolder('Settings'),ji.add(params,'loadprev').name(qa.restoresession),ji.add(params,'savealpha').name(qa.savepicture),ji.add(params,'author').name(qa.author).onChange(function(){Ve()}).domElement.children[0].setAttribute('maxlength','20'),ji.add(params,'openfile').name(qa.openfilegeology),ji.add(params,'ex').name('Expert user').onChange(function(){Ii.close(),Pa(is)}),ji.add(params,'clear').name(qa.clearall),ji.add(params,'overridepel').name('Override pel'),ji.add(params,'withbg').name(qa.showmwd).onChange(function(){ga()}),ji.add(params,'showbergart').name(qa.showrocktype).onChange(function(){allp.update(),re()}),ji.add(params,'forcesync').name('ForcedSync'),null!=Hn&&(Hn==qa.qval&&ja(),'Select'==Hn)){Ei=Ii.addFolder(qa.setproperties);var eo=sid2txtdate($i.sid)+' '+$i.author;if(Ei.add(bf,'blank').name(eo),Ei.add($i,'author').name(qa.author),'T'!=Xn){q22=Ei.add($i,'comment').name('');var to=q22.domElement.children[0];to.setAttribute('class','myta'),q22.domElement.setAttribute('class','c bigtadiv'),to.placeholder='Comment...',to.onkeyup=function(){Je(this)},to.onchange=function(){We()},q22.__li.setAttribute('class','cr string bigta')}if('T'==Xn&&(Ei.add(ss[Xs],'text').name(qa.text).onChange(function(){se(Xs,ss[Xs].text)}),Ei.add(params,'openfoto').name(qa.takephoto),Ei.add(params,'makelab').name(qa.labtest)),null==Xn||'L'==Xn){Ei.add($i,'bergart',Vi).name(qa.rocktype).listen().onChange(function(){params.parcolor=Pe($i.bergart),Ii.updateDisplay()});var Zn=Ei.addColor(params,'parcolor').name(qa.color).listen().onChange(function(){params.parcolor=Pe($i.bergart),Ii.updateDisplay()}),ao=Zn.domElement.children[0];ao.style.width='70%'}return'W'==Xn&&(Ei.add($i,'dsc',qa.dsc).name(qa.description),Ei.add($i,'wdrip').name(qa.dripmin),Ei.add($i,'wleak').name(qa.litmin)),'F'==Xn&&(Ei.add(ss[Xs],'angle',0,360).step(1).name(qa.angle).onChange(function(){ie(Xs,ss[Xs].fall,ss[Xs].angle)}),Ei.add(ss[Xs],'fall',0,90).step(1).name(qa.fall).onChange(function(){ie(Xs,ss[Xs].fall,ss[Xs].angle)})),Ei.add(bf,'blank').name(''),void Ei.add(params,'applyP').name(qa.ap)}Ai=Ii.addFolder(qa.main),Ai.add(bf,'blank').name(''),params.ex&&(M(Ai),M(Ai),Ai.add(params,'resetcam').name(qa.resetcamera),M(Ai))}function ja(){Pi=Ii.addFolder(qa.qval);var Hn=sid2txtdate(Zi.lastchange)+' by \''+Zi.author+'\'';Pi.add(bf,'blank').name('Updated '+Hn);var Xn=Pi.add(Zi,'ps').name('Pel start').domElement.children[0];Xn.type='tel',Xn.setAttribute('maxlength','5'),Xn=Pi.add(Zi,'pe').name('Pel end').domElement.children[0],Xn.type='tel',Xn.setAttribute('maxlength','5'),q22=Pi.add(Zi,'comment').name('');var Yn=q22.domElement.children[0];Yn.setAttribute('class','myta'),q22.domElement.setAttribute('class','c bigtadiv'),Yn.placeholder='Comment...',Yn.onkeyup=function(){Je(this)},20<Zi.comment.length&&Je(Yn),Yn.onchange=function(){Ne()},q22.__li.setAttribute('class','cr string bigta');var Xn=je(Pi);Ti.rqd=Ma('RQD',function(){params.editRQD()}),Xn.appendChild(Ti.rqd),Ti.Jr=Ma('Jr',function(){params.editJr()}),Xn.appendChild(Ti.Jr),Ti.Jw=Ma('Jw',function(){params.editJw()}),Xn.appendChild(Ti.Jw),Ti.Jn=Ma('Jn',function(){params.editJn()}),Xn.appendChild(Ti.Jn),Ti.Ja=Ma('Ja',function(){params.editJa()}),Xn.appendChild(Ti.Ja),Ti.SRF=Ma('SRF',function(){params.editSRF()}),Xn.appendChild(Ti.SRF);var Kn=Pi.add(bf,'blank').name('');Kn.__li.setAttribute('class','cr function qtext'),Ti.Q=Kn,Pi.add(Zi,'bergart',Vi).name(qa.rocktype);var Xn=je(Pi),Zn=Ma(qa.apply,function(){Ne()});Zn.setAttribute('class','inguib but2gui'),Xn.appendChild(Zn);var Zn=Ma(qa.removeq,function(){params.removeq()});Zn.setAttribute('class','inguib but2gui'),Xn.appendChild(Zn)}function Ja(){Ii=new dat.GUI({autoPlace:!1,width:Math.min(400,mi/2-4)}),container.appendChild(Ii.domElement),Ii.domElement.id='guipos'}function Pa(Hn,Xn){is=Hn;var Yn=Hn;El?(Yn='3d',globgeo='Settings'):globgeo='Geology',Mt(),null==Yn&&(Yl=[],chosenp=-2);var Kn=Ii.closed;if(container.removeChild(Ii.domElement),Ii.destroy(),Ja(),'3d'==Yn){var Zn=Ii.add(bf,'blank').name('Settings:');Zn.onChange(function(){Ii.close()}),Zn.__li.setAttribute('class','cr function first');var $n=parseFloat(Ii.domElement.style.width)-1;return Zn.__li.style.width=$n+'px',Ii.add(lingeom,'visible').name('Tunnel frame').onChange(function(){re()}),_n&&(params.showholes&&(pointval.valmin=23,pMaterial.size=12,pointCloud.geometry.drawRange.start=pointval.ar[pointval.valmin-1],pointCloud.geometry.drawRange.count=pointval.ar[pointval.valmax-1]-pointCloud.geometry.drawRange.start,_n=0),params.opacity=0.3,meshes.children[0].material.opacity=params.opacity,re()),params.showholes&&(Ii.add(pointval,'valmin',1,pointval.ar.length).name('Min').step(1).onChange(function(){pointCloud.geometry.drawRange.start=pointval.ar[pointval.valmin-1],pointCloud.geometry.drawRange.count=pointval.ar[pointval.valmax-1]-pointCloud.geometry.drawRange.start,re()}),Ii.add(pointval,'valmax',1,pointval.ar.length).name('Max').step(1).onChange(function(){pointCloud.geometry.drawRange.count=pointval.ar[pointval.valmax-1]-pointCloud.geometry.drawRange.start,re()}),Ii.add(pMaterial,'size',5,35).name('Point size').step(1).onChange(function(){re()})),Ii.add(params,'opacity',0,1).name('Tunnel opacity').step(0.1).onChange(function(){meshes.children[0].material.opacity=params.opacity,re()}),Ii.add(fscale,'val',0,1).name('Plane size').step(0.02).onChange(function(){for(var to in fallar.children)fallar.children[to].scale.set(fscale.val,fscale.val,1);re()}),params.showholes||Ii.add(params,'showholeask').name('Show holes'),void Ii.updateDisplay()}if(La(Yn,Xn),null==Xn&&Za(),Vt(),'Line'==Yn&&(di.setAttribute('class','geobuttonf'),params.linetype='Line',Ai.add(params,'bolt').name(qa.bolt),Ai.add(params,'lineStyle',qa.lineStylear).name(qa.ls),params.ex&&Ai.add(params,'size',0.1,1).name('Size').step(0.1),Ai.add(bf,'blank').name('')),'Water'==Yn&&(pi.setAttribute('class','geobuttonf'),params.linetype='Water',Ai.add(params,'wsize',0.1,1).step(0.1).name('Size'),Ai.add(bf,'blank').name('')),'Text'==Yn){ci.setAttribute('class','geobuttonf'),params.linetype='Text',q22=Ai.add(params,'text').name(qa.ttp),Ai.add(bf,'blank').name('');var eo=q22.domElement.children[0];eo.setAttribute('class','myta'),eo.placeholder='Text...',Kn=!1}'Fall'==Yn&&(ui.setAttribute('class','geobuttonf'),params.linetype='Fall',q22=Ai.add(params,'angle',0,360).step(1).name(qa.angle),Ai.add(params,'fall',0,90).step(1).name(qa.fall),Ai.add(bf,'blank').name(''),Kn=!1),'Bolt'==Yn&&(params.linetype='Bolt',Ai.add(params,'boltlen',1,10).step(0.5).name(qa.len),Ai.add(params,'bolttype',qa.boltlist).name(qa.material),Ai.add(bf,'blank').name('')),'Select'==Yn||'Q - value'==Yn?(hi.setAttribute('class','geobuttonf'),params.linetype='Select'):Ai.open(),Ii.updateDisplay(),Kn?Ge():Be()}function Aa(){for(var Hn in Os.children.length=0,oman.ao){var Xn=oman.ao[Hn];Xn.toskip||'B'!=Xn.type||oman.plot(Xn)}}function Ea(){this.oldzero=1,this.oldppu=1,this.oldpw=1,this.getnewy=function(Hn){var Yn=Na(Hn);return Yn=mr(Yn),Yn},this.getnewx=function(Hn){var Xn=Hn/this.oldpw*Zs;return Xn=mr(Xn),Xn}}function Ta(Hn,Xn){for(var Yn in Xn)for(var Kn=Xn[Yn],Zn=0;Zn<Kn.length;Zn++)if(Kn[Zn]==Hn)return''+Yn;return null}function Oa(Hn){mt.start('Get json');var Xn='object'==typeof Hn?JSON.parse(JSON.stringify(Hn)):JSON.parse(Hn);var Yn=Xn.objdata;mt.end('Get json');var Kn=new Ea,Zn=Xn.authors,$n=Xn.sids,eo=Xn.chlist;if(null==eo||isEmpty(eo))for(var to in $n)oman.changelist[to]=to;else for(var to in $n)oman.changelist[to]=eo[to];Kn.oldzero=Xn.zeropel,Un=Xn.author,Kn.oldppu=Xn.pelperunit,Kn.oldpw=Xn.pw,Wn=Xn.sid,allq.restore(Xn.qval,1);for(var ao=Xn.pval,lo=0;lo<ao.par.length;lo++)for(var to=0;to<ao.par[lo].coords.length;to+=2)ao.par[lo].coords[to]=Kn.getnewx(ao.par[lo].coords[to]),ao.par[lo].coords[to+1]=Kn.getnewy(ao.par[lo].coords[to+1],1);allp.restore(ao,1);for(var uo,no=Yn.length,oo=6,po='#000000',co=qy=qz=tmpy=tmpx=-1e3,to=0;to<no;to++){if(uo=new Ga,null==$n)uo.sid=Wn;else{var ho=Ta(to,$n);uo.sid=null==ho?Wn:ho}if(null==Zn)uo.author=Un;else{var ho=Ta(to,Zn);uo.author=null==ho?Un:ho}var go=Yn[to];if(2==go.length){tmpx=Kn.getnewx(go[0]/qprec),tmpy=Kn.getnewy(go[1]/qprec),uo.addline(co,qy,qz,tmpx,tmpy,qz,oo,po),co=Kn.getnewx(go[0]/qprec),qy=Kn.getnewy(go[1]/qprec),oman.isdublicate(uo),oman.plot(uo),oman.add(uo);continue}if(0==go[0]){oo=15,po='#000000',6<go.length&&('number'==typeof go[6]&&(oo=go[6]),'string'==typeof go[6]&&(po=go[6])),8==go.length&&(po=go[7]),co=Kn.getnewx(go[4]/qprec),qy=Kn.getnewy(go[5]/qprec),qz=go[3],tmpx=Kn.getnewx(go[1]/qprec),tmpy=Kn.getnewy(go[2]/qprec),uo.addline(tmpx,tmpy,qz,co,qy,qz,oo,po),oman.isdublicate(uo),oman.plot(uo),oman.add(uo);continue}if(1==go[0]){oo=0.5,3<oo.length&&(oo=go[3]),tmpx=Kn.getnewx(go[1]/qprec),tmpy=Kn.getnewy(go[2]/qprec),uo.addwater(tmpx,tmpy,10,oo),oman.isdublicate(uo),oman.plot(uo),oman.add(uo);continue}if(2==go[0]){tmpx=Kn.getnewx(go[1]/qprec),tmpy=Kn.getnewy(go[2]/qprec);var mo=go[4];'_pho_'==mo.slice(0,5)&&(uo.fall=1,mo=mo.slice(5),console.log(mo)),'_lab_'==mo.slice(0,5)&&(uo.fall=2,mo=mo.slice(5)),uo.addtext(mo,tmpx,tmpy,go[3],1),oman.isdublicate(uo),oman.plot(uo),oman.add(uo);continue}if(3==go[0]&&(tmpx=Kn.getnewx(go[1]/qprec),tmpy=Kn.getnewy(go[2]/qprec),uo.addfall(tmpx,tmpy,10,go[3],go[4],go[5]),null!=go[6]&&(uo.color=[tv(go[6][0].x,go[6][0].y,go[6][0].z),tv(go[6][1].x,go[6][1].y,go[6][1].z),tv(go[6][2].x,go[6][2].y,go[6][2].z)]),oman.isdublicate(uo),oman.plot(uo),oman.add(uo)),4==go[0]){uo.addbolt(Kn.getnewx(go[1]/qprec),Kn.getnewy(go[2]/qprec),go[3],Kn.getnewx(go[4]/qprec),Kn.getnewy(go[5]/qprec),go[6],go[7]),oman.isdublicate(uo),oman.plot(uo),oman.add(uo);continue}}}function Ia(Hn,Xn,Yn){var Kn=0.02/Math.abs(Rl-Ll);null!=Yn&&(Kn=Yn);var Zn=Math.abs(parseFloat(Hn)-parseFloat(Xn));return!!(Zn<Kn)}function Ba(Hn,Xn){var Kn=Math.abs(parseFloat(Hn)-parseFloat(Xn));return Kn}function Ga(){this.type='',this.sid=Ql,this.author=params.author,this.id=0,this.skip=0,this.text='',this.xs=0,this.ys=0,this.zs=0,this.xe=0,this.ye=1,this.ze=1,this.size=3,this.color='',this.fall=0,this.angle=0,this.lastmx=-1e3,this.lastmy=-1e3,this.sameas=function(Hn){return this.type==Hn.type&&Ia(this.xs,Hn.xs)&&Ia(this.ys,Hn.ys)},this.addline=function(Hn,Xn,Yn,Kn,Zn,$n,eo,to){this.type='L',this.size=eo,this.color=to,this.xs=Hn,this.ys=Xn,this.zs=Yn,this.xe=Kn,this.ye=Zn,this.ze=$n},this.addbolt=function(Hn,Xn,Yn,Kn,Zn,$n,eo){this.type='B',this.text=eo,this.xs=Hn,this.ys=Xn,this.zs=Yn,this.xe=Kn,this.ye=Zn,this.ze=$n},this.addwater=function(Hn,Xn,Yn,Kn,Zn,$n,eo,to){this.type='W',this.size=Kn,this.xs=Hn,this.ys=Xn,this.zs=Yn,null!==Zn&&(this.text=Zn),null!==$n&&(this.xe=$n),null!==eo&&(this.fall=eo),null!==to&&(this.angle=to)},this.addfall=function(Hn,Xn,Yn,Kn,Zn,$n){this.type='F',this.xs=Hn,this.ys=Xn,this.zs=Yn,this.angle=Kn,this.fall=Zn,this.size=null==$n?Ye(_a(Xn)):$n},this.addtext=function(Hn,Xn,Yn,Kn){this.type='T',this.text=Hn,this.xs=Xn,this.ys=Yn,this.zs=Kn}}function Na(Hn){var Xn=parseFloat(2*(pmult*(Hn-parseFloat(Pl))*Jl/Ks));return Xn}function _a(Hn){var Xn=parseFloat(pmult*Hn/(2*(Jl/Ks))+Pl);return Xn}function Wa(){var Hn=new Date,Xn=parseInt(Hn.getMonth()+1),Yn={date:Hn.getFullYear()+'-'+az(Xn)+'-'+az(Hn.getDate()),author:params.author};return Yn}function Ua(Hn){for(var Xn=[],Yn=[],Kn={pmult:pmult,pelperunit:1/(2*(Jl/Ks)),zeropel:Pl,pw:Zs,author:params.author,tunnel:Hn},Zn=new myxml(Kn),$n={type:'w',da:Wa(),coords:[0,1],comment:'',dsc:0,drip:'',leak:''},eo={type:'t',da:Wa(),coords:[0,1],comment:'',fall:0},to={type:'f',da:Wa(),coords:[0,1],comment:'',angle:0,fall:0},ao={type:'l',da:Wa(),coords:[0,1],ltype:0,comment:'',bergart:'none',color:'',width:0},lo={type:'q',da:Wa(),coords:[0,1],QVal:[],bergart:'none',color:0,comment:''},no=0;no<allq.qar.length;no++){var oo=allq.qar[no],po=lo;po.da.author=oo.author,po.da.date=sid2date(oo.lastchange),po.coords=[oo.ps,oo.pe],po.QVal=[oo.RQD,oo.Jn,oo.Jr,oo.Ja,oo.Jw,oo.SRF,oo.Q],po.bergart=oo.bergart,po.comment=oo.comment,po.color=Dt(Pe(oo.bergart)),Zn.parseos(po)}for(var no=0;no<ss.length;no++)if(!ss[no].skip&&!isinarray(Yn,no)){var co=Te(no);if(!isinarray(Xn,co)){var go,uo=Ae(no),ho=-2<co?1:0;ho&&(Xn.push(co),go=allp.par[co]);var yo,mo=ss[no];if('L'==uo)if(yo=ao,yo.da.author=mo.author,yo.da.date=sid2date(mo.sid),yo.ltype=mo.color[0],ho)go.isarea&&(yo.ltype=5),yo.coords=go.coords,yo.comment=go.comment,yo.bergart=go.bergart,yo.color=go.color,yo.width=go.width;else{for(var fo=we(no),bo=0;bo<fo.length;bo++)Yn.push(fo[bo]);yo.coords=Se(fo)}'W'==uo&&(yo=$n,yo.da.author=mo.author,yo.da.date=sid2date(mo.sid),yo.coords=[mo.xs,mo.ys],ho&&(go.comment&&(yo.comment=go.comment),go.dsc&&(yo.dsc=go.dsc),go.wdrip&&(yo.drip=go.wdrip),go.wleak&&(yo.leak=go.wleak))),'T'==uo&&(yo=eo,yo.da.author=mo.author,yo.da.date=sid2date(mo.sid),yo.coords=[mo.xs,mo.ys],yo.comment=mo.text,yo.fall=mo.fall),'B'==uo&&(yo=eo,yo.da.author=mo.author,yo.da.date=sid2date(mo.sid),yo.coords=[mo.xs,mo.ys],yo.comment='B'),'F'==uo&&(yo=to,yo.da.author=mo.author,yo.da.date=sid2date(mo.sid),yo.coords=[mo.xs,mo.ys],yo.angle=mo.size?mo.angle:360-mo.angle,yo.fall=mo.fall),Zn.parseos(yo)}}return Zn.showstrout()}function Ha(Hn,Xn){for(var Yn=[],Kn=[],Zn=JSON.parse(JSON.stringify(Hn)),$n=0;$n<Zn.length;$n++)if(!isinarray(Kn,$n)){var eo=params.onlynew&&!Xn?Zn[$n].sid==Ql:1;1<params.onlynew&&(eo=Zn[$n].sid==params.onlynew?1:0);var to=1;if(params.onlycurpel&&!Xn&&!dl(_a(Zn[$n].ys))){var ao=we($n);add2array(Kn,ao),to=0}!Zn[$n].skip&&eo&&to&&Yn.push(Zn[$n])}return Yn}function Xa(Hn){var Xn=0;null!=Hn&&(Xn=Hn);var Yn=Ha(ss,Xn),Kn=new Fe;Kn.lastchange=oman.changelist[params.onlynew],null==Kn.lastchange&&(Kn.lastchange=Ql),Kn.zeropel=Pl,Kn.pelperunit=Jl*pmult,Kn.pw=Zs,Kn.pelstart=Rl,Kn.pelend=Ll,Kn.author=params.author,Kn.authors={},Kn.sid=Ql,Kn.sids={},Kn.tunnel=params.tunnel;var Zn=new Ke;Xn?Zn.restore(allq,1):Zn.restore(allq,1,params.onlynew),Kn.qval=Zn;var $n=new He;$n.restore(allp,1,params.onlynew&&!Xn),Xn?$n.restore(allp,1):$n.restore(allp,1,params.onlynew),$n.cleanFromQ(),$n.y2pelcoords(),params.onlycurpel&&$n.cleanFromPel(),Kn.pval=$n;for(var eo=yprev=cprev=sprev=-1e3,to=0;to<Yn.length;to++)Yn[to].ys=_a(Yn[to].ys),Yn[to].ye=_a(Yn[to].ye);for(var ao,to=0;to<Yn.length;to++){ao=Yn[to].author,null==Kn.authors[ao]?Kn.authors[ao]=[to]:Kn.authors[ao].push(to);var lo=Yn[to].sid;if(null==Kn.sids[lo]?Kn.sids[lo]=[to]:Kn.sids[lo].push(to),'L'==Yn[to].type){if(eo==Math.round(Yn[to].xs*qprec)&&yprev==Math.round(Yn[to].ys*qprec)&&cprev==Yn[to].color&&sprev==Yn[to].size){var no=[Math.round(Yn[to].xe*qprec),Math.round(Yn[to].ye*qprec)];eo=Math.round(Yn[to].xe*qprec),yprev=Math.round(Yn[to].ye*qprec)}else{eo=Math.round(Yn[to].xe*qprec),yprev=Math.round(Yn[to].ye*qprec),cprev=Yn[to].color,sprev=Yn[to].size;var no=[0,Math.round(Yn[to].xs*qprec),Math.round(Yn[to].ys*qprec),Yn[to].zs,eo,yprev];6!=Yn[to].size&&no.push(Yn[to].size),'#000000'!=Yn[to].color&&no.push(Yn[to].color)}Kn.objdata.push(no)}if('W'==Yn[to].type){eo=-1e3;var no=[1,Yn[to].xs*qprec,Yn[to].ys*qprec];0.5!=Yn[to].size&&no.push(Yn[to].size),Kn.objdata.push(no)}if('T'==Yn[to].type){eo=-1e3;var oo=Yn[to].text;1==Yn[to].fall&&(oo='_pho_'+oo),2==Yn[to].fall&&(oo='_lab_'+oo);var no=[2,Yn[to].xs*qprec,Yn[to].ys*qprec,Yn[to].zs,oo];Kn.objdata.push(no)}if('F'==Yn[to].type){if(eo=-1e3,''!=Yn[to].color)var no=[3,Yn[to].xs*qprec,Yn[to].ys*qprec,Yn[to].angle,Yn[to].fall,Yn[to].size,Yn[to].color];else var no=[3,Yn[to].xs*qprec,Yn[to].ys*qprec,Yn[to].angle,Yn[to].fall,Yn[to].size];Kn.objdata.push(no)}if('B'==Yn[to].type){eo=-1e3;var no=[4,Yn[to].xs*qprec,Yn[to].ys*qprec,Yn[to].zs,Yn[to].xe*qprec,Yn[to].ye*qprec,Yn[to].ze,Yn[to].text];Kn.objdata.push(no)}}var po=Object.keys(Kn.authors).length;if(1==po){var co=Ta(0,Kn.authors);null!=co&&(Kn.author=Ta(0,Kn.authors)),null==Kn.authors}var uo=Object.keys(Kn.sids).length;if(1==uo){var co=Ta(0,Kn.sids);null!=co&&(Kn.sid=Ta(0,Kn.sids)),null==Kn.sids}for(var ho in Kn.chlist={},Kn.sids){var ao=oman.changelist[ho];console.log('Element of changelist',ho,ao),null!=ao&&(Kn.chlist[ho]=ao)}return console.log('Saved change list',Kn.chlist),0==Kn.qval.qar.length&&console.log('No Q to save'),0==Kn.pval.par.length&&console.log('No Props to save'),0==Kn.objdata.length&&console.log('No registrations to save'),0==Kn.objdata.length&&0==Kn.pval.par.length&&0==Kn.qval.qar.length&&(Kn=0),Kn}function Ya(Hn,Xn){if(Oi=1,renderblock=1,Xn>=Hn.files.length)return ii.value=null,allq.update(),H(),renderblock=0,re(),void(Oi=0);var Yn=new FileReader;Yn.onload=function(Kn){return 1==Hn.files.length&&params.overridepel?(console.log('open one blank file'),openblankimage(Kn.target.result),Oi=0,void(renderblock=0)):void(Oa(Kn.target.result),console.log('Done reading ',Xn),Ya(ii,Xn+1))},Yn.readAsText(Hn.files[Xn])}function Za(){Js.visible=!1,es=yp=zp=-1e3,Xs=-1,Ps.visible=!1}function $a(Hn,Xn){var Kn=180*(Math.atan2(Hn-ss[ss.length-1].xs,Xn-ss[ss.length-1].ys)/Math.PI);Kn=Math.round(Kn),0>Kn&&(Kn=360+Kn),fs.rotation=Math.round(1e3*(-Math.PI/180*Kn))/1e3,params.angle=Kn,ss[ss.length-1].angle=Kn,Ii.updateDisplay(),oman.updchangelist(ss[ss.length-1].sid)}function el(Hn,Xn,Yn,Kn,Zn,$n){var eo=new THREE.CircleGeometry(Kn,32,Math.PI/4,2.12*Math.PI),to=new THREE.Line(eo,new THREE.LineBasicMaterial({color:$n,linewidth:Zn}));return to.position.set(Hn,Xn,Yn),to}function sl(Hn,Xn,Yn){var Zn=0;null!=Xn&&(Zn=Dt(Xn,1));var $n='object'==typeof Yn?Yn.val:1,eo=new THREE.Object3D,eo=new THREE.TextSprite({textSize:0.25*si*$n,redrawInterval:1e7,texture:{text:Hn+'',fontFamily:'Arial, Helvetica, sans-serif, Bold',fontWeight:'bold',autoRedraw:!1},material:{color:Zn,fog:!1}});return 15!=$n&&globtxt.push(eo),eo.position.set(0,0,1),fcp&&(setTimeout(function(){re()},100),fcp=0),eo}function rl(){Ne(),Le(),Be()}function dl(Hn){var Xn=picparams.ps,Yn=picparams.pe;if(0<pmult){if(Hn>=Xn&&Hn<=Yn)return!0;}else if(Hn>=Yn&&Hn<=Xn)return!0;return!1}function ul(Hn,Xn,Yn){var Kn=Xn,Zn=Yn;if(Yn>Xn){if(Hn>=Kn&&Hn<=Zn)return!0;}else if(Hn>=Zn&&Hn<=Kn)return!0;return!1}var gl=window.getComputedStyle(document.body,null).getPropertyValue('--myyellow'),yl=window.getComputedStyle(document.body,null).getPropertyValue('--myblack'),fl=window.getComputedStyle(document.body,null).getPropertyValue('--mybackground'),vl,wl;this.getrs=function(){return vl},this.callresultstring=function(Hn){de(Hn)},this.getrp=function(){return wl},this.callresultpic=function(Hn){ge(Hn)},this.loadlines=function(Hn){Oa(Hn),allq.update(),H(),re()},this.setauthor=function(Hn){params.author=Hn,Ii.updateDisplay()},this.showvederlag=function(){console.log('vederlag to be done')},this.makenovaxml=function(Hn,Xn){console.log('novaxmlto to be done'),Xn},this.getnxml=function(){return'to be xml text'},this.show3d=function(){ht()},this.show2d=function(){gt()};var kl=S.picsizex,zl=S.picsizey,Fl=S.picadress;Fl='';var Dl=Fl,Ml=S.tung,Vl=S.ling,Ql=getsessionid();newdb=new mydb,newdb.ldb(),picdb=new mypicdb,6>picdb.files.length&&(picdb.files=picfiles,picdb.sdb()),tungeom.Tunnel1=tungeom1.Tunnel1;var Cl=new THREE.MeshBasicMaterial({color:16777215,transparent:!0,opacity:0}),Rl=S.pelstart,Ll=S.pelend,jl=Math.abs(parseInt(Rl)-parseInt(Ll)),Jl=50;11>jl&&(Jl=100),6>jl&&(Jl=200),zl=Jl*jl;var Pl=S.zeropel,Al=S.picpack,El=!1,Tl=kl,Ol=zl;container=condiv();var Il,Bl=new THREE.Raycaster,Gl=new THREE.Vector2,_l=0,Wl=0,Ul=0,Yl=[],es=yp=zp=-1e3,as=yp2d=zp2d=-1e3,ls=[],ss=[],is='Line';oman=new J;var ns=function(){return{s:'bevgsave1',l:'bevgsave1'}}(),ds=new function(){this.idx=[],this.type=[],this.remprev=[],this.xl=[],this.yl=[],this.add=function(Hn,Xn,Yn){this.idx.push(Hn),this.type.push(Xn),this.remprev.push(Yn),this.xl.push(0),this.yl.push(0)},this.addMove=function(Hn,Xn,Yn,Kn,Zn){this.idx.push(Hn),this.type.push(Xn),this.remprev.push(Yn),this.xl.push(Kn),this.yl.push(Zn)},this.removelast=function(){this.type.splice(this.type.length-1,1),this.idx.splice(this.idx.length-1,1),this.remprev.splice(this.remprev.length-1,1),this.xl.splice(this.xl.length-1,1),this.yl.splice(this.xl.length-1,1)}},us,ms,fs,Fs,Ds,Ms=0,Vs=lastmovey=-1e3,Qs=0;Detector.canvas||alert('Browser does not support canvas 3d'),Il=new THREE.Scene;var Rs=new THREE.Scene,Ls=new THREE.Scene,js=Il,Js=new THREE.Object3D,Ps=new THREE.Object3D,As=new THREE.Object3D,Es=new THREE.Object3D,Ts=new THREE.Object3D,Os=new THREE.Object3D,Is=new THREE.Object3D,Bs=new THREE.Object3D,Gs=new THREE.Object3D,Ns=new THREE.Object3D,_s;fallar=new THREE.Object3D,line3dgroup=new THREE.Object3D,line3dtemp=new THREE.Object3D,Il.add(Is),Il.add(Bs),Il.add(Gs);var Ws=new THREE.Object3D,Us=new THREE.Object3D,Hs=new THREE.Object3D,Xs=-1;Js.visible=!1,Ps.visible=!1,pmult=Rl<Ll?1:-1;var Ks=200,Zs=kl/Ks,$s=1,ei=zl/Ks,ti=0,li=1,si=1,ii=document.createElement('input');document.body.appendChild(ii),ii.type='file',ii.accept='.txt',ii.multiple=!0,ii.style.display='none',ii.onchange=function(){if(console.log('Start file read'),null==this.files[0])return void console.log('No files chosen');var Hn=this.files[0].name,Xn=pelfromfname(Hn);params.overridepel&&saveifokdist(Xn[0],Xn[1]),('t'==Hn[Hn.length-1]||'T'==Hn[Hn.length-1])&&Ya(this,0)};var oi=document.createElement('input');document.body.appendChild(oi),oi.type='file',oi.style.display='none',oi.onchange=function(){if(null==this.files[0])return void console.log('No photo chosen');var Hn=this.files[0].name;('g'==Hn[Hn.length-1]||'G'==Hn[Hn.length-1])&&ae(this)};var ri=new Image,di=document.getElementById('linbtn'),pi=document.getElementById('watbtn'),ci=document.getElementById('txtbtn'),ui=document.getElementById('falbtn'),hi=document.getElementById('selbtn'),gi=document.getElementById('undbtn'),mi,yi;F();var fi=new THREE.Vector2(mi,yi),bi=mi/yi,vi=2.5*ei*Math.sqrt(2.28/(ei/Zs)),xi=vi,Si;(function(){null!=renderer&&document.getElementById(h).removeChild(renderer.domElement),renderer=new THREE.WebGLRenderer({antialias:!1,alpha:!0,premultipliedAlpha:!0});var Hn=android?0.8:1;renderer.setPixelRatio(window.devicePixelRatio/Hn),renderer.setClearColor(Dt(fl,1)),renderer.setSize(mi,yi),document.getElementById(h).appendChild(renderer.domElement),cameraFix=new THREE.OrthographicCamera(-vi*bi/2,vi*bi/2,xi/2,-xi/2,-5e3,5e3),camera=new THREE.OrthographicCamera(-vi*bi/2,vi*bi/2,xi/2,-xi/2,-5e3,5e3),camera.position.set(0,0,$s),Si=camera.zoom,controls=new THREE.OrbitControls(camera,renderer.domElement),controls.enableDamping=!1,controls.dampingFactor=0.3,controls.enableRotate=!1,controls.rotateSpeed=0.45,controls.zoomSpeed=1,android||iOS||(controls.zoomSpeed=3),controls.target.set(0,0,0),controls.addEventListener('change',function(){ea(1)})})();var zi=document.getElementById(h).offsetTop,Fi=document.getElementById(h).offsetLeft;Il.add(As),Il.add(Ws),Il.add(Hs),Il.add(Us),Il.add(Ts),Il.add(Os),Il.add(Es);var Di,Mi;xa(Fl,0),function(){var Hn=0.07*si,Xn=0.14*si,Yn=Y(-Hn,-Hn,10,Hn,Hn,10,8*si,'#000000'),Kn=Y(Hn,-Hn,10,-Hn,Hn,10,8*si,'#000000');Js.add(Yn,Kn),Il.add(Js);var Zn=Y(-Xn,-Xn,10,Xn,-Xn,10,5*si,'#000000'),$n=Y(Xn,-Xn,10,Xn,Xn,10,5*si,'#0000ff'),eo=Y(Xn,Xn,10,-Xn,Xn,10,5*si,'#ff0000'),to=Y(-Xn,Xn,10,-Xn,-Xn,10,5*si,'#00ff00');Ps.add(Zn,$n,eo,to),Il.add(Ps)}();var Vi=['none','Hornfels','Svartskifer','Sill','Spr\xF8ytebetong','Special','Weakness','Basalt','Calcite','Granite','Pyrite'],Qi=['#ffffff','#D0D470','#817A85','#EDA155','#877D7B','#ED4AE8','#771111','#000000','#aaffaa','#aa7777','#ff2222'],ji,Pi,Ai,Ei,Ti={rqd:'',Jn:'',Jr:'',Ja:'',Jw:'',SRF:'',Q:''},Oi=0;(android||iOS)&&setInterval(function(){vt()},3e4),params={ex:!1,restses:1,loadprev:function(){myask(container,qa.unsaved,function(){L(),xt()})},savexml:function(){Ra(params.tunnel)},forcesync:!1,enrot:!1,linetype:'Line',linemagnet:!0,lineStyle:qa.lineStylear[0],tunnel:picparams.ps>tunborder?'Bamble':'Kjorholt',vederlag:!1,text:'',author:'V',onlynew:!1,onlycurpel:!1,rutenett:!1,size:0.5,wsize:0.5,opacity:0.5,angle:0,fall:45,layer:0,showholes:!1,showholeask:function(){myask(container,'This will take up to 10 seconds calculations.',function(){params.showholefunc()})},showholefunc:function(){params.showholes=!0,''!=strin&&(!android&&(strin=strin2),Ns=makecloud(strin));var Hn=getglobc((Rl+Ll)/2),Xn=new THREE.Object3D;Xn.add(Ns),Xn.position.set(-Hn.x,-Hn.y,-Hn.z),my3dgroup.add(Xn),re(),Pa('3d')},move:!1,movestart:!1,color:'#000000',parcolor:'#000000',savealpha:function(){dt(),ea(null,1),re();var Hn=renderer.domElement.toDataURL(),Xn=new Date,Yn='';Yn=Yn+'geo'+Xn.getHours()+'h'+Xn.getMinutes()+'m'+Xn.getSeconds()+'s.png',Ln(Hn,Yn),ft(),lsc=1,H()},what2plot:'Geo+Q+Pel',withbg:!0,showbergart:!0,tstval:45,bolt:function(){hi.value='Select',Pa('Bolt')},boltlen:5,bolttype:'Steel',wtxt:'',dsc:'Not given',wleak:0,wdrip:0,save:function(){var Hn='Save all registrations as \n'+params.tunnel+' tunnel?';myask(container,Hn,function(){params.onlynew=!1,disassemble(),Ii.updateDisplay()})},textsave:'',clear:function(){myask(container,qa.unsaved,function(){L()})},load:function(){Oa(params.textsave),re()},go3d:ht,go2d:gt,getflist:function(){Qa()},add5m:function(){fgui.close(),Ii.close(),yt()},resetcam:function(){Ii.updateDisplay(),controls.reset(),controls.target.set(0,0,0),camera.position.set(0,0,$s),Za(),re()},openfile:function(){params.overridepel?myask(container,qa.unsaved,function(){ii.click()}):ii.click()},overridepel:!0,openfoto:function(){oi.click()},makelab:function(){se(Xs,qa.labtest,2),Ii.updateDisplay()},dummy:function(){},apply:function(){Ne()},applyP:function(){We()},qedit:function(){},editRQD:function(){rqdmenu(Zi,container,rl)},editJn:function(){jnmenu(Zi,container,rl)},editJr:function(){jrmenu(Zi,container,rl)},editJa:function(){jamenu(Zi,container,rl)},editJw:function(){jwmenu(Zi,container,rl)},editSRF:function(){srfmenu(Zi,container,rl)},removeq:function(){myask(container,qa.removeqmes,function(){_e()})}},params.author=function(){return localStorage.getItem('lastauthor')?localStorage.getItem('lastauthor'):'none'}(),params.tunnel=gettunnel()?gettunnel():tunlist[0];var Ii=new dat.GUI({autoPlace:!1});Ii.domElement.id='guipos',Ii.close(),container.appendChild(Ii.domElement),Pa('Line'),lasst=params.tunnel,myaddfunc.flip=function(){renderblock=1;var Hn=vt();L();var Xn=picparams.ps;picparams.ps=picparams.pe,picparams.pe=Xn,fgui.updateDisplay(),saveifokdist(picparams.ps,picparams.pe),''==Fl?ba(picparams.ps,picparams.pe):fa(picparams.ps,picparams.pe),Hn&&xt(),renderblock=0,re(),Pa('Line'),hi.value='Select',fgui.close(),Ii.close()},myaddfunc.openblank=function(){console.log('Oblank'),fgui.close(),myask(container,qa.unsaved,function(){getbypl(picparams.ps,picparams.pe)})};var Bi={showdb:function(){var Hn=function(){mt.start('Opening files');for(var Yn=0,Kn=0;Kn<newdb.files.length;Kn++)newdb.files[Kn].ischosen&&!newdb.files[Kn].toskip&&Yn++;if(Yn){if(params.overridepel){var Zn=getchosenpels(newdb),$n=Zn[0],eo=Zn[1];picparams.ps=$n,picparams.pe=eo,fgui.updateDisplay(),saveifokdist(picparams.ps,picparams.pe),ba(picparams.ps,picparams.pe)}var to=0;renderblock=1;for(var ao,Kn=0;Kn<newdb.files.length;Kn++)ao=newdb.files[Kn],ao.ischosen&&!newdb.files[Kn].toskip&&(to++,Oa(ao.savedata));H(),allq.update(),renderblock=0,re(),newdb.uncheckall();var lo=mt.end('Opening files');Pa('Line'),'debug'==params.author&&R('Files '+lo+'ms',1)}};dbtable(container,function(){params.ex?myask3(container,qa.openneworex,qa.opennew,function(){params.overridepel=!0,Hn(),Ii.updateDisplay()},qa.opentoexisting,function(){params.overridepel=!1,Hn()}):(Hn(),Ii.updateDisplay())})},showpicdb:function(){dbpictable(container,Gi)},newblank:function(){fa(picparams.ps,picparams.pe)}};picparams.openf=function(){myask(container,qa.unsaved,function(){picdb.makefromfiles(function(){for(var Hn in picdb.sortbytime(),picdb.files)if(!picdb.files[Hn].toskip){picdb.files[Hn].ischosen=1;break}Gi(1)})})};var Gi=function(Hn){var Xn=getchosenpels(picdb);if(null!=Xn){var Yn=Xn[0],Kn=Xn[1],Zn=Xn[2];picparams.ps=Yn,picparams.pe=Kn,fgui.updateDisplay(),saveifokdist(picparams.ps,picparams.pe),console.log('Chosen are',picparams.ps,picparams.pe),Hn?getbypl(picparams.ps,picparams.pe):ba(picparams.ps,picparams.pe,Zn),Bt(),picdb.uncheckall()}},Ni=je(fgui),_i=Ma('Start!',function(){myaddfunc.openblank()});_i.setAttribute('class','inguib but1gui aguibut'),Ni.appendChild(_i);var Ni=je(fgui),_i=Ma('Flip pic',function(){myaddfunc.flip()});_i.setAttribute('class','inguib but2gui'),Ni.appendChild(_i),_i=Ma('Add 5m',function(){params.add5m()}),_i.setAttribute('class','inguib but2gui'),Ni.appendChild(_i);var Ni=je(fgui),_i=Ma('MWDdb',function(){Bi.showpicdb()});_i.setAttribute('class','inguib but2gui aguibut'),Ni.appendChild(_i),_i=Ma('Open geom',function(){picparams.openf()}),_i.setAttribute('class','inguib but2gui aguibut'),Ni.appendChild(_i);var Ni=je(fgui),_i=Ma('Go 2d',function(){params.go2d()});_i.setAttribute('class','inguib but2gui'),Ni.appendChild(_i),_i=Ma('Go 3d',function(){params.go3d()}),_i.setAttribute('class','inguib but2gui'),Ni.appendChild(_i),fgui.add(params,'tunnel',tunlist).name('Tunnel:').onChange(function(){savetunnel(params.tunnel),Bt()}),fgui.add(params,'vederlag').name(qa.showved).onChange(function(){H(),re()}),fgui.add(params,'rutenett').name(qa.rutenett).onChange(function(){kt(Rl,Ll),re()}),B(Rl,Ll);var Wi=new THREE.TextureLoader;Wi.crossOrigin='anonymous';var Ui=Wi.load(spcline),Hi=Wi.load(spcline1,function(){Hi.wrapS=Hi.wrapT=THREE.RepeatWrapping,Hi.offset.set(0,0),Hi.repeat.set(1,1)}),Xi=Wi.load(spcline2,function(){Xi.wrapS=Xi.wrapT=THREE.RepeatWrapping,Xi.offset.set(0,0),Xi.repeat.set(1,1)}),Ki=new Ga,Zi=new Ze,$i=new Ue;Zi.getQ(),allq=new Ke,allp=new He;var en=chosenp=-2;Sa(Rl,Ll,-1);var tn=0,ln=new Hammer(di);di.onclick=function(){if(tn)return void(tn=0);var Xn=0,Yn=Ii.closed;'Line'==params.linetype&&(Xn=1),Pa('Line'),V(this),Xn&&O(),Yn&&Ii.close(),Ii.removeFolder(qa.qval),Ii.removeFolder(qa.setproperties),hi.value='Select'},(iOS||android)&&ln.on('press',function(){di.click(),tn=1,setTimeout(function(){tn=0},250)}),ln.get('press').set({threshold:100,time:3});var nn=new Hammer(pi);pi.onclick=function(){return tn?void(tn=0):void(Pa('Water'),hi.value='Select',V(this),'debug'==params.author&&oa())},(iOS||android)&&nn.on('press',function(){pi.click(),tn=1,setTimeout(function(){tn=0},250)}),nn.get('press').set({threshold:100,time:3});var rn=new Hammer(ci);ci.onclick=function(){Pa('Text'),hi.value='Select',V(this)},(iOS||android)&&rn.on('press',function(){ci.click(),tn=1,setTimeout(function(){tn=0},250)}),rn.get('press').set({threshold:100,time:3});var dn=new Hammer(ui);ui.onclick=function(){return El?void Kt():void(Pa('Fall'),hi.value='Select',V(this))},(iOS||android)&&dn.on('press',function(){ui.click(),tn=1,setTimeout(function(){tn=0},250)}),dn.get('press').set({threshold:100,time:3});var cn=new Hammer(gi);gi.onclick=function(){android&&ke(),hi.value='Select',Vt()},cn.on('press',function(){android||(ke(),hi.value='Select',tn=1,setTimeout(function(){tn=0},250))}),cn.get('press').set({threshold:100,time:3});var un=0,hn=new Hammer(hi);android&&(hi.onclick=function(){un||gn(1)}),hn.on('press',function(){gn(0),un=1,setTimeout(function(){un=0},250)}),hn.get('press').set({threshold:100,time:3});var gn=function(){return'Select'==hi.value?(hi.value='Group',void Pa('Select')):'One'==hi.value?void(hi.value='Group'):'Group'==hi.value?void(hi.value='One'):void 0};Ge();Il.children.length;document.addEventListener('keydown',function(Hn){switch(Hn.keyCode){case 65:break;case 66:break;case 67:break;case 68:}},!1),window.addEventListener('resize',ft,!1),window.addEventListener('orientationchange',ft,!1);var yn=null,fn=new Hammer(renderer.domElement),bn=lasty=-1e3,xn=firsty=firstz=-1e3,wn=endy=-1e3;fn.on('press',function(Hn){Qs=new Date().getTime(),P(Hn),'Line'==params.linetype&&H()}),fn.on('pan',function(Hn){if('Line'==params.linetype){var Xn=(bn-Hn.center.x+Fi)*(bn-Hn.center.x+Fi)+(lasty-Hn.center.y+zi)*(lasty-Hn.center.y+zi);Xn>sensivity*sensivity&&P(Hn)}if('Select'==params.linetype){if(_l)return;var Xn=(bn-Hn.center.x+Fi)*(bn-Hn.center.x+Fi)+(lasty-Hn.center.y+zi)*(lasty-Hn.center.y+zi),Yn=Hn.velocityX*Hn.velocityX+Hn.velocityY*Hn.velocityY;20<Yn&&(fe(),_l=1),params.move&&5>Yn&&(1e4<Xn||params.movestart)&&(P(Hn),params.movestart=!0)}'Bolt'==params.linetype&&P(Hn),'Fall'==params.linetype&&P(Hn)}),fn.on('panstart',function(){Wl=1,Ul=1,_l=0,params.move=!0,params.movestart=!1,!El||controls.enableRotate}),fn.on('panend',function(){'Line'==params.linetype&&(Za(),Qs=new Date().getTime()),params.move=!1,'Line'==params.linetype&&H(),re(),_l=0,Wl=0,Ul=0,El}),fn.on('pinchstart',function(){clearTimeout(yn),yn=null,Za()}),Q(fn);re();var Wi=new THREE.TextureLoader;Wi.crossOrigin='anonymous';var kn=Wi.load(Al.imdrop),zn=new THREE.SpriteMaterial({map:kn,color:16777215}),Fn=Wi.load(Al.fallMap),qn=Wi.load(Al.fallMapA180),Dn=Wi.load(Al.fallMapF0),Mn=Wi.load(imflask),Vn=Wi.load(imphoto),Qn=new THREE.SpriteMaterial({map:Mn}),Cn=new THREE.SpriteMaterial({map:Vn}),Rn=1,Ln=function(Hn,Xn){var Yn=document.createElement('a');'string'==typeof Yn.download?(document.body.appendChild(Yn),Yn.download=Xn,Yn.href=Hn,Yn.click(),document.body.removeChild(Yn)):location.replace(uri)};var jn=function(Hn,Xn){var Yn=new THREE.Vector3().subVectors(Xn,Hn),Kn=new THREE.Matrix4;Kn.lookAt(Hn,Xn,new THREE.Object3D().up);var Zn=new THREE.Matrix4;Zn.set(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),Kn.multiply(Zn);var $n=new THREE.CylinderGeometry(0.1,0.1,Yn.multiplyScalar(0.3).length(),48,1),eo=new THREE.Mesh($n,new THREE.MeshBasicMaterial({color:0}));eo.applyMatrix(Kn);var to=new THREE.Vector3().addVectors(Hn,Yn.multiplyScalar(0.5));return eo.position.set(to.x,to.y,to.z),eo},Jn=function(Hn,Xn){var Yn,Kn,Zn,$n,eo,to,ao,lo,no,oo,po,co,uo,ho;for(uo=[],ao=Hn.geometry.faceVertexUvs[0],lo=Hn.geometry.faces,no=Hn.geometry.vertices,oo=new THREE.Matrix4,po=new THREE.Matrix4,ho=new THREE.Matrix4,Rs.updateMatrixWorld(!0),$n=0;$n<ao.length;$n++)if(eo=ao[$n],to=lo[$n],rt(eo,Xn)){Yn=no[to.a].clone().applyMatrix4(Hn.matrixWorld),Kn=no[to.b].clone().applyMatrix4(Hn.matrixWorld),Zn=no[to.c].clone().applyMatrix4(Hn.matrixWorld),oo.set(Yn.x,Yn.y,Yn.z,0,Kn.x,Kn.y,Kn.z,0,Zn.x,Zn.y,Zn.z,0,0,0,0,1),po.set(eo[0].x,eo[0].y,0,1,eo[1].x,eo[1].y,0,1,eo[2].x,eo[2].y,0,1,0,0,1,0),po.getInverse(po),oo.multiplyMatrices(po,oo),oo.elements=at(oo),oo.transpose(),co=new THREE.Vector3(Xn.x,Xn.y,1);var go=co.applyMatrix4(oo);uo.push(go),uo.push(to.normal)}return uo};check3dbox.onchange=function(){controls.enableRotate=check3dbox.checked,Ii.updateDisplay()},syncfun=function(Xn,Yn){var Kn=function(){putdbf(Xn),Ql=getsessionid()},Zn=function(){mt.end('Merging'),newdb.syncall(),Kn()},$n=function(to){mt.start('Merging'),syncbtn.textContent='Merge start',newdb.wipeold(function(){newdb.mergewithstring(to,Zn)})};getver(function(to){var ao=to[0];console.log('localver=',newdb.getsid(),'onlinever',ao);var lo=!0;for(var no in newdb.files)lo=lo&&newdb.files[no].issynced;syncbtn.textContent='Got versions',newdb.getsid()!=ao||!lo||params.forcesync?(syncbtn.textContent=newdb.getsid()+' '+ao,getdbf($n)):(console.log('Version is up to date'),syncbtn.textContent='Version is up to date',null!=Yn&&Yn())})};getbypl=function(Xn,Yn){var Kn=normPel(Xn,Yn),Zn=Kn[0],$n=Kn[1],eo=Zn,to=$n,ao=newdb.sorted;newdb.sortbypelasc();var lo=[],no=JSON.parse(JSON.stringify(newdb.files));for(var oo in no){var po=no[oo];if(!po.toskip){var co=normPel(po.ps,po.pe);numintersect(Zn,$n,co[0],co[1])&&(eo=Math.min(eo,Zn,$n,co[0],co[1]),to=Math.max(to,Zn,$n,co[0],co[1]),lo.push(po.savedata))}}for(var oo in newdb.sortbytime(),ba(eo,to),renderblock=1,lo)Oa(lo[oo]);H(),allq.update(),renderblock=0,re()};var An,Tn;Bt();var On=300,In=0,Bn,Gn=new THREE.Object3D;Il.add(Gn);var Nn=[],_n=1,Wn,Un;cutpels=function(){params.onlycurpel=!0;var Hn=Xa();L(),Oa(Hn),H(),allq.update(),re(),params.onlycurpel=!1},disassemble=function(){var Hn=Xa();console.log('Sids are',Hn.sids);var Xn=[];for(var Yn in Hn.sids)Xn.push(Yn);for(var Kn in Xn)params.onlynew=parseInt(Xn[Kn]),Kn==Xn.length-1?de(1):de(1,1);params.onlynew=0,ue()},dat.GUI.prototype.removeFolder=function(Hn){var Xn=this.__folders[Hn];Xn&&(Xn.close(),this.__ul.removeChild(Xn.domElement.parentNode),delete this.__folders[Hn],this.onResize())},S.callback(),picdb.ldb(function(){ba(picparams.ps,picparams.pe,params.tunnel)})}