function bevgeoplot(h,S){function F(){bi=document.getElementById(h).offsetWidth,vi=document.getElementById(h).offsetHeight}function D(Zn){console.log('Resetting render'),null!=renderer&&document.getElementById(h).removeChild(renderer.domElement),renderer=new THREE.WebGLRenderer({antialias:!1,alpha:!0});var $n=android?1:1;renderer.setPixelRatio(window.devicePixelRatio/$n),renderer.setClearColor(Mt(wl,1)),renderer.setSize(bi,vi),document.getElementById(h).appendChild(renderer.domElement),cameraFix=new THREE.OrthographicCamera(-ki*Si/2,ki*Si/2,zi/2,-zi/2,-5e3,5e3),camera=new THREE.OrthographicCamera(-ki*Si/2,ki*Si/2,zi/2,-zi/2,-5e3,5e3),camera.position.set(0,0,li),Fi=camera.zoom,controls=new THREE.OrbitControls(camera,renderer.domElement),controls.enableDamping=!1,controls.dampingFactor=0.3,controls.enableRotate=!1,controls.screenSpacePanning=true,controls.rotateSpeed=0.45,controls.panSpeed = 1.5,android||iOS||(controls.panSpeed=1),controls.zoomSpeed=1,android||iOS||(controls.zoomSpeed=3),controls.target.set(0,0,0),controls.addEventListener('change',function(){ia(1)});var eo=new Hammer(renderer.domElement);Q(eo),null!=Zn&&Zn()}function M(Zn){var $n=Zn.add(bf,'blank').name('').__li;$n.setAttribute('class','cr function mydum')}function V(){}function Q(Zn){Zn.on('press',function($n){Ls=new Date().getTime(),A($n),'Line'==params.linetype&&X()}),Zn.on('pan',function($n){if('Line'==params.linetype){var eo=(wn-$n.center.x+Vi)*(wn-$n.center.x+Vi)+(lasty-$n.center.y+Mi)*(lasty-$n.center.y+Mi);eo>sensivity*sensivity&&A($n)}if('Select'==params.linetype){if(Hl)return;var eo=(wn-$n.center.x+Vi)*(wn-$n.center.x+Vi)+(lasty-$n.center.y+Mi)*(lasty-$n.center.y+Mi),to=$n.velocityX*$n.velocityX+$n.velocityY*$n.velocityY;20<to&&(be(),Hl=1),params.move&&5>to&&(1e4<eo||params.movestart)&&(A($n),params.movestart=!0)}'Bolt'==params.linetype&&A($n),'Fall'==params.linetype&&A($n)}),Zn.on('panstart',function(){Xl=1,Yl=1,Hl=0,params.move=!0,params.movestart=!1,!Il||controls.enableRotate}),Zn.on('panend',function(){'Line'==params.linetype&&($a(),Ls=new Date().getTime()),params.move=!1,'Line'==params.linetype&&X(),de(),Hl=0,Xl=0,Yl=0,Il}),Zn.on('pinchstart',function(){clearTimeout(xn),xn=null,$a()}),C(Zn)}function C(Zn){Zn.get('tap').set({threshold:1,posThreshold:1,time:1,interval:2}),Zn.get('press').set({threshold:50,time:3}),Zn.get('pan').set({threshold:sensivity,time:4,direction:Hammer.DIRECTION_ALL}),Zn.get('pinch').set({enable:!0})}function R(Zn,$n){var eo=null==$n?Nl:$n;if(null==Zn)return console.log('Null object!'),null;for(var to,ao=0;ao<eo.children.length;ao++)if(eo.children[ao].uuid==Zn){to=eo.children[ao];break}return to}function L(Zn,$n){var eo=document.getElementsByClassName('close-button close-bottom'),to=null==$n?0:1;eo[to].innerHTML=Zn}function J(){D(),line3dtemp.children.length=0,line3dgroup.children.length=0,fallar.children.length=0,Es.visible=!1,ss=yp=zp=-1e3,kn=-1e3,renderblock=1;for(var Zn=0;Zn<oman.ao.length;Zn++)oman.removefromscene(oman.get(Zn));ds=[],oman=new P,Fa(),allp=new Xe,allq=new Ze,X(),allq.update(),renderblock=0,de()}function P(){this.ao=ds,this.history=[],this.sid=Rl,this.so=null,this.sp=null,this.selidx=null,this.changelist={},this.updchangelist=function(Zn){this.changelist[Zn]=Rl},this.select=function(Zn,$n){this.so=null,this.sp=null,this.selidx=null;var eo=De(Zn,$n);if(eo[3]>Math.sqrt(si*si+ti*ti)/7)return console.log('Nothing selected'),[null,null];var to=eo[0];return this.selidx=to,this.so=this.get(to),this.so||console.log('No object selected'),this.sp=allp.par[Oe(to)],this.sp||console.log('No property selected'),Ts.visible=!!this.so,[this.so,this.sp]},this.get=function(Zn){var $n=this.ao[Zn];return null==$n?(console.log('No object ',Zn),null):$n},this.add=function(Zn){this.ao.push(Zn)},this.undo=function(){var Zn=this.history.pop();return Zn?void('add'==Zn[0]&&(this.removefromscene(Zn[1]),this.history.pop()),'remove'==Zn[0]&&(this.plot(Zn[1]),this.history.pop()),'removeSequence'==Zn[0]&&(this.plot(Zn[1]),this.history.pop(),'removeSequence'==this.history[this.history.length-1][0]&&this.undo()),'movefrom'==Zn[0]&&this.move(Zn[1],Zn[2],Zn[3]),X(),de()):void console.log('No history elements')},this.move=function(Zn,$n,eo){if(null==Zn)return void console.log('Trying to move null object');var to=R(Zn.id,'B'==Zn.type?Gs:null);if(to){var ao=$n-Zn.xs,lo=eo-Zn.ys;to.position.x+=ao,to.position.y+=lo,params.movestart||this.history.push(['movefrom',Zn,Zn.xs,Zn.ys]),Zn.xs=$n,Zn.ys=eo,Ts.visible=!0,Ts.position.set($n,eo,10),this.updchangelist(Zn.sid)}},this.erasefromhistory=function(Zn){for(var $n=0;$n<this.history.length;$n)this.history[$n][1].sameas(Zn)?this.history.splice($n,1):$n++},this.removefromscene=function(Zn,$n){if(1==Zn.skip)return!1;if('L'==Zn.type)return Zn.skip=1,$n?this.history.push(['removeSequence',Zn]):this.history.push(['remove',Zn]),renderblock||this.updchangelist(Zn.sid),!0;var eo=R(Zn.id,'B'==Zn.type?Gs:null);return null==eo?(console.log('No such object on scene',Zn),!1):('B'==Zn.type?Gs.remove(eo):Nl.remove(eo),this.history.push(['remove',Zn]),de(),Zn.skip=1,renderblock||this.updchangelist(Zn.sid),!0)},this.isdublicate=function(Zn){for(var eo,$n=0;$n<this.ao.length;$n++)eo=this.get($n),eo.sameas(Zn)&&(this.removefromscene(eo),this.erasefromhistory(Zn))},this.plot=function(Zn){if('L'==Zn.type)return Zn.skip=0,void this.history.push(['add',Zn]);var $n;'W'==Zn.type&&($n=ee(Zn.xs,Zn.ys,Zn.zs,Zn.size)),'F'==Zn.type&&($n=re(Zn.xs,Zn.ys,Zn.zs,Zn.angle,Zn.fall,Zn.size),''!=Zn.color&&Ht(Zn.color)),'T'==Zn.type&&($n=ae(Zn.text,Zn.xs,Zn.ys,Zn.zs,1- -Zn.fall)),'B'==Zn.type&&($n=_(Zn.xs,Zn.ys,Zn.zs,Zn.xe,Zn.ye,Zn.ze),Vs=[$n,Zn],Gs.add($n));$n&&($n.name=ds.length,Zn.id=$n.uuid,Zn.skip=0,this.history.push(['add',Zn]),'B'!=Zn.type&&Nl.add($n),de())}}function A(Zn){!0==controls.enableRotate||((!params.move||'Line'==params.linetype)&&(wn=Zn.center.x-Vi,lasty=Zn.center.y-Mi),Wl.x=2*((Zn.center.x-Vi)/bi)-1,Wl.y=2*-((Zn.center.y-Mi)/vi)+1,Il?E():O())}function E(){fcp=1,_l.setFromCamera(Wl,camera);var Zn=_l.intersectObjects(meshes.children);if(0<Zn.length){var $n=new Na;$n.sid=Rl;var eo=mr(ss),to=mr(yp),ao=mr(zp),lo=mr(is),no=mr(yp2d),oo=mr(Zn[0].point.x),po=mr(Zn[0].point.y),co=mr(Zn[0].point.z),uo=mr(2*(Zn[0].uv.x-0.5)*ti),ho=mr(2*(Zn[0].uv.y-0.5)*si);if(-1e3<ss){var go=params.lineStyle==qa.lineStylear[0]?0:params.lineStyle==qa.lineStylear[1]?1:params.lineStyle==qa.lineStylear[2]?2:3,mo=go+params.color,yo=K(eo,to,ao,oo,po,co,Math.round(40*params.size),params.color);if(2==Zn.length){var fo=mr(2*(Zn[1].uv.x-0.5)*ti),bo=mr(2*(Zn[1].uv.y-0.5)*si),vo={xs:fo,ys:bo,v:new THREE.Vector3(Zn[1].point.x,Zn[1].point.y,Zn[1].point.z)};linez.push(vo)}var vo={xs:lo,ys:no,v:new THREE.Vector3(eo,to,ao)};linez.push(vo),line3dtemp.add(yo)}ss=oo,yp=po,zp=co,is=uo,yp2d=ho,zp2d=co}de()}function T(Zn){return Math.min(ti,Math.max(Zn,-ti))}function O(){fcp=1,_l.setFromCamera(Wl,camera);var Zn=_l.intersectObjects(ns);if(0<Zn.length){var $n=new Na;$n.sid=Rl;var eo=mr(ss),to=mr(yp),ao=mr(zp),lo=mr(Zn[0].point.x),no=mr(Zn[0].point.y),oo=mr(Zn[0].point.z);if(!Il&&!params.move&&lo<-ti&&'Select'==params.linetype)return Be(no),Ge(),void de();if('Line'==params.linetype){if(eo=T(eo),lo=T(lo),-1e3<ss){Es.visible=!0,Es.position.set(lo,no,10);var po=params.lineStyle==qa.lineStylear[0]?0:params.lineStyle==qa.lineStylear[1]?1:params.lineStyle==qa.lineStylear[2]?2:3,co=po+params.color,uo=0,ho=(lo-eo)*uo,mo=K(eo,to,ao,lo+ho,no+(no-to)*uo,oo+params.layer+1,Math.round(30*params.size),params.color);mo.name=ds.length,$n.addline(eo,to,ao,lo,no,oo+params.layer+1,Math.round(30*params.size),co),oman.plot($n),oman.add($n),Is.add(mo),kn=lo,endy=no}else Sn=lo,firsty=no,firstz=oo;Es.visible=!0,Es.position.set(lo,no,10),ss=lo,yp=no,zp=oo+params.layer+1}if('Bolt'==params.linetype&&lo>=-ti&&lo<=ti)if(!Xl)$n.addbolt(lo,no,oo+7,lo,no,oo+7,params.bolttype),oman.plot($n),oman.add($n);else{H(lo,no,oo+7);var yo=oman.get(ds.length-1);yo.xe=bs.vertices[1].x,yo.ye=bs.vertices[1].y,yo.ze=bs.vertices[1].z}if('Fall'==params.linetype&&lo>=-ti&&lo<=ti&&(Yl?0!=params.fall&&el(lo,no,oo+7):($n.addfall(lo,no,oo+7,params.angle,params.fall,Jl<Pl),oman.plot($n),oman.add($n))),'Water'==params.linetype&&lo>=-ti&&lo<=ti&&($n.addwater(lo,no,oo+7,Math.round(10*params.wsize)/10),oman.plot($n),oman.add($n)),'Text'==params.linetype&&lo>=-ti&&lo<=ti&&''!=params.text&&($n.addtext(params.text,lo,no,oo+params.layer+1),oman.plot($n),oman.add($n)),'Select'==params.linetype&&lo>=-ti&&lo<=ti)if(!params.move){oman.select(lo,no);var fo=De(lo,no);if(fo[3]>Math.sqrt(si*si+ti*ti)/7)return;Ts.visible=!0,Ts.position.set(fo[1],fo[2],10),Zs=fo[0],Te(Zs)}else if(oman.so){var bo=lo-0.1*ti/camera.zoom,vo=no+0.1*si/camera.zoom;oman.move(oman.get(Zs),bo,vo)}}else'Select'==params.linetype?params.move&&be():($a(),Ts.visible=!1);de()}function I(){if(-1e3<kn){var Zn=new Na;Zn.sid=Rl;var $n=params.lineStyle==qa.lineStylear[0]?0:params.lineStyle==qa.lineStylear[1]?1:params.lineStyle==qa.lineStylear[2]?2:3;if(0<$n)return void(kn=endy=Sn=firsty=firstz=-1e3);var eo=$n+params.color;Zn.addline(kn,endy,firstz+params.layer+1,Sn,firsty,firstz+params.layer+1,Math.round(30*params.size),eo),oman.plot(Zn),oman.add(Zn),kn=endy=Sn=firsty=firstz=-1e3,X(),de()}}function B(Zn,$n,eo){var to=new THREE.LineSegmentsGeometry;to.setPositions(Zn);var ao=new THREE.LineMaterial({color:0,linewidth:$n,dashed:!1}),lo=renderer.getSize();ao.resolution.set(lo.width,lo.height);var no=new THREE.LineSegments2(to,ao);return null==eo&&Bs.add(no),no}function G(Zn,$n,eo){Nl.remove(Ns);var to=[],lo=0.1*ri;Ns=new THREE.Object3D;var no=-si,oo=si,po=1.13*ti,co=1.067*ti;to.push(po,no,2,po,oo,2);var uo={val:15},ho=ae(Zn,po+0.11*ti,no+lo,0,0,fl);Ns.add(ho),to.push(po,no,2,co,no,2),to.push(po,no,2,co,no,2);var go=ae($n,po+0.11*ti,oo-lo,0,0,fl);Ns.add(go),to.push(po,oo,2,co,oo,2,-po,oo,10,-co,oo,10);for(var mo=1;mo<pmult*($n-Zn)/5;++mo){var yo=-si+5*(pmult*mo*(oo-no))/($n-Zn),fo=5*pmult*mo+parseInt(Zn),bo=ae(fo,po+0.11*ti,yo,0,0,fl);Ns.add(bo),to.push(po,yo,2,co,yo,2,-po,yo,10,-co,yo,10)}Ns.add(B(to,2,1));var vo=normPel(Zn,$n);if(100<vo[1]-vo[0])for(var mo=vo[0]-1;mo<=vo[1];mo++)if(0==mo%100){fcp=1;var xo=ae(mo,4*ti,_a(mo),uo,0,fl);Ns.add(xo),fcp=0}if(null!=eo){Ns.position.set(0,eo,0)}Nl.add(Ns)}function _(Zn,$n,eo,to,ao,lo){var no=new THREE.Object3D,oo=0.07,po=K(Zn+oo,$n+oo,eo,Zn-oo,$n-oo,eo-0.01,2,'#000000'),co=K(Zn-oo,$n+oo,eo,Zn+oo,$n-oo,eo-0.01,2,'#000000'),uo=sl(Zn,$n,eo,2*(oo/Math.sqrt(2)),2,'#000000');return Qs=U(Zn,$n,eo,to,ao,lo,1,'#000000'),no.add(po),no.add(co),no.add(uo),no.add(Qs),no}function W(){return 1/2e3}function U(Zn,$n,eo,to,ao,lo,no,oo){bs=new THREE.Geometry,ws=new THREE.Vector3(Zn,$n,eo),bs.vertices.push(ws),bs.vertices.push(new THREE.Vector3(to,ao,lo));return Y([Zn,$n,eo,to,ao,lo],10,oo)}function H(Zn,$n,eo){var to=(ws.x-Zn)*(ws.x-Zn)+(ws.y-$n)*(ws.y-$n),ao=2*(El/ei),lo=params.boltlen*Math.sin(Math.PI/24);if(to=Math.sqrt(to)/ao,to<lo)Vs[0].remove(Qs),Qs=U(ws.x,ws.y,ws.z,Zn,$n,eo,1,'#000000'),Vs[0].add(Qs),Vs[1].xe=Zn,Vs[1].ye=$n,Vs[1].ze=eo;else{var oo,po;oo=ws.x+(Zn-ws.x)/to*lo,po=ws.y+($n-ws.y)/to*lo,Vs[0].remove(Qs),Qs=U(ws.x,ws.y,ws.z,oo,po,eo,1,'#000000'),Vs[0].add(Qs),Vs[1].xe=oo,Vs[1].ye=po,Vs[1].ze=eo}}function X(){Da(),Ft();for(var Zn=[],$n=0;$n<ds.length;$n++)0==ds[$n].skip&&Zn.push(ds[$n]);for(var ao,lo,eo=yprev=cprev=sprev=-1e3,to=[],no=[1],oo=[],$n=0;$n<Zn.length;$n++)if('L'==Zn[$n].type){if(eo==Zn[$n].xs&&yprev==Zn[$n].ys&&cprev==Zn[$n].color&&sprev==Zn[$n].size){var po=[Zn[$n].xe,Zn[$n].ye,Zn[$n].zs];eo=Zn[$n].xe,yprev=Zn[$n].ye,to.push(po[0],po[1],po[2])}else'0'==no[0]||'#'==no[0]||Y(to,lo,ao),eo=Zn[$n].xe,yprev=Zn[$n].ye,cprev=Zn[$n].color,sprev=Zn[$n].size,to=[Zn[$n].xs,Zn[$n].ys,Zn[$n].zs,eo,yprev,Zn[$n].zs],ao=Zn[$n].color,lo=Zn[$n].size,no=ao+'';('0'==no[0]||'#'==no[0])&&oo.push(Zn[$n].xs,Zn[$n].ys,Zn[$n].zs,Zn[$n].xe,Zn[$n].ye,Zn[$n].ze)}'0'==no[0]||'#'==no[0]||Y(to,lo,ao),B(oo,5)}function Y(Zn,$n,eo,to){if(0!=Zn.length){var ao=eo+'',lo=0;if(7<ao.length&&(lo=ao[0],ao=ao.slice(1,8)),0<lo){var no=Z(Zn,$n,eo,to);return no}var oo=Math.abs($n),po=new THREE.LineGeometry;po.setPositions(Zn);var co=new THREE.LineMaterial({color:0,linewidth:oo/3,dashed:!1}),uo=renderer.getSize();co.resolution.set(uo.width,uo.height);var no=new THREE.LineSegments2(po,co);return null==to&&Bs.add(no),no}}function K(Zn,$n,eo,to,ao,lo,no,oo){var po=new Float32Array(6);po[0]=Zn,po[1]=$n,po[2]=eo,po[3]=to,po[4]=ao,po[5]=lo;var co=Y(po,no,oo,1);return co}function Z(Zn,$n,eo,to){if(0!=Zn.length){var ao=Zn.length,lo=eo+'',no=0;7<lo.length&&(no=lo[0],lo=lo.slice(1,8));for(var oo=0,po=3;po<ao;po+=3)oo+=Math.sqrt((Zn[po]-Zn[po-3])*(Zn[po]-Zn[po-3])+(Zn[po+1]-Zn[po-2])*(Zn[po+1]-Zn[po-2]));var co=new Float32Array(ao);iOS&&(co=new Float32Array(2*ao-3));for(var po=0;po<Zn.length;po++)co[po]=Zn[po];if(iOS)for(var ho,po=0;po<ao-3;po+=3)ho=2*ao-3-po-3,co[ho]=Zn[po],co[ho+1]=Zn[po+1],co[ho+2]=Zn[po+2];var go=new THREE.Color(lo),mo=Math.abs($n)*W(),yo=new MeshLineMaterial({color:go,lineWidth:mo*lsc,useMap:!1,transparent:!!(0>$n),opacity:0>$n?0.6:1,resolution:xi});if(1==no)var yo=new MeshLineMaterial({color:go,lineWidth:mo*lsc,useMap:!1,useAlphaMap:1,transparent:!0,alphaMap:Yi,resolution:xi});if(2==no){var fo=Math.round(1.5*oo);fo=1>fo?1:fo;var yo=new MeshLineMaterial({color:go,lineWidth:mo*lsc,useMap:!1,useAlphaMap:1,repeat:new THREE.Vector2(fo,1),transparent:!0,alphaMap:Ki,resolution:xi})}if(3==no){var fo=Math.round(oo);go=new THREE.Color('#aaaaaa'),fo=1>fo?1:fo;var yo=new MeshLineMaterial({color:go,lineWidth:1.5*(mo*lsc),useMap:!0,map:Zi,useAlphaMap:1,repeat:new THREE.Vector2(fo,1),transparent:!0,alphaMap:Zi,resolution:xi})}var bo=new MeshLine;bo.setGeometry(co);var vo=new THREE.Mesh(bo.geometry,yo);return null==to&&Bs.add(vo),vo}}function $(Zn,$n){var eo=new THREE.Sprite;return eo.position.set(Zn,$n,2),eo.scale.set(0.4,0.4,0.4),eo}function ee(Zn,$n,eo,to){var ao=new THREE.Sprite(Dn);return ao.position.set(Zn,$n,eo),ao.scale.x=ao.scale.y=to*ri,ao}function ae(Zn,$n,eo,to,ao,lo){var no=10,oo=new THREE.Object3D,po=il(Zn,lo,to);if(po.position.set($n+0.1,eo-0.05,no/5),oo.add(po),ao){po.position.set($n+0.35,eo-0.2,no/5);var co=0.07,uo=K(-co,-co,10,co,co,10,no/5,'#000000'),ho=K(co,-co,10,-co,co,10,no/5,'#000000');uo.position.set($n,eo,0),ho.position.set($n,eo,0);var go=$($n+0.35,eo+0.12);go.visible=!1,oo.add(uo),oo.add(ho),oo.add(go),2==ao&&(go.material=jn,go.visible=!0,console.log('photo added')),3==ao&&(go.material=Ln,go.visible=!0,console.log('labtest added'))}return oo}function le(Zn){var $n=new FileReader;$n.onloadend=function(eo){var to=Jl;Ee()&&(to=Math.round(Wa(ds[Zs].ys)));var ao=new Date,lo='';lo='pic_'+to+'_'+ao.getMinutes()+'m'+ao.getSeconds()+'s',An(eo.target.result,lo+'.jpg'),ie(Zs,lo,1),Ni.updateDisplay(),ie(Zs,lo)},$n.readAsDataURL(Zn.files[0])}function ie(Zn,$n,eo){var to=ds[Zn];if('T'!=Ee(Zn))return void console.log('not T');var ao=Nl.getObjectByName(Zn),lo=ao.children[0];console.log(lo),lo.lastRedraw=0,lo.material.map.text=''+$n,to.text=$n,oman.updchangelist(to.sid),null!=eo&&(1==eo&&(to.fall=1,ao.children[3].material=jn),2==eo&&(to.fall=2,ao.children[3].material=Ln),ao.children[3].visible=1),lo.lastRedraw=0,requestAnimationFrame(function(){lo.redrawInterval=1e5,lo.lastRedraw=0,ia()}),setTimeout(function(){ia()},50)}function oe(Zn,$n,eo){var to=ds[Zn];if('F'!=Ee(Zn))return void console.log('not F');var ao=to.size&&Jl<Pl?eo:360-eo,lo=Nl.getObjectByName(Zn),no=lo.children[1].children[0];no.redrawInterval=1,0!=$n&&90!=$n&&(lo.children[1].children[0].material.map.text=''+$n),lo.children[0].material.rotation=Math.round(1e3*(-Math.PI/180*ao))/1e3,0==$n&&(lo.children[0].material.map=Qn,lo.children[1].children[0].material.map.text='',lo.children[0].material.rotation=0),90==$n&&(lo.children[0].material.map=Vn,lo.children[1].children[0].material.map.text=''),0!=$n&&90!=$n&&(lo.children[0].material.map=Mn),to.fall=parseInt($n),to.angle=parseInt(eo),oman.updchangelist(to.sid),de(),setTimeout(function(){no.redrawInterval=1e8,de()},50)}function re(Zn,$n,eo,to,ao,lo){var no=lo==Jl<Pl?to:360-to,oo='',po=new THREE.Object3D;if(0!=ao&&90!=ao){Ss=new THREE.SpriteMaterial({map:Mn,color:16777215,rotation:-Math.PI/180*no});var co=new THREE.Sprite(Ss);oo=ao+''}if(0==ao)var uo=new THREE.SpriteMaterial({map:Qn,color:16777215}),co=new THREE.Sprite(uo);if(90==ao){Ss=new THREE.SpriteMaterial({map:Vn,color:16777215,rotation:-Math.PI/180*no});var co=new THREE.Sprite(Ss)}co.position.set(Zn,$n,eo),co.scale.x=co.scale.y=0.4*ri;var ho=ae(oo,Zn+0.25*oi,$n-0.12*ri,eo,0);return po.add(co),po.add(ho),po}function de(Zn,$n){renderblock||(Jn=0,mt.start('render'),requestAnimationFrame(function(){if(null==Zn&&controls.update(),Il?renderer.render(Js,camera):null==$n?renderer.render(Nl,camera):renderer.render($n,camera),null==Zn&&(1==rendebug&&console.log('r'),2==rendebug)){var eo=de.caller;console.log(eo)}if(null!=null,Jn=1,'debug1'==params.author){var to=mt.end('render');L('FPS '+Math.round(1e3/to))}}))}function ue(Zn,$n){var eo=Ya();if(!eo)return void console.log('Nothing to save');var to=JSON.stringify(eo),ao=getpelrange(to,picparams.ps,picparams.pe);params.textsave=to,Ni.updateDisplay();var lo=new Date,no='',oo=getauthorandsid(eo);no='pel'+ao[0]+'_'+ao[1]+'\''+params.tunnel+'\''+oo.author+shortsid(oo.sid)+'.txt';var po={name:no,size:to.length,content:to},co=elemfromfile(po),uo=function(yo){dbputreg(yo,function(){null==$n&&(newdb.ldb(),allq.update())})};console.log('Attempt to add new file to db',co);var ho=newdb.comparef(co);if(ho){console.log('File already exists in db',ho);var go=co.savedata,mo=ho.savedata;comparesave(go,mo)?console.log('Files are same, not saving'):(console.log('Adding because files are different'),uo(co))}else console.log('Adding new file to db',co),uo(co);he(Zn)}function he(){var $n=Ya(1);if(!$n)return void console.log('Nothing to save');var eo=JSON.stringify($n),to=getpelrange(eo,picparams.ps,picparams.pe);params.textsave=eo,Ni.updateDisplay();var ao=new Date,lo='',no=getauthorandsid($n);lo='pel'+to[0]+'_'+to[1]+'\''+params.tunnel+'\''+no.author+shortsid(no.sid)+'.txt';({name:lo,size:eo.length,content:eo})}function me(Zn,$n){params.withbg||(Os.visible=!1),pt();var eo=new THREE.Scene;eo.add(Ks),de(null,eo),console.log('start save as image'),fe(function(to){Nl.add(Ks),de(),fe(Zn,to),Os.visible=!0,bt(),X(),de(),null!=$n&&(params.what2plot='Geo+Q+Pel')},1)}function fe(Zn,$n){var eo,ao=window.devicePixelRatio;try{eo=renderer.domElement.toDataURL('image/png');var no=new Image,oo='For 3d'==params.what2plot?1:0,po='Only texture'==params.what2plot?1:0;no.onload=function(){var uo=document.createElement('canvas');uo.width=po?2*Gl:Bl,uo.height=po?2*Gl:Gl,uo.width*=ao,uo.height*=ao,uo.visible=0;var ho=uo.getContext('2d');ho.drawImage(no,0,0);var go=ho.getImageData(0,0,uo.width,uo.height),mo=go.data,yo=mo.length,fo=[];if(null!=$n&&!Array.isArray($n))for(var bo=0;bo<yo;bo+=4)if(208==mo[bo]&&208==mo[bo+1]&&208==mo[bo+2]);else fo.push(bo);if(null!=$n&&!Array.isArray($n))return void Zn(fo);if(!params.withbg){for(var bo=0;bo<yo;bo+=4)208==mo[bo]&&208==mo[bo+1]&&208==mo[bo+2]&&(mo[bo+3]=0);if(Array.isArray($n))for(var bo=0;bo<$n.length;bo++)mo[$n[bo]+3]=100}console.log('done pic'),go.data=mo,ho.putImageData(go,0,0);var vo=document.createElement('canvas');vo.visible=0;var xo=ho.getImageData(Gl,0,Gl+Bl,Gl);vo.width=Gl,vo.height=Bl;var wo=vo.getContext('2d');if(wo.putImageData(xo,0,0),eo=po?vo.toDataURL():uo.toDataURL(),Vl=eo,console.log('tmp pic saved'),void 0!==Zn)return kl=eo,void Zn();if(!oo){var So=new Date,ko='';ko=ko+'geo'+So.getHours()+'h'+So.getMinutes()+'m'+So.getSeconds()+'s.png',An(eo,ko)}},no.src=eo}catch(uo){return void console.log(uo)}}function be(){if(!Hl){var Zn=Ee();Zn&&('L'==Zn?myask(container,'Remove line?',function(){we(),kn=-1e3,X(),de()}):(we(),X(),de()))}}function we(){if(oman.so){allp.remove(oman.sp);var Zn=[];if(Zn=Se(oman.selidx),'Group'==yi.value&&1<Zn.length)for(var $n=0;$n<Zn.length;$n++)oman.removefromscene(oman.get(Zn[$n]),1);else oman.removefromscene(oman.so);Ts.visible=!1,oman.so=null,oman.selidx=null}}function Se(Zn){for(var $n=[Zn],eo=Zn-1;0<=eo&&1!=ds[eo].skip&&ds[eo].xe==ds[eo+1].xs&&ds[eo].ye==ds[eo+1].ys;eo--)$n.push(eo);for(var eo=Zn+1;eo<ds.length&&1!=ds[eo].skip&&ds[eo-1].xe==ds[eo].xs&&ds[eo-1].ye==ds[eo].ys;eo++)$n.push(eo);return $n.sort((to,ao)=>to-ao),$n}function ke(Zn){var $n=[];if(-1==Zn[0])return $n;for(var to,eo=0;eo<Zn.length;eo++)to=Zn[eo],0==eo&&($n.push(ds[to].xs),$n.push(ds[to].ys)),$n.push(ds[to].xe),$n.push(ds[to].ye);return $n}function Fe(){oman.undo(),X(),fi.setAttribute('class','geobutton1'),setTimeout(function(){fi.setAttribute('class','geobutton')},200)}function qe(){this.tunnel='',this.zeropel=0,this.pelperunit=1,this.pelstart=0,this.pelend=20,this.qval={},this.pval={},this.pw=ti,this.author='V',this.sid=Rl,this.lastchange=0,this.objdata=[]}function De(Zn,$n){for(var eo=ds.length,to=1e3,ao=-1,lo=-20,no=-20,oo=1,po=0;po<eo;po++)if(!ds[po].skip){oo=1;var co=ds[po].xs,uo=ds[po].ys,ho=(Zn-co)*(Zn-co)+($n-uo)*($n-uo);if('L'==ds[po].type){var go=Me(ds[po],Zn,$n);ho=go[0],co=go[2],uo=go[3],(0>go[1]||1<go[1])&&(oo=0)}to>=ho&&oo&&(to=ho,ao=po,lo=co,no=uo)}return[ao,lo,no,Math.sqrt(to)]}function Me(Zn,$n,eo){var to=Zn.xs,ao=Zn.xe,lo=Zn.ys,no=Zn.ye,oo=Math.sqrt((ao-to)*(ao-to)+(no-lo)*(no-lo)),uo=[0,1,2,3,4],go=((ao-to)*($n-to)+(no-lo)*(eo-lo))/oo/oo,mo=to+go*oo*((ao-to)/oo),yo=lo+go*oo*((no-lo)/oo),fo=Math.sqrt(($n-to)*($n-to)+(eo-lo)*(eo-lo)),bo=Math.sqrt(($n-ao)*($n-ao)+(eo-no)*(eo-no)),vo=Math.sqrt(($n-mo)*($n-mo)+(eo-yo)*(eo-yo));return uo[0]=Math.sqrt(($n-mo)*($n-mo)+(eo-yo)*(eo-yo)),Ve(go)||(uo[0]=Math.min(fo,bo)),uo[1]=go,uo[2]=mo,uo[3]=yo,uo[4]=0,0>=(ao-to)*(eo-lo)-(no-lo)*($n-to)&&(uo[4]=1),uo}function Ve(Zn){return 0<=Zn&&1>=Zn}function Qe(){localStorage.setItem('lastauthor',params.author)}function Re(Zn){return': -1??'==Zn?'':Zn}function Le(Zn,$n,eo){$n.value=Zn+Re(': '+eo),'-1??'!=eo&&$n.setAttribute('class','inguib aguibut')}function je(){Le('RQD',Bi.rqd,tn.RQD+tn.RQDc),Le('Jn',Bi.Jn,tn.Jn+tn.Jnc),Le('Jr',Bi.Jr,tn.Jr+tn.Jrc),Le('Ja',Bi.Ja,tn.Ja+tn.Jac),Le('Jw',Bi.Jw,tn.Jw+tn.Jwc),Le('SRF',Bi.SRF,tn.SRF+tn.SRFc),tn.getQ(),'????'==tn.Q+tn.class?Bi.Q.name('Q = ?'):Bi.Q.name('Q = '+tn.Q+tn.class),Ni.updateDisplay()}function Je(Zn,$n){var eo=Zn.add(bf,'blank').name($n).__li;return eo.setAttribute('class','cr function myguibut'),null==$n&&eo.removeChild(eo.children[0]),eo}function Pe(Zn){Zn.style.height='5px',Zn.style.height=Zn.scrollHeight-5+'px'}function Ae(Zn){for(var $n=0;$n<Ri.length;$n++)if(Zn==Ri[$n])return Li[$n]}function Ee(Zn){var $n=0,eo=Zs;null!=Zn&&(eo=Zn);Nl.getObjectByName(eo);return null==ds[eo]?$n:1==ds[eo].skip?$n:ds[eo].type}function Te(Zn){var $n=Oe(Zn);if(-3==$n)return void console.log('Nothing selected');var eo=Ee(Zn);chosenp=$n,-2==chosenp?(ln=new He,ln.type=eo,ln.coords=$l,ln.isarea=Ye($l)):ln.restore(allp.par[chosenp]),Aa('Select',eo),Ni.updateDisplay()}function Oe(Zn){var $n=Ee(Zn);if(!$n)return console.log('Nothing selected'),-3;if('L'==$n){var eo=Se(Zn);$l=ke(eo),0==$l.length&&console.log('No lines selected')}else $l=[ds[Zn].xs,ds[Zn].ys];return allp.get($l)}function Ie(Zn){for(var $n=normPel(Jl,Pl),eo=$n[0];eo<$n[1];eo+=5)if(Zn>=eo&&Zn<eo+5){var to=allq.get(eo),ao=allq.get(eo+5);if(-2==to&&-2==ao)return console.log('No Q near'),[eo,eo+5];var lo=eo,no=-2==ao?to:ao;lo=-2==ao?Math.max(allq.qar[to].ps,allq.qar[to].pe):Math.min(allq.qar[ao].ps,allq.qar[ao].pe);var oo=-2==ao?5:-5;return[lo,lo+oo]}return console.log('No q found'),[Zn,Zn+5*$n[2]]}function Be(Zn){var $n=Wa(Zn);if(nn=allq.get($n),-2==nn){tn=new $e,tn.getQ();var eo=Ie($n);tn.ps=eo[0],tn.pe=eo[1],tn.comment=''}else tn.restore(allq.qar[nn]);de(),us==qa.qval?(Ni.removeFolder(qa.qval),Ja()):Aa(qa.qval),Ai.close(),Ni.removeFolder(qa.main),Ni.removeFolder(qa.setproperties),Ti.open(),Ts.visible=!0,Ts.position.set(1.2*-ti,0.35*_a(tn.pe)+0.65*_a(tn.ps),10),je(),Ni.updateDisplay()}function Ge(){setTimeout(function(){Ni.open()},200)}function Ne(){Ni.close()}function _e(){-1<nn?(tn.lastchange=Rl,allq.qar[nn].restore(tn)):(allq.add(tn),nn=allq.qar.length-1),oman.updchangelist(tn.sid),allq.update(),ia(null,1)}function We(){allq.remove(nn),allq.update(),de(),tn=new $e,je()}function Ue(){if(0==$l.length)return void console.log('No lines selected');if(-1<chosenp){if('undefined'==typeof allp.par[chosenp])return void console.log('No lines selected');allp.par[chosenp].restore(ln),allp.par[chosenp].author=params.author,allp.par[chosenp].lastchange=Rl,'L'==allp.par[chosenp].type&&(allp.par[chosenp].color=Mt(Ae(ln.bergart)))}else ln.author=params.author,'L'==ln.type&&(ln.color=Mt(Ae(ln.bergart))),ln.sid=Rl,allp.add(ln),chosenp=allp.amtok()-1;oman.sp=allp.par[chosenp],allq.update(),de()}function He(){this.author=params.author,this.sid=Rl,this.lastchange=Rl,this.type='',this.bergart='none',this.ispartofQ=0,this.id='',this.coords=[],this.color=0,this.comment='',this.width=0,this.dsc='Not given',this.wdrip=0,this.wleak=0,this.isarea=!1,this.restore=function(Zn){var $n=JSON.parse(JSON.stringify(Zn));this.sid=$n.sid,this.lastchange=null==$n.lastchange?this.sid:$n.lastchange,this.type=$n.type,this.id=$n.id,this.coords=$n.coords,this.bergart=$n.bergart,this.width=$n.width,this.comment=$n.comment,this.ispartofQ=$n.ispartofQ,null!=$n.author&&(this.author=$n.author),this.isarea=$n.isarea,this.color=$n.color,null!=$n.dsc&&(this.dsc=$n.dsc,this.wdrip=$n.wdrip,this.wleak=$n.wleak)},this.sameas=function(Zn){if(0==Zn.length)return!1;for(var $n=0;$n<Math.min(Zn.length,this.coords.length)&&!(6<$n);$n++){if(20<$n)return console.log('Same',this.coords),!0;if(10<Zn.length){var eo=Ga(Zn[$n],this.coords[$n]);if(!eo)return!0}if(!Ba(Zn[$n],this.coords[$n]))return!1}return!0},this.showprops=function(){var Zn;return Zn='W'==this.type?this.coords+' wdrip='+this.wdrip+' wleak='+this.wleak:this.bergart+' '+this.coords,Zn}}function Xe(){this.par=[],this.getareas=function(){var Zn=[];for(var $n in this.par){var eo=this.par[$n];eo.isarea&&!eo.ispartofQ&&Zn.push(eo)}return Zn},this.amtok=function(){for(var Zn=0,$n=0;$n<this.par.length;$n++)this.par[$n].ispartofQ||Zn++;return Zn},this.add=function(Zn,$n){var eo=new He;eo.restore(Zn),this.par.push(eo),null==$n&&this.update()},this.remove=function(Zn,$n){if('object'==typeof Zn)for(var eo in console.log('Trying to remove',Zn),this.par){var to=this.par[eo];if(to==Zn){this.par.splice(eo,1);break}}else-1<Zn&&this.par.splice(Zn,1);null==$n&&this.update()},this.cleanFromQ=function(){for(var Zn=0;Zn<this.par.length;Zn++)1==this.par[Zn].ispartofQ&&(this.remove(Zn,1),Zn--)},this.y2pelcoords=function(){for(var Zn=0;Zn<this.par.length;Zn++)for(var $n=0;$n<this.par[Zn].coords.length;$n+=2)this.par[Zn].coords[$n+1]=Wa(this.par[Zn].coords[$n+1])},this.cleanFromPel=function(){for(var Zn=0;Zn<this.par.length;Zn++)ul(this.par[Zn].coords[1])||(console.log('Skipping property',this.par[Zn]),this.remove(Zn),Zn--)},this.get=function(Zn){for(var $n=0;$n<this.par.length;$n++)if(this.par[$n].sameas(Zn))return $n;return-2},this.restore=function(Zn,$n,eo){var to=!1;null!=eo&&(to=eo);for(var lo,ao=0;ao<Zn.par.length;ao++)(lo=this.ismemberalready(Zn.par[ao]),null==Zn.par[ao].sid&&(Zn.par[ao].sid=Yn),null==Zn.par[ao].author&&(Zn.par[ao].author=Kn),!(1==to&&Zn.par[ao].sid<Rl))&&(1<to&&Zn.par[ao].sid!=to||(-1<lo?this.par[lo].restore(Zn.par[ao]):this.add(Zn.par[ao],$n)));null==$n&&(console.log('Update inside restore'),this.update())},this.ismemberalready=function(Zn){for(var $n=0;$n<this.par.length;$n++)if(this.par[$n].sameas(Zn.coords))return $n;return-1},this.update=function(){mt.start('updatePinside');var Zn=renderblock;if(renderblock=1,Fa(),params.showbergart)for(var $n=0;$n<this.par.length;$n++)if(('L'==this.par[$n].type||this.par[$n].ispartofQ)&&(this.par[$n].isarea&&at(this.par[$n].coords,Ae(this.par[$n].bergart),this.par[$n].ispartofQ),''!=this.par[$n].comment)){var to,ao,eo=this.par[$n].coords.length;to=this.par[$n].coords[eo-2],ao=this.par[$n].coords[eo-1];var lo=ae('comment!',to,ao,5,1);Ks.add(lo)}renderblock=Zn,mt.end('updatePinside')}}function Ye(Zn){var $n=Zn.length;return $n%2?(console.log('Odd amount of coordinates?'),console.log(Zn),!1):!(8>$n)&&Zn[0]==Zn[$n-2]&&Zn[1]==Zn[$n-1]}function Ke(Zn){var $n=Jl<Pl,eo=allq.get(Zn);return-1<eo&&($n=allq.qar[eo].ps>allq.qar[eo].pe?0:$n),Jl<tunborder&&($n=13730<Zn&&13915>Zn||14350<Zn&&14980>Zn?0:1),17057<Zn&&17068>Zn&&($n=1),$n}function Ze(){this.qar=[],this.add=function(Zn){var $n=new $e;$n.restore(Zn),this.qar.push($n)},this.get=function(Zn){for(var ao,$n=1e3,eo=-2,to=0;to<this.qar.length;to++)ao=$n,(this.qar[to].pe>Zn&&this.qar[to].ps<Zn||this.qar[to].ps>Zn&&this.qar[to].pe<Zn)&&($n=Math.min($n,Math.abs(Zn-this.qar[to].ps),Math.abs(Zn-this.qar[to].pe),Math.abs(Zn-(this.qar[to].pe+this.qar[to].ps)/2)),ao!=$n&&(eo=to));return eo},this.remove=function(Zn){-1<Zn&&(console.log('Removed Q'),oman.updchangelist(this.qar[Zn].sid),this.qar.splice(Zn,1))},this.removeP=function(Zn){var $n=this.get(Zn);-1<$n?this.qar.splice($n,1):console.log('No such Q with pel'+Zn)},this.getoverlaps=function(){for(var Zn=[],$n=0;$n<this.qar.length;$n++){for(var eo=0,to=this.qar[$n],ao=Math.min(to.ps,to.pe),lo=Math.max(to.ps,to.pe),no=$n+1;no<this.qar.length;no++){var oo=this.qar[no],po=Math.min(oo.ps,oo.pe),co=Math.max(oo.ps,oo.pe);if(po<=lo&&po>=ao){if(po==lo)continue;var uo=[po,Math.min(co,lo)];Zn.push(uo),to.Q==oo.Q&&to.comment==oo.comment&&(to.sid>oo.sid?(console.log('Removing overlap',oo),this.remove(no),no--):eo=1);continue}if(co<=lo&&co>=ao){if(co==ao)continue;var uo=[Math.max(po,ao),co];Zn.push(uo),to.Q==oo.Q&&to.comment==oo.comment&&(to.sid>oo.sid?(console.log('Removing overlap',oo),this.remove(no),no--):eo=1)}}eo&&(console.log('Removing i',to),this.remove($n),$n--)}return 2<Zn.length&&console.log('Overlaps',Zn),Zn},this.update=function(){mt.start('updateQ'),mt.start('Get Q overlaps'),this.getoverlaps(),mt.end('Get Q overlaps'),za(),mt.start('Clean Q'),allp.cleanFromQ(),mt.end('Clean Q');for(var Zn=0;Zn<this.qar.length;Zn++)if(ka(this.qar[Zn].ps,this.qar[Zn].pe,this.qar[Zn].getQ(),this.qar[Zn].class,this.qar[Zn].comment),'none'!=this.qar[Zn].bergart){var $n=new Xe,eo=new He;eo.ispartofQ=1;var to=_a(this.qar[Zn].ps),ao=_a(this.qar[Zn].pe);eo.coords=[-ti,to,-ti,ao,ti,ao,ti,to],eo.bergart=this.qar[Zn].bergart,eo.isarea=!0,$n.add(eo,1),allp.restore($n,1)}mt.start('updatePFinal'),allp.update(),mt.end('updatePFinal'),mt.end('updateQ')},this.clear=function(){za(),this.qar=[]},this.restore=function(Zn,$n,eo){var to=!1;null!=eo&&(to=eo);for(var ao=0;ao<Zn.qar.length;ao++)if((null==Zn.qar[ao].sid&&(Zn.qar[ao].sid=Yn),null==Zn.qar[ao].author&&(Zn.qar[ao].author=Kn),!(1==to&&Zn.qar[ao].sid<Rl))&&!(1<to&&Zn.qar[ao].sid!=to)){if(params.onlycurpel&&(!ul(Zn.qar[ao].ps)||!ul(Zn.qar[ao].pe))){console.log('Q not in limits'+Zn.qar[ao].ps+' '+Zn.qar[ao].pe);continue}var lo=this.isequal(Zn.qar[ao]);-1<lo?this.qar[lo].restore(Zn.qar[ao]):this.add(Zn.qar[ao])}null==$n&&this.update()},this.isequal=function(Zn){for(var $n=0;$n<this.qar.length;$n++)if(this.qar[$n].ps==Zn.ps&&this.qar[$n].pe==Zn.pe)return $n;return-1}}function $e(){this.author=params.author,this.sid=Rl,this.lastchange=Rl,this.ps=Jl,this.pe=Pl,this.RQDc='??',this.Jrc='??',this.Jwc='??',this.Jnc='??',this.Jac='??',this.SRFc='??',this.Jnmult=1,this.RQD=-1,this.Jr=-1,this.Jw=-1,this.Jn=-1,this.Ja=-1,this.SRF=-1,this.Q='??',this.class='??',this.comment='',this.bergart='none',this.getQ=function(){return 0>this.RQD||0>this.Jr||0>this.Jr||0>this.Jn||0>this.Ja||0>this.SRF?this.Q:(this.Q=Math.round(1e3*(Math.max(this.RQD,10)*this.Jr*this.Jw/(this.Jn*this.Ja*this.SRF)))/1e3,0.01<this.Q&&(this.Q=Math.round(100*this.Q)/100),1<this.Q&&(this.Q=Math.round(10*this.Q)/10),this.class='G',0.01<this.Q&&(this.class='F'),0.1<this.Q&&(this.class='E'),1<this.Q&&(this.class='D'),4<this.Q&&(this.class='C'),10<this.Q&&(this.class='A/B'),this.Q)},this.restore=function(Zn){this.ps=Zn.ps,this.pe=Zn.pe,this.comment=Zn.comment,this.bergart=Zn.bergart,this.RQDc=Zn.RQDc,this.Jrc=Zn.Jrc,this.Jwc=Zn.Jwc,this.Jnc=Zn.Jnc,this.Jac=Zn.Jac,this.SRFc=Zn.SRFc,this.Jnmultc=1,this.RQD=Zn.RQD,this.Jr=Zn.Jr,this.Jw=Zn.Jw,this.Jn=Zn.Jn,this.Ja=Zn.Ja,this.SRF=Zn.SRF,null!=Zn.author&&(this.author=Zn.author),null!=Zn.sid&&(this.sid=Zn.sid),this.lastchange=null==Zn.lastchange?this.sid:Zn.lastchange,this.getQ()}}function at(Zn,$n,eo){for(var lo,to=[],ao=0;ao<Zn.length;ao+=2)lo=new THREE.Vector3(Zn[ao],Zn[ao+1],1-0.02*eo),to.push(lo);var oo,po,co=new THREE.Geometry,uo=new THREE.MeshBasicMaterial({color:$n,transparent:!0,opacity:0.7});uo.side=THREE.DoubleSide,co.vertices=to,oo=THREE.ShapeUtils.triangulateShape(to,[]);for(var ao=0;ao<oo.length;ao++)co.faces.push(new THREE.Face3(oo[ao][0],oo[ao][1],oo[ao][2]));po=new THREE.Mesh(co,uo),Ks.add(po),de()}function lt(Zn){for(var $n=Zn.elements,eo=0;eo<$n.length;eo++)$n[eo]=mr($n[eo]);return $n}function rt(Zn,$n){var eo={x:(Zn/ti+1)/2,y:($n/si+1)/2};return eo}function dt(Zn,$n){var eo=$n.x-Zn[0].x,to=$n.y-Zn[0].y,ao=0<(Zn[1].x-Zn[0].x)*to-(Zn[1].y-Zn[0].y)*eo;return 0<(Zn[2].x-Zn[0].x)*to-(Zn[2].y-Zn[0].y)*eo!=ao&&0<(Zn[2].x-Zn[1].x)*($n.y-Zn[1].y)-(Zn[2].y-Zn[1].y)*($n.x-Zn[1].x)==ao}function pt(){controls.reset(),controls.target.set(0,0,0),camera.position.set(0,0,li),cameraFix.position.set(0,0,li),$a(),ht(),X()}function ht(){var Zn=window.devicePixelRatio;Bl=Fl,Gl=Dl,camera.left=-ti,camera.right=ti,camera.top=si+ii,camera.bottom=-si+ii,cameraFix.left=-ti,cameraFix.right=ti,cameraFix.top=si+ii,cameraFix.bottom=-si+ii,'Geo+Q+Pel'==params.what2plot&&(camera.left=-ti-1.2,camera.right=ti+1.2,Bl*=1.3,lsc=0.5),Bl/=Zn,Gl/=Zn;'For 3d'!=params.what2plot&&4096<Gl&&(Bl=4096*Bl/Gl,Gl=4096);var eo=Bl,to=Gl;'For 3d'==params.what2plot,renderer.setSize(eo,to),xi=new THREE.Vector2(eo,to),'For 3d'==params.what2plot&&(lsc=Math.min(0.5,5e3/to));var ao=android||iOS?4:1;buftext=new THREE.WebGLRenderTarget(4096/ao,16384/ao,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat}),camera.updateProjectionMatrix(),cameraFix.updateProjectionMatrix()}function gt(){Il||(sensivity=1,params.what2plot='For 3d',zt(Jl,Pl,1),pt(),Ea(),Il=!0,renderer.render(Nl,cameraFix,buftext),bt(),Jt(),camera.position.set(0,0,1e3),params.what2plot='Geo+Q+Pel',controls.enableRotate=!0,de(),check3dbox.style.display='',check3dbox.checked=!0,fgui.close(),Aa('3d'))}function yt(){if(Il){for(sensivity=5;0<Js.children.length;)Js.remove(Js.children[0]);buftext.dispose(),Nl=As,params.resetcam(),controls.enableRotate=!1,Il=!1,camera.position.set(0,0,li),lsc=1,bt(),X(),Ea(),zt(Jl,Pl),setTimeout(function(){de()},50),yi.value='Select',Aa('Line'),check3dbox.style.display='none',fgui.close(),Ni.close()}}function ft(){Pl+=5*pmult,Jl-=5*pmult,Al=Math.abs(parseInt(Jl)-parseInt(Pl)),Dl=El*Al,Gl=Dl,si=Dl/ei,G(Jl,Pl,ii),zt(Jl,Pl),ka(Jl,Pl,-1),Sa(Ml,_a(Pl-2.5*pmult)),Sa(Ml,_a(Jl+2.5*pmult)),de()}function bt(){F(),xi=new THREE.Vector2(bi,vi),Si=bi/vi,camera.left=-ki*Si/2,camera.right=ki*Si/2,camera.top=zi/2,camera.bottom=-zi/2,camera.updateProjectionMatrix(),renderer.setSize(bi,vi),de()}function xt(){if(Gi)return!1;for(var Zn=0,$n=0;$n<ds.length;$n++)1!=ds[0].skip&&(Zn=1);if(allq.qar.length&&(Zn=1),!Zn)return!1;var eo=new Date().getTime(),to=Ya(1),ao=JSON.stringify(to);localStorage.setItem(ms.s,ao);var lo=new Date().getTime()-eo;return console.log('dT = '+lo),!0}function wt(){if(localStorage.getItem(ms.l)){var Zn=localStorage.getItem(ms.l),$n=JSON.parse(Zn);console.log('Sid set to',$n.sid),Ia($n),allq.update(),X(),de(),params.restses=0,Aa('Line')}}function zt(Zn,$n,eo){if(Nl.remove(_s),!!params.rutenett){_s=new THREE.Object3D;var to=normPel(Zn,$n),ao=to[0],lo=to[1],no=-4;null!=eo&&(no=-0.5);for(var go,ho=ao;ho<=lo;ho++){go=[],go.push(-ti,_a(ho),1,1.13*ti,_a(ho),1);var mo=Y(go,no,'0#000000');_s.add(mo)}Nl.add(_s)}}function Ft(){if(params.vederlag){var Zn=tungeom[params.tunnel].Width,$n=[];for(var eo in Zn){var to=Zn[eo][1],ao=Zn[eo][3],lo=Zn[eo][5],no=lo-to;$n.push([Zn[eo][0],2*((Zn[eo][2]-to)/no)-1,2*((Zn[eo][3]-to)/no)-1,2*((Zn[eo][4]-to)/no)-1])}for(var mo,yo,fo,bo,no,oo=normPel(Jl,Pl),po=oo[0],co=oo[1],uo=[],ho=[],go=[],vo=1,eo=po;eo<co;eo++){if(no=Math.max(eo,$n[0][0]),no=eo,mo=Dt(no,$n),fo=_a(no),yo=Dt(no+pmult,$n),bo=_a(no+1),!mo||!yo){console.log('No vederlag data for pel=',eo),vo=0;break}uo.push(mo[0]),uo.push(fo),uo.push(1),ho.push(mo[1]),ho.push(fo),ho.push(1),go.push(mo[2]),go.push(fo),go.push(1)}vo&&(uo.push(yo[0]),uo.push(bo),uo.push(1),ho.push(yo[1]),ho.push(bo),ho.push(1),go.push(yo[2]),go.push(bo),go.push(1)),Y(uo,-4,'0#000000'),Y(ho,-4,'0#000000'),Y(go,-4,'0#000000')}}function Dt(Zn,$n){for(var eo=$n.length,to=xct=xrt=0,ao=0,lo=0,no=0;no<eo-1;no++)if(Zn>=$n[no][0]&&Zn<$n[no+1][0]||Zn<=$n[no][0]&&Zn>$n[no+1][0]){var oo=$n[no+1][0]-$n[no][0];0==oo?ao=[$n[no][1]*ti,$n[no][2]*ti,$n[no][3]*ti]:(lo=(Zn-$n[no][0])/($n[no+1][0]-$n[no][0]),to=$n[no][1]+lo*($n[no+1][1]-$n[no][1]),xct=$n[no][2]+lo*($n[no+1][2]-$n[no][2]),xrt=$n[no][3]+lo*($n[no+1][3]-$n[no][3]),ao=[to*ti,xct*ti,xrt*ti])}return ao?ao:Zn<$n[0][0]?[$n[0][1]*ti,$n[0][2]*ti,$n[0][3]*ti]:[$n[eo-1][1]*ti,$n[eo-1][2]*ti,$n[eo-1][3]*ti]}function Mt(Zn,$n){var eo=Zn;return 7==eo.length?(eo=null==$n?'0x'+eo[5]+eo[6]+eo[3]+eo[4]+eo[1]+eo[2]:'0x'+eo[1]+eo[2]+eo[3]+eo[4]+eo[5]+eo[6],parseInt(eo)):0}function Vt(){Il?(ui.style.display='none',hi.style.display='none',gi.style.display='none',yi.style.display='none',fi.style.display='none'):(ui.style.display='',hi.style.display='',gi.style.display='',yi.style.display='',fi.style.display='')}function Qt(){ui.setAttribute('class','geobutton'),hi.setAttribute('class','geobutton'),gi.setAttribute('class','geobutton'),mi.setAttribute('class','geobutton'),yi.setAttribute('class','geobutton')}function Rt(Zn){var $n=[],eo=Zn.length;for(var to in $n.push(It(Zn[0][0]+1,Zn)),Zn)Zn[to][0]>Zn[0][0]+1&&Zn[to][0]<Zn[eo-1][0]-1&&$n.push(It(Zn[to][0],Zn));return $n.push(It(Zn[eo-1][0]-1,Zn)),$n}function Lt(Zn){var $n=tungeom[Zn].TunProfile,eo=parse3dmod($n),to=Rt(eo),ao=At(eo);for(var lo in to)ao.add(jt(to[lo]));var no=(eo[0][0]+eo[eo.length-1][0])/2,oo=-_a(no);return[eo,ao]}function jt(Zn){var $n=[];for(var eo in Zn.v)$n.push(Zn.v[eo].x),$n.push(Zn.v[eo].y),$n.push(Zn.v[eo].z);var to=new THREE.Object3D,ao=Y($n,10,'0#000000');return to.add(ao),to}function Jt(){p2y=_a;var Zn=In,$n=Zn[0];lingeom=new THREE.Object3D,lingeom.add(In[1]),lingeom.add(Gn);var eo=($n[0][0]+$n[$n.length-1][0])/2,to=_a(eo),ao=getglobc((Jl+Pl)/2);lingeom.position.set(-ao.x,-ao.y,-ao.z);var lo=Ot($n),no=lo[0];for(var oo in partlingeom=lo[1],pmat=new THREE.MeshBasicMaterial({map:buftext.texture,transparent:!0,opacity:0.5,depthTest:!0}),pmat.side=THREE.DoubleSide,my3dgroup=new THREE.Object3D,meshes=new THREE.Object3D,no){var po=new THREE.Mesh(no[oo][2],pmat);po.castShadow=!1,po.receiveShadow=!1,meshes.add(po)}meshes.position.set(-ao.x,-ao.y,-ao.z),my3dgroup.add(meshes),Js=new THREE.Scene,As=Nl;var co=new THREE.Object3D;params.showholes&&(co.add(Us),co.position.set(-ao.x,-ao.y,-ao.z),my3dgroup.add(co));var uo=new THREE.Object3D;my3dgroup.add(uo),no[0][2].computeBoundingSphere();var ho=no[0][2].boundingSphere.center,go=new THREE.Quaternion;go.setFromUnitVectors(new THREE.Vector3(0,0,1),new THREE.Vector3(0,1,0));for(var mo,yo,fo=0;fo<oman.ao.length;fo++)if('B'==oman.ao[fo].type){var bo=rt(oman.get(fo).xs,oman.get(fo).ys),vo=Wa(oman.get(fo).ys),xo=new THREE.Vector2(bo.x,bo.y);for(var wo in no)if(numintersect(no[wo][0],no[wo][1],vo,vo)){mo=Tn(meshes.children[wo],xo);break}var So=rt(oman.get(fo).xe,oman.get(fo).ye),vo=Wa(oman.get(fo).ye),xo=new THREE.Vector2(So.x,So.y);for(var wo in no)if(numintersect(no[wo][0],no[wo][1],vo,vo)){yo=Tn(meshes.children[wo],xo);break}var ko=yo[0],zo=yo[1],Fo=mo[0],qo=mo[1],Do=10,Mo=En(new THREE.Vector3(Fo.x,Fo.y,Fo.z),new THREE.Vector3(ko.x+1*(qo.x*Do),ko.y+1*(qo.y*Do),ko.z+1*(qo.z*Do)));uo.add(Mo)}my3dgroup.applyQuaternion(go),my3dgroup.add(lingeom),my3dgroup.add(partlingeom),Js.add(my3dgroup),Js.add(fallar),Js.add(line3dgroup),Js.add(line3dtemp),controls.enableRotate=!0,de()}function At(Zn){for(var $n=Zn[0][1].length,eo=new THREE.Object3D,to=[],ao=Zn[0][1],lo=[],no=Zn[0][0]+1;no<Zn[Zn.length-1][0]-1;no+=2)lo.push(It(no,Zn));for(var oo in ao){for(var po in to=[],lo){var co=lo[po],uo=co.v[oo];to.push(uo.x,uo.y,uo.z)}var oo=Y(to,5,'0#000000');eo.add(oo)}return eo}function Tt(Zn,$n){var eo=[];if(Zn<$n[0][0])return Hs=[Zn,$n[0][1]],Hs;if(Zn>$n[$n.length-1][0])return Hs=[Zn,$n[$n.length-1][1]],Hs;for(var to=1;to<$n.length;to++)if(Zn>=$n[to-1][0]&&Zn<=$n[to][0]){var ao=$n[to-1][0],lo=$n[to][0],no=(Zn-ao)/(lo-ao);for(var oo in $n[to][1]){var po=$n[to][1][oo],co=$n[to-1][1][oo];eo.push(new THREE.Vector2(po.x*no+co.x*(1-no),po.y*no+co.y*(1-no)))}break}return eo.length||console.log('Error! Vout not defined in getcurveatpel'),[Zn,eo]}function Ot(Zn){for(var co,$n=Jl,eo=Pl,to=Tt($n,Zn),ao=Tt(eo,Zn),lo=-1,no=[[0,to]],oo=[],po=0;po<Zn.length;po++)if((co=Zn[po][0],Math.round(lo)!=Math.round(co))&&(lo=co,co=Math.round(co),hl(co,$n,eo))){var uo=(co-$n)/(eo-$n);oo.push([uo,Zn[po]])}if(0<pmult)for(var ho=0;ho<oo.length;ho++)no.push(oo[ho]);else for(var ho=oo.length-1;-1<ho;ho--)no.push(oo[ho]);no.push([1,ao]);for(var go=new THREE.Object3D,mo=[],yo=[],ho=0;ho<no.length-1;ho++)for(var fo=no[ho][1][0],bo=no[ho+1][1][0],vo=0,po=fo;0>(po-bo)*pmult;po+=5*pmult){vo++;var uo=(po-$n)/(eo-$n);if(yo.push([uo,Tt(po,Zn)]),500<vo)return}yo.push(no[no.length-1]);for(var ho=1;ho<yo.length;ho++){var xo=It(yo[ho][1][0],Zn),wo=It(yo[ho-1][1][0],Zn);mo.push([yo[ho-1][1][0],yo[ho][1][0],Bt(wo,xo,yo[ho-1][0],yo[ho][0])])}return[mo,go]}function It(Zn,$n){var eo=Tt(Zn,$n),to=getglobc(Zn),ao=getglobc(Zn,1)[1]/180*Math.PI,lo=getglobc(Zn+0.01),no=new THREE.Quaternion;null==lo?(lo=getglobc(Zn).sub(getglobc(Zn-0.01)).normalize(),lo=lo.normalize(),lo.z=0,no.setFromUnitVectors(new THREE.Vector3(1,0,0),lo)):(lo=getglobc(Zn+0.01).sub(to),lo=lo.normalize(),lo.z=0,no.setFromUnitVectors(new THREE.Vector3(1,0,0),lo)),0.1<Math.abs(no.y)&&(console.log(Zn,to,lo),console.log(Zn,no));var oo={pel:Zn,v:[]};for(var po in eo[1]){var co=eo[1][po],uo=Math.sin(ao),ho=Math.cos(ao),go=new THREE.Vector3(0,co.x,co.y);go.applyAxisAngle(new THREE.Vector3(1,0,0),ao),go.applyQuaternion(no),go.add(to),oo.v.push(go)}return oo}function Bt(Zn,$n,eo,to){var ao=new THREE.Geometry,lo=0,no=Zn.v.length;ao.faceVertexUvs[0]=[];for(var oo=0;oo<no-1;++oo){var po=Zn.v[oo],co=Zn.v[oo+1],uo=$n.v[oo],ho=$n.v[oo+1],go=oo/(no-1),mo=(oo+1)/(no-1),yo=null==eo?0:eo,fo=null==to?1:to;ao.vertices.push(new THREE.Vector3(po.x,po.y,po.z)),ao.vertices.push(new THREE.Vector3(co.x,co.y,co.z)),ao.vertices.push(new THREE.Vector3(uo.x,uo.y,uo.z)),ao.vertices.push(new THREE.Vector3(ho.x,ho.y,ho.z)),ao.faces.push(new THREE.Face3(lo+2,lo+1,lo)),ao.faces.push(new THREE.Face3(lo+1,lo+2,lo+3)),ao.faceVertexUvs[0].push([new THREE.Vector2(go,fo),new THREE.Vector2(mo,yo),new THREE.Vector2(go,yo)]),ao.faceVertexUvs[0].push([new THREE.Vector2(mo,yo),new THREE.Vector2(go,fo),new THREE.Vector2(mo,fo)]),lo+=4}return ao.uvsNeedUpdate=!0,ao.computeFaceNormals(),ao}function Gt(){Gn=new THREE.Object3D;var Zn=tun2='';if('34100'==params.tunnel&&(tun2='34100',Zn='34000'),'34000'==params.tunnel&&(tun2='34000',Zn='34100'),Zn){globavg=tungeom[Zn].Geo3d.globavg,globtc=tungeom[Zn].Geo3d.globtc,Gn=Lt(Zn)[1];var $n=tv().copy(tungeom[Zn].Geo3d.globavg).sub(tungeom[tun2].Geo3d.globavg);$n.y=-$n.y,Gn.position.set($n.x,$n.y,$n.z)}globavg=tungeom[params.tunnel].Geo3d.globavg,globtc=tungeom[params.tunnel].Geo3d.globtc,globtc[0].pel-=0.1,('Kjorholt'==params.tunnel||'Tunnel1'==params.tunnel)&&(globtc[0].pel=13650),globtc[globtc.length-1].pel+=0.1,In=Lt(params.tunnel)}function Nt(){var Zn=linez.length;if(!(2>Zn)){for(var eo,$n=1;$n<Zn;$n++)eo=new Na,eo.addline(linez[$n-1].xs,linez[$n-1].ys,1,linez[$n].xs,linez[$n].ys,1,Math.round(30*params.size),'#000000'),oman.add(eo);var to=linez[0].v,ao=linez[Math.floor(Zn/2)].v,lo=linez[Zn-1].v,no=_t();return no}}function _t(){for(var Zn=linez.length,$n=Math.floor(Zn/3),eo=Math.floor(2*Zn/3),to=tv(),ao=tv(),lo=tv(),no=0;no<$n;no++)to.add(linez[no].v);to.multiplyScalar(1/$n);for(var no=$n;no<eo;no++)ao.add(linez[no].v);ao.multiplyScalar(1/(eo-$n));for(var no=eo;no<Zn;no++)lo.add(linez[no].v);return lo.multiplyScalar(1/(Zn-eo)),[to,ao,lo]}function Ht(Zn){var $n=new THREE.Plane().setFromCoplanarPoints(Zn[0],Zn[1],Zn[2]),eo=new THREE.Vector3((Zn[0].x+Zn[1].x+Zn[2].x)/3,(Zn[0].y+Zn[1].y+Zn[2].y)/3,(Zn[0].z+Zn[1].z+Zn[2].z)/3),to=new THREE.BoxGeometry(150,150,0.5),ao=new THREE.MeshBasicMaterial({color:17408,transparent:!0,opacity:0.1}),lo=new THREE.Mesh(to,ao),no=new THREE.Quaternion;no.setFromUnitVectors(new THREE.Vector3(0,0,1),$n.normal),lo.applyQuaternion(no),lo.position.set(eo.x,eo.y,eo.z),lo.scale.set(fscale.val,fscale.val,1),fallar.add(lo)}function Xt(Zn){var $n=new THREE.Plane().setFromCoplanarPoints(Zn[0],Zn[1],Zn[2]),eo=new THREE.Vector3((Zn[0].x+Zn[1].x+Zn[2].x)/3,(Zn[0].y+Zn[1].y+Zn[2].y)/3,(Zn[0].z+Zn[1].z+Zn[2].z)/3),to=$n.normal;0>to.y&&to.negate();var ao=180*new THREE.Vector3(0,1,0).angleTo(to)/Math.PI,lo=Wa(linez[0].ys),no=getglobc(lo+1).sub(getglobc(lo));no=no.normalize();var oo=getglobc((Jl+Pl)/2),po=new THREE.Quaternion;po.setFromUnitVectors(new THREE.Vector3(0,0,1),new THREE.Vector3(0,1,0)),no.applyQuaternion(po);var co=new THREE.Quaternion;co.setFromUnitVectors(new THREE.Vector3(0,1,0).applyQuaternion(po),new THREE.Vector3(1,0,0).applyQuaternion(po));var uo=tv().copy(no).applyQuaternion(co),ho=new THREE.Plane().setFromCoplanarPoints(eo,tv().copy(eo).add(uo),tv().copy(eo).add(no)),go=tv().copy(to).projectOnPlane(ho.normal),mo=go.angleTo(no)<Math.PI/2?1:0,yo=180*go.angleTo(uo)/Math.PI;return yo=mo?360-yo:yo,console.log('Strike:',yo),console.log('Dip/Fall',ao),[Math.floor(yo),Math.round(ao)]}function Zt(){if(linez.length){var Zn=new ConvexHullGrahamScan;for(var $n in linez)Zn.addPoint(linez[$n].xs,linez[$n].ys);var eo=Zn.getHull(),to=[];for(var ao in linez)for(var $n in eo){var lo=linez[ao];eo[$n].x==lo.xs&&eo[$n].y==lo.ys&&to.push(lo)}linez=to,linez.sort(function(uo,ho){return ho.xs-uo.xs});var no=y=0;for(var ao in linez)no+=linez[ao].xs,y+=linez[ao].ys;no/=linez.length,y/=linez.length;var oo=Nt(),po=Xt(oo),co=new Na;co.addfall(no,y,8,po[0],po[1],1),co.color=oo,oman.plot(co),oman.add(co),$t(linez),X(),de(),linez=[],controls.enableRotate=!0,check3dbox.checked=!0,Ni.updateDisplay()}}function $t(Zn){var $n=[];for(var eo in Zn)$n.push(Zn[eo].v.x,Zn[eo].v.y,Zn[eo].v.z);if($n.length){var to=Y($n,Math.round(40*params.size),'#000000',1);line3dgroup.add(to)}}function ea(){camera.zoom;return!!(0.5>camera.zoom)}function ia(Zn,$n){if(ea()){for(var eo in globtxt)globtxt[eo].visible=!1;return void de(Zn)}for(var eo in globtxt)globtxt[eo].visible=!0;var to=new Date().getTime(),ao=5e3;if(null!=$n&&(ao=$n),to-Cs>ao){for(var eo in globtxt){var lo=globtxt[eo];lo.redrawInterval=1}for(var eo in de(Zn),globtxt){var lo=globtxt[eo];lo.redrawInterval=1e5}Cs=to}else de(Zn)}function oa(){var Zn=_n-1;Un.add(K(Math.cos(5*(Zn/100)*Math.PI)*Zn/50,Math.sin(5*(Zn/100)*Math.PI)*Zn/50,1,Math.cos(5*(_n/100)*Math.PI)*_n/50,Math.sin(5*(_n/100)*Math.PI)*_n/50,1,5,'#000000')),de(),_n++,_n<Nn?requestAnimationFrame(oa):pa()}function ra(){0!=_n||(Nl.remove(Un),Un=new THREE.Object3D,Nl.add(Un),Wn=new mytimer('Time1000',5),requestAnimationFrame(oa))}function pa(){var Zn=Wn.end('Time1000');globgeo='FPS '+1e3/(Zn/Nn),lastgeo.innerHTML=globgeo,_n=0}function ya(){params.withbg?fa(Ml):fa(''),Qi.material=Ci,de()}function fa(Zn){if(''==Zn)Ci=new THREE.MeshBasicMaterial({color:16777215});else{var $n=new THREE.TextureLoader;$n.crossOrigin='anonymous';var eo=$n.load(Zn,function(){de()});eo.magFilter=THREE.NearestFilter,eo.minFilter=THREE.LinearMipMapLinearFilter,eo.anisotropy=2,Jl>Pl&&(eo.flipY=!1),Ci=new THREE.MeshBasicMaterial({map:eo})}}function ba(Zn,$n){Rl=getsessionid(),J(),Pl=parseInt($n),Jl=parseInt(Zn),pmult=Jl<Pl?1:-1,Tl=(Jl+Pl)/2,Al=Math.abs(parseInt(Jl)-parseInt(Pl)),El=50,11>Al&&(El=100),6>Al&&(El=200),Dl=El*Al,Gl=Dl,si=Dl/ei,G(Jl,Pl,ii),zt(Jl,Pl),wa(Ml,0),ka(Jl,Pl,-1),params.resetcam(),de(),picparams.ps=Jl,picparams.pe=Pl,saveifokdist(picparams.ps,picparams.pe),fgui.updateDisplay()}function va(Zn,$n,eo){var ao=params.tunnel;null!=eo&&(ao=eo);var lo=Zn>$n,no=Math.min(Zn,$n),oo=Math.max(Zn,$n),po=1*Math.floor(no/1),co=1*Math.floor((oo-0.01)/1+1),uo=gettunlim(ao);('Kjorholt'==params.tunnel||'Tunnel1'==params.tunnel)&&(uo.pmin=13650),'34100'==params.tunnel&&(uo.pmin=0);var ho=checklims(po,co,uo);po=ho[0],co=ho[1],picdb.sortbypelasc();var go=getpicsinrange(ao,po,co);Ml='';var mo=go.length;mo&&(po=parseFloat(picdb.files[go[0]].ps),co=parseFloat(picdb.files[go[mo-1]].pe)),lo?ba(co,po):ba(po,co);var yo={c:-1},fo=function(){yo.c++,yo.c<go.length?xa(picdb.files[go[yo.c]],lo,function(){fo()}):console.log('Done')};fo(),yt(),fgui.close(),Ni.close()}function xa(Zn,$n,eo){var to=Jl>Pl;null!=$n&&(to=$n);var ao=new THREE.TextureLoader;ao.crossOrigin='anonymous';var lo=ao.load(Zn.pic,function(){de(),null!=eo&&eo()});lo.magFilter=THREE.NearestFilter,lo.minFilter=THREE.LinearMipMapLinearFilter,lo.anisotropy=2,to&&(lo.flipY=!1);var no=new THREE.MeshBasicMaterial({map:lo}),oo=Math.abs(_a(Math.max(Zn.ps,Zn.pe))-_a(Math.min(Zn.ps,Zn.pe))),po=_a((Zn.ps- -Zn.pe)/2),co=new THREE.PlaneGeometry(oo,2*ti,1,1);Qi=new THREE.Mesh(co,no),Qi.visible=Ll,Qi.position.set(0,po,0.01);var uo=to?Math.PI:0;Qi.rotateZ(Math.PI/2+uo),ns.push(Qi),Os.add(Qi)}function wa(Zn,$n){Nl.remove(Os),Os=new THREE.Object3D,ns.length=0,fa(Zn);var eo=new THREE.PlaneGeometry(2*si,2*ti,1,1);Qi=new THREE.Mesh(eo,Ci),Qi.position.set(0,$n/El,0);var to=Jl>Pl?Math.PI:0;Qi.rotateZ(Math.PI/2+to),ns.push(Qi),Os.add(Qi),Nl.add(Os);var ao=new THREE.PlaneGeometry(2*si,2.8*ti,1,1),lo=new THREE.Mesh(ao,Ci);lo.position.set(0,$n/El,0),lo.rotateZ(Math.PI/2+to),ns.push(lo),Os.add(lo)}function Sa(Zn,$n){var eo=new THREE.MeshBasicMaterial({color:16777215}),to=new THREE.PlaneGeometry(5*(2*(El/ei)),2*ti,1,1),ao=new THREE.Mesh(to,eo);ao.position.set(0,$n,0),ao.rotateZ(Math.PI/2),ns.push(ao),Os.add(ao);var lo=new THREE.PlaneGeometry(5*(2*(El/ei)),3*ti,1,1),no=new THREE.Mesh(lo,jl);no.position.set(0,$n,0),no.rotateZ(Math.PI/2),ns.push(no),Os.add(no)}function ka(Zn,$n,eo,to,ao){var lo,no=!1;-1==eo?(no=!0,lo=11184810):(lo=16711680,1<eo&&(lo=16769024),4<eo&&(lo=16746240),10<eo&&(lo=2258722));var oo=no?1:0.8,po=new THREE.MeshBasicMaterial({color:lo,transparent:!0,opacity:oo}),co=_a((Zn+$n)/2),uo=Math.abs(_a($n)-_a(Zn)),ho=ti/3,go=-ti-ho+ti/10,mo=new THREE.PlaneGeometry(ho,uo,1,1),yo=new THREE.Mesh(mo,po);if(yo.position.set(go,co,no?0:1),no){var fo=Ys.children[0];null!=fo&&Ys.remove(fo),Ys.add(yo),ns.push(yo)}else{Xs.add(yo);var bo=ae('Q='+eo+' '+to,go,co,10,0);if(Xs.add(bo),null!=ao&&''!=ao){for(var vo='',xo=0;xo<Math.min(4,ao.length);xo++)vo+=ao[xo];vo+='..!';var wo=ae(vo,go-0.35*oi,co+0.38*uo,10,1);Xs.add(wo)}}}function za(){for(;Xs.children.length;){var Zn=Xs.children[0];'undefined'!=typeof Zn.material&&Zn.material.dispose(),'undefined'!=typeof Zn.geometry&&Zn.geometry.dispose(),Xs.remove(Zn)}}function Fa(){for(;Ks.children.length;){var Zn=Ks.children[0];'undefined'!=typeof Zn.material&&Zn.material.dispose(),'undefined'!=typeof Zn.geometry&&Zn.geometry.dispose(),Ks.remove(Zn)}}function Da(){for(;Bs.children.length;){var Zn=Bs.children[0];'undefined'!=typeof Zn.material&&Zn.material.dispose(),'undefined'!=typeof Zn.geometry&&Zn.geometry.dispose(),Bs.remove(Zn)}for(;Ws.children.length;){var Zn=Ws.children[0];'undefined'!=typeof Zn.material&&Zn.material.dispose(),'undefined'!=typeof Zn.geometry&&Zn.geometry.dispose(),Ws.remove(Zn)}for(;Is.children.length;){var Zn=Is.children[0];'undefined'!=typeof Zn.material&&Zn.material.dispose(),'undefined'!=typeof Zn.geometry&&Zn.geometry.dispose(),Is.remove(Zn)}}function Va(Zn,$n){var eo=document.createElement('input',$n);eo.setAttribute('class','inguib'),eo.setAttribute('type','button'),eo.setAttribute('value',Zn),eo.setAttribute('id','mgb'+Zn);var to=new Hammer(eo);return eo.onfocus=function(){eo.blur()},to.on('press',function(){mycswitch(eo,'ibpressed',500),null!=$n&&setTimeout(function(){$n()},150)}),C(to),eo}function Ca(){var Zn=new FormData;Zn.append('data',params.author);try{var $n=window.XMLHttpRequest?new XMLHttpRequest:new activeXObject('Microsoft.XMLHTTP');$n.onreadystatechange=function(){if(4===$n.readyState){var eo=JSON.parse($n.response);filetable(container,eo,function(to){var ao=pelfromfname(to),lo=ao[0],no=ao[1];saveifokdist(lo,no),Ra(to)})}},$n.open('post',baseaddr+'getflist.php',!0),$n.send(Zn)}catch(eo){console.log(eo)}}function Ra(Zn){var $n=new FormData;$n.append('fname',Zn);try{var eo=window.XMLHttpRequest?new XMLHttpRequest:new activeXObject('Microsoft.XMLHTTP');eo.onreadystatechange=function(){if(4===eo.readyState){if(params.overridepel){var to=pelfromfname(Zn),ao=getpelrange(eo.response,to[0],to[1]);Hn=[],Ml='',ba(ao[0],ao[1])}Ia(eo.response),allq.update(),X(),de()}},eo.open('post',baseaddr+'gettxt.php',!0),eo.send($n)}catch(to){console.log(to)}}function La(Zn){var $n=basekjor;'Kjorholt'==Zn&&($n=basekjor),'Bamle'==Zn&&($n=basebamble);var eo=Zn+picparams.ps+'_'+picparams.pe+'.xml',to=$n+Ha(Zn)+endfile,ao=vkbeautify.xml(to);download(ao,eo)}function ja(Zn,$n){var eo=Ni.add(bf,'blank').name('Geology:');eo.onChange(function(){Ni.close()}),eo.__li.setAttribute('class','cr function first');var to=parseFloat(Ni.domElement.style.width)-1;eo.__li.style.width=to+'px';var ao=Je(Ni),lo=Va('ShowDB',function(){_i.showdb()});if(lo.setAttribute('class','inguib but2gui'),ao.appendChild(lo),lo=Va('Save',function(){params.save()}),lo.setAttribute('class','inguib but2gui'),ao.appendChild(lo),Ai=Ni.addFolder('Settings'),Ai.add(params,'loadprev').name(qa.restoresession),Ai.add(params,'savealpha').name(qa.savepicture),Ai.add(params,'author').name(qa.author).onChange(function(){Qe()}).domElement.children[0].setAttribute('maxlength','20'),Ai.add(params,'openfile').name(qa.openfilegeology),Ai.add(params,'ex').name('Expert user').onChange(function(){Ni.close(),Aa(us)}),Ai.add(params,'clear').name(qa.clearall),Ai.add(params,'overridepel').name('Override pel'),Ai.add(params,'withbg').name(qa.showmwd).onChange(function(){ya()}),Ai.add(params,'showbergart').name(qa.showrocktype).onChange(function(){allp.update(),de()}),Ai.add(params,'forcesync').name('ForcedSync'),null!=Zn&&(Zn==qa.qval&&Ja(),'Select'==Zn)){Ii=Ni.addFolder(qa.setproperties);var no=sid2txtdate(ln.sid)+' '+ln.author;if(Ii.add(bf,'blank').name(no),Ii.add(ln,'author').name(qa.author),'T'!=$n){q22=Ii.add(ln,'comment').name('');var oo=q22.domElement.children[0];oo.setAttribute('class','myta'),q22.domElement.setAttribute('class','c bigtadiv'),oo.placeholder='Comment...',oo.onkeyup=function(){Pe(this)},oo.onchange=function(){Ue()},q22.__li.setAttribute('class','cr string bigta')}if('T'==$n&&(Ii.add(ds[Zs],'text').name(qa.text).onChange(function(){console.log('Change'),ie(Zs,ds[Zs].text)}),Ii.add(params,'openfoto').name(qa.takephoto),Ii.add(params,'makelab').name(qa.labtest)),null==$n||'L'==$n){Ii.add(ln,'bergart',Ri).name(qa.rocktype).listen().onChange(function(){params.parcolor=Ae(ln.bergart),Ni.updateDisplay()});var ao=Ii.addColor(params,'parcolor').name(qa.color).listen().onChange(function(){params.parcolor=Ae(ln.bergart),Ni.updateDisplay()}),po=ao.domElement.children[0];po.style.width='70%'}return'W'==$n&&(Ii.add(ln,'dsc',qa.dsc).name(qa.description),Ii.add(ln,'wdrip').name(qa.dripmin),Ii.add(ln,'wleak').name(qa.litmin)),'F'==$n&&(Ii.add(ds[Zs],'angle',0,360).step(1).name(qa.angle).onChange(function(){oe(Zs,ds[Zs].fall,ds[Zs].angle)}),Ii.add(ds[Zs],'fall',0,90).step(1).name(qa.fall).onChange(function(){oe(Zs,ds[Zs].fall,ds[Zs].angle)})),Ii.add(bf,'blank').name(''),void Ii.add(params,'applyP').name(qa.ap)}Oi=Ni.addFolder(qa.main),Oi.add(bf,'blank').name(''),params.ex&&(M(Oi),M(Oi),Oi.add(params,'resetcam').name(qa.resetcamera),M(Oi))}function Ja(){Ti=Ni.addFolder(qa.qval);var Zn=sid2txtdate(tn.lastchange)+' by \''+tn.author+'\'';Ti.add(bf,'blank').name('Updated '+Zn);var $n=Ti.add(tn,'ps').name('Pel start').domElement.children[0];$n.type='tel',$n.setAttribute('maxlength','5'),$n=Ti.add(tn,'pe').name('Pel end').domElement.children[0],$n.type='tel',$n.setAttribute('maxlength','5'),q22=Ti.add(tn,'comment').name('');var eo=q22.domElement.children[0];eo.setAttribute('class','myta'),q22.domElement.setAttribute('class','c bigtadiv'),eo.placeholder='Comment...',eo.onkeyup=function(){Pe(this)},20<tn.comment.length&&Pe(eo),eo.onchange=function(){_e()},q22.__li.setAttribute('class','cr string bigta');var $n=Je(Ti);Bi.rqd=Va('RQD',function(){params.editRQD()}),$n.appendChild(Bi.rqd),Bi.Jr=Va('Jr',function(){params.editJr()}),$n.appendChild(Bi.Jr),Bi.Jw=Va('Jw',function(){params.editJw()}),$n.appendChild(Bi.Jw),Bi.Jn=Va('Jn',function(){params.editJn()}),$n.appendChild(Bi.Jn),Bi.Ja=Va('Ja',function(){params.editJa()}),$n.appendChild(Bi.Ja),Bi.SRF=Va('SRF',function(){params.editSRF()}),$n.appendChild(Bi.SRF);var to=Ti.add(bf,'blank').name('');to.__li.setAttribute('class','cr function qtext'),Bi.Q=to,Ti.add(tn,'bergart',Ri).name(qa.rocktype);var $n=Je(Ti),ao=Va(qa.apply,function(){_e()});ao.setAttribute('class','inguib but2gui'),$n.appendChild(ao);var ao=Va(qa.removeq,function(){params.removeq()});ao.setAttribute('class','inguib but2gui'),$n.appendChild(ao)}function Pa(){Ni=new dat.GUI({autoPlace:!1,width:Math.min(400,bi/2-4)}),container.appendChild(Ni.domElement),Ni.domElement.id='guipos'}function Aa(Zn,$n){us=Zn;var eo=Zn;Il?(eo='3d',globgeo='Settings'):globgeo='Geology',Vt(),null==eo&&($l=[],chosenp=-2);var to=Ni.closed;if(container.removeChild(Ni.domElement),Ni.destroy(),Pa(),'3d'==eo){var ao=Ni.add(bf,'blank').name('Settings:');ao.onChange(function(){Ni.close()}),ao.__li.setAttribute('class','cr function first');var lo=parseFloat(Ni.domElement.style.width)-1;return ao.__li.style.width=lo+'px',Ni.add(lingeom,'visible').name('Tunnel frame').onChange(function(){de()}),Xn&&(params.showholes&&(pointval.valmin=23,pMaterial.size=12,pointCloud.geometry.drawRange.start=pointval.ar[pointval.valmin-1],pointCloud.geometry.drawRange.count=pointval.ar[pointval.valmax-1]-pointCloud.geometry.drawRange.start,Xn=0),params.opacity=0.3,meshes.children[0].material.opacity=params.opacity,de()),params.showholes&&(Ni.add(pointval,'valmin',1,pointval.ar.length).name('Min').step(1).onChange(function(){pointCloud.geometry.drawRange.start=pointval.ar[pointval.valmin-1],pointCloud.geometry.drawRange.count=pointval.ar[pointval.valmax-1]-pointCloud.geometry.drawRange.start,de()}),Ni.add(pointval,'valmax',1,pointval.ar.length).name('Max').step(1).onChange(function(){pointCloud.geometry.drawRange.count=pointval.ar[pointval.valmax-1]-pointCloud.geometry.drawRange.start,de()}),Ni.add(pMaterial,'size',5,35).name('Point size').step(1).onChange(function(){de()})),Ni.add(params,'opacity',0,1).name('Tunnel opacity').step(0.1).onChange(function(){meshes.children[0].material.opacity=params.opacity,de()}),Ni.add(fscale,'val',0,1).name('Plane size').step(0.02).onChange(function(){for(var oo in fallar.children)fallar.children[oo].scale.set(fscale.val,fscale.val,1);de()}),params.showholes||Ni.add(params,'showholeask').name('Show holes'),void Ni.updateDisplay()}if(ja(eo,$n),null==$n&&$a(),Qt(),'Line'==eo&&(ui.setAttribute('class','geobuttonf'),params.linetype='Line',Oi.add(params,'bolt').name(qa.bolt),Oi.add(params,'lineStyle',qa.lineStylear).name(qa.ls),params.ex&&Oi.add(params,'size',0.1,1).name('Size').step(0.1),Oi.add(bf,'blank').name('')),'Water'==eo&&(hi.setAttribute('class','geobuttonf'),params.linetype='Water',Oi.add(params,'wsize',0.1,1).step(0.1).name('Size'),Oi.add(bf,'blank').name('')),'Text'==eo){gi.setAttribute('class','geobuttonf'),params.linetype='Text',q22=Oi.add(params,'text').name(qa.ttp),Oi.add(bf,'blank').name('');var no=q22.domElement.children[0];no.setAttribute('class','myta'),no.placeholder='Text...',to=!1}'Fall'==eo&&(mi.setAttribute('class','geobuttonf'),params.linetype='Fall',q22=Oi.add(params,'angle',0,360).step(1).name(qa.angle),Oi.add(params,'fall',0,90).step(1).name(qa.fall),Oi.add(bf,'blank').name(''),to=!1),'Bolt'==eo&&(params.linetype='Bolt',Oi.add(params,'boltlen',1,10).step(0.5).name(qa.len),Oi.add(params,'bolttype',qa.boltlist).name(qa.material),Oi.add(bf,'blank').name('')),'Select'==eo||'Q - value'==eo?(yi.setAttribute('class','geobuttonf'),params.linetype='Select'):Oi.open(),Ni.updateDisplay(),to?Ne():Ge()}function Ea(){for(var Zn in Gs.children.length=0,oman.ao){var $n=oman.ao[Zn];$n.toskip||'B'!=$n.type||oman.plot($n)}}function Ta(){this.oldzero=1,this.oldppu=1,this.oldpw=1,this.getnewy=function(Zn){var eo=_a(Zn);return eo=mr(eo),eo},this.getnewx=function(Zn){var $n=Zn/this.oldpw*ti;return $n=mr($n),$n}}function Oa(Zn,$n){for(var eo in $n)for(var to=$n[eo],ao=0;ao<to.length;ao++)if(to[ao]==Zn)return''+eo;return null}function Ia(Zn){mt.start('Get json');var $n='object'==typeof Zn?JSON.parse(JSON.stringify(Zn)):JSON.parse(Zn);var eo=$n.objdata;mt.end('Get json');var to=new Ta,ao=$n.authors,lo=$n.sids,no=$n.chlist;if(null==no||isEmpty(no))for(var oo in lo)oman.changelist[oo]=oo;else for(var oo in lo)oman.changelist[oo]=no[oo];to.oldzero=$n.zeropel,Kn=$n.author,to.oldppu=$n.pelperunit,to.oldpw=$n.pw,Yn=$n.sid,allq.restore($n.qval,1);for(var po=$n.pval,co=0;co<po.par.length;co++)for(var oo=0;oo<po.par[co].coords.length;oo+=2)po.par[co].coords[oo]=to.getnewx(po.par[co].coords[oo]),po.par[co].coords[oo+1]=to.getnewy(po.par[co].coords[oo+1],1);allp.restore(po,1);for(var yo,uo=eo.length,ho=6,go='#000000',mo=qy=qz=tmpy=tmpx=-1e3,oo=0;oo<uo;oo++){if(yo=new Na,null==lo)yo.sid=Yn;else{var fo=Oa(oo,lo);yo.sid=null==fo?Yn:fo}if(null==ao)yo.author=Kn;else{var fo=Oa(oo,ao);yo.author=null==fo?Kn:fo}var bo=eo[oo];if(2==bo.length){tmpx=to.getnewx(bo[0]/qprec),tmpy=to.getnewy(bo[1]/qprec),yo.addline(mo,qy,qz,tmpx,tmpy,qz,ho,go),mo=to.getnewx(bo[0]/qprec),qy=to.getnewy(bo[1]/qprec),oman.isdublicate(yo),oman.plot(yo),oman.add(yo);continue}if(0==bo[0]){ho=15,go='#000000',6<bo.length&&('number'==typeof bo[6]&&(ho=bo[6]),'string'==typeof bo[6]&&(go=bo[6])),8==bo.length&&(go=bo[7]),mo=to.getnewx(bo[4]/qprec),qy=to.getnewy(bo[5]/qprec),qz=bo[3],tmpx=to.getnewx(bo[1]/qprec),tmpy=to.getnewy(bo[2]/qprec),yo.addline(tmpx,tmpy,qz,mo,qy,qz,ho,go),oman.isdublicate(yo),oman.plot(yo),oman.add(yo);continue}if(1==bo[0]){ho=0.5,3<ho.length&&(ho=bo[3]),tmpx=to.getnewx(bo[1]/qprec),tmpy=to.getnewy(bo[2]/qprec),yo.addwater(tmpx,tmpy,10,ho),oman.isdublicate(yo),oman.plot(yo),oman.add(yo);continue}if(2==bo[0]){tmpx=to.getnewx(bo[1]/qprec),tmpy=to.getnewy(bo[2]/qprec);var vo=bo[4];'_pho_'==vo.slice(0,5)&&(yo.fall=1,vo=vo.slice(5),console.log(vo)),'_lab_'==vo.slice(0,5)&&(yo.fall=2,vo=vo.slice(5)),yo.addtext(vo,tmpx,tmpy,bo[3],1),oman.isdublicate(yo),oman.plot(yo),oman.add(yo);continue}if(3==bo[0]&&(tmpx=to.getnewx(bo[1]/qprec),tmpy=to.getnewy(bo[2]/qprec),yo.addfall(tmpx,tmpy,10,bo[3],bo[4],bo[5]),null!=bo[6]&&(yo.color=[tv(bo[6][0].x,bo[6][0].y,bo[6][0].z),tv(bo[6][1].x,bo[6][1].y,bo[6][1].z),tv(bo[6][2].x,bo[6][2].y,bo[6][2].z)]),oman.isdublicate(yo),oman.plot(yo),oman.add(yo)),4==bo[0]){yo.addbolt(to.getnewx(bo[1]/qprec),to.getnewy(bo[2]/qprec),bo[3],to.getnewx(bo[4]/qprec),to.getnewy(bo[5]/qprec),bo[6],bo[7]),oman.isdublicate(yo),oman.plot(yo),oman.add(yo);continue}}}function Ba(Zn,$n,eo){var to=0.02/Math.abs(Jl-Pl);null!=eo&&(to=eo);var ao=Math.abs(parseFloat(Zn)-parseFloat($n));return!!(ao<to)}function Ga(Zn,$n){var to=Math.abs(parseFloat(Zn)-parseFloat($n));return to}function Na(){this.type='',this.sid=Rl,this.author=params.author,this.id=0,this.skip=0,this.text='',this.xs=0,this.ys=0,this.zs=0,this.xe=0,this.ye=1,this.ze=1,this.size=3,this.color='',this.fall=0,this.angle=0,this.lastmx=-1e3,this.lastmy=-1e3,this.sameas=function(Zn){return this.type==Zn.type&&Ba(this.xs,Zn.xs)&&Ba(this.ys,Zn.ys)},this.addline=function(Zn,$n,eo,to,ao,lo,no,oo){this.type='L',this.size=no,this.color=oo,this.xs=Zn,this.ys=$n,this.zs=eo,this.xe=to,this.ye=ao,this.ze=lo},this.addbolt=function(Zn,$n,eo,to,ao,lo,no){this.type='B',this.text=no,this.xs=Zn,this.ys=$n,this.zs=eo,this.xe=to,this.ye=ao,this.ze=lo},this.addwater=function(Zn,$n,eo,to,ao,lo,no,oo){this.type='W',this.size=to,this.xs=Zn,this.ys=$n,this.zs=eo,null!==ao&&(this.text=ao),null!==lo&&(this.xe=lo),null!==no&&(this.fall=no),null!==oo&&(this.angle=oo)},this.addfall=function(Zn,$n,eo,to,ao,lo){this.type='F',this.xs=Zn,this.ys=$n,this.zs=eo,this.angle=to,this.fall=ao,this.size=null==lo?Ke(Wa($n)):lo},this.addtext=function(Zn,$n,eo,to){this.type='T',this.text=Zn,this.xs=$n,this.ys=eo,this.zs=to}}function _a(Zn){var $n=parseFloat(2*(pmult*(Zn-parseFloat(Tl))*El/ei));return $n}function Wa(Zn){var $n=parseFloat(pmult*Zn/(2*(El/ei))+Tl);return $n}function Ua(){var Zn=new Date,$n=parseInt(Zn.getMonth()+1),eo={date:Zn.getFullYear()+'-'+az($n)+'-'+az(Zn.getDate()),author:params.author};return eo}function Ha(Zn){for(var $n=[],eo=[],to={pmult:pmult,pelperunit:1/(2*(El/ei)),zeropel:Tl,pw:ti,author:params.author,tunnel:Zn},ao=new myxml(to),lo={type:'w',da:Ua(),coords:[0,1],comment:'',dsc:0,drip:'',leak:''},no={type:'t',da:Ua(),coords:[0,1],comment:'',fall:0},oo={type:'f',da:Ua(),coords:[0,1],comment:'',angle:0,fall:0},po={type:'l',da:Ua(),coords:[0,1],ltype:0,comment:'',bergart:'none',color:'',width:0},co={type:'q',da:Ua(),coords:[0,1],QVal:[],bergart:'none',color:0,comment:''},uo=0;uo<allq.qar.length;uo++){var ho=allq.qar[uo],go=co;go.da.author=ho.author,go.da.date=sid2date(ho.lastchange),go.coords=[ho.ps,ho.pe],go.QVal=[ho.RQD,ho.Jn,ho.Jr,ho.Ja,ho.Jw,ho.SRF,ho.Q],go.bergart=ho.bergart,go.comment=ho.comment,go.color=Mt(Ae(ho.bergart)),ao.parseos(go)}for(var uo=0;uo<ds.length;uo++)if(!ds[uo].skip&&!isinarray(eo,uo)){var mo=Oe(uo);if(!isinarray($n,mo)){var bo,yo=Ee(uo),fo=-2<mo?1:0;fo&&($n.push(mo),bo=allp.par[mo]);var xo,vo=ds[uo];if('L'==yo)if(xo=po,xo.da.author=vo.author,xo.da.date=sid2date(vo.sid),xo.ltype=vo.color[0],fo)bo.isarea&&(xo.ltype=5),xo.coords=bo.coords,xo.comment=bo.comment,xo.bergart=bo.bergart,xo.color=bo.color,xo.width=bo.width;else{for(var wo=Se(uo),So=0;So<wo.length;So++)eo.push(wo[So]);xo.coords=ke(wo)}'W'==yo&&(xo=lo,xo.da.author=vo.author,xo.da.date=sid2date(vo.sid),xo.coords=[vo.xs,vo.ys],fo&&(bo.comment&&(xo.comment=bo.comment),bo.dsc&&(xo.dsc=bo.dsc),bo.wdrip&&(xo.drip=bo.wdrip),bo.wleak&&(xo.leak=bo.wleak))),'T'==yo&&(xo=no,xo.da.author=vo.author,xo.da.date=sid2date(vo.sid),xo.coords=[vo.xs,vo.ys],xo.comment=vo.text,xo.fall=vo.fall),'B'==yo&&(xo=no,xo.da.author=vo.author,xo.da.date=sid2date(vo.sid),xo.coords=[vo.xs,vo.ys],xo.comment='B'),'F'==yo&&(xo=oo,xo.da.author=vo.author,xo.da.date=sid2date(vo.sid),xo.coords=[vo.xs,vo.ys],xo.angle=vo.size?vo.angle:360-vo.angle,xo.fall=vo.fall),ao.parseos(xo)}}return ao.showstrout()}function Xa(Zn,$n){for(var eo=[],to=[],ao=JSON.parse(JSON.stringify(Zn)),lo=0;lo<ao.length;lo++)if(!isinarray(to,lo)){var no=params.onlynew&&!$n?ao[lo].sid==Rl:1;1<params.onlynew&&(no=ao[lo].sid==params.onlynew?1:0);var oo=1;if(params.onlycurpel&&!$n&&!ul(Wa(ao[lo].ys))){var po=Se(lo);add2array(to,po),oo=0}!ao[lo].skip&&no&&oo&&eo.push(ao[lo])}return eo}function Ya(Zn){var $n=0;null!=Zn&&($n=Zn);var eo=Xa(ds,$n),to=new qe;to.lastchange=oman.changelist[params.onlynew],null==to.lastchange&&(to.lastchange=Rl),to.zeropel=Tl,to.pelperunit=El*pmult,to.pw=ti,to.pelstart=Jl,to.pelend=Pl,to.author=params.author,to.authors={},to.sid=Rl,to.sids={},to.tunnel=params.tunnel;var ao=new Ze;$n?ao.restore(allq,1):ao.restore(allq,1,params.onlynew),to.qval=ao;var lo=new Xe;lo.restore(allp,1,params.onlynew&&!$n),$n?lo.restore(allp,1):lo.restore(allp,1,params.onlynew),lo.cleanFromQ(),lo.y2pelcoords(),params.onlycurpel&&lo.cleanFromPel(),to.pval=lo;for(var no=yprev=cprev=sprev=-1e3,oo=0;oo<eo.length;oo++)eo[oo].ys=Wa(eo[oo].ys),eo[oo].ye=Wa(eo[oo].ye);for(var po,oo=0;oo<eo.length;oo++){po=eo[oo].author,null==to.authors[po]?to.authors[po]=[oo]:to.authors[po].push(oo);var co=eo[oo].sid;if(null==to.sids[co]?to.sids[co]=[oo]:to.sids[co].push(oo),'L'==eo[oo].type){if(no==Math.round(eo[oo].xs*qprec)&&yprev==Math.round(eo[oo].ys*qprec)&&cprev==eo[oo].color&&sprev==eo[oo].size){var uo=[Math.round(eo[oo].xe*qprec),Math.round(eo[oo].ye*qprec)];no=Math.round(eo[oo].xe*qprec),yprev=Math.round(eo[oo].ye*qprec)}else{no=Math.round(eo[oo].xe*qprec),yprev=Math.round(eo[oo].ye*qprec),cprev=eo[oo].color,sprev=eo[oo].size;var uo=[0,Math.round(eo[oo].xs*qprec),Math.round(eo[oo].ys*qprec),eo[oo].zs,no,yprev];6!=eo[oo].size&&uo.push(eo[oo].size),'#000000'!=eo[oo].color&&uo.push(eo[oo].color)}to.objdata.push(uo)}if('W'==eo[oo].type){no=-1e3;var uo=[1,eo[oo].xs*qprec,eo[oo].ys*qprec];0.5!=eo[oo].size&&uo.push(eo[oo].size),to.objdata.push(uo)}if('T'==eo[oo].type){no=-1e3;var ho=eo[oo].text;1==eo[oo].fall&&(ho='_pho_'+ho),2==eo[oo].fall&&(ho='_lab_'+ho);var uo=[2,eo[oo].xs*qprec,eo[oo].ys*qprec,eo[oo].zs,ho];to.objdata.push(uo)}if('F'==eo[oo].type){if(no=-1e3,''!=eo[oo].color)var uo=[3,eo[oo].xs*qprec,eo[oo].ys*qprec,eo[oo].angle,eo[oo].fall,eo[oo].size,eo[oo].color];else var uo=[3,eo[oo].xs*qprec,eo[oo].ys*qprec,eo[oo].angle,eo[oo].fall,eo[oo].size];to.objdata.push(uo)}if('B'==eo[oo].type){no=-1e3;var uo=[4,eo[oo].xs*qprec,eo[oo].ys*qprec,eo[oo].zs,eo[oo].xe*qprec,eo[oo].ye*qprec,eo[oo].ze,eo[oo].text];to.objdata.push(uo)}}var go=Object.keys(to.authors).length;if(1==go){var mo=Oa(0,to.authors);null!=mo&&(to.author=Oa(0,to.authors)),null==to.authors}var yo=Object.keys(to.sids).length;if(1==yo){var mo=Oa(0,to.sids);null!=mo&&(to.sid=Oa(0,to.sids)),null==to.sids}for(var fo in to.chlist={},to.sids){var po=oman.changelist[fo];console.log('Element of changelist',fo,po),null!=po&&(to.chlist[fo]=po)}return console.log('Saved change list',to.chlist),0==to.qval.qar.length&&console.log('No Q to save'),0==to.pval.par.length&&console.log('No Props to save'),0==to.objdata.length&&console.log('No registrations to save'),0==to.objdata.length&&0==to.pval.par.length&&0==to.qval.qar.length&&(to=0),to}function Ka(Zn,$n){if(Gi=1,renderblock=1,$n>=Zn.files.length)return di.value=null,allq.update(),X(),renderblock=0,de(),void(Gi=0);var eo=new FileReader;eo.onload=function(to){return 1==Zn.files.length&&params.overridepel?(console.log('open one blank file'),openblankimage(to.target.result),Gi=0,void(renderblock=0)):void(Ia(to.target.result),console.log('Done reading ',$n),Ka(di,$n+1))},eo.readAsText(Zn.files[$n])}function $a(){Es.visible=!1,ss=yp=zp=-1e3,Zs=-1,Ts.visible=!1}function el(Zn,$n){var to=180*(Math.atan2(Zn-ds[ds.length-1].xs,$n-ds[ds.length-1].ys)/Math.PI);to=Math.round(to),0>to&&(to=360+to),Ss.rotation=Math.round(1e3*(-Math.PI/180*to))/1e3,params.angle=to,ds[ds.length-1].angle=to,Ni.updateDisplay(),oman.updchangelist(ds[ds.length-1].sid)}function sl(Zn,$n,eo,to,ao,lo){var no=new THREE.CircleGeometry(to,32,Math.PI/4,2.12*Math.PI),oo=new THREE.Line(no,new THREE.LineBasicMaterial({color:lo,linewidth:ao}));return oo.position.set(Zn,$n,eo),oo}function il(Zn,$n,eo){var ao=0;null!=$n&&(ao=Mt($n,1));var lo='object'==typeof eo?eo.val:1,no=new THREE.Object3D,no=new THREE.TextSprite({textSize:0.25*ri*lo,redrawInterval:1e7,texture:{text:Zn+'',fontFamily:'Arial, Helvetica, sans-serif, Bold',fontWeight:'bold',autoRedraw:!1},material:{color:ao,fog:!1}});return 15!=lo&&globtxt.push(no),no.position.set(0,0,1),fcp&&(setTimeout(function(){de()},100),fcp=0),no}function dl(){_e(),je(),Ge()}function ul(Zn){var $n=picparams.ps,eo=picparams.pe;if(0<pmult){if(Zn>=$n&&Zn<=eo)return!0;}else if(Zn>=eo&&Zn<=$n)return!0;return!1}function hl(Zn,$n,eo){var to=$n,ao=eo;if(eo>$n){if(Zn>=to&&Zn<=ao)return!0;}else if(Zn>=ao&&Zn<=to)return!0;return!1}var fl=window.getComputedStyle(document.body,null).getPropertyValue('--myyellow'),vl=window.getComputedStyle(document.body,null).getPropertyValue('--myblack'),wl=window.getComputedStyle(document.body,null).getPropertyValue('--mybackground'),Sl,kl;this.getrs=function(){return Sl},this.callresultstring=function(Zn){ue(Zn)},this.getrp=function(){return kl},this.callresultpic=function(Zn){me(Zn)},this.loadlines=function(Zn){Ia(Zn),allq.update(),X(),de()},this.setauthor=function(Zn){params.author=Zn,Ni.updateDisplay()},this.showvederlag=function(){console.log('vederlag to be done')},this.makenovaxml=function(Zn,$n){console.log('novaxmlto to be done'),$n},this.getnxml=function(){return'to be xml text'},this.show3d=function(){gt()},this.show2d=function(){yt()};var Fl=S.picsizex,Dl=S.picsizey,Ml=S.picadress;Ml='';var Vl=Ml,Ql=S.tung,Cl=S.ling,Rl=getsessionid();newdb=new mydb,newdb.ldb(),picdb=new mypicdb;var Ll=!1;picdb.ldb(function(){6>picdb.files.length&&(picdb.files=picfiles,picdb.sdb());var Zn=picparams.ps,$n=picparams.pe;va(Zn,$n,params.tunnel),setTimeout(function(){Ll=!0,va(Zn,$n,params.tunnel)},150)}),tungeom.Tunnel1=tungeom1.Tunnel1;var jl=new THREE.MeshBasicMaterial({color:16777215,transparent:!0,opacity:0}),Jl=S.pelstart,Pl=S.pelend,Al=Math.abs(parseInt(Jl)-parseInt(Pl)),El=50;11>Al&&(El=100),6>Al&&(El=200),Dl=El*Al;var Tl=S.zeropel,Ol=S.picpack,Il=!1,Bl=Fl,Gl=Dl;container=condiv();var Nl,_l=new THREE.Raycaster,Wl=new THREE.Vector2,Hl=0,Xl=0,Yl=0,$l=[],ss=yp=zp=-1e3,is=yp2d=zp2d=-1e3,ns=[],ds=[],us='Line';oman=new P;var ms=function(){return{s:'bevgsave1',l:'bevgsave1'}}(),fs=new function(){this.idx=[],this.type=[],this.remprev=[],this.xl=[],this.yl=[],this.add=function(Zn,$n,eo){this.idx.push(Zn),this.type.push($n),this.remprev.push(eo),this.xl.push(0),this.yl.push(0)},this.addMove=function(Zn,$n,eo,to,ao){this.idx.push(Zn),this.type.push($n),this.remprev.push(eo),this.xl.push(to),this.yl.push(ao)},this.removelast=function(){this.type.splice(this.type.length-1,1),this.idx.splice(this.idx.length-1,1),this.remprev.splice(this.remprev.length-1,1),this.xl.splice(this.xl.length-1,1),this.yl.splice(this.xl.length-1,1)}},bs,ws,Ss,Vs,Qs,Cs=0,Rs=lastmovey=-1e3,Ls=0;Detector.canvas||alert('Browser does not support canvas 3d'),Nl=new THREE.Scene;var Js=new THREE.Scene,Ps=new THREE.Scene,As=Nl,Es=new THREE.Object3D,Ts=new THREE.Object3D,Os=new THREE.Object3D,Is=new THREE.Object3D,Bs=new THREE.Object3D,Gs=new THREE.Object3D,Ns=new THREE.Object3D,_s=new THREE.Object3D,Ws=new THREE.Object3D,Us=new THREE.Object3D,Hs;fallar=new THREE.Object3D,line3dgroup=new THREE.Object3D,line3dtemp=new THREE.Object3D,Nl.add(Ns),Nl.add(_s),Nl.add(Ws);var Xs=new THREE.Object3D,Ys=new THREE.Object3D,Ks=new THREE.Object3D,Zs=-1;Es.visible=!1,Ts.visible=!1,pmult=Jl<Pl?1:-1;var ei=200,ti=Fl/ei,li=1,si=Dl/ei,ii=0,oi=1,ri=1,di=document.createElement('input');document.body.appendChild(di),di.type='file',di.accept='.txt',di.multiple=!0,di.style.display='none',di.onchange=function(){if(console.log('Start file read'),null==this.files[0])return void console.log('No files chosen');var Zn=this.files[0].name,$n=pelfromfname(Zn);params.overridepel&&saveifokdist($n[0],$n[1]),('t'==Zn[Zn.length-1]||'T'==Zn[Zn.length-1])&&Ka(this,0)};var pi=document.createElement('input');document.body.appendChild(pi),pi.type='file',pi.style.display='none',pi.onchange=function(){if(null==this.files[0])return void console.log('No photo chosen');var Zn=this.files[0].name;('g'==Zn[Zn.length-1]||'G'==Zn[Zn.length-1])&&le(this)};var ci=new Image,ui=document.getElementById('linbtn'),hi=document.getElementById('watbtn'),gi=document.getElementById('txtbtn'),mi=document.getElementById('falbtn'),yi=document.getElementById('selbtn'),fi=document.getElementById('undbtn'),bi,vi;F();var xi=new THREE.Vector2(bi,vi),Si=bi/vi,ki=2.5*si*Math.sqrt(2.28/(si/ti)),zi=ki,Fi;D();var Mi=document.getElementById(h).offsetTop,Vi=document.getElementById(h).offsetLeft;Nl.add(Os),Nl.add(Xs),Nl.add(Ks),Nl.add(Ys),Nl.add(Bs),Nl.add(Gs),Nl.add(Is);var Qi,Ci;wa(Ml,0),function(){var Zn=0.07*ri,$n=0.14*ri,eo=K(-Zn,-Zn,10,Zn,Zn,10,8*ri,'#000000'),to=K(Zn,-Zn,10,-Zn,Zn,10,8*ri,'#000000');Es.add(eo,to),Nl.add(Es);var ao=K(-$n,-$n,10,$n,-$n,10,5*ri,'#000000'),lo=K($n,-$n,10,$n,$n,10,5*ri,'#0000ff'),no=K($n,$n,10,-$n,$n,10,5*ri,'#ff0000'),oo=K(-$n,$n,10,-$n,-$n,10,5*ri,'#00ff00');Ts.add(ao,lo,no,oo),Nl.add(Ts)}();var Ri=['none','Hornfels','Svartskifer','Sill','Spr\xF8ytebetong','Special','Weakness','Basalt','Calcite','Granite','Pyrite'],Li=['#ffffff','#D0D470','#817A85','#EDA155','#877D7B','#ED4AE8','#771111','#000000','#aaffaa','#aa7777','#ff2222'],Ai,Ti,Oi,Ii,Bi={rqd:'',Jn:'',Jr:'',Ja:'',Jw:'',SRF:'',Q:''},Gi=0;(android||iOS)&&setInterval(function(){xt()},3e4),params={ex:!1,restses:1,loadprev:function(){myask(container,qa.unsaved,function(){J(),wt()})},savexml:function(){La(params.tunnel)},forcesync:!1,enrot:!1,linetype:'Line',linemagnet:!0,lineStyle:qa.lineStylear[0],tunnel:picparams.ps>tunborder?'Bamble':'Kjorholt',vederlag:!1,text:'',author:'V',onlynew:!1,onlycurpel:!1,rutenett:!1,size:0.5,wsize:0.5,opacity:0.5,angle:0,fall:45,layer:0,showholes:!1,showholeask:function(){myask(container,'This will take up to 10 seconds calculations.',function(){params.showholefunc()})},showholefunc:function(){params.showholes=!0,''!=strin&&(!android&&(strin=strin2),Us=makecloud(strin));var Zn=getglobc((Jl+Pl)/2),$n=new THREE.Object3D;$n.add(Us),$n.position.set(-Zn.x,-Zn.y,-Zn.z),my3dgroup.add($n),de(),Aa('3d')},move:!1,movestart:!1,color:'#000000',parcolor:'#000000',savealpha:function(){pt(),renderer.render(Nl,camera);var Zn=renderer.domElement.toDataURL();console.log(Zn.length);var $n=new Date,eo='';eo=eo+'geo'+$n.getHours()+'h'+$n.getMinutes()+'m'+$n.getSeconds()+'s.png',An(Zn,eo),bt(),lsc=1,X()},what2plot:'Geo+Q+Pel',withbg:!0,showbergart:!0,tstval:45,bolt:function(){yi.value='Select',Aa('Bolt')},boltlen:5,bolttype:'Steel',wtxt:'',dsc:'Not given',wleak:0,wdrip:0,save:function(){var Zn='Save all registrations as \n'+params.tunnel+' tunnel?';myask(container,Zn,function(){params.onlynew=!1,disassemble(),Ni.updateDisplay()})},textsave:'',clear:function(){myask(container,qa.unsaved,function(){J()})},load:function(){Ia(params.textsave),de()},go3d:gt,go2d:yt,getflist:function(){Ca()},add5m:function(){fgui.close(),Ni.close(),ft()},resetcam:function(){Ni.updateDisplay(),controls.reset(),controls.target.set(0,0,0),camera.position.set(0,0,li),$a(),de()},openfile:function(){params.overridepel?myask(container,qa.unsaved,function(){di.click()}):di.click()},overridepel:!0,openfoto:function(){pi.click()},makelab:function(){ie(Zs,qa.labtest,2),Ni.updateDisplay()},dummy:function(){},apply:function(){_e()},applyP:function(){Ue()},qedit:function(){},editRQD:function(){rqdmenu(tn,container,dl)},editJn:function(){jnmenu(tn,container,dl)},editJr:function(){jrmenu(tn,container,dl)},editJa:function(){jamenu(tn,container,dl)},editJw:function(){jwmenu(tn,container,dl)},editSRF:function(){srfmenu(tn,container,dl)},removeq:function(){myask(container,qa.removeqmes,function(){We()})}},params.author=function(){return localStorage.getItem('lastauthor')?localStorage.getItem('lastauthor'):'none'}(),params.tunnel=gettunnel()?gettunnel():tunlist[0];var Ni=new dat.GUI({autoPlace:!1});Ni.domElement.id='guipos',Ni.close(),container.appendChild(Ni.domElement),Aa('Line'),lasst=params.tunnel,myaddfunc.flip=function(){renderblock=1;var Zn=xt();J();var $n=picparams.ps;picparams.ps=picparams.pe,picparams.pe=$n,fgui.updateDisplay(),saveifokdist(picparams.ps,picparams.pe),''==Ml?va(picparams.ps,picparams.pe):ba(picparams.ps,picparams.pe),Zn&&wt(),renderblock=0,de(),Aa('Line'),yi.value='Select',fgui.close(),Ni.close()},myaddfunc.openblank=function(){console.log('Oblank'),fgui.close(),myask(container,qa.unsaved,function(){getbypl(picparams.ps,picparams.pe)})};var _i={showdb:function(){var Zn=function(){mt.start('Opening files');for(var eo=0,to=0;to<newdb.files.length;to++)newdb.files[to].ischosen&&!newdb.files[to].toskip&&eo++;if(eo){if(params.overridepel){var ao=getchosenpels(newdb),lo=ao[0],no=ao[1];picparams.ps=lo,picparams.pe=no,fgui.updateDisplay(),saveifokdist(picparams.ps,picparams.pe),va(picparams.ps,picparams.pe)}var oo=0;renderblock=1;for(var po,to=0;to<newdb.files.length;to++)po=newdb.files[to],po.ischosen&&!newdb.files[to].toskip&&(oo++,Ia(po.savedata));X(),allq.update(),renderblock=0,de(),newdb.uncheckall();var co=mt.end('Opening files');Aa('Line'),'debug'==params.author&&L('Files '+co+'ms',1)}};dbtable(container,function(){params.ex?myask3(container,qa.openneworex,qa.opennew,function(){params.overridepel=!0,Zn(),Ni.updateDisplay()},qa.opentoexisting,function(){params.overridepel=!1,Zn()}):(Zn(),Ni.updateDisplay())})},showpicdb:function(){dbpictable(container,Wi)},newblank:function(){ba(picparams.ps,picparams.pe)}};picparams.openf=function(){myask(container,qa.unsaved,function(){picdb.makefromfiles(function(){for(var Zn in picdb.sortbytime(),picdb.files)if(!picdb.files[Zn].toskip){picdb.files[Zn].ischosen=1;break}Wi(1)})})};var Wi=function(Zn){var $n=getchosenpels(picdb);if(null!=$n){var eo=$n[0],to=$n[1],ao=$n[2];picparams.ps=eo,picparams.pe=to,fgui.updateDisplay(),saveifokdist(picparams.ps,picparams.pe),console.log('Chosen are',picparams.ps,picparams.pe),Zn?getbypl(picparams.ps,picparams.pe):va(picparams.ps,picparams.pe,ao),Gt(),picdb.uncheckall()}},Ui=Je(fgui),Hi=Va('Start!',function(){myaddfunc.openblank()});Hi.setAttribute('class','inguib but1gui aguibut'),Ui.appendChild(Hi);var Ui=Je(fgui),Hi=Va('Flip pic',function(){myaddfunc.flip()});Hi.setAttribute('class','inguib but2gui'),Ui.appendChild(Hi),Hi=Va('Add 5m',function(){params.add5m()}),Hi.setAttribute('class','inguib but2gui'),Ui.appendChild(Hi);var Ui=Je(fgui),Hi=Va('MWDdb',function(){_i.showpicdb()});Hi.setAttribute('class','inguib but2gui aguibut'),Ui.appendChild(Hi),Hi=Va('Open geom',function(){picparams.openf()}),Hi.setAttribute('class','inguib but2gui aguibut'),Ui.appendChild(Hi);var Ui=Je(fgui),Hi=Va('Go 2d',function(){params.go2d()});Hi.setAttribute('class','inguib but2gui'),Ui.appendChild(Hi),Hi=Va('Go 3d',function(){params.go3d()}),Hi.setAttribute('class','inguib but2gui'),Ui.appendChild(Hi),fgui.add(params,'tunnel',tunlist).name('Tunnel:').onChange(function(){savetunnel(params.tunnel),Gt()}),fgui.add(params,'vederlag').name(qa.showved).onChange(function(){X(),de()}),fgui.add(params,'rutenett').name(qa.rutenett).onChange(function(){zt(Jl,Pl),de()}),G(Jl,Pl);var Xi=new THREE.TextureLoader;Xi.crossOrigin='anonymous';var Yi=Xi.load(spcline),Ki=Xi.load(spcline1,function(){Ki.wrapS=Ki.wrapT=THREE.RepeatWrapping,Ki.offset.set(0,0),Ki.repeat.set(1,1)}),Zi=Xi.load(spcline2,function(){Zi.wrapS=Zi.wrapT=THREE.RepeatWrapping,Zi.offset.set(0,0),Zi.repeat.set(1,1)}),en=new Na,tn=new $e,ln=new He;tn.getQ(),allq=new Ze,allp=new Xe;var nn=chosenp=-2;ka(Jl,Pl,-1);var rn=0,dn=new Hammer(ui);ui.onclick=function(){if(rn)return void(rn=0);var $n=0,eo=Ni.closed;'Line'==params.linetype&&($n=1),Aa('Line'),V(this),$n&&I(),eo&&Ni.close(),Ni.removeFolder(qa.qval),Ni.removeFolder(qa.setproperties),yi.value='Select'},(iOS||android)&&dn.on('press',function(){ui.click(),rn=1,setTimeout(function(){rn=0},250)}),dn.get('press').set({threshold:100,time:3});var cn=new Hammer(hi);hi.onclick=function(){return rn?void(rn=0):void(Aa('Water'),yi.value='Select',V(this),'debug'==params.author&&ra())},(iOS||android)&&cn.on('press',function(){hi.click(),rn=1,setTimeout(function(){rn=0},250)}),cn.get('press').set({threshold:100,time:3});var un=new Hammer(gi);gi.onclick=function(){Aa('Text'),yi.value='Select',V(this),'debug'==params.author&&L('Ver 1302')},(iOS||android)&&un.on('press',function(){gi.click(),rn=1,setTimeout(function(){rn=0},250)}),un.get('press').set({threshold:100,time:3});var hn=new Hammer(mi);mi.onclick=function(){return Il?void Zt():void(Aa('Fall'),yi.value='Select',V(this))},(iOS||android)&&hn.on('press',function(){mi.click(),rn=1,setTimeout(function(){rn=0},250)}),hn.get('press').set({threshold:100,time:3});var gn=new Hammer(fi);fi.onclick=function(){android&&Fe(),yi.value='Select',Qt()},gn.on('press',function(){android||(Fe(),yi.value='Select',rn=1,setTimeout(function(){rn=0},250))}),gn.get('press').set({threshold:100,time:3});var mn=0,yn=new Hammer(yi);android&&(yi.onclick=function(){mn||fn(1)}),yn.on('press',function(){fn(0),mn=1,setTimeout(function(){mn=0},250)}),yn.get('press').set({threshold:100,time:3});var fn=function(){return'Select'==yi.value?(yi.value='Group',void Aa('Select')):'One'==yi.value?void(yi.value='Group'):'Group'==yi.value?void(yi.value='One'):void 0};Ne();Nl.children.length;document.addEventListener('keydown',function(Zn){switch(Zn.keyCode){case 65:break;case 66:break;case 67:break;case 68:}},!1),window.addEventListener('resize',bt,!1),window.addEventListener('orientationchange',bt,!1);var xn=null,wn=lasty=-1e3,Sn=firsty=firstz=-1e3,kn=endy=-1e3,Fn=new Hammer(renderer.domElement);Q(Fn);de();var Xi=new THREE.TextureLoader;Xi.crossOrigin='anonymous';var qn=Xi.load(Ol.imdrop),Dn=new THREE.SpriteMaterial({map:qn,color:16777215}),Mn=Xi.load(Ol.fallMap),Vn=Xi.load(Ol.fallMapA180),Qn=Xi.load(Ol.fallMapF0),Cn=Xi.load(imflask),Rn=Xi.load(imphoto),Ln=new THREE.SpriteMaterial({map:Cn}),jn=new THREE.SpriteMaterial({map:Rn}),Jn=1,An=function(Zn,$n){var eo=document.createElement('a');'string'==typeof eo.download?(document.body.appendChild(eo),eo.download=$n,eo.href=Zn,eo.click(),document.body.removeChild(eo)):location.replace(uri)};var En=function(Zn,$n){var eo=new THREE.Vector3().subVectors($n,Zn),to=new THREE.Matrix4;to.lookAt(Zn,$n,new THREE.Object3D().up);var ao=new THREE.Matrix4;ao.set(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),to.multiply(ao);var lo=new THREE.CylinderGeometry(0.1,0.1,eo.multiplyScalar(0.3).length(),48,1),no=new THREE.Mesh(lo,new THREE.MeshBasicMaterial({color:0}));no.applyMatrix(to);var oo=new THREE.Vector3().addVectors(Zn,eo.multiplyScalar(0.5));return no.position.set(oo.x,oo.y,oo.z),no},Tn=function(Zn,$n){var eo,to,ao,lo,no,oo,po,co,uo,ho,go,mo,yo,fo;for(yo=[],po=Zn.geometry.faceVertexUvs[0],co=Zn.geometry.faces,uo=Zn.geometry.vertices,ho=new THREE.Matrix4,go=new THREE.Matrix4,fo=new THREE.Matrix4,Js.updateMatrixWorld(!0),lo=0;lo<po.length;lo++)if(no=po[lo],oo=co[lo],dt(no,$n)){eo=uo[oo.a].clone().applyMatrix4(Zn.matrixWorld),to=uo[oo.b].clone().applyMatrix4(Zn.matrixWorld),ao=uo[oo.c].clone().applyMatrix4(Zn.matrixWorld),ho.set(eo.x,eo.y,eo.z,0,to.x,to.y,to.z,0,ao.x,ao.y,ao.z,0,0,0,0,1),go.set(no[0].x,no[0].y,0,1,no[1].x,no[1].y,0,1,no[2].x,no[2].y,0,1,0,0,1,0),go.getInverse(go),ho.multiplyMatrices(go,ho),ho.elements=lt(ho),ho.transpose(),mo=new THREE.Vector3($n.x,$n.y,1);var bo=mo.applyMatrix4(ho);yo.push(bo),yo.push(oo.normal)}return yo};check3dbox.onchange=function(){controls.enableRotate=check3dbox.checked,Ni.updateDisplay()},syncfun=function($n,eo){var to=function(){putdbf($n),Rl=getsessionid()},ao=function(){mt.end('Merging'),newdb.syncall(),to()},lo=function(oo){mt.start('Merging'),syncbtn.textContent='Merge start',newdb.wipeold(function(){newdb.mergewithstring(oo,ao)})};getver(function(oo){var po=oo[0];console.log('localver=',newdb.getsid(),'onlinever',po);var co=!0;for(var uo in newdb.files)co=co&&newdb.files[uo].issynced;syncbtn.textContent='Got versions',newdb.getsid()!=po||!co||params.forcesync?(syncbtn.textContent=newdb.getsid()+' '+po,getdbf(lo)):(console.log('Version is up to date'),syncbtn.textContent='Version is up to date',null!=eo&&eo())})};getbypl=function($n,eo){var to=normPel($n,eo),ao=to[0],lo=to[1],no=ao,oo=lo,po=newdb.sorted;newdb.sortbypelasc();var co=[],uo=JSON.parse(JSON.stringify(newdb.files));for(var ho in uo){var go=uo[ho];if(!go.toskip){var mo=normPel(go.ps,go.pe);numintersect(ao,lo,mo[0],mo[1])&&(no=Math.min(no,ao,lo,mo[0],mo[1]),oo=Math.max(oo,ao,lo,mo[0],mo[1]),co.push(go.savedata))}}for(var ho in newdb.sortbytime(),va(no,oo),renderblock=1,co)Ia(co[ho]);X(),allq.update(),renderblock=0,de()};var In,Gn;Gt();var Nn=300,_n=0,Wn,Un=new THREE.Object3D;Nl.add(Un);var Hn=[],Xn=1,Yn,Kn;cutpels=function(){params.onlycurpel=!0;var Zn=Ya();J(),Ia(Zn),X(),allq.update(),de(),params.onlycurpel=!1},disassemble=function(){var Zn=Ya();console.log('Sids are',Zn.sids);var $n=[];for(var eo in Zn.sids)$n.push(eo);for(var to in $n)params.onlynew=parseInt($n[to]),to==$n.length-1?ue(1):ue(1,1);params.onlynew=0,he()},dat.GUI.prototype.removeFolder=function(Zn){var $n=this.__folders[Zn];$n&&($n.close(),this.__ul.removeChild($n.domElement.parentNode),delete this.__folders[Zn],this.onResize())}}